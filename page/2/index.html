<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
<meta property="og:type" content="website">
<meta property="og:title" content="XiSun的博客">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="XiSun的博客">
<meta property="og:description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="XiSun">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>XiSun的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">XiSun的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Learning is endless</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/27/db-jdbc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/27/db-jdbc/" class="post-title-link" itemprop="url">JDBC 入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-27 13:53:15" itemprop="dateCreated datePublished" datetime="2021-06-27T13:53:15+08:00">2021-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-06 14:32:32" itemprop="dateModified" datetime="2021-07-06T14:32:32+08:00">2021-07-06</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>95k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:26</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="JDBC-概述"><a href="#JDBC-概述" class="headerlink" title="JDBC 概述"></a>JDBC 概述</h2><h3 id="数据的持久化"><a href="#数据的持久化" class="headerlink" title="数据的持久化"></a>数据的持久化</h3><ul>
<li><p>持久化 (persistence)：<strong>把数据保存到可掉电式存储设备中以供之后使用</strong>。大多数情况下，特别是企业级应用，<strong>数据持久化意味着将内存中的数据保存到硬盘</strong>上加以 “固化”<strong>，而持久化的实现过程大多通过各种关系数据库来完成</strong>。</p>
</li>
<li><p>持久化的主要应用是将内存中的数据存储在关系型数据库中，当然也可以存储在磁盘文件、XML 数据文件中。</p>
<p><img src="/2021/06/27/db-jdbc/1566741430592.png" alt="1566741430592"></p>
</li>
</ul>
<h3 id="Java-中的数据存储技术"><a href="#Java-中的数据存储技术" class="headerlink" title="Java 中的数据存储技术"></a>Java 中的数据存储技术</h3><ul>
<li><p>在 Java 中，数据库存取技术可分为如下几类：</p>
<ul>
<li><p><strong>JDBC</strong> 直接访问数据库。</p>
</li>
<li><p>JDO (Java Data Object ) 技术。</p>
</li>
<li><p><strong>第三方 O/R 工具</strong>，如 Hibernate，Mybatis 等。</p>
</li>
</ul>
</li>
<li><p>JDBC 是 Java 访问数据库的基石，JDO、Hibernate、MyBatis 等只是更好的封装了 JDBC。</p>
</li>
</ul>
<h3 id="JDBC-介绍"><a href="#JDBC-介绍" class="headerlink" title="JDBC 介绍"></a>JDBC 介绍</h3><ul>
<li>JDBC (Java Database Connectivity) 是一个<strong>独立于特定数据库管理系统、通用的 SQL 数据库存取和操作的公共接口</strong> (一组 API)，定义了用来访问数据库的标准 Java 类库，然后 <code>java.sql</code> 和 <code>javax.sql</code> 这些 Java 的 API，可以使用这些类库以一种<strong>标准</strong>的方法、方便地访问数据库资源。</li>
<li>JDBC 为访问不同的数据库提供了一种<strong>统一的途径</strong>，为开发者屏蔽了一些细节问题。</li>
<li>JDBC 的目标是使 Java 程序员使用 JDBC 可以连接任何<strong>提供了 JDBC 驱动程序</strong>的数据库系统，这样就使得程序员无需对特定的数据库系统的特点有过多的了解，从而大大简化和加快了开发过程。</li>
<li>如果没有 JDBC，那么 Java 程序访问数据库时是这样的：</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1555575760234.png" alt="1555575760234"></p>
<ul>
<li>有了 JDBC，Java 程序访问数据库时是这样的：</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1555575981203.png" alt="1555575981203"></p>
<ul>
<li>总结如下：</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1566741692804.png" alt="1566741692804"></p>
<h3 id="JDBC-体系结构"><a href="#JDBC-体系结构" class="headerlink" title="JDBC 体系结构"></a>JDBC 体系结构</h3><ul>
<li>JDBC 接口 (API) 包括两个层次：<ul>
<li><strong>面向应用的 API</strong>：Java API，抽象接口，供应用程序开发人员使用 (连接数据库，执行 SQL 语句，获得结果)。</li>
<li><strong>面向数据库的 API</strong>：Java Driver API，供开发商开发数据库驱动程序用。</li>
</ul>
</li>
</ul>
<blockquote>
<p>面向接口编程：</p>
<p>JDBC 是 sun 公司提供一套用于数据库操作的接口，Java 程序员只需要面向这套接口编程即可。</p>
<p>不同的数据库厂商，需要针对这套接口，提供不同实现。不同的实现的集合，即为不同数据库的驱动。</p>
</blockquote>
<h3 id="JDBC-程序编写步骤"><a href="#JDBC-程序编写步骤" class="headerlink" title="JDBC 程序编写步骤"></a>JDBC 程序编写步骤</h3><p><img src="/2021/06/27/db-jdbc/1565969323908.png" alt="1565969323908"></p>
<blockquote>
<p>ODBC (Open Database Connectivity，开放式数据库连接)，是微软在 Windows 平台下推出的。使用者在程序中只需要调用 ODBC API，由 ODBC 驱动程序将调用转换成为对特定的数据库的调用请求。</p>
</blockquote>
<h2 id="获取数据库连接"><a href="#获取数据库连接" class="headerlink" title="获取数据库连接"></a>获取数据库连接</h2><h3 id="要素一：Driver-驱动"><a href="#要素一：Driver-驱动" class="headerlink" title="要素一：Driver 驱动"></a>要素一：Driver 驱动</h3><ul>
<li><p><code>java.sql.Driver</code> 接口是所有 JDBC 驱动程序需要实现的接口。这个接口是提供给数据库厂商使用的，不同数据库厂商提供不同的实现。</p>
</li>
<li><p>在程序中不需要直接去访问实现了 Driver 接口的类，而是由驱动程序管理器类 (<code>java.sql.DriverManager</code>) 去调用这些 Driver 实现。</p>
</li>
<li><p>第一步：Maven 添加驱动依赖。</p>
<ul>
<li><p>MySQL：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>PostgreSQL：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第二步：加载驱动。加载 JDBC 驱动需调用 Class 类的静态方法 <code>forName()</code>，并向其传递要加载的 JDBC 驱动的类名。</p>
<ul>
<li><p>MySQL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>com.mysql.jdbc.Driver</code> 已被舍弃。</p>
</blockquote>
</li>
<li><p>PostgreSQL：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;org.postgresql.Driver&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第三步：注册驱动。DriverManager 类是驱动程序管理器类，负责管理驱动程序。</p>
<ul>
<li><p>DriverManager 类使用 <code>registerDriver()</code> 注册驱动。</p>
</li>
<li><p>通常不用显式调用 DriverManager 类的 <code>registerDriver()</code> 来注册驱动程序类的实例，因为 Driver 接口的驱动程序类 (即实现类) 都包含了一个静态代码块，在这个静态代码块中，会调用 DriverManager 类 的 <code>registerDriver()</code> 来注册自身的一个实例。下图是 MySQL 的 Driver 实现类的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mysql.cj.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> <span class="keyword">extends</span> <span class="title">NonRegisteringDriver</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">sql</span>.<span class="title">Driver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Driver</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DriverManager.registerDriver(<span class="keyword">new</span> Driver());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="要素二：URL"><a href="#要素二：URL" class="headerlink" title="要素二：URL"></a>要素二：URL</h3><ul>
<li><p>JDBC URL 用于标识一个被注册的驱动程序，驱动程序管理器通过这个 URL 选择正确的驱动程序，从而建立到数据库的连接。</p>
</li>
<li><p>JDBC URL 的标准由三部分组成，各部分间用冒号分隔。 </p>
<ul>
<li><strong>格式：协议:子协议:子名称</strong></li>
<li><strong>协议</strong>：JDBC URL 中的协议总是 jdbc。</li>
<li><strong>子协议</strong>：子协议用于标识一个数据库驱动程序。</li>
<li><strong>子名称</strong>：一种标识数据库的方法。子名称可以依不同的子协议而变化，用子名称的目的是为<strong>定位数据库</strong>提供足够的信息。包含<strong>主机名</strong> (对应服务端的 ip 地址)<strong>，端口号和数据库名</strong>。</li>
</ul>
</li>
<li><p>举例：</p>
<p><img src="/2021/06/27/db-jdbc/1555576477107.png" alt="1555576477107"></p>
</li>
<li><p><strong>几种常用数据库的 JDBC URL</strong></p>
<ul>
<li><p>MySQL 的连接 URL 的编写方式：</p>
<ul>
<li><strong>jdbc:mysql://主机名称:mysql服务端口号/数据库名称?参数=值&amp;参数=值</strong><ul>
<li>jdbc:mysql://localhost:3306/atguigu</li>
<li>jdbc:mysql://localhost:3306/atguigu?useUnicode=true&amp;characterEncoding=utf8<ul>
<li>如果 JDBC 程序与服务器端的字符集不一致，会导致乱码，此时，可以通过参数指定服务器端的字符集。</li>
</ul>
</li>
<li>jdbc:mysql://localhost:3306/atguigu?user=root&amp;password=123456</li>
</ul>
</li>
</ul>
</li>
<li><p>Oracle 9i 的连接 URL 的编写方式：</p>
<ul>
<li><strong>jdbc:oracle:thin:@主机名称:oracle服务端口号:数据库名称</strong><ul>
<li>jdbc:oracle:thin:@localhost:1521:atguigu</li>
</ul>
</li>
</ul>
</li>
<li><p>SQLServer 的连接 URL 的编写方式：</p>
<ul>
<li><p>jdbc:sqlserver://主机名称:sqlserver服务端口号:DatabaseName=数据库名称</p>
<ul>
<li>jdbc:sqlserver://localhost:1433:DatabaseName=atguigu</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="要素三：用户名和密码"><a href="#要素三：用户名和密码" class="headerlink" title="要素三：用户名和密码"></a>要素三：用户名和密码</h3><ul>
<li>user 和 password，可以用 <code>属性名=属性值</code> 的方式告诉数据库。</li>
<li>可以调用 DriverManager 类的 <code>getConnection()</code> 方法建立到数据库的连接。</li>
</ul>
<h3 id="数据库连接方式举例"><a href="#数据库连接方式举例" class="headerlink" title="数据库连接方式举例"></a>数据库连接方式举例</h3><ul>
<li><p>连接方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.提供java.sql.Driver接口实现类的对象</span></span><br><span class="line">        Driver driver = <span class="keyword">null</span>;</span><br><span class="line">        driver = <span class="keyword">new</span> com.mysql.cj.jdbc.Driver();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.提供url，指明具体操作的数据</span></span><br><span class="line">        String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.提供Properties的对象，指明用户名和密码</span></span><br><span class="line">        Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">        info.setProperty(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">        info.setProperty(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;abc123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.调用driver的connect()，获取连接</span></span><br><span class="line">        Connection connection = driver.connect(url, info);</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：上述代码中显式出现了第三方数据库的 API。</p>
</blockquote>
</li>
<li><p>连接方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.实例化Driver</span></span><br><span class="line">        String className = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">        Driver driver = (Driver) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.提供url，指明具体操作的数据</span></span><br><span class="line">        String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.提供Properties的对象，指明用户名和密码</span></span><br><span class="line">        Properties info = <span class="keyword">new</span> Properties();</span><br><span class="line">        info.setProperty(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">        info.setProperty(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;abc123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.调用driver的connect()，获取连接</span></span><br><span class="line">        Connection connection = driver.connect(url, info);</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：相较于方式一，这里使用反射实例化 Driver，不在代码中体现第三方数据库的 API，体现了面向接口编程思想。</p>
</blockquote>
</li>
<li><p>连接方式三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.数据库连接的4个基本要素：</span></span><br><span class="line">        String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line">        String user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;abc123&quot;</span>;</span><br><span class="line">        String driverName = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.实例化Driver</span></span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(driverName);</span><br><span class="line">        Driver driver = (Driver) clazz.newInstance();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.注册驱动</span></span><br><span class="line">        DriverManager.registerDriver(driver);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4.获取连接</span></span><br><span class="line">        Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：使用 DriverManager 实现数据库的连接。体会获取连接必要的 4 个基本要素。</p>
</blockquote>
</li>
<li><p>连接方式四</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1.数据库连接的4个基本要素：</span></span><br><span class="line">        String url = <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line">        String user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        String password = <span class="string">&quot;abc123&quot;</span>;</span><br><span class="line">        String driverName = <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.加载驱动(实例化Driver和注册驱动)</span></span><br><span class="line">        Class.forName(driverName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Driver driver = (Driver) clazz.newInstance();</span></span><br><span class="line">        <span class="comment">// 3.注册驱动</span></span><br><span class="line">        <span class="comment">// DriverManager.registerDriver(driver);</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            可以注释掉上述代码的原因，是因为在mysql的Driver类中声明有(其他数据库的Driver类有类似代码)：</span></span><br><span class="line"><span class="comment">            static &#123;</span></span><br><span class="line"><span class="comment">                try &#123;</span></span><br><span class="line"><span class="comment">                    DriverManager.registerDriver(new Driver());</span></span><br><span class="line"><span class="comment">                &#125; catch (SQLException var1) &#123;</span></span><br><span class="line"><span class="comment">                    throw new RuntimeException(&quot;Can&#x27;t register driver!&quot;);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.获取连接</span></span><br><span class="line">        Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：不必显式的注册驱动。因为在 DriverManager 的源码中已经存在静态代码块，实现了驱动的注册。</p>
</blockquote>
</li>
<li><p>连接方式五 (最终版)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection5</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.加载配置文件</span></span><br><span class="line">    InputStream is = ConnectionTest.class.getClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">    Properties pros = <span class="keyword">new</span> Properties();</span><br><span class="line">    pros.load(is);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.读取配置信息</span></span><br><span class="line">    String user = pros.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    String password = pros.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    String url = pros.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">    String driverClass = pros.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.加载驱动</span></span><br><span class="line">    Class.forName(driverClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.获取连接</span></span><br><span class="line">    Connection connection = DriverManager.getConnection(url,user,password);</span><br><span class="line">    System.out.println(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置文件 jdbc.properties 内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/test</span></span><br><span class="line"><span class="attr">driverClass</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：使用配置文件的方式保存配置信息，在代码中加载配置文件。</p>
</blockquote>
</li>
<li><p>使用配置文件的好处：</p>
<ul>
<li>实现了代码和数据的分离，如果需要修改配置信息，直接在配置文件中修改，不需要深入代码。</li>
<li>如果修改了配置信息，省去重新编译、打包的过程。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="使用-PreparedStatement-实现-CRUD-操作"><a href="#使用-PreparedStatement-实现-CRUD-操作" class="headerlink" title="使用 PreparedStatement 实现 CRUD 操作"></a>使用 PreparedStatement 实现 CRUD 操作</h2><h3 id="Java-操作和访问数据库"><a href="#Java-操作和访问数据库" class="headerlink" title="Java 操作和访问数据库"></a>Java 操作和访问数据库</h3><ul>
<li><p>数据库连接被用于向数据库服务器发送命令和 SQL 语句，并接受数据库服务器返回的结果。其实一个数据库连接就是一个 Socket 连接。</p>
</li>
<li><p>在 <code>java.sql</code> 包中有 3 个接口分别定义了对数据库的调用的不同方式：</p>
<ul>
<li>Statement：用于执行静态 SQL 语句并返回它所生成结果的对象。 </li>
<li>PrepatedStatement：SQL 语句被预编译并存储在此对象中，可以使用此对象多次高效地执行该语句。</li>
<li>CallableStatement：用于执行 SQL 存储过程。</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1566573842140.png" alt="1566573842140"></p>
</li>
</ul>
<h3 id="Java-与-SQL-对应数据类型转换表"><a href="#Java-与-SQL-对应数据类型转换表" class="headerlink" title="Java 与 SQL 对应数据类型转换表"></a>Java 与 SQL 对应数据类型转换表</h3><table>
<thead>
<tr>
<th>Java 类型</th>
<th>SQL 类型</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>BIT</td>
</tr>
<tr>
<td>byte</td>
<td>TINYINT</td>
</tr>
<tr>
<td>short</td>
<td>SMALLINT</td>
</tr>
<tr>
<td>int</td>
<td>INTEGER</td>
</tr>
<tr>
<td>long</td>
<td>BIGINT</td>
</tr>
<tr>
<td>String</td>
<td>CHAR,VARCHAR,LONGVARCHAR</td>
</tr>
<tr>
<td>byte   array</td>
<td>BINARY  ,    VAR BINARY</td>
</tr>
<tr>
<td>java.sql.Date</td>
<td>DATE</td>
</tr>
<tr>
<td>java.sql.Time</td>
<td>TIME</td>
</tr>
<tr>
<td>java.sql.Timestamp</td>
<td>TIMESTAMP</td>
</tr>
</tbody></table>
<h3 id="使用-Statement-操作数据表的弊端"><a href="#使用-Statement-操作数据表的弊端" class="headerlink" title="使用 Statement 操作数据表的弊端"></a>使用 Statement 操作数据表的弊端</h3><ul>
<li><p>通过调用 Connection 对象的 <code>createStatement()</code> 创建该对象。该对象用于执行静态的 SQL 语句，并且返回执行结果。</p>
</li>
<li><p>Statement 接口中定义了下列方法用于执行 SQL 语句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行更新操作INSERT、UPDATE、DELETE</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行查询操作SELECT</span></span><br><span class="line"><span class="function">ResultSet <span class="title">executeQuery</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>但是，使用 Statement 操作数据表存在弊端：</p>
<ul>
<li><strong>问题一：存在拼串操作，繁琐。</strong></li>
<li><strong>问题二：存在 SQL 注入问题。</strong></li>
</ul>
</li>
<li><p>SQL 注入是利用某些系统没有对用户输入的数据进行充分的检查，而在用户输入的数据中注入非法的 SQL 语句段或命令，如：<code>SELECT user, password FROM user_table WHERE user=&#39;a&#39; OR 1 = &#39; AND password = &#39; OR &#39;1&#39; = &#39;1&#39;)</code>，从而利用系统的 SQL 引擎完成恶意行为的做法。</p>
</li>
<li><p>对于 Java 而言，要防范 SQL 注入，只要用 PreparedStatement (从 Statement 扩展而来) 取代 Statement 就可以了。</p>
</li>
<li><p>代码演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatementTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用Statement实现对数据表的查询操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(String sql, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Statement statement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.加载配置文件</span></span><br><span class="line">            InputStream is = StatementTest.class.getClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.load(is);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.读取配置信息</span></span><br><span class="line">            String user = properties.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            String password = properties.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            String url = properties.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">            String driverClass = properties.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.加载驱动</span></span><br><span class="line">            Class.forName(driverClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.获取连接</span></span><br><span class="line">            connection = DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">            statement = connection.createStatement();</span><br><span class="line"></span><br><span class="line">            resultSet = statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取结果集的元数据</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取结果集的列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line"></span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 1.获取列的名称</span></span><br><span class="line">                    <span class="comment">// String columnName = resultSetMetaData.getColumnName(i+1);</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 1.获取列的别名</span></span><br><span class="line">                    String columnName = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2. 根据列名获取对应数据表中的数据</span></span><br><span class="line">                    Object columnVal = resultSet.getObject(columnName);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 3. 将数据表中得到的数据，封装进对象</span></span><br><span class="line">                    Field field = clazz.getDeclaredField(columnName);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnVal);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭资源</span></span><br><span class="line">            <span class="keyword">if</span> (resultSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resultSet.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    statement.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用Statement的弊端：需要拼写sql语句，并且存在SQL注入的问题</span></span><br><span class="line">        <span class="comment">// 如何避免出现sql注入：只要用 PreparedStatement(从Statement扩展而来) 取代 Statement</span></span><br><span class="line"></span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入用户名：&quot;</span>);</span><br><span class="line">        String user = scanner.nextLine();</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入密码：&quot;</span>);</span><br><span class="line">        String password = scanner.nextLine();</span><br><span class="line">        <span class="comment">// SELECT user,password FROM user_table WHERE user = &#x27;1&#x27; or &#x27; AND password = &#x27;=1 or &#x27;1&#x27; = &#x27;1&#x27;</span></span><br><span class="line">        String sql = <span class="string">&quot;SELECT user,password FROM user_table WHERE user = &#x27;&quot;</span> + user + <span class="string">&quot;&#x27; AND password = &#x27;&quot;</span> + password + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        User returnUser = get(sql, User.class);</span><br><span class="line">        <span class="keyword">if</span> (returnUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户名不存在或密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>改进：</p>
<p><img src="/2021/06/27/db-jdbc/1566569819744.png" alt="1566569819744"></p>
</li>
</ul>
<h3 id="PreparedStatement的使用"><a href="#PreparedStatement的使用" class="headerlink" title="PreparedStatement的使用"></a>PreparedStatement的使用</h3><h4 id="PreparedStatement介绍"><a href="#PreparedStatement介绍" class="headerlink" title="PreparedStatement介绍"></a>PreparedStatement介绍</h4><ul>
<li><p>通过调用 Connection 对象的 <code>preparedStatement(String sql)</code> 获取 PreparedStatement 对象。</p>
</li>
<li><p><strong>PreparedStatement 接口是 Statement 的子接口，它表示一条预编译过的 SQL 语句。</strong></p>
</li>
<li><p>PreparedStatement 对象所代表的 SQL 语句中的参数用问号 (?) 来表示，调用 PreparedStatement 对象的 <code>setXxx()</code> (Xxx 表示数据类型) 来设置这些参数。<code>setXxx()</code> 有两个参数，第一个参数是要设置的 SQL 语句中的问号参数的索引 (从 1 开始)，第二个是设置的 SQL 语句中的该索引位置对应参数的值。</p>
</li>
</ul>
<h4 id="PreparedStatement-与-Statement-的对比"><a href="#PreparedStatement-与-Statement-的对比" class="headerlink" title="PreparedStatement 与 Statement 的对比"></a>PreparedStatement 与 Statement 的对比</h4><ul>
<li>代码的可读性和可维护性。</li>
<li><strong>PreparedStatement 通过预编译，可以防止 SQL 注入 (占位符的位置只是参数，SQL 的语意，在预编译时已经完成)。</strong></li>
<li>PreparedStatement 可以操作 Blob 的数据，而 Statement 做不到。</li>
<li><strong>PreparedStatement 能最大可能提高性能：</strong><ul>
<li>DBServer 会对<strong>预编译</strong>语句提供性能优化。因为预编译语句有可能被重复调用，所以语句在被 DBServer 的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中就会得到执行。</li>
<li>在 Statement 语句中，即使是相同操作，但因为数据内容不一样，所以整个语句本身不能匹配，没有缓存语句的意义。事实是没有数据库会对普通语句编译后的执行代码缓存。这样，每执行一次都要对传入的语句编译一次。</li>
<li>对于新的 SQL 语句，需要经过语法检查，语义检查，翻译成二进制命令等操作，PreparedStatement 的语句是预编译的，会被缓存，就不再需要经过前面的那几个操作，从而提高效率。</li>
</ul>
</li>
</ul>
<h4 id="使用-PreparedStatement-实现增、删、改操作"><a href="#使用-PreparedStatement-实现增、删、改操作" class="headerlink" title="使用 PreparedStatement 实现增、删、改操作"></a>使用 PreparedStatement 实现增、删、改操作</h4><ul>
<li><p>常规：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementUpdateTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向customers表中添加一条记录</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.读取配置文件中的4个基本信息</span></span><br><span class="line">            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.load(is);</span><br><span class="line"></span><br><span class="line">            String user = properties.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            String password = properties.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            String url = properties.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">            String driverClass = properties.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.加载驱动</span></span><br><span class="line">            Class.forName(driverClass);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.获取连接</span></span><br><span class="line">            connection = DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.预编译sql语句，返回PreparedStatement的实例</span></span><br><span class="line">            String sql = <span class="string">&quot;insert into customers(name, email, birth) values(?, ?, ?)&quot;</span>;<span class="comment">// ?: 占位符</span></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.填充占位符</span></span><br><span class="line">            preparedStatement.setString(<span class="number">1</span>, <span class="string">&quot;哪吒&quot;</span>);</span><br><span class="line">            preparedStatement.setString(<span class="number">2</span>, <span class="string">&quot;nezha@gmail.com&quot;</span>);</span><br><span class="line">            SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">            java.util.Date date = sdf.parse(<span class="string">&quot;1000-01-01&quot;</span>);</span><br><span class="line">            preparedStatement.setDate(<span class="number">3</span>, <span class="keyword">new</span> Date(date.getTime()));<span class="comment">// java.util.Date与java.sql.Date转换</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.执行操作</span></span><br><span class="line">            preparedStatement.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7.资源的关闭</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (preparedStatement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    preparedStatement.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        testInsert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDBCUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用throws抛出异常，在真正用到Connection的地方，统一使用try/catch，防止获取连接时出现异常，导致Connection为空但代码继续执行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.读取配置文件中的4个基本信息</span></span><br><span class="line">        InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.load(is);</span><br><span class="line"></span><br><span class="line">        String user = properties.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        String password = properties.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        String url = properties.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        String driverClass = properties.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.加载驱动</span></span><br><span class="line">        Class.forName(driverClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.获取连接</span></span><br><span class="line">        Connection connection = DriverManager.getConnection(url, user, password);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Connection connection, Statement statement)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                statement.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Connection connection, Statement statement, ResultSet resultSet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resultSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                resultSet.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                statement.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementUpdateTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通用的增删改操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String sql, Object... args)</span> </span>&#123;<span class="comment">// sql中占位符的个数与可变形参的长度相同！</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.预编译sql语句，返回PreparedStatement的实例</span></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.填充占位符</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.执行</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * 方式一，preparedStatement.execute()：</span></span><br><span class="line"><span class="comment">			 * 		如果执行的是查询操作，有返回结果，则此方法返回true;</span></span><br><span class="line"><span class="comment">			 * 		如果执行的是增、删、改操作，没有返回结果，则此方法返回false。</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">// preparedStatement.execute();</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 方式二，preparedStatement.executeUpdate()：</span></span><br><span class="line"><span class="comment">             *      返回sql语句执行过后，对数据库影响的行数，可以根据返回值，判断增、删、查操作的结果</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            preparedStatement.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5.资源的关闭</span></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// String sql = &quot;delete from customers where id = ?&quot;;</span></span><br><span class="line">        <span class="comment">// update(sql,3);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// order是数据库关键字，作为表名，为防止错误，添加``符号</span></span><br><span class="line">        String sql = <span class="string">&quot;update `order` set order_name = ? where order_id = ?&quot;</span>;</span><br><span class="line">        update(sql, <span class="string">&quot;DD&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="使用-PreparedStatement-实现查询操作"><a href="#使用-PreparedStatement-实现查询操作" class="headerlink" title="使用 PreparedStatement 实现查询操作"></a>使用 PreparedStatement 实现查询操作</h4><ul>
<li><p>常规：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ORM编程思想---Object Relational Mapping</span></span><br><span class="line"><span class="comment"> * 一个数据表对应一个Java类</span></span><br><span class="line"><span class="comment"> * 表中的一条记录对应Java类的一个对象</span></span><br><span class="line"><span class="comment"> * 表中的一个字段对应Java类的一个属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date birth;<span class="comment">// java.sql.Date</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(<span class="keyword">int</span> id, String name, String email, Date birth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">        <span class="keyword">this</span>.birth = birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirth</span><span class="params">(Date birth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birth = birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Customer [id=&quot;</span> + id + <span class="string">&quot;, name=&quot;</span> + name + <span class="string">&quot;, email=&quot;</span> + email + <span class="string">&quot;, birth=&quot;</span> + birth + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 针对于customers表的查询操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerForQuery</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testQuery1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            preparedStatement.setObject(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行，并返回结果集</span></span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理结果集</span></span><br><span class="line">            <span class="comment">// next()：判断结果集的下一条是否有数据，如果有数据返回true，并且指针下移；</span></span><br><span class="line">            <span class="comment">// 如果没有数据返回false，指针不会下移。</span></span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="comment">// 获取当前这条数据的各个字段值</span></span><br><span class="line">                <span class="keyword">int</span> id = resultSet.getInt(<span class="number">1</span>);</span><br><span class="line">                String name = resultSet.getString(<span class="number">2</span>);</span><br><span class="line">                String email = resultSet.getString(<span class="number">3</span>);</span><br><span class="line">                Date birth = resultSet.getDate(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 方式一：</span></span><br><span class="line">                <span class="comment">// System.out.println(&quot;id = &quot; + id + &quot;,name = &quot; + name + &quot;,email = &quot; + email + &quot;,birth = &quot; + birth);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 方式二：</span></span><br><span class="line">                <span class="comment">// Object[] data = new Object[]&#123;id, name, email, birth&#125;;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 方式三：将数据封装为一个对象（推荐）</span></span><br><span class="line">                Customer customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line">                System.out.println(customer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭资源</span></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        testQuery1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通用：</p>
<ul>
<li><p>类的属性和表的字段相同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 针对于customers表的查询操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerForQuery</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对customers表的通用的查询操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Customer <span class="title">queryForCustomers</span><span class="params">(String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="comment">// 获取结果集的元数据：ResultSetMetaData</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="comment">// 通过ResultSetMetaData获取结果集中的列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 只返回一条数据q2w</span></span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                Customer customer = <span class="keyword">new</span> Customer();</span><br><span class="line">                <span class="comment">// 处理结果集一行数据中的每一个列</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 获取列值</span></span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取每个列的列名</span></span><br><span class="line">                    <span class="comment">// String columnName = resultSetMetaData.getColumnName(i + 1);</span></span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 通过反射：给customer对象指定的columnName属性，赋值为columnValue</span></span><br><span class="line">                    Field field = Customer.class.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(customer, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> customer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">        Customer customer = queryForCustomers(sql, <span class="number">13</span>);</span><br><span class="line">        System.out.println(customer);</span><br><span class="line"></span><br><span class="line">        sql = <span class="string">&quot;select id, name, email, birth from customers where id = ? and name = ?&quot;</span>;</span><br><span class="line">        Customer customer1 = queryForCustomers(sql, <span class="number">10</span>, <span class="string">&quot;杰杰&quot;</span>);</span><br><span class="line">        System.out.println(customer1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>类的属性和表的字段不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date orderDate;<span class="comment">// java.sql.Date</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">(<span class="keyword">int</span> orderId, String orderName, Date orderDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">        <span class="keyword">this</span>.orderName = orderName;</span><br><span class="line">        <span class="keyword">this</span>.orderDate = orderDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderId</span><span class="params">(<span class="keyword">int</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderName</span><span class="params">(String orderName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderName = orderName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getOrderDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderDate</span><span class="params">(Date orderDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderDate = orderDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Order [orderId=&quot;</span> + orderId + <span class="string">&quot;, orderName=&quot;</span> + orderName + <span class="string">&quot;, orderDate=&quot;</span> + orderDate + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 针对order表的通用的查询操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderForQuery</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 针对于表的字段名与类的属性名不相同的情况：</span></span><br><span class="line"><span class="comment">     * 1.在声明sql时，使用类的属性名来命名字段的别名</span></span><br><span class="line"><span class="comment">     * 2.使用ResultSetMetaData时，需要使用getColumnLabel()来替换getColumnName()获取列的别名</span></span><br><span class="line"><span class="comment">     *   说明：如果sql中没有给字段起别名，getColumnLabel()获取的就是列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对于order表的通用的查询操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Order <span class="title">orderForQuery</span><span class="params">(String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行，获取结果集</span></span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="comment">// 获取结果集的元数据</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="comment">// 获取列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                Order order = <span class="keyword">new</span> Order();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 获取每个列的列值</span></span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 通过ResultSetMetaData</span></span><br><span class="line">                    <span class="comment">// 获取列的列名：getColumnName()---不推荐使用</span></span><br><span class="line">                    <span class="comment">// 获取列的别名：getColumnLabel()</span></span><br><span class="line">                    <span class="comment">// String columnName = resultSetMetaData.getColumnName(i + 1);</span></span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 通过反射，将对象指定名columnName的属性赋值为指定的值columnValue</span></span><br><span class="line">                    Field field = Order.class.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(order, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> order;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select order_id orderId, order_name orderName, order_date orderDate from `order` where order_id = ?&quot;</span>;</span><br><span class="line">        Order order = orderForQuery(sql, <span class="number">1</span>);</span><br><span class="line">        System.out.println(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不同表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatementQueryTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 返回一个</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="comment">// 获取结果集的元数据</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="comment">// 通过ResultSetMetaData获取结果集中的列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="comment">// 处理结果集一行数据中的每一个列</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 获取列值</span></span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 获取每个列的别名</span></span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 通过反射，给t对象指定的columnName属性，赋值为columnValue</span></span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回一个集合</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getForList</span><span class="params">(Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="comment">// 获取结果集的元数据</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="comment">// 通过ResultSetMetaData获取结果集中的列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            <span class="comment">// 创建集合对象</span></span><br><span class="line">            List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="comment">// 处理结果集一行数据中的每一个列: 给t对象指定的属性赋值</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 获取列值</span></span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 获取每个列的别名</span></span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 给t对象指定的columnName属性，赋值为columnValue：通过反射</span></span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                list.add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">        Customer customer = getInstance(Customer.class, sql, <span class="number">12</span>);</span><br><span class="line">        System.out.println(customer);</span><br><span class="line"></span><br><span class="line">        String sql1 = <span class="string">&quot;select order_id orderId, order_name orderName from `order` where order_id = ?&quot;</span>;</span><br><span class="line">        Order order = getInstance(Order.class, sql1, <span class="number">1</span>);</span><br><span class="line">        System.out.println(order);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String sql2 = <span class="string">&quot;select id, name, email, birth from customers where id &lt; ?&quot;</span>;</span><br><span class="line">        List&lt;Customer&gt; list = getForList(Customer.class, sql2, <span class="number">12</span>);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        String sql3 = <span class="string">&quot;select order_id orderId, order_name orderName from `order`&quot;</span>;</span><br><span class="line">        List&lt;Order&gt; orderList = getForList(Order.class, sql3);</span><br><span class="line">        orderList.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="ResultSet-与-ResultSetMetaData-的说明"><a href="#ResultSet-与-ResultSetMetaData-的说明" class="headerlink" title="ResultSet 与 ResultSetMetaData 的说明"></a>ResultSet 与 ResultSetMetaData 的说明</h3><h4 id="ResultSet"><a href="#ResultSet" class="headerlink" title="ResultSet"></a>ResultSet</h4><ul>
<li><p>查询数据库时，需要调用 PreparedStatement 的 <code>executeQuery()</code>，查询结果是一个 ResultSet 对象。</p>
</li>
<li><p>ResultSet 对象以逻辑表格的形式封装了执行数据库操作的结果集，ResultSet 接口由数据库厂商提供实现。</p>
</li>
<li><p>ResultSet 返回的实际上就是一张数据表。有一个指针指向数据表的第一条记录的前面。</p>
</li>
<li><p>ResultSet 对象维护了一个指向当前数据行的<strong>游标</strong>，初始的时候，游标在第一行之前，可以通过 ResultSet 对象的 <code>next()</code> 移动到下一行。调用 <code>next()</code> 时会检测下一行是否有效，若有效，该方法返回 true，且指针下移。相当于 Iterator 对象的 <code>hasNext()</code> 和 <code>next()</code> 两个方法的结合体。</p>
<p><img src="/2021/06/27/db-jdbc/1555580152530.png" alt="1555580152530"></p>
</li>
<li><p>当指针指向一行时，可以通过调用 <code>getXxx(int index)</code> 或 <code>getXxx(int columnName)</code> 获取每一列的值。</p>
<ul>
<li>例如：<code>getInt(1)</code>，<code>getString(&quot;name&quot;)</code>。</li>
<li><strong>注意：Java 与数据库交互涉及到的相关 Java API 中的索引都从 1 开始。</strong></li>
</ul>
</li>
</ul>
<h4 id="ResultSetMetaData"><a href="#ResultSetMetaData" class="headerlink" title="ResultSetMetaData"></a>ResultSetMetaData</h4><ul>
<li><p>ResultSetMetaData 是描述 ResultSet 的元数据，可用于获取 ResultSet 对象中列的类型和属性信息。</p>
</li>
<li><p>通过 ResultSet 的 <code>getMetaData()</code> 获取 ResultSetMetaData。</p>
<p><img src="/2021/06/27/db-jdbc/1555579494691.png" alt="1555579494691"></p>
<p><img src="/2021/06/27/db-jdbc/1555579816884.png" alt="1555579816884"></p>
</li>
<li><p>常用方法：</p>
<ul>
<li><code>getColumnCount()</code>：返回当前 ResultSet 对象中的列数。 </li>
<li><code>getColumnName(int column)</code>：获取指定列的名称，不推荐使用。</li>
<li><code>getColumnLabel(int column)</code>：获取指定列的别名，如果没有别名，则返回该列的名称。</li>
<li><code>getColumnTypeName(int column)</code>：检索指定列的数据库特定的类型名称。 </li>
<li><code>getColumnDisplaySize(int column)</code>：指示指定列的最大标准宽度，以字符为单位。 </li>
<li><code>isNullable(int column)</code>：指示指定列中的值是否可以为 null。 </li>
<li><code>isAutoIncrement(int column)</code>：指示是否自动为指定列进行编号，这样这些列仍然是只读的。 </li>
</ul>
</li>
</ul>
<h3 id="资源的释放"><a href="#资源的释放" class="headerlink" title="资源的释放"></a>资源的释放</h3><ul>
<li>释放 ResultSet，Statement，Connection。</li>
<li>数据库连接 (Connection) 是非常稀有的资源，用完后必须马上释放，如果 Connection 不能及时正确的关闭将导致系统宕机。Connection 的使用原则是<strong>尽量晚创建，尽量早的释放。</strong></li>
<li>应该在 finally 中关闭，保证及时其他代码出现异常，资源也一定能被关闭。</li>
</ul>
<h3 id="JDBC-API-使用小结"><a href="#JDBC-API-使用小结" class="headerlink" title="JDBC API 使用小结"></a>JDBC API 使用小结</h3><ul>
<li><p>两种思想：</p>
<ul>
<li><p>面向接口编程的思想</p>
</li>
<li><p>ORM 思想 (Object Relational Mapping)</p>
<ul>
<li>一个数据表对应一个 Java 类。</li>
<li>表中的一条记录对应 Java 类的一个对象。</li>
<li>表中的一个字段对应 Java 类的一个属性。</li>
</ul>
</li>
</ul>
<blockquote>
<p>SQL 应结合列名和表的属性名来写，必要时需要起别名。</p>
</blockquote>
</li>
<li><p>两种技术：</p>
<ul>
<li>JDBC 结果集的元数据 ResultSetMetaData。<ul>
<li>获取列数：<code>getColumnCount()</code></li>
<li>获取列的别名：<code>getColumnLabel()</code></li>
</ul>
</li>
<li>通过反射，创建指定类的对象，获取指定的属性并赋值。</li>
</ul>
</li>
</ul>
<h2 id="操作-BLOB-类型字段"><a href="#操作-BLOB-类型字段" class="headerlink" title="操作 BLOB 类型字段"></a>操作 BLOB 类型字段</h2><h3 id="MySQL-BLOB-类型"><a href="#MySQL-BLOB-类型" class="headerlink" title="MySQL BLOB 类型"></a>MySQL BLOB 类型</h3><ul>
<li><p>MySQL 中，BLOB 是一个二进制大型对象，是一个可以存储大量数据的容器，它能容纳不同大小的数据。</p>
</li>
<li><p>插入 BLOB 类型的数据必须使用 PreparedStatement，因为 BLOB 类型的数据无法使用字符串拼接来写。</p>
</li>
<li><p>MySQL 的四种 BLOB 类型 (除了在存储的最大信息量上不同外，它们是等同的)：</p>
<p><img src="/2021/06/27/db-jdbc/1555581069798.png" alt="1555581069798"></p>
</li>
<li><p>实际使用中根据需要存入的数据大小定义不同的 BLOB 类型。</p>
</li>
<li><p>需要注意的是：如果存储的文件过大，数据库的性能会下降。</p>
</li>
<li><p>如果在指定了相关的 BLOB 类型以后，还报错：<code>xxx too large</code>，原因是文件大小超过默认存储。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.mysql.cj.jdbc.exceptions.PacketTooBigException: <span class="function">Packet <span class="keyword">for</span> query is too <span class="title">large</span> <span class="params">(<span class="number">6</span>,<span class="number">218</span>,<span class="number">041</span> &gt; <span class="number">4</span>,<span class="number">194</span>,<span class="number">304</span>)</span>. You can change <span class="keyword">this</span> value on the server by setting the &#x27;max_allowed_packet&#x27; variable.</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>在 MySQL 的安装目录下，查找 my.ini 文件，并添加如下的配置参数： <strong>max_allowed_packet=16M</strong>，设置存储大小。注意：修改了 my.ini 文件之后，需要重新启动 MySQL 服务。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">16</span>M</span><br></pre></td></tr></table></figure>

<img src="/2021/06/27/db-jdbc/image-20210630172127799.png" alt="image-20210630172127799" style="zoom:80%;">
</li>
<li><p>Windows 系统下，在服务中，右键点击属性，可以查找到 my.ini 文件的位置：</p>
<p><img src="/2021/06/27/db-jdbc/image-20210630172332037.png" alt="image-20210630172332037"></p>
</li>
<li><p>在 cmd 中，也可以查看 max_allowed_packet 配置：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">XiSun</span>&gt;<span class="title">mysql</span> -<span class="title">u</span> <span class="title">root</span> -<span class="title">p</span></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">password</span>: ***************</span></span><br><span class="line"><span class="function"><span class="title">Welcome</span> <span class="title">to</span> <span class="title">the</span> <span class="title">MySQL</span> <span class="title">monitor</span>.  <span class="title">Commands</span> <span class="title">end</span> <span class="title">with</span> ; <span class="title">or</span> \<span class="title">g</span>.</span></span><br><span class="line"><span class="function"><span class="title">Your</span> <span class="title">MySQL</span> <span class="title">connection</span> <span class="title">id</span> <span class="title">is</span> 8</span></span><br><span class="line"><span class="function"><span class="title">Server</span> <span class="title">version</span>: 8.0.25 <span class="title">MySQL</span> <span class="title">Community</span> <span class="title">Server</span> - <span class="title">GPL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">c</span>) 2000, 2021, <span class="title">Oracle</span> <span class="title">and</span>/<span class="title">or</span> <span class="title">its</span> <span class="title">affiliates</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Oracle</span> <span class="title">is</span> <span class="title">a</span> <span class="title">registered</span> <span class="title">trademark</span> <span class="title">of</span> <span class="title">Oracle</span> <span class="title">Corporation</span> <span class="title">and</span>/<span class="title">or</span> <span class="title">its</span></span></span><br><span class="line"><span class="function"><span class="title">affiliates</span>. <span class="title">Other</span> <span class="title">names</span> <span class="title">may</span> <span class="title">be</span> <span class="title">trademarks</span> <span class="title">of</span> <span class="title">their</span> <span class="title">respective</span></span></span><br><span class="line"><span class="function"><span class="title">owners</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Type</span> &#x27;<span class="title">help</span>;&#x27; <span class="title">or</span> &#x27;\<span class="title">h</span>&#x27; <span class="title">for</span> <span class="title">help</span>. <span class="title">Type</span> &#x27;\<span class="title">c</span>&#x27; <span class="title">to</span> <span class="title">clear</span> <span class="title">the</span> <span class="title">current</span> <span class="title">input</span> <span class="title">statement</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mysql</span>&gt; <span class="title">show</span> <span class="title">VARIABLES</span> <span class="title">like</span> &#x27;%<span class="title">max_allowed_packet</span>%&#x27;;</span></span><br><span class="line"><span class="function">+---------------------------+------------+</span></span><br><span class="line"><span class="function">| <span class="title">Variable_name</span>             | <span class="title">Value</span>      |</span></span><br><span class="line"><span class="function">+---------------------------+------------+</span></span><br><span class="line"><span class="function">| <span class="title">max_allowed_packet</span>        | 16777216   |</span></span><br><span class="line"><span class="function">| <span class="title">mysqlx_max_allowed_packet</span> | 67108864   |</span></span><br><span class="line"><span class="function">| <span class="title">slave_max_allowed_packet</span>  | 1073741824 |</span></span><br><span class="line"><span class="function">+---------------------------+------------+</span></span><br><span class="line"><span class="function">3 <span class="title">rows</span> <span class="title">in</span> <span class="title">set</span>, 1 <span class="title">warning</span> (0.01 <span class="title">sec</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mysql</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>设置：<code>set global max_allowed_packet = 2*1024*1024*10;</code></p>
<p>退出 MySQL：<code>quit</code></p>
<p>重启：<code>service mysqld restart </code></p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="数据表中插入-BLOB-类型字段"><a href="#数据表中插入-BLOB-类型字段" class="headerlink" title="数据表中插入 BLOB 类型字段"></a>数据表中插入 BLOB 类型字段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlobTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向数据表customers中插入Blob类型的字段</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            String sql = <span class="string">&quot;insert into customers(name, email, birth, photo) values(?, ?, ?, ?)&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            preparedStatement.setObject(<span class="number">1</span>, <span class="string">&quot;袁浩&quot;</span>);</span><br><span class="line">            preparedStatement.setObject(<span class="number">2</span>, <span class="string">&quot;yuan@qq.com&quot;</span>);</span><br><span class="line">            preparedStatement.setObject(<span class="number">3</span>, <span class="string">&quot;1992-09-08&quot;</span>);</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;E:/test.png&quot;</span>));</span><br><span class="line">            preparedStatement.setBlob(<span class="number">4</span>, fis);</span><br><span class="line"></span><br><span class="line">            preparedStatement.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据表中修改-BLOB-类型字段"><a href="#数据表中修改-BLOB-类型字段" class="headerlink" title="数据表中修改 BLOB 类型字段"></a>数据表中修改 BLOB 类型字段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlobTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 向数据表customers中修改Blob类型的字段</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            String sql = <span class="string">&quot;update customers set photo = ? where id = ?&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;test.png&quot;</span>));</span><br><span class="line">            preparedStatement.setBlob(<span class="number">1</span>, fis);</span><br><span class="line">            preparedStatement.setObject(<span class="number">2</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">            preparedStatement.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据表中读取-BLOB-类型字段"><a href="#数据表中读取-BLOB-类型字段" class="headerlink" title="数据表中读取 BLOB 类型字段"></a>数据表中读取 BLOB 类型字段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlobTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查询数据表customers中Blob类型的字段</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth, photo from customers where id = ?&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            preparedStatement.setInt(<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="comment">// 方式一：</span></span><br><span class="line">                <span class="comment">// int id = resultSet.getInt(1);</span></span><br><span class="line">                <span class="comment">// String name = resultSet.getString(2);</span></span><br><span class="line">                <span class="comment">// String email = resultSet.getString(3);</span></span><br><span class="line">                <span class="comment">// Date birth = resultSet.getDate(4);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 方式二：</span></span><br><span class="line">                <span class="keyword">int</span> id = resultSet.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                String name = resultSet.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                String email = resultSet.getString(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">                Date birth = resultSet.getDate(<span class="string">&quot;birth&quot;</span>);</span><br><span class="line"></span><br><span class="line">                Customer customer = <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line">                System.out.println(customer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Blob类型的字段需要下载下来，以文件的方式保存在本地</span></span><br><span class="line">                Blob photo = resultSet.getBlob(<span class="string">&quot;photo&quot;</span>);</span><br><span class="line">                is = photo.getBinaryStream();</span><br><span class="line">                fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;test2.jpg&quot;</span>);</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">int</span> len;</span><br><span class="line">                <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="批量处理"><a href="#批量处理" class="headerlink" title="批量处理"></a>批量处理</h2><h3 id="批量执行-SQL-语句"><a href="#批量执行-SQL-语句" class="headerlink" title="批量执行 SQL 语句"></a>批量执行 SQL 语句</h3><ul>
<li>当需要成批插入或者更新记录时，可以采用 JDBC 的批量<strong>更新</strong>机制，这一机制允许多条语句一次性提交给数据库批量处理。通常情况下比单独提交处理更有效率</li>
</ul>
<ul>
<li><p>JDBC 的批量处理语句包括下面三个方法：</p>
<ul>
<li><strong><code>addBatch(String)</code>：添加需要批量处理的 SQL 语句或是参数。</strong></li>
<li><strong><code>executeBatch()</code>：执行批量处理语句。</strong></li>
<li><strong><code>clearBatch()</code>：清空缓存的数据。</strong></li>
</ul>
</li>
<li><p>通常我们会遇到两种批量执行 SQL 语句的情况：</p>
<ul>
<li>多条 SQL 语句的批量处理。</li>
<li>一条 SQL 语句的批量传参。</li>
</ul>
</li>
</ul>
<h3 id="高效的批量插入"><a href="#高效的批量插入" class="headerlink" title="高效的批量插入"></a>高效的批量插入</h3><ul>
<li>举例：向数据表中插入 20000 条数据。</li>
</ul>
<ul>
<li><p>数据库中提供一个 goods 表作为测试。创建如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> goods(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT,</span><br><span class="line"><span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询goods表总条目数</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> goods;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空goods表</span></span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> goods;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="实现层次一"><a href="#实现层次一" class="headerlink" title="实现层次一"></a>实现层次一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用PreparedStatement实现批量数据的操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * update、delete本身就具有批量操作的效果。</span></span><br><span class="line"><span class="comment"> * 此时的批量操作，主要指的是批量插入。使用PreparedStatement如何实现更高效的批量插入？</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 功能：向goods表中插入20000条数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 批量插入的方式一：使用Statement</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Statement statement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            statement = connection.createStatement();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">20000</span>; i++) &#123;</span><br><span class="line">                String sql = <span class="string">&quot;insert into goods(name) values(&#x27;name_&quot;</span> + i + <span class="string">&quot;&#x27;)&quot;</span>;</span><br><span class="line">                statement.execute(sql);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;花费的时间为：&quot;</span> + (end - start));<span class="comment">// 20000: 35856</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, statement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现层次二"><a href="#实现层次二" class="headerlink" title="实现层次二"></a>实现层次二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用PreparedStatement实现批量数据的操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * update、delete本身就具有批量操作的效果。</span></span><br><span class="line"><span class="comment"> * 此时的批量操作，主要指的是批量插入。使用PreparedStatement如何实现更高效的批量插入？</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 功能：向goods表中插入20000条数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 批量插入的方式二：使用PreparedStatement</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            String sql = <span class="string">&quot;insert into goods(name) values(?)&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">20000</span>; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(<span class="number">1</span>, <span class="string">&quot;name_&quot;</span> + i);</span><br><span class="line">                preparedStatement.execute();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;花费的时间为：&quot;</span> + (end - start));<span class="comment">// 20000：36488</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实现层次三"><a href="#实现层次三" class="headerlink" title="实现层次三"></a>实现层次三</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用PreparedStatement实现批量数据的操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * update、delete本身就具有批量操作的效果。</span></span><br><span class="line"><span class="comment"> * 此时的批量操作，主要指的是批量插入。使用PreparedStatement如何实现更高效的批量插入？</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 功能：向goods表中插入20000条数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 批量插入的方式三：</span></span><br><span class="line"><span class="comment">     * 1.addBatch()、executeBatch()、clearBatch()</span></span><br><span class="line"><span class="comment">     * 2.MySQL服务器默认是关闭批处理的，需要通过一个参数，让MySQL开启批处理的支持。</span></span><br><span class="line"><span class="comment">     *     在配置文件的url后面添加参数：?rewriteBatchedStatements=true</span></span><br><span class="line"><span class="comment">     * 3.MySQL驱动要求5.1.37及以上版本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            String sql = <span class="string">&quot;insert into goods(name) values(?)&quot;</span>;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(<span class="number">1</span>, <span class="string">&quot;name_&quot;</span> + i);</span><br><span class="line">                <span class="comment">// 1.&quot;攒&quot;sql</span></span><br><span class="line">                preparedStatement.addBatch();</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">500</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 2.执行batch</span></span><br><span class="line">                    preparedStatement.executeBatch();</span><br><span class="line">                    <span class="comment">// 3.清空batch</span></span><br><span class="line">                    preparedStatement.clearBatch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;花费的时间为：&quot;</span> + (end - start));<span class="comment">// 20000: 1130</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;                                <span class="comment">// 1000000: 13560</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>url 格式：<code>url=jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true</code></p>
</blockquote>
<h4 id="实现层次四"><a href="#实现层次四" class="headerlink" title="实现层次四"></a>实现层次四</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用PreparedStatement实现批量数据的操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * update、delete本身就具有批量操作的效果。</span></span><br><span class="line"><span class="comment"> * 此时的批量操作，主要指的是批量插入。使用PreparedStatement如何实现更高效的批量插入？</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 功能：向goods表中插入20000条数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 批量插入的方式四：设置连接不允许自动提交数据(在方式三的基础上实现)</span></span><br><span class="line"><span class="comment">     * 使用Connection的setAutoCommit(false)/commit()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInsert4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            <span class="comment">// 先设置不允许自动提交数据</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            String sql = <span class="string">&quot;insert into goods(name) values(?)&quot;</span>;</span><br><span class="line">            ps = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">                ps.setObject(<span class="number">1</span>, <span class="string">&quot;name_&quot;</span> + i);</span><br><span class="line">                <span class="comment">// 1.&quot;攒&quot;sql</span></span><br><span class="line">                ps.addBatch();</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">500</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 2.执行batch</span></span><br><span class="line">                    ps.executeBatch();</span><br><span class="line">                    <span class="comment">// 3.清空batch</span></span><br><span class="line">                    ps.clearBatch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 然后手动提交数据</span></span><br><span class="line">            connection.commit();</span><br><span class="line">            <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">&quot;花费的时间为：&quot;</span> + (end - start));<span class="comment">// 20000: 1094</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;                                <span class="comment">// 1000000: 10129</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, ps);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每次向数据库 commit 操作时，也会耗时，可以等全部数据处理完后，再统一 commit。</p>
</blockquote>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><h3 id="数据库事务介绍"><a href="#数据库事务介绍" class="headerlink" title="数据库事务介绍"></a>数据库事务介绍</h3><ul>
<li><strong>事务：一组逻辑操作单元，使数据从一种状态变换到另一种状态。</strong><ul>
<li>一组逻辑操作单元：指一个或多个 DML 操作。</li>
</ul>
</li>
<li><strong>事务处理 (事务操作)：</strong>保证所有事务都作为一个工作单元来执行，即使出现了故障，都不能改变这种执行方式。当在一个事务中执行多个操作时，要么所有的事务都被提交 (commit)，那么这些修改就永久地保存下来；要么数据库管理系统将放弃所作的所有修改，整个事务回滚 (rollback) 到最初状态。</li>
<li>为确保数据库中数据的一致性，数据的操纵应当是离散的成组的逻辑单元：当它全部完成时，数据的一致性可以保持，而当这个单元中的一部分操作失败，整个事务应全部视为错误，所有从起始点以后的操作应全部回退到开始状态。 </li>
</ul>
<h3 id="JDBC-事务处理"><a href="#JDBC-事务处理" class="headerlink" title="JDBC 事务处理"></a>JDBC 事务处理</h3><ul>
<li><p><strong>数据一旦提交 (commit)，就不可回滚。</strong></p>
</li>
<li><p>数据什么时候会提交：</p>
<ul>
<li><strong>DDL 操作，一旦执行，都会自动提交。</strong>注意：<code>set autocommit = false</code> 对 DDL 操作无效。<ul>
<li>DDL：CREATE、ALTER、DROP、TRUNCATE、COMMENT、RENAME。</li>
</ul>
</li>
<li><strong>DML 操作，默认情况下，一旦执行，就会自动提交。</strong>可以通过 <code>set autocommit = false</code> 的方式取消 DML 操作的自动提交。<ul>
<li>DML：SELECT、INSERT、UPDATE、DELETE、MERGE、CALL、EXPLAIN PLAN、LOCK TABLE。</li>
</ul>
</li>
<li><strong>当一个连接对象被创建时，默认情况下是自动提交事务</strong>：每次执行一个 SQL 语句时，如果执行成功，就会向数据库自动提交，而不能回滚。</li>
<li><strong>关闭数据库连接时，数据也会自动的提交。</strong>如果多个操作，每个操作使用的是自己单独的连接，则无法保证事务。即同一个事务的多个操作必须在同一个连接下。</li>
</ul>
</li>
<li><p><strong>JDBC 程序中为了让多个 SQL 语句作为一个事务执行：</strong></p>
<ul>
<li><p>第一步：调用 Connection 对象的 **<code>setAutoCommit(false);</code>**，取消自动提交事务；</p>
</li>
<li><p>第二步：在所有的 SQL 语句都成功执行后，调用 **<code>commit();</code>**，提交事务；</p>
</li>
<li><p>第三步：当出现异常时，调用 **<code>rollback();</code>**，回滚事务。</p>
<blockquote>
<p>当一个事务操作结束之后，若此时 Connection 没有被关闭，还可能被重复使用，则应该调用 Connection 的 <code>setAutoCommit(true)</code>，恢复其自动提交状态 。尤其是在使用数据库连接池技术时，在执行 <code>close()</code> 关闭资源之前，建议恢复自动提交状态。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>案例：用户 AA 向用户 BB 转账 100。</p>
<ul>
<li><p>未考虑事务的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 针对于数据表user_table来说：</span></span><br><span class="line"><span class="comment">     * AA用户给BB用户转账100</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * update user_table set balance = balance - 100 where user = &#x27;AA&#x27;;</span></span><br><span class="line"><span class="comment">     * update user_table set balance = balance + 100 where user = &#x27;BB&#x27;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的增删改操作---version 1.0</span></span><br><span class="line">    <span class="comment">// ******************未考虑数据库事务情况下的转账操作**************************</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取数据库的连接</span></span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            <span class="comment">// 2.预编译sql语句，返回PreparedStatement的实例</span></span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="comment">// 3.填充占位符</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4.执行</span></span><br><span class="line">            <span class="keyword">return</span> preparedStatement.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5.资源的关闭</span></span><br><span class="line">            JDBCUtils.closeResource(connection, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String sql1 = <span class="string">&quot;update user_table set balance = balance - 100 where user = ?&quot;</span>;</span><br><span class="line">        update(sql1, <span class="string">&quot;AA&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟网络异常</span></span><br><span class="line">        System.out.println(<span class="number">10</span> / <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        String sql2 = <span class="string">&quot;update user_table set balance = balance + 100 where user = ?&quot;</span>;</span><br><span class="line">        update(sql2, <span class="string">&quot;BB&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;转账成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述代码，当出现网络异常时，AA 用户资产会少 100，但 BB 用户资产不会变化，转账过程发生错误。</p>
</blockquote>
</li>
<li><p>考虑事务的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.什么叫数据库事务？</span></span><br><span class="line"><span class="comment"> * 事务：一组逻辑操作单元,使数据从一种状态变换到另一种状态。</span></span><br><span class="line"><span class="comment"> *        &gt; 一组逻辑操作单元：一个或多个DML操作。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.事务处理的原则：保证所有事务都作为一个工作单元来执行，即使出现了故障，都不能改变这种执行方式。</span></span><br><span class="line"><span class="comment"> * 当在一个事务中执行多个操作时，要么所有的事务都被提交(commit)，那么这些修改就永久地保存</span></span><br><span class="line"><span class="comment"> * 下来；要么数据库管理系统将放弃所作的所有修改，整个事务回滚(rollback)到最初状态。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3.数据一旦提交，就不可回滚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4.哪些操作会导致数据的自动提交？</span></span><br><span class="line"><span class="comment"> *        &gt;DDL操作一旦执行，都会自动提交。</span></span><br><span class="line"><span class="comment"> *           &gt;set autocommit = false 对DDL操作失效</span></span><br><span class="line"><span class="comment"> *        &gt;DML默认情况下，一旦执行，就会自动提交。</span></span><br><span class="line"><span class="comment"> *           &gt;我们可以通过set autocommit = false的方式取消DML操作的自动提交。</span></span><br><span class="line"><span class="comment"> *        &gt;默认在关闭连接时，会自动的提交数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 针对于数据表user_table来说：</span></span><br><span class="line"><span class="comment">     * AA用户给BB用户转账100</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * update user_table set balance = balance - 100 where user = &#x27;AA&#x27;;</span></span><br><span class="line"><span class="comment">     * update user_table set balance = balance + 100 where user = &#x27;BB&#x27;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的增删改操作---version 2.0(考虑事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Connection conn, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.预编译sql语句，返回PreparedStatement的实例</span></span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            <span class="comment">// 2.填充占位符</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                ps.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.执行</span></span><br><span class="line">            <span class="keyword">return</span> ps.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4.资源的关闭</span></span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ********************考虑数据库事务后的转账操作*********************</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            System.out.println(connection.getAutoCommit());<span class="comment">// 默认为true</span></span><br><span class="line">            <span class="comment">// 1.取消数据的自动提交</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            String sql1 = <span class="string">&quot;update user_table set balance = balance - 100 where user = ?&quot;</span>;</span><br><span class="line">            update(connection, sql1, <span class="string">&quot;AA&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模拟网络异常</span></span><br><span class="line">            System.out.println(<span class="number">10</span> / <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            String sql2 = <span class="string">&quot;update user_table set balance = balance + 100 where user = ?&quot;</span>;</span><br><span class="line">            update(connection, sql2, <span class="string">&quot;BB&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;转账成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.提交数据</span></span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 3.回滚数据</span></span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.rollback();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e1) &#123;</span><br><span class="line">                    e1.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 关闭之前修改其为自动提交数据，主要针对于使用数据库连接池的使用</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述代码，是一个完整的事务操作，AA 和 BB 用户，要么资产都发生变化，要么资产都不发生变化。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="事务的-ACID-属性"><a href="#事务的-ACID-属性" class="headerlink" title="事务的 ACID 属性"></a>事务的 ACID 属性</h3><ul>
<li><p><strong>原子性 (Atomicity)</strong></p>
<ul>
<li>原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。 </li>
</ul>
</li>
<li><p><strong>一致性 (Consistency)</strong></p>
<ul>
<li>事务必须使数据库从一个一致性状态变换到另外一个一致性状态。</li>
</ul>
</li>
<li><p><strong>隔离性 (Isolation)</strong></p>
<ul>
<li><p>事务的隔离性是指一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</p>
<blockquote>
<p>参考多线程对共享数据的处理。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>持久性 (Durability)</strong></p>
<ul>
<li>持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响。</li>
</ul>
</li>
</ul>
<h4 id="数据库的并发问题"><a href="#数据库的并发问题" class="headerlink" title="数据库的并发问题"></a>数据库的并发问题</h4><ul>
<li><p>对于同时运行的多个事务，当这些事务访问数据库中相同的数据时，如果没有采取必要的隔离机制，就会导致各种并发问题：</p>
<ul>
<li><strong>脏读</strong>：对于两个事务 T1 和 T2，T1 读取了已经被 T2 更新但还<strong>没有被提交</strong>的字段。之后，若 T2 回滚，那么 T1 读取的内容就是临时且无效的。</li>
<li><strong>不可重复读</strong>：对于两个事务 T1 和 T2，T1 读取了一个字段，然后 T2 <strong>更新</strong>了该字段。之后，T1 再次读取同一个字段，值会不一样。</li>
<li><strong>幻读</strong>：对于两个事务 T1 和 T2，T1 从一个表中读取了一个字段，然后 T2 在该表中<strong>插入</strong>了一些新的行。之后, 如果 T1 再次读取同一个表，就会多出几行。</li>
</ul>
</li>
<li><p><strong>数据库事务的隔离性</strong>：数据库系统必须具有隔离并发运行各个事务的能力，使它们不会相互影响，从而避免各种并发问题。</p>
</li>
<li><p>一个事务与其他事务隔离的程度称为隔离级别。数据库规定了多种事务隔离级别，不同隔离级别对应不同的干扰程度，<strong>隔离级别越高，数据一致性就越好，但并发性越弱。</strong></p>
</li>
</ul>
<h4 id="四种隔离级别"><a href="#四种隔离级别" class="headerlink" title="四种隔离级别"></a>四种隔离级别</h4><ul>
<li><p>数据库提供了 4 种事务隔离级别：</p>
<p><img src="/2021/06/27/db-jdbc/1555586275271.png" alt="1555586275271"></p>
</li>
<li><p>Oracle 支持 2 种事务隔离级别：READ COMMITED 和 SERIALIZABLE。 Oracle 默认的事务隔离级别为 <strong>READ COMMITED</strong>。</p>
</li>
</ul>
<ul>
<li>MySQL 支持 4 种事务隔离级别。MySQL 默认的事务隔离级别为 <strong>REPEATABLE READ</strong>。</li>
<li>在开发中，要保证隔离级别至少为 READ COMMITED。如果数据库本身能够满足，不需要在代码中设置，否则，应该在代码中显式设置事物的隔离级别。</li>
</ul>
<h4 id="在-MySQL-中设置隔离级别"><a href="#在-MySQL-中设置隔离级别" class="headerlink" title="在 MySQL 中设置隔离级别"></a>在 MySQL 中设置隔离级别</h4><ul>
<li><p>每启动一个 MySQL 程序，就会获得一个单独的数据库连接。每个数据库连接都有一个全局变量 @@transaction_isolation，表示当前的事务隔离级别。</p>
</li>
<li><p>查看当前的隔离级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@transaction_isolation;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>旧版本是 @@tx_isolation。</p>
</blockquote>
</li>
<li><p>设置当前用户 MySQL 连接的隔离级别:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set transaction isolation level read committed;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置数据库系统的全局的隔离级别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global transaction isolation level read committed;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>设置隔离级别之后，需要重新连接 MySQL。</p>
</blockquote>
</li>
<li><p>补充操作：</p>
<ul>
<li><p>创建 MySQL 数据库用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user tom identified by &#39;abc123&#39;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>授予权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 授予通过网络方式登录的tom用户，对所有库所有表的全部权限，密码设为abc123</span><br><span class="line">grant all privileges on *.* to tom@&#39;%&#39;  identified by &#39;abc123&#39;; </span><br><span class="line"></span><br><span class="line"> # 给tom用户使用本地命令行方式，授予test这个库下的所有表的插删改查的权限。</span><br><span class="line">grant select, insert, delete, update on test.* to tom@localhost identified by &#39;abc123&#39;; </span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="在-JDBC-中设置隔离级别"><a href="#在-JDBC-中设置隔离级别" class="headerlink" title="在 JDBC 中设置隔离级别"></a>在 JDBC 中设置隔离级别</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通用的增删改操作---version 2.0(考虑事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Connection conn, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement ps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.预编译sql语句，返回PreparedStatement的实例</span></span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            <span class="comment">// 2.填充占位符</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                ps.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.执行</span></span><br><span class="line">            <span class="keyword">return</span> ps.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4.资源的关闭</span></span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的查询操作，用于返回数据表中的一条记录---version 2.0(考虑事务)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Connection connection, Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="comment">// 获取结果集的元数据 :ResultSetMetaData</span></span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="comment">// 通过ResultSetMetaData获取结果集中的列数</span></span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="comment">// 处理结果集一行数据中的每一个列</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    <span class="comment">// 获取列值</span></span><br><span class="line">                    Object columValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 获取每个列的列名</span></span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 给t对象指定的columnName属性，赋值为columValue：通过反射</span></span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resultSet.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (preparedStatement != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    preparedStatement.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟隔离级别测试：查询</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testTransactionSelect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            <span class="comment">// 获取当前连接的隔离级别，默认：TRANSACTION_REPEATABLE_READ</span></span><br><span class="line">            System.out.println(connection.getTransactionIsolation());</span><br><span class="line">            <span class="comment">// 设置数据库的隔离级别</span></span><br><span class="line">            connection.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);</span><br><span class="line">            <span class="comment">// 取消自动提交数据</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            String sql = <span class="string">&quot;select user, password, balance from user_table where user = ?&quot;</span>;</span><br><span class="line">            User user = getInstance(connection, User.class, sql, <span class="string">&quot;CC&quot;</span>);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟隔离级别测试：更新</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testTransactionUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 取消自动提交数据</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            String sql = <span class="string">&quot;update user_table set balance = ? where user = ?&quot;</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;开始修改&quot;</span>);</span><br><span class="line">            update(connection, sql, <span class="number">5000</span>, <span class="string">&quot;CC&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">15000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;修改结束&quot;</span>);</span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.rollback();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                    throwables.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable update = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                testTransactionUpdate();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(update).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Runnable select = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                testTransactionSelect();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(select).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DAO-及相关实现类"><a href="#DAO-及相关实现类" class="headerlink" title="DAO 及相关实现类"></a>DAO 及相关实现类</h2><ul>
<li>DAO：Data Access Object，访问数据信息的类和接口，包括了对数据的 CRUD (Create、Retrival、Update、Delete) 操作，但不包含任何业务相关的信息。有时也称作 BaseDAO。</li>
<li>作用：为了实现功能的模块化，更有利于代码的维护和升级。</li>
<li>下面是尚硅谷 JavaWeb 阶段书城项目中 DAO 使用的体现：</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1566726681515.png" alt="1566726681515"></p>
<ul>
<li>层次结构：</li>
</ul>
<p><img src="/2021/06/27/db-jdbc/1566745811244.png" alt="1566745811244"></p>
<h3 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h3><ul>
<li><p>Page.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Page</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAGE_SIZE = <span class="number">4</span>; <span class="comment">// 每页显示的记录数</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pageNo; <span class="comment">// 当前页</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list; <span class="comment">// 每页查到的记录存放的集合</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// private int totalPageNo; // 总页数，通过计算得到</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> totalRecord; <span class="comment">// 总记录数，通过查询数据库得到</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPageNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pageNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageNo</span><span class="params">(<span class="keyword">int</span> pageNo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pageNo = pageNo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTotalRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalRecord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalRecord</span><span class="params">(<span class="keyword">int</span> totalRecord)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.totalRecord = totalRecord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Page&#123;&quot;</span> + <span class="string">&quot;list=&quot;</span> + list + <span class="string">&quot;, pageNo=&quot;</span> + pageNo + <span class="string">&quot;, totalRecord=&quot;</span> + totalRecord + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Customer.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(<span class="keyword">int</span> id, String name, String email, Date birth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">        <span class="keyword">this</span>.birth = birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirth</span><span class="params">(Date birth)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birth = birth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Customer [id=&quot;</span> + id + <span class="string">&quot;, name=&quot;</span> + name + <span class="string">&quot;, email=&quot;</span> + email + <span class="string">&quot;, birth=&quot;</span> + birth + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>BaseDao.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAO: Data(base) Access Object</span></span><br><span class="line"><span class="comment"> * 封装了针对于数据表的通用的操作，声明为abstact类，不能被实例化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通用的增删改操作---version 2.0(考虑上事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> preparedStatement.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的查询操作，用于返回数据表中的一条记录---version 2.0(考虑上事务)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Connection connection, Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的查询操作，用于返回数据表中的多条记录构成的集合---version 2.0(考虑事务)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getForList</span><span class="params">(Connection connection, Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            ArrayList&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">            <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                list.add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于查询特殊值的通用的方法，比如：select count(*) from test;</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="function">E <span class="title">getValue</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> (E) resultSet.getObject(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>BaseDao 中未指定泛型，<code>getInstance()</code> 和 <code>getForList()</code> 两个方法是泛型方法，每个子类在实现这两个方法时，都需要传入一个对应的 Class 参数，实际上这个参数是可以省略的。</p>
</blockquote>
</li>
<li><p>CustomerDao.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 此接口用于规范针对于customers表的常用操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomerDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 将customer对象添加到数据库中</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Connection connection, Customer customer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 针对指定的id，删除表中的一条记录</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 针对内存中的customer对象，去修改数据表中指定的记录</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(Connection connection, Customer customer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 针对指定的id查询得到对应的customer对象</span></span><br><span class="line">    <span class="function">Customer <span class="title">getCustomerById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询表中的所有记录构成的集合</span></span><br><span class="line">    <span class="function">List&lt;Customer&gt; <span class="title">getAll</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据表中的数据的条目数</span></span><br><span class="line">    <span class="function">Long <span class="title">getCount</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回数据表中最大的生日</span></span><br><span class="line">    <span class="function">Date <span class="title">getMaxBirth</span><span class="params">(Connection connection)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取带分页的Customer信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page：是只包含了用户输入的pageNo属性的Page对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回的Page对象是包含了所有属性的Page对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Page&lt;Customer&gt; <span class="title">getPageCustomers</span><span class="params">(Connection connection, Page&lt;Customer&gt; page)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取带分页和生日范围的Customer信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page：是只包含了用户输入的pageNo属性的Page对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回的Page对象是包含了所有属性的Page对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Page&lt;Customer&gt; <span class="title">getPageCustomersByBirth</span><span class="params">(Connection connection, Page&lt;Customer&gt; page, Date minBirth, Date maxBirth)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>CustomerDaoImpl.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerDaoImpl</span> <span class="keyword">extends</span> <span class="title">BaseDao</span> <span class="keyword">implements</span> <span class="title">CustomerDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Connection connection, Customer customer)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;insert into customers(name, email, birth) values(?, ?, ?)&quot;</span>;</span><br><span class="line">        update(connection, sql, customer.getName(), customer.getEmail(), customer.getBirth());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;delete from customers where id = ?&quot;</span>;</span><br><span class="line">        update(connection, sql, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Connection connection, Customer customer)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update customers set name = ?, email = ?, birth = ? where id = ?&quot;</span>;</span><br><span class="line">        update(connection, sql, customer.getName(), customer.getEmail(), customer.getBirth(), customer.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getInstance(connection, Customer.class, sql, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">getAll</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getForList(connection, Customer.class, sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getCount</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select count(*) from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getValue(connection, sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getMaxBirth</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select max(birth) from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getValue(connection, sql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Customer&gt; <span class="title">getPageCustomers</span><span class="params">(Connection connection, Page&lt;Customer&gt; page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取数据库中Customer的总数</span></span><br><span class="line">        String sql = <span class="string">&quot;select count(*) from customers&quot;</span>;</span><br><span class="line">        <span class="comment">// 调用BaseDao中获取一个单一值的方法</span></span><br><span class="line">        <span class="keyword">long</span> totalRecord = (<span class="keyword">long</span>) getValue(connection, sql);</span><br><span class="line">        <span class="comment">// 将总数设置都page对象中</span></span><br><span class="line">        page.setTotalRecord((<span class="keyword">int</span>) totalRecord);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前页中的记录存放的List</span></span><br><span class="line">        String sql2 = <span class="string">&quot;select id, name, email, birth from customers limit ?, ?&quot;</span>;</span><br><span class="line">        <span class="comment">// 调用BaseDao中获取一个集合的方法</span></span><br><span class="line">        List&lt;Customer&gt; beanList = getForList(connection, sql2, (page.getPageNo() - <span class="number">1</span>) * Page.PAGE_SIZE, Page.PAGE_SIZE);</span><br><span class="line">        <span class="comment">// 将这个List设置到page对象中</span></span><br><span class="line">        page.setList(beanList);</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;Customer&gt; <span class="title">getPageCustomersByBirth</span><span class="params">(Connection connection, Page&lt;Customer&gt; page, Date minBirth, Date maxBirth)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取数据库中Customer的总数</span></span><br><span class="line">        String sql = <span class="string">&quot;select count(*) from customers where birth between ? and ?&quot;</span>;</span><br><span class="line">        <span class="comment">// 调用BaseDao中获取一个单一值的方法</span></span><br><span class="line">        <span class="keyword">long</span> totalRecord = getValue(connection, sql, minBirth, maxBirth);</span><br><span class="line">        <span class="comment">// 将总数设置都page对象中</span></span><br><span class="line">        page.setTotalRecord((<span class="keyword">int</span>) totalRecord);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前页中的记录存放的List</span></span><br><span class="line">        String sql2 = <span class="string">&quot;select id, name, email, birth from customers where birth between ? and ? limit ?, ?&quot;</span>;</span><br><span class="line">        <span class="comment">// 调用BaseDao中获取一个集合的方法</span></span><br><span class="line">        List&lt;Customer&gt; beanList = getForList(connection, sql2, minBirth, maxBirth, (page.getPageNo() - <span class="number">1</span>) * Page.PAGE_SIZE, Page.PAGE_SIZE);</span><br><span class="line">        <span class="comment">// 将这个List设置到page对象中</span></span><br><span class="line">        page.setList(beanList);</span><br><span class="line">        <span class="keyword">return</span> page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CustomerDaoImpl 实现父类 BaseDao 的 <code>getInstance()</code> 和 <code>getForList()</code> 方法，需要传入 Customer.class 参数。</p>
</blockquote>
</li>
<li><p>CustomerDaoImplTest.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomerDaoImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomerDaoImpl dao = <span class="keyword">new</span> CustomerDaoImpl();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Customer customer = <span class="keyword">new</span> Customer(<span class="number">1</span>, <span class="string">&quot;于小飞&quot;</span>, <span class="string">&quot;xiaofei@126.com&quot;</span>, <span class="keyword">new</span> Date(<span class="number">43534646435L</span>));</span><br><span class="line">            dao.insert(connection, customer);</span><br><span class="line">            System.out.println(<span class="string">&quot;添加成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            dao.deleteById(connection, <span class="number">22</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Customer customer = <span class="keyword">new</span> Customer(<span class="number">18</span>, <span class="string">&quot;贝多芬&quot;</span>, <span class="string">&quot;beiduofen@126.com&quot;</span>, <span class="keyword">new</span> Date(<span class="number">453465656L</span>));</span><br><span class="line">            dao.update(connection, customer);</span><br><span class="line">            System.out.println(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetCustomerById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Customer customer = dao.getCustomerById(connection, <span class="number">20</span>);</span><br><span class="line">            System.out.println(customer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            List&lt;Customer&gt; list = dao.getAll(connection);</span><br><span class="line">            list.forEach(System.out::println);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Long count = dao.getCount(connection);</span><br><span class="line">            System.out.println(<span class="string">&quot;表中的记录数为：&quot;</span> + count);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetMaxBirth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Date maxBirth = dao.getMaxBirth(connection);</span><br><span class="line">            System.out.println(<span class="string">&quot;最大的生日为：&quot;</span> + maxBirth);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetPageCustomers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Page&lt;Customer&gt; page = <span class="keyword">new</span> Page&lt;&gt;();</span><br><span class="line">            page.setPageNo(<span class="number">2</span>);<span class="comment">// 查询第二页</span></span><br><span class="line">            page = dao.getPageCustomers(connection, page);</span><br><span class="line">            System.out.println(page);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetPageCustomersByBirth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getConnection();</span><br><span class="line">            Page&lt;Customer&gt; page = <span class="keyword">new</span> Page&lt;&gt;();</span><br><span class="line">            page.setPageNo(<span class="number">1</span>);<span class="comment">// 查询第二页</span></span><br><span class="line">            SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">            java.util.Date minDate = sdf.parse(<span class="string">&quot;1984-01-01&quot;</span>);</span><br><span class="line">            java.util.Date maxDate = sdf.parse(<span class="string">&quot;2010-12-31&quot;</span>);</span><br><span class="line">            page = dao.getPageCustomersByBirth(connection, page, <span class="keyword">new</span> Date(minDate.getTime()), <span class="keyword">new</span> Date(maxDate.getTime()));</span><br><span class="line">            System.out.println(page);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(connection, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><ul>
<li><p>在 BaseDao 中添加泛型，同步修改 CustomerDaoImpl 的相应代码：</p>
</li>
<li><p>BaseDao.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DAO: Data(base) Access Object</span></span><br><span class="line"><span class="comment"> * 封装了针对于数据表的通用的操作，声明为abstact类，不能被实例化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDao</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 在构造器中，或者代码块中赋值，clazz就是当前类的父类的泛型参数</span></span><br><span class="line">    <span class="comment">// 比如当前类为CustomerDaoImpl，clazz就是它的父类BaseDao&lt;Customer&gt;的泛型参数</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; clazz;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 方式一：获取T的Class对象，获取泛型的类型，泛型是在被子类继承时才确定</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 获取子类的类型</span></span><br><span class="line">		Class clazz = <span class="keyword">this</span>.getClass();</span><br><span class="line">		<span class="comment">// 获取父类的类型</span></span><br><span class="line">		<span class="comment">// getGenericSuperclass()用来获取当前类的父类的类型</span></span><br><span class="line">		<span class="comment">// ParameterizedType表示的是带泛型的类型</span></span><br><span class="line">		ParameterizedType parameterizedType = (ParameterizedType) clazz.getGenericSuperclass();</span><br><span class="line">		<span class="comment">// 获取具体的泛型类型 getActualTypeArguments获取具体的泛型的类型</span></span><br><span class="line">		<span class="comment">// 这个方法会返回一个Type的数组</span></span><br><span class="line">		Type[] types = parameterizedType.getActualTypeArguments();</span><br><span class="line">		<span class="comment">// 获取具体的泛型的类型·</span></span><br><span class="line">		<span class="keyword">this</span>.type = (Class&lt;T&gt;) types[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方式二：</span></span><br><span class="line">    <span class="comment">/*&#123;</span></span><br><span class="line"><span class="comment">        Type genericSuperclass = this.getClass().getGenericSuperclass();</span></span><br><span class="line"><span class="comment">        ParameterizedType parameterizedType = (ParameterizedType) genericSuperclass;</span></span><br><span class="line"><span class="comment">        Type[] actualTypeArguments = parameterizedType.getActualTypeArguments();// 获取了父类的泛型参数</span></span><br><span class="line"><span class="comment">        clazz = (Class&lt;T&gt;) actualTypeArguments[0];// 泛型的第一个参数</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的增删改操作---version 2.0(考虑上事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> preparedStatement.executeUpdate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的查询操作，用于返回数据表中的一条记录---version 2.0(考虑上事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getInstance</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通用的查询操作，用于返回数据表中的多条记录构成的集合---version 2.0(考虑事务)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getForList</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            ResultSetMetaData resultSetMetaData = resultSet.getMetaData();</span><br><span class="line">            <span class="keyword">int</span> columnCount = resultSetMetaData.getColumnCount();</span><br><span class="line">            ArrayList&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">            <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">                T t = clazz.newInstance();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; columnCount; i++) &#123;</span><br><span class="line">                    Object columnValue = resultSet.getObject(i + <span class="number">1</span>);</span><br><span class="line">                    String columnLabel = resultSetMetaData.getColumnLabel(i + <span class="number">1</span>);</span><br><span class="line">                    Field field = clazz.getDeclaredField(columnLabel);</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(t, columnValue);</span><br><span class="line">                &#125;</span><br><span class="line">                list.add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于查询特殊值的通用的方法，比如：select count(*) from test;</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E&gt; <span class="function">E <span class="title">getValue</span><span class="params">(Connection connection, String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line">        ResultSet resultSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                preparedStatement.setObject(i + <span class="number">1</span>, args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            resultSet = preparedStatement.executeQuery();</span><br><span class="line">            <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                <span class="keyword">return</span> (E) resultSet.getObject(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResource(<span class="keyword">null</span>, preparedStatement, resultSet);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>BaseDao 中添加了泛型参数，每一个子类在继承时，直接添加对应的 Class，这样在方法中，就不需要再单独传入 Class 参数。</p>
</blockquote>
</li>
<li><p>CustomerDaoImpl.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerDaoImpl</span> <span class="keyword">extends</span> <span class="title">BaseDao</span>&lt;<span class="title">Customer</span>&gt; <span class="keyword">implements</span> <span class="title">CustomerDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Connection connection, Customer customer)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;insert into customers(name, email, birth) values(?, ?, ?)&quot;</span>;</span><br><span class="line">        update(connection, sql, customer.getName(), customer.getEmail(), customer.getBirth());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;delete from customers where id = ?&quot;</span>;</span><br><span class="line">        update(connection, sql, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Connection connection, Customer customer)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update customers set name = ?, email = ?, birth = ? where id = ?&quot;</span>;</span><br><span class="line">        update(connection, sql, customer.getName(), customer.getEmail(), customer.getBirth(), customer.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Customer <span class="title">getCustomerById</span><span class="params">(Connection connection, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getInstance(connection, sql, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">getAll</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select id, name, email, birth from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getForList(connection, sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getCount</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select count(*) from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getValue(connection, sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getMaxBirth</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select max(birth) from customers&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> getValue(connection, sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h2><h3 id="JDBC-数据库连接池的必要性"><a href="#JDBC-数据库连接池的必要性" class="headerlink" title="JDBC 数据库连接池的必要性"></a>JDBC 数据库连接池的必要性</h3><ul>
<li><p>在使用开发基于数据库的 Web 程序时，传统的模式基本是按以下步骤：　　</p>
<ul>
<li><strong>在主程序 (如 servlet、beans) 中建立数据库连接；</strong></li>
<li><strong>进行 SQL 操作；</strong></li>
<li><strong>断开数据库连接。</strong></li>
</ul>
</li>
<li><p>这种模式开发，存在的问题:</p>
<ul>
<li>普通的 JDBC 数据库连接使用 DriverManager 来获取，每次向数据库建立连接的时候都要将 Connection 加载到内存中，再验证用户名和密码 (需要耗费 0.05s～1s 的时间)。当需要数据库连接的时候，就向数据库要求一个，执行完成后再断开连接。这样的方式将会消耗大量的资源和时间。<strong>数据库的连接资源并没有得到很好的重复利用。</strong>若同时有几百人甚至几千人在线，频繁的进行数据库连接操作将占用很多的系统资源，严重的甚至会造成服务器的崩溃。</li>
<li><strong>对于每一次数据库连接，使用完后都得断开。</strong>否则，如果程序出现异常而未能关闭，将会导致数据库系统中的内存泄漏，最终将导致重启数据库。</li>
<li><strong>这种开发不能控制被创建的连接对象数</strong>，系统资源会被毫无顾及的分配出去，如连接过多，也可能导致内存泄漏，服务器崩溃。 </li>
</ul>
</li>
</ul>
<h3 id="数据库连接池技术"><a href="#数据库连接池技术" class="headerlink" title="数据库连接池技术"></a>数据库连接池技术</h3><ul>
<li><p>为解决传统开发中的数据库连接问题，可以采用数据库连接池技术。</p>
</li>
<li><p><strong>数据库连接池的基本思想</strong>：就是为数据库连接建立一个”缓冲池”。预先在缓冲池中放入一定数量的连接，当需要建立数据库连接时，只需从”缓冲池”中取出一个，使用完毕之后再放回去。</p>
</li>
<li><p><strong>数据库连接池负责分配、管理和释放数据库连接，它允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个</strong>。</p>
</li>
<li><p>数据库连接池在初始化时，会创建一定数量的数据库连接放到连接池中，这些数据库连接的数量是由<strong>最小数据库连接数来设定</strong>的。无论这些数据库连接是否被使用，连接池都将一直保证至少拥有这么多的连接数量。连接池的<strong>最大数据库连接数量</strong>限定了这个连接池能占有的最大连接数，当应用程序向连接池请求的连接数超过最大连接数量时，这些请求将被加入到等待队列中。</p>
<img src="/2021/06/27/db-jdbc/1555593464033.png" alt="1555593464033" style="zoom:80%;">
</li>
<li><p><strong>工作原理：</strong></p>
<p><img src="/2021/06/27/db-jdbc/1555593598606.png" alt="1555593598606"></p>
</li>
<li><p><strong>数据库连接池技术的优点：</strong></p>
<ul>
<li><strong>资源重用</strong><ul>
<li>由于数据库连接得以重用，避免了频繁创建、释放连接所引起的大量性能开销。在减少系统消耗的基础上，另一方面也增加了系统运行环境的平稳性。</li>
</ul>
</li>
<li><strong>更快的系统反应速度</strong><ul>
<li>数据库连接池在初始化过程中，往往已经创建了若干数据库连接置于连接池中备用。此时连接的初始化工作均已完成。对于业务请求处理而言，直接利用现有可用连接，避免了数据库连接初始化和释放过程的时间开销，从而减少了系统的响应时间。</li>
</ul>
</li>
<li><strong>新的资源分配手段</strong><ul>
<li>对于多应用共享同一数据库的系统而言，可在应用层通过数据库连接池的配置，实现某一应用最大可用数据库连接数的限制，避免某一应用独占所有的数据库资源。</li>
</ul>
</li>
<li><strong>统一的连接管理，避免数据库连接泄漏</strong><ul>
<li>在较为完善的数据库连接池实现中，可根据预先的占用超时设定，强制回收被占用连接，从而避免了常规数据库连接操作中可能出现的资源泄露。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="多种开源的数据库连接池"><a href="#多种开源的数据库连接池" class="headerlink" title="多种开源的数据库连接池"></a>多种开源的数据库连接池</h3><ul>
<li>JDBC 的数据库连接池使用 <code>javax.sql.DataSource</code> 来表示，DataSource 是一个接口，该接口通常由服务器 (如 Weblogic，WebSphere，Tomcat 等) 提供实现，也有一些开源组织提供实现：<ul>
<li>DBCP：是 Apache 提供的数据库连接池。Tomcat 服务器自带 DBCP 数据库连接池。速度相对 C3P0 较快，但因自身存在 BUG，Hibernate3 已不再提供支持。</li>
<li>C3P0：是一个开源组织提供的一个数据库连接池，速度相对较慢，稳定性还可以。Hibernate 官方推荐使用。</li>
<li>Proxool：是 sourceforge 下的一个开源项目数据库连接池，有监控连接池状态的功能，稳定性较 C3P0 差一点。</li>
<li>BoneCP：是一个开源组织提供的数据库连接池，速度快。</li>
<li><strong>Druid</strong>：是阿里提供的数据库连接池，据说是集DBCP 、C3P0 、Proxool 优点于一身的数据库连接池，但是速度不确定是否有BoneCP快</li>
</ul>
</li>
<li>DataSource 通常被称为数据源，它包含连接池和连接池管理两个部分，习惯上也经常把 DataSource 称为连接池。</li>
<li><strong>DataSource 用来取代 DriverManager 来获取 Connection，获取速度快，同时可以大幅度提高数据库访问速度。</strong></li>
<li>特别注意：<ul>
<li>数据源和数据库连接不同，数据源无需创建多个，它是产生数据库连接的工厂，因此，<strong>整个应用只需要一个数据源即可。</strong></li>
<li>当数据库访问结束后，程序还是像以前一样关闭数据库连接：<code>connection.close();</code>，但 <code>connection.close()</code> 并没有关闭数据库的物理连接，它仅仅把数据库连接释放，将其归还给了数据库连接池。</li>
</ul>
</li>
</ul>
<h4 id="C3P0-数据库连接池"><a href="#C3P0-数据库连接池" class="headerlink" title="C3P0 数据库连接池"></a>C3P0 数据库连接池</h4><ul>
<li><p>Maven 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取连接方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0Test</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式一：不推荐</span></span><br><span class="line">    <span class="keyword">private</span> ComboPooledDataSource cpds = <span class="keyword">new</span> ComboPooledDataSource();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建c3p0数据库连接池</span></span><br><span class="line">            cpds.setDriverClass(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">            cpds.setJdbcUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>);</span><br><span class="line">            cpds.setUser(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">            cpds.setPassword(<span class="string">&quot;abc123&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过设置相关的参数，对数据库连接池进行管理</span></span><br><span class="line">            cpds.setInitialPoolSize(<span class="number">10</span>);<span class="comment">// 设置初始时数据库连接池中的连接数</span></span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (PropertyVetoException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getC3P0Connection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection connection = cpds.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 销毁c3p0数据库连接池的方法，了解，不要轻易使用</span></span><br><span class="line">        <span class="comment">// DataSources.destroy(cpds);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取连接方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0Test</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式二：使用配置文件，推荐</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource cpds = <span class="keyword">new</span> ComboPooledDataSource(<span class="string">&quot;helloc3p0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getC3P0Connection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Connection connection = cpds.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c3p0-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">named-config</span> <span class="attr">name</span>=<span class="string">&quot;helloc3p0&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 获取连接的4个基本信息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果连接本地3306端口，可以简写为：jdbc:mysql:///test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/test<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>abc123<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 涉及到数据库连接池的管理的常用相关属性的设置 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 若数据库中连接数不足时，一次向数据库服务器申请多少个连接 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;acquireIncrement&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 初始化数据库连接池时连接的数量 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialPoolSize&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库连接池中的最小的数据库连接数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minPoolSize&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库连接池中的最大的数据库连接数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- C3P0数据库连接池可以维护的Statement的个数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxStatements&quot;</span>&gt;</span>20<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 每个连接同时可以使用的Statement对象的个数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxStatementsPerConnection&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">named-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c3p0-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>c3p0-config.xml 配置文件，在 resourcs 目录下新建。</p>
</blockquote>
</li>
</ul>
<h4 id="DBCP-数据库连接池"><a href="#DBCP-数据库连接池" class="headerlink" title="DBCP 数据库连接池"></a>DBCP 数据库连接池</h4><ul>
<li><p>DBCP 是 Apache 软件基金组织下的开源连接池实现，该连接池依赖该组织下的另一个开源系统：Common-pool。如需使用该连接池实现，应在系统中增加如下两个 jar 文件：</p>
<ul>
<li>Commons-dbcp.jar：连接池的实现。</li>
<li>Commons-pool.jar：连接池实现的依赖库。</li>
</ul>
</li>
<li><p><strong>Tomcat 的连接池正是采用该连接池来实现的。</strong>该数据库连接池既可以与应用服务器整合使用，也可由应用程序独立使用。</p>
</li>
<li><p>配置属性说明：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>initialSize</td>
<td>0</td>
<td>连接池启动时创建的初始化连接数量</td>
</tr>
<tr>
<td>maxActive</td>
<td>8</td>
<td>连接池中可同时连接的最大的连接数</td>
</tr>
<tr>
<td>maxIdle</td>
<td>8</td>
<td>连接池中最大的空闲的连接数，超过的空闲连接将被释放，如果设置为负数表示不限制</td>
</tr>
<tr>
<td>minIdle</td>
<td>0</td>
<td>连接池中最小的空闲的连接数，低于这个数量会被创建新的连接。该参数越接近maxIdle，性能越好，因为连接的创建和销毁，都是需要消耗资源的；但是不能太大。</td>
</tr>
<tr>
<td>maxWait</td>
<td>无限制</td>
<td>最大等待时间，当没有可用连接时，连接池等待连接释放的最大时间，超过该时间限制会抛出异常，如果设置-1表示无限等待</td>
</tr>
<tr>
<td>poolPreparedStatements</td>
<td>false</td>
<td>开启池的Statement是否prepared</td>
</tr>
<tr>
<td>maxOpenPreparedStatements</td>
<td>无限制</td>
<td>开启池的prepared 后的同时最大连接数</td>
</tr>
<tr>
<td>minEvictableIdleTimeMillis</td>
<td></td>
<td>连接池中连接，在时间段内一直空闲， 被逐出连接池的时间</td>
</tr>
<tr>
<td>removeAbandonedTimeout</td>
<td>300</td>
<td>超过时间限制，回收没有用(废弃)的连接</td>
</tr>
<tr>
<td>removeAbandoned</td>
<td>false</td>
<td>超过removeAbandonedTimeout时间后，是否进 行没用连接（废弃）的回收</td>
</tr>
</tbody></table>
</li>
<li><p>Maven 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/27/db-jdbc/image-20210702172610516.png" alt="image-20210702172610516"></p>
</li>
<li><p>获取连接方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBCPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式一：不推荐</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasicDataSource source = <span class="keyword">new</span> BasicDataSource();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 设置基本信息</span></span><br><span class="line">        source.setDriverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        source.setUrl(<span class="string">&quot;jdbc:mysql:///test&quot;</span>);</span><br><span class="line">        source.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        source.setPassword(<span class="string">&quot;abc123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置其他涉及数据库连接池管理的相关属性：</span></span><br><span class="line">        source.setInitialSize(<span class="number">10</span>);</span><br><span class="line">        source.setMaxActive(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getDbcpConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = source.getConnection();</span><br><span class="line">            System.out.println(connection);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">            throwables.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取连接方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBCPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式二：使用配置文件，推荐</span></span><br><span class="line">    <span class="keyword">private</span> DataSource source = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="comment">// 方式1：</span></span><br><span class="line">            <span class="comment">// FileInputStream is = new FileInputStream(new File(&quot;dbcp.properties&quot;));</span></span><br><span class="line">            <span class="comment">// 方式2：</span></span><br><span class="line">            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;dbcp.properties&quot;</span>);</span><br><span class="line">            properties.load(is);</span><br><span class="line">            source = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getDbcpConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection connection = source.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true&amp;useServerPrepStmts=false</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br><span class="line"><span class="attr">initialSize</span>=<span class="string">10</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>dbcp.properties 配置文件，在 resourcs 目录下新建。</p>
</blockquote>
</li>
</ul>
<h4 id="Druid-德鲁伊-数据库连接池"><a href="#Druid-德鲁伊-数据库连接池" class="headerlink" title="Druid (德鲁伊) 数据库连接池"></a>Druid (德鲁伊) 数据库连接池</h4><ul>
<li><p>Druid是阿里巴巴开源平台上一个数据库连接池实现，它结合了C3P0、DBCP、Proxool等DB池的优点，同时加入了日志监控，可以很好的监控DB池连接和SQL的执行情况，可以说是针对监控而生的DB连接池，<strong>可以说是目前最好的连接池之一。</strong></p>
</li>
<li><p>详细配置参数：</p>
<table>
<thead>
<tr>
<th><strong>配置</strong></th>
<th><strong>缺省</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td></td>
<td>配置这个属性的意义在于，如果存在多个数据源，监控的时候可以通过名字来区分开来。   如果没有配置，将会生成一个名字，格式是：”DataSource-” +   System.identityHashCode(this)</td>
</tr>
<tr>
<td>url</td>
<td></td>
<td>连接数据库的url，不同数据库不一样。例如：mysql :   jdbc:mysql://10.20.153.104:3306/druid2      oracle :   jdbc:oracle:thin:@10.20.149.85:1521:ocnauto</td>
</tr>
<tr>
<td>username</td>
<td></td>
<td>连接数据库的用户名</td>
</tr>
<tr>
<td>password</td>
<td></td>
<td>连接数据库的密码。如果你不希望密码直接写在配置文件中，可以使用ConfigFilter。详细看这里：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E4%BD%BF%E7%94%A8ConfigFilter">https://github.com/alibaba/druid/wiki/%E4%BD%BF%E7%94%A8ConfigFilter</a></td>
</tr>
<tr>
<td>driverClassName</td>
<td></td>
<td>根据url自动识别   这一项可配可不配，如果不配置druid会根据url自动识别dbType，然后选择相应的driverClassName(建议配置下)</td>
</tr>
<tr>
<td>initialSize</td>
<td>0</td>
<td>初始化时建立物理连接的个数。初始化发生在显示调用init方法，或者第一次getConnection时</td>
</tr>
<tr>
<td>maxActive</td>
<td>8</td>
<td>最大连接池数量</td>
</tr>
<tr>
<td>maxIdle</td>
<td>8</td>
<td>已经不再使用，配置了也没效果</td>
</tr>
<tr>
<td>minIdle</td>
<td></td>
<td>最小连接池数量</td>
</tr>
<tr>
<td>maxWait</td>
<td></td>
<td>获取连接时最大等待时间，单位毫秒。配置了maxWait之后，缺省启用公平锁，并发效率会有所下降，如果需要可以通过配置useUnfairLock属性为true使用非公平锁。</td>
</tr>
<tr>
<td>poolPreparedStatements</td>
<td>false</td>
<td>是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle。在mysql下建议关闭。</td>
</tr>
<tr>
<td>maxOpenPreparedStatements</td>
<td>-1</td>
<td>要启用PSCache，必须配置大于0，当大于0时，poolPreparedStatements自动触发修改为true。在Druid中，不会存在Oracle下PSCache占用内存过多的问题，可以把这个数值配置大一些，比如说100</td>
</tr>
<tr>
<td>validationQuery</td>
<td></td>
<td>用来检测连接是否有效的sql，要求是一个查询语句。如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会其作用。</td>
</tr>
<tr>
<td>testOnBorrow</td>
<td>true</td>
<td>申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。</td>
</tr>
<tr>
<td>testOnReturn</td>
<td>false</td>
<td>归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能</td>
</tr>
<tr>
<td>testWhileIdle</td>
<td>false</td>
<td>建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。</td>
</tr>
<tr>
<td>timeBetweenEvictionRunsMillis</td>
<td></td>
<td>有两个含义： 1)Destroy线程会检测连接的间隔时间2)testWhileIdle的判断依据，详细看testWhileIdle属性的说明</td>
</tr>
<tr>
<td>numTestsPerEvictionRun</td>
<td></td>
<td>不再使用，一个DruidDataSource只支持一个EvictionRun</td>
</tr>
<tr>
<td>minEvictableIdleTimeMillis</td>
<td></td>
<td></td>
</tr>
<tr>
<td>connectionInitSqls</td>
<td></td>
<td>物理连接初始化的时候执行的sql</td>
</tr>
<tr>
<td>exceptionSorter</td>
<td></td>
<td>根据dbType自动识别   当数据库抛出一些不可恢复的异常时，抛弃连接</td>
</tr>
<tr>
<td>filters</td>
<td></td>
<td>属性类型是字符串，通过别名的方式配置扩展插件，常用的插件有：监控统计用的filter：stat；日志用的filter：log4j；防御sql注入的filter：wall。</td>
</tr>
<tr>
<td>proxyFilters</td>
<td></td>
<td>类型是List，如果同时配置了filters和proxyFilters，是组合关系，并非替换关系</td>
</tr>
</tbody></table>
</li>
<li><p>Maven 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取连接方式一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式一：不推荐</span></span><br><span class="line">    <span class="keyword">private</span> DruidDataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 设置基本信息</span></span><br><span class="line">        dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        dataSource.setUrl(<span class="string">&quot;jdbc:mysql:///test&quot;</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">&quot;abc123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置其他涉及数据库连接池管理的相关属性：</span></span><br><span class="line">        dataSource.setInitialSize(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getDruidConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection connection = dataSource.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取连接方式二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 方式二：使用配置文件，推荐</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;druid.properties&quot;</span>);</span><br><span class="line">            properties.load(is);</span><br><span class="line">            dataSource = DruidDataSourceFactory.createDataSource(properties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getDruidConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection connection = dataSource.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br><span class="line"><span class="attr">initialSize</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">maxActive</span>=<span class="string">20</span></span><br><span class="line"><span class="attr">maxWait</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">filters</span>=<span class="string">wall</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>druid.properties 配置文件，在 resourcs 目录下新建。</p>
</blockquote>
</li>
</ul>
<h2 id="Apache-DBUtils-实现-CRUD-操作"><a href="#Apache-DBUtils-实现-CRUD-操作" class="headerlink" title="Apache-DBUtils 实现 CRUD 操作"></a>Apache-DBUtils 实现 CRUD 操作</h2><h3 id="Apache-DBUtils-简介"><a href="#Apache-DBUtils-简介" class="headerlink" title="Apache-DBUtils 简介"></a>Apache-DBUtils 简介</h3><ul>
<li><p><code>commons-dbutils</code> 是 Apache 组织提供的一个开源 JDBC工具类库，它是对 JDBC 的简单封装，学习成本极低，并且使用 DBUtils 能极大简化 JDBC 编码的工作量，同时也不会影响程序的性能。</p>
</li>
<li><p>API 介绍：</p>
<ul>
<li><code>org.apache.commons.dbutils.DbUtils</code><ul>
<li>工具类。</li>
</ul>
</li>
<li><code>org.apache.commons.dbutils.QueryRunner</code><ul>
<li>提供数据库操作的一系列重载的 <code>update()</code> 和 <code>query()</code> 操作。</li>
</ul>
</li>
<li><code>org.apache.commons.dbutils.ResultSetHandler</code><ul>
<li>此接口用于处理数据库查询操作得到的结果集。不同的结果集的情形，由其不同的子类来实现。</li>
</ul>
</li>
</ul>
</li>
<li><p>Maven 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="主要-API-的使用"><a href="#主要-API-的使用" class="headerlink" title="主要 API 的使用"></a>主要 API 的使用</h3><h4 id="DbUtils"><a href="#DbUtils" class="headerlink" title="DbUtils"></a>DbUtils</h4><ul>
<li>DbUtils ：提供如关闭连接、装载 JDBC 驱动程序等常规工作的工具类，里面的所有方法都是静态的。</li>
<li>主要方法如下：<ul>
<li><code>public static void close(…) throws java.sql.SQLException</code>：　DbUtils 类提供了三个重载的关闭方法。这些方法检查所提供的参数是不是 null，如果不是的话，它们就关闭 Connection、Statement 和 ResultSet。</li>
<li><code>public static void closeQuietly(…)</code>：这一类方法不仅能在 Connection、Statement 和 ResultSet 为 null 情况下避免关闭，还能隐藏一些在程序中抛出的 SQLEeception。</li>
<li><code>public static void commitAndClose(Connection connection)throws SQLException</code>： 用来提交连接的事务，然后关闭连接。</li>
<li><code>public static void commitAndCloseQuietly(Connection connection)</code>： 用来提交连接，然后关闭连接，并且在关闭连接时不抛出 SQL 异常。 </li>
<li><code>public static void rollback(Connection connection)throws SQLException</code>：允许 connection 为 null，因为方法内部做了判断。</li>
<li><code>public static void rollbackAndClose(Connection connection)throws SQLException</code></li>
<li><code>rollbackAndCloseQuietly(Connection connection)</code></li>
<li><code>public static boolean loadDriver(java.lang.String driverClassName)</code>：这一方装载并注册 JDBC 驱动程序，如果成功就返回 true。使用该方法，你不需要捕捉 ClassNotFoundException 异常。</li>
</ul>
</li>
</ul>
<h4 id="QueryRunner类"><a href="#QueryRunner类" class="headerlink" title="QueryRunner类"></a>QueryRunner类</h4><ul>
<li><p><strong>该类简单化了 SQL 查询，它与 ResultSetHandler 组合在一起使用可以完成大部分的数据库操作，能够大大减少编码量。</strong></p>
</li>
<li><p>QueryRunner 类提供了两个构造器：</p>
<ul>
<li>默认的构造器。</li>
<li>需要一个 <code>javax.sql.DataSource</code> 来作参数的构造器。</li>
</ul>
</li>
<li><p>QueryRunner类的主要方法：</p>
<ul>
<li><strong>更新</strong><ul>
<li><code>public int update(Connection connection, String sql, Object... params) throws SQLException</code>：用来执行一个更新 (插入、更新或删除) 操作。</li>
</ul>
</li>
<li><strong>插入</strong><ul>
<li><code>public &lt;T&gt; T insert(Connection connection, String sql, ResultSetHandler&lt;T&gt; rsh, Object... params) throws SQLException</code>：只支持 INSERT 语句，其中，rsh：The handler used to create the result object from the ResultSet of auto-generated keys。返回值：An object generated by the handler，即自动生成的键值。</li>
</ul>
</li>
<li><strong>批处理</strong><ul>
<li><code>public int[] batch(Connection connection, String sql, Object[][] params)throws SQLException</code>： INSERT，UPDATE，DELETE 语句。</li>
<li><code>public &lt;T&gt; T insertBatch(Connection connection, String sql, ResultSetHandler&lt;T&gt; rsh, Object[][] params)throws SQLException</code>：只支持 INSERT 语句。</li>
</ul>
</li>
<li><strong>查询</strong><ul>
<li><code>public Object query(Connection connection, String sql, ResultSetHandler rsh, Object... params) throws SQLException</code>：执行一个查询操作，在这个查询中，对象数组中的每个元素值被用来作为查询语句的置换参数。该方法会自行处理 PreparedStatement 和 ResultSet 的创建和关闭。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ResultSetHandler-接口及实现类"><a href="#ResultSetHandler-接口及实现类" class="headerlink" title="ResultSetHandler 接口及实现类"></a>ResultSetHandler 接口及实现类</h4><ul>
<li><p>该接口用于处理 <code>java.sql.ResultSet</code>，将数据按要求转换为另一种形式。</p>
</li>
<li><p>ResultSetHandler 接口提供了一个单独的方法：<code>Object handle (java.sql.ResultSet rs)</code>。</p>
</li>
<li><p>接口的主要实现类：</p>
<ul>
<li><p>ArrayHandler：把结果集中的第一行数据转成对象数组。</p>
</li>
<li><p>ArrayListHandler：把结果集中的每一行数据都转成一个数组，再存放到 List 中。</p>
</li>
<li><p><strong>BeanHandler：</strong>将结果集中的第一行数据封装到一个对应的 JavaBean 实例中。</p>
</li>
<li><p><strong>BeanListHandler：</strong>将结果集中的每一行数据都封装到一个对应的 JavaBean 实例中，再存放到 List 中。</p>
</li>
<li><p>ColumnListHandler：将结果集中某一列的数据存放到 List 中。</p>
</li>
<li><p>KeyedHandler(name)：将结果集中的每一行数据都封装到一个 Map 里，再把这些 Map 再存到一个 Map 里，其 key 为指定的 key。</p>
</li>
<li><p><strong>MapHandler：</strong>将结果集中的第一行数据封装到一个 Map 里，key 是列名，value 是对应的值。</p>
</li>
<li><p><strong>MapListHandler：</strong>将结果集中的每一行数据都封装到一个 Map 里，再存放到 List 中。</p>
</li>
<li><p><strong>ScalarHandler：</strong>查询单个值对象。</p>
</li>
</ul>
</li>
</ul>
<h2 id="JDBC-总结"><a href="#JDBC-总结" class="headerlink" title="JDBC 总结"></a>JDBC 总结</h2><ul>
<li><p>pom.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xisun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xisun-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>chemicalStructure<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>JDBCUtils.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDBCUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 常规方式获取数据库的连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getCommonConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.读取配置文件中的4个基本信息</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line">        properties.load(is);</span><br><span class="line">        String driverClass = properties.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line">        String url = properties.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        String user = properties.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        String password = properties.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.加载驱动</span></span><br><span class="line">        Class.forName(driverClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.获取连接</span></span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(url, user, password);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 使用C3P0数据库连接池技术获取数据库连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 创建一个C3P0数据库连接池，数据库连接池只需提供一个即可</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ComboPooledDataSource CPDS = <span class="keyword">new</span> ComboPooledDataSource(<span class="string">&quot;hellc3p0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getC3P0Connection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CPDS.getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 使用DBCP数据库连接池技术获取数据库连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 创建一个DBCP数据库连接池，数据库连接池只需提供一个即可</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DataSource dbcpSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;dbcp.properties&quot;</span>);</span><br><span class="line">            properties.load(is);</span><br><span class="line">            dbcpSource = BasicDataSourceFactory.createDataSource(properties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getDbcpConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dbcpSource.getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 使用Druid数据库连接池技术获取数据库连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 创建一个Druid数据库连接池，数据库连接池只需提供一个即可</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DataSource druidSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;druid.properties&quot;</span>);</span><br><span class="line">            properties.load(is);</span><br><span class="line">            druidSource = DruidDataSourceFactory.createDataSource(properties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getDruidConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> druidSource.getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 连接回滚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rollBackConnection</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.rollback();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                throwables.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// DbUtils工具类提供的回滚操作</span></span><br><span class="line">        <span class="comment">/*DbUtils.rollback(connection);</span></span><br><span class="line"><span class="comment">        DbUtils.rollbackAndClose(connection);</span></span><br><span class="line"><span class="comment">        DbUtils.rollbackAndCloseQuietly(connection);*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 常规方式，实现资源的关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Connection connection, Statement statement, ResultSet resultSet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resultSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                resultSet.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">                throwables.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (statement != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                statement.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 使用DbUtils工具类，实现资源的关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResourceByDbUtils</span><span class="params">(Connection connection, Statement statement, ResultSet resultSet)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 方式一</span></span><br><span class="line">        <span class="comment">/*try &#123;</span></span><br><span class="line"><span class="comment">            DbUtils.close(resultSet);</span></span><br><span class="line"><span class="comment">        &#125; catch (SQLException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            DbUtils.close(statement);</span></span><br><span class="line"><span class="comment">        &#125; catch (SQLException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            DbUtils.close(connection);</span></span><br><span class="line"><span class="comment">        &#125; catch (SQLException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式二</span></span><br><span class="line">        DbUtils.closeQuietly(resultSet);</span><br><span class="line">        DbUtils.closeQuietly(statement);</span><br><span class="line">        DbUtils.closeQuietly(connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>resources：</p>
<ul>
<li><p>jdbc.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClass</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql://localhost:3306/test</span></span><br><span class="line"><span class="attr">user</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>c3p0-config.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c3p0-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">named-config</span> <span class="attr">name</span>=<span class="string">&quot;helloc3p0&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 获取连接的4个基本信息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果连接本地3306端口，可以简写为：jdbc:mysql:///test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/test<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>abc123<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 涉及到数据库连接池的管理的常用相关属性的设置 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 若数据库中连接数不足时，一次向数据库服务器申请多少个连接 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;acquireIncrement&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 初始化数据库连接池时连接的数量 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialPoolSize&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库连接池中的最小的数据库连接数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minPoolSize&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库连接池中的最大的数据库连接数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- C3P0数据库连接池可以维护的Statement的个数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxStatements&quot;</span>&gt;</span>20<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 每个连接同时可以使用的Statement对象的个数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxStatementsPerConnection&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">named-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c3p0-config</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>dbcp.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql:///test?rewriteBatchedStatements=true&amp;useServerPrepStmts=false</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br><span class="line"><span class="attr">initialSize</span>=<span class="string">10</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>druid.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">url</span>=<span class="string">jdbc:mysql:///test?rewriteBatchedStatements=true</span></span><br><span class="line"><span class="attr">username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">password</span>=<span class="string">abc123</span></span><br><span class="line"><span class="attr">initialSize</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">maxActive</span>=<span class="string">20</span></span><br><span class="line"><span class="attr">maxWait</span>=<span class="string">1000</span></span><br><span class="line"><span class="attr">filters</span>=<span class="string">wall</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>?rewriteBatchedStatements=true</code>：开启 MySQL 批处理的支持。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>QueryRunnerTest.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryRunnerTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;insert into customers(name, email, birth) values(?, ?, ?)&quot;</span>;</span><br><span class="line">            <span class="keyword">int</span> insertCount = runner.update(connection, sql, <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;cc@126.com&quot;</span>, <span class="string">&quot;1997-09-08&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;添加了&quot;</span> + insertCount + <span class="string">&quot;条记录&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;delete from customers where id &lt; ?&quot;</span>;</span><br><span class="line">            <span class="keyword">int</span> deleteCount = runner.update(connection, sql, <span class="number">26</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;删除了&quot;</span> + deleteCount + <span class="string">&quot;条记录&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试更新</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;update customers set name = ?, email = ?, birth = ?, photo = ? where id = ?&quot;</span>;</span><br><span class="line">            SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">            java.util.Date date = sdf.parse(<span class="string">&quot;1997-05-21&quot;</span>);</span><br><span class="line">            <span class="comment">// 处理BLOB类型字段数据</span></span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;E:/test.png&quot;</span>));</span><br><span class="line">            <span class="keyword">int</span> updateCount = runner.update(connection, sql, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;zs@163.com&quot;</span>, <span class="keyword">new</span> Date(date.getTime()), fis, <span class="number">26</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;更新了&quot;</span> + updateCount + <span class="string">&quot;条记录&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException | ParseException | FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                    exception.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试查询</span></span><br><span class="line"><span class="comment">     * BeanHander：ResultSetHandler接口的实现类，用于封装表中的一条记录。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">            BeanHandler&lt;Customer&gt; handler = <span class="keyword">new</span> BeanHandler&lt;&gt;(Customer.class);</span><br><span class="line">            Customer customer = runner.query(connection, sql, handler, <span class="number">26</span>);</span><br><span class="line">            System.out.println(customer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试查询</span></span><br><span class="line"><span class="comment">     * BeanListHandler：ResultSetHandler接口的实现类，用于封装表中的多条记录构成的集合。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForBeanList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth from customers where id &lt; ?&quot;</span>;</span><br><span class="line">            BeanListHandler&lt;Customer&gt; handler = <span class="keyword">new</span> BeanListHandler&lt;&gt;(Customer.class);</span><br><span class="line">            List&lt;Customer&gt; list = runner.query(connection, sql, handler, <span class="number">28</span>);</span><br><span class="line">            list.forEach(System.out::println);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试查询</span></span><br><span class="line"><span class="comment">     * MapHander：ResultSetHandler接口的实现类，对应表中的一条记录。</span></span><br><span class="line"><span class="comment">     * 将字段及相应字段的值作为Map中的key和value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth from customers where id = ?&quot;</span>;</span><br><span class="line">            MapHandler handler = <span class="keyword">new</span> MapHandler();</span><br><span class="line">            Map&lt;String, Object&gt; map = runner.query(connection, sql, handler, <span class="number">26</span>);</span><br><span class="line">            System.out.println(map);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试查询</span></span><br><span class="line"><span class="comment">     * MapListHander：ResultSetHandler接口的实现类，对应表中的多条记录。</span></span><br><span class="line"><span class="comment">     * 将字段及相应字段的值作为Map中的key和value，再将每一个Map添加到List中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForMapList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth from customers where id &lt; ?&quot;</span>;</span><br><span class="line">            MapListHandler handler = <span class="keyword">new</span> MapListHandler();</span><br><span class="line">            List&lt;Map&lt;String, Object&gt;&gt; list = runner.query(connection, sql, handler, <span class="number">28</span>);</span><br><span class="line">            list.forEach(System.out::println);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试查询</span></span><br><span class="line"><span class="comment">     * ScalarHandler：用于查询特殊值。</span></span><br><span class="line"><span class="comment">     * 类似于最大的，最小的，平均的，总和，个数相关的数据。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForSpecialValue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select count(*) from customers&quot;</span>;</span><br><span class="line">            ScalarHandler&lt;Long&gt; handler = <span class="keyword">new</span> ScalarHandler&lt;&gt;();</span><br><span class="line">            Long count = runner.query(connection, sql, handler);</span><br><span class="line">            System.out.println(count);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryForSpecialValue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select max(birth) from customers&quot;</span>;</span><br><span class="line">            ScalarHandler&lt;Date&gt; handler = <span class="keyword">new</span> ScalarHandler&lt;&gt;();</span><br><span class="line">            Date maxBirth = runner.query(connection, sql, handler);</span><br><span class="line">            System.out.println(maxBirth);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义ResultSetHandler的实现类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryPersonal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql = <span class="string">&quot;select id, name, email, birth, photo from customers where id = ?&quot;</span>;</span><br><span class="line">            <span class="comment">// 匿名内部类</span></span><br><span class="line">            ResultSetHandler&lt;Customer&gt; handler = <span class="keyword">new</span> ResultSetHandler&lt;Customer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Customer <span class="title">handle</span><span class="params">(ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">                        <span class="keyword">int</span> id = resultSet.getInt(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                        String name = resultSet.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                        String email = resultSet.getString(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">                        Date birth = resultSet.getDate(<span class="string">&quot;birth&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 处理BLOB类型字段</span></span><br><span class="line">                        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">                        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Blob photo = resultSet.getBlob(<span class="string">&quot;photo&quot;</span>);</span><br><span class="line">                            is = photo.getBinaryStream();</span><br><span class="line">                            fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;test2.jpg&quot;</span>);</span><br><span class="line">                            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                            <span class="keyword">int</span> len;</span><br><span class="line">                            <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                                fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                            exception.printStackTrace();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    fos.close();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                                    exception.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    is.close();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                                    exception.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Customer(id, name, email, birth);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Customer customer = runner.query(connection, sql, handler, <span class="number">26</span>);</span><br><span class="line">            System.out.println(customer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 测试事务操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = JDBCUtils.getDruidConnection();</span><br><span class="line">            <span class="comment">// 1.取消数据的自动提交</span></span><br><span class="line">            connection.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">            QueryRunner runner = <span class="keyword">new</span> QueryRunner();</span><br><span class="line">            String sql1 = <span class="string">&quot;update user_table set balance = balance - 100 where user = ?&quot;</span>;</span><br><span class="line">            runner.update(connection, sql1, <span class="string">&quot;AA&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 模拟网络异常</span></span><br><span class="line">            System.out.println(<span class="number">10</span> / <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            String sql2 = <span class="string">&quot;update user_table set balance = balance + 100 where user = ?&quot;</span>;</span><br><span class="line">            runner.update(connection, sql2, <span class="string">&quot;BB&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;转账成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.提交数据</span></span><br><span class="line">            connection.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 3.回滚数据</span></span><br><span class="line">            JDBCUtils.rollBackConnection(connection);</span><br><span class="line">            System.out.println(<span class="string">&quot;转账失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            JDBCUtils.closeResourceByDbUtils(connection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1eJ411c7rf">https://www.bilibili.com/video/BV1eJ411c7rf</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/12/spring-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/12/spring-boot/" class="post-title-link" itemprop="url">Spring Boot 入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-12 15:31:58" itemprop="dateCreated datePublished" datetime="2021-06-12T15:31:58+08:00">2021-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-24 17:34:01" itemprop="dateModified" datetime="2021-08-24T17:34:01+08:00">2021-08-24</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>105k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:36</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Spring-Boot-简介"><a href="#Spring-Boot-简介" class="headerlink" title="Spring Boot 简介"></a>Spring Boot 简介</h2><ul>
<li><p>官网：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">https://spring.io/projects/spring-boot</a></p>
</li>
<li><p>文档：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot#learn">https://spring.io/projects/spring-boot#learn</a></p>
<img src="/2021/06/12/spring-boot/image-20210618171017632.png" alt="image-20210618171017632" style="zoom:80%;">

<p><img src="/2021/06/12/spring-boot/image-20210618172108696.png" alt="image-20210618172108696"></p>
</li>
<li><p>查看各版本的新特性：<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-boot/wiki#release-notes">https://github.com/spring-projects/spring-boot/wiki#release-notes</a></p>
<img src="/2021/06/12/spring-boot/image-20210618172926609.png" alt="image-20210618172926609" style="zoom:80%;">

<img src="/2021/06/12/spring-boot/image-20210618173003220.png" alt="image-20210618173003220" style="zoom:80%;">

</li>
</ul>
<h2 id="Spring-Boot-的作用"><a href="#Spring-Boot-的作用" class="headerlink" title="Spring Boot 的作用"></a>Spring Boot 的作用</h2><ul>
<li>Spring Boot makes it easy to create stand-alone, production-grade Spring based Applications that you can “just run”.<ul>
<li>Spring Boot 能快速创建出生产级别的 Spring 应用。</li>
</ul>
</li>
</ul>
<h2 id="Spring-Boot-的优点"><a href="#Spring-Boot-的优点" class="headerlink" title="Spring Boot 的优点"></a>Spring Boot 的优点</h2><ul>
<li><p>Create stand-alone Spring applications</p>
<ul>
<li>创建独立的 Spring 应用。</li>
</ul>
</li>
<li><p>Embed Tomcat, Jetty or Undertow directly (no need to deploy WAR files)</p>
<ul>
<li>内嵌 web 服务器。</li>
</ul>
</li>
<li><p>Provide opinionated ‘starter’ dependencies to simplify your build configuration</p>
<ul>
<li>自动 starter 依赖，简化构建配置。</li>
</ul>
</li>
<li><p>Automatically configure Spring and 3rd party libraries whenever possible</p>
<ul>
<li>自动配置 Spring 以及第三方功能。</li>
</ul>
</li>
<li><p>Provide production-ready features such as metrics, health checks, and externalized configuration</p>
<ul>
<li>提供生产级别的监控、健康检查及外部化配置。</li>
</ul>
</li>
<li><p>Absolutely no code generation and no requirement for XML configuration</p>
<ul>
<li>无代码生成、无需编写 XML。</li>
</ul>
</li>
</ul>
<h2 id="Spring-Boot-的缺点"><a href="#Spring-Boot-的缺点" class="headerlink" title="Spring Boot 的缺点"></a>Spring Boot 的缺点</h2><ul>
<li>人称版本帝，迭代快，需要时刻关注变化。</li>
<li>封装太深，内部原理复杂，不容易精通。</li>
</ul>
<h2 id="Spring-Boot-2-入门"><a href="#Spring-Boot-2-入门" class="headerlink" title="Spring Boot 2 入门"></a>Spring Boot 2 入门</h2><h3 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h3><ul>
<li><p>Java 8 +：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\XiSun&gt; java <span class="literal">-version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_222&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (AdoptOpenJDK)(build <span class="number">1.8</span>.<span class="number">0</span>_222<span class="literal">-b10</span>)</span><br><span class="line">OpenJDK <span class="number">64</span><span class="literal">-Bit</span> Server VM (AdoptOpenJDK)(build <span class="number">25.222</span><span class="literal">-b10</span>, mixed mode)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Maven 3.5 +：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\XiSun&gt; mvn <span class="literal">-v</span></span><br><span class="line">Apache Maven <span class="number">3.6</span>.<span class="number">3</span> (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">Maven home: D:\Program Files\Maven\apache<span class="literal">-maven</span><span class="literal">-3</span>.<span class="number">6.3</span>\bin\..</span><br><span class="line">Java version: <span class="number">1.8</span>.<span class="number">0</span>_222, vendor: AdoptOpenJDK, runtime: D:\Program Files\AdoptOpenJDK\jdk<span class="literal">-8</span>.<span class="number">0.222</span>.<span class="number">10</span><span class="literal">-hotspot</span>\jre</span><br><span class="line">Default locale: zh_CN, platform encoding: GBK</span><br><span class="line">OS name: <span class="string">&quot;windows 10&quot;</span>, version: <span class="string">&quot;10.0&quot;</span>, arch: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;windows&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>Maven setting.xml 的设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>说明：添加上面的配置后，项目中每次 Maven 更新依赖时，不会改变 Compiler 的版本。如果针对单个项目配置，则在该项目的 pom.xml 文件中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">app.main.class</span>&gt;</span>cn.matgene.reaction.extractor.FlinkKafkaJob<span class="tag">&lt;/<span class="name">app.main.class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">maven.compiler.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven.compiler.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h3><ul>
<li><p>需求：浏览器发送 <code>/hello</code>请求，服务器响应 <code>Hello, Spring Boot 2!</code>。</p>
</li>
<li><p>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.first-application">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.first-application</a></p>
</li>
<li><p>创建 Maven 工程，并添加 parent 依赖：</p>
<p><img src="/2021/06/12/spring-boot/image-20210620142811195.png" alt="image-20210620142811195"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xisun<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-helloworld<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>parent 节点为手动添加。</p>
</blockquote>
</li>
<li><p>引入 web 相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建主程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/20 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 主程序类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>业务层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/20 15:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, Spring Boot 2!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 MainApplication.class 的 main 方法，启动程序，在浏览器输入地址 <code>http://localhost:8080/hello</code>，查看结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | &#x27;</span>_ | <span class="string">&#x27;_| | &#x27;</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::                (v2.5.1)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2021-06-20 15:37:47.623  INFO 14268 --- [           main] cn.xisun.web.MainApplication             : Starting MainApplication using Java 1.8.0_222 on DESKTOP-OJKMETJ with PID 14268 (D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot\target\classes started by XiSun in D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot)</span></span><br><span class="line"><span class="string">2021-06-20 15:37:47.627  INFO 14268 --- [           main] cn.xisun.web.MainApplication             : No active profile set, falling back to default profiles: default</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.380  INFO 14268 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.386  INFO 14268 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.386  INFO 14268 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.46]</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.438  INFO 14268 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.439  INFO 14268 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 760 ms</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.674  INFO 14268 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">2021-06-20 15:37:48.681  INFO 14268 --- [           main] cn.xisun.web.MainApplication             : Started MainApplication in 1.374 seconds (JVM running for 2.301)</span></span><br><span class="line"><span class="string">2021-06-20 15:37:59.504  INFO 14268 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet &#x27;</span>dispatcherServlet<span class="string">&#x27;</span></span><br><span class="line"><span class="string">2021-06-20 15:37:59.504  INFO 14268 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#x27;</span>dispatcherServlet<span class="string">&#x27;</span></span><br><span class="line"><span class="string">2021-06-20 15:37:59.504  INFO 14268 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 0 ms</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210620154854477.png" alt="image-20210620154854477"></p>
</li>
<li><p>简化配置：</p>
<ul>
<li><p>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties</a></p>
</li>
<li><p>在 resources 目录下新建 application.properties 文件，项目中的一些配置可在此文件中进行修改。</p>
</li>
<li><p>如，修改 tomcat 端口：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8888</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>简化部署：</p>
<ul>
<li><p><strong>添加 <code>spring-boot-maven-plugin</code>：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot&gt;mvn clean <span class="keyword">package</span> -DskipTests</span><br><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] -------------------&lt; cn.xisun:springboot-helloworld &gt;-------------------</span><br><span class="line">[INFO] Building springboot-helloworld <span class="number">1.0</span>-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-clean-plugin:<span class="number">3.1</span>.<span class="number">0</span>:clean (<span class="keyword">default</span>-clean) @ springboot-helloworld ---</span><br><span class="line">[INFO] Deleting D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot\target</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-resources-plugin:<span class="number">3.2</span>.<span class="number">0</span>:resources (<span class="keyword">default</span>-resources) @ springboot-helloworld ---</span><br><span class="line">[INFO] Using <span class="string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.</span><br><span class="line">[INFO] Using <span class="string">&#x27;UTF-8&#x27;</span> encoding to copy filtered properties files.</span><br><span class="line">[INFO] Copying <span class="number">1</span> resource</span><br><span class="line">[INFO] Copying <span class="number">0</span> resource</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-compiler-plugin:<span class="number">3.8</span>.<span class="number">1</span>:compile (<span class="keyword">default</span>-compile) @ springboot-helloworld ---</span><br><span class="line">[INFO] Changes detected - recompiling the <span class="keyword">module</span>!</span><br><span class="line">[INFO] Compiling <span class="number">2</span> source files to D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot\target\classes</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-resources-plugin:<span class="number">3.2</span>.<span class="number">0</span>:testResources (<span class="keyword">default</span>-testResources) @ springboot-helloworld ---</span><br><span class="line">[INFO] Using <span class="string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.</span><br><span class="line">[INFO] Using <span class="string">&#x27;UTF-8&#x27;</span> encoding to copy filtered properties files.</span><br><span class="line">[INFO] skip non existing resourceDirectory D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot\src\test\resources</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-compiler-plugin:<span class="number">3.8</span>.<span class="number">1</span>:testCompile (<span class="keyword">default</span>-testCompile) @ springboot-helloworld ---</span><br><span class="line">[INFO] Changes detected - recompiling the <span class="keyword">module</span>!</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-surefire-plugin:<span class="number">2.22</span>.<span class="number">2</span>:test (<span class="keyword">default</span>-test) @ springboot-helloworld ---</span><br><span class="line">[INFO] Tests are skipped.</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-jar-plugin:<span class="number">3.2</span>.<span class="number">0</span>:jar (<span class="keyword">default</span>-jar) @ springboot-helloworld ---</span><br><span class="line">[INFO] Building jar: D:\JetBrainsWorkSpace\IDEAProjects\xisun-springboot\target\springboot-helloworld-<span class="number">1.0</span>-SNAPSHOT.jar</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- spring-boot-maven-plugin:<span class="number">2.5</span>.<span class="number">1</span>:repackage (repackage) @ springboot-helloworld ---</span><br><span class="line">[INFO] Replacing main artifact with repackaged archive</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  <span class="number">1.890</span> s</span><br><span class="line">[INFO] Finished at: <span class="number">2021</span>-<span class="number">06</span>-<span class="number">20</span>T16:<span class="number">47</span>:<span class="number">43</span>+<span class="number">08</span>:<span class="number">00</span></span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="Spring-Boot-的特点"><a href="#Spring-Boot-的特点" class="headerlink" title="Spring Boot 的特点"></a>Spring Boot 的特点</h2><h3 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h3><ul>
<li><p>Spring Boot 项目，都会添加一个 parent 依赖 <code>spring-boot-starter-parent</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>父项目一般都是做依赖管理的，后续在项目中添加的依赖，其版本号和父项目 version 一致，不需要再单独指定。</p>
</li>
<li><p><code>spring-boot-starter-parent</code> 有自己的父项目 <code>spring-boot-dependencies</code>，在该项目中几乎声明了所有开发中常用的依赖的版本号，这个版本号一般适应当前项目对应的版本。这是<strong>自动版本仲裁机制</strong>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activemq.version</span>&gt;</span>5.16.2<span class="tag">&lt;/<span class="name">activemq.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">antlr2.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">antlr2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appengine-sdk.version</span>&gt;</span>1.9.89<span class="tag">&lt;/<span class="name">appengine-sdk.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artemis.version</span>&gt;</span>2.17.0<span class="tag">&lt;/<span class="name">artemis.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">assertj.version</span>&gt;</span>3.19.0<span class="tag">&lt;/<span class="name">assertj.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">atomikos.version</span>&gt;</span>4.0.6<span class="tag">&lt;/<span class="name">atomikos.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">awaitility.version</span>&gt;</span>4.0.3<span class="tag">&lt;/<span class="name">awaitility.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build-helper-maven-plugin.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">build-helper-maven-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">byte-buddy.version</span>&gt;</span>1.10.22<span class="tag">&lt;/<span class="name">byte-buddy.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">caffeine.version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">caffeine.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cassandra-driver.version</span>&gt;</span>4.11.1<span class="tag">&lt;/<span class="name">cassandra-driver.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">classmate.version</span>&gt;</span>1.5.1<span class="tag">&lt;/<span class="name">classmate.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">commons-codec.version</span>&gt;</span>1.15<span class="tag">&lt;/<span class="name">commons-codec.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">commons-dbcp2.version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">commons-dbcp2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">commons-lang3.version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">commons-lang3.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">commons-pool.version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">commons-pool.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">commons-pool2.version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">commons-pool2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">couchbase-client.version</span>&gt;</span>3.1.6<span class="tag">&lt;/<span class="name">couchbase-client.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">db2-jdbc.version</span>&gt;</span>11.5.5.0<span class="tag">&lt;/<span class="name">db2-jdbc.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency-management-plugin.version</span>&gt;</span>1.0.11.RELEASE<span class="tag">&lt;/<span class="name">dependency-management-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">derby.version</span>&gt;</span>10.14.2.0<span class="tag">&lt;/<span class="name">derby.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dropwizard-metrics.version</span>&gt;</span>4.1.22<span class="tag">&lt;/<span class="name">dropwizard-metrics.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ehcache.version</span>&gt;</span>2.10.9.2<span class="tag">&lt;/<span class="name">ehcache.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ehcache3.version</span>&gt;</span>3.9.4<span class="tag">&lt;/<span class="name">ehcache3.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">embedded-mongo.version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">embedded-mongo.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">flyway.version</span>&gt;</span>7.7.3<span class="tag">&lt;/<span class="name">flyway.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">freemarker.version</span>&gt;</span>2.3.31<span class="tag">&lt;/<span class="name">freemarker.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">git-commit-id-plugin.version</span>&gt;</span>4.0.5<span class="tag">&lt;/<span class="name">git-commit-id-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">glassfish-el.version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">glassfish-el.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">glassfish-jaxb.version</span>&gt;</span>2.3.4<span class="tag">&lt;/<span class="name">glassfish-jaxb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groovy.version</span>&gt;</span>3.0.8<span class="tag">&lt;/<span class="name">groovy.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">gson.version</span>&gt;</span>2.8.7<span class="tag">&lt;/<span class="name">gson.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2.version</span>&gt;</span>1.4.200<span class="tag">&lt;/<span class="name">h2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hamcrest.version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">hamcrest.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hazelcast.version</span>&gt;</span>4.1.3<span class="tag">&lt;/<span class="name">hazelcast.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hazelcast-hibernate5.version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">hazelcast-hibernate5.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hibernate.version</span>&gt;</span>5.4.32.Final<span class="tag">&lt;/<span class="name">hibernate.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hibernate-validator.version</span>&gt;</span>6.2.0.Final<span class="tag">&lt;/<span class="name">hibernate-validator.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hikaricp.version</span>&gt;</span>4.0.3<span class="tag">&lt;/<span class="name">hikaricp.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hsqldb.version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">hsqldb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">htmlunit.version</span>&gt;</span>2.49.1<span class="tag">&lt;/<span class="name">htmlunit.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpasyncclient.version</span>&gt;</span>4.1.4<span class="tag">&lt;/<span class="name">httpasyncclient.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpclient.version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">httpclient.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpclient5.version</span>&gt;</span>5.0.4<span class="tag">&lt;/<span class="name">httpclient5.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpcore.version</span>&gt;</span>4.4.14<span class="tag">&lt;/<span class="name">httpcore.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpcore5.version</span>&gt;</span>5.1.1<span class="tag">&lt;/<span class="name">httpcore5.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">infinispan.version</span>&gt;</span>12.1.4.Final<span class="tag">&lt;/<span class="name">infinispan.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">influxdb-java.version</span>&gt;</span>2.21<span class="tag">&lt;/<span class="name">influxdb-java.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jackson-bom.version</span>&gt;</span>2.12.3<span class="tag">&lt;/<span class="name">jackson-bom.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-activation.version</span>&gt;</span>1.2.2<span class="tag">&lt;/<span class="name">jakarta-activation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-annotation.version</span>&gt;</span>1.3.5<span class="tag">&lt;/<span class="name">jakarta-annotation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-jms.version</span>&gt;</span>2.0.3<span class="tag">&lt;/<span class="name">jakarta-jms.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-json.version</span>&gt;</span>1.1.6<span class="tag">&lt;/<span class="name">jakarta-json.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-json-bind.version</span>&gt;</span>1.0.2<span class="tag">&lt;/<span class="name">jakarta-json-bind.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-mail.version</span>&gt;</span>1.6.7<span class="tag">&lt;/<span class="name">jakarta-mail.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-persistence.version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">jakarta-persistence.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-servlet.version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">jakarta-servlet.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-servlet-jsp-jstl.version</span>&gt;</span>1.2.7<span class="tag">&lt;/<span class="name">jakarta-servlet-jsp-jstl.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-transaction.version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">jakarta-transaction.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-validation.version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">jakarta-validation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-websocket.version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">jakarta-websocket.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-ws-rs.version</span>&gt;</span>2.1.6<span class="tag">&lt;/<span class="name">jakarta-ws-rs.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-xml-bind.version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">jakarta-xml-bind.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-xml-soap.version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">jakarta-xml-soap.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jakarta-xml-ws.version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">jakarta-xml-ws.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">janino.version</span>&gt;</span>3.1.4<span class="tag">&lt;/<span class="name">janino.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-activation.version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">javax-activation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-annotation.version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">javax-annotation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-cache.version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">javax-cache.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-jaxb.version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">javax-jaxb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-jaxws.version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">javax-jaxws.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-jms.version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">javax-jms.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-json.version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">javax-json.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-jsonb.version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">javax-jsonb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-mail.version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">javax-mail.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-money.version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">javax-money.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-persistence.version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">javax-persistence.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-transaction.version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">javax-transaction.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-validation.version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">javax-validation.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax-websocket.version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">javax-websocket.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jaxen.version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">jaxen.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jaybird.version</span>&gt;</span>4.0.3.java8<span class="tag">&lt;/<span class="name">jaybird.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jboss-logging.version</span>&gt;</span>3.4.2.Final<span class="tag">&lt;/<span class="name">jboss-logging.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jboss-transaction-spi.version</span>&gt;</span>7.6.1.Final<span class="tag">&lt;/<span class="name">jboss-transaction-spi.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jdom2.version</span>&gt;</span>2.0.6<span class="tag">&lt;/<span class="name">jdom2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jedis.version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">jedis.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jersey.version</span>&gt;</span>2.33<span class="tag">&lt;/<span class="name">jersey.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jetty-el.version</span>&gt;</span>9.0.29<span class="tag">&lt;/<span class="name">jetty-el.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jetty-jsp.version</span>&gt;</span>2.2.0.v201112011158<span class="tag">&lt;/<span class="name">jetty-jsp.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jetty-reactive-httpclient.version</span>&gt;</span>1.1.9<span class="tag">&lt;/<span class="name">jetty-reactive-httpclient.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jetty.version</span>&gt;</span>9.4.42.v20210604<span class="tag">&lt;/<span class="name">jetty.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jmustache.version</span>&gt;</span>1.15<span class="tag">&lt;/<span class="name">jmustache.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">johnzon.version</span>&gt;</span>1.2.13<span class="tag">&lt;/<span class="name">johnzon.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jolokia.version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">jolokia.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jooq.version</span>&gt;</span>3.14.11<span class="tag">&lt;/<span class="name">jooq.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">json-path.version</span>&gt;</span>2.5.0<span class="tag">&lt;/<span class="name">json-path.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">json-smart.version</span>&gt;</span>2.4.7<span class="tag">&lt;/<span class="name">json-smart.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jsonassert.version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">jsonassert.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jstl.version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">jstl.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">jtds.version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">jtds.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">junit-jupiter.version</span>&gt;</span>5.7.2<span class="tag">&lt;/<span class="name">junit-jupiter.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kafka.version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">kafka.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kotlin.version</span>&gt;</span>1.5.10<span class="tag">&lt;/<span class="name">kotlin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kotlin-coroutines.version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">kotlin-coroutines.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">lettuce.version</span>&gt;</span>6.1.2.RELEASE<span class="tag">&lt;/<span class="name">lettuce.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">liquibase.version</span>&gt;</span>4.3.5<span class="tag">&lt;/<span class="name">liquibase.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4j2.version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">log4j2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logback.version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">logback.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.20<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mariadb.version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">mariadb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-antrun-plugin.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven-antrun-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-assembly-plugin.version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">maven-assembly-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-clean-plugin.version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">maven-clean-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-compiler-plugin.version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">maven-compiler-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-dependency-plugin.version</span>&gt;</span>3.1.2<span class="tag">&lt;/<span class="name">maven-dependency-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-deploy-plugin.version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">maven-deploy-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-enforcer-plugin.version</span>&gt;</span>3.0.0-M3<span class="tag">&lt;/<span class="name">maven-enforcer-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-failsafe-plugin.version</span>&gt;</span>2.22.2<span class="tag">&lt;/<span class="name">maven-failsafe-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-help-plugin.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">maven-help-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-install-plugin.version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">maven-install-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-invoker-plugin.version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">maven-invoker-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-jar-plugin.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">maven-jar-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-javadoc-plugin.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">maven-javadoc-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-resources-plugin.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">maven-resources-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-shade-plugin.version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">maven-shade-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-source-plugin.version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">maven-source-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-surefire-plugin.version</span>&gt;</span>2.22.2<span class="tag">&lt;/<span class="name">maven-surefire-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven-war-plugin.version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">maven-war-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">micrometer.version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">micrometer.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mimepull.version</span>&gt;</span>1.9.14<span class="tag">&lt;/<span class="name">mimepull.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mockito.version</span>&gt;</span>3.9.0<span class="tag">&lt;/<span class="name">mockito.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mongodb.version</span>&gt;</span>4.2.3<span class="tag">&lt;/<span class="name">mongodb.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mssql-jdbc.version</span>&gt;</span>9.2.1.jre8<span class="tag">&lt;/<span class="name">mssql-jdbc.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.25<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nekohtml.version</span>&gt;</span>1.9.22<span class="tag">&lt;/<span class="name">nekohtml.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">neo4j-java-driver.version</span>&gt;</span>4.2.6<span class="tag">&lt;/<span class="name">neo4j-java-driver.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">netty.version</span>&gt;</span>4.1.65.Final<span class="tag">&lt;/<span class="name">netty.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">netty-tcnative.version</span>&gt;</span>2.0.39.Final<span class="tag">&lt;/<span class="name">netty-tcnative.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">oauth2-oidc-sdk.version</span>&gt;</span>9.3.3<span class="tag">&lt;/<span class="name">oauth2-oidc-sdk.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nimbus-jose-jwt.version</span>&gt;</span>9.8.1<span class="tag">&lt;/<span class="name">nimbus-jose-jwt.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ojdbc.version</span>&gt;</span>19.3.0.0<span class="tag">&lt;/<span class="name">ojdbc.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">okhttp3.version</span>&gt;</span>3.14.9<span class="tag">&lt;/<span class="name">okhttp3.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">oracle-database.version</span>&gt;</span>21.1.0.0<span class="tag">&lt;/<span class="name">oracle-database.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pooled-jms.version</span>&gt;</span>1.2.2<span class="tag">&lt;/<span class="name">pooled-jms.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">postgresql.version</span>&gt;</span>42.2.20<span class="tag">&lt;/<span class="name">postgresql.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">prometheus-pushgateway.version</span>&gt;</span>0.10.0<span class="tag">&lt;/<span class="name">prometheus-pushgateway.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">quartz.version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">quartz.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">querydsl.version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">querydsl.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">r2dbc-bom.version</span>&gt;</span>Arabba-SR10<span class="tag">&lt;/<span class="name">r2dbc-bom.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rabbit-amqp-client.version</span>&gt;</span>5.12.0<span class="tag">&lt;/<span class="name">rabbit-amqp-client.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">reactive-streams.version</span>&gt;</span>1.0.3<span class="tag">&lt;/<span class="name">reactive-streams.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">reactor-bom.version</span>&gt;</span>2020.0.7<span class="tag">&lt;/<span class="name">reactor-bom.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rest-assured.version</span>&gt;</span>4.3.3<span class="tag">&lt;/<span class="name">rest-assured.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rsocket.version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">rsocket.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rxjava.version</span>&gt;</span>1.3.8<span class="tag">&lt;/<span class="name">rxjava.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rxjava-adapter.version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">rxjava-adapter.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rxjava2.version</span>&gt;</span>2.2.21<span class="tag">&lt;/<span class="name">rxjava2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">saaj-impl.version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">saaj-impl.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">selenium.version</span>&gt;</span>3.141.59<span class="tag">&lt;/<span class="name">selenium.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">selenium-htmlunit.version</span>&gt;</span>2.49.1<span class="tag">&lt;/<span class="name">selenium-htmlunit.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sendgrid.version</span>&gt;</span>4.7.2<span class="tag">&lt;/<span class="name">sendgrid.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-api.version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">servlet-api.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">snakeyaml.version</span>&gt;</span>1.28<span class="tag">&lt;/<span class="name">snakeyaml.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">solr.version</span>&gt;</span>8.8.2<span class="tag">&lt;/<span class="name">solr.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-amqp.version</span>&gt;</span>2.3.8<span class="tag">&lt;/<span class="name">spring-amqp.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-batch.version</span>&gt;</span>4.3.3<span class="tag">&lt;/<span class="name">spring-batch.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-data-bom.version</span>&gt;</span>2021.0.1<span class="tag">&lt;/<span class="name">spring-data-bom.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-framework.version</span>&gt;</span>5.3.8<span class="tag">&lt;/<span class="name">spring-framework.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-hateoas.version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">spring-hateoas.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-integration.version</span>&gt;</span>5.5.0<span class="tag">&lt;/<span class="name">spring-integration.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-kafka.version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">spring-kafka.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-ldap.version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">spring-ldap.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-restdocs.version</span>&gt;</span>2.0.5.RELEASE<span class="tag">&lt;/<span class="name">spring-restdocs.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-retry.version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">spring-retry.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-security.version</span>&gt;</span>5.5.0<span class="tag">&lt;/<span class="name">spring-security.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-session-bom.version</span>&gt;</span>2021.0.0<span class="tag">&lt;/<span class="name">spring-session-bom.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring-ws.version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">spring-ws.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sqlite-jdbc.version</span>&gt;</span>3.34.0<span class="tag">&lt;/<span class="name">sqlite-jdbc.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sun-mail.version</span>&gt;</span>1.6.7<span class="tag">&lt;/<span class="name">sun-mail.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thymeleaf.version</span>&gt;</span>3.0.12.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thymeleaf-extras-data-attribute.version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">thymeleaf-extras-data-attribute.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thymeleaf-extras-java8time.version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf-extras-java8time.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thymeleaf-extras-springsecurity.version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf-extras-springsecurity.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tomcat.version</span>&gt;</span>9.0.46<span class="tag">&lt;/<span class="name">tomcat.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unboundid-ldapsdk.version</span>&gt;</span>4.0.14<span class="tag">&lt;/<span class="name">unboundid-ldapsdk.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">undertow.version</span>&gt;</span>2.2.8.Final<span class="tag">&lt;/<span class="name">undertow.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">versions-maven-plugin.version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">versions-maven-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">webjars-hal-browser.version</span>&gt;</span>3325375<span class="tag">&lt;/<span class="name">webjars-hal-browser.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">webjars-locator-core.version</span>&gt;</span>0.46<span class="tag">&lt;/<span class="name">webjars-locator-core.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">wsdl4j.version</span>&gt;</span>1.6.3<span class="tag">&lt;/<span class="name">wsdl4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">xml-maven-plugin.version</span>&gt;</span>1.0.2<span class="tag">&lt;/<span class="name">xml-maven-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">xmlunit2.version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">xmlunit2.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>spring-boot-dependencies</code>，可以查看适应当前版本的其他依赖的 version。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>场景启动器：</p>
<ul>
<li><p>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters">https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters</a></p>
</li>
<li><p>场景启动器表示的是实现某种功能时，所需要的一组常规的依赖，当引入这个启动器后，会自动添加这一组依赖。比如 <code>spring-boot-start-web</code>：</p>
<p><img src="/2021/06/12/spring-boot/springboot-helloworld.png" alt="springboot-helloworld"></p>
</li>
<li><p>Spring 官方的启动器命名规则为 <code>spring-boot-start-*</code>，* 代表的就是某种场景。</p>
</li>
<li><p>自定义的第三方启动器，命名规则一般为 <code>thirdpartyproject-spring-boot-starter</code>。</p>
</li>
<li><p>所有场景启动器最底层的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h3><ul>
<li><p>比如，引入 <code>spring-boot-start-web</code> 启动器时，会自动引入 Tomcat、SpringMVC 的相关依赖，并配置好。也会自动配好 Web 的常见功能，如：字符编码问题。</p>
</li>
<li><p>默认的包结构：</p>
<ul>
<li><p><strong>主程序所在包及其下面的所有子包</strong>里面的组件都会被默认扫描进来，无需自行设置包扫描。</p>
<p><img src="/2021/06/12/spring-boot/image-20210623132742700.png" alt="image-20210623132742700"></p>
</li>
<li><p>如果想要改变扫描路径，使用 **<code>@SpringBootApplication(scanBasePackages=&quot;cn.xisun&quot;)</code>**。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(scanBasePackages = &quot;cn.xisun&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@SpringBootApplication</code> 注解等同于 <code>@SpringBootConfiguration</code>，<code>@EnableAutoConfiguration</code> 和 <code>@ComponentScan</code>，复写此三个注解，然后使用 <code>@ComponentScan</code> 也可以重新指定扫码路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;cn.xisun&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>各种配置拥有默认值：</p>
<ul>
<li>默认配置最终都是映射到某个类上，如：MultipartProperties。</li>
<li>配置文件的值最终会绑定每个类上，这个类会在容器中会创建对象。</li>
<li>在 application.properties 文件内可以修改各种配置的默认值。</li>
</ul>
</li>
<li><p>按需加载所有自动配置项：</p>
<ul>
<li>引入了一个场景启动器后，这个场景的自动配置才会开启。</li>
<li>Spring Boot 所有的自动配置功能，都在 spring-boot-autoconfigure 包里面。</li>
</ul>
</li>
</ul>
<h2 id="Spring-Boot-的容器功能"><a href="#Spring-Boot-的容器功能" class="headerlink" title="Spring Boot 的容器功能"></a>Spring Boot 的容器功能</h2><h3 id="添加组件"><a href="#添加组件" class="headerlink" title="添加组件"></a>添加组件</h3><ul>
<li><p>新建 User 类和 Pet 类，用于测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.web.bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/23 16:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pet</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Pet&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.web.bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/23 15:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">getPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPet</span><span class="params">(Pet pet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pet = pet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, pet=&quot;</span> + pet +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>@Configuration</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/23 15:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 1.<span class="doctag">@Configuration</span>注解标识当前类是一个配置类，作用等同于Spring的配置文件</span></span><br><span class="line"><span class="comment"> * 2.<span class="doctag">@Configuration</span>注解标识的配置类本身也是一个组件</span></span><br><span class="line"><span class="comment"> * 3.配置类里可以使用<span class="doctag">@Bean</span>注解，标注在方法上给容器注册组件，组件是单实例的</span></span><br><span class="line"><span class="comment"> * 4.<span class="doctag">@Configuration</span>注解有一个proxyBeanMethods属性，表示是否代理配置类中Bean的方法，默认为true，即代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@Bean</span>注解给容器中注册组件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 以方法名作为组件的id，返回类型就是组件的类型，返回的值，就是组件在容器中的实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User zhangsan = <span class="keyword">new</span> User(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * user01组件依赖了tom组件：</span></span><br><span class="line"><span class="comment">         *      如果proxyBeanMethods = true，user01组件依赖的tom组件，就是容器中注册的那个</span></span><br><span class="line"><span class="comment">         *      如果proxyBeanMethods = false，user01组件依赖的tom组件，是新建的，与容器中注册的那个无关</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 可以重新指定组件的id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;lisi&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">&quot;lisi&quot;</span>, <span class="number">19</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">tomcatPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@Scope</span>(&quot;prototype&quot;)注解，指定注册的组件是多实例的，默认情况是单实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 每次从容器中获得的tom1组件，都不相同</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;tom1&quot;)</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">tomcatPet1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">&quot;tomcat2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/20 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 主程序类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.返回IOC容器</span></span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.查看容器内的所有组件</span></span><br><span class="line">        String[] beanDefinitionNames = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">            System.out.println(beanDefinitionName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从容器中获取配置类本身的组件</span></span><br><span class="line">        MyConfig myConfig = run.getBean(MyConfig.class);</span><br><span class="line">        System.out.println(myConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.从容器中获取配置类中注册的组件，每次获取的实例都相同</span></span><br><span class="line">        User user01 = run.getBean(<span class="string">&quot;user01&quot;</span>, User.class);</span><br><span class="line">        User user011 = run.getBean(<span class="string">&quot;user01&quot;</span>, User.class);</span><br><span class="line">        System.out.println(user01);</span><br><span class="line">        System.out.println(<span class="string">&quot;单例? &quot;</span> + (user01 == user011));</span><br><span class="line">        User lisi = run.getBean(<span class="string">&quot;lisi&quot;</span>, User.class);</span><br><span class="line">        System.out.println(lisi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 5.通过配置类的方法获取实例</span></span><br><span class="line"><span class="comment">         * @Configuration(proxyBeanMethods = true)：</span></span><br><span class="line"><span class="comment">         *      此时，配置类是一个MyConfig$$EnhancerBySpringCGLIB$$70400c34@1517f633对象(CGLIB代理对象)</span></span><br><span class="line"><span class="comment">         *      在执行方法前，SpringBoot总会检查要获取的组件是否在容器中已存在，若存在，直接返回该组件---保持容器中组件单实例</span></span><br><span class="line"><span class="comment">         *      Full模式：外部无论对配置类中的这个组件的注册方法调用多少次，获取的都是之前已经注册在容器中的单实例对象，即user和user1总是相等</span></span><br><span class="line"><span class="comment">         *		组件依赖必须使用Full模式</span></span><br><span class="line"><span class="comment">         * @Configuration(proxyBeanMethods = false)：</span></span><br><span class="line"><span class="comment">         *      此时，配置类是一个MyConfig@644abb8f对象(普通对象)</span></span><br><span class="line"><span class="comment">         *      在执行方法前，SpringBoot不会检查要获取的组件是否在容器中已存在</span></span><br><span class="line"><span class="comment">         *      Lite模式：外部对配置类中的这个组件的注册方法的每一次调用，都会获得一个新的实例，即user和user1总是不等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        User user = myConfig.user01();</span><br><span class="line">        User user1 = myConfig.user01();</span><br><span class="line">        System.out.println(user == user1);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据proxyBeanMethods的属性为true或false，可以看出user01的pet属性，与容器中的tom组件是否相同</span></span><br><span class="line">        Pet tom = run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;用户的宠物：&quot;</span> + (user01.getPet() == tom));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// tom1组件是多实例的，tom1对象和tom2对象不相同</span></span><br><span class="line">        Pet tom1 = run.getBean(<span class="string">&quot;tom1&quot;</span>, Pet.class);</span><br><span class="line">        Pet tom2 = run.getBean(<span class="string">&quot;tom1&quot;</span>, Pet.class);</span><br><span class="line">        System.out.println(tom1 == tom2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@Configuration</code> 标注在类上，表明该类是一个配置类，作用等同于 Spring 的 xml 配置文件中的 &lt;beans&gt; 标签，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user01&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.web.bean.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pet&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;lisi&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.web.bean.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;lisi&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;19&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;tom&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.web.bean.Pet&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tomcat&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据 <code>@Configuration</code> 注解的 proxyBeanMethods 属性值：</p>
<ul>
<li>false：Lite 模式。当配置类组件之间无依赖关系时，用 Lite 模式可以减少判断，加速容器启动过程。</li>
<li>true：Full 模式。当配置类组件之间有依赖关系时，配置类里的 Bean 方法会被调用，为了得到之前容器中注册的单实例组件，需要使用 Full 模式。<ul>
<li>组件依赖必须使用 Full 模式。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>@ComponentScan</code>：指定扫描的包，默认扫码主程序所在包及其下面的所有子包。</p>
</li>
<li><p><code>@Import</code>：给容器中自动创建出指定类型的组件，并且，默认组件的名字是全类名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(&#123;User.class, ThrowableToStringArray.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;lisi&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">&quot;lisi&quot;</span>, <span class="number">19</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.返回IOC容器</span></span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.按User类型获取容器中注册的实例</span></span><br><span class="line">        String[] beanNamesForType = run.getBeanNamesForType(User.class);</span><br><span class="line">        <span class="keyword">for</span> (String bean : beanNamesForType) &#123;</span><br><span class="line">            System.out.println(bean);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ThrowableToStringArray bean = run.getBean(ThrowableToStringArray.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    cn.xisun.web.bean.User											<span class="comment">// 全类名</span></span><br><span class="line">	user01															<span class="comment">// 容器中注册的</span></span><br><span class="line">	lisi															<span class="comment">// 容器中注册的</span></span><br><span class="line">	ch.qos.logback.core.helpers.ThrowableToStringArray@<span class="number">312</span>afbc7		<span class="comment">// 全类名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Bean</code>、<code>@Component</code>、<code>@Controller</code>、<code>@Service</code>、<code>@Repository</code>。</p>
</li>
<li><p><code>@Conditional</code>：条件装配，当满足 <code>@Conditional</code> 指定的条件时，则进行组件注入。</p>
<ul>
<li><p><code>@Conditional</code> 注解有多个派生注解，每一个派生注解都代表一种条件。</p>
<p><img src="/2021/06/12/spring-boot/image-20210709153759323.png" alt="image-20210709153759323"></p>
<ul>
<li><code>@ConditionalOnBean</code>：当容器中存在指定的 Bean 时。</li>
<li><code>@ConditionalOnMissingBean</code>：当容器中不存在指定的 Bean 时。</li>
<li><code>@ConditionalOnClass</code>：当容器中存在指定的类时。</li>
<li><code>@ConditionalOnMissingClass</code>：当容器中不存在指定的类时。</li>
<li><code>@ConditionalOnJava</code>：当指定的 Java 版本时。</li>
<li><code>@ConditionalOnResource</code>：当指定资源存在时。</li>
</ul>
</li>
<li><p>注意：配置类中定义的组件，是按照从上到下的顺序依次注册的，在使用类似 <code>@ConditionalOnBean</code> 这样的条件装配注解时，需要注意组件的定义顺序。在这样的情况下，在配置类上使用条件装配注解时，需要额外注意。</p>
<ul>
<li><p>tom 组件在 user01 组件上面定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">tomcatPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(name = &quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User zhangsan = <span class="keyword">new</span> User(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line">        <span class="keyword">boolean</span> tom = run.containsBean(<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> user01 = run.containsBean(<span class="string">&quot;user01&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在tom？&quot;</span> + tom);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在user01？&quot;</span> + user01);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    容器中存在tom？<span class="keyword">true</span></span><br><span class="line">	容器中存在user01？<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>tom 组件在 user01 组件下面定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(name = &quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User zhangsan = <span class="keyword">new</span> User(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">tomcatPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line">        <span class="keyword">boolean</span> tom = run.containsBean(<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> user01 = run.containsBean(<span class="string">&quot;user01&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在tom？&quot;</span> + tom);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在user01？&quot;</span> + user01);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    容器中存在tom？<span class="keyword">true</span></span><br><span class="line">	容器中存在user01？<span class="keyword">false</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="原生配置文件引入"><a href="#原生配置文件引入" class="headerlink" title="原生配置文件引入"></a>原生配置文件引入</h3><ul>
<li><p><code>@ImportResource</code>：导入 Spring 的配置文件，使用在主类上，或者任一配置类上。当旧项目更新，并存在很多配置文件时，会很有用处。</p>
<ul>
<li><p>oldBeans.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;wangwu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.web.bean.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wangwu&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pet&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;jerry&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jerry&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.web.bean.Pet&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jerry&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>MainApplication.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ImportResource(&quot;classpath:oldBeans.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line">        <span class="keyword">boolean</span> wangwu = run.containsBean(<span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> jerry = run.containsBean(<span class="string">&quot;jerry&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在jerry？&quot;</span> + jerry);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中存在wangwu？&quot;</span> + wangwu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    容器中存在jerry？<span class="keyword">true</span></span><br><span class="line">	容器中存在wangwu？<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="配置绑定"><a href="#配置绑定" class="headerlink" title="配置绑定"></a>配置绑定</h3><ul>
<li><p>application.properties 文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="meta">mycar.brand</span>=<span class="string">BMW</span></span><br><span class="line"><span class="meta">mycar.price</span>=<span class="string">200000.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>待封装的 JavaBean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrand</span><span class="params">(String brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(Double price)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>自定义的类和配置文件绑定一般没有提示，Car 类上会出现以下提示，需要添加 <code>spring-boot-configuration-processo</code> 依赖：</p>
<p><img src="/2021/06/12/spring-boot/image-20210715114843221.png" alt="image-20210715114843221"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>该依赖只在开发时提供帮助，因此在打包 jar 包时，应该排除：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 打包插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 打包时排除依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>从 application.properties 文件中读取内容，并且把它封装到 JavaBean 中的普通写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;application.properties&quot;</span>);</span><br><span class="line">    properties.load(is);</span><br><span class="line">    <span class="comment">// 得到配置文件中的值</span></span><br><span class="line">    Enumeration&lt;?&gt; enumeration = properties.propertyNames();</span><br><span class="line">    <span class="keyword">while</span> (enumeration.hasMoreElements()) &#123;</span><br><span class="line">        String strKey = (String) enumeration.nextElement();</span><br><span class="line">        String strValue = properties.getProperty(strKey);</span><br><span class="line">        System.out.println(strKey + <span class="string">&quot;=&quot;</span> + strValue);</span><br><span class="line">        <span class="comment">// 封装到JavaBean的操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式一：在需绑定的 JavaBean 上，添加 <code>@Component</code> 和 <code>@ConfigurationProperties</code> 注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/7/9 21:58</span></span><br><span class="line"><span class="comment"> * 1.使用<span class="doctag">@Component</span>注解将JavaBean注册到容器中，只有容器中的组件才能</span></span><br><span class="line"><span class="comment"> * 拥有SpringBoot提供的功能，这是前提；</span></span><br><span class="line"><span class="comment"> * 2.使用<span class="doctag">@ConfigurationProperties</span>注解，将配置文件和JavaBean绑定，</span></span><br><span class="line"><span class="comment"> * prefix属性指定配置文件中需绑定的值的前缀；</span></span><br><span class="line"><span class="comment"> * 3.JavaBean的属性名，需和配置文件中对应值前缀后的值相同。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrand</span><span class="params">(String brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(Double price)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：在需绑定的 JavaBean 上，添加 <code>@ConfigurationProperties</code> 注解，在配置类上添加 <code>@EnableConfigurationProperties</code> 注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/7/9 21:58</span></span><br><span class="line"><span class="comment"> * 1.使用<span class="doctag">@ConfigurationProperties</span>注解，将配置文件和JavaBean绑定，</span></span><br><span class="line"><span class="comment"> * prefix属性指定配置文件中需绑定的值的前缀；</span></span><br><span class="line"><span class="comment"> * 2.JavaBean的属性名，需和配置文件中对应值前缀后的值相同。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrand</span><span class="params">(String brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(Double price)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.使用<span class="doctag">@EnableConfigurationProperties</span>注解，开启待装配的JavaBean的配置绑定功能，</span></span><br><span class="line"><span class="comment"> * 同时，将该JavaBean这个组件自动注入到容器中；</span></span><br><span class="line"><span class="comment"> * 2.JavaBean上不需要使用<span class="doctag">@Component</span>注解，某些时候，比如JavaBean是第三方依赖包中的</span></span><br><span class="line"><span class="comment"> * 类，这个特点会很重要。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;Car.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User zhangsan = <span class="keyword">new</span> User(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pet <span class="title">tomcatPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pet(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>主类测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/20 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 主程序类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取容器中的Car类型的组件</span></span><br><span class="line">        String[] beanNamesForType = run.getBeanNamesForType(Car.class);</span><br><span class="line">        <span class="keyword">for</span> (String beanName : beanNamesForType) &#123;</span><br><span class="line">            System.out.println(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Car car = run.getBean(<span class="string">&quot;car&quot;</span>, Car.class);</span><br><span class="line">        System.out.println(car);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">方式一输出结果：</span><br><span class="line">    car</span><br><span class="line">	Car&#123;brand=<span class="string">&#x27;BMW&#x27;</span>, price=<span class="number">200000.0</span>&#125;</span><br><span class="line"></span><br><span class="line">方式二输出结果：</span><br><span class="line">    mycar-cn.xisun.web.bean.Car</span><br><span class="line">	Car&#123;brand=<span class="string">&#x27;BMW&#x27;</span>, price=<span class="number">200000.0</span>&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于方式一，注册到容器中的组件名，就是 JavaBean 类名的首字母小写。</p>
<p>对于方式二，注册到容器中的组件名，有所不同，为前缀加 JavaBean 全类名。</p>
</blockquote>
</li>
<li><p>Controller 中获取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/6/20 15:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/car&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">car</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, Spring Boot 2!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210710220348915.png" alt="image-20210710220348915"></p>
</li>
</ul>
<h2 id="Spring-Boot-的自动配置原理入门"><a href="#Spring-Boot-的自动配置原理入门" class="headerlink" title="Spring Boot 的自动配置原理入门"></a>Spring Boot 的自动配置原理入门</h2><h3 id="引导加载自动配置类"><a href="#引导加载自动配置类" class="headerlink" title="引导加载自动配置类"></a>引导加载自动配置类</h3><ul>
<li><p>主类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>@SpringBootApplication</code>：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">      @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@SpringBootConfiguration</code>：是 <code>@Configuration</code> 的派生注解，表明当前主类实际上也是一个配置类。</p>
</li>
<li><p><code>@ComponentScan</code>：指定扫描的包，默认为当前主类所在包及其子包。</p>
</li>
<li><p><strong><code>@EnableAutoConfiguration</code>：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>@AutoConfigurationPackage</code>：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationPackages.Registrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@Import(AutoConfigurationPackages.Registrar.class)</code>：向容器中注册了一个 AutoConfigurationPackages.Registrar.class 组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; to store the base package from the importing</span></span><br><span class="line"><span class="comment"> * configuration.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">      register(registry, <span class="keyword">new</span> PackageImports(metadata).getPackageNames().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> PackageImports(metadata));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>new PackageImports(metadata).getPackageNames()</code>：拿到元注解所包含的包信息，实际上就是主类所在的包，如 <code>cn.xisun.web</code>。</li>
<li><code>register()</code> 的功能，也就是将主类所在包下的所有组件，批量注册到容器中。这也就是默认包路径为主类所在包的原因。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>@Import(AutoConfigurationImportSelector.class)</code>：</strong>向容器中注册了一个 AutoConfigurationImportSelector.class 组件，执行如下方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">   <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">      <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">   &#125;</span><br><span class="line">   AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">   <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>getAutoConfigurationEntry(annotationMetadata)</code>：向容器中批量注册一些组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">      <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">   &#125;</span><br><span class="line">   AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">   List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">   configurations = removeDuplicates(configurations);</span><br><span class="line">   Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">   checkExcludedClasses(configurations, exclusions);</span><br><span class="line">   configurations.removeAll(exclusions);</span><br><span class="line">   configurations = getConfigurationClassFilter().filter(configurations);</span><br><span class="line">   fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>getCandidateConfigurations(annotationMetadata, attributes);</code>：获取所有待批量注册的组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">   List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),</span><br><span class="line">         getBeanClassLoader());</span><br><span class="line">   Assert.notEmpty(configurations, <span class="string">&quot;No auto configuration classes found in META-INF/spring.factories. If you &quot;</span></span><br><span class="line">         + <span class="string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</code>：具体通过 SpringFactoriesLoader 工厂加载所有的组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * The location to look for factories.</span></span><br><span class="line"><span class="comment">  * &lt;p&gt;Can be present in multiple JAR files.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">&quot;META-INF/spring.factories&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">   ClassLoader classLoaderToUse = classLoader;</span><br><span class="line">   <span class="keyword">if</span> (classLoaderToUse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br><span class="line">   &#125;</span><br><span class="line">   String factoryTypeName = factoryType.getName();</span><br><span class="line">   <span class="keyword">return</span> loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(ClassLoader classLoader) &#123;</span><br><span class="line">   Map&lt;String, List&lt;String&gt;&gt; result = cache.get(classLoader);</span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 在此处，加载项目里</span></span><br><span class="line">      Enumeration&lt;URL&gt; urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION);</span><br><span class="line">      <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">         URL url = urls.nextElement();</span><br><span class="line">         UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">         Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">         <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            String factoryTypeName = ((String) entry.getKey()).trim();</span><br><span class="line">            String[] factoryImplementationNames =</span><br><span class="line">                  StringUtils.commaDelimitedListToStringArray((String) entry.getValue());</span><br><span class="line">            <span class="keyword">for</span> (String factoryImplementationName : factoryImplementationNames) &#123;</span><br><span class="line">               result.computeIfAbsent(factoryTypeName, key -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;())</span><br><span class="line">                     .add(factoryImplementationName.trim());</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Replace all lists with unmodifiable lists containing unique elements</span></span><br><span class="line">      result.replaceAll((factoryType, implementations) -&gt; implementations.stream().distinct()</span><br><span class="line">            .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList)));</span><br><span class="line">      cache.put(classLoader, result);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to load factories from location [&quot;</span> +</span><br><span class="line">            FACTORIES_RESOURCE_LOCATION + <span class="string">&quot;]&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>classLoader.getResources(FACTORIES_RESOURCE_LOCATION);</code>：此方法扫描项目内各 jar 包的 <code>META-INF/spring.factories</code> 路径内声明的资源。主要看 <code>spring-boot-autoconfigure-2.5.1.jar</code> 包下的 spring.factories 文件，该文件内声明了 131 个需要自动注册的组件，当 Spring Boot 启动时，就会向容器中注册这些声明的组件：</p>
<p><img src="/2021/06/12/spring-boot/image-20210713150035110.png" alt="image-20210713150035110"></p>
<p><img src="/2021/06/12/spring-boot/image-20210713150238536.png" alt="image-20210713150238536"></p>
<p><img src="/2021/06/12/spring-boot/image-20210713132839154.png" alt="image-20210713132839154"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="按需开启自动配置项"><a href="#按需开启自动配置项" class="headerlink" title="按需开启自动配置项"></a>按需开启自动配置项</h3><ul>
<li><p>在上面的分析中，Spring Boot 在启动时，默认会加载 131 个自动配置的组件。但在实际启动时，各 xxxxAutoConfiguration 组件，会根据 <code>@Conditional</code> 注解，即按照条件装配规则，实现按需配置。</p>
</li>
<li><p>例如，<code>org.springframework.boot.autoconfigure.aop.AopAutoConfiguration</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当org.aspectj.weaver.Advice.class文件存在时，AspectJAutoProxyingConfiguration生效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(Advice.class)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectJAutoProxyingConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">      <span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = false)</span></span><br><span class="line">      <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;)</span></span><br><span class="line">      <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicAutoProxyConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">      <span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line">      <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">            matchIfMissing = true)</span></span><br><span class="line">      <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibAutoProxyConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当org.aspectj.weaver.Advice.class文件不存在，且配置文件中spring.aop.proxy-target-class属性值为true(默认为true)时，</span></span><br><span class="line"><span class="comment">     * ClassProxyingConfiguration生效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingClass(&quot;org.aspectj.weaver.Advice&quot;)</span></span><br><span class="line">   <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;,</span></span><br><span class="line"><span class="meta">         matchIfMissing = true)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassProxyingConfiguration</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">static</span> BeanFactoryPostProcessor <span class="title">forceAutoProxyCreatorToUseClassProxying</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> (beanFactory) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> BeanDefinitionRegistry) &#123;</span><br><span class="line">               BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">               AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">               AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</code>：当配置文件中配置了 <code>spring.aop.auto</code> 属性，且值为 true 时，AopAutoConfiguration 生效。默认情况下，即使没有配置此属性，也认为其生效。</li>
<li>可以看出，当导入 aop 依赖时，会注册 AspectJAutoProxyingConfiguration 配置类，否则，注册 ClassProxyingConfiguration 配置类，且后者是 Spring Boot 默认开启的一个简单的 aop 功能。</li>
</ul>
</li>
<li><p>例如，<code>org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span><span class="comment">// 当前配置类的配置顺序</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span><span class="comment">// 当项目是一个原生的Web Servlet应用时</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span><span class="comment">// 当容器中存在DispatcherServlet.class时</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(ServletWebServerFactoryAutoConfiguration.class)</span><span class="comment">// 在ServletWebServerFactoryAutoConfiguration后配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The bean name for a DispatcherServlet that will be mapped to the root URL &quot;/&quot;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DISPATCHER_SERVLET_BEAN_NAME = <span class="string">&quot;dispatcherServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The bean name for a ServletRegistrationBean for the DispatcherServlet &quot;/&quot;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME = <span class="string">&quot;dispatcherServletRegistration&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@Conditional(DefaultDispatcherServletCondition.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(ServletRegistration.class)</span><span class="comment">// 当容器中存在ServletRegistration.class时</span></span><br><span class="line">   <span class="meta">@EnableConfigurationProperties(WebMvcProperties.class)</span><span class="comment">// 开启WebMvcProperties类的配置绑定功能，并注册到容器中</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span><span class="comment">// 注册DispatcherServlet组件到容器中，名字为dispatcherServlet</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> DispatcherServlet <span class="title">dispatcherServlet</span><span class="params">(WebMvcProperties webMvcProperties)</span> </span>&#123;</span><br><span class="line">         DispatcherServlet dispatcherServlet = <span class="keyword">new</span> DispatcherServlet();<span class="comment">// 新建了一个DispatcherServlet对象</span></span><br><span class="line">         dispatcherServlet.setDispatchOptionsRequest(webMvcProperties.isDispatchOptionsRequest());</span><br><span class="line">         dispatcherServlet.setDispatchTraceRequest(webMvcProperties.isDispatchTraceRequest());</span><br><span class="line">         dispatcherServlet.setThrowExceptionIfNoHandlerFound(webMvcProperties.isThrowExceptionIfNoHandlerFound());</span><br><span class="line">         dispatcherServlet.setPublishEvents(webMvcProperties.isPublishRequestHandledEvents());</span><br><span class="line">         dispatcherServlet.setEnableLoggingRequestDetails(webMvcProperties.isLogRequestDetails());</span><br><span class="line">         <span class="keyword">return</span> dispatcherServlet;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean</span><span class="comment">// 注册MultipartResolver组件到容器中，即文件上传解析器</span></span><br><span class="line">      <span class="meta">@ConditionalOnBean(MultipartResolver.class)</span><span class="comment">// 当容器中存在MultipartResolver.class时</span></span><br><span class="line">      <span class="comment">// 当容器中没有name为multipartResolver的MultipartResolver对象时</span></span><br><span class="line">      <span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span></span><br><span class="line">      <span class="comment">// 用@Bean标注的方法传入的对象参数，会从容器中找一个该参数所属类型的对象，并赋值</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 因为容器中有MultipartResolver的对象，所以resolver参数会自动绑定该对象</span></span><br><span class="line">         <span class="comment">// 此方法的作用是，防止有些用户配置的文件上传解析器不符合规范：</span></span><br><span class="line">         <span class="comment">// 将用户自己配置的文件上传解析器重新注册给容器，并重命名为multipartResolver(方法名)</span></span><br><span class="line">         <span class="comment">// (Spring Boot种的文件上传解析器的名字，就叫multipartResolver)</span></span><br><span class="line">         <span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">         <span class="keyword">return</span> resolver;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@Conditional(DispatcherServletRegistrationCondition.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(ServletRegistration.class)</span></span><br><span class="line">   <span class="meta">@EnableConfigurationProperties(WebMvcProperties.class)</span></span><br><span class="line">   <span class="meta">@Import(DispatcherServletConfiguration.class)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletRegistrationConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)</span></span><br><span class="line">      <span class="meta">@ConditionalOnBean(value = DispatcherServlet.class, name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title">dispatcherServletRegistration</span><span class="params">(DispatcherServlet dispatcherServlet,</span></span></span><br><span class="line"><span class="function"><span class="params">            WebMvcProperties webMvcProperties, ObjectProvider&lt;MultipartConfigElement&gt; multipartConfig)</span> </span>&#123;</span><br><span class="line">         DispatcherServletRegistrationBean registration = <span class="keyword">new</span> DispatcherServletRegistrationBean(dispatcherServlet,</span><br><span class="line">               webMvcProperties.getServlet().getPath());</span><br><span class="line">         registration.setName(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span><br><span class="line">         registration.setLoadOnStartup(webMvcProperties.getServlet().getLoadOnStartup());</span><br><span class="line">         multipartConfig.ifAvailable(registration::setMultipartConfig);</span><br><span class="line">         <span class="keyword">return</span> registration;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Order(Ordered.LOWEST_PRECEDENCE - 10)</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultDispatcherServletCondition</span> <span class="keyword">extends</span> <span class="title">SpringBootCondition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> ConditionOutcome <span class="title">getMatchOutcome</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">         ConditionMessage.Builder message = ConditionMessage.forCondition(<span class="string">&quot;Default DispatcherServlet&quot;</span>);</span><br><span class="line">         ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">         List&lt;String&gt; dispatchServletBeans = Arrays</span><br><span class="line">               .asList(beanFactory.getBeanNamesForType(DispatcherServlet.class, <span class="keyword">false</span>, <span class="keyword">false</span>));</span><br><span class="line">         <span class="keyword">if</span> (dispatchServletBeans.contains(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome</span><br><span class="line">                  .noMatch(message.found(<span class="string">&quot;dispatcher servlet bean&quot;</span>).items(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (beanFactory.containsBean(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.noMatch(</span><br><span class="line">                  message.found(<span class="string">&quot;non dispatcher servlet bean&quot;</span>).items(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (dispatchServletBeans.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.match(message.didNotFind(<span class="string">&quot;dispatcher servlet beans&quot;</span>).atAll());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> ConditionOutcome.match(message.found(<span class="string">&quot;dispatcher servlet bean&quot;</span>, <span class="string">&quot;dispatcher servlet beans&quot;</span>)</span><br><span class="line">               .items(Style.QUOTE, dispatchServletBeans)</span><br><span class="line">               .append(<span class="string">&quot;and none is named &quot;</span> + DEFAULT_DISPATCHER_SERVLET_BEAN_NAME));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Order(Ordered.LOWEST_PRECEDENCE - 10)</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletRegistrationCondition</span> <span class="keyword">extends</span> <span class="title">SpringBootCondition</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> ConditionOutcome <span class="title">getMatchOutcome</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</span><br><span class="line">         ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">         ConditionOutcome outcome = checkDefaultDispatcherName(beanFactory);</span><br><span class="line">         <span class="keyword">if</span> (!outcome.isMatch()) &#123;</span><br><span class="line">            <span class="keyword">return</span> outcome;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> checkServletRegistration(beanFactory);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> ConditionOutcome <span class="title">checkDefaultDispatcherName</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">boolean</span> containsDispatcherBean = beanFactory.containsBean(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span><br><span class="line">         <span class="keyword">if</span> (!containsDispatcherBean) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.match();</span><br><span class="line">         &#125;</span><br><span class="line">         List&lt;String&gt; servlets = Arrays</span><br><span class="line">               .asList(beanFactory.getBeanNamesForType(DispatcherServlet.class, <span class="keyword">false</span>, <span class="keyword">false</span>));</span><br><span class="line">         <span class="keyword">if</span> (!servlets.contains(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.noMatch(</span><br><span class="line">                  startMessage().found(<span class="string">&quot;non dispatcher servlet&quot;</span>).items(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> ConditionOutcome.match();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> ConditionOutcome <span class="title">checkServletRegistration</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">         ConditionMessage.Builder message = startMessage();</span><br><span class="line">         List&lt;String&gt; registrations = Arrays</span><br><span class="line">               .asList(beanFactory.getBeanNamesForType(ServletRegistrationBean.class, <span class="keyword">false</span>, <span class="keyword">false</span>));</span><br><span class="line">         <span class="keyword">boolean</span> containsDispatcherRegistrationBean = beanFactory</span><br><span class="line">               .containsBean(DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME);</span><br><span class="line">         <span class="keyword">if</span> (registrations.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (containsDispatcherRegistrationBean) &#123;</span><br><span class="line">               <span class="keyword">return</span> ConditionOutcome.noMatch(message.found(<span class="string">&quot;non servlet registration bean&quot;</span>)</span><br><span class="line">                     .items(DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.match(message.didNotFind(<span class="string">&quot;servlet registration bean&quot;</span>).atAll());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (registrations.contains(DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.noMatch(message.found(<span class="string">&quot;servlet registration bean&quot;</span>)</span><br><span class="line">                  .items(DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (containsDispatcherRegistrationBean) &#123;</span><br><span class="line">            <span class="keyword">return</span> ConditionOutcome.noMatch(message.found(<span class="string">&quot;non servlet registration bean&quot;</span>)</span><br><span class="line">                  .items(DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME));</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> ConditionOutcome.match(message.found(<span class="string">&quot;servlet registration beans&quot;</span>).items(Style.QUOTE, registrations)</span><br><span class="line">               .append(<span class="string">&quot;and none is named &quot;</span> + DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> ConditionMessage.<span class="function">Builder <span class="title">startMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> ConditionMessage.forCondition(<span class="string">&quot;DispatcherServlet Registration&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@ConditionalOnWebApplication(type = Type.SERVLET)</code>：Spring Boot 支持两种类型的 Web 应用开发，一种是响应式，一种是原生 Servlet。响应式 Web 开发导入 <code>spring-boot-starter-webflux</code> 依赖，原生 Servlet Web 开发导入 <code>spring-boot-starter-web</code> 依赖。</p>
</li>
<li><p><code>@ConditionalOnClass(DispatcherServlet.class)</code>：在主类中可以验证项目中存在 DispatcherServlet 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        String[] beanNamesForType = run.getBeanNamesForType(DispatcherServlet.class);</span><br><span class="line">        System.out.println(beanNamesForType.length);<span class="comment">// 1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>例如，<code>org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span><span class="comment">// 开启ServerProperties类的配置绑定功能，并注册到容器中</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span><span class="comment">// 当项目是一个原生的Web Servlet应用时</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CharacterEncodingFilter.class)</span><span class="comment">// 当容器中存在CharacterEncodingFilter.class时</span></span><br><span class="line"><span class="comment">// 当配置文件中server.servlet.encoding属性值为enabled(默认为true)时</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;server.servlet.encoding&quot;, value = &quot;enabled&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpEncodingAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Encoding properties;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">HttpEncodingAutoConfiguration</span><span class="params">(ServerProperties properties)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.properties = properties.getServlet().getEncoding();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向容器中注册一个CharacterEncodingFilter组件，此组件就是解决Spring Boot收到的请求出现乱码的问题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span><span class="comment">// 当容器中没有这个Bean时才配置，即用户未配置时，Spring Boot才主动配置一个</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CharacterEncodingFilter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      CharacterEncodingFilter filter = <span class="keyword">new</span> OrderedCharacterEncodingFilter();</span><br><span class="line">      filter.setEncoding(<span class="keyword">this</span>.properties.getCharset().name());</span><br><span class="line">      filter.setForceRequestEncoding(<span class="keyword">this</span>.properties.shouldForce(Encoding.Type.REQUEST));</span><br><span class="line">      filter.setForceResponseEncoding(<span class="keyword">this</span>.properties.shouldForce(Encoding.Type.RESPONSE));</span><br><span class="line">      <span class="keyword">return</span> filter;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> LocaleCharsetMappingsCustomizer <span class="title">localeCharsetMappingsCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LocaleCharsetMappingsCustomizer(<span class="keyword">this</span>.properties);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LocaleCharsetMappingsCustomizer</span></span></span><br><span class="line"><span class="class">         <span class="keyword">implements</span> <span class="title">WebServerFactoryCustomizer</span>&lt;<span class="title">ConfigurableServletWebServerFactory</span>&gt;, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> Encoding properties;</span><br><span class="line"></span><br><span class="line">      LocaleCharsetMappingsCustomizer(Encoding properties) &#123;</span><br><span class="line">         <span class="keyword">this</span>.properties = properties;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(ConfigurableServletWebServerFactory factory)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getMapping() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            factory.setLocaleCharsetMappings(<span class="keyword">this</span>.properties.getMapping());</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>HttpEncodingAutoConfiguration 配置类会防止 Spring Boot 乱码。</p>
</li>
<li><p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/helloWho&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloWho</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210714132902955.png" alt="image-20210714132902955"></p>
<p><img src="/2021/06/12/spring-boot/image-20210714133027284.png" alt="image-20210714133027284"></p>
</li>
</ul>
</li>
</ul>
<h3 id="修改默认配置"><a href="#修改默认配置" class="headerlink" title="修改默认配置"></a>修改默认配置</h3><ul>
<li><p>一般来说，Spring Boot 默认会在底层配好所有需要的组件，但是如果用户自己配置了，就会以用户配置的优先。</p>
</li>
<li><p>以 CharacterEncodingFilter 为例，如果用户希望按自己的需求进行配置，可以在配置类中自行添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharacterEncodingFilter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// filter的实现代码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从前面对 CharacterEncodingFilter 的分析可以看出，当用户自己配置了 CharacterEncodingFilter 的实例时，Spring Boot 就不会再配置。</p>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>Spring Boot 先加载所有的自动配置类，即 xxxxxAutoConfiguration.class。</p>
</li>
<li><p>每个自动配置类按照条件进行生效。xxxxxAutoConfiguration.class 在配置时，会从对应的 xxxxxProperties.class 中取值，而 xxxxxProperties.class 会和配置文件中对应的值进行绑定。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Conditional(DefaultDispatcherServletCondition.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ServletRegistration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WebMvcProperties.class)</span><span class="comment">// WebMvcProperties.class与配置文件绑定</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServletConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DispatcherServlet <span class="title">dispatcherServlet</span><span class="params">(WebMvcProperties webMvcProperties)</span> </span>&#123;<span class="comment">// 从容器中的webMvcProperties组件取值</span></span><br><span class="line">      DispatcherServlet dispatcherServlet = <span class="keyword">new</span> DispatcherServlet();</span><br><span class="line">      dispatcherServlet.setDispatchOptionsRequest(webMvcProperties.isDispatchOptionsRequest());</span><br><span class="line">      dispatcherServlet.setDispatchTraceRequest(webMvcProperties.isDispatchTraceRequest());</span><br><span class="line">      dispatcherServlet.setThrowExceptionIfNoHandlerFound(webMvcProperties.isThrowExceptionIfNoHandlerFound());</span><br><span class="line">      dispatcherServlet.setPublishEvents(webMvcProperties.isPublishRequestHandledEvents());</span><br><span class="line">      dispatcherServlet.setEnableLoggingRequestDetails(webMvcProperties.isLogRequestDetails());</span><br><span class="line">      <span class="keyword">return</span> dispatcherServlet;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生效的配置类，会给容器中装配很多不同功能的组件；</p>
</li>
<li><p>这些组件装配到容器中后，项目就具有了该组件所具有的功能；</p>
</li>
<li><p>如果用户自行配置了某一个组件，则以用户配置的优先。</p>
</li>
<li><p>若想实现定制化配置，有两种方法：</p>
<ul>
<li>方法一：用户自行配置组件，添加 <code>@Bean</code> 注解，用以替换 Spring Boot 底层的默认组件。</li>
<li>方法二：用户查看该组件从配置文件种获取的是什么属性的值，然后按需求自行修改对应的属性值。比如 HttpEncodingAutoConfiguration 对应的就是配置文件中的 <code>server.servlet.encoding</code> 属性。<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties</a></li>
</ul>
</li>
</ul>
</li>
<li><p>过程：<strong>xxxxxAutoConfiguration.class —&gt; 注册组件 —&gt; 从 xxxxxProperties.class 里面拿值 —-&gt; 绑定 application.properties 文件</strong>。</p>
<ul>
<li>可以看出，一般通过修改 application.properties 文件中相应的配置，就可完成 Spring Boot 功能的修改。</li>
</ul>
</li>
</ul>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ul>
<li><p>第一步：引入相应的场景依赖。</p>
<ul>
<li>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters">https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters</a></li>
</ul>
</li>
<li><p>第二步：查看 Spring Boot 做了哪些自动配置。</p>
<ul>
<li><p>自己查看底层源码，找出对应配置的参数。一般来说，引入一个场景后，该场景对应的自动配置都会生效。</p>
</li>
<li><p>配置文件中添加 <code>debug=true</code>，开启自动配置的报告。启动主程序后，即可在控制台查看所有生效和未生效的配置 — Positive (生效) / Negative (未生效)：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">debug</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210715111453136.png" alt="image-20210715111453136"></p>
<p><img src="/2021/06/12/spring-boot/image-20210715111558457.png" alt="image-20210715111558457"></p>
</li>
</ul>
</li>
<li><p>第三步：按照需求，确定是否需要修改默写配置。</p>
<ul>
<li><p>参照文档修改配置项</p>
<ul>
<li><p>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties</a></p>
</li>
<li><p>自己查看底层源码，分析 xxxxxProperties.class 绑定了配置文件的哪些属性。</p>
</li>
<li><p>比如，修改 Spring Boot 启动时的 banner 图：</p>
<ul>
<li><p>原图：</p>
<table>
<thead>
<tr>
<th><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties.core.spring.banner.image.location"><code>spring.banner.image.location</code></a></th>
<th>Banner image file location (jpg or png can also be used).</th>
<th><code>classpath:banner.gif</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><img src="/2021/06/12/spring-boot/image-20210715113318390.png" alt="image-20210715113318390"></p>
</li>
<li><p>添加配置到配置文件中，或者将 classpath 路径下的 spring.jpg 重命名为 banner.jpg (Spring Boot 默认查找 classpath 下的 banner 图片)：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.banner.image.location</span>=<span class="string">classpath:spring.jpg</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210715113542645.png" alt="image-20210715113542645"></p>
</li>
<li><p>新图：</p>
<p><img src="/2021/06/12/spring-boot/image-20210715113617461.png" alt="image-20210715113617461"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>自定义加入或者替换组件。</p>
<ul>
<li><code>@Bean</code>、<code>@Component</code> 等。</li>
</ul>
</li>
<li><p>自定义器 <strong>xxxxxCustomizer</strong>；</p>
</li>
</ul>
</li>
<li><p>第四步：实现自己所需功能的业务逻辑。</p>
</li>
</ul>
<h2 id="Spring-Boot-的开发工具"><a href="#Spring-Boot-的开发工具" class="headerlink" title="Spring Boot 的开发工具"></a>Spring Boot 的开发工具</h2><h3 id="dev-tools"><a href="#dev-tools" class="headerlink" title="dev-tools"></a>dev-tools</h3><ul>
<li><p>Maven 添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动项目，在后续开发时，如果对项目有改动，使用 <code>ctrl + F9</code> 快捷键，即可刷新项目，实现简单的热更新，其本质上是自动重启项目。</p>
</li>
<li><p>如果项目做了某些改动，<code>ctrl + F9</code> 之后，控制台会打印重启信息。</p>
</li>
</ul>
<h3 id="Spring-Initailizr"><a href="#Spring-Initailizr" class="headerlink" title="Spring Initailizr"></a>Spring Initailizr</h3><ul>
<li><p>项目初始化向导，能够快速的创建 Spring Boot 的项目。</p>
</li>
<li><p>New Project 时，选择需要的开发场景，Spring Boot 会自动添加所需要的依赖，并创建好主类：</p>
<p><img src="/2021/06/12/spring-boot/image-20210715133805834.png" alt="image-20210715133805834"></p>
<p><img src="/2021/06/12/spring-boot/image-20210715134035829.png" alt="image-20210715134035829"></p>
<p><img src="/2021/06/12/spring-boot/image-20210715143251658.png" alt="image-20210715143251658"></p>
<p><img src="/2021/06/12/spring-boot/image-20210715143631578.png" alt="image-20210715143631578"></p>
<blockquote>
<p>static：静态资源，如 css，js 等；templates：Web 页面。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 自动添加parent --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xisun.springboot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>helloworld<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>helloworld<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 自动添加相关依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Web开发 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 单元测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 自动添加打包插件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Spring-Boot-2-核心功能"><a href="#Spring-Boot-2-核心功能" class="headerlink" title="Spring Boot 2 核心功能"></a>Spring Boot 2 核心功能</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h4><ul>
<li><p>properties：同前面 application.properties 配置文件的写法。</p>
</li>
<li><p>yaml：</p>
<ul>
<li><p>YAML 是 “YAML Ain’t Markup Language” (YAML 不是一种标记语言 ) 的递归缩写。在开发这种语言时，YAML 的意思其实是：”Yet Another Markup Language” (仍是一种标记语言)。 </p>
</li>
<li><p>yarm 非常适合用来做以数据为中心的配置文件。</p>
</li>
<li><p>基本语法：</p>
<ul>
<li><p>书写格式：<code>key: value</code>，key 和 value 之间有空格；</p>
</li>
<li><p>大小写敏感；</p>
</li>
<li><p>使用缩进表示层级关系；</p>
</li>
<li><p>缩进不允许使用 tab，只允许使用空格；</p>
</li>
<li><p>缩进的空格数不重要，只要相同层级的元素左对齐即可；</p>
</li>
<li><p># 表示注释；</p>
</li>
<li><p>文件中的字符串无需加引号，如果要加，’ ‘ 内的字符串内容会被转义，” “ 内的字符串内容不会被转义。</p>
<ul>
<li><p>单引号：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">&#x27;zhangsan \n 李四&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloworldApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(HelloworldApplication.class, args);</span><br><span class="line">        Person person = run.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(person.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    zhangsan \n 李四</span><br></pre></td></tr></table></figure>

<blockquote>
<p>单引号内的 \n，没有表现出换行的本意，而是被转义为了 \n 字符串 — 单引号内的字符串内容会被转义。</p>
</blockquote>
</li>
<li><p>双引号：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">&quot;zhangsan \n 李四&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloworldApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(HelloworldApplication.class, args);</span><br><span class="line">        Person person = run.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(person.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    zhangsan </span><br><span class="line"> 	 李四</span><br></pre></td></tr></table></figure>

<blockquote>
<p>双引号内的 \n，表现出换行的本意，没有被转义为 \n 字符串 — 双引号内的字符串内容不会被转义。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>数据类型：</p>
<ul>
<li><p>字面量：单个的、不可再分的值。如 date、boolean、string、number、null。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对象：键值对的集合。如 map、hash、set、object。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 行内写法</span></span><br><span class="line"><span class="attr">key:</span> &#123;<span class="string">key1:value1</span>, <span class="string">key2:value2</span>, <span class="string">key3:value3</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩进写法</span></span><br><span class="line"><span class="attr">key:</span></span><br><span class="line">	<span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line">	<span class="attr">key2:</span> <span class="string">value2</span></span><br><span class="line">	<span class="attr">key3:</span> <span class="string">value3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>数组：一组按次序排列的值。如 array、list、queue。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 行内写法</span></span><br><span class="line"><span class="attr">key:</span> &#123;<span class="string">value1</span>, <span class="string">value2</span>, <span class="string">value3</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩进写法，一个-代表一个元素</span></span><br><span class="line"><span class="attr">key:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">value2</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">value3</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>示例：</p>
<ul>
<li><p>Person 和 Pet 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] interests;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; animal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; score;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;Double&gt; salarys;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;Pet&gt;&gt; allPets;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;pet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yaml 配置文件 (也可以命名为 application.yml)：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">boss:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">birth:</span> <span class="number">2019</span><span class="string">/12/12</span> <span class="number">20</span><span class="string">:12:33</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">  <span class="attr">pet:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">23.4</span></span><br><span class="line">  <span class="attr">interests:</span> [<span class="string">篮球</span>, <span class="string">游泳</span>]</span><br><span class="line">  <span class="attr">animal:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jerry</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">  <span class="attr">score:</span></span><br><span class="line">    <span class="attr">english:</span></span><br><span class="line">      <span class="attr">first:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">second:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">third:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">math:</span> [<span class="number">131</span>, <span class="number">140</span>, <span class="number">148</span>]</span><br><span class="line">    <span class="attr">chinese:</span> &#123;<span class="attr">first:</span> <span class="number">128</span>, <span class="attr">second:</span> <span class="number">136</span>&#125;</span><br><span class="line">  <span class="attr">salarys:</span> [<span class="number">3999</span>, <span class="number">4999.98</span>, <span class="number">5999.99</span>]</span><br><span class="line">  <span class="attr">allPets:</span></span><br><span class="line">    <span class="attr">sick:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tom1</span>, <span class="attr">weight:</span> <span class="number">33</span>&#125;</span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">jerry1</span>, <span class="attr">weight:</span> <span class="number">47</span>&#125;</span><br><span class="line">    <span class="attr">healthy:</span> [&#123;<span class="attr">name:</span> <span class="string">tom2</span>, <span class="attr">weight:</span> <span class="number">33</span>&#125;, &#123;<span class="attr">name:</span> <span class="string">jerry2</span>, <span class="attr">weight:</span> <span class="number">47</span>&#125;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在实际开发时，配置文件的写法方式，应该统一为行内写法，或者缩进写法，不要混写。</p>
</blockquote>
</li>
<li><p>Controller 测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/person&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210715155740364.png" alt="image-20210715155740364"></p>
<blockquote>
<p>可以看出，容器中的 Person 组件，就是按照 application.yaml 配置文件进行属性配置的。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring Boot 项目，可以同时存在 properties 和 yaml 两种配置文件，当二者包含相同属性的配置时，propertire 配置文件会覆盖 yaml 配置文件。</p>
<ul>
<li><p>application.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">person.user-name</span>=<span class="string">wangwu</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">zhangsan</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloworldApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext run = SpringApplication.run(HelloworldApplication.class, args);</span><br><span class="line">        Person person = run.getBean(<span class="string">&quot;person&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(person.getUserName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">    wangwu</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="配置提示"><a href="#配置提示" class="headerlink" title="配置提示"></a>配置提示</h4><ul>
<li><p>自定义的类和配置文件绑定一般没有提示，需要添加 <code>spring-boot-configuration-processor</code> 依赖，这样在配置文件书写时，会进行提示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210715164630655.png" alt="image-20210715164630655"></p>
<blockquote>
<p>user-name 与 userName 效果等同。</p>
</blockquote>
</li>
<li><p>因为 <code>spring-boot-configuration-processor</code> 依赖是开发过程中提供帮助，在打包程序时，应将其排除，不打包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 打包插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    		<span class="comment">&lt;!-- 打包时排除依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Web-开发"><a href="#Web-开发" class="headerlink" title="Web 开发"></a>Web 开发</h3><ul>
<li>参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-web-applications">https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-web-applications</a></li>
</ul>
<h4 id="Spring-MVC-自动配置概览"><a href="#Spring-MVC-自动配置概览" class="headerlink" title="Spring MVC 自动配置概览"></a>Spring MVC 自动配置概览</h4><ul>
<li><p>Spring Boot provides auto-configuration for Spring MVC that <strong>works well with most applications.</strong></p>
<ul>
<li>大多场景都无需自定义配置。</li>
</ul>
</li>
<li><p>The auto-configuration adds the following features on top of Spring’s defaults:</p>
<ul>
<li><p>Inclusion of <code>ContentNegotiatingViewResolver</code> and <code>BeanNameViewResolver</code> beans.</p>
<ul>
<li>内容协商视图解析器和 BeanName 视图解析器。</li>
</ul>
</li>
<li><p>Support for serving static resources, including support for WebJars (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-static-content">later in this document</a>)).</p>
<ul>
<li>静态资源 (包括 WebJars)。</li>
</ul>
</li>
<li><p>Automatic registration of <code>Converter</code>, <code>GenericConverter</code>, and <code>Formatter</code> beans.</p>
<ul>
<li>自动注册 <code>Converter</code>， <code>GenericConverter</code> 和 <code>Formatter</code>。</li>
</ul>
</li>
<li><p>Support for <code>HttpMessageConverters</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-message-converters">later in this document</a>).</p>
<ul>
<li>支持 <code>HttpMessageConverters</code>  (配合内容协商章节理解原理)。</li>
</ul>
</li>
<li><p>Automatic registration of <code>MessageCodesResolver</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-message-codes">later in this document</a>).</p>
<ul>
<li>自动注册 <code>MessageCodesResolver</code> (国际化用)。</li>
</ul>
</li>
<li><p>Static <code>index.html</code> support.</p>
<ul>
<li>静态 index.html 页支持。</li>
</ul>
</li>
<li><p>Custom <code>Favicon</code> support (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-favicon">later in this document</a>).</p>
<ul>
<li>自定义 <code>Favicon</code>。</li>
</ul>
</li>
<li><p>Automatic use of a <code>ConfigurableWebBindingInitializer</code> bean (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-web-binding-initializer">later in this document</a>).</p>
<ul>
<li>自动使用 <code>ConfigurableWebBindingInitializer</code>，(DataBinder 负责将请求数据绑定到 JavaBean 上)。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>If you want to keep those Spring Boot MVC customizations and make more <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/5.2.9.RELEASE/spring-framework-reference/web.html#mvc">MVC customizations</a> (interceptors, formatters, view controllers, and other features), you can add your own <code>@Configuration</code> class of type <code>WebMvcConfigurer</code> but <strong>without</strong> <code>@EnableWebMvc</code>.</p>
<ul>
<li>不用 <code>@EnableWebMvc</code> 注解，使用 <code>@Configuration</code> + WebMvcConfigurer 自定义规则。</li>
</ul>
</li>
<li><p>If you want to provide custom instances of <code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code>, or <code>ExceptionHandlerExceptionResolver</code>, and still keep the Spring Boot MVC customizations, you can declare a bean of type <code>WebMvcRegistrations</code> and use it to provide custom instances of those components.</p>
<ul>
<li>声明 WebMvcRegistrations 改变默认底层组件。</li>
</ul>
</li>
<li><p>If you want to take complete control of Spring MVC, you can add your own <code>@Configuration</code> annotated with <code>@EnableWebMvc</code>, or alternatively add your own <code>@Configuration</code>-annotated <code>DelegatingWebMvcConfiguration</code> as described in the Javadoc of <code>@EnableWebMvc</code>.</p>
<ul>
<li>使用 <code>@EnableWebMvc</code> + <code>@Configuration</code> + DelegatingWebMvcConfiguration 全面接管 Spring MVC。</li>
</ul>
</li>
</ul>
<h4 id="Spring-MVC-静态资源访问及原理"><a href="#Spring-MVC-静态资源访问及原理" class="headerlink" title="Spring MVC 静态资源访问及原理"></a>Spring MVC 静态资源访问及原理</h4><h5 id="静态资源访问"><a href="#静态资源访问" class="headerlink" title="静态资源访问"></a>静态资源访问</h5><ul>
<li><p>静态资源目录</p>
<ul>
<li><p>只要静态资源放在类路径下的 <code>/static</code> 或者 <code>/public</code> 或者 <code>/resources</code> 或者 <code>/META-INF/resources</code>，都可以访问。</p>
<p><img src="/2021/06/12/spring-boot/image-20210715172620534.png" alt="image-20210715172620534"></p>
</li>
<li><p>访问方式：<code>当前项目根路径 / + 静态资源名</code>。例如：<code>http://localhost:8080/spring1.jpg</code>。</p>
</li>
<li><p>原理：Spring Boot 静态资源访问映射 <code>/**</code>，即拦截所有的请求。当一个请求进来时，先去找 Controller 看能不能处理，不能处理的所有请求，都会交给静态资源处理器。如果静态资源也找不到，则响应 404 页面。</p>
<p><img src="/2021/06/12/spring-boot/image-20210716112544630.png" alt="image-20210716112544630"></p>
</li>
<li><p>改变静态资源默认的存储路径：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单个路径</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> <span class="string">classpath:images</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多个路径</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> [<span class="string">classpath:images</span>, <span class="string">classpath:statics</span>]</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210716115724190.png" alt="image-20210716115724190"></p>
<blockquote>
<p>静态资源都需要放在 application.yaml 配置文件里标明的路径下 (有时可能不生效，更改一下路径名，刷新几次)。</p>
<p>默认的那几个路径不再生效，默认路径如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;classpath:/META-INF/resources/&quot;</span>, <span class="string">&quot;classpath:/resources/&quot;</span>, <span class="string">&quot;classpath:/static/&quot;</span>, <span class="string">&quot;classpath:/public/&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
</li>
<li><p>静态资源访问前缀</p>
<ul>
<li><p>静态资源访问时，默认没有前缀。</p>
</li>
<li><p>改变静态资源的访问前缀：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/res/**</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再次访问静态资源时，都需要添加前缀。比如：<code>http://localhost:8080/res/spring.jpg</code>。</p>
</li>
</ul>
</li>
<li><p>webjar (了解)</p>
<ul>
<li><p>Spring 把常用的一些 js 打包成 jar 包，添加引用后即可使用。官方地址：<a target="_blank" rel="noopener" href="https://www.webjars.org/">https://www.webjars.org/</a></p>
<p><img src="/2021/06/12/spring-boot/image-20210716132425106.png" alt="image-20210716132425106"></p>
</li>
<li><p>例如，使用 jquery，Maven 引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210716133416070.png" alt="image-20210716133416070"></p>
</li>
<li><p>访问时，根据添加的 jquery 依赖的资源结构，确定访问地址：<code>http://localhost:8080/webjars/jquery/3.6.0/jquery.js</code>。</p>
<p><img src="/2021/06/12/spring-boot/image-20210716133549052.png" alt="image-20210716133549052"></p>
<blockquote>
<p>不同的 webjars，其访问地址可能不同，需要按照相应依赖里面的资源包路径确定。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h5 id="欢迎页支持"><a href="#欢迎页支持" class="headerlink" title="欢迎页支持"></a>欢迎页支持</h5><ul>
<li><p>Spring Boot supports both static and templated welcome pages. It first looks for an <code>index.html</code> file in the configured static content locations. If one is not found, it then looks for an <code>index</code> template. If either is found, it is automatically used as the welcome page of the application.</p>
<ul>
<li><p>Spring Boot 支持两种方式的欢迎页，一种是存放在静态资源存储路径下的 index.html，另一种是能处理动态请求 <code>/index</code> 的 Controller。</p>
</li>
<li><p>静态欢迎页：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 配置静态资源路径，会导致welcome page失效</span></span><br><span class="line">  <span class="comment">#  mvc:</span></span><br><span class="line">  <span class="comment">#    static-path-pattern: /res/**</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> [<span class="string">classpath:images</span>, <span class="string">classpath:statics</span>]</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210716150324478.png" alt="image-20210716150324478"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, Xisun!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210716150414792.png" alt="image-20210716150414792"></p>
</li>
<li><p>动态请求：<code>/index</code>，交由相应的 Controller 处理。</p>
</li>
</ul>
</li>
</ul>
<h5 id="静态资源配置原理"><a href="#静态资源配置原理" class="headerlink" title="静态资源配置原理"></a>静态资源配置原理</h5><ul>
<li><p>Spring Boot 在启动时，默认加载 xxxxxAutoConfiguration.class，即各种自动配置类。</p>
<ul>
<li>分析 Spring Boot 的某一项功能时，应该先查找其对应的自动配置类，从底层源码开始。</li>
</ul>
</li>
<li><p>与 Spring MVC 相关的自动配置类，是 <code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">      ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcAutoConfiguration</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>WebMvcAutoConfiguration 配置类中的 WebMvcAutoConfigurationAdapter 组件，对应了静态资源路径和访问前缀有关的规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Import(EnableWebMvcConfiguration.class)</span></span><br><span class="line"><span class="comment">// 开启WebMvcProperties、ResourceProperties和WebProperties类配置绑定功能，并注册到容器中</span></span><br><span class="line"><span class="comment">// 1.WebMvcProperties.class: spring.mvc</span></span><br><span class="line"><span class="comment">// 2.ResourceProperties.class: spring.resources</span></span><br><span class="line"><span class="comment">// 3.WebProperties.class: spring.web</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123; WebMvcProperties.class,</span></span><br><span class="line"><span class="meta">      org.springframework.boot.autoconfigure.web.ResourceProperties.class, WebProperties.class &#125;)</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcAutoConfigurationAdapter</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span>, <span class="title">ServletContextAware</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * WebMvcAutoConfigurationAdapter配置类只有一个有参构造器</span></span><br><span class="line"><span class="comment">    * 有参构造器所有参数的值都会从容器中确定</span></span><br><span class="line"><span class="comment">    * resourceProperties: 获取和spring.resources属性的所有值绑定的对象</span></span><br><span class="line"><span class="comment">    * webProperties: 获取和spring.web属性的所有值绑定的对象;</span></span><br><span class="line"><span class="comment">    * mvcProperties: 获取和spring.mvc属性的所有值绑定的对象;</span></span><br><span class="line"><span class="comment">    * beanFactory: Spring的beanFactory;</span></span><br><span class="line"><span class="comment">    * messageConvertersProvider: 找到所有的HttpMessageConverters;</span></span><br><span class="line"><span class="comment">    * resourceHandlerRegistrationCustomizerProvider: 找到资源处理器的自定义器</span></span><br><span class="line"><span class="comment">    * dispatcherServletPath: </span></span><br><span class="line"><span class="comment">    * servletRegistrations: 给应用注册Servlet、Filter....</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">WebMvcAutoConfigurationAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         org.springframework.boot.autoconfigure.web.ResourceProperties resourceProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">         WebProperties webProperties, WebMvcProperties mvcProperties, ListableBeanFactory beanFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">         ObjectProvider&lt;HttpMessageConverters&gt; messageConvertersProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">         ObjectProvider&lt;ResourceHandlerRegistrationCustomizer&gt; resourceHandlerRegistrationCustomizerProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">         ObjectProvider&lt;DispatcherServletPath&gt; dispatcherServletPath,</span></span></span><br><span class="line"><span class="function"><span class="params">         ObjectProvider&lt;ServletRegistrationBean&lt;?&gt;&gt; servletRegistrations)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.resourceProperties = resourceProperties.hasBeenCustomized() ? resourceProperties</span><br><span class="line">            : webProperties.getResources();</span><br><span class="line">      <span class="keyword">this</span>.mvcProperties = mvcProperties;</span><br><span class="line">      <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">      <span class="keyword">this</span>.messageConvertersProvider = messageConvertersProvider;</span><br><span class="line">      <span class="keyword">this</span>.resourceHandlerRegistrationCustomizer = resourceHandlerRegistrationCustomizerProvider.getIfAvailable();</span><br><span class="line">      <span class="keyword">this</span>.dispatcherServletPath = dispatcherServletPath;</span><br><span class="line">      <span class="keyword">this</span>.servletRegistrations = servletRegistrations;</span><br><span class="line">      <span class="keyword">this</span>.mvcProperties.checkConfiguration();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * webjars资源处理的默认规则</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;Default resource handling disabled&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// webjars: 映射规则是/webjars/**,资源路径是各jar包下的classpath:/META-INF/resources/webjars/</span></span><br><span class="line">      addResourceHandler(registry, <span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line">      <span class="comment">// this.mvcProperties.getStaticPathPattern(): 静态资源默认映射是/**</span></span><br><span class="line">      addResourceHandler(registry, <span class="keyword">this</span>.mvcProperties.getStaticPathPattern(), (registration) -&gt; &#123;</span><br><span class="line">         registration.addResourceLocations(<span class="keyword">this</span>.resourceProperties.getStaticLocations());</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ServletContextResource resource = <span class="keyword">new</span> ServletContextResource(<span class="keyword">this</span>.servletContext, SERVLET_LOCATION);</span><br><span class="line">            registration.addResourceLocations(resource);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(&quot;spring.web&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Resources</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 静态资源默认存储路径</span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; <span class="string">&quot;classpath:/META-INF/resources/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;classpath:/resources/&quot;</span>, <span class="string">&quot;classpath:/static/&quot;</span>, <span class="string">&quot;classpath:/public/&quot;</span> &#125;;</span><br><span class="line">       </span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Whether to enable default resource handling.</span></span><br><span class="line"><span class="comment">		* 通过设置spring.web.add-mappings: false, 能够禁用所有静态资源的规则, </span></span><br><span class="line"><span class="comment">		* 也就是说无论静态资源存放在哪，都无法访问，默认为true</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	  <span class="keyword">private</span> <span class="keyword">boolean</span> addMappings = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WebMvcAutoConfiguration 配置类中的 EnableWebMvcConfiguration 组件，对应了欢迎页的处理规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WebProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableWebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">DelegatingWebMvcConfiguration</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// HandlerMapping: 处理器映射,保存了每一个Handler能处理哪些请求.</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext,</span></span></span><br><span class="line"><span class="function"><span class="params">         FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> </span>&#123;</span><br><span class="line">      WelcomePageHandlerMapping welcomePageHandlerMapping = <span class="keyword">new</span> WelcomePageHandlerMapping(</span><br><span class="line">            <span class="keyword">new</span> TemplateAvailabilityProviders(applicationContext), applicationContext, getWelcomePage(),</span><br><span class="line">            <span class="keyword">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">      welcomePageHandlerMapping.setInterceptors(getInterceptors(mvcConversionService, mvcResourceUrlProvider));</span><br><span class="line">      welcomePageHandlerMapping.setCorsConfigurations(getCorsConfigurations());</span><br><span class="line">      <span class="keyword">return</span> welcomePageHandlerMapping;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WelcomePageHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractUrlHandlerMapping</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,</span><br><span class="line">         ApplicationContext applicationContext, Resource welcomePage, String staticPathPattern) &#123;</span><br><span class="line">      <span class="comment">// 如果使用欢迎页功能,默认映射是/**,访问index.html</span></span><br><span class="line">      <span class="keyword">if</span> (welcomePage != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;/**&quot;</span>.equals(staticPathPattern)) &#123;</span><br><span class="line">         logger.info(<span class="string">&quot;Adding welcome page: &quot;</span> + welcomePage);</span><br><span class="line">         setRootViewName(<span class="string">&quot;forward:index.html&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果上面的条件不满足,转为发送/index请求,查看Controller是否能匹配并处理</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (welcomeTemplateExists(templateAvailabilityProviders, applicationContext)) &#123;</span><br><span class="line">         logger.info(<span class="string">&quot;Adding welcome page template: index&quot;</span>);</span><br><span class="line">         setRootViewName(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="Spring-MVC-请求参数的处理"><a href="#Spring-MVC-请求参数的处理" class="headerlink" title="Spring MVC 请求参数的处理"></a>Spring MVC 请求参数的处理</h4><h5 id="请求映射"><a href="#请求映射" class="headerlink" title="请求映射"></a>请求映射</h5><ul>
<li><p>请求映射的方式</p>
<ul>
<li><p>常使用 <code>@RequestMapping</code> 注解声明请求映射。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Mapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RequestMapping &#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;path&quot;)</span></span><br><span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    String[] path() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    RequestMethod[] method() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] params() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] headers() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] consumes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] produces() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HellO, Spring Boot!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rest 风格支持：使用 HTTP 请求方式的动词来表示对资源的操作。</p>
<ul>
<li><p>以前：<code>/getUser</code> 表示获取用户请求，<code>/saveUser</code> 表示保存用户请求，<code>/editUser</code> 表示修改用户请求，<code>/deleteUser</code> 表示删除用户请求。</p>
</li>
<li><p>现在： <code>/user</code> 表示所有与 User 相关的请求，GET 请求表示获取用户，POST 请求表示保存用户，PUT 请求表示修改用户，DELETE 请求表示删除用户。</p>
</li>
<li><p>默认情况下，浏览器只发送 GET 和 POST 请求，不支持 PUT 和 DELETE 请求。如果要完成 Rest 风格的请求，需要在容器中配置一个 HiddenHttpMethodFilter 的组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiddenHttpMethodFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; ALLOWED_METHODS =</span><br><span class="line">         Collections.unmodifiableList(Arrays.asList(HttpMethod.PUT.name(),</span><br><span class="line">               HttpMethod.DELETE.name(), HttpMethod.PATCH.name()));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 表单提交时,添加一个隐藏的_method参数,该参数的值,作为最终的实际请求</span></span><br><span class="line">   <span class="comment">/** Default method parameter: &#123;<span class="doctag">@code</span> _method&#125;. */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_METHOD_PARAM = <span class="string">&quot;_method&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String methodParam = DEFAULT_METHOD_PARAM;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Set the parameter name to look for HTTP methods.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #DEFAULT_METHOD_PARAM</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMethodParam</span><span class="params">(String methodParam)</span> </span>&#123;</span><br><span class="line">      Assert.hasText(methodParam, <span class="string">&quot;&#x27;methodParam&#x27; must not be empty&quot;</span>);</span><br><span class="line">      <span class="keyword">this</span>.methodParam = methodParam;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 原生Request(POST请求)</span></span><br><span class="line">      HttpServletRequest requestToUse = request;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 原理: 发送的请求没有异常,且是POST请求时,会获取请求中的_method参数的值,并根据该值发送实际的请求</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equals(request.getMethod()) &amp;&amp; request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) == <span class="keyword">null</span>) &#123;</span><br><span class="line">         String paramValue = request.getParameter(<span class="keyword">this</span>.methodParam);</span><br><span class="line">         <span class="keyword">if</span> (StringUtils.hasLength(paramValue)) &#123;</span><br><span class="line">            String method = paramValue.toUpperCase(Locale.ENGLISH);</span><br><span class="line">            <span class="comment">// ALLOWED_METHODS: 兼容PUT、DELETE和PATCH请求</span></span><br><span class="line">            <span class="keyword">if</span> (ALLOWED_METHODS.contains(method)) &#123;</span><br><span class="line">               <span class="comment">// 创建了一个新的请求,作为最终实际的请求</span></span><br><span class="line">               <span class="comment">// 包装Request(根据_method参数的值,作为实际请求)</span></span><br><span class="line">               requestToUse = <span class="keyword">new</span> HttpMethodRequestWrapper(request, method);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      filterChain.doFilter(requestToUse, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Simple &#123;<span class="doctag">@link</span> HttpServletRequest&#125; wrapper that returns the supplied method for</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> HttpServletRequest#getMethod()&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpMethodRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> String method;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">HttpMethodRequestWrapper</span><span class="params">(HttpServletRequest request, String method)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(request);</span><br><span class="line">         <span class="keyword">this</span>.method = method;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.method;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>HiddenHttpMethodFilter 会拦截 POST 请求，并根据请求中的 _method 参数的值，发送实际的请求。</p>
</li>
<li><p>HiddenHttpMethodFilter 兼容 PUT、DELETE 和 PATCH 请求，也就是说，除了 GET 和 POST 请求，Rest 风格支持上述的三种请求。</p>
</li>
<li><p>Spring Boot 自动配置的 WebMvcAutoConfiguration 中，默认提供了一个 OrderedHiddenHttpMethodFilter，但 <code>spring.mvc.hiddenmethod.filter</code> 值默认为 false，也就是说，Spring Boot 默认不开启 Rest 风格支持。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">      ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcAutoConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title">hiddenHttpMethodFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> OrderedHiddenHttpMethodFilter();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderedHiddenHttpMethodFilter</span> <span class="keyword">extends</span> <span class="title">HiddenHttpMethodFilter</span> <span class="keyword">implements</span> <span class="title">OrderedFilter</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>配置类中手动开启 Rest 风格支持：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">hiddenmethod:</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>用法：表单 method 设置为 POST，添加隐藏域 _method，值按需求设置为 PUT 和 DELETE。如果本意是发送 POST 请求，则不需要 _method 属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, Xisun!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;RESET-GET 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;RESET-POST 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PUT&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;RESET-PUT 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DELETE&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;RESET-DELETE 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @RequestMapping(value = &quot;/user&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;GET-张三&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestMapping(value = &quot;/user&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;POST-张三&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestMapping(value = &quot;/user&quot;, method = RequestMethod.PUT)</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;PUT-张三&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestMapping(value = &quot;/user&quot;, method = RequestMethod.DELETE)</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DELETE-张三&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@GetMapping</code>、<code>@PostMapping</code>、<code>@PutMapping</code> 和 <code>@DeleteMapping</code> 四个派生注解，效果等同上面的写法。</p>
</blockquote>
</li>
<li><p>原理 (表单提交时的情况)：</p>
<ul>
<li>表单提交时，只有 GET 请求和 POST 请求两种方式。</li>
<li>表单提交会带上 _method 参数，比如 <code>_method=PUT</code>。</li>
<li>请求过来时，会被 HiddenHttpMethodFilter 拦截：<ul>
<li>判断请求是正常的，并且是 POST 请求；</li>
<li>获取到 _method 参数的值。<ul>
<li>兼容以下请求：PUT、DELETE 和 PATCH。</li>
</ul>
</li>
<li>将原生 Request (post 请求)，使用包装模式 requesWrapper，重写 <code>getMethod()</code>，返回传入的 _method 的值。</li>
<li>过滤器链放行的时候用 requesWrapper。后续的方法调用 <code>getMethod()</code> 时，调用的是 requesWrapper 重写后的方法。</li>
<li>经过以上过程，实现了表单提交时的 Rest 风格。</li>
</ul>
</li>
<li>如果使用客户端工具，比如 PostMan，会直接发送 PUT、DELETE 等方式的请求，无需使用 HiddenHttpMethodFilter。</li>
</ul>
</li>
<li><p>扩展：修改默认的 _method 参数名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title">hiddenHttpMethodFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> OrderedHiddenHttpMethodFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>根据 OrderedHiddenHttpMethodFilter 的条件性注解，可以看出，当容器内没有 HiddenHttpMethodFilter 组件时，会默认注册一个 OrderedHiddenHttpMethodFilter 组件，而 OrderedHiddenHttpMethodFilter 组件默认使用 _method 参数。因此，如果希望修改 _method 参数，可以自己自定义注册一个 HiddenHttpMethodFilter 组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HiddenHttpMethodFilter <span class="title">hiddenHttpMethodFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HiddenHttpMethodFilter hiddenHttpMethodFilter = <span class="keyword">new</span> HiddenHttpMethodFilter();</span><br><span class="line">        <span class="comment">// 修改默认的_method参数</span></span><br><span class="line">        hiddenHttpMethodFilter.setMethodParam(<span class="string">&quot;_real&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hiddenHttpMethodFilter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>请求映射的原理</p>
<ul>
<li><p>处理 Web 请求时，Spring Boot 底层使用的是 Spring MVC，当请求到达时，都会先经过 DispatcherServlet，这是 Web 请求的开始。</p>
</li>
<li><p>DispatcherServlet 的继承树结构 (<code>ctrl + H</code>)：</p>
<p><img src="/2021/06/12/spring-boot/image-20210717225144630.png" alt="image-20210717225144630"></p>
<ul>
<li><p>HttpServletBean：没有重写 HttpServlet 的 <code>doGet()</code> 和 <code>doPost()</code>，查看其子类。</p>
</li>
<li><p>FrameworkServlet：重写了 HttpServlet 的 <code>doGet()</code> 和 <code>doPost()</code>，以及其他方法。可以看出，都调用了 <code>processRequest()</code>，最终执行 <code>doService()</code>，这个方法在 FrameworkServlet 类中没有实现，查看其子类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   processRequest(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate POST requests to &#123;<span class="doctag">@link</span> #processRequest&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   processRequest(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate PUT requests to &#123;<span class="doctag">@link</span> #processRequest&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   processRequest(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Delegate DELETE requests to &#123;<span class="doctag">@link</span> #processRequest&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doService</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">   Throwable failureCause = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class="line">   LocaleContext localeContext = buildLocaleContext(request);</span><br><span class="line"></span><br><span class="line">   RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">   ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class="line"></span><br><span class="line">   WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">   asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), <span class="keyword">new</span> RequestBindingInterceptor());</span><br><span class="line"></span><br><span class="line">   initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 最终执行的方法</span></span><br><span class="line">      doService(request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ServletException | IOException ex) &#123;</span><br><span class="line">      failureCause = ex;</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      failureCause = ex;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NestedServletException(<span class="string">&quot;Request processing failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">      <span class="keyword">if</span> (requestAttributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">         requestAttributes.requestCompleted();</span><br><span class="line">      &#125;</span><br><span class="line">      logResult(request, response, failureCause, asyncManager);</span><br><span class="line">      publishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FrameworkServlet中没有实现doService(),查看其子类的实现</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DispatcherServlet：重写了 <code>doService()</code>，核心方法在于调用 <code>doDispatch()</code>，这个方法是处理 Web 请求的最终方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   logRequest(request);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Keep a snapshot of the request attributes in case of an include,</span></span><br><span class="line">   <span class="comment">// to be able to restore the original attributes after the include.</span></span><br><span class="line">   Map&lt;String, Object&gt; attributesSnapshot = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">      attributesSnapshot = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">      <span class="keyword">while</span> (attrNames.hasMoreElements()) &#123;</span><br><span class="line">         String attrName = (String) attrNames.nextElement();</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span>.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) &#123;</span><br><span class="line">            attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Make framework objects available to handlers and view objects.</span></span><br><span class="line">   request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">   request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.localeResolver);</span><br><span class="line">   request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="keyword">this</span>.themeResolver);</span><br><span class="line">   request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.flashMapManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">      FlashMap inputFlashMap = <span class="keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">      <span class="keyword">if</span> (inputFlashMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">         request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">      &#125;</span><br><span class="line">      request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="keyword">new</span> FlashMap());</span><br><span class="line">      request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="keyword">this</span>.flashMapManager);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   RequestPath previousRequestPath = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.parseRequestPath) &#123;</span><br><span class="line">      previousRequestPath = (RequestPath) request.getAttribute(ServletRequestPathUtils.PATH_ATTRIBUTE);</span><br><span class="line">      ServletRequestPathUtils.parseAndCache(request);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 核心方法</span></span><br><span class="line">      doDispatch(request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">         <span class="comment">// Restore the original attribute snapshot, in case of an include.</span></span><br><span class="line">         <span class="keyword">if</span> (attributesSnapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">            restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.parseRequestPath) &#123;</span><br><span class="line">         ServletRequestPathUtils.setParsedRequestPath(previousRequestPath, request);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   HttpServletRequest processedRequest = request;</span><br><span class="line">   HandlerExecutionChain mappedHandler = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">boolean</span> multipartRequestParsed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">   WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      ModelAndView mv = <span class="keyword">null</span>;</span><br><span class="line">      Exception dispatchException = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         processedRequest = checkMultipart(request);</span><br><span class="line">         multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Determine handler for the current request.</span></span><br><span class="line">         <span class="comment">// 找出当前请求使用哪个Handler处理,也就是Controller里的哪个方法</span></span><br><span class="line">         mappedHandler = getHandler(processedRequest);</span><br><span class="line">         <span class="keyword">if</span> (mappedHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            noHandlerFound(processedRequest, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Determine handler adapter for the current request.</span></span><br><span class="line">         HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Process last-modified header, if supported by the handler.</span></span><br><span class="line">         String method = request.getMethod();</span><br><span class="line">         <span class="keyword">boolean</span> isGet = HttpMethod.GET.matches(method);</span><br><span class="line">         <span class="keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;</span><br><span class="line">            <span class="keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Actually invoke the handler.</span></span><br><span class="line">         mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         applyDefaultViewName(processedRequest, mv);</span><br><span class="line">         mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         dispatchException = ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">         <span class="comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span></span><br><span class="line">         <span class="comment">// making them available for @ExceptionHandler methods and other scenarios.</span></span><br><span class="line">         dispatchException = <span class="keyword">new</span> NestedServletException(<span class="string">&quot;Handler dispatch failed&quot;</span>, err);</span><br><span class="line">      &#125;</span><br><span class="line">      processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable err) &#123;</span><br><span class="line">      triggerAfterCompletion(processedRequest, response, mappedHandler,</span><br><span class="line">            <span class="keyword">new</span> NestedServletException(<span class="string">&quot;Handler processing failed&quot;</span>, err));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">         <span class="comment">// Instead of postHandle and afterCompletion</span></span><br><span class="line">         <span class="keyword">if</span> (mappedHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Clean up any resources used by a multipart request.</span></span><br><span class="line">         <span class="keyword">if</span> (multipartRequestParsed) &#123;</span><br><span class="line">            cleanupMultipart(processedRequest);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>mappedHandler = getHandler(processedRequest);</code>：找出当前请求使用哪个 Handler 处理，也就是 Controller 里的哪个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 对每一个handlerMapping映射规则循环,以找到符合当前请求的映射</span></span><br><span class="line">      <span class="keyword">for</span> (HandlerMapping mapping : <span class="keyword">this</span>.handlerMappings) &#123;</span><br><span class="line">         HandlerExecutionChain handler = mapping.getHandler(request);</span><br><span class="line">         <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>processedRequest：当前的请求，包含了请求的路径。</p>
<p><img src="/2021/06/12/spring-boot/image-20210718132758156.png" alt="image-20210718132758156"></p>
</li>
<li><p>handlerMappings：处理器映射器，是对请求的处理规则。</p>
<p><img src="/2021/06/12/spring-boot/image-20210718133108782.png" alt="image-20210718133108782"></p>
<ul>
<li><p>不同的 HandlerMapping 会处理不同的请求，上图中的五个 HandlerMapping，对应不同的功能。</p>
<ul>
<li>此处先着重说明 RequestMappingHandlerMapping 和 WelcomePageHandlerMapping。</li>
</ul>
</li>
<li><p>请求进来时，会遍历尝试所有的 HandlerMapping，看其是否有符合的请求信息。</p>
<ul>
<li>如果有，就找到这个请求对应的 handler；</li>
<li>如果没有，就继续遍历下一个 HandlerMapping 查找。</li>
</ul>
</li>
<li><p><strong>RequestMappingHandlerMapping</strong>：</p>
<ul>
<li><p>保存了所有 <code>@RequestMapping</code> 注解对应的 handler 的映射规则。</p>
</li>
<li><p>在 Spring Boot 启动时，就会扫描所有包内 Controller 中的 <code>@RequestMapping</code> 注解，然后保存每一个注解中的规则。</p>
<p><img src="/2021/06/12/spring-boot/image-20210718140932222.png" alt="image-20210718140932222"></p>
</li>
<li><p>每一个映射规则，都有其所在的 Controller 和对应的方法：</p>
<p><img src="/2021/06/12/spring-boot/image-20210718141237274.png" alt="image-20210718141237274"></p>
</li>
<li><p>RequestMappingHandlerMapping 的依赖树：</p>
<p><img src="/2021/06/12/spring-boot/image-20210718142901281.png" alt="image-20210718142901281"></p>
</li>
<li><p>RequestMappingHandlerMapping 的 <code>getHandler()</code>：(Debug 模式下，F7 进入方法内部，查看方法的具体执行方，F8 则跳过当前方法，不查看细节)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMapping</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">HandlerMapping</span>, <span class="title">Ordered</span>, <span class="title">BeanNameAware</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">// 获取当前请求对应的handler!!!F7进入方法内部</span></span><br><span class="line">       Object handler = getHandlerInternal(request);</span><br><span class="line">        </span><br><span class="line">       <span class="comment">// 找到了handler之后,即可进行之后的业务功能、逻辑处理等操作</span></span><br><span class="line">       <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">          handler = getDefaultHandler();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Bean name or resolved handler?</span></span><br><span class="line">       <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">          String handlerName = (String) handler;</span><br><span class="line">          handler = obtainApplicationContext().getBean(handlerName);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Ensure presence of cached lookupPath for interceptors and others</span></span><br><span class="line">       <span class="keyword">if</span> (!ServletRequestPathUtils.hasCachedPath(request)) &#123;</span><br><span class="line">          initLookupPath(request);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       HandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">          logger.trace(<span class="string">&quot;Mapped to &quot;</span> + handler);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !DispatcherType.ASYNC.equals(request.getDispatcherType())) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Mapped to &quot;</span> + executionChain.getHandler());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (hasCorsConfigurationSource(handler) || CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">          CorsConfiguration config = getCorsConfiguration(handler, request);</span><br><span class="line">          <span class="keyword">if</span> (getCorsConfigurationSource() != <span class="keyword">null</span>) &#123;</span><br><span class="line">             CorsConfiguration globalConfig = getCorsConfigurationSource().getCorsConfiguration(request);</span><br><span class="line">             config = (globalConfig != <span class="keyword">null</span> ? globalConfig.combine(config) : config);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">             config.validateAllowCredentials();</span><br><span class="line">          &#125;</span><br><span class="line">          executionChain = getCorsHandlerExecutionChain(request, executionChain, config);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> executionChain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMappingInfoHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMethodMapping</span>&lt;<span class="title">RequestMappingInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       request.removeAttribute(PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 具体调用!!!F7进入方法内部</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">super</span>.getHandlerInternal(request);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">finally</span> &#123;</span><br><span class="line">          ProducesRequestCondition.clearMediaTypesAttribute(request);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMethodMapping</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Handler method lookup</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Look up a handler method for the given request.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 当前请求的路径,例如: /user</span></span><br><span class="line">      String lookupPath = initLookupPath(request);</span><br><span class="line">      <span class="comment">// 加锁</span></span><br><span class="line">      <span class="keyword">this</span>.mappingRegistry.acquireReadLock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// 查找当前请求的lookupPath路径,应该由哪个Handler处理!!!F7进入方法内部</span></span><br><span class="line">         HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);</span><br><span class="line">         <span class="keyword">return</span> (handlerMethod != <span class="keyword">null</span> ? handlerMethod.createWithResolvedBean() : <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">this</span>.mappingRegistry.releaseReadLock();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   List&lt;Match&gt; matches = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   <span class="comment">// 查找RequestMappingHandlerMapping中注册的所有能够处理lookupPath请求的Mapping,可能有多个</span></span><br><span class="line">   List&lt;T&gt; directPathMatches = <span class="keyword">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">   <span class="keyword">if</span> (directPathMatches != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 找到的Mapping,经过验证,找到最佳匹配的Mapping,然后添加到matches集合中</span></span><br><span class="line">      addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (matches.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// 如果没找到,做一些空值处理</span></span><br><span class="line">      addMatchingMappings(<span class="keyword">this</span>.mappingRegistry.getRegistrations().keySet(), matches, request);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!matches.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// 得到的最佳匹配的Mapping,正常情况下只能有一个</span></span><br><span class="line">      Match bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">      <span class="comment">// 同一个请求,如果有多个Mapping,会抛出异常</span></span><br><span class="line">      <span class="keyword">if</span> (matches.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">         Comparator&lt;Match&gt; comparator = <span class="keyword">new</span> MatchComparator(getMappingComparator(request));</span><br><span class="line">         matches.sort(comparator);</span><br><span class="line">         bestMatch = matches.get(<span class="number">0</span>);</span><br><span class="line">         <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(matches.size() + <span class="string">&quot; matching mappings: &quot;</span> + matches);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Match match : matches) &#123;</span><br><span class="line">               <span class="keyword">if</span> (match.hasCorsConfig()) &#123;</span><br><span class="line">                  <span class="keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">            Match secondBestMatch = matches.get(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="number">0</span>) &#123;</span><br><span class="line">               Method m1 = bestMatch.getHandlerMethod().getMethod();</span><br><span class="line">               Method m2 = secondBestMatch.getHandlerMethod().getMethod();</span><br><span class="line">               String uri = request.getRequestURI();</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                     <span class="string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="string">&quot;, &quot;</span> + m2 + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.getHandlerMethod());</span><br><span class="line">      handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">      <span class="comment">// 返回最佳匹配的结果,如下图所示,这个结果就是此次请求所对应的Mapping,以及所在的Controller和方法</span></span><br><span class="line">      <span class="keyword">return</span> bestMatch.getHandlerMethod();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> handleNoMatch(<span class="keyword">this</span>.mappingRegistry.getRegistrations().keySet(), lookupPath, request);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/12/spring-boot/image-20210718175748062.png" alt="image-20210718175748062"></p>
</li>
</ul>
</li>
<li><p>WelcomePageHandlerMapping：处理欢迎页的映射规则，访问 <code>/</code> 能访问到 index.html。</p>
<p><img src="/2021/06/12/spring-boot/image-20210718133924900.png" alt="image-20210718133924900"></p>
<p><img src="/2021/06/12/spring-boot/image-20210718134030643.png" alt="image-20210718134030643"></p>
</li>
<li><p>Spring Boot 在启动时，会在 WebMvcAutoConfiguration 配置类中注册 HandlerMapping：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">      ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@EnableConfigurationProperties(WebProperties.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableWebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title">DelegatingWebMvcConfiguration</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line">        <span class="comment">// RequestMappingHandlerMapping!!!</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@Primary</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> RequestMappingHandlerMapping <span class="title">requestMappingHandlerMapping</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="meta">@Qualifier(&quot;mvcContentNegotiationManager&quot;)</span> ContentNegotiationManager contentNegotiationManager,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="meta">@Qualifier(&quot;mvcConversionService&quot;)</span> FormattingConversionService conversionService,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="meta">@Qualifier(&quot;mvcResourceUrlProvider&quot;)</span> ResourceUrlProvider resourceUrlProvider)</span> </span>&#123;</span><br><span class="line">			<span class="comment">// Must be @Primary for MvcUriComponentsBuilder to work</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.requestMappingHandlerMapping(contentNegotiationManager, conversionService,</span><br><span class="line">					resourceUrlProvider);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// WelcomePageHandlerMapping!!!</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext,</span></span></span><br><span class="line"><span class="function"><span class="params">				FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> </span>&#123;</span><br><span class="line">			WelcomePageHandlerMapping welcomePageHandlerMapping = <span class="keyword">new</span> WelcomePageHandlerMapping(</span><br><span class="line">					<span class="keyword">new</span> TemplateAvailabilityProviders(applicationContext), applicationContext, getWelcomePage(),</span><br><span class="line">					<span class="keyword">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">			welcomePageHandlerMapping.setInterceptors(getInterceptors(mvcConversionService, mvcResourceUrlProvider));</span><br><span class="line">			welcomePageHandlerMapping.setCorsConfigurations(getCorsConfigurations());</span><br><span class="line">			<span class="keyword">return</span> welcomePageHandlerMapping;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要一些自定义的映射处理，我们也可以自己向容器中注册 HandlerMapping。</p>
<ul>
<li>自定义 HandlerMapping 的场合，比如：项目内包含一个系统的两个版本，v1 和 v2 版本调用不同的映射。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="普通参数与基本注解"><a href="#普通参数与基本注解" class="headerlink" title="普通参数与基本注解"></a>普通参数与基本注解</h5><ul>
<li><p>注解：</p>
<ul>
<li><p><code>@PathVariable</code>，<code>@RequestHeader</code>，<code>@RequestParam</code>，<code>@CookieValue</code></p>
<ul>
<li><p>Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 假设访问路径为: localhost:8080/car/3/owner/lisi?age=18&amp;interests=basketball&amp;interests=football</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 说明: 3这个位置为id,lisi这个位置为userName,?age=18&amp;interests=basketball&amp;interests=football为请求参数</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@PathVariable</span>注解:</span></span><br><span class="line"><span class="comment">     * 1.指定变量名时,可以获取访问路径中对应的变量值</span></span><br><span class="line"><span class="comment">     * 2.不指定变量名时,可以获取访问路径中所有的变量值,但必须是Map&lt;String, String&gt;格式</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@RequestHeader</span>注解:</span></span><br><span class="line"><span class="comment">     * 1.指定变量名时,可以获取请求头中指定的变量值</span></span><br><span class="line"><span class="comment">     * 2.不指定变量名时,可以获取请求头中所有的变量值,但必须是Map&lt;String, String&gt;格式</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@RequestParam</span>注解:</span></span><br><span class="line"><span class="comment">     * 1.指定变量名时,可以获取请求参数中指定的变量值</span></span><br><span class="line"><span class="comment">     * 2.不指定变量名时,可以获取请求参数中所有的变量值,但必须是Map&lt;String, String&gt;格式</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@CookieValue</span>注解:</span></span><br><span class="line"><span class="comment">     * 1.指定变量名时,可以获取Cookie中指定的变量值,也可以直接转换为Cookie对象</span></span><br><span class="line"><span class="comment">     * 2.注意: 如果请求中没有Cookie,使用<span class="doctag">@CookieValue</span>注解会报错</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/car/&#123;id&#125;/owner/&#123;userName&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getCar</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@PathVariable(&quot;userName&quot;)</span> String userName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@PathVariable</span> Map&lt;String, String&gt; paths,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@RequestHeader(&quot;User-Agent&quot;)</span> String userAgent,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@RequestHeader</span> Map&lt;String, String&gt; headers,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@RequestParam(&quot;age&quot;)</span> Integer age,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@RequestParam(&quot;interests&quot;)</span> List&lt;String&gt; interests,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="meta">@RequestParam</span> Map&lt;String, String&gt; params</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="comment">/*@CookieValue(&quot;_ga&quot;) String ga,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="comment">                                      @CookieValue(&quot;_ga&quot;) Cookie cookie*/</span>)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 存放请求中路径变量的值</span></span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        map.put(<span class="string">&quot;userName&quot;</span>, userName);</span><br><span class="line">        map.put(<span class="string">&quot;paths&quot;</span>, paths);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存放请求头中的值</span></span><br><span class="line">        map.put(<span class="string">&quot;userAgent&quot;</span>, userAgent);</span><br><span class="line">        map.put(<span class="string">&quot;headers&quot;</span>, headers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存放请求参数中的值</span></span><br><span class="line">        map.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">        map.put(<span class="string">&quot;interests&quot;</span>, interests);</span><br><span class="line">        map.put(<span class="string">&quot;params&quot;</span>, params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存放Cookie中的值</span></span><br><span class="line">        <span class="comment">/*map.put(&quot;_ga&quot;, ga);</span></span><br><span class="line"><span class="comment">        System.out.println(&quot;打印Cookie对象: &quot; + cookie);</span></span><br><span class="line"><span class="comment">        System.out.println(cookie.getName() + &quot; ------&gt; &quot; + cookie.getValue());*/</span></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
<p><img src="/2021/06/12/spring-boot/image-20210719155355517.png" alt="image-20210719155355517"></p>
<ul>
<li>细节：</li>
</ul>
<p><img src="/2021/06/12/spring-boot/image-20210719160053974.png" alt="image-20210719160053974"></p>
<p><img src="/2021/06/12/spring-boot/image-20210719155911239.png" alt="image-20210719155911239"></p>
</li>
</ul>
</li>
<li><p><code>@RequestBody</code></p>
<ul>
<li><p>index.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, Xisun!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/save&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span>&gt;</span></span><br><span class="line">    邮箱:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对于POST请求,可以使用<span class="doctag">@RequestBody</span>注解,获取表单提交中的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">postMethod</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;content&quot;</span>, content);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
<p><img src="/2021/06/12/spring-boot/image-20210719162448727.png" alt="image-20210719162448727"></p>
<p><img src="/2021/06/12/spring-boot/image-20210719163040040.png"></p>
<p><img src="/2021/06/12/spring-boot/image-20210719163217031.png" alt="image-20210719163217031"></p>
</li>
</ul>
</li>
<li><p><code>@RequestAttribute</code></p>
<ul>
<li><p>Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/goto&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">goToPage</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 收到/goto请求时,在请求中添加一个或多个属性,然后转发到/success请求</span></span><br><span class="line">        request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;go to success&quot;</span>);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;code&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;<span class="comment">// return &quot;/success&quot;;  这种方式也可以正常转发</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有两种方式获得Request中的属性值:</span></span><br><span class="line"><span class="comment">     * 方式一: 使用<span class="doctag">@RequestAttribute</span>注解,并指定需要获取的属性名</span></span><br><span class="line"><span class="comment">     * 方式二: 直接从Request对象中获得属性值</span></span><br><span class="line"><span class="comment">     * 注意: 直接访问/success请求会出异常,因为该请求中没有msg和code这两个属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">success</span><span class="params">(<span class="meta">@RequestAttribute(&quot;msg&quot;)</span> String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="meta">@RequestAttribute(&quot;code&quot;)</span> Integer code,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式一: 使用@RequestAttribute注解获取的Request中的属性值</span></span><br><span class="line">        map.put(<span class="string">&quot;annotationMsg&quot;</span>, msg);</span><br><span class="line">        map.put(<span class="string">&quot;annotationCode&quot;</span>, code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式二: 直接从Request对象中获得属性值</span></span><br><span class="line">        String reqMsg = (String) request.getAttribute(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;requestMsg&quot;</span>, reqMsg);</span><br><span class="line">        Integer reqCode = (Integer) request.getAttribute(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;requestCode&quot;</span>, reqCode);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
<p><img src="/2021/06/12/spring-boot/image-20210719170034261.png" alt="image-20210719170034261"></p>
<p><img src="/2021/06/12/spring-boot/image-20210719170135235.png" alt="image-20210719170135235"></p>
<p><img src="/2021/06/12/spring-boot/image-20210719170328498.png" alt="image-20210719170328498"></p>
</li>
</ul>
</li>
<li><p><code>@MatrixVariable</code>：矩阵变量注解，此处省略不谈。</p>
</li>
<li><p><code>@ModelAttribute</code>：此处省略不谈。</p>
</li>
</ul>
</li>
<li><p>s</p>
</li>
</ul>
<h3 id="数据访问"><a href="#数据访问" class="headerlink" title="数据访问"></a>数据访问</h3><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><h3 id="指标监控"><a href="#指标监控" class="headerlink" title="指标监控"></a>指标监控</h3><h3 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h3><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT">https://www.bilibili.com/video/BV19K4y1L7MT</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/atguigu/springboot">https://www.yuque.com/atguigu/springboot</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/17/docker-base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/17/docker-base/" class="post-title-link" itemprop="url">Docker 入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-17 10:30:51" itemprop="dateCreated datePublished" datetime="2021-05-17T10:30:51+08:00">2021-05-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-03 08:58:11" itemprop="dateModified" datetime="2022-01-03T08:58:11+08:00">2022-01-03</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>120k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:49</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Docker-简介"><a href="#Docker-简介" class="headerlink" title="Docker 简介"></a>Docker 简介</h2><h3 id="Docker-出现的背景"><a href="#Docker-出现的背景" class="headerlink" title="Docker 出现的背景"></a>Docker 出现的背景</h3><ul>
<li><p>一款产品从开发到上线，从操作系统，到运行环境，再到应用配置。作为开发 + 运维之间的协作我们需要关心很多东西，这也是很多互联网公司都不得不面对的问题，特别是各种版本的迭代之后，不同版本环境的兼容，对运维人员都是考验。</p>
</li>
<li><p>环境配置如此麻烦，换一台机器，就要重来一次，费力费时。很多人想到，能不能从根本上解决问题，软件可以带环境安装？也就是说，安装的时候，把原始环境一模一样地复制过来。</p>
</li>
<li><p>Docker 之所以发展如此迅速，也是因为它对此给出了一个标准化的解决方案。开发人员利用 Docker 可以消除协作编码时 “在我的机器上可正常工作” 的问题。</p>
</li>
<li><p>之前在服务器配置一个应用的运行环境，要安装各种软件。安装和配置这些东西有多麻烦就不说了，它还不能跨平台。假如我们是在 Windows 上安装的这些环境，到了 Linux 又得重新装。况且就算不跨操作系统，换另一台同样操作系统的服务器，要移植应用也是非常麻烦的。</p>
</li>
<li><p>传统上认为，软件编码开发/测试结束后，所产出的成果即是程序或是能够编译执行的二进制字节码等。而为了让这程序可以顺利执行，开发团队也得准备完整的部署文件，让运维团队得以部署应用程式，<strong>开发需要清楚的告诉运维部署团队，用的全部配置文件 + 所有软件环境。不过，即便如此，仍然常常发生部署失败的状况。</strong>Docker 镜像的设计<strong>，使得 Docker 得以打破过去「程序即应用」的观念。透过镜像 (images) 将作业系统核心除外，运作应用程式所需要的系统环境，由下而上打包，达到应用程式跨平台间的无缝接轨运作。</strong></p>
<p><img src="/2021/05/17/docker-base/image-20210517132812149.png" alt="image-20210517132812149"></p>
</li>
</ul>
<h3 id="Docker-的理念"><a href="#Docker-的理念" class="headerlink" title="Docker 的理念"></a>Docker 的理念</h3><ul>
<li>Docker 是基于 Go 语言实现的云开源项目。</li>
<li>Docker 的主要目标是 “<strong>Build, Ship and Run Any App, Anywhere</strong>“，也就是通过对应用组件的封装、分发、部署、运行等生命期的管理，使用户的 APP (可以是一个 WEB 应用或数据库应用等等) 及其运行环境能够做到 “<strong>一次封装，到处运行</strong>“。</li>
<li>Linux 容器技术的出现就解决了这样一个问题，而 Docker 就是在它的基础上发展过来的。将应用运行在 Docker 容器上面，而 Docker 容器在任何操作系统上都是一致的，这就实现了跨平台、跨服务器。<strong>只需要一次配置好环境，换到别的机子上就可以一键部署好，大大简化了操作。</strong></li>
<li>总之，Docker 是一个解决了运行环境和配置问题的软件容器，是方便做持续集成并有助于整体发布的容器虚拟化技术。</li>
</ul>
<h2 id="Docker-的基本组成"><a href="#Docker-的基本组成" class="headerlink" title="Docker 的基本组成"></a>Docker 的基本组成</h2><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><img src="/2021/05/17/docker-base/image-20210517153016458.png" alt="image-20210517153016458" style="zoom:80%;">

<h3 id="镜像-Image"><a href="#镜像-Image" class="headerlink" title="镜像 (Image)"></a>镜像 (Image)</h3><ul>
<li><p>Docker 镜像就是一个只读的模板。镜像可以用来创建 Docker 容器，一个镜像可以创建很多容器。</p>
</li>
<li><p>镜像与容器的关系类似于面向对象编程中的类与对象：</p>
<table>
<thead>
<tr>
<th>Docker</th>
<th>面向对象</th>
</tr>
</thead>
<tbody><tr>
<td>镜像</td>
<td>类</td>
</tr>
<tr>
<td>容器</td>
<td>对象</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="容器-Container"><a href="#容器-Container" class="headerlink" title="容器 (Container)"></a>容器 (Container)</h3><ul>
<li>Docker 利用容器独立运行一个或一组应用。<strong>容器是用镜像创建的运行实例。</strong></li>
<li>容器可以被启动、开始、停止、删除。每个容器都是相互隔离的、保证安全的平台。</li>
<li><strong>容器可以看做是一个简易版的 Linux 环境 (包括 root 用户权限、进程空间、用户空间和网络空间等) 和运行在其中的应用程序。</strong></li>
<li>容器的定义和镜像几乎一模一样，也是一堆层的统一视角， 唯一区别在于容器的最上面那一层是可读可写的。</li>
</ul>
<h3 id="仓库-Repository"><a href="#仓库-Repository" class="headerlink" title="仓库 (Repository)"></a>仓库 (Repository)</h3><ul>
<li>仓库是<strong>集中存放镜像</strong>文件的场所。</li>
<li>仓库和仓库注册服务器 (Registry) 是有区别的。仓库注册服务器上往往存放着多个仓库，每个仓库中又包含了多镜像，每个镜像有不同的标签 (tag) 。</li>
<li>仓库分为公开仓库 (Public) 和私有仓库 (Private) 两种形式。</li>
<li><strong>最大的公开仓库是 Docker Hub</strong> ( <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a> )，存放了数量庞大的镜像供用户下载。国内的公开仓库包括<strong>阿里云</strong>、网易云等。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Docker本身是一个容器运行载体或称之为管理引擎。我们把应用程序和配置依赖打包好形成一个可交付的运行环境，这个打包好的运行环境就是 image 镜像文件。只有通过这个镜像文件才能生成 Docker 容器。image 文件可以看作是容器的模板。Docker 根据 image 文件生成容器的实例。同一个 image 文件，可以生成多个同时运行的容器实例。</li>
<li>image 文件生成的容器实例，本身也是一个文件，称为镜像文件。</li>
<li>一个容器运行一种服务，当我们需要的时候，就可以通过 Docker 客户端创建一个对应的运行实例，也就是我们的容器。</li>
<li>至于仓储，就是放了一堆镜像的地方，我们可以把镜像发布到仓储中，需要的时候从仓储中拉下来就可以了。</li>
</ul>
<h3 id="底层原理"><a href="#底层原理" class="headerlink" title="底层原理"></a>底层原理</h3><h4 id="Docker-是怎样工作的"><a href="#Docker-是怎样工作的" class="headerlink" title="Docker 是怎样工作的"></a>Docker 是怎样工作的</h4><ul>
<li><p>Docker 是一个 Client-Server 结构的系统，Docker 守护进程运行在主机上，然后通过 Socket 连接从客户端访问，守护进程从客户端接受命令并管理运行在主机上的容器。<strong>容器，是一个运行时环境，就是我们前面说到的集装箱。</strong></p>
<img src="/2021/05/17/docker-base/image-20210518115953156.png" alt="image-20210518115953156" style="zoom:80%;">

</li>
</ul>
<h4 id="Docker-为什么比-VM-快"><a href="#Docker-为什么比-VM-快" class="headerlink" title="Docker 为什么比 VM 快"></a>Docker 为什么比 VM 快</h4><ul>
<li><p>Docker 有着比虚拟机更少的抽象层。由于 Docker 不需要 <strong>Hypervisor</strong> 实现硬件资源虚拟化，运行在 Docker 容器上的程序直接使用的都是实际物理机的硬件资源。因此在 CPU、内存利用率上，Docker 将会在效率上有明显优势。</p>
</li>
<li><p>Docker 利用的是宿主机的内核，而不需要 <strong>Guest OS</strong>。因此，当新建一个容器时，Docker 不需要和虚拟机一样重新加载一个操作系统内核，因此可以避免引寻、加载操作系统内核这个比较费时费资源的过程，当新建一个虚拟机时，虚拟机软件需要加载 Guest OS，这个新建过程是分钟级别的。而 Docker 由于直接利用宿主机的操作系统，则省略了返个过程，因此新建一个 Docker 容器只需要几秒钟。</p>
<p><img src="/2021/05/17/docker-base/image-20210518164632786.png" alt="image-20210518164632786"></p>
<img src="/2021/05/17/docker-base/image-20210518164700236.png" alt="image-20210518164700236" style="zoom:80%;">

</li>
</ul>
<h2 id="Docker-安装"><a href="#Docker-安装" class="headerlink" title="Docker 安装"></a>Docker 安装</h2><ul>
<li>官网：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></li>
<li>Linux 安装：<a target="_blank" rel="noopener" href="https://hub.docker.com/search?q=&amp;type=edition&amp;offering=community&amp;operating_system=linux">https://hub.docker.com/search?q=&amp;type=edition&amp;offering=community&amp;operating_system=linux</a></li>
</ul>
<h3 id="WSL-安装"><a href="#WSL-安装" class="headerlink" title="WSL 安装"></a>WSL 安装</h3><ul>
<li><p>默认已经安装 WSL。</p>
</li>
<li><p>默认安装的 WSL version 是 1，在 Windows PowerShell 中查看：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Xisun\Desktop&gt; wsl -<span class="literal">-list</span> <span class="literal">-v</span></span><br><span class="line">  NAME      STATE           VERSION</span><br><span class="line">* Ubuntu    Running         <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Windows PowerShell 中，切换 WSL version 为 2：</p>
<ul>
<li><p>启用 Hyper-V 功能：</p>
<p><img src="/2021/05/17/docker-base/image-20210607214517890.png" alt="image-20210607214517890"></p>
<blockquote>
<p>启用 Hyper-V 功能后，需要重启电脑。</p>
</blockquote>
</li>
<li><p>再按以下步骤依次执行：</p>
<img src="/2021/05/17/docker-base/image-20210608092639524.png" alt="image-20210608092639524" style="zoom:80%;">

<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">https://docs.microsoft.com/en-us/windows/wsl/install-win10</a></p>
</blockquote>
</li>
<li><p>切换 version：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl -<span class="literal">-set</span><span class="literal">-version</span> &lt;distribution name&gt; &lt;versionNumber&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Xisun\Desktop&gt; wsl -<span class="literal">-set</span><span class="literal">-version</span> Ubuntu <span class="number">2</span></span><br><span class="line">正在进行转换，这可能需要几分钟时间...</span><br><span class="line">有关与 WSL <span class="number">2</span> 的主要区别的信息，请访问 https://aka.ms/wsl2</span><br><span class="line">转换完成。</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Xisun\Desktop&gt; wsl -<span class="literal">-list</span> <span class="literal">-v</span></span><br><span class="line">  NAME      STATE           VERSION</span><br><span class="line">* Ubuntu    Running         <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>WSL 默认不支持 Docker，需要破解：</p>
<ul>
<li><p>破解步骤：</p>
<p><img src="/2021/05/17/docker-base/image-20210609105236382.png" alt="image-20210609105236382"></p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/arkane-systems/genie">https://github.com/arkane-systems/genie</a></p>
</blockquote>
</li>
<li><p>以管理员身份打开 Windows PowerShell：<code>win + x</code> 快捷键，然后执行命令 <code>wsl</code>，进入 WSL 控制台，并切换到 root 用户：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\WINDOWS\system32&gt; wsl</span><br><span class="line">xisun@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/WINDOWS/system32<span class="variable">$</span> su root</span><br><span class="line">Password:</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/WINDOWS/system32<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果忘记 root 用户密码，可以如下方式重置：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.以管理员身份打开Windows PowerShell;</span><br><span class="line"><span class="number">2</span>.输入命令: wsl.exe -<span class="literal">-user</span> root;</span><br><span class="line"><span class="number">3</span>.输入命令: passwd root, 修改root用户密码。</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装 dotnet：</p>
<ul>
<li><p>查看 Ubuntu 版本：</p>
<ul>
<li><p>方式一：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># cat /proc/version</span></span><br><span class="line">Linux version <span class="number">5.4</span>.<span class="number">72</span><span class="literal">-microsoft</span><span class="literal">-standard</span><span class="literal">-WSL2</span> (oe<span class="literal">-user</span>@oe<span class="literal">-host</span>) (gcc version <span class="number">8.2</span>.<span class="number">0</span> (GCC)) <span class="comment">#1 SMP Wed Oct 28 23:40:43 UTC 2020</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># lsb_release -a</span></span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu <span class="number">20.04</span>.<span class="number">2</span> LTS</span><br><span class="line">Release:        <span class="number">20.04</span></span><br><span class="line">Codename:       focal</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210609113128182.png" alt="image-20210609113128182"></p>
</li>
<li><p>查看内核版本号：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># uname -r</span></span><br><span class="line"><span class="number">5.4</span>.<span class="number">72</span><span class="literal">-microsoft</span><span class="literal">-standard</span><span class="literal">-WSL2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>安装对应版本的 dotnet：</p>
<p><img src="/2021/05/17/docker-base/image-20210608214208564.png" alt="image-20210608214208564"></p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-ubuntu">https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-ubuntu</a></p>
</blockquote>
<ul>
<li><p>将 Microsoft 包签名密钥添加到受信任密钥列表，并添加包存储库。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wget</span> https://packages.microsoft.com/config/ubuntu/<span class="number">20.04</span>/packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb <span class="literal">-O</span> packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb</span><br><span class="line">sudo dpkg <span class="literal">-i</span> packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb</span></span><br><span class="line">o dpkg <span class="literal">-i</span> packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb-<span class="literal">-2021</span><span class="literal">-06</span><span class="literal">-08</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">31</span>--  https://packages.microsoft.com/config/ubuntu/<span class="number">20.04</span>/packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb</span><br><span class="line">Resolving packages.microsoft.com (packages.microsoft.com)... <span class="number">65.52</span>.<span class="number">183.205</span></span><br><span class="line">Connecting to packages.microsoft.com (packages.microsoft.com)|<span class="number">65.52</span>.<span class="number">183.205</span>|:<span class="number">443</span>... connected.</span><br><span class="line">HTTP request sent, awaiting response... <span class="number">200</span> OK</span><br><span class="line">Length: <span class="number">3124</span> (<span class="number">3.1</span>K) [<span class="type">application</span>/<span class="type">octet</span>-<span class="type">stream</span>]</span><br><span class="line">Saving to: ‘packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb’</span><br><span class="line"></span><br><span class="line">packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb   <span class="number">100</span>%[=================================================&gt;]   <span class="number">3.05</span>K  --.<span class="literal">-KB</span>/s    <span class="keyword">in</span> <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-08</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">32</span> (<span class="number">523</span> MB/s) - ‘packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb’ saved [<span class="number">3124</span>/<span class="number">3124</span>]</span><br><span class="line"></span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># sudo dpkg -i packages-microsoft-prod.deb</span></span><br><span class="line">Selecting previously unselected package packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.</span><br><span class="line">(Reading database ... <span class="number">47281</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack packages<span class="literal">-microsoft</span><span class="literal">-prod</span>.deb ...</span><br><span class="line">Unpacking packages<span class="literal">-microsoft</span><span class="literal">-prod</span> (<span class="number">1.0</span><span class="literal">-ubuntu20</span>.<span class="number">04.1</span>) ...</span><br><span class="line">Setting up packages<span class="literal">-microsoft</span><span class="literal">-prod</span> (<span class="number">1.0</span><span class="literal">-ubuntu20</span>.<span class="number">04.1</span>) ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 SDK：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt<span class="literal">-get</span> update; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> apt<span class="literal">-transport</span><span class="literal">-https</span> &amp;&amp; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> update &amp;&amp; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># sudo apt-get update; \</span></span><br><span class="line">&gt;   sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> apt<span class="literal">-transport</span><span class="literal">-https</span> &amp;&amp; \</span><br><span class="line">&gt;   sudo apt<span class="literal">-get</span> update &amp;&amp; \</span><br><span class="line">&gt;   sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span></span><br><span class="line">Get:<span class="number">1</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal InRelease [<span class="number">10.5</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">2</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 Packages [<span class="number">74.9</span> <span class="type">kB</span>]</span><br><span class="line">Hit:<span class="number">3</span> http://archive.ubuntu.com/ubuntu focal InRelease</span><br><span class="line">Get:<span class="number">4</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span> InRelease [<span class="number">114</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">5</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span> InRelease [<span class="number">114</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">6</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/main amd64 Packages [<span class="number">702</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">7</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-backports</span> InRelease [<span class="number">101</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">8</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/main Translation<span class="literal">-en</span> [<span class="number">141</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">9</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 Packages [<span class="number">1026</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">10</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/main amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">7780</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">11</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/restricted amd64 Packages [<span class="number">247</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">12</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/restricted Translation<span class="literal">-en</span> [<span class="number">36.1</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">13</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/restricted amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">456</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">14</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/universe amd64 Packages [<span class="number">588</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">15</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/universe Translation<span class="literal">-en</span> [<span class="number">94.6</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">16</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/universe amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">11.5</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">17</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/multiverse amd64 Packages [<span class="number">19.9</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">18</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/multiverse Translation<span class="literal">-en</span> [<span class="number">4316</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">19</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span>/multiverse amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">528</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">20</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main Translation<span class="literal">-en</span> [<span class="number">229</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">21</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">13.5</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">22</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/restricted amd64 Packages [<span class="number">266</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">23</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/restricted Translation<span class="literal">-en</span> [<span class="number">38.9</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">24</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/restricted amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">456</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">25</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/universe amd64 Packages [<span class="number">781</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">26</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/universe Translation<span class="literal">-en</span> [<span class="number">170</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">27</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/universe amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">17.6</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">28</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/multiverse amd64 Packages [<span class="number">23.6</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">29</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/multiverse Translation<span class="literal">-en</span> [<span class="number">6376</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">30</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/multiverse amd64 c<span class="literal">-n</span><span class="operator">-f</span> Metadata [<span class="number">648</span> <span class="type">B</span>]</span><br><span class="line">Fetched <span class="number">4840</span> kB <span class="keyword">in</span> <span class="number">4</span>s (<span class="number">1125</span> kB/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  apt<span class="literal">-transport</span><span class="literal">-https</span></span><br><span class="line"><span class="number">0</span> upgraded, <span class="number">1</span> newly installed, <span class="number">0</span> to remove and <span class="number">101</span> not upgraded.</span><br><span class="line">Need to get <span class="number">1704</span> B of archives.</span><br><span class="line">After this operation, <span class="number">161</span> kB of additional disk space will be used.</span><br><span class="line">Get:<span class="number">1</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/universe amd64 apt<span class="literal">-transport</span><span class="literal">-https</span> all <span class="number">2.0</span>.<span class="number">5</span> [<span class="number">1704</span> <span class="type">B</span>]</span><br><span class="line">Fetched <span class="number">1704</span> B <span class="keyword">in</span> <span class="number">0</span>s (<span class="number">3469</span> B/s)</span><br><span class="line">Selecting previously unselected package apt<span class="literal">-transport</span><span class="literal">-https</span>.</span><br><span class="line">(Reading database ... <span class="number">47289</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../apt<span class="literal">-transport</span><span class="literal">-https_2</span>.<span class="number">0.5</span>_all.deb ...</span><br><span class="line">Unpacking apt<span class="literal">-transport</span><span class="literal">-https</span> (<span class="number">2.0</span>.<span class="number">5</span>) ...</span><br><span class="line">Setting up apt<span class="literal">-transport</span><span class="literal">-https</span> (<span class="number">2.0</span>.<span class="number">5</span>) ...</span><br><span class="line">Hit:<span class="number">1</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal InRelease</span><br><span class="line">Hit:<span class="number">2</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span> InRelease</span><br><span class="line">Hit:<span class="number">3</span> http://archive.ubuntu.com/ubuntu focal InRelease</span><br><span class="line">Hit:<span class="number">4</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span> InRelease</span><br><span class="line">Hit:<span class="number">5</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-backports</span> InRelease</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-host</span> dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span></span><br><span class="line">  dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span></span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-host</span> dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span></span><br><span class="line">  dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span> dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span></span><br><span class="line"><span class="number">0</span> upgraded, <span class="number">10</span> newly installed, <span class="number">0</span> to remove and <span class="number">101</span> not upgraded.</span><br><span class="line">Need to get <span class="number">95.1</span> MB of archives.</span><br><span class="line">After this operation, <span class="number">396</span> MB of additional disk space will be used.</span><br><span class="line">Get:<span class="number">1</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">2642</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">2</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-host</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">52.5</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">3</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">140</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">4</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">22.1</span> <span class="type">MB</span>]</span><br><span class="line">Get:<span class="number">5</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">6086</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">6</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span> [<span class="number">2086</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">7</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span> [<span class="number">1316</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">8</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span> [<span class="number">3412</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">9</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span> amd64 <span class="number">2.1</span>.<span class="number">0</span><span class="literal">-1</span> [<span class="number">1476</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">10</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal/main amd64 dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span> amd64 <span class="number">5.0</span>.<span class="number">300</span><span class="literal">-1</span> [<span class="number">58.4</span> <span class="type">MB</span>]</span><br><span class="line">Fetched <span class="number">95.1</span> MB <span class="keyword">in</span> <span class="number">1</span>min <span class="number">11</span>s (<span class="number">1332</span> kB/s)</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">(Reading database ... <span class="number">47293</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../<span class="number">0</span><span class="literal">-dotnet</span><span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-host</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">1</span><span class="literal">-dotnet</span><span class="literal">-host_5</span>.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-host</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">2</span><span class="literal">-dotnet</span><span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">3</span><span class="literal">-dotnet</span><span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">4</span><span class="literal">-aspnetcore</span><span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">5</span><span class="literal">-dotnet</span><span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.0</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">6</span><span class="literal">-aspnetcore</span><span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.0</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">7</span><span class="literal">-dotnet</span><span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.6</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">8</span><span class="literal">-netstandard</span><span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span>_2.<span class="number">1.0</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span> (<span class="number">2.1</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span>.</span><br><span class="line">Preparing to unpack .../<span class="number">9</span><span class="literal">-dotnet</span><span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span>_5.<span class="number">0.300</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">300</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-host</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-runtime</span><span class="literal">-deps</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up netstandard<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-2</span>.<span class="number">1</span> (<span class="number">2.1</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-hostfxr</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-apphost</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up aspnetcore<span class="literal">-targeting</span><span class="literal">-pack</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">0</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">6</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up dotnet<span class="literal">-sdk</span><span class="literal">-5</span>.<span class="number">0</span> (<span class="number">5.0</span>.<span class="number">300</span><span class="literal">-1</span>) ...</span><br><span class="line">This software may collect information about you and your use of the software, and send that to Microsoft.</span><br><span class="line">Please visit http://aka.ms/dotnet<span class="literal">-cli</span><span class="literal">-eula</span> <span class="keyword">for</span> more information.</span><br><span class="line">Welcome to .NET!</span><br><span class="line">---------------------</span><br><span class="line">Learn more about .NET: https://aka.ms/dotnet<span class="literal">-docs</span></span><br><span class="line">Use <span class="string">&#x27;dotnet --help&#x27;</span> to see available commands or visit: https://aka.ms/dotnet<span class="literal">-cli</span><span class="literal">-docs</span></span><br><span class="line"></span><br><span class="line">Telemetry</span><br><span class="line">---------</span><br><span class="line">The .NET tools collect usage <span class="keyword">data</span> <span class="keyword">in</span> order to help us improve your experience. It is collected by Microsoft and shared with the community. You can opt<span class="literal">-out</span> of telemetry by setting the DOTNET_CLI_TELEMETRY_OPTOUT environment variable to <span class="string">&#x27;1&#x27;</span> or <span class="string">&#x27;true&#x27;</span> <span class="keyword">using</span> your favorite shell.</span><br><span class="line"></span><br><span class="line">Read more about .NET <span class="built_in">CLI</span> Tools telemetry: https://aka.ms/dotnet<span class="literal">-cli</span><span class="literal">-telemetry</span></span><br><span class="line"></span><br><span class="line">Configuring...</span><br><span class="line">--------------</span><br><span class="line">A command is running to populate your local package cache to improve restore speed and enable offline access. This command takes up to one minute to complete and only runs once.</span><br><span class="line">Processing triggers <span class="keyword">for</span> <span class="built_in">man</span><span class="literal">-db</span> (<span class="number">2.9</span>.<span class="number">1</span><span class="literal">-1</span>) ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装运行时：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt<span class="literal">-get</span> update; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> apt<span class="literal">-transport</span><span class="literal">-https</span> &amp;&amp; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> update &amp;&amp; \</span><br><span class="line">  sudo apt<span class="literal">-get</span> install <span class="literal">-y</span> aspnetcore<span class="literal">-runtime</span><span class="literal">-5</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>dotnet-sdk-5.0 安装成功后，会一起安装 aspnetcore-runtime-5.0。</p>
</blockquote>
</li>
<li><p>检查 dotnet 版本：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># dotnet</span></span><br><span class="line"></span><br><span class="line">Usage: dotnet [<span class="type">options</span>]</span><br><span class="line">Usage: dotnet [<span class="type">path</span>-<span class="type">to</span>-<span class="type">application</span>]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  <span class="literal">-h</span>|-<span class="literal">-help</span>         Display help.</span><br><span class="line">  -<span class="literal">-info</span>            Display .NET information.</span><br><span class="line">  -<span class="literal">-list</span><span class="literal">-sdks</span>       Display the installed SDKs.</span><br><span class="line">  -<span class="literal">-list</span><span class="literal">-runtimes</span>   Display the installed runtimes.</span><br><span class="line"></span><br><span class="line">path<span class="literal">-to</span><span class="literal">-application</span>:</span><br><span class="line">  The path to an application .dll file to execute.</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># dotnet --list-sdks</span></span><br><span class="line"><span class="number">5.0</span>.<span class="number">300</span> [/<span class="type">usr</span>/<span class="type">share</span>/<span class="type">dotnet</span>/<span class="type">sdk</span>]</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/WINDOWS/system32<span class="comment"># dotnet --list-runtimes</span></span><br><span class="line">Microsoft.AspNetCore.App <span class="number">5.0</span>.<span class="number">6</span> [/<span class="type">home</span>/<span class="type">xisun</span>/<span class="type">.dotnet</span>/<span class="type">shared</span>/<span class="type">Microsoft.AspNetCore.App</span>]</span><br><span class="line">Microsoft.NETCore.App <span class="number">5.0</span>.<span class="number">6</span> [/<span class="type">home</span>/<span class="type">xisun</span>/<span class="type">.dotnet</span>/<span class="type">shared</span>/<span class="type">Microsoft.NETCore.App</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>安装 wsl-translinux：</p>
<p><img src="/2021/05/17/docker-base/image-20210609105418915.png" alt="image-20210609105418915"></p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://arkane-systems.github.io/wsl-transdebian/">https://arkane-systems.github.io/wsl-transdebian/</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apt install apt<span class="literal">-transport</span><span class="literal">-https</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wget</span> <span class="literal">-O</span> /etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/wsl<span class="literal">-transdebian</span>.gpg</span><br><span class="line"></span><br><span class="line">chmod a+<span class="built_in">r</span> /etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; EOF &gt; /etc/apt/sources.list.d/wsl<span class="literal">-transdebian</span>.list</span><br><span class="line">deb https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">deb<span class="literal">-src</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># apt install apt-transport-https</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">wget</span> <span class="literal">-O</span> /etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/wsl<span class="literal">-transdebian</span>.gpg</span><br><span class="line"></span><br><span class="line">chmod a+<span class="built_in">r</span> /etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; EOF &gt; /etc/apt/sources.list.d/wsl<span class="literal">-transdebian</span>.list</span><br><span class="line">deb https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">deb<span class="literal">-src</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">apt<span class="literal">-transport</span><span class="literal">-https</span> is already the newest version (<span class="number">2.0</span>.<span class="number">5</span>).</span><br><span class="line"><span class="number">0</span> upgraded, <span class="number">0</span> newly installed, <span class="number">0</span> to remove and <span class="number">101</span> not upgraded.</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># wget -O /etc/apt/trusted.gpg.d/wsl-transdebian.gpg https://arkane-systems.github.io/wsl-transdebian/apt/wsl-transdebian.gpg</span></span><br><span class="line">-<span class="literal">-2021</span><span class="literal">-06</span><span class="literal">-08</span> <span class="number">21</span>:<span class="number">23</span>:<span class="number">47</span>--  https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/wsl<span class="literal">-transdebian</span>.gpg</span><br><span class="line">Resolving arkane<span class="literal">-systems</span>.github.io (arkane<span class="literal">-systems</span>.github.io)... <span class="number">185.199</span>.<span class="number">109.153</span>, <span class="number">185.199</span>.<span class="number">108.153</span>, <span class="number">185.199</span>.<span class="number">110.153</span>, ...</span><br><span class="line">Connecting to arkane<span class="literal">-systems</span>.github.io (arkane<span class="literal">-systems</span>.github.io)|<span class="number">185.199</span>.<span class="number">109.153</span>|:<span class="number">443</span>... connected.</span><br><span class="line">HTTP request sent, awaiting response... <span class="number">200</span> OK</span><br><span class="line">Length: <span class="number">2280</span> (<span class="number">2.2</span>K) [<span class="type">application</span>/<span class="type">octet</span>-<span class="type">stream</span>]</span><br><span class="line">Saving to: ‘/etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg’</span><br><span class="line"></span><br><span class="line">/etc/apt/trusted.gpg.d/wsl<span class="literal">-tr</span> <span class="number">100</span>%[=================================================&gt;]   <span class="number">2.23</span>K  --.<span class="literal">-KB</span>/s    <span class="keyword">in</span> <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-08</span> <span class="number">21</span>:<span class="number">23</span>:<span class="number">49</span> (<span class="number">36.1</span> MB/s) - ‘/etc/apt/trusted.gpg.d/wsl<span class="literal">-transdebian</span>.gpg’ saved [<span class="number">2280</span>/<span class="number">2280</span>]</span><br><span class="line"></span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># chmod a+r /etc/apt/trusted.gpg.d/wsl-transdebian.gpg</span></span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># cat &lt;&lt; EOF &gt; /etc/apt/sources.list.d/wsl-transdebian.list</span></span><br><span class="line">&gt; deb https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">&gt; deb<span class="literal">-src</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt/ <span class="variable">$</span>(lsb_release <span class="literal">-cs</span>) main</span><br><span class="line">&gt; EOF</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># apt update</span></span><br><span class="line">Hit:<span class="number">1</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal InRelease</span><br><span class="line">Hit:<span class="number">2</span> http://archive.ubuntu.com/ubuntu focal InRelease</span><br><span class="line">Hit:<span class="number">3</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span> InRelease</span><br><span class="line">Hit:<span class="number">4</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span> InRelease</span><br><span class="line">Get:<span class="number">5</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt focal InRelease [<span class="number">2495</span> <span class="type">B</span>]</span><br><span class="line">Hit:<span class="number">6</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-backports</span> InRelease</span><br><span class="line">Get:<span class="number">7</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt focal/main Sources [<span class="number">1338</span> <span class="type">B</span>]</span><br><span class="line">Get:<span class="number">8</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt focal/main amd64 Packages [<span class="number">1897</span> <span class="type">B</span>]</span><br><span class="line">Fetched <span class="number">5730</span> B <span class="keyword">in</span> <span class="number">2</span>s (<span class="number">3130</span> B/s)</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line"><span class="number">101</span> packages can be upgraded. Run <span class="string">&#x27;apt list --upgradable&#x27;</span> to see them.</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 genie：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install <span class="literal">-y</span> systemd<span class="literal">-genie</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># sudo apt update</span></span><br><span class="line">Hit:<span class="number">1</span> https://packages.microsoft.com/ubuntu/<span class="number">20.04</span>/prod focal InRelease</span><br><span class="line">Hit:<span class="number">2</span> http://security.ubuntu.com/ubuntu focal<span class="literal">-security</span> InRelease</span><br><span class="line">Hit:<span class="number">3</span> http://archive.ubuntu.com/ubuntu focal InRelease</span><br><span class="line">Hit:<span class="number">4</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span> InRelease</span><br><span class="line">Hit:<span class="number">5</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt focal InRelease</span><br><span class="line">Hit:<span class="number">6</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-backports</span> InRelease</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line"><span class="number">101</span> packages can be upgraded. Run <span class="string">&#x27;apt list --upgradable&#x27;</span> to see them.</span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># sudo apt install -y systemd-genie</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">The following additional packages will be installed:</span><br><span class="line">  daemonize libnss<span class="literal">-mymachines</span> libnss<span class="literal">-systemd</span> libpam<span class="literal">-systemd</span> libsystemd0 systemd systemd<span class="literal">-container</span> systemd<span class="literal">-sysv</span></span><br><span class="line">  systemd<span class="literal">-timesyncd</span></span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  daemonize libnss<span class="literal">-mymachines</span> systemd<span class="literal">-container</span> systemd<span class="literal">-genie</span></span><br><span class="line">The following packages will be upgraded:</span><br><span class="line">  libnss<span class="literal">-systemd</span> libpam<span class="literal">-systemd</span> libsystemd0 systemd systemd<span class="literal">-sysv</span> systemd<span class="literal">-timesyncd</span></span><br><span class="line"><span class="number">6</span> upgraded, <span class="number">4</span> newly installed, <span class="number">0</span> to remove and <span class="number">95</span> not upgraded.</span><br><span class="line">Need to get <span class="number">5359</span> kB of archives.</span><br><span class="line">After this operation, <span class="number">3892</span> kB of additional disk space will be used.</span><br><span class="line">Get:<span class="number">1</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 libnss<span class="literal">-systemd</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">95.8</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">2</span> https://arkane<span class="literal">-systems</span>.github.io/wsl<span class="literal">-transdebian</span>/apt focal/main amd64 systemd<span class="literal">-genie</span> amd64 <span class="number">1.42</span> [<span class="number">504</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">3</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 systemd<span class="literal">-timesyncd</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">28.1</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">4</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 systemd<span class="literal">-sysv</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">10.3</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">5</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 libpam<span class="literal">-systemd</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">186</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">6</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 systemd amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">3805</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">7</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 libsystemd0 amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">269</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">8</span> http://archive.ubuntu.com/ubuntu focal/universe amd64 daemonize amd64 <span class="number">1.7</span>.<span class="number">8</span><span class="literal">-1</span> [<span class="number">11.9</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">9</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 systemd<span class="literal">-container</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">317</span> <span class="type">kB</span>]</span><br><span class="line">Get:<span class="number">10</span> http://archive.ubuntu.com/ubuntu focal<span class="literal">-updates</span>/main amd64 libnss<span class="literal">-mymachines</span> amd64 <span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span> [<span class="number">131</span> <span class="type">kB</span>]</span><br><span class="line">Fetched <span class="number">5359</span> kB <span class="keyword">in</span> <span class="number">5</span>s (<span class="number">1137</span> kB/s)</span><br><span class="line">(Reading database ... <span class="number">50558</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../<span class="number">0</span><span class="literal">-libnss</span><span class="literal">-systemd_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking libnss<span class="literal">-systemd</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Preparing to unpack .../<span class="number">1</span><span class="literal">-systemd</span><span class="literal">-timesyncd_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking systemd<span class="literal">-timesyncd</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Preparing to unpack .../<span class="number">2</span><span class="literal">-systemd</span><span class="literal">-sysv_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking systemd<span class="literal">-sysv</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Preparing to unpack .../<span class="number">3</span><span class="literal">-libpam</span><span class="literal">-systemd_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking libpam<span class="literal">-systemd</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Preparing to unpack .../<span class="number">4</span><span class="literal">-systemd_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking systemd (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Preparing to unpack .../<span class="number">5</span><span class="literal">-libsystemd0_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking libsystemd0:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) over (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">4</span>) ...</span><br><span class="line">Setting up libsystemd0:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Selecting previously unselected package daemonize.</span><br><span class="line">(Reading database ... <span class="number">50558</span> files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../daemonize_1.<span class="number">7.8</span><span class="literal">-1_amd64</span>.deb ...</span><br><span class="line">Unpacking daemonize (<span class="number">1.7</span>.<span class="number">8</span><span class="literal">-1</span>) ...</span><br><span class="line">Selecting previously unselected package systemd<span class="literal">-container</span>.</span><br><span class="line">Preparing to unpack .../systemd<span class="literal">-container_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking systemd<span class="literal">-container</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Selecting previously unselected package systemd<span class="literal">-genie</span>.</span><br><span class="line">Preparing to unpack .../systemd<span class="literal">-genie_1</span>.<span class="number">42</span>_amd64.deb ...</span><br><span class="line">Unpacking systemd<span class="literal">-genie</span> (<span class="number">1.42</span>) ...</span><br><span class="line">Selecting previously unselected package libnss<span class="literal">-mymachines</span>:amd64.</span><br><span class="line">Preparing to unpack .../libnss<span class="literal">-mymachines_245</span>.<span class="number">4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>_amd64.deb ...</span><br><span class="line">Unpacking libnss<span class="literal">-mymachines</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Setting up daemonize (<span class="number">1.7</span>.<span class="number">8</span><span class="literal">-1</span>) ...</span><br><span class="line">Setting up systemd (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Initializing machine ID from random generator.</span><br><span class="line">Setting up systemd<span class="literal">-timesyncd</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Setting up systemd<span class="literal">-container</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Created symlink /etc/systemd/system/multi<span class="literal">-user</span>.target.wants/machines.target → /lib/systemd/system/machines.target.</span><br><span class="line">Setting up systemd<span class="literal">-sysv</span> (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Setting up systemd<span class="literal">-genie</span> (<span class="number">1.42</span>) ...</span><br><span class="line">Created symlink /etc/systemd/system/sockets.target.wants/wslg<span class="literal">-xwayland</span>.socket → /lib/systemd/system/wslg<span class="literal">-xwayland</span>.socket.</span><br><span class="line">Setting up libnss<span class="literal">-systemd</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Setting up libnss<span class="literal">-mymachines</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">First installation detected...</span><br><span class="line">Checking NSS setup...</span><br><span class="line">Setting up libpam<span class="literal">-systemd</span>:amd64 (<span class="number">245.4</span><span class="literal">-4ubuntu3</span>.<span class="number">6</span>) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc<span class="literal">-bin</span> (<span class="number">2.31</span><span class="literal">-0ubuntu9</span>.<span class="number">2</span>) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> <span class="built_in">man</span><span class="literal">-db</span> (<span class="number">2.9</span>.<span class="number">1</span><span class="literal">-1</span>) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> dbus (<span class="number">1.12</span>.<span class="number">16</span><span class="literal">-2ubuntu2</span>.<span class="number">1</span>) ...</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>破解完成之后，即可在 WSL 中安装 Docker (利用脚本安装)：</p>
<p><img src="/2021/05/17/docker-base/image-20210610215004640.png" alt="image-20210610215004640"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">curl</span> <span class="literal">-fsSL</span> https://get.docker.com <span class="literal">-o</span> <span class="built_in">get-docker</span>.sh</span><br><span class="line">sh <span class="built_in">get-docker</span>.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># curl -fsSL https://get.docker.com -o get-docker.sh</span></span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># sh get-docker.sh</span></span><br><span class="line"><span class="comment"># Executing docker install script, commit: 7cae5f8b0decc17d6571f9f52eb840fbc13b2737</span></span><br><span class="line"></span><br><span class="line">WSL DETECTED: We recommend <span class="keyword">using</span> Docker Desktop for Windows.</span><br><span class="line">Please get Docker Desktop from https://www.docker.com/products/docker<span class="literal">-desktop</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You may press Ctrl+C now to abort this script.</span><br><span class="line">+ <span class="built_in">sleep</span> <span class="number">20</span></span><br><span class="line">+ sh <span class="literal">-c</span> apt<span class="literal">-get</span> update <span class="literal">-qq</span> &gt;/dev/null</span><br><span class="line">+ sh <span class="literal">-c</span> DEBIAN_FRONTEND=noninteractive apt<span class="literal">-get</span> install <span class="literal">-y</span> <span class="literal">-qq</span> apt<span class="literal">-transport</span><span class="literal">-https</span> ca<span class="literal">-certificates</span> <span class="built_in">curl</span> &gt;/dev/null</span><br><span class="line">+ sh <span class="literal">-c</span> <span class="built_in">curl</span> <span class="literal">-fsSL</span> <span class="string">&quot;https://download.docker.com/linux/ubuntu/gpg&quot;</span> | apt<span class="literal">-key</span> add <span class="literal">-qq</span> - &gt;/dev/null</span><br><span class="line">Warning: apt<span class="literal">-key</span> output should not be parsed (stdout is not a terminal)</span><br><span class="line">+ sh <span class="literal">-c</span> <span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable&quot;</span> &gt; /etc/apt/sources.list.d/docker.l</span><br><span class="line">ist</span><br><span class="line">+ sh <span class="literal">-c</span> apt<span class="literal">-get</span> update <span class="literal">-qq</span> &gt;/dev/null</span><br><span class="line">+ [ -<span class="type">n</span>  ]</span><br><span class="line">+ sh <span class="literal">-c</span> apt<span class="literal">-get</span> install <span class="literal">-y</span> <span class="literal">-qq</span> -<span class="literal">-no</span><span class="literal">-install</span><span class="literal">-recommends</span> docker<span class="literal">-ce</span> &gt;/dev/null</span><br><span class="line">+ [ -<span class="type">n</span> <span class="number">1</span> ]</span><br><span class="line">+ sh <span class="literal">-c</span> DEBIAN_FRONTEND=noninteractive apt<span class="literal">-get</span> install <span class="literal">-y</span> <span class="literal">-qq</span> docker<span class="literal">-ce</span><span class="literal">-rootless</span><span class="literal">-extras</span> &gt;/dev/null</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line"></span><br><span class="line">To run Docker as a non<span class="literal">-privileged</span> user, consider setting up the</span><br><span class="line">Docker daemon <span class="keyword">in</span> rootless mode <span class="keyword">for</span> your user:</span><br><span class="line"></span><br><span class="line">    dockerd<span class="literal">-rootless</span><span class="literal">-setuptool</span>.sh install</span><br><span class="line"></span><br><span class="line">Visit https://docs.docker.com/go/rootless/ to learn about rootless mode.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To run the Docker daemon as a fully privileged service, but granting non<span class="literal">-root</span></span><br><span class="line">users access, refer to https://docs.docker.com/go/daemon<span class="literal">-access</span>/</span><br><span class="line"></span><br><span class="line">WARNING: Access to the remote API on a privileged Docker daemon is equivalent</span><br><span class="line">         to root access on the host. Refer to the <span class="string">&#x27;Docker daemon attack surface&#x27;</span></span><br><span class="line">         documentation <span class="keyword">for</span> details: https://docs.docker.com/go/attack<span class="literal">-surface</span>/</span><br><span class="line"></span><br><span class="line">================================================================================</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/docker/docker-install">https://github.com/docker/docker-install</a></p>
</blockquote>
</li>
<li><p>Docker 安装成功后，启动 Docker 服务：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/WINDOWS/system32<span class="comment"># service docker start</span></span><br><span class="line"> * Starting Docker: docker                                                                               [ <span class="type">OK</span> ]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Docker 服务如果没有启动，执行 Docker 的命令时，会提示：<code>Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</code>。</p>
<p>Docker 服务启动后，如果不手动关闭，会一直运行，即使关闭 Windows PowerShell 也不会关闭。</p>
<p>如果关闭电脑，需要重启 Docker 服务。</p>
</blockquote>
</li>
<li><p>查看 Docker version：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/WINDOWS/system32<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           <span class="number">20.10</span>.<span class="number">6</span></span><br><span class="line"> API version:       <span class="number">1.41</span></span><br><span class="line"> Go version:        go1.<span class="number">13.15</span></span><br><span class="line"> Git commit:        <span class="number">370</span>c289</span><br><span class="line"> Built:             Fri Apr  <span class="number">9</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">17</span> <span class="number">2021</span></span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line"> Experimental:      true</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          <span class="number">20.10</span>.<span class="number">7</span></span><br><span class="line">  API version:      <span class="number">1.41</span> (minimum version <span class="number">1.12</span>)</span><br><span class="line">  Go version:       go1.<span class="number">13.15</span></span><br><span class="line">  Git commit:       b0f5bc3</span><br><span class="line">  Built:            Wed Jun  <span class="number">2</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">50</span> <span class="number">2021</span></span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"> containerd:</span><br><span class="line">  Version:          <span class="number">1.4</span>.<span class="number">6</span></span><br><span class="line">  GitCommit:        d71fcd7d8303cbf684402823e425e9dd2e99285d</span><br><span class="line"> runc:</span><br><span class="line">  Version:          <span class="number">1.0</span>.<span class="number">0</span><span class="literal">-rc95</span></span><br><span class="line">  GitCommit:        b9ee9c6314599f1b4a7f497e1f1f856fe433d3b7</span><br><span class="line"> docker<span class="literal">-init</span>:</span><br><span class="line">  Version:          <span class="number">0.19</span>.<span class="number">0</span></span><br><span class="line">  GitCommit:        de40ad0</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试 Docker，运行 hello-world：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># docker run hello-world</span></span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/hello<span class="literal">-world</span></span><br><span class="line">b8dfde127a29: Pull complete</span><br><span class="line">Digest: sha256:<span class="number">9</span>f6ad537c5132bcce57f7a0a20e317228d382c3cd61edae14650eec68b2b345c</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello<span class="literal">-world</span>:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> <span class="number">1</span>. The Docker client contacted the Docker daemon.</span><br><span class="line"> <span class="number">2</span>. The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> <span class="number">3</span>. The Docker daemon created a new container from that image which runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> <span class="number">4</span>. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To <span class="keyword">try</span> something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> <span class="variable">$</span> docker run <span class="literal">-it</span> ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/<span class="built_in">get-started</span>/</span><br><span class="line"></span><br><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Windows/system32<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello<span class="literal">-world</span>   latest    d1165f221234   <span class="number">3</span> months ago   <span class="number">13.3</span>kB</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭 Docker 服务：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP<span class="literal">-OJKMETJ</span>:/mnt/c/Users/Ziyoo<span class="comment"># service docker stop</span></span><br><span class="line"> * Stopping Docker: docker                                                                               [ <span class="type">OK</span> ]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动和关闭 Docker 服务时，必须使用 root 用户。</p>
</blockquote>
</li>
</ul>
<h3 id="Ubuntu-安装"><a href="#Ubuntu-安装" class="headerlink" title="Ubuntu 安装"></a>Ubuntu 安装</h3><ul>
<li><p>参考：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
</li>
<li><p>按照官网指示一步步执行，即可安装 Docker。主要涉及如下命令，各命令的含义参考官网：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get remove docker docker-engine docker.io containerd runc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install apt-transport-https \</span></span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line">    </span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \</span></span><br><span class="line">	sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> \</span></span><br><span class="line">  &quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span><br><span class="line"><span class="meta">  $</span><span class="bash">(lsb_release -cs) stable<span class="string">&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install docker-ce docker-ce-cli containerd.io</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上命令默认安装的为 Docker 最新版本，若需要安装特定版本，请参考官网。</p>
</blockquote>
</li>
</ul>
<h2 id="Docker-常用命令"><a href="#Docker-常用命令" class="headerlink" title="Docker 常用命令"></a>Docker 常用命令</h2><h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker version</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker info</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker --<span class="built_in">help</span></span></span><br></pre></td></tr></table></figure>

<h3 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h3><ul>
<li><p><strong>列出本机上的镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker images [OPTIONS]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>OPTIONS 说明：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-a 列出本地所有的镜像(含中间映射层)</span><br><span class="line">-q 只显示镜像ID</span><br><span class="line">--digests 显示镜像的摘要信息</span><br><span class="line">--no-trunc 显示完整的镜像信息</span><br></pre></td></tr></table></figure>

</li>
</ul>
<img src="/2021/05/17/docker-base/image-20210518170502255.png" alt="image-20210518170502255" style="zoom:80%;">
</li>
<li><p><strong>查询某个镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker search [OPTIONS] 镜像名字</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>OPTIONS 说明：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--no-trunc 显示完整的镜像描述</span><br><span class="line">-s 列出收藏数不小于指定值的镜像</span><br><span class="line">--automated 只列出 automated build类型的镜像</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>官方镜像仓库：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
</blockquote>
</li>
<li><p><strong>下载镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull 镜像名字[:TAG]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>一般设置从阿里云镜像下载。</p>
<p><code>docker pull tomcat</code> 等价于 <code>docker pull tomcat:latest</code>，即默认下载最新版本。</p>
</blockquote>
</li>
<li><p><strong>删除镜像</strong></p>
<ul>
<li><p>删除单个镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rmi -f 镜像名[:TAG]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除多个镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rmi -f 镜像名1[:TAG] 镜像名2[:TAG] 镜像名3[:TAG] ...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除全部镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rmi -f $(docker images -qa)</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h3><ul>
<li><p>有镜像才能创建容器，这是根本前提。先下载一个 CentOS 镜像作为示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull centos</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>新建并启动容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run [OPTIONS] IMAGE [COMMAND][ARG]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>OPTIONS 说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--name 为容器指定一个名称，若不指定，由系统随机分配</span><br><span class="line">-d 后台运行容器，并返回容器ID，即启动守护式容器</span><br><span class="line">-i 以交互模式运行容器，通常与-t同时使用</span><br><span class="line">-t 为容器重新分配一个伪输入终端，通常与-i同时使用</span><br><span class="line">-P 随机端口映射</span><br><span class="line">-p 指定端口映射，有以下四种格式：</span><br><span class="line">	ip:hostPort:containerPort</span><br><span class="line">	ip::containerPort</span><br><span class="line">	hostPort:containerPort</span><br><span class="line">	containerPort</span><br></pre></td></tr></table></figure>

</li>
</ul>
<img src="/2021/05/17/docker-base/image-20210519144837032.png" alt="image-20210519144837032">

<blockquote>
<p><strong>此时启动的是一个交互式的容器。</strong></p>
</blockquote>
</li>
<li><p><strong>列出当前所有正在运行的容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps [OPTIONS]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>OPTIONS 说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-a 列出当前所有正在运行的容器+历史上运行过的</span><br><span class="line">-| 显示最近创建的容器</span><br><span class="line">-n 显示最近n个创建的容器</span><br><span class="line">-q 静默模式，只显示容器编号</span><br><span class="line">--no-trunc 不截断输出</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>退出容器</strong></p>
<ul>
<li>方式一，停止容器并退出：<code>exit</code>。</li>
<li>方式二，不停止容器退出：<code>ctrl + P + Q</code>。</li>
</ul>
</li>
<li><p><strong>启动容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker start 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>重启容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker restart 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>停止容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker stop 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>强制停止容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">kill</span> 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>删除已停止的容器</strong></p>
<ul>
<li><p>普通删除：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rm 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>强制删除：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rm -f 容器ID或容器名</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>-f 可以删除没有停止的容器。</p>
</blockquote>
</li>
<li><p>删除多个：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rm -f $(docker ps -aq)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps -aq | xargs docker rm</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>启动守护式容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d IMAGE</span></span><br></pre></td></tr></table></figure>

<ul>
<li>例如，以后台模式启动一个 CentOS，<code>docker run -d centos</code>，然后 <code>docker ps -a</code> 进行查看，<strong>会发现容器已经退出。</strong></li>
<li><strong>Docker 容器若要后台运行，就必须有一个前台进程。</strong></li>
</ul>
</li>
<li><p><strong>查看容器日志</strong></p>
<ul>
<li><p>启动一个一直运行的守护式容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d centos /bin/sh -c <span class="string">&quot;while true; do echo hello xisun; sleep 2; done&quot;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看该容器的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker logs [OPTIONS] 容器ID或容器名</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>OPTION 说明：</p>
<figure class="highlight do"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-t 添加时间戳</span><br><span class="line"></span><br><span class="line">-f 跟随最新的日志打印</span><br><span class="line"></span><br><span class="line">--tail number 显示最后number条</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>查看容器内运行的进程</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker top 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查看容器内部的细节</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker inspect 容器ID或容器名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>进入正在运行的容器并以命令行交互</strong></p>
<ul>
<li><p>方式一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker attach 容器ID或容器名</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>直接进入容器启动命令的终端，不会启动新的进程。</strong>然后在该容器的终端内，执行相应的命令。</p>
</blockquote>
</li>
<li><p>方式二：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -t 容器ID或容器名 ls -l /tmp</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>在容器中打开新的终端，并且可以启动新的进程。</strong>然后执行后续的命令，并将结果显示在当前窗口。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -t 容器ID或容器名 /bin/bash</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>与方式一等效。</p>
</blockquote>
<img src="/2021/05/17/docker-base/image-20210520094656346.png" alt="image-20210520094656346" style="zoom:80%;">

</li>
</ul>
<blockquote>
<p>针对执行 <code>ctrl + P + Q</code> 命令退出的容器。</p>
</blockquote>
</li>
<li><p><strong>从容器内拷贝文件到主机上</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker cp 容器ID或容器名:容器内路径 目的主机路径</span></span><br></pre></td></tr></table></figure>

<img src="/2021/05/17/docker-base/image-20210520102210176.png" alt="image-20210520102210176" style="zoom:80%;">

</li>
</ul>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><img src="/2021/05/17/docker-base/image-20210520102432819.png" alt="image-20210520102432819" style="zoom:80%;">

<img src="/2021/05/17/docker-base/20201003133051.png" alt="20201003133051" style="zoom:80%;">

<h2 id="Docker-镜像"><a href="#Docker-镜像" class="headerlink" title="Docker 镜像"></a>Docker 镜像</h2><ul>
<li>镜像是一种轻量级、可执行的独立软件包，用来打包软件运行环境和基于运行环境开发的软件，它包含运行某个软件所需的有内容，包括代码、运行时、库、环境变量和配置文件。</li>
</ul>
<h3 id="UnionFS-联合文件系统"><a href="#UnionFS-联合文件系统" class="headerlink" title="UnionFS (联合文件系统)"></a>UnionFS (联合文件系统)</h3><ul>
<li>UnionFS 是一种分层、轻量级并且高性能的文件系统，它支持<strong>对文件系统的修作为一次提交来一层层的叠加</strong>，同时可以将不同目录挂载到同一个虚拟文件系统下 (unite several directories into a single virtual file system)。</li>
<li><strong>UnionFS 是 Docker 镜像的基础。</strong>镜像可以通过分层来进行继承，基于基础镜像 (没有父镜像)，可以制作各种具体的应用镜像。</li>
<li>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</li>
</ul>
<h3 id="Docker-镜像加载原理"><a href="#Docker-镜像加载原理" class="headerlink" title="Docker 镜像加载原理"></a>Docker 镜像加载原理</h3><ul>
<li><p>Docker 的镜像实际上是由一层一层的文件系统组成，这种层级的文件系统即为 UnionFS。主要包含两个部分：</p>
<img src="/2021/05/17/docker-base/image-20210520113123426.png" alt="image-20210520113123426" style="zoom:80%;">

<ul>
<li><strong>bootfs (boot file system)：</strong>主要包含 bootloader 和 kernel，bootloader 主要是引导加载 kernel，Linux 刚启动时会加载bootfs文件系统。bootfs 是 Docker 镜像的最底层，这一层与我们典型的 Linux/Unix 系统是一样的，包含 boot 加载器和内核。当 boot 加载完成之后整个内核就都在内存中了，此时内存的使用权由 bootfs 转交给内核，系统也会卸载 bootfs。</li>
<li><strong>rootfs (root file system)：</strong>在 bootfs 之上。包含的就是典型 Linux 系统中的 /dev， /proc，/bin，/etc 等标准目录和文件。rootfs 就是各种不同的操作系统发行版，比如 Ubuntu，CentOS 等等。</li>
</ul>
</li>
<li><p>对于一个精简的 OS，rootfs 可以很小，只需要包括最基本的命令、工具和程序库就可以了，因为底层直接用 Host (宿主机) 的 kernel，自己只需要提供 rootfs 就行了。由此可见对于不同的 Linux 发行版，bootfs基本是一致的，rootfs会有差别，因此不同的发行版可以公用 bootfs。比如：平时我们安装的虚拟机的 CentOS 都是好几个 G 大小，而 Docker 里才要 200 M 左右。</p>
<p><img src="/2021/05/17/docker-base/image-20210520113538105.png" alt="image-20210520113538105"></p>
</li>
</ul>
<h3 id="Docker-镜像是分层的"><a href="#Docker-镜像是分层的" class="headerlink" title="Docker 镜像是分层的"></a>Docker 镜像是分层的</h3><ul>
<li><p>在执行 pull 命令时，可以看出 docker 的镜像时一层一层的在下载：</p>
<p><img src="/2021/05/17/docker-base/image-20210520165412315.png" alt="image-20210520165412315"></p>
</li>
<li><p>以 tomcat 为例，主要分为如下几个层次：</p>
<p><img src="/2021/05/17/docker-base/image-20210520165008832.png" alt="image-20210520165008832"></p>
</li>
</ul>
<h3 id="Docker-镜像采用分层结构的原因"><a href="#Docker-镜像采用分层结构的原因" class="headerlink" title="Docker 镜像采用分层结构的原因"></a>Docker 镜像采用分层结构的原因</h3><ul>
<li>最大的一个好处就是：<strong>共享资源。</strong></li>
<li>比如：有多个镜像都从相同的 base 镜像构建而来，那么宿主机只需在磁盘上保存一份 base 镜像，同时内存中也只需加载一份 base 镜像，就可以为所有容器服务了。进一步的，<strong>镜像的每一层都可以被共享。</strong></li>
</ul>
<h3 id="Docker-镜像的特点"><a href="#Docker-镜像的特点" class="headerlink" title="Docker 镜像的特点"></a>Docker 镜像的特点</h3><ul>
<li>Docker 镜像都是只读的，当容器启动时，一个新的可写层被加载到<strong>镜像的顶部</strong>，这一层通常被称为<strong>容器层</strong>，容器层之下都叫<strong>镜像层</strong>。<ul>
<li>Docker 镜像的最外层是可写的，之下的都是封装好不可写的。</li>
</ul>
</li>
</ul>
<h3 id="Docker-镜像-commit-操作"><a href="#Docker-镜像-commit-操作" class="headerlink" title="Docker 镜像 commit 操作"></a>Docker 镜像 commit 操作</h3><ul>
<li><p>docker commit 命令，可以提交容器副本使之称为一个新的镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker commit -m=<span class="string">&quot;提交的描述信息&quot;</span> -a=<span class="string">&quot;作者&quot;</span> 容器ID 要创建的目标镜像名:[标签名]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>案例演示：</p>
<ul>
<li><p>从 Hub 上下载 tomcat 镜像到本地，然后运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -p 8888:8080 tomcat</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-p 主机端口:容器端口，主机端口即为暴露的能访问docker的端口，容器端口即为docker内待访问特定容器的端口，如tomcat默认为8080</span><br><span class="line">-P 随机分配主机的端口</span><br><span class="line">-d 后台运行容器，并返回容器ID，即启动守护式容器</span><br><span class="line">-i 以交互模式运行容器，通常与-t同时使用</span><br><span class="line">-t 为容器重新分配一个伪输入终端，通常与-i同时使用</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210523092658718.png" alt="image-20210523092658718"></p>
</li>
<li><p>故意删除上一步镜像生成的 tomcat 容器的文档，会发现再次进入 tomcat 主页时，点击 Documentation 会返回 404。</p>
<p><img src="/2021/05/17/docker-base/image-20210523095753669.png" alt="image-20210523095753669"></p>
<p><img src="/2021/05/17/docker-base/image-20210523095840185.png" alt="image-20210523095840185"></p>
</li>
<li><p>也即当前的 tomcat 运行实例是一个没有文档内容的容器，现在，以此为模板 commit 一个没有 doc 文档的 tomcat 新镜像：atguigu/tomcat02:1.2。</p>
<p><img src="/2021/05/17/docker-base/image-20210523105707137.png" alt="image-20210523105707137"></p>
</li>
<li><p>启动新镜像并和原来的对比。</p>
<ul>
<li><p>启动 atuigu/tomcat02，没有doc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -p 7777:8080 atuigu/tomcat02:1.2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动原来 tomcat，有doc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -p 8888:8080 tomcat</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Docker-容器数据卷"><a href="#Docker-容器数据卷" class="headerlink" title="Docker 容器数据卷"></a>Docker 容器数据卷</h2><ul>
<li>Docker 容器产生的数据，如果不通过 docker commit 生成一个新的镜像，使得数据做为镜像的一部分保存下来，那么当容器删除后，数据自然也就没有了。</li>
<li><strong>在 Docker 中，使用卷来保存数据。</strong>有点类似 Redis 里面的 rdb 和 aof 文件。</li>
<li>卷是目录或文件，存在于一个或多个容器中，由 Docker 挂载到容器，但不属于联合文件系统，因此能够绕过 UnionFS 提供一些用于持续存储或共享数据的特性。</li>
<li><strong>卷的设计目的就是数据的持久化</strong>，卷完全独立于容器的生存周期，因此 Docker 不会在容器删除时删除其挂载的数据卷。</li>
<li><strong>卷的特点：</strong><ul>
<li><strong>数据卷可在容器之间共享或重用数据。</strong></li>
<li><strong>数据卷中的更改可以直接生效。</strong></li>
<li><strong>数据卷中的更改不会包含在镜像的更新中。</strong></li>
<li><strong>数据卷的生命周期一直持续到没有容器使用它为止。</strong></li>
</ul>
</li>
</ul>
<h3 id="容器内添加数据卷"><a href="#容器内添加数据卷" class="headerlink" title="容器内添加数据卷"></a>容器内添加数据卷</h3><ul>
<li><p><strong>直接命令添加</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v /宿主机绝对路径目录:/容器内目录 镜像名</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>案例演示：</p>
<p><img src="/2021/05/17/docker-base/image-20210525100710287.png" alt="image-20210525100710287"></p>
</li>
<li><p>查看数据卷是否挂载成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker inspect 容器ID</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525102017647.png" alt="image-20210525102017647"></p>
<blockquote>
<p>此时，volume 权限是可读写的。可以在容器或主机内分别对卷进行数据的读写，读写的数据是共享的。</p>
</blockquote>
</li>
<li><p>容器运行时，容器和宿主机之间数据能够共享：</p>
<p><img src="/2021/05/17/docker-base/image-20210525102405896.png" alt="image-20210525102405896"></p>
</li>
<li><p>容器停止退出后，主机修改后的数据也能同步：</p>
<p><img src="/2021/05/17/docker-base/image-20210525103400831.png" alt="image-20210525103400831"></p>
</li>
<li><p>带权限的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v /宿主机绝对路径目录:/容器内目录:ro 镜像名</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525104906871.png" alt="image-20210525104906871"></p>
<blockquote>
<p>此时，volume 权限是不可写的。可以在主机对卷进行数据的读写，读写的数据是共享的。但是，在容器内，只可对卷进行数据的读，不可写。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>Dockerfile 添加</strong></p>
<ul>
<li><p>在主机根目录下新建 mydocker 文件夹并进入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir /mydocker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /mydocker</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Dockerfile 中，使用 VOLUME 指令来给镜像添加一个或多个数据卷：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/dataVolumeContainer&quot;</span>,<span class="string">&quot;/dataVolumeContainer2&quot;</span>,<span class="string">&quot;/dataVolumeContainer3&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>出于可移植和分享的考虑，用 <code>-v 主机目录:容器目录</code> 这种方法不能直接在 Dockerfile 中实现。因为宿主机目录是依赖于特定宿主机的，不能保证在所有的宿主机上都存在这样的特定目录。</li>
</ul>
</li>
<li><p>构建 Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim Dockerfile2</span></span><br></pre></td></tr></table></figure>

<p>在 Dockerfile2 中添加如下内容：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># volume test</span></span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/dataVolumeContainer1&quot;</span>,<span class="string">&quot;/dataVolumeContainer2&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;finished,--------success1&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /bin/bash</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>大致等同于命令：<code>docker run -it -v /host1:/dataVolumeContainer1 -v /host2:/dataVolumeContainer2 centos /bin/bash</code>。</p>
</blockquote>
</li>
<li><p>执行 build 命令生成一个新镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker builder -f /mydocker/Dockerfile2 -t zzyy/centos .</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525170205671.png" alt="image-20210525170205671"></p>
</li>
<li><p>执行 run 命令启动容器，并查看容器内创建的卷的目录所在：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it zzyy/centos /bin/bash</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525170543474.png" alt="image-20210525170543474"></p>
</li>
<li><p>执行 inspect 命令查看主机对应的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker inspect 容器ID</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525171348807.png" alt="image-20210525171348807"></p>
<p><img src="/2021/05/17/docker-base/image-20210525171451918.png" alt="image-20210525171451918"></p>
</li>
</ul>
</li>
<li><p>备注：</p>
<ul>
<li>Docker 挂载主机目录 Docker 访问出现 <code>cannot open directory. Permission denied</code> 异常时，在挂载目录后多加一个 <code>--privileged=true</code> 参数即可。</li>
</ul>
</li>
</ul>
<h3 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h3><ul>
<li><p>命名的容器挂载数据卷，其它容器通过挂载这个 (父容器) 实现数据共享，挂载数据卷的容器，称之为数据卷容器。</p>
</li>
<li><p>案例演示：</p>
<ul>
<li><p>先启动一个父容器 doc1，启动后在 dataVolumeContainer2 中新增内容 dc01_add.txt：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it --name dc01 zzyy/centos</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525172731112.png" alt="image-20210525172731112"></p>
</li>
<li><p>启动子容器 dc02 和 dc03，继承 dc01，启动后分别在 dataVolumeContainer2 中新增内容 dc02_add.txt 和 dc03_add.txt：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it --name dc02 --volume-from dco1 zzyy/centos</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it --name dc03 --volume-from dco1 zzyy/centos</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525173239008.png" alt="image-20210525173239008"></p>
</li>
<li><p>重新进入 dc01 容器，可以看到 dc02 和 dc03 容器内添加的数据，在卷 dataVolumeContainer2  中都可以共享：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker attach dc01</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210525173530503.png" alt="image-20210525173530503"></p>
</li>
<li><p>删除 dc01，dc02 和 dc03 仍然能够共享数据：</p>
<p><img src="/2021/05/17/docker-base/image-20210525215431656.png" alt="image-20210525215431656"></p>
</li>
<li><p>删除 dc02 后，dc03 仍然能够共享数据：</p>
<p><img src="/2021/05/17/docker-base/image-20210525221249241.png" alt="image-20210525221249241"></p>
</li>
<li><p>新建 dc04 继承 dc03，然后删除 dc03，dc04 仍然能够共享数据：</p>
<p><img src="/2021/05/17/docker-base/image-20210525221624773.png" alt="image-20210525221624773"></p>
<p><img src="/2021/05/17/docker-base/image-20210525221738032.png" alt="image-20210525221738032"></p>
</li>
</ul>
</li>
<li><p><strong>结论：容器之间配置信息的传递，数据卷的生命周期一直持续到没有容器使用它为止。</strong></p>
</li>
</ul>
<h2 id="Dockerfile-解析"><a href="#Dockerfile-解析" class="headerlink" title="Dockerfile 解析"></a>Dockerfile 解析</h2><ul>
<li><p><strong>Dockerfile 是用来构建 Docker 镜像的构建文件，由一系列命令和参数构成的脚本。</strong></p>
<p><img src="/2021/05/17/docker-base/image-20210526170718893.png" alt="image-20210526170718893"></p>
</li>
<li><p>Dockerfile 构建的三步骤：</p>
<ul>
<li>手动编写一个 Dockerfile 文件，必须要符合 Dockerfile 的规范；</li>
<li>docker build 命令执行编写好的 Dockerfile 文件，获得一个自定义的镜像；</li>
<li>doucker run 命令启动容器。</li>
</ul>
</li>
</ul>
<h3 id="Dockerfile-构建过程解析"><a href="#Dockerfile-构建过程解析" class="headerlink" title="Dockerfile 构建过程解析"></a>Dockerfile 构建过程解析</h3><ul>
<li><p>Dockerfile 内容基础知识：</p>
<ul>
<li>每条保留字指令都必须为大写字母，且后面要跟随至少一个参数。</li>
<li>指令按照从上到下，顺序执行。</li>
<li># 表示注释。</li>
<li>每条指令都会创建一个新的镜像层，并对镜像进行提交。</li>
</ul>
</li>
<li><p>Docker 执行 Dockerfile 的大致流程：</p>
<ul>
<li>第一步：Docker 从基础镜像运行一个容器；</li>
<li>第二步：执行一条指令并对容器作出修改；</li>
<li>第三步：执行类似 docker commit 的操作提交一个新的镜像层；</li>
<li>第四步：docker 再基刚提交的镜像运行一个新容器；</li>
<li>第五步：执行 Dockerfile 中的下一条指令，重复第二至第五步，直到所有指令都执行完成。</li>
</ul>
</li>
<li><p>Dockerfile、 Docker 镜像与 Docker 容器三者的关系：</p>
<ul>
<li><p>从应用软件的角度来看，Dockerfile、 Docker 镜像与 Docker 容器分别代表软件的三个不同阶段：</p>
<p><img src="/2021/05/17/docker-base/image-20210526203303754.png" alt="image-20210526203303754"></p>
<ul>
<li>Dockerfile 是软件的原材料。</li>
<li>Docker 镜像是软件的交付品。</li>
<li>Docker 容器可以认为是软件的运行态。</li>
<li>Dockerfile 面向开发，Docker 镜像为交付标准，Docker 容器则涉及部署与运维，三者缺一不可，合力充当 Docker 体系的基石。</li>
</ul>
</li>
<li><p>Dockerfile 定义了进程需要的一切东西。Dockerfile 涉及的内容包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进程和内核进程 (当应用进程需要和系统服务和内核进程打交道，这时需要考虑如何设计 namespace 的权限控制) 等等。</p>
</li>
<li><p>定义了 Dockerfile 文件后，docker build 命令产生一个 Docker 镜像。</p>
</li>
<li><p>对于生成的 Docker 镜像，docker run 命令生成 Docker 容器，容器是直接提供服务的。</p>
</li>
</ul>
</li>
</ul>
<h3 id="Dockerfile-体系结构-保留字指令"><a href="#Dockerfile-体系结构-保留字指令" class="headerlink" title="Dockerfile 体系结构 (保留字指令)"></a>Dockerfile 体系结构 (保留字指令)</h3><img src="/2021/05/17/docker-base/image-20210528152339289.png" alt="image-20210528152339289" style="zoom:80%;">

<ul>
<li><p><strong>FROM</strong>：基础镜像，即当前新镜像是基于哪个镜像的。</p>
</li>
<li><p><strong>MAINTAINER</strong>：镜像维护者的姓名和邮箱地址。</p>
</li>
<li><p><strong>RUN</strong>：容器构建时需要运行的命令。</p>
</li>
<li><p><strong>EXPOSE</strong>：当前容器对外暴露出的端口。</p>
</li>
<li><p><strong>WORKDIR</strong>：指定在创建容器后，终端默认进入的工作目录。如果不指定，则为根目录。</p>
</li>
<li><p><strong>ENV</strong>：用来在构建过程中设置环境变量。例如：<code>ENV MY_PATH /usr/mytest</code>，这个环境变量可以在后续的任何 RUN 指令中使用，如同在命令前制定了环境变量前缀；也可以在其他指令中直接使用这个环境变量，如 <code>WORKDIR $MY_PATH</code>。</p>
</li>
<li><p><strong>ADD</strong>：将宿主机目录下的文件拷贝进镜像，并且能够自动处理 URL 和解压 tar 压缩包。</p>
</li>
<li><p><strong>COPY</strong>：类似 ADD，拷贝文件和目录到镜像中 (只拷贝)。将从构建上下文目录中 &lt;源路径&gt; 的文件/目录复制到新的一层镜像内的 &lt;目标路径&gt; 指向的位置。</p>
<ul>
<li><code>COPY src dest</code></li>
<li><code>COPY [&quot;src&quot;,&quot;dest&quot;]</code></li>
</ul>
</li>
<li><p><strong>VOLUME</strong>：容器数据卷，用于数据保存和持久化工作。</p>
</li>
<li><p><strong>CMD</strong>：指定一个容器启动时要运行的命令。</p>
<ul>
<li>CMD 指令的格式和 RUN 相似：<ul>
<li>shell 格式：<code>CMD &lt;命令&gt;</code></li>
<li>exec 格式：<code>CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>
<li>参数列表格式：<code>CMD [&quot;参数1&quot;, &quot;参数2&quot;...]</code>。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。</li>
</ul>
</li>
<li>Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效。<strong>CMD 指令会被 docker run 之后的参数替换。</strong></li>
</ul>
</li>
<li><p><strong>ENTRYPOINT</strong>：指定一个容器启动时要运行的命令。</p>
<ul>
<li>ENTRYPOINT 的目的和 CMD 一样，不同的是，<strong>ENTRYPOINT 指令会被 docker run 之后的参数追加。</strong></li>
</ul>
</li>
<li><p>ONBUILD：当构建一个被继承的 Dockerfile 时运行命令，父镜像在被子镜像继承时，父镜像的 ONBUILD 指令触发，</p>
<p><img src="/2021/05/17/docker-base/image-20210528152445200.png" alt="image-20210528152445200"></p>
</li>
</ul>
<h3 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h3><h4 id="Base-镜像"><a href="#Base-镜像" class="headerlink" title="Base 镜像"></a>Base 镜像</h4><ul>
<li><p>Docker Hub 中 99% 的镜像都是通过在 base 镜像中，安装和配置需要的软件构建出来的。例如 centos 镜像：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> centos-8-x86_64.tar.xz /</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="bash"> org.label-schema.schema-version=<span class="string">&quot;1.0&quot;</span>     org.label-schema.name=<span class="string">&quot;CentOS Base Image&quot;</span>     org.label-schema.vendor=<span class="string">&quot;CentOS&quot;</span>     org.label-schema.license=<span class="string">&quot;GPLv2&quot;</span>     org.label-schema.build-date=<span class="string">&quot;20201204&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="自定义镜像-mycentos"><a href="#自定义镜像-mycentos" class="headerlink" title="自定义镜像 mycentos"></a>自定义镜像 mycentos</h4><ul>
<li><p>编写 Dockerfile：</p>
<ul>
<li><p>Docker Hub 默认的 centos 镜像：</p>
<p><img src="/2021/05/17/docker-base/image-20210528161841454.png" alt="image-20210528161841454"></p>
</li>
<li><p>需求：</p>
<ul>
<li>设置登陆后的默认路径；</li>
<li>增加 vim 编辑器；</li>
<li>增加查看网络配置 ifconfig 支持。</li>
</ul>
</li>
<li><p>在主机 /mydocker 或其他目录下编写 Dockerfile 文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> ZZYY&lt;zzyy167@<span class="number">126</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install net-tools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$MYPATH</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;success--------------ok&quot;</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /bin/bash</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>构建镜像：**<code>docker build -f Dockerfile路径 -t 新镜像名字:TAG .</code>**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -f /mydocker/Dockerfile -t mycentos:1.3 .</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210528165752297.png" alt="image-20210528165752297"></p>
</li>
<li><p>运行容器：**<code>docker run -it 新镜像名字:TAG </code>**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it mycentos:1.3</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210528170148528.png" alt="image-20210528170148528"></p>
</li>
<li><p>列出镜像的变更历史：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">history</span> 镜像ID</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210528173122209.png" alt="image-20210528173122209"></p>
</li>
</ul>
<h4 id="CMD-ENTRYPOINT-镜像案例"><a href="#CMD-ENTRYPOINT-镜像案例" class="headerlink" title="CMD/ENTRYPOINT 镜像案例"></a>CMD/ENTRYPOINT 镜像案例</h4><ul>
<li><p>CMD/ENTRYPOINT 都是指定一个容器启动时要运行的命令。</p>
</li>
<li><p><strong>Dockerfile 中可以有多个 CMD 指令，但只有最后一个生效；另外，CMD 指令会被 docker run 命令之后的参数替换。</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">16</span>-jdk-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/tomcat</span><br><span class="line"><span class="keyword">ENV</span> PATH $CATALINA_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>&quot;</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$CATALINA_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># let &quot;Tomcat Native&quot; live somewhere isolated</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_NATIVE_LIBDIR $CATALINA_HOME/native-jni-lib</span><br><span class="line"><span class="keyword">ENV</span> LD_LIBRARY_PATH $&#123;LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:&#125;$TOMCAT_NATIVE_LIBDIR</span><br><span class="line"></span><br><span class="line"><span class="comment"># see https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/KEYS</span></span><br><span class="line"><span class="comment"># see also &quot;update.sh&quot; (https://github.com/docker-library/tomcat/blob/master/update.sh)</span></span><br><span class="line"><span class="keyword">ENV</span> GPG_KEYS A9C5DF4D22E99998D9875A5110C01C5A2F6059E7</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_MAJOR <span class="number">10</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_VERSION <span class="number">10.0</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">ENV</span> TOMCAT_SHA512 <span class="number">3</span>d39b086b6fec86e354aa4837b1b55e6c16bfd5ec985a82a5dd71f928e3fab5370b2964a5a1098cfe05ca63d031f198773b18b1f8c7c6cdee6c90aa0644fb2f2</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># verify Tomcat Native is working properly</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;catalina.sh&quot;</span>, <span class="string">&quot;run&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>以 tomcat 的 Dockerfile 为例，可以看到，文件的最后一条指令为 CMD 指令。</p>
</li>
<li><p>运行以下命令，tomcat 能够正常启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -p 7777:8080 tomcat</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令，tomcat 不能正常启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -p 7777:8080 tomcat ls -l</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的 docker run 命令，末尾的 <code>ls -l</code> 参数会替换 Dockerfile 文件中的 <code>CMD [&quot;catalina.sh&quot;, &quot;run&quot;]</code> 指令，因此，tomcat 不会启动，只会列出 <code>/usr/local/tomcat</code> 路径下的文件。</li>
</ul>
</li>
</ul>
</li>
<li><p>不同于 CMD 指令，<strong>docker run 命令之后的参数，会传递给 ENTRYPOINT 指令，追加形成新的命令组合。</strong></p>
<ul>
<li><p>curl 命令解释：</p>
<ul>
<li>curl 命令可以用来执行下载、发送各种 HTTP 请求，指定 HTTP 头部等操作。</li>
<li>如果系统没有 curl，可以使用 <code>yum install -y curl</code> 命令安装。</li>
<li>curl 命令的 URL 如果指向的是 HTML 文档，那么缺省只显示文件头部，即 HTML 文档的 header，要全部显示，则加参数 -i。</li>
</ul>
</li>
<li><p>CMD 版查询 IP 信息的容器：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y curl</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;http://ip.cn&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210601115857147.png" alt="image-20210601115857147"></p>
<ul>
<li>上面的容器，已经指定了 CMD 指令，如果希望查询结果包含 header，命令 <code>docker run myip -i</code> 会不生效。-i 参数会替换掉 CMD 指令。</li>
</ul>
</li>
<li><p>ENTRYPOINT 版查询 IP 信息的容器：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y curl</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;http://ip.cn&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210601152053797.png" alt="image-20210601152053797"></p>
<ul>
<li>上面的容器，使用的是 ENTRYPOINT 指令，如果希望查询结果包含 header，只需要使用命令 <code>docker run myip -i</code> 即可。-i 参数会追加到 ENTRYPOINT 指令后面。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="自定义镜像-tomcat"><a href="#自定义镜像-tomcat" class="headerlink" title="自定义镜像 tomcat"></a>自定义镜像 tomcat</h4><ul>
<li><p>创建目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /zzyy/mydockerfile/tomcat9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再上述目录创建 c.txt：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /zzyy/mydockerfile/tomcat9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> touch c.txt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将 JDK 和 tomcat 的安装压缩包拷贝进上一步目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/jdk-8u171-linux-x64.tar.gz /zzyy/mydockerfile/tomcat9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp /opt/apache-tomcat-9.0.8.tar.gz /zzyy/mydockerfile/tomcat9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 zzyyuse/mydockerfile/tomcat9 目录下新建 Dockerfile 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim Dockerfie</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> zzyy&lt;zzyybs@ <span class="number">126</span>.com&gt;</span><br><span class="line"><span class="comment">#把宿主机当前上下文的c.txt拷贝到容器/usr/local/路径下</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> c.txt /usr/<span class="built_in">local</span>/cincontainer.txt</span></span><br><span class="line"><span class="comment">#把java与tomcat添加到容器中</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u171-linux x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> apache-tomcat-9.0.8.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="comment">#安装vim编辑器</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"><span class="comment">#设置工作访问时候的WORKDIR路径，登录落脚点</span></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"><span class="comment">#配置java与tomcat环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_ HOME /usr/local/jdk1.<span class="number">8.0</span>_171</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_BASE /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"><span class="comment">#容器运行时监听的端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment">#启动时运行tomcat</span></span><br><span class="line"><span class="comment"># ENTRYPOINT [&quot;/usrl/local/apache-tomcat-9.0.8/bin/startup.sh&quot; ]</span></span><br><span class="line"><span class="comment"># CMD [&quot;/usr/local/apache-tomcat-9.0.8/bin/catalina.sh&quot;,&quot;run&quot;]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /usr/<span class="built_in">local</span>/apache-tomcat-9.0.8/bin/startup.sh &amp;&amp; tail -F /usr/<span class="built_in">local</span>/apache-tomcat-9.0.8/<span class="keyword">in</span>/logs/catalina.out</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>目录内容：</p>
<img src="/2021/05/17/docker-base/image-20210601172840353.png" alt="image-20210601172840353" style="zoom:80%;">
</li>
<li><p>构建镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -t zzyytomcat9</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>不添加 -f 参数，默认构建当前路径下的 Dockerfile。</p>
</blockquote>
<p><img src="/2021/05/17/docker-base/image-20210601173056817.png" alt="image-20210601173056817"></p>
<p><img src="/2021/05/17/docker-base/image-20210601173119315.png" alt="image-20210601173119315"></p>
</li>
<li><p>运行容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 9080:8080 -name myt9 -v /zzyyuse/mydockerfile/tomcat9/<span class="built_in">test</span>:/usrlocal/apache-tomcat9.0.8/webapps/<span class="built_in">test</span> -v /zzyyuse/mydockerfile/tomcat9/tomcat9logs/:/usrlocal/apache-tomcat-9.0.8/logs -privileged=<span class="literal">true</span> zzyytomcat9</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210601173620972.png" alt="image-20210601173620972"></p>
<ul>
<li>-v 参数设置两个数据卷，一个用于存放发布项目，一个用于存放日志记录。</li>
<li><code>-privileged=true</code> 是 Docker 挂载主机目录 Docker 访问出现 <code>cannot open directory : Permission denied</code> 时的解决办法。</li>
</ul>
</li>
<li><p>验证：</p>
<p><img src="/2021/05/17/docker-base/image-20210602102100326.png" alt="image-20210602102100326"></p>
</li>
<li><p>发布 web 服务 test：</p>
<ul>
<li><p>在主机数据卷对应的目录 <code>/zzyyuse/mydockerfile/tomcat9/test</code> 目录下，新建 WEB-INF 目录，并添加 web.xml 文件。然后编写一个 a.jsp 文件作为测试：</p>
<p><img src="/2021/05/17/docker-base/image-20210602102911917.png" alt="image-20210602102911917"></p>
</li>
<li><p>web.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1 .0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmIns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XML Schema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmIns</span>=<span class="string">&quot;http://java sun.com/xm/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaL</span> <span class="attr">ocation</span>=<span class="string">&quot;http://java. sun.com/xml/ns/javaee htp:/:/java. sun.com/xml/ns/javaee/web-app_ 2_ _5.xsd&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">id</span>=<span class="string">&quot;WebApp_ ID&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.5&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>a.jsp：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC“<span class="comment">//W3C//DTD HTML 4.01 Transitional//EN&quot; http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span><br><span class="line">        &lt;title&gt;Insert title here &lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">    	---------------welcome---------------</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;%=<span class="string">&quot;i am in docker tomcat self &quot;</span>%&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;% System.out.printIn(<span class="string">&quot;==========docker tomcat self&quot;</span>);%&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/htmI&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker restart 命令重新启动 tomcat，然后网页访问 <code>localhost:9080/test/a.jsp</code>，即可查看到 a.jsp 网页的内容。在主机目录下修改 a.jsp 的内容时，会同步到 tomcat 中。</p>
</li>
<li><p>主机上查看日志：</p>
<p><img src="/2021/05/17/docker-base/image-20210602112906898.png" alt="image-20210602112906898"></p>
</li>
</ul>
</li>
</ul>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p><img src="/2021/05/17/docker-base/image-20210602112943914.png" alt="image-20210602112943914"></p>
<h2 id="Docker-常用安装"><a href="#Docker-常用安装" class="headerlink" title="Docker 常用安装"></a>Docker 常用安装</h2><h3 id="总体步骤"><a href="#总体步骤" class="headerlink" title="总体步骤"></a>总体步骤</h3><ul>
<li>搜索镜像</li>
<li>拉取镜像</li>
<li>查看镜像</li>
<li>启动镜像</li>
<li>停止镜像</li>
<li>移除镜像</li>
</ul>
<h3 id="安装-mysql"><a href="#安装-mysql" class="headerlink" title="安装 mysql"></a>安装 mysql</h3><ul>
<li><p>docker hub 上查找 mysql 镜像：</p>
<p><img src="/2021/05/17/docker-base/image-20210602113910658.png" alt="image-20210602113910658"></p>
</li>
<li><p>从 docker hub (阿里云加速器) 拉取 mysql 镜像到本地，标签为 5.6：</p>
<p><img src="/2021/05/17/docker-base/image-20210602114009574.png" alt="image-20210602114009574"></p>
</li>
<li><p>使用 mysql:5.6 镜像创建容器 (也叫运行镜像)：</p>
<p><img src="/2021/05/17/docker-base/image-20210602114309822.png" alt="image-20210602114309822"></p>
<ul>
<li><p>命令说明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 12345:3306 --name mysql </span><br><span class="line">-v /zzyyuse/mysql/conf:/etc/mysql/conf.d </span><br><span class="line">-v /zzyyuse/mysql/logs:/logs </span><br><span class="line">-v /zzyyuse/mysql/data:/var/lib/mysql </span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6</span><br><span class="line">----------------------------------------------</span><br><span class="line">命令说明:</span><br><span class="line">-p 12345:3306: 将主机的12345端口映射到docker容器的3306端口</span><br><span class="line">-name mysql: 运行服务名字</span><br><span class="line">-v /zzyyuse/mysql/conf:/etc/mysql/conf.d: 将主机/zzyyuse/mysq|目录下的conf/my.cnf挂载到容器的/etc/mysql/conf.d</span><br><span class="line">-v /zzyyuse/mysql/logs:/logs: 将主机/zzyyuse/mysql目录下的logs目录挂载到容器的/logs</span><br><span class="line">-v /zzyyuse/mysql/data:/var/lib/mysql: 将主机/zzyyuse/mysql目录下的data目录挂载到容器的/var/lib/mysql</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456: 初始化root用户的密码</span><br><span class="line">-d mysql:5.6: 后台程序运行mysql5.6 </span><br><span class="line">----------------------------------------------</span><br><span class="line">docker exec -it mysql运行成功后的容器ID /bin/bash</span><br><span class="line">----------------------------------------------</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>将 mysql 数据备份测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> mysql运行成功后的容器ID sh -c <span class="string">&#x27;exec mysqldump --all-databases -uroot -p&quot;123456&quot;&#x27;</span> &gt;/zzyyuse/all-database.sql</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210602115827004.png" alt="image-20210602115827004"></p>
</li>
</ul>
<h3 id="安装-redis"><a href="#安装-redis" class="headerlink" title="安装 redis"></a>安装 redis</h3><ul>
<li><p>从 docker hub 上 (阿里云加速器) 拉取 redis 镜像到本地，标签为 3.2：</p>
<p><img src="/2021/05/17/docker-base/image-20210602132253349.png" alt="image-20210602132253349"></p>
</li>
<li><p>使用 redis:3.2 镜像创建容器 (也叫运行镜像)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -p 6379:6379 -v /zzyyuse/myredis/conf/redis.conf:/usr/<span class="built_in">local</span>/etc/redis/redis.conf -v /zzyyuse/myredis/data:/data -d redis:3.2 redis-server /usr/<span class="built_in">local</span>/etc/redis/redis.conf --appendonly yes</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>命令中的 redis.conf 是路径，不是文件。</p>
</blockquote>
</li>
<li><p>在主机 <code>/zzyyuse/myredis/conf/redis.conf</code> 目录下新建 redis 配置文件 redis.conf，并添加如下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vim /zzyyuse/myredis/conf/redis.conf/redis.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Redis configuration file example.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that <span class="keyword">in</span> order to <span class="built_in">read</span> the configuration file, Redis must be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> started with the file path as first argument:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./redis-server /path/to/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note on units: when memory size is needed, it is possible to specify</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it <span class="keyword">in</span> the usual form of 1k 5GB 4M and so forth:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1gb =&gt; 1024*1024*1024 bytes</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> units are <span class="keyword">case</span> insensitive so 1GB 1Gb 1gB are all the same.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# INCLUDES ###################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Include one or more other config files here.  This is useful <span class="keyword">if</span> you</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> have a standard template that goes to all Redis servers but also need</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to customize a few per-server settings.  Include files can include</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> other files, so use this wisely.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Notice option <span class="string">&quot;include&quot;</span> won<span class="string">&#x27;t be rewritten by command &quot;CONFIG REWRITE&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> from admin or Redis Sentinel. Since Redis always uses the last processed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> line as value of a configuration directive, you<span class="string">&#x27;d better put includes</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> at the beginning of this file to avoid overwriting config change at runtime.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If instead you are interested <span class="keyword">in</span> using includes to override configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> options, it is better to use include as the last line.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> include /path/to/local.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> include /path/to/other.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# MODULES #####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Load modules at startup. If the server is not able to load modules</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it will abort. It is possible to use multiple loadmodule directives.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> loadmodule /path/to/my_module.so</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> loadmodule /path/to/other_module.so</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# NETWORK #####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, <span class="keyword">if</span> no <span class="string">&quot;bind&quot;</span> configuration directive is specified, Redis listens</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> connections from all the network interfaces available on the server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is possible to listen to just one or multiple selected interfaces using</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the <span class="string">&quot;bind&quot;</span> configuration directive, followed by one or more IP addresses.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Examples:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span> 192.168.1.100 10.0.0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span> 127.0.0.1 ::1</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> internet, binding to all the interfaces is dangerous and will expose the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> instance to everybody on the internet. So by default we uncomment the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> following <span class="built_in">bind</span> directive, that will force Redis to listen only into</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the IPv4 loopback interface address (this means Redis will be able to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> accept connections only from clients running into the same computer it</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is running).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> JUST COMMENT THE FOLLOWING LINE.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">bind</span> 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Protected mode is a layer of security protection, <span class="keyword">in</span> order to avoid that</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis instances left open on the internet are accessed and exploited.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When protected mode is on and <span class="keyword">if</span>:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) The server is not binding explicitly to a <span class="built_in">set</span> of addresses using the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="string">&quot;bind&quot;</span> directive.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) No password is configured.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The server only accepts connections from clients connecting from the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sockets.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default protected mode is enabled. You should <span class="built_in">disable</span> it only <span class="keyword">if</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you are sure you want clients from other hosts to connect to Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> even <span class="keyword">if</span> no authentication is configured, nor a specific <span class="built_in">set</span> of interfaces</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> are explicitly listed using the <span class="string">&quot;bind&quot;</span> directive.</span></span><br><span class="line">protected-mode yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Accept connections on the specified port, default is 6379 (IANA <span class="comment">#815344).</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If port 0 is specified Redis will not listen on a TCP socket.</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP listen() backlog.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In high requests-per-second environments you need an high backlog <span class="keyword">in</span> order</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to avoid slow clients connections issues. Note that the Linux kernel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will silently truncate it to the value of /proc/sys/net/core/somaxconn so</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> make sure to raise both the value of somaxconn and tcp_max_syn_backlog</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to get the desired effect.</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unix socket.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify the path <span class="keyword">for</span> the Unix socket that will be used to listen <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> incoming connections. There is no default, so Redis will not listen</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on a unix socket when not specified.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> unixsocket /tmp/redis.sock</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> unixsocketperm 700</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Close the connection after a client is idle <span class="keyword">for</span> N seconds (0 to <span class="built_in">disable</span>)</span></span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP keepalive.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients <span class="keyword">in</span> absence</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of communication. This is useful <span class="keyword">for</span> two reasons:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) Detect dead peers.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Take the connection alive from the point of view of network</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    equipment <span class="keyword">in</span> the middle.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> On Linux, the specified value (<span class="keyword">in</span> seconds) is the period used to send ACKs.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that to close the connection the double of the time is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> On other kernels the period depends on the kernel configuration.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A reasonable value <span class="keyword">for</span> this option is 300 seconds, <span class="built_in">which</span> is the new</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis default starting with Redis 3.2.1.</span></span><br><span class="line">tcp-keepalive 300</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ TLS/SSL #####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, TLS/SSL is disabled. To <span class="built_in">enable</span> it, the <span class="string">&quot;tls-port&quot;</span> configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> directive can be used to define TLS-listening ports. To <span class="built_in">enable</span> TLS on the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default port, use:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> port 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-port 6379</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure a X.509 certificate and private key to use <span class="keyword">for</span> authenticating the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server to connected clients, masters or cluster peers.  These files should be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PEM formatted.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-cert-file redis.crt </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-key-file redis.key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure a DH parameters file to <span class="built_in">enable</span> Diffie-Hellman (DH) key exchange:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-dh-params-file redis.dh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure a CA certificate(s) bundle or directory to authenticate TLS/SSL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clients and peers.  Redis requires an explicit configuration of at least one</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of these, and will not implicitly use the system wide configuration.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-ca-cert-file ca.crt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-ca-cert-dir /etc/ssl/certs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, clients (including replica servers) on a TLS port are required</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to authenticate using valid client side certificates.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="string">&quot;no&quot;</span> is specified, client certificates are not required and not accepted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="string">&quot;optional&quot;</span> is specified, client certificates are accepted and must be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> valid <span class="keyword">if</span> provided, but are not required.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-auth-clients no</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-auth-clients optional</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, a Redis replica does not attempt to establish a TLS connection</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with its master.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use the following directive to <span class="built_in">enable</span> TLS on replication links.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-replication yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, the Redis Cluster bus uses a plain TCP connection. To <span class="built_in">enable</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TLS <span class="keyword">for</span> the bus protocol, use the following directive:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-cluster yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Explicitly specify TLS versions to support. Allowed values are <span class="keyword">case</span> insensitive</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and include <span class="string">&quot;TLSv1&quot;</span>, <span class="string">&quot;TLSv1.1&quot;</span>, <span class="string">&quot;TLSv1.2&quot;</span>, <span class="string">&quot;TLSv1.3&quot;</span> (OpenSSL &gt;= 1.1.1) or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> any combination. To <span class="built_in">enable</span> only TLSv1.2 and TLSv1.3, use:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-protocols <span class="string">&quot;TLSv1.2 TLSv1.3&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure allowed ciphers.  See the ciphers(1ssl) manpage <span class="keyword">for</span> more information</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> about the syntax of this string.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: this configuration applies only to &lt;= TLSv1.2.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-ciphers DEFAULT:!MEDIUM</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure allowed TLSv1.3 ciphersuites.  See the ciphers(1ssl) manpage <span class="keyword">for</span> more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> information about the syntax of this string, and specifically <span class="keyword">for</span> TLSv1.3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ciphersuites.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When choosing a cipher, use the server<span class="string">&#x27;s preference instead of the client</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> preference. By default, the server follows the client<span class="string">&#x27;s preference.</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-prefer-server-ciphers yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default, TLS session caching is enabled to allow faster and less expensive</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reconnections by clients that support it. Use the following directive to <span class="built_in">disable</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> caching.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-session-caching no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Change the default number of TLS sessions cached. A zero value sets the cache</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to unlimited size. The default size is 20480.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-session-cache-size 5000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Change the default timeout of cached TLS sessions. The default timeout is 300</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tls-session-cache-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ GENERAL #####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis does not run as a daemon. Use <span class="string">&#x27;yes&#x27;</span> <span class="keyword">if</span> you need it.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that Redis will write a pid file <span class="keyword">in</span> /var/run/redis.pid when daemonized.</span></span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you run Redis from upstart or systemd, Redis can interact with your</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> supervision tree. Options:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   supervised no      - no supervision interaction</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   supervised upstart - signal upstart by putting Redis into SIGSTOP mode</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   supervised systemd - signal systemd by writing READY=1 to <span class="variable">$NOTIFY_SOCKET</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">   supervised auto    - detect upstart or systemd method based on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                        UPSTART_JOB or NOTIFY_SOCKET environment variables</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: these supervision methods only signal <span class="string">&quot;process is ready.&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">       They <span class="keyword">do</span> not <span class="built_in">enable</span> continuous liveness pings back to your supervisor.</span></span><br><span class="line">supervised no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If a pid file is specified, Redis writes it <span class="built_in">where</span> specified at startup</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and removes it at <span class="built_in">exit</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When the server runs non daemonized, no pid file is created <span class="keyword">if</span> none is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> specified <span class="keyword">in</span> the configuration. When the server is daemonized, the pid file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is used even <span class="keyword">if</span> not specified, defaulting to <span class="string">&quot;/var/run/redis.pid&quot;</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Creating a pid file is best effort: <span class="keyword">if</span> Redis is not able to create it</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> nothing bad happens, the server will start and run normally.</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify the server verbosity level.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This can be one of:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> debug (a lot of information, useful <span class="keyword">for</span> development/testing)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> notice (moderately verbose, what you want <span class="keyword">in</span> production probably)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> warning (only very important / critical messages are logged)</span></span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify the <span class="built_in">log</span> file name. Also the empty string can be used to force</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis to <span class="built_in">log</span> on the standard output. Note that <span class="keyword">if</span> you use standard</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> output <span class="keyword">for</span> logging but daemonize, logs will be sent to /dev/null</span></span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> To <span class="built_in">enable</span> logging to the system logger, just <span class="built_in">set</span> <span class="string">&#x27;syslog-enabled&#x27;</span> to yes,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and optionally update the other syslog parameters to suit your needs.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syslog-enabled no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify the syslog identity.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syslog-ident redis</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> syslog-facility local0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a different one on a per-connection basis using SELECT &lt;dbid&gt; <span class="built_in">where</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dbid is a number between 0 and <span class="string">&#x27;databases&#x27;</span>-1</span></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis shows an ASCII art logo only when started to <span class="built_in">log</span> to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> standard output and <span class="keyword">if</span> the standard output is a TTY. Basically this means</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that normally a logo is displayed only <span class="keyword">in</span> interactive sessions.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However it is possible to force the pre-4.0 behavior and always show a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ASCII art logo <span class="keyword">in</span> startup logs by setting the following option to yes.</span></span><br><span class="line">always-show-logo yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### SNAPSHOTTING  ################################</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Save the DB on disk:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   save &lt;seconds&gt; &lt;changes&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Will save the DB <span class="keyword">if</span> both the given number of seconds and the given</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   number of write operations against the DB occurred.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   In the example below the behaviour will be to save:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   after 900 sec (15 min) <span class="keyword">if</span> at least 1 key changed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   after 300 sec (5 min) <span class="keyword">if</span> at least 10 keys changed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   after 60 sec <span class="keyword">if</span> at least 10000 keys changed</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Note: you can <span class="built_in">disable</span> saving completely by commenting out all <span class="string">&quot;save&quot;</span> lines.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   It is also possible to remove all the previously configured save</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   points by adding a save directive with a single empty string argument</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   like <span class="keyword">in</span> the following example:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   save <span class="string">&quot;&quot;</span></span></span><br><span class="line"></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis will stop accepting writes <span class="keyword">if</span> RDB snapshots are enabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (at least one save point) and the latest background save failed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This will make the user aware (<span class="keyword">in</span> a hard way) that data is not persisting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on disk properly, otherwise chances are that no one will notice and some</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disaster will happen.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If the background saving process will start working again Redis will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> automatically allow writes again.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However <span class="keyword">if</span> you have setup your proper monitoring of the Redis server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and persistence, you may want to <span class="built_in">disable</span> this feature so that Redis will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">continue</span> to work as usual even <span class="keyword">if</span> there are problems with disk,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> permissions, and so forth.</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Compress string objects using LZF when dump .rdb databases?</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For default that<span class="string">&#x27;s set to &#x27;</span>yes<span class="string">&#x27; as it&#x27;</span>s almost always a win.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you want to save some CPU <span class="keyword">in</span> the saving child <span class="built_in">set</span> it to <span class="string">&#x27;no&#x27;</span> but</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the dataset will likely be bigger <span class="keyword">if</span> you have compressible values or keys.</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This makes the format more resistant to corruption but there is a performance</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> hit to pay (around 10%) when saving and loading RDB files, so you can <span class="built_in">disable</span> it</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> maximum performances.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RDB files created with checksum disabled have a checksum of zero that will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tell the loading code to skip the check.</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The filename <span class="built_in">where</span> to dump the DB</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Remove RDB files used by replication <span class="keyword">in</span> instances without persistence</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enabled. By default this option is disabled, however there are environments</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> <span class="keyword">for</span> regulations or other security concerns, RDB files persisted on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disk by masters <span class="keyword">in</span> order to feed replicas, or stored on disk by replicas</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to load them <span class="keyword">for</span> the initial synchronization, should be deleted</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ASAP. Note that this option ONLY WORKS <span class="keyword">in</span> instances that have both AOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and RDB persistence disabled, otherwise is completely ignored.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> An alternative (and sometimes better) way to obtain the same effect is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to use diskless replication on both master and replicas instances. However</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the <span class="keyword">case</span> of replicas, diskless is not always an option.</span></span><br><span class="line">rdb-del-sync-files no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The working directory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The DB will be written inside this directory, with the filename specified</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> above using the <span class="string">&#x27;dbfilename&#x27;</span> configuration directive.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Append Only File will also be created inside this directory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that you must specify a directory here, not a file name.</span></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################ REPLICATION #################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Master-Replica replication. Use replicaof to make a Redis instance a copy of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> another Redis server. A few things to understand ASAP about Redis replication.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   +------------------+      +---------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   |      Master      | ---&gt; |    Replica    |</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   | (receive writes) |      |  (exact copy) |</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   +------------------+      +---------------+</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) Redis replication is asynchronous, but you can configure a master to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    stop accepting writes <span class="keyword">if</span> it appears to be not connected with at least</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    a given number of replicas.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Redis replicas are able to perform a partial resynchronization with the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    master <span class="keyword">if</span> the replication link is lost <span class="keyword">for</span> a relatively small amount of</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    time. You may want to configure the replication backlog size (see the next</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    sections of this file) with a sensible value depending on your needs.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3) Replication is automatic and does not need user intervention. After a</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    network partition replicas automatically try to reconnect to masters</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    and resynchronize with them.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replicaof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If the master is password protected (using the <span class="string">&quot;requirepass&quot;</span> configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> directive below) it is possible to tell the replica to authenticate before</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> starting the replication synchronization process, otherwise the master will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> refuse the replica request.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> masterauth &lt;master-password&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However this is not enough <span class="keyword">if</span> you are using Redis ACLs (<span class="keyword">for</span> Redis version</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6 or greater), and the default user is not capable of running the PSYNC</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">command</span> and/or other commands needed <span class="keyword">for</span> replication. In this <span class="keyword">case</span> it<span class="string">&#x27;s</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> better to configure a special user to use with replication, and specify the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> masteruser configuration as such:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> masteruser &lt;username&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When masteruser is specified, the replica will authenticate against its</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master using the new AUTH form: AUTH &lt;username&gt; &lt;password&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When a replica loses its connection with the master, or when the replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is still <span class="keyword">in</span> progress, the replica can act <span class="keyword">in</span> two different ways:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) <span class="keyword">if</span> replica-serve-stale-data is <span class="built_in">set</span> to <span class="string">&#x27;yes&#x27;</span> (the default) the replica will</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    still reply to client requests, possibly with out of date data, or the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    data <span class="built_in">set</span> may just be empty <span class="keyword">if</span> this is the first synchronization.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) <span class="keyword">if</span> replica-serve-stale-data is <span class="built_in">set</span> to <span class="string">&#x27;no&#x27;</span> the replica will reply with</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    an error <span class="string">&quot;SYNC with master in progress&quot;</span> to all the kind of commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    but to INFO, replicaOF, AUTH, PING, SHUTDOWN, REPLCONF, ROLE, CONFIG,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    SUBSCRIBE, UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    COMMAND, POST, HOST: and LATENCY.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can configure a replica instance to accept writes or not. Writing against</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a replica instance may be useful to store some ephemeral data (because data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> written on a replica will be easily deleted after resync with the master) but</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> may also cause problems <span class="keyword">if</span> clients are writing to it because of a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> misconfiguration.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since Redis 2.6 by default replicas are read-only.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: <span class="built_in">read</span> only replicas are not designed to be exposed to untrusted clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on the internet. It<span class="string">&#x27;s just a protection layer against misuse of the instance.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Still a <span class="built_in">read</span> only replica exports by default all the administrative commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> security of <span class="built_in">read</span> only replicas using <span class="string">&#x27;rename-command&#x27;</span> to shadow all the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> administrative / dangerous commands.</span></span><br><span class="line">replica-read-only yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication SYNC strategy: disk or socket.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> New replicas and reconnecting replicas that are not able to <span class="built_in">continue</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replication process just receiving differences, need to <span class="keyword">do</span> what is called a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;full synchronization&quot;</span>. An RDB file is transmitted from the master to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replicas.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The transmission can happen <span class="keyword">in</span> two different ways:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) Disk-backed: The Redis master creates a new process that writes the RDB</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 file on disk. Later the file is transferred by the parent</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 process to the replicas incrementally.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Diskless: The Redis master creates a new process that directly writes the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">              RDB file to replica sockets, without touching the disk at all.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> With disk-backed replication, <span class="keyword">while</span> the RDB file is generated, more replicas</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> can be queued and served with the RDB file as soon as the current child</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> producing the RDB file finishes its work. With diskless replication instead</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> once the transfer starts, new replicas arriving will be queued and a new</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> transfer will start when the current one terminates.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When diskless replication is used, the master waits a configurable amount of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> time (<span class="keyword">in</span> seconds) before starting the transfer <span class="keyword">in</span> the hope that multiple</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replicas will arrive and the transfer can be parallelized.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> With slow disks and fast (large bandwidth) networks, diskless replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> works better.</span></span><br><span class="line">repl-diskless-sync no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When diskless replication is enabled, it is possible to configure the delay</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the server waits <span class="keyword">in</span> order to spawn the child that transfers the RDB via socket</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to the replicas.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is important since once the transfer starts, it is not possible to serve</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> new replicas arriving, that will be queued <span class="keyword">for</span> the next RDB transfer, so the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server waits a delay <span class="keyword">in</span> order to <span class="built_in">let</span> more replicas arrive.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The delay is specified <span class="keyword">in</span> seconds, and by default is 5 seconds. To <span class="built_in">disable</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it entirely just <span class="built_in">set</span> it to 0 seconds and the transfer will start ASAP.</span></span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WARNING: RDB diskless load is experimental. Since <span class="keyword">in</span> this setup the replica</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> does not immediately store an RDB on disk, it may cause data loss during</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> failovers. RDB diskless load + Redis modules not handling I/O reads may also</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cause Redis to abort <span class="keyword">in</span> <span class="keyword">case</span> of I/O errors during the initial synchronization</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> stage with the master. Use only <span class="keyword">if</span> your <span class="keyword">do</span> what you are doing.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replica can load the RDB it reads from the replication link directly from the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> socket, or store the RDB to a file and <span class="built_in">read</span> that file after it was completely</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> recived from the master.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In many cases the disk is slower than the network, and storing and loading</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the RDB file may increase replication time (and even increase the master<span class="string">&#x27;s</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copy on Write memory and salve buffers).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However, parsing the RDB file directly from the socket may mean that we have</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to flush the contents of the current database before the full rdb was</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> received. For this reason we have the following options:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;disabled&quot;</span>    - Don<span class="string">&#x27;t use diskless load (store the rdb file to the disk first)</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;on-empty-db&quot;</span> - Use diskless load only when it is completely safe.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;swapdb&quot;</span>      - Keep a copy of the current db contents <span class="keyword">in</span> RAM <span class="keyword">while</span> parsing</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 the data directly from the socket. note that this requires</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 sufficient memory, <span class="keyword">if</span> you don<span class="string">&#x27;t have it, you risk an OOM kill.</span></span></span><br><span class="line">repl-diskless-load disabled</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replicas send PINGs to server <span class="keyword">in</span> a predefined interval. It<span class="string">&#x27;s possible to</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> change this interval with the repl_ping_replica_period option. The default</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> value is 10 seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> repl-ping-replica-period 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following option sets the replication timeout <span class="keyword">for</span>:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) Bulk transfer I/O during SYNC, from the point of view of replica.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Master timeout from the point of view of replicas (data, pings).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3) Replica timeout from the point of view of masters (REPLCONF ACK pings).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is important to make sure that this value is greater than the value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> specified <span class="keyword">for</span> repl-ping-replica-period otherwise a timeout will be detected</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> every time there is low traffic between the master and the replica.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> repl-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Disable TCP_NODELAY on the replica socket after SYNC?</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you select <span class="string">&quot;yes&quot;</span> Redis will use a smaller number of TCP packets and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> less bandwidth to send data to replicas. But this can add a delay <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the data to appear on the replica side, up to 40 milliseconds with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Linux kernels using a default configuration.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you select <span class="string">&quot;no&quot;</span> the delay <span class="keyword">for</span> data to appear on the replica side will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be reduced but more bandwidth will be used <span class="keyword">for</span> replication.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default we optimize <span class="keyword">for</span> low latency, but <span class="keyword">in</span> very high traffic conditions</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or when the master and replicas are many hops away, turning this to <span class="string">&quot;yes&quot;</span> may</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be a good idea.</span></span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set the replication backlog size. The backlog is a buffer that accumulates</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica data when replicas are disconnected <span class="keyword">for</span> some time, so that when a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica wants to reconnect again, often a full resync is not needed, but a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> partial resync is enough, just passing the portion of data the replica</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> missed <span class="keyword">while</span> disconnected.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The bigger the replication backlog, the longer the time the replica can be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disconnected and later be able to perform a partial resynchronization.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The backlog is only allocated once there is at least a replica connected.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> repl-backlog-size 1mb</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> After a master has no longer connected replicas <span class="keyword">for</span> some time, the backlog</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will be freed. The following option configures the amount of seconds that</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> need to elapse, starting from the time the last replica disconnected, <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the backlog buffer to be freed.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that replicas never free the backlog <span class="keyword">for</span> timeout, since they may be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> promoted to masters later, and should be able to correctly <span class="string">&quot;partially</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> resynchronize<span class="string">&quot; with the replicas: hence they should always accumulate backlog.</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A value of 0 means to never release the backlog.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> repl-backlog-ttl 3600</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The replica priority is an <span class="built_in">integer</span> number published by Redis <span class="keyword">in</span> the INFO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> output. It is used by Redis Sentinel <span class="keyword">in</span> order to select a replica to promote</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> into a master <span class="keyword">if</span> the master is no longer working correctly.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A replica with a low priority number is considered better <span class="keyword">for</span> promotion, so</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> instance <span class="keyword">if</span> there are three replicas with priority 10, 100, 25 Sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will pick the one with priority 10, that is the lowest.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However a special priority of 0 marks the replica as not able to perform the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> role of master, so a replica with priority of 0 will never be selected by</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis Sentinel <span class="keyword">for</span> promotion.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default the priority is 100.</span></span><br><span class="line">replica-priority 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is possible <span class="keyword">for</span> a master to stop accepting writes <span class="keyword">if</span> there are less than</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> N replicas connected, having a lag less or equal than M seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The N replicas need to be <span class="keyword">in</span> <span class="string">&quot;online&quot;</span> state.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The lag <span class="keyword">in</span> seconds, that must be &lt;= the specified value, is calculated from</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the last ping received from the replica, that is usually sent every second.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This option does not GUARANTEE that N replicas will accept the write, but</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will <span class="built_in">limit</span> the window of exposure <span class="keyword">for</span> lost writes <span class="keyword">in</span> <span class="keyword">case</span> not enough replicas</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> are available, to the specified number of seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For example to require at least 3 replicas with a lag &lt;= 10 seconds use:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> min-replicas-to-write 3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> min-replicas-max-lag 10</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Setting one or the other to 0 disables the feature.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default min-replicas-to-write is <span class="built_in">set</span> to 0 (feature disabled) and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> min-replicas-max-lag is <span class="built_in">set</span> to 10.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A Redis master is able to list the address and port of the attached</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replicas <span class="keyword">in</span> different ways. For example the <span class="string">&quot;INFO replication&quot;</span> section</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> offers this information, <span class="built_in">which</span> is used, among other tools, by</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis Sentinel <span class="keyword">in</span> order to discover replica instances.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Another place <span class="built_in">where</span> this info is available is <span class="keyword">in</span> the output of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;ROLE&quot;</span> <span class="built_in">command</span> of a master.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The listed IP and address normally reported by a replica is obtained</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the following way:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   IP: The address is auto detected by checking the peer address</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   of the socket used by the replica to connect with the master.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   Port: The port is communicated by the replica during the replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   handshake, and is normally the port that the replica is using to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   listen <span class="keyword">for</span> connections.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However when port forwarding or Network Address Translation (NAT) is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used, the replica may be actually reachable via different IP and port</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pairs. The following two options can be used by a replica <span class="keyword">in</span> order to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> report to its master a specific <span class="built_in">set</span> of IP and port, so that both INFO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and ROLE will report those values.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> There is no need to use both the options <span class="keyword">if</span> you need to override just</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the port or the IP address.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica-announce-ip 5.5.5.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica-announce-port 1234</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################## KEYS TRACKING #################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis implements server assisted support <span class="keyword">for</span> client side caching of values.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is implemented using an invalidation table that remembers, using</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 16 millions of slots, what clients may have certain subsets of keys. In turn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this is used <span class="keyword">in</span> order to send invalidation messages to clients. Please</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to understand more about the feature check this page:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   https://redis.io/topics/client-side-caching</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When tracking is enabled <span class="keyword">for</span> a client, all the <span class="built_in">read</span> only queries are assumed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to be cached: this will force Redis to store information <span class="keyword">in</span> the invalidation</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> table. When keys are modified, such information is flushed away, and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> invalidation messages are sent to the clients. However <span class="keyword">if</span> the workload is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> heavily dominated by reads, Redis could use more and more memory <span class="keyword">in</span> order</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to track the keys fetched by many clients.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For this reason it is possible to configure a maximum fill value <span class="keyword">for</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> invalidation table. By default it is <span class="built_in">set</span> to 1M of keys, and once this <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is reached, Redis will start to evict keys <span class="keyword">in</span> the invalidation table</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> even <span class="keyword">if</span> they were not modified, just to reclaim memory: this will <span class="keyword">in</span> turn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> force the clients to invalidate the cached values. Basically the table</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maximum size is a trade off between the memory you want to spend server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> side to track information about who cached what, and the ability of clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to retain cached objects <span class="keyword">in</span> memory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you <span class="built_in">set</span> the value to 0, it means there are no limits, and Redis will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> retain as many keys as needed <span class="keyword">in</span> the invalidation table.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In the <span class="string">&quot;stats&quot;</span> INFO section, you can find information about the number of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keys <span class="keyword">in</span> the invalidation table at every given moment.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: when key tracking is used <span class="keyword">in</span> broadcasting mode, no memory is used</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the server side so this setting is useless.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tracking-table-max-keys 1000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# SECURITY ###################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Warning: since Redis is pretty fast an outside user can try up to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 million passwords per second against a modern box. This means that you</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> should use very strong passwords, otherwise they will be very easy to <span class="built_in">break</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that because the password is really a shared secret between the client</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and the server, and should not be memorized by any human, the password</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> can be easily a long string from /dev/urandom or whatever, so by using a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> long and unguessable password no brute force attack will be possible.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis ACL users are defined <span class="keyword">in</span> the following format:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   user &lt;username&gt; ... acl rules ...</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For example:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   user worker +@list +@connection ~<span class="built_in">jobs</span>:* on &gt;ffa9203c493aa99</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The special username <span class="string">&quot;default&quot;</span> is used <span class="keyword">for</span> new connections. If this user</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> has the <span class="string">&quot;nopass&quot;</span> rule, <span class="keyword">then</span> new connections will be immediately authenticated</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as the <span class="string">&quot;default&quot;</span> user without the need of any password provided via the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTH <span class="built_in">command</span>. Otherwise <span class="keyword">if</span> the <span class="string">&quot;default&quot;</span> user is not flagged with <span class="string">&quot;nopass&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the connections will start <span class="keyword">in</span> not authenticated state, and will require</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTH (or the HELLO <span class="built_in">command</span> AUTH option) <span class="keyword">in</span> order to be authenticated and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> start to work.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ACL rules that describe what an user can <span class="keyword">do</span> are the following:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  on           Enable the user: it is possible to authenticate as this user.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  off          Disable the user: it<span class="string">&#x27;s no longer possible to authenticate</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">               with this user, however the already authenticated connections</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               will still work.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  +&lt;<span class="built_in">command</span>&gt;   Allow the execution of that <span class="built_in">command</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  -&lt;<span class="built_in">command</span>&gt;   Disallow the execution of that <span class="built_in">command</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  +@&lt;category&gt; Allow the execution of all the commands <span class="keyword">in</span> such category</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               with valid categories are like @admin, @<span class="built_in">set</span>, @sortedset, ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               and so forth, see the full list <span class="keyword">in</span> the server.c file <span class="built_in">where</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">               the Redis <span class="built_in">command</span> table is described and defined.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               The special category @all means all the commands, but currently</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               present <span class="keyword">in</span> the server, and that will be loaded <span class="keyword">in</span> the future</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               via modules.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  +&lt;<span class="built_in">command</span>&gt;|subcommand    Allow a specific subcommand of an otherwise</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                           disabled <span class="built_in">command</span>. Note that this form is not</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                           allowed as negative like -DEBUG|SEGFAULT, but</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                           only additive starting with <span class="string">&quot;+&quot;</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  allcommands  Alias <span class="keyword">for</span> +@all. Note that it implies the ability to execute</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               all the future commands loaded via the modules system.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  nocommands   Alias <span class="keyword">for</span> -@all.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  ~&lt;pattern&gt;   Add a pattern of keys that can be mentioned as part of</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               commands. For instance ~* allows all the keys. The pattern</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               is a glob-style pattern like the one of KEYS.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               It is possible to specify multiple patterns.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  allkeys      Alias <span class="keyword">for</span> ~*</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  resetkeys    Flush the list of allowed keys patterns.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  &gt;&lt;password&gt;  Add this passowrd to the list of valid password <span class="keyword">for</span> the user.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               For example &gt;mypass will add <span class="string">&quot;mypass&quot;</span> to the list.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               This directive clears the <span class="string">&quot;nopass&quot;</span> flag (see later).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  &lt;&lt;<span class="string">password&gt;  Remove this password</span> from the list of valid passwords.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  nopass       All the <span class="built_in">set</span> passwords of the user are removed, and the user</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               is flagged as requiring no password: it means that every</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               password will work against this user. If this directive is</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               used <span class="keyword">for</span> the default user, every new connection will be</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               immediately authenticated with the default user without</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               any explicit AUTH <span class="built_in">command</span> required. Note that the <span class="string">&quot;resetpass&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">               directive will clear this condition.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  resetpass    Flush the list of allowed passwords. Moreover removes the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               <span class="string">&quot;nopass&quot;</span> status. After <span class="string">&quot;resetpass&quot;</span> the user has no associated</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               passwords and there is no way to authenticate without adding</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               some password (or setting it as <span class="string">&quot;nopass&quot;</span> later).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  reset        Performs the following actions: resetpass, resetkeys, off,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               -@all. The user returns to the same state it has immediately</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               after its creation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ACL rules can be specified <span class="keyword">in</span> any order: <span class="keyword">for</span> instance you can start with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> passwords, <span class="keyword">then</span> flags, or key patterns. However note that the additive</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and subtractive rules will CHANGE MEANING depending on the ordering.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For instance see the following example:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   user alice on +@all -DEBUG ~* &gt;somepassword</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This will allow <span class="string">&quot;alice&quot;</span> to use all the commands with the exception of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEBUG <span class="built_in">command</span>, since +@all added all the commands to the <span class="built_in">set</span> of the commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> alice can use, and later DEBUG was removed. However <span class="keyword">if</span> we invert the order</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of two ACL rules the result will be different:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   user alice on -DEBUG +@all ~* &gt;somepassword</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Now DEBUG was removed when alice had yet no commands <span class="keyword">in</span> the <span class="built_in">set</span> of allowed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> commands, later all the commands are added, so the user will be able to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> execute everything.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Basically ACL rules are processed left-to-right.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For more information about ACL configuration please refer to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the Redis web site at https://redis.io/topics/acl</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ACL LOG</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ACL Log tracks failed commands and authentication events associated</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with ACLs. The ACL Log is useful to troubleshoot failed commands blocked </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> by ACLs. The ACL Log is stored <span class="keyword">in</span> memory. You can reclaim memory with </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ACL LOG RESET. Define the maximum entry length of the ACL Log below.</span></span><br><span class="line">acllog-max-len 128</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Using an external ACL file</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Instead of configuring users here <span class="keyword">in</span> this file, it is possible to use</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a stand-alone file just listing users. The two methods cannot be mixed:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> you configure users here and at the same time you activate the exteranl</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ACL file, the server will refuse to start.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The format of the external ACL user file is exactly the same as the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> format that is used inside redis.conf to describe users.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> aclfile /etc/redis/users.acl</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> IMPORTANT NOTE: starting with Redis 6 <span class="string">&quot;requirepass&quot;</span> is just a compatiblity</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> layer on top of the new ACL system. The option effect will be just setting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the password <span class="keyword">for</span> the default user. Clients will still authenticate using</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTH &lt;password&gt; as usually, or more explicitly with AUTH default &lt;password&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> they follow the new protocol: both will work.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> requirepass foobared</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Command renaming (DEPRECATED).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WARNING: avoid using this option <span class="keyword">if</span> possible. Instead use ACLs to remove</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> commands from the default user, and put them only <span class="keyword">in</span> some admin user you</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> create <span class="keyword">for</span> administrative purposes.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is possible to change the name of dangerous commands <span class="keyword">in</span> a shared</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> environment. For instance the CONFIG <span class="built_in">command</span> may be renamed into something</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> hard to guess so that it will still be available <span class="keyword">for</span> internal-use tools</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> but not available <span class="keyword">for</span> general clients.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is also possible to completely <span class="built_in">kill</span> a <span class="built_in">command</span> by renaming it into</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> an empty string:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rename-command CONFIG <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Please note that changing the name of commands that are logged into the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF file or transmitted to replicas may cause problems.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################## CLIENTS ####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set the max number of connected clients at the same time. By default</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this <span class="built_in">limit</span> is <span class="built_in">set</span> to 10000 clients, however <span class="keyword">if</span> the Redis server is not</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> able to configure the process file <span class="built_in">limit</span> to allow <span class="keyword">for</span> the specified <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the max number of allowed clients is <span class="built_in">set</span> to the current file <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> minus 32 (as Redis reserves a few file descriptors <span class="keyword">for</span> internal uses).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Once the <span class="built_in">limit</span> is reached Redis will close all the new connections sending</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> an error <span class="string">&#x27;max number of clients reached&#x27;</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IMPORTANT: When Redis Cluster is used, the max number of connections is also</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> shared with the cluster bus: every node <span class="keyword">in</span> the cluster will use two</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> connections, one incoming and another outgoing. It is important to size the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">limit</span> accordingly <span class="keyword">in</span> <span class="keyword">case</span> of very large clusters.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maxclients 10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################# MEMORY MANAGEMENT ################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set a memory usage <span class="built_in">limit</span> to the specified amount of bytes.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When the memory <span class="built_in">limit</span> is reached Redis will try to remove keys</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> according to the eviction policy selected (see maxmemory-policy).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If Redis can<span class="string">&#x27;t remove keys according to the policy, or if the policy is</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> to <span class="string">&#x27;noeviction&#x27;</span>, Redis will start to reply with errors to commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that would use more memory, like SET, LPUSH, and so on, and will <span class="built_in">continue</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to reply to read-only commands like GET.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This option is usually useful when using Redis as an LRU or LFU cache, or to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> a hard memory <span class="built_in">limit</span> <span class="keyword">for</span> an instance (using the <span class="string">&#x27;noeviction&#x27;</span> policy).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WARNING: If you have replicas attached to an instance with maxmemory on,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the size of the output buffers needed to feed the replicas are subtracted</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> from the used memory count, so that network problems / resyncs will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> not trigger a loop <span class="built_in">where</span> keys are evicted, and <span class="keyword">in</span> turn the output</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> buffer of replicas is full with DELs of keys evicted triggering the deletion</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of more keys, and so forth until the database is completely emptied.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In short... <span class="keyword">if</span> you have replicas attached it is suggested that you <span class="built_in">set</span> a lower</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">limit</span> <span class="keyword">for</span> maxmemory so that there is some free RAM on the system <span class="keyword">for</span> replica</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> output buffers (but this is not needed <span class="keyword">if</span> the policy is <span class="string">&#x27;noeviction&#x27;</span>).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maxmemory &lt;bytes&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is reached. You can select one from the following behaviors:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-lru -&gt; Evict using approximated LRU, only keys with an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-lru -&gt; Evict any key using approximated LRU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-lfu -&gt; Evict any key using approximated LFU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-random -&gt; Remove a random key having an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-random -&gt; Remove a random key, any key.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> noeviction -&gt; Don<span class="string">&#x27;t evict anything, just return an error on write operations.</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LRU means Least Recently Used</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LFU means Least Frequently Used</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Both LRU, LFU and volatile-ttl are implemented using approximated</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> randomized algorithms.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: with any of the above policies, Redis will <span class="built_in">return</span> an error on write</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       operations, when there are no suitable keys <span class="keyword">for</span> eviction.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       At the date of writing these commands are: <span class="built_in">set</span> setnx setex append</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       getset mset msetnx <span class="built_in">exec</span> sort</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default is:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maxmemory-policy noeviction</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> LRU, LFU and minimal TTL algorithms are not precise algorithms but approximated</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> algorithms (<span class="keyword">in</span> order to save memory), so you can tune it <span class="keyword">for</span> speed or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> accuracy. For default Redis will check five keys and pick the one that was</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used less recently, you can change the sample size using the following</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configuration directive.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default of 5 produces good enough results. 10 Approximates very closely</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="literal">true</span> LRU but costs more CPU. 3 is faster but not very accurate.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maxmemory-samples 5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Starting from Redis 5, by default a replica will ignore its maxmemory setting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (unless it is promoted to master after a failover or manually). It means</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that the eviction of keys will be just handled by the master, sending the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEL commands to the replica as keys evict <span class="keyword">in</span> the master side.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This behavior ensures that masters and replicas stay consistent, and is usually</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> what you want, however <span class="keyword">if</span> your replica is writable, or you want the replica</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to have a different memory setting, and you are sure all the writes performed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to the replica are idempotent, <span class="keyword">then</span> you may change this default (but be sure</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to understand what you are doing).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that since the replica by default does not evict, it may end using more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> memory than the one <span class="built_in">set</span> via maxmemory (there are certain buffers that may</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be larger on the replica, or data structures may sometimes take more memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and so forth). So make sure you monitor your replicas and make sure they</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> have enough memory to never hit a real out-of-memory condition before the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master hits the configured maxmemory setting.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica-ignore-maxmemory yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis reclaims expired keys <span class="keyword">in</span> two ways: upon access when those keys are</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> found to be expired, and also <span class="keyword">in</span> background, <span class="keyword">in</span> what is called the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;active expire key&quot;</span>. The key space is slowly and interactively scanned</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> looking <span class="keyword">for</span> expired keys to reclaim, so that it is possible to free memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of keys that are expired and will never be accessed again <span class="keyword">in</span> a short time.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default effort of the expire cycle will try to avoid having more than</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ten percent of expired keys still <span class="keyword">in</span> memory, and will try to avoid consuming</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> more than 25% of total memory and to add latency to the system. However</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it is possible to increase the expire <span class="string">&quot;effort&quot;</span> that is normally <span class="built_in">set</span> to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;1&quot;</span>, to a greater value, up to the value <span class="string">&quot;10&quot;</span>. At its maximum value the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> system will use more CPU, longer cycles (and technically may introduce</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> more latency), and will tollerate less already expired keys still present</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the system. It<span class="string">&#x27;s a tradeoff betweeen memory, CPU and latecy.</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-expire-effort 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ LAZY FREEING ####################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis has two primitives to delete keys. One is called DEL and is a blocking</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> deletion of the object. It means that the server stops processing new commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to reclaim all the memory associated with an object <span class="keyword">in</span> a synchronous</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> way. If the key deleted is associated with a small object, the time needed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to execute the DEL <span class="built_in">command</span> is very small and comparable to most other</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> O(1) or O(log_N) commands <span class="keyword">in</span> Redis. However <span class="keyword">if</span> the key is associated with an</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> aggregated value containing millions of elements, the server can block <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a long time (even seconds) <span class="keyword">in</span> order to complete the operation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For the above reasons Redis also offers non blocking deletion primitives</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> such as UNLINK (non blocking DEL) and the ASYNC option of FLUSHALL and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FLUSHDB commands, <span class="keyword">in</span> order to reclaim memory <span class="keyword">in</span> background. Those commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> are executed <span class="keyword">in</span> constant time. Another thread will incrementally free the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> object <span class="keyword">in</span> the background as fast as possible.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEL, UNLINK and ASYNC option of FLUSHALL and FLUSHDB are user-controlled.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It<span class="string">&#x27;s up to the design of the application to understand when it is a good</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> idea to use one or the other. However the Redis server sometimes has to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> delete keys or flush the whole database as a side effect of other operations.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specifically Redis deletes objects independently of a user call <span class="keyword">in</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> following scenarios:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) On eviction, because of the maxmemory and maxmemory policy configurations,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">in</span> order to make room <span class="keyword">for</span> new data, without going over the specified</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    memory <span class="built_in">limit</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Because of expire: when a key with an associated time to live (see the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    EXPIRE <span class="built_in">command</span>) must be deleted from memory.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3) Because of a side effect of a <span class="built_in">command</span> that stores data on a key that may</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    already exist. For example the RENAME <span class="built_in">command</span> may delete the old key</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    content when it is replaced with another one. Similarly SUNIONSTORE</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    or SORT with STORE option may delete existing keys. The SET <span class="built_in">command</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    itself removes any old content of the specified key <span class="keyword">in</span> order to replace</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    it with the specified string.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4) During replication, when a replica performs a full resynchronization with</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    its master, the content of the whole database is removed <span class="keyword">in</span> order to</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    load the RDB file just transferred.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In all the above cases the default is to delete objects <span class="keyword">in</span> a blocking way,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> like <span class="keyword">if</span> DEL was called. However you can configure each <span class="keyword">case</span> specifically</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to instead release memory <span class="keyword">in</span> a non-blocking way like <span class="keyword">if</span> UNLINK</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> was called, using the following configuration directives.</span></span><br><span class="line"></span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is also possible, <span class="keyword">for</span> the <span class="keyword">case</span> when to replace the user code DEL calls</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with UNLINK calls is not easy, to modify the default behavior of the DEL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">command</span> to act exactly like UNLINK, using the following configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> directive:</span></span><br><span class="line"></span><br><span class="line">lazyfree-lazy-user-del no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### THREADED I/O #################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis is mostly single threaded, however there are certain threaded</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> operations such as UNLINK, slow I/O accesses and other things that are</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> performed on side threads.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Now it is also possible to handle Redis clients socket reads and writes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> different I/O threads. Since especially writing is so slow, normally</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis users use pipelining <span class="keyword">in</span> order to speedup the Redis performances per</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> core, and spawn multiple instances <span class="keyword">in</span> order to scale more. Using I/O</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threads it is possible to easily speedup two <span class="built_in">times</span> Redis without resorting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to pipelining nor sharding of the instance.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default threading is disabled, we suggest enabling it only <span class="keyword">in</span> machines</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that have at least 4 or more cores, leaving at least one spare core.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Using more than 8 threads is unlikely to <span class="built_in">help</span> much. We also recommend using</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threaded I/O only <span class="keyword">if</span> you actually have performance problems, with Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> instances being able to use a quite big percentage of CPU time, otherwise</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> there is no point <span class="keyword">in</span> using this feature.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> So <span class="keyword">for</span> instance <span class="keyword">if</span> you have a four cores boxes, try to use 2 or 3 I/O</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threads, <span class="keyword">if</span> you have a 8 cores, try to use 6 threads. In order to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">enable</span> I/O threads use the following configuration directive:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> io-threads 4</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Setting io-threads to 1 will just use the main thread as usually.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When I/O threads are enabled, we only use threads <span class="keyword">for</span> writes, that is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to thread the write(2) syscall and transfer the client buffers to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> socket. However it is also possible to <span class="built_in">enable</span> threading of reads and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> protocol parsing using the following configuration directive, by setting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it to yes:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> io-threads-do-reads no</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Usually threading reads doesn<span class="string">&#x27;t help much.</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NOTE 1: This configuration directive cannot be changed at runtime via</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG SET. Aso this feature currently does not work when SSL is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enabled.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NOTE 2: If you want to <span class="built_in">test</span> the Redis speedup using redis-benchmark, make</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sure you also run the benchmark itself <span class="keyword">in</span> threaded mode, using the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --threads option to match the number of Redis theads, otherwise you<span class="string">&#x27;ll not</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be able to notice the improvements.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########################### KERNEL OOM CONTROL ##############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> On Linux, it is possible to hint the kernel OOM killer on what processes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> should be killed first when out of memory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Enabling this feature makes Redis actively control the oom_score_adj value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> all its processes, depending on their role. The default scores will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> attempt to have background child processes killed before all others, and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replicas killed before masters.</span></span><br><span class="line"></span><br><span class="line">oom-score-adj no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When oom-score-adj is used, this directive controls the specific values used</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> master, replica and background child processes. Values range -1000 to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1000 (higher means more likely to be killed).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unprivileged processes (not root, and without CAP_SYS_RESOURCE capabilities)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> can freely increase their value, but not decrease it below its initial</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> settings.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Values are used relative to the initial value of oom_score_adj when the server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> starts. Because typically the initial value is 0, they will often match the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> absolute values.</span></span><br><span class="line"></span><br><span class="line">oom-score-adj-values 0 200 800</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################# APPEND ONLY MODE ###############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis asynchronously dumps the dataset on disk. This mode is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> good enough <span class="keyword">in</span> many applications, but an issue with the Redis process or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a power outage may result into a few minutes of writes lost (depending on</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the configured save points).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Append Only File is an alternative persistence mode that provides</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> much better durability. For instance using the default data fsync policy</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (see later <span class="keyword">in</span> the config file) Redis can lose just one second of writes <span class="keyword">in</span> a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dramatic event like a server power outage, or a single write <span class="keyword">if</span> something</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wrong with the Redis process itself happens, but the operating system is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> still running correctly.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF and RDB persistence can be enabled at the same time without problems.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If the AOF is enabled on startup Redis will load the AOF, that is the file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the better durability guarantees.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Please check http://redis.io/topics/persistence <span class="keyword">for</span> more information.</span></span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The name of the append only file (default: <span class="string">&quot;appendonly.aof&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The fsync() call tells the Operating System to actually write data on disk</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> instead of waiting <span class="keyword">for</span> more data <span class="keyword">in</span> the output buffer. Some OS will really flush</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> data on disk, some other OS will just try to <span class="keyword">do</span> it ASAP.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis supports three different modes:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> no: don<span class="string">&#x27;t fsync, just let the OS flush the data when it wants. Faster.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> always: fsync after every write to the append only <span class="built_in">log</span>. Slow, Safest.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> everysec: fsync only one time every second. Compromise.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default is <span class="string">&quot;everysec&quot;</span>, as that<span class="string">&#x27;s usually the right compromise between</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> speed and data safety. It<span class="string">&#x27;s up to you to understand if you can relax this to</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;no&quot;</span> that will <span class="built_in">let</span> the operating system flush the output buffer when</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it wants, <span class="keyword">for</span> better performances (but <span class="keyword">if</span> you can live with the idea of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> some data loss consider the default persistence mode that<span class="string">&#x27;s snapshotting),</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or on the contrary, use <span class="string">&quot;always&quot;</span> that<span class="string">&#x27;s very slow but a bit safer than</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> everysec.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> More details please check the following article:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://antirez.com/post/redis-persistence-demystified.html</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If unsure, use <span class="string">&quot;everysec&quot;</span>.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta">#</span><span class="bash"> appendfsync no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When the AOF fsync policy is <span class="built_in">set</span> to always or everysec, and a background</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> saving process (a background save or AOF <span class="built_in">log</span> background rewriting) is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> performing a lot of I/O against the disk, <span class="keyword">in</span> some Linux configurations</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis may block too long on the fsync() call. Note that there is no fix <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this currently, as even performing fsync <span class="keyword">in</span> a different thread will block</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> our synchronous write(2) call.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In order to mitigate this problem it<span class="string">&#x27;s possible to use the following option</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that will prevent fsync() from being called <span class="keyword">in</span> the main process <span class="keyword">while</span> a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> BGSAVE or BGREWRITEAOF is <span class="keyword">in</span> progress.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This means that <span class="keyword">while</span> another child is saving, the durability of Redis is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the same as <span class="string">&quot;appendfsync none&quot;</span>. In practical terms, this means that it is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> possible to lose up to 30 seconds of <span class="built_in">log</span> <span class="keyword">in</span> the worst scenario (with the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default Linux settings).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you have latency problems turn this to <span class="string">&quot;yes&quot;</span>. Otherwise leave it as</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;no&quot;</span> that is the safest pick from the point of view of durability.</span></span><br><span class="line"></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Automatic rewrite of the append only file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis is able to automatically rewrite the <span class="built_in">log</span> file implicitly calling</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> BGREWRITEAOF when the AOF <span class="built_in">log</span> size grows by the specified percentage.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is how it works: Redis remembers the size of the AOF file after the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> latest rewrite (<span class="keyword">if</span> no rewrite has happened since the restart, the size of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the AOF at startup is used).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This base size is compared to the current size. If the current size is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bigger than the specified percentage, the rewrite is triggered. Also</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you need to specify a minimal size <span class="keyword">for</span> the AOF file to be rewritten, this</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is useful to avoid rewriting the AOF file even <span class="keyword">if</span> the percentage increase</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is reached but it is still pretty small.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Specify a percentage of zero <span class="keyword">in</span> order to <span class="built_in">disable</span> the automatic AOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rewrite feature.</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> An AOF file may be found to be truncated at the end during the Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> startup process, when the AOF data gets loaded back into memory.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This may happen when the system <span class="built_in">where</span> Redis is running</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> crashes, especially when an ext4 filesystem is mounted without the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> data=ordered option (however this can<span class="string">&#x27;t happen when Redis itself</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> crashes or aborts but the operating system still works correctly).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis can either <span class="built_in">exit</span> with an error when this happens, or load as much</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> data as possible (the default now) and start <span class="keyword">if</span> the AOF file is found</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to be truncated at the end. The following option controls this behavior.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If aof-load-truncated is <span class="built_in">set</span> to yes, a truncated AOF file is loaded and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the Redis server starts emitting a <span class="built_in">log</span> to inform the user of the event.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Otherwise <span class="keyword">if</span> the option is <span class="built_in">set</span> to no, the server aborts with an error</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and refuses to start. When the option is <span class="built_in">set</span> to no, the user requires</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to fix the AOF file using the <span class="string">&quot;redis-check-aof&quot;</span> utility before to restart</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the server.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that <span class="keyword">if</span> the AOF file will be found to be corrupted <span class="keyword">in</span> the middle</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the server will still <span class="built_in">exit</span> with an error. This option only applies when</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis will try to <span class="built_in">read</span> more data from the AOF file but not enough bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will be found.</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When rewriting the AOF file, Redis is able to use an RDB preamble <span class="keyword">in</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF file <span class="keyword">for</span> faster rewrites and recoveries. When this option is turned</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on the rewritten AOF file is composed of two different stanzas:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   [RDB file][AOF tail]</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When loading Redis recognizes that the AOF file starts with the <span class="string">&quot;REDIS&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> string and loads the prefixed RDB file, and continues loading the AOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tail.</span></span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### LUA SCRIPTING  ###############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Max execution time of a Lua script <span class="keyword">in</span> milliseconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If the maximum execution time is reached Redis will <span class="built_in">log</span> that a script is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> still <span class="keyword">in</span> execution after the maximum allowed time and will start to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reply to queries with an error.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When a long running script exceeds the maximum execution time only the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used to stop a script that did not yet called write commands. The second</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is the only way to shut down the server <span class="keyword">in</span> the <span class="keyword">case</span> a write <span class="built_in">command</span> was</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> already issued by the script but the user doesn<span class="string">&#x27;t want to wait for the natural</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> termination of the script.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set it to 0 or a negative value <span class="keyword">for</span> unlimited execution without warnings.</span></span><br><span class="line">lua-time-limit 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### REDIS CLUSTER  ###############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Normal Redis instances can<span class="string">&#x27;t be part of a Redis Cluster; only nodes that are</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> started as cluster nodes can. In order to start a Redis instance as a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster node <span class="built_in">enable</span> the cluster support uncommenting the following:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-enabled yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Every cluster node has a cluster configuration file. This file is not</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> intended to be edited by hand. It is created and updated by Redis nodes.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Every Redis Cluster node requires a different cluster configuration file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Make sure that instances running <span class="keyword">in</span> the same system <span class="keyword">do</span> not have</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> overlapping cluster configuration file names.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-config-file nodes-6379.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster node timeout is the amount of milliseconds a node must be unreachable</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> it to be considered <span class="keyword">in</span> failure state.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most other internal time limits are multiple of the node timeout.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-node-timeout 15000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A replica of a failing master will avoid to start a failover <span class="keyword">if</span> its data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> looks too old.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> There is no simple way <span class="keyword">for</span> a replica to actually have an exact measure of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> its <span class="string">&quot;data age&quot;</span>, so the following two checks are performed:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) If there are multiple replicas able to failover, they exchange messages</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="keyword">in</span> order to try to give an advantage to the replica with the best</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    replication offset (more data from the master processed).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    Replicas will try to get their rank by offset, and apply to the start</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    of the failover a delay proportional to their rank.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) Every single replica computes the time of the last interaction with</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    its master. This can be the last ping or <span class="built_in">command</span> received (<span class="keyword">if</span> the master</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    is still <span class="keyword">in</span> the <span class="string">&quot;connected&quot;</span> state), or the time that elapsed since the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    disconnection with the master (<span class="keyword">if</span> the replication link is currently down).</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    If the last interaction is too old, the replica will not try to failover</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    at all.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The point <span class="string">&quot;2&quot;</span> can be tuned by user. Specifically a replica will not perform</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the failover <span class="keyword">if</span>, since the last interaction with the master, the time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> elapsed is greater than:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   (node-timeout * replica-validity-factor) + repl-ping-replica-period</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> So <span class="keyword">for</span> example <span class="keyword">if</span> node-timeout is 30 seconds, and the replica-validity-factor</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is 10, and assuming a default repl-ping-replica-period of 10 seconds, the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica will not try to failover <span class="keyword">if</span> it was not able to talk with the master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> longer than 310 seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A large replica-validity-factor may allow replicas with too old data to failover</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a master, <span class="keyword">while</span> a too small value may prevent the cluster from being able to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> elect a replica at all.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For maximum availability, it is possible to <span class="built_in">set</span> the replica-validity-factor</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to a value of 0, <span class="built_in">which</span> means, that replicas will always try to failover the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master regardless of the last time they interacted with the master.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (However they<span class="string">&#x27;ll always try to apply a delay proportional to their</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> offset rank).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Zero is the only value able to guarantee that when all the partitions heal</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the cluster will always be able to <span class="built_in">continue</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-replica-validity-factor 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster replicas are able to migrate to orphaned masters, that are masters</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that are left without working replicas. This improves the cluster ability</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to resist to failures as otherwise an orphaned master can<span class="string">&#x27;t be failed over</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> <span class="keyword">case</span> of failure <span class="keyword">if</span> it has no working replicas.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replicas migrate to orphaned masters only <span class="keyword">if</span> there are still at least a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> given number of other working replicas <span class="keyword">for</span> their old master. This number</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is the <span class="string">&quot;migration barrier&quot;</span>. A migration barrier of 1 means that a replica</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will migrate only <span class="keyword">if</span> there is at least 1 other working replica <span class="keyword">for</span> its master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and so forth. It usually reflects the number of replicas you want <span class="keyword">for</span> every</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master <span class="keyword">in</span> your cluster.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Default is 1 (replicas migrate only <span class="keyword">if</span> their masters remain with at least</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> one replica). To <span class="built_in">disable</span> migration just <span class="built_in">set</span> it to a very large value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A value of 0 can be <span class="built_in">set</span> but is useful only <span class="keyword">for</span> debugging and dangerous</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> production.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-migration-barrier 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis Cluster nodes stop accepting queries <span class="keyword">if</span> they detect there</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is at least an <span class="built_in">hash</span> slot uncovered (no available node is serving it).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This way <span class="keyword">if</span> the cluster is partially down (<span class="keyword">for</span> example a range of <span class="built_in">hash</span> slots</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> are no longer covered) all the cluster becomes, eventually, unavailable.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It automatically returns available as soon as all the slots are covered again.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However sometimes you want the subset of the cluster <span class="built_in">which</span> is working,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to <span class="built_in">continue</span> to accept queries <span class="keyword">for</span> the part of the key space that is still</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> covered. In order to <span class="keyword">do</span> so, just <span class="built_in">set</span> the cluster-require-full-coverage</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> option to no.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-require-full-coverage yes</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This option, when <span class="built_in">set</span> to yes, prevents replicas from trying to failover its</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master during master failures. However the master can still perform a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> manual failover, <span class="keyword">if</span> forced to <span class="keyword">do</span> so.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is useful <span class="keyword">in</span> different scenarios, especially <span class="keyword">in</span> the <span class="keyword">case</span> of multiple</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> data center operations, <span class="built_in">where</span> we want one side to never be promoted <span class="keyword">if</span> not</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the <span class="keyword">case</span> of a total DC failure.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-replica-no-failover no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This option, when <span class="built_in">set</span> to yes, allows nodes to serve <span class="built_in">read</span> traffic <span class="keyword">while</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the cluster is <span class="keyword">in</span> a down state, as long as it believes it owns the slots. </span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is useful <span class="keyword">for</span> two cases.  The first <span class="keyword">case</span> is <span class="keyword">for</span> when an application </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> doesn<span class="string">&#x27;t require consistency of data during node failures or network partitions.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> One example of this is a cache, <span class="built_in">where</span> as long as the node has the data it</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> should be able to serve it. </span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The second use <span class="keyword">case</span> is <span class="keyword">for</span> configurations that don<span class="string">&#x27;t meet the recommended  </span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> three shards but want to <span class="built_in">enable</span> cluster mode and scale later. A </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> master outage <span class="keyword">in</span> a 1 or 2 shard configuration causes a <span class="built_in">read</span>/write outage to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> entire cluster without this option <span class="built_in">set</span>, with it <span class="built_in">set</span> there is only a write outage.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Without a quorum of masters, slot ownership will not change automatically. </span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-allow-reads-when-down no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> In order to setup your cluster make sure to <span class="built_in">read</span> the documentation</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> available at http://redis.io web site.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">######################### CLUSTER DOCKER/NAT support  ########################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> In certain deployments, Redis Cluster nodes address discovery fails, because</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> addresses are NAT-ted or because ports are forwarded (the typical <span class="keyword">case</span> is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Docker and other containers).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In order to make Redis Cluster working <span class="keyword">in</span> such environments, a static</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configuration <span class="built_in">where</span> each node knows its public address is needed. The</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> following two options are used <span class="keyword">for</span> this scope, and are:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> * cluster-announce-ip</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> * cluster-announce-port</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> * cluster-announce-bus-port</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Each instruct the node about its address, client port, and cluster message</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bus port. The information is <span class="keyword">then</span> published <span class="keyword">in</span> the header of the bus packets</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> so that other nodes will be able to correctly map the address of the node</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> publishing the information.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If the above options are not used, the normal Redis Cluster auto-detection</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will be used instead.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that when remapped, the bus port may not be at the fixed offset of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> clients port + 10000, so you can specify any port and bus-port depending</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on how they get remapped. If the bus-port is not <span class="built_in">set</span>, a fixed offset of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10000 will be used as usually.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-announce-ip 10.1.1.5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-announce-port 6379</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster-announce-bus-port 6380</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################# SLOW LOG ###################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Redis Slow Log is a system to <span class="built_in">log</span> queries that exceeded a specified</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> execution time. The execution time does not include the I/O operations</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> like talking with the client, sending the reply and so forth,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> but just the time needed to actually execute the <span class="built_in">command</span> (this is the only</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> stage of <span class="built_in">command</span> execution <span class="built_in">where</span> the thread is blocked and can not serve</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> other requests <span class="keyword">in</span> the meantime).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can configure the slow <span class="built_in">log</span> with two parameters: one tells Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> what is the execution time, <span class="keyword">in</span> microseconds, to exceed <span class="keyword">in</span> order <span class="keyword">for</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">command</span> to get logged, and the other parameter is the length of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> slow <span class="built_in">log</span>. When a new <span class="built_in">command</span> is logged the oldest one is removed from the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> queue of logged commands.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following time is expressed <span class="keyword">in</span> microseconds, so 1000000 is equivalent</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to one second. Note that a negative number disables the slow <span class="built_in">log</span>, <span class="keyword">while</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a value of zero forces the logging of every <span class="built_in">command</span>.</span></span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> There is no <span class="built_in">limit</span> to this length. Just be aware that it will consume memory.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can reclaim memory used by the slow <span class="built_in">log</span> with SLOWLOG RESET.</span></span><br><span class="line">slowlog-max-len 128</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################### LATENCY MONITOR ##############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Redis latency monitoring subsystem samples different operations</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> at runtime <span class="keyword">in</span> order to collect data related to possible sources of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> latency of a Redis instance.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Via the LATENCY <span class="built_in">command</span> this information is available to the user that can</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">print</span> graphs and obtain reports.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The system only logs operations that were performed <span class="keyword">in</span> a time equal or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> greater than the amount of milliseconds specified via the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> latency-monitor-threshold configuration directive. When its value is <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to zero, the latency monitor is turned off.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default latency monitoring is disabled since it is mostly not needed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> you don<span class="string">&#x27;t have latency issues, and collecting data has a performance</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> impact, that <span class="keyword">while</span> very small, can be measured under big load. Latency</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> monitoring can easily be enabled at runtime using the <span class="built_in">command</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;&quot;</span> <span class="keyword">if</span> needed.</span></span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ EVENT NOTIFICATION ##############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis can notify Pub/Sub clients about events happening <span class="keyword">in</span> the key space.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This feature is documented at http://redis.io/topics/notifications</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For instance <span class="keyword">if</span> keyspace events notification is enabled, and a client</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> performs a DEL operation on key <span class="string">&quot;foo&quot;</span> stored <span class="keyword">in</span> the Database 0, two</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> messages will be published via Pub/Sub:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PUBLISH __keyspace@0__:foo del</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PUBLISH __keyevent@0__:del foo</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is possible to select the events that Redis will notify among a <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of classes. Every class is identified by a single character:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  $     String commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  l     List commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  s     Set commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  h     Hash commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  z     Sorted <span class="built_in">set</span> commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  x     Expired events (events generated every time a key expires)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  e     Evicted events (events generated when a key is evicted <span class="keyword">for</span> maxmemory)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  t     Stream commands</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  m     Key-miss events (Note: It is not included <span class="keyword">in</span> the <span class="string">&#x27;A&#x27;</span> class)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  A     Alias <span class="keyword">for</span> g<span class="variable">$lshzxet</span>, so that the <span class="string">&quot;AKE&quot;</span> string means all the events</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        (Except key-miss events <span class="built_in">which</span> are excluded from <span class="string">&#x27;A&#x27;</span> due to their</span></span><br><span class="line"><span class="meta">#</span><span class="bash">         unique nature).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  The <span class="string">&quot;notify-keyspace-events&quot;</span> takes as argument a string that is composed</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  of zero or multiple characters. The empty string means that notifications</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  are disabled.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  Example: to <span class="built_in">enable</span> list and generic events, from the point of view of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">           event name, use:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  notify-keyspace-events Elg</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  Example 2: to get the stream of the expired keys subscribing to channel</span></span><br><span class="line"><span class="meta">#</span><span class="bash">             name __keyevent@0__:expired use:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  notify-keyspace-events Ex</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  By default all notifications are disabled because most users don<span class="string">&#x27;t need</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  this feature and the feature has some overhead. Note that <span class="keyword">if</span> you don<span class="string">&#x27;t</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  specify at least one of K or E, no events will be delivered.</span></span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################## GOPHER SERVER #################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis contains an implementation of the Gopher protocol, as specified <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the RFC 1436 (https://www.ietf.org/rfc/rfc1436.txt).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Gopher protocol was very popular <span class="keyword">in</span> the late <span class="string">&#x27;90s. It is an alternative</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to the web, and the implementation both server and client side is so simple</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that the Redis server has just 100 lines of code <span class="keyword">in</span> order to implement this</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> support.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> What <span class="keyword">do</span> you <span class="keyword">do</span> with Gopher nowadays? Well Gopher never *really* died, and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lately there is a movement <span class="keyword">in</span> order <span class="keyword">for</span> the Gopher more hierarchical content</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> composed of just plain text documents to be resurrected. Some want a simpler</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> internet, others believe that the mainstream internet became too much</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> controlled, and it<span class="string">&#x27;s cool to create an alternative space for people that</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> want a bit of fresh air.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Anyway <span class="keyword">for</span> the 10nth birthday of the Redis, we gave it the Gopher protocol</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as a gift.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --- HOW IT WORKS? ---</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Redis Gopher support uses the inline protocol of Redis, and specifically</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> two kind of inline requests that were anyway illegal: an empty request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or any request that starts with <span class="string">&quot;/&quot;</span> (there are no Redis commands starting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with such a slash). Normal RESP2/RESP3 requests are completely out of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> path of the Gopher protocol implementation and are served as usually as well.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you open a connection to Redis when Gopher is enabled and send it</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a string like <span class="string">&quot;/foo&quot;</span>, <span class="keyword">if</span> there is a key named <span class="string">&quot;/foo&quot;</span> it is served via the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Gopher protocol.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In order to create a real Gopher <span class="string">&quot;hole&quot;</span> (the name of a Gopher site <span class="keyword">in</span> Gopher</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> talking), you likely need a script like the following:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   https://github.com/antirez/gopher2redis</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --- SECURITY WARNING ---</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If you plan to put Redis on the internet <span class="keyword">in</span> a publicly accessible address</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to server Gopher pages MAKE SURE TO SET A PASSWORD to the instance.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Once a password is <span class="built_in">set</span>:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   1. The Gopher server (when enabled, not by default) will still serve</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      content via Gopher.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   2. However other commands cannot be called before the client will</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      authenticate.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> So use the <span class="string">&#x27;requirepass&#x27;</span> option to protect your instance.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> To <span class="built_in">enable</span> Gopher support uncomment the following line and <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the option from no (the default) to yes.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> gopher-enabled no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################## ADVANCED CONFIG ###############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Hashes are encoded using a memory efficient data structure when they have a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> small number of entries, and the biggest entry does not exceed a given</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threshold. These thresholds can be configured using the following directives.</span></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Lists are also encoded <span class="keyword">in</span> a special way to save a lot of space.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of entries allowed per internal list node can be specified</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as a fixed maximum size or a maximum number of elements.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For a fixed maximum size, use -5 through -1, meaning:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -5: max size: 64 Kb  &lt;-- not recommended <span class="keyword">for</span> normal workloads</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -4: max size: 32 Kb  &lt;-- not recommended</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -3: max size: 16 Kb  &lt;-- probably not recommended</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -2: max size: 8 Kb   &lt;-- good</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -1: max size: 4 Kb   &lt;-- good</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Positive numbers mean store up to _exactly_ that number of elements</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> per list node.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> but <span class="keyword">if</span> your use <span class="keyword">case</span> is unique, adjust the settings as necessary.</span></span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Lists may also be compressed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Compress depth is the number of quicklist ziplist nodes from *each* side of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the list to *exclude* from compression.  The head and tail of the list</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> are always uncompressed <span class="keyword">for</span> fast push/pop operations.  Settings are:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0: <span class="built_in">disable</span> all list compression</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1: depth 1 means <span class="string">&quot;don&#x27;t start compressing until after 1 node into the list,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    going from either the head or tail<span class="string">&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    So: [head]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[tail]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    [head], [tail] will always be uncompressed; inner nodes will compress.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2: [head]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[tail]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2 here means: don<span class="string">&#x27;t compress head or head-&gt;next or tail-&gt;prev or tail,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    but compress all nodes between them.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3: [head]-&gt;[next]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[prev]-&gt;[tail]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> etc.</span></span><br><span class="line">list-compress-depth 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sets have a special encoding <span class="keyword">in</span> just one <span class="keyword">case</span>: when a <span class="built_in">set</span> is composed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of just strings that happen to be integers <span class="keyword">in</span> radix 10 <span class="keyword">in</span> the range</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of 64 bit signed integers.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following configuration setting sets the <span class="built_in">limit</span> <span class="keyword">in</span> the size of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> <span class="keyword">in</span> order to use this special memory saving encoding.</span></span><br><span class="line">set-max-intset-entries 512</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Similarly to hashes and lists, sorted sets are also specially encoded <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> order to save a lot of space. This encoding is only used when the length and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> elements of a sorted <span class="built_in">set</span> are below the following limits:</span></span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HyperLogLog sparse representation bytes <span class="built_in">limit</span>. The <span class="built_in">limit</span> includes the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 16 bytes header. When an HyperLogLog using the sparse representation crosses</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this <span class="built_in">limit</span>, it is converted into the dense representation.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A value greater than 16000 is totally useless, since at that point the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dense representation is more memory efficient.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The suggested value is ~ 3000 <span class="keyword">in</span> order to have the benefits of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the space efficient encoding without slowing down too much PFADD,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">which</span> is O(N) with the sparse encoding. The value can be raised to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ~ 10000 when CPU is not a concern, but space is, and the data <span class="built_in">set</span> is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> composed of many HyperLogLogs with cardinality <span class="keyword">in</span> the 0 - 15000 range.</span></span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Streams macro node max size / items. The stream data structure is a radix</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tree of big nodes that encode multiple items inside. Using this configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it is possible to configure how big a single node can be <span class="keyword">in</span> bytes, and the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maximum number of items it may contain before switching to a new node when</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> appending new stream entries. If any of the following settings are <span class="built_in">set</span> to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zero, the <span class="built_in">limit</span> is ignored, so <span class="keyword">for</span> instance it is possible to <span class="built_in">set</span> just a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> max entires <span class="built_in">limit</span> by setting max-bytes to 0 and max-entries to the desired</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> value.</span></span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Active rehashing uses 1 millisecond every 100 milliseconds of CPU time <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> order to <span class="built_in">help</span> rehashing the main Redis <span class="built_in">hash</span> table (the one mapping top-level</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keys to values). The <span class="built_in">hash</span> table implementation Redis uses (see dict.c)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> performs a lazy rehashing: the more operation you run into a <span class="built_in">hash</span> table</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that is rehashing, the more rehashing <span class="string">&quot;steps&quot;</span> are performed, so <span class="keyword">if</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server is idle the rehashing is never complete and some more memory is used</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> by the <span class="built_in">hash</span> table.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default is to use this millisecond 10 <span class="built_in">times</span> every second <span class="keyword">in</span> order to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> actively <span class="built_in">rehash</span> the main dictionaries, freeing memory when possible.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If unsure:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use <span class="string">&quot;activerehashing no&quot;</span> <span class="keyword">if</span> you have hard latency requirements and it is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> not a good thing <span class="keyword">in</span> your environment that Redis can reply from time to time</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to queries with 2 milliseconds delay.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use <span class="string">&quot;activerehashing yes&quot;</span> <span class="keyword">if</span> you don<span class="string">&#x27;t have such hard requirements but</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> want to free memory asap when possible.</span></span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The client output buffer limits can be used to force disconnection of clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that are not reading data from the server fast enough <span class="keyword">for</span> some reason (a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> common reason is that a Pub/Sub client can<span class="string">&#x27;t consume messages as fast as the</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> publisher can produce them).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The <span class="built_in">limit</span> can be <span class="built_in">set</span> differently <span class="keyword">for</span> the three different classes of clients:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> normal -&gt; normal clients including MONITOR clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> replica  -&gt; replica clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> pubsub -&gt; clients subscribed to at least one pubsub channel or pattern</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The syntax of every client-output-buffer-limit directive is the following:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> client-output-buffer-limit &lt;class&gt; &lt;hard <span class="built_in">limit</span>&gt; &lt;soft <span class="built_in">limit</span>&gt; &lt;soft seconds&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A client is immediately disconnected once the hard <span class="built_in">limit</span> is reached, or <span class="keyword">if</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the soft <span class="built_in">limit</span> is reached and remains reached <span class="keyword">for</span> the specified number of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> seconds (continuously).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> So <span class="keyword">for</span> instance <span class="keyword">if</span> the hard <span class="built_in">limit</span> is 32 megabytes and the soft <span class="built_in">limit</span> is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 16 megabytes / 10 seconds, the client will get disconnected immediately</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> the size of the output buffers reach 32 megabytes, but will also get</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> disconnected <span class="keyword">if</span> the client reaches 16 megabytes and continuously overcomes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the <span class="built_in">limit</span> <span class="keyword">for</span> 10 seconds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default normal clients are not limited because they don<span class="string">&#x27;t receive data</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> without asking (<span class="keyword">in</span> a push way), but just after a request, so only</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> asynchronous clients may create a scenario <span class="built_in">where</span> data is requested faster</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> than it can <span class="built_in">read</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Instead there is a default <span class="built_in">limit</span> <span class="keyword">for</span> pubsub and replica clients, since</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> subscribers and replicas receive data <span class="keyword">in</span> a push fashion.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Both the hard or the soft <span class="built_in">limit</span> can be disabled by setting them to zero.</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Client query buffers accumulate new commands. They are limited to a fixed</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> amount by default <span class="keyword">in</span> order to avoid that a protocol desynchronization (<span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> instance due to a bug <span class="keyword">in</span> the client) will lead to unbound memory usage <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the query buffer. However you can configure it here <span class="keyword">if</span> you have very special</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> needs, such us huge multi/<span class="built_in">exec</span> requests or alike.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> client-query-buffer-limit 1gb</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> In the Redis protocol, bulk requests, that are, elements representing single</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> strings, are normally limited ot 512 mb. However you can change this <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> here, but must be 1mb or greater</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> proto-max-bulk-len 512mb</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis calls an internal <span class="keyword">function</span> to perform many background tasks, like</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> closing connections of clients <span class="keyword">in</span> timeout, purging expired keys that are</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> never requested, and so forth.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Not all tasks are performed with the same frequency, but Redis checks <span class="keyword">for</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tasks to perform according to the specified <span class="string">&quot;hz&quot;</span> value.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default <span class="string">&quot;hz&quot;</span> is <span class="built_in">set</span> to 10. Raising the value will use more CPU when</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis is idle, but at the same time will make Redis more responsive when</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> there are many keys expiring at the same time, and timeouts may be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> handled with more precision.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The range is between 1 and 500, however a value over 100 is usually not</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a good idea. Most users should use the default of 10 and raise this up to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 100 only <span class="keyword">in</span> environments <span class="built_in">where</span> very low latency is required.</span></span><br><span class="line">hz 10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Normally it is useful to have an HZ value <span class="built_in">which</span> is proportional to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> number of clients connected. This is useful <span class="keyword">in</span> order, <span class="keyword">for</span> instance, to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> avoid too many clients are processed <span class="keyword">for</span> each background task invocation</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to avoid latency spikes.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since the default HZ value by default is conservatively <span class="built_in">set</span> to 10, Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> offers, and enables by default, the ability to use an adaptive HZ value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">which</span> will temporary raise when there are many connected clients.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When dynamic HZ is enabled, the actual configured HZ will be used</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as a baseline, but multiples of the configured HZ value will be actually</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> used as needed once more clients are connected. In this way an idle</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> instance will use very little CPU time <span class="keyword">while</span> a busy instance will be</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> more responsive.</span></span><br><span class="line">dynamic-hz yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When a child rewrites the AOF file, <span class="keyword">if</span> the following option is enabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the file will be fsync-ed every 32 MB of data generated. This is useful</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to commit the file to the disk more incrementally and avoid</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> big latency spikes.</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> When redis saves RDB file, <span class="keyword">if</span> the following option is enabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the file will be fsync-ed every 32 MB of data generated. This is useful</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> order to commit the file to the disk more incrementally and avoid</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> big latency spikes.</span></span><br><span class="line">rdb-save-incremental-fsync yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis LFU eviction (see maxmemory setting) can be tuned. However it is a good</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> idea to start with the default settings and only change them after investigating</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> how to improve the performances and how the keys LFU change over time, <span class="built_in">which</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> is possible to inspect via the OBJECT FREQ <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> There are two tunable parameters <span class="keyword">in</span> the Redis LFU implementation: the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> counter logarithm factor and the counter decay time. It is important to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> understand what the two parameters mean before changing them.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The LFU counter is just 8 bits per key, it<span class="string">&#x27;s maximum value is 255, so Redis</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> uses a probabilistic increment with logarithmic behavior. Given the value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of the old counter, when a key is accessed, the counter is incremented <span class="keyword">in</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this way:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. A random number R between 0 and 1 is extracted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. A probability P is calculated as 1/(old_value*lfu_log_factor+1).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. The counter is incremented only <span class="keyword">if</span> R &lt; P.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default lfu-log-factor is 10. This is a table of how the frequency</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> counter changes with a different number of accesses with different</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logarithmic factors:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> | factor | 100 hits   | 1000 hits  | 100K hits  | 1M hits    | 10M hits   |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> | 0      | 104        | 255        | 255        | 255        | 255        |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> | 1      | 18         | 49         | 255        | 255        | 255        |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> | 10     | 10         | 18         | 142        | 255        | 255        |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> | 100    | 8          | 11         | 49         | 143        | 255        |</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> +--------+------------+------------+------------+------------+------------+</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NOTE: The above table was obtained by running the following commands:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   redis-benchmark -n 1000000 incr foo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   redis-cli object freq foo</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NOTE 2: The counter initial value is 5 <span class="keyword">in</span> order to give new objects a chance</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to accumulate hits.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The counter decay time is the time, <span class="keyword">in</span> minutes, that must elapse <span class="keyword">in</span> order</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> the key counter to be divided by two (or decremented <span class="keyword">if</span> it has a value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> less &lt;= 10).</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default value <span class="keyword">for</span> the lfu-decay-time is 1. A Special value of 0 means to</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> decay the counter every time it happens to be scanned.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lfu-log-factor 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> lfu-decay-time 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">########################## ACTIVE DEFRAGMENTATION #######################</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> What is active defragmentation?</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -------------------------------</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Active (online) defragmentation allows a Redis server to compact the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> spaces left between small allocations and deallocations of data <span class="keyword">in</span> memory,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> thus allowing to reclaim back memory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Fragmentation is a natural process that happens with every allocator (but</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> less so with Jemalloc, fortunately) and certain workloads. Normally a server</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> restart is needed <span class="keyword">in</span> order to lower the fragmentation, or at least to flush</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> away all the data and create it again. However thanks to this feature</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> implemented by Oran Agra <span class="keyword">for</span> Redis 4.0 this process can happen at runtime</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> an <span class="string">&quot;hot&quot;</span> way, <span class="keyword">while</span> the server is running.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Basically when the fragmentation is over a certain level (see the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configuration options below) Redis will start to create new copies of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> values <span class="keyword">in</span> contiguous memory regions by exploiting certain specific Jemalloc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> features (<span class="keyword">in</span> order to understand <span class="keyword">if</span> an allocation is causing fragmentation</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and to allocate it <span class="keyword">in</span> a better place), and at the same time, will release the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> old copies of the data. This process, repeated incrementally <span class="keyword">for</span> all the keys</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> will cause the fragmentation to drop back to normal values.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Important things to understand:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. This feature is disabled by default, and only works <span class="keyword">if</span> you compiled Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    to use the copy of Jemalloc we ship with the <span class="built_in">source</span> code of Redis.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    This is the default with Linux builds.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. You never need to <span class="built_in">enable</span> this feature <span class="keyword">if</span> you don<span class="string">&#x27;t have fragmentation</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    issues.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. Once you experience fragmentation, you can <span class="built_in">enable</span> this feature when</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    needed with the <span class="built_in">command</span> <span class="string">&quot;CONFIG SET activedefrag yes&quot;</span>.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The configuration parameters are able to fine tune the behavior of the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> defragmentation process. If you are not sure about what they mean it is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> a good idea to leave the defaults untouched.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Enabled active defragmentation</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> activedefrag no</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Minimum amount of fragmentation waste to start active defrag</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-ignore-bytes 100mb</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Minimum percentage of fragmentation to start active defrag</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-threshold-lower 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum percentage of fragmentation at <span class="built_in">which</span> we use maximum effort</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-threshold-upper 100</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Minimal effort <span class="keyword">for</span> defrag <span class="keyword">in</span> CPU percentage, to be used when the lower</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threshold is reached</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-cycle-min 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximal effort <span class="keyword">for</span> defrag <span class="keyword">in</span> CPU percentage, to be used when the upper</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threshold is reached</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-cycle-max 25</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Maximum number of <span class="built_in">set</span>/<span class="built_in">hash</span>/zset/list fields that will be processed from</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the main dictionary scan</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> active-defrag-max-scan-fields 1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Jemalloc background thread <span class="keyword">for</span> purging will be enabled by default</span></span><br><span class="line">jemalloc-bg-thread yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> It is possible to pin different threads and processes of Redis to specific</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CPUs <span class="keyword">in</span> your system, <span class="keyword">in</span> order to maximize the performances of the server.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is useful both <span class="keyword">in</span> order to pin different Redis threads <span class="keyword">in</span> different</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CPUs, but also <span class="keyword">in</span> order to make sure that multiple Redis instances running</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">in</span> the same host will be pinned to different CPUs.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Normally you can <span class="keyword">do</span> this using the <span class="string">&quot;taskset&quot;</span> <span class="built_in">command</span>, however it is also</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> possible to this via Redis configuration directly, both <span class="keyword">in</span> Linux and FreeBSD.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can pin the server/IO threads, bio threads, aof rewrite child process, and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the bgsave child process. The syntax to specify the cpu list is the same as</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the taskset <span class="built_in">command</span>:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set redis server/io threads to cpu affinity 0,2,4,6:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server_cpulist 0-7:2</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set bio threads to cpu affinity 1,3:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bio_cpulist 1,3</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set aof rewrite child process to cpu affinity 8,9,10,11:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> aof_rewrite_cpulist 8-11</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set bgsave child process to cpu affinity 1,10,11</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bgsave_cpulist 1,10-11</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试 redis-cli 连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it 运行的redis服务容器的ID redis-cli</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210602141938779.png" alt="image-20210602141938779"></p>
</li>
<li><p>查看持久化文件生成：</p>
<p><img src="/2021/05/17/docker-base/image-20210602142955037.png" alt="image-20210602142955037"></p>
</li>
</ul>
<h2 id="推送镜像到阿里云"><a href="#推送镜像到阿里云" class="headerlink" title="推送镜像到阿里云"></a>推送镜像到阿里云</h2><h3 id="本地镜像发布到阿里云的流程"><a href="#本地镜像发布到阿里云的流程" class="headerlink" title="本地镜像发布到阿里云的流程"></a>本地镜像发布到阿里云的流程</h3><p><img src="/2021/05/17/docker-base/image-20210602143748392.png" alt="image-20210602143748392"></p>
<h3 id="本地镜像推送到阿里云"><a href="#本地镜像推送到阿里云" class="headerlink" title="本地镜像推送到阿里云"></a>本地镜像推送到阿里云</h3><ul>
<li><p>本地镜像素材原型：</p>
<p><img src="/2021/05/17/docker-base/image-20210602144708714.png" alt="image-20210602144708714"></p>
</li>
<li><p>升级为 1.4 (按需)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker commit [OPTIONS] 容器ID [REPOSITORY[:TAG]]</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/17/docker-base/image-20210602150141742.png" alt="image-20210602150141742"></p>
<blockquote>
<p>-a：提交镜像的作者；-m：提交时的文字说明。</p>
</blockquote>
</li>
<li><p>阿里云开发者平台：</p>
<p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/kubernetes.html">https://promotion.aliyun.com/ntms/act/kubernetes.html</a></p>
<p><img src="/2021/05/17/docker-base/image-20210602144836594.png" alt="image-20210602144836594"></p>
</li>
<li><p>创建镜像仓库：</p>
<p><img src="/2021/05/17/docker-base/image-20210602145700864.png" alt="image-20210602145700864"></p>
</li>
<li><p>将镜像推送到阿里云：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo docker login --username= registry.cn-shenzhen.aliyuncs.com</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo docker tag [ImageId] registry.cn-shenzhen.aliyuncs.com/[命名空间]/[仓库名称]:[镜像版本号]</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo docker push registry.cn-shenzhen.aliyuncs.com/[命名空间]/[仓库名称]:[镜像版本号]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ImageId 即为要推送的本地镜像。阿里云仓库中的镜像版本号可以与本地镜像 tag 保持一致，也可以不一致。</p>
</blockquote>
<p><img src="/2021/05/17/docker-base/image-20210602145727217.png" alt="image-20210602145727217"></p>
</li>
<li><p>查看：</p>
<p><img src="/2021/05/17/docker-base/image-20210602145837640.png" alt="image-20210602145837640"></p>
<p><img src="/2021/05/17/docker-base/image-20210602145904796.png" alt="image-20210602145904796"></p>
</li>
<li><p>下载：</p>
<p><img src="/2021/05/17/docker-base/image-20210602145943825.png" alt="image-20210602145943825"></p>
</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ls411n7mx">https://www.bilibili.com/video/BV1Ls411n7mx</a></p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/jack-GCQ/brain-map">https://gitee.com/jack-GCQ/brain-map</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/flink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/flink/" class="post-title-link" itemprop="url">Flink 入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-25 13:01:45" itemprop="dateCreated datePublished" datetime="2021-04-25T13:01:45+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-10 14:33:45" itemprop="dateModified" datetime="2022-01-10T14:33:45+08:00">2022-01-10</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>221k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3:21</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Flink-流处理简介"><a href="#Flink-流处理简介" class="headerlink" title="Flink 流处理简介"></a>Flink 流处理简介</h2><ul>
<li>Flink 官网：<a target="_blank" rel="noopener" href="https://flink.apache.org/">https://flink.apache.org/</a></li>
</ul>
<ul>
<li><p>Apache Flink is a framework and distributed processing engine for stateful computations over unbounded and bounded data streams.</p>
<ul>
<li>Apache Flink 是一个<strong>框架</strong>和<strong>分布式处理引擎</strong>，用于对<strong>无界和有界数据流</strong>进行<strong>状态</strong>计算。</li>
</ul>
</li>
<li><p>为什么选择 Flink：</p>
<ul>
<li>流数据更真实地反映了我们的生活方式。</li>
<li>传统的数据架构是基于有限数据集的。</li>
<li>我们的目标：<ul>
<li>低延迟</li>
<li>高吞吐</li>
<li>结果的准确性和良好的容错性</li>
</ul>
</li>
</ul>
</li>
<li><p>哪些行业需要处理流数据：</p>
<ul>
<li>电商和市场营销<ul>
<li>数据报表、广告投放、业务流程需要。</li>
</ul>
</li>
<li>物联网 (IOT)<ul>
<li>传感器实时数据采集和显示、实时报警，交通运输业。</li>
</ul>
</li>
<li>电信业<ul>
<li>基站流量调配。</li>
</ul>
</li>
<li>银行和金融业<ul>
<li>实时结算和通知推送，实时检测异常行为。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="传统数据处理架构"><a href="#传统数据处理架构" class="headerlink" title="传统数据处理架构"></a>传统数据处理架构</h3><ul>
<li><p>事务处理架构：</p>
<img src="/2021/04/25/flink/image-20210425162301927.png" alt="image-20210425162301927" style="zoom:67%;">

<ul>
<li>特点：实时性好，但数据量大时，难以进行高并发处理。(低延迟、低吞吐)</li>
</ul>
</li>
<li><p>分析处理架构：</p>
<img src="/2021/04/25/flink/image-20210425162650326.png" alt="image-20210425162650326" style="zoom: 80%;">

<ul>
<li>特点：将数据从业务数据库复制到数仓，再进行分析和查询。能够处理大数据，高并发，但实时性差。(高延迟、高吞吐)</li>
</ul>
</li>
</ul>
<h3 id="有状态的流式处理-第一代"><a href="#有状态的流式处理-第一代" class="headerlink" title="有状态的流式处理 (第一代)"></a>有状态的流式处理 (第一代)</h3><img src="/2021/04/25/flink/image-20210425165553312.png" alt="image-20210425165553312" style="zoom:67%;">

<ul>
<li>数据存储于内存当中，达到 Periodic Checkpoint 条件时，执行持久化存储。能够做到低延迟、高吞吐，但分布式架构下，难以保证数据的顺序。</li>
</ul>
<h3 id="lambda-架构-第二代"><a href="#lambda-架构-第二代" class="headerlink" title="lambda 架构 (第二代)"></a>lambda 架构 (第二代)</h3><img src="/2021/04/25/flink/image-20210425165954248.png" alt="image-20210425165954248" style="zoom:67%;">

<ul>
<li>采用两套系统，同时保证低延迟和结果准确：<ul>
<li>批处理系统处理速度慢，但准确性高。</li>
<li>流处理系统处理速度快，但准确性差。</li>
<li>缺点：实现一个功能，但需要维护两套系统，开发成本高。</li>
</ul>
</li>
</ul>
<h3 id="流处理系统的演变"><a href="#流处理系统的演变" class="headerlink" title="流处理系统的演变"></a>流处理系统的演变</h3><img src="/2021/04/25/flink/image-20210425170357898.png" alt="image-20210425170357898" style="zoom:67%;">

<ul>
<li>Storm 能够做到低延迟，Spark Streaming 能做到高吞吐，而 Flink 不仅综合了它们的优点，同时还能做得更好。</li>
<li>Flink 可以看作第三代流处理架构。</li>
</ul>
<h3 id="Flink-的特点"><a href="#Flink-的特点" class="headerlink" title="Flink 的特点"></a>Flink 的特点</h3><ul>
<li><p><strong>事件驱动 (Event-driven)</strong></p>
<img src="/2021/04/25/flink/image-20210425171740295.png" alt="image-20210425171740295" style="zoom:80%;">
</li>
<li><p><strong>基于流的世界观</strong></p>
<img src="/2021/04/25/flink/image-20210425171848097.png" alt="image-20210425171848097" style="zoom:80%;">

<ul>
<li>在 Flink 的世界观中，一切都是由流组成的，离线数据是有界的流，实时数据是一个没有界限的流，这就是所谓的<strong>有界流</strong>和<strong>无界流</strong>。</li>
</ul>
</li>
<li><p><strong>分层 API</strong></p>
<img src="/2021/04/25/flink/image-20210425172005916.png" alt="image-20210425172005916" style="zoom:67%;">

<ul>
<li>越顶层越抽象，表达含义越简明，使用越方便。</li>
<li>越底层越具体，表达能力越丰富，使用越灵活。</li>
</ul>
</li>
<li><p>支持事件时间 (event-time) 和处理时间 (processing-time) 语义。</p>
</li>
<li><p>精确一次 (exactly-once) 的状态一致性保证。</p>
</li>
<li><p>低延迟，每秒处理数百万个事件，毫秒级延迟。</p>
</li>
<li><p>与众多常用存储系统的连接。</p>
</li>
<li><p>高可用，动态扩展，实现 7 * 24 小时全天候运行。</p>
</li>
</ul>
<h3 id="Flink-vs-Spark-Streaming"><a href="#Flink-vs-Spark-Streaming" class="headerlink" title="Flink vs Spark Streaming"></a>Flink vs Spark Streaming</h3><ul>
<li><p>Flink 是流处理 (stream) 架构，Spark Streaming 是微批处理 (micro-batching) 架构。</p>
<img src="/2021/04/25/flink/image-20210425172711551.png" alt="image-20210425172711551" style="zoom:67%;">
</li>
<li><p>数据模型</p>
<ul>
<li>Spark 采用 RDD 模型，Spark Streaming 的 DStream 实际上也就是一组组小批数据 RDD 的集合。—&gt; 底层实现基于微批</li>
<li>Flink 基本数据模型是数据流，以及事件 (Event) 序列。—&gt; 底层实现就是流，一个一个的处理</li>
</ul>
</li>
<li><p>运行时架构</p>
<ul>
<li>Spark 是批计算，将 DAG 划分为不同的 stage，一个完成后才可以计算下一个。—&gt; 需要等待</li>
<li>Flink 是标准的流执行模式，一个事件在一个节点处理完后可以直接发往下一个节点进行处理。—&gt; 不需要等待</li>
</ul>
</li>
</ul>
<h2 id="QuickStart"><a href="#QuickStart" class="headerlink" title="QuickStart"></a>QuickStart</h2><ul>
<li><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xisun.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xisun-flink<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.11.1<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scala.binary.version</span>&gt;</span>2.12<span class="tag">&lt;/<span class="name">scala.binary.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>flink-streaming-java_2.12：Flink 底层组件依赖 scala，2.12 是 scala 版本。</p>
<p>Flink 1.11 版本之后，需要添加 flink-clients_2.12 依赖，否则会报异常 <code>java.lang.IllegalStateException: No ExecutorFactory found to execute the application.</code>。</p>
</blockquote>
</li>
</ul>
<h3 id="批处理实现-WordCount"><a href="#批处理实现-WordCount" class="headerlink" title="批处理实现 WordCount"></a>批处理实现 WordCount</h3><ul>
<li><p>hello.txt 文件内容：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hello java</span><br><span class="line">hello world</span><br><span class="line">hello flink</span><br><span class="line">hello spark</span><br><span class="line">hello scala</span><br><span class="line">how are you</span><br><span class="line">fine thank you</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.DataSet;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/25 20:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义类，实现FlatMapFunction接口</span></span><br><span class="line"><span class="comment">     * 参数说明：</span></span><br><span class="line"><span class="comment">     * 		String：传入数据类型</span></span><br><span class="line"><span class="comment">     * 		Tuple2&lt;String, Integer&gt;：传出数据类型</span></span><br><span class="line"><span class="comment">     * Tuple2&lt;T0, T1&gt;：Flink自身实现的元组，注意不要用scala的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlatMapper</span> <span class="keyword">implements</span> <span class="title">FlatMapFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String line, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 按空格分词</span></span><br><span class="line">            String[] words = line.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="comment">// 遍历所有word，包装成二元组输出</span></span><br><span class="line">            <span class="keyword">for</span> (String str : words) &#123;</span><br><span class="line">                <span class="comment">// 每一个word，都包装成一个二元组对象，并计数为1，然后用out收集</span></span><br><span class="line">                out.collect(<span class="keyword">new</span> Tuple2&lt;&gt;(str, <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建批处理执行环境</span></span><br><span class="line">        ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从resources路径下的文件中单线程读取数据，是按照一行一行读取的</span></span><br><span class="line">        String inputPath = <span class="string">&quot;src/main/resources/hello.txt&quot;</span>;</span><br><span class="line">        DataSet&lt;String&gt; inputDataSet = env.readTextFile(inputPath).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.对数据集进行处理，按空格分词展开，转换成(word, 1)这样的二元组进行统计</span></span><br><span class="line">        DataSet&lt;Tuple2&lt;String, Integer&gt;&gt; resultSet = inputDataSet.flatMap(<span class="keyword">new</span> MyFlatMapper())</span><br><span class="line">                .groupBy(<span class="number">0</span>)<span class="comment">// 按照元组第一个位置的word分组</span></span><br><span class="line">                .sum(<span class="number">1</span>);<span class="comment">// 按照元组第二个位置上的数据求和</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.打印输出</span></span><br><span class="line">        resultSet.print();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">(scala,<span class="number">1</span>)</span><br><span class="line">(you,<span class="number">2</span>)</span><br><span class="line">(flink,<span class="number">1</span>)</span><br><span class="line">(world,<span class="number">1</span>)</span><br><span class="line">(hello,<span class="number">5</span>)</span><br><span class="line">(are,<span class="number">1</span>)</span><br><span class="line">(java,<span class="number">1</span>)</span><br><span class="line">(thank,<span class="number">1</span>)</span><br><span class="line">(fine,<span class="number">1</span>)</span><br><span class="line">(how,<span class="number">1</span>)</span><br><span class="line">(spark,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="流处理实现-WordCount"><a href="#流处理实现-WordCount" class="headerlink" title="流处理实现 WordCount"></a>流处理实现 WordCount</h3><ul>
<li><p>基于文件读取数据，非真正的流式数据。</p>
</li>
<li><p>批处理 —&gt; 几组或所有数据到达后才处理；流处理 —&gt; 有数据来就直接处理，不等数据堆叠到一定数量级。</p>
</li>
<li><p><strong>这里不像批处理有 groupBy —&gt; 所有数据统一处理，而是用流处理的 keyBy —&gt; 每一个数据都对 key 进行 hash 计算，进行类似分区的操作，来一个数据就处理一次，所有中间过程都有输出！</strong></p>
</li>
<li><p><strong>并行度：本地 IDEA 执行环境的并行度默认就是计算机的 CPU 逻辑核数。</strong></p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/25 20:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWordCount</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置并行度，可选操作，默认值=当前计算机的CPU逻辑核数(设置成1即为单线程处理)</span></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从resources路径下的文件中多线程读取数据，是按照一行一行读取的</span></span><br><span class="line">        String inputPath = <span class="string">&quot;src/main/resources/hello.txt&quot;</span>;</span><br><span class="line">        DataStream&lt;String&gt; inputDataStream = env.readTextFile(inputPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.对数据集进行处理，按空格分词展开，转换成(word, 1)这样的二元组进行统计</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; resultStream = inputDataStream.flatMap(<span class="keyword">new</span> WordCount.MyFlatMapper())</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.打印输出</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不同于批处理，<code>env.execute()</code> 之前的代码，可以理解为是在定义任务，只有执行 <code>env.execute()</code> 后，Flink 才把前面的代码片段当作一个任务整体 (每个线程根据这个任务操作，并行处理流数据)。</p>
</blockquote>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">2</span>&gt; (java,<span class="number">1</span>)</span><br><span class="line"><span class="number">7</span>&gt; (flink,<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span>&gt; (scala,<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span>&gt; (spark,<span class="number">1</span>)</span><br><span class="line"><span class="number">4</span>&gt; (are,<span class="number">1</span>)</span><br><span class="line"><span class="number">3</span>&gt; (hello,<span class="number">1</span>)</span><br><span class="line"><span class="number">3</span>&gt; (hello,<span class="number">2</span>)</span><br><span class="line"><span class="number">6</span>&gt; (how,<span class="number">1</span>)</span><br><span class="line"><span class="number">3</span>&gt; (thank,<span class="number">1</span>)</span><br><span class="line"><span class="number">3</span>&gt; (hello,<span class="number">3</span>)</span><br><span class="line"><span class="number">3</span>&gt; (hello,<span class="number">4</span>)</span><br><span class="line"><span class="number">5</span>&gt; (fine,<span class="number">1</span>)</span><br><span class="line"><span class="number">5</span>&gt; (you,<span class="number">1</span>)</span><br><span class="line"><span class="number">5</span>&gt; (you,<span class="number">2</span>)</span><br><span class="line"><span class="number">5</span>&gt; (world,<span class="number">1</span>)</span><br><span class="line"><span class="number">3</span>&gt; (hello,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为是流处理，所以所有中间过程都会被输出，前面的序号就是并行执行任务的线程编号。</p>
<p>线程最大编号为 7，是因为本机配置是 4 核 8 处理器，默认并行度为 8。</p>
</blockquote>
</li>
</ul>
<h3 id="流式数据源测试"><a href="#流式数据源测试" class="headerlink" title="流式数据源测试"></a>流式数据源测试</h3><ul>
<li><p>开启适用于 Linux 的 Windows 子系统。</p>
<img src="/2021/04/25/flink/image-20210426131311252.png" alt="image-20210426131311252" style="zoom: 80%;">
</li>
<li><p>第一次使用时，需要先安装 Ubuntu 系统：</p>
<img src="/2021/04/25/flink/image-20210426152309423.png" alt="image-20210426152309423" style="zoom:80%;">
</li>
<li><p>打开 Windows PowerShell，输入 <code>wsl</code> 命令进入系统，然后通过 <code>nc -lk &lt;port&gt;</code> 命令打开一个 Socket 服务，用于模拟实时的流数据。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/26 10:40</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWordCount</span> <span class="title">throws</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置并行度，默认值 = 当前计算机的CPU逻辑核数(设置成1即为单线程处理)</span></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从数据流中读取数据，Socket文本流只能单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputDataStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.对数据集进行处理，按空格分词展开，转换成(word, 1)这样的二元组进行统计</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; resultStream = inputDataStream.flatMap(<span class="keyword">new</span> WordCount.MyFlatMapper())</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.打印输出</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>生产环境时，一般是在程序的启动参数中设置主机和端口号，此时，可以通过 ParameterTool 工具提取参数：</p>
<p><img src="/2021/04/25/flink/image-20210426142005687.png" alt="image-20210426142005687"></p>
<blockquote>
<p>参数设置格式：<code>--host localhost --port 7777</code>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用parameter tool工具从程序启动参数中提取配置项</span></span><br><span class="line">ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class="line">String host = parameterTool.get(<span class="string">&quot;host&quot;</span>);</span><br><span class="line"><span class="keyword">int</span> port = parameterTool.getInt(<span class="string">&quot;port&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.从数据流中读取数据</span></span><br><span class="line">DataStream&lt;String&gt; inputDataStream = env.socketTextStream(host, port);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>输出结果：在本地开启的 Socket 中输入数据，并观察 IDEA 的 Console 输出。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/Users/Xisun/Desktop$ nc -lk 7777</span><br><span class="line">hello world</span><br><span class="line">hello flink</span><br><span class="line">hello scala</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">3</span>&gt; (world,<span class="number">1</span>)</span><br><span class="line"><span class="number">2</span>&gt; (hello,<span class="number">1</span>)</span><br><span class="line"><span class="number">4</span>&gt; (flink,<span class="number">1</span>)</span><br><span class="line"><span class="number">2</span>&gt; (hello,<span class="number">2</span>)</span><br><span class="line"><span class="number">1</span>&gt; (scala,<span class="number">1</span>)</span><br><span class="line"><span class="number">2</span>&gt; (hello,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于输出结果，某项数据对应的次数最大值，是该数据统计到当前时间的最终结果。</p>
</blockquote>
</li>
</ul>
<h2 id="Flink-的部署"><a href="#Flink-的部署" class="headerlink" title="Flink 的部署"></a>Flink 的部署</h2><ul>
<li><p>下载地址：<a target="_blank" rel="noopener" href="https://flink.apache.org/downloads.html">https://flink.apache.org/downloads.html</a></p>
</li>
<li><p>最新版本：</p>
<p><img src="/2021/04/25/flink/image-20210722110158056.png" alt="image-20210722110158056"></p>
</li>
<li><p>全部稳定版本：<a target="_blank" rel="noopener" href="https://flink.apache.org/downloads.html#all-stable-releases">https://flink.apache.org/downloads.html#all-stable-releases</a></p>
<p><img src="/2021/04/25/flink/image-20210722105422030.png" alt="image-20210722105422030"></p>
<p><img src="/2021/04/25/flink/image-20210722105503741.png" alt="image-20210722105503741"></p>
</li>
<li><p>对于新版本的 Flink (1.7 之后)，需要额外下载 Hadoop 依赖，否则无法使用 Hadoop 支持的 Yarn 资源：</p>
<p><img src="/2021/04/25/flink/image-20210722105640710.png" alt="image-20210722105640710"></p>
</li>
</ul>
<h3 id="Standalone-模式"><a href="#Standalone-模式" class="headerlink" title="Standalone 模式"></a>Standalone 模式</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul>
<li><p>地址：<a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.lua/flink/flink-1.13.1/flink-1.13.1-bin-scala_2.12.tgz">https://www.apache.org/dyn/closer.lua/flink/flink-1.13.1/flink-1.13.1-bin-scala_2.12.tgz</a></p>
</li>
<li><p>Flink 组件：</p>
<p><img src="/2021/04/25/flink/image-20210722111347256.png" alt="image-20210722111347256"></p>
</li>
<li><p>其他组件 (Hadoop)：</p>
<p><img src="/2021/04/25/flink/image-20210426211322730.png" alt="image-20210426211322730"></p>
</li>
<li><p>解压到指定目录，并把 Hadoop 的组件添加到 Flink 解压路径的 lib 目录下：</p>
<p><img src="/2021/04/25/flink/image-20210722113043847.png" alt="image-20210722113043847"></p>
<p><img src="/2021/04/25/flink/image-20210722113205682.png" alt="image-20210722113205682"></p>
</li>
<li><p>打开 wsl 控制台，安装 JDK：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1$ sudo apt update</span><br><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1$ sudo apt install openjdk-8-jdk</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1$ java -version</span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_282&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_282-8u282-b08-0ubuntu1~20.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.282-b08, mixed mode)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Ubuntu 20.04 系统下安装 OpenJDK 11 和 OpenJDK 8 的方法：<a target="_blank" rel="noopener" href="https://ywnz.com/linuxjc/6984.html">https://ywnz.com/linuxjc/6984.html</a></p>
</blockquote>
</li>
<li><p>查看 JDK 安装路径，并在 Flink 安装目录的 conf/flink-conf.yaml 文件中配置 Java 环境：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Java</span></span><br><span class="line"><span class="attr">env.java.home:</span> <span class="string">/usr/lib/jvm/java-8-openjdk-amd64</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>建议不要使用 Windows 系统下安装的 JDK 路径，可能会有问题。</p>
</blockquote>
</li>
<li><p>配置主机和从机 (未验证)：</p>
<ul>
<li><p>修改 conf/flink-conf.yaml 文件，配置主机地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The external address of the host on which the JobManager runs and can be</span></span><br><span class="line"><span class="comment"># reached by the TaskManagers and any clients which want to connect. This setting</span></span><br><span class="line"><span class="comment"># is only used in Standalone mode and may be overwritten on the JobManager side</span></span><br><span class="line"><span class="comment"># by specifying the --host &lt;hostname&gt; parameter of the bin/jobmanager.sh executable.</span></span><br><span class="line"><span class="comment"># In high availability mode, if you use the bin/start-cluster.sh script and setup</span></span><br><span class="line"><span class="comment"># the conf/masters file, this will be taken care of automatically. Yarn/Mesos</span></span><br><span class="line"><span class="comment"># automatically configure the host name based on the hostname of the node where the</span></span><br><span class="line"><span class="comment"># JobManager runs.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobmanager.rpc.address:</span> <span class="string">hadoop1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 conf/workers 文件，配置从机地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop2</span><br><span class="line">hadoop3</span><br></pre></td></tr></table></figure>
</li>
<li><p>将主机 Flink 安装文件，派发给从机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xsync flink-1.13.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动 Flink 集群：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/Users/XiSun/Desktop$ bash /mnt/d/Program\ Files/flink-1.13.1/bin/start-cluster.sh</span><br><span class="line">Starting cluster.</span><br><span class="line">Starting standalonesession daemon on host DESKTOP-OM8IACS.</span><br><span class="line">Starting taskexecutor daemon on host DESKTOP-OM8IACS.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/Users/XiSun/Desktop$ jps</span><br><span class="line">7347 Jps</span><br><span class="line">6956 StandaloneSessionClusterEntrypoint</span><br><span class="line">7246 TaskManagerRunner</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端页面访问 <code>localhost:8081</code>，可以对 Flink 集群和任务进行监控管理。(8081 是默认端口)</p>
<p><img src="/2021/04/25/flink/image-20210427100238674.png" alt="image-20210427100238674"></p>
<blockquote>
<p>可以查看任务分配，内存使用，Log 日志，标准输出 (控制台) 等。</p>
</blockquote>
</li>
</ul>
<h4 id="提交任务"><a href="#提交任务" class="headerlink" title="提交任务"></a>提交任务</h4><ul>
<li><p>Web 页面提交</p>
<ul>
<li><p>上传 Jar 包：Submit New Job —&gt; Add New，将打包好的 Jar 包添加上来。</p>
<p><img src="/2021/04/25/flink/image-20210427102627506.png" alt="image-20210427102627506"></p>
</li>
<li><p>设置启动参数：</p>
<p><img src="/2021/04/25/flink/image-20210427103016003.png" alt="image-20210427103016003"></p>
<ul>
<li><p>Show Plan 查看任务执行计划：</p>
<p><img src="/2021/04/25/flink/image-20210427103111560.png" alt="image-20210427103111560"></p>
</li>
</ul>
</li>
<li><p>Submit 提交任务：</p>
<ul>
<li><p>提交失败：</p>
<p><img src="/2021/04/25/flink/image-20210427103303879.png" alt="image-20210427103303879"></p>
<blockquote>
<p>提交任务时，如果 slot 的数量低于设置的线程数量，会提交失败，会一直等待分配更多的资源。—&gt; 增加 slot 数量或者降低任务线程数量。</p>
</blockquote>
</li>
<li><p>提交成功：(需要先启动本机的 socket 服务)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/Users/XiSun/Desktop$ nc -tl 7777</span><br><span class="line">hello world</span><br><span class="line">hello flink</span><br><span class="line">hellojava^[[D^[[D^[[D</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/25/flink/image-20210427110351124.png" alt="image-20210427110351124"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>命令行提交</p>
<ul>
<li><p>准备数据文件，把含数据文件的文件夹，分发到 taskmanage 所在的机器中 (如果需要)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xsync flink</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果从文件中读取数据，由于是从本地磁盘读取，实际任务会被分发到 taskmanage 的机器中，所以要把数据文件分发到该机器上。</p>
</blockquote>
</li>
<li><p>提交命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1/bin$ ./flink run -p 4 -c cn.xisun.flink.StreamWordCount /mnt/d/JetBrainsWorkSpace/IDEAProjects/xisun-flink/target/xisun-flink-1.0-SNAPSHOT.jar --host localhost --port 7777</span><br><span class="line">Job has been submitted with JobID 470883e75e676e9c538d13f509ddc6cc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>./flink run：启动命令；-p 参数：指定并行度；-c 参数：指定 Jar 包运行的主程序。</p>
</blockquote>
</li>
<li><p>查看结果，如果输出到控制台，应该在 taskmanager 下查看；如果计算结果输出到文件，同样会保存到 taskmanage 的机器下，不会在 jobmanage 下。</p>
<p><img src="/2021/04/25/flink/image-20210722164432110.png" alt="image-20210722164432110"></p>
<blockquote>
<p>如果 Job 要求的 Task Slots 数大于可用的 Task Slots，Job 提交时会一直等待，直到分配到足够的资源。</p>
<p>flink-conf.yaml 配置文件中，<code>taskmanager.numberOfTaskSlots: 8</code> 用于配置可用的最大 slots 数，默认为 1，一般设置与当前主机 CPU 最大逻辑核心数相同。</p>
</blockquote>
<p><img src="/2021/04/25/flink/image-20210722164519782.png" alt="image-20210722164519782"></p>
<p>  <img src="/2021/04/25/flink/image-20210722164634809.png" alt="image-20210722164634809"></p>
</li>
<li><p>查看提交的 Job 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1/bin$ ./flink list</span><br><span class="line">Waiting <span class="keyword">for</span> response...</span><br><span class="line">------------------ Running/Restarting Jobs -------------------</span><br><span class="line">22.07.2021 16:41:11 : 470883e75e676e9c538d13f509ddc6cc : Flink Streaming Job (RUNNING)</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">No scheduled <span class="built_in">jobs</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>取消 Job：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1/bin$ ./flink cancel 470883e75e676e9c538d13f509ddc6cc</span><br><span class="line">Cancelling job 470883e75e676e9c538d13f509ddc6cc.</span><br><span class="line">Cancelled job 470883e75e676e9c538d13f509ddc6cc.</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看包含已取消的 Job 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/d/Program Files/flink-1.13.1/bin$ ./flink list -a</span><br><span class="line">Waiting <span class="keyword">for</span> response...</span><br><span class="line">No running <span class="built_in">jobs</span>.</span><br><span class="line">No scheduled <span class="built_in">jobs</span>.</span><br><span class="line">---------------------- Terminated Jobs -----------------------</span><br><span class="line">22.07.2021 16:41:11 : 470883e75e676e9c538d13f509ddc6cc : Flink Streaming Job (CANCELED)</span><br><span class="line">--------------------------------------------------------------</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="Yarn-模式"><a href="#Yarn-模式" class="headerlink" title="Yarn 模式"></a>Yarn 模式</h3><ul>
<li>以 Yarn 模式部署 Flink 任务时，要求 Flink 是有 Hadoop 支持的版本，Hadoop 环境需要保证版本在 2.2 以上，并且集群中安装有 HDFS 服务。</li>
</ul>
<h4 id="Flink-on-Yarn"><a href="#Flink-on-Yarn" class="headerlink" title="Flink on Yarn"></a>Flink on Yarn</h4><ul>
<li><p>Flink 提供了两种在 Yarn 上运行的模式，分别为 Session-Cluster 模式和 Per-Job-Cluster 模式。</p>
</li>
<li><p>Session-Cluster 模式</p>
<p><img src="/2021/04/25/flink/image-20210723104757557.png" alt="image-20210723104757557"></p>
<ul>
<li>Session-Cluster 模式需要先在 Yarn 中初始化一个 Flink 会话集群，开辟指定的资源。之后，所有任务都向这个 Flink 会话集群提交。这个 Flink 会话集群会常驻在 Yarn 集群中，除非手动停止。</li>
<li>Flink 会话集群所占的资源，会一直保持不变。提交任务时，如果资源满了，下一个任务就无法提交，只有等到 Yarn 中的其中一个任务执行完成后，释放了资源，下个任务才会正常提交。</li>
<li>Flink 会话集群中所有任务共享 Dispatcher 和 ResourceManager；共享资源。</li>
<li>Session-Cluster 模式适合规模小执行时间短的任务。</li>
</ul>
</li>
<li><p>Per-Job-Cluster 模式</p>
<p><img src="/2021/04/25/flink/image-20210723112007722.png" alt="image-20210723112007722"></p>
<ul>
<li><strong>Per-Job-Cluster 模式每次提交任务时，都会创建一个新的 Flink 集群，各任务之间互相独立，互不影响，方便管理。任务执行完成之后创建的集群也会消失。</strong></li>
<li>一个 Job 会对应一个集群，每提交一个任务会根据自身的情况，单独向 Yarn 申请资源，直到任务执行完成，一个任务的失败与否并不会影响下一个任务的正常提交和运行。</li>
<li>每个任务独享 Dispatcher 和 ResourceManager，按需接受资源申请；适合规模大长时间运行的作业。</li>
</ul>
</li>
</ul>
<h4 id="Session-Cluster"><a href="#Session-Cluster" class="headerlink" title="Session-Cluster"></a>Session-Cluster</h4><ul>
<li><p>启动 Hadoop 集群 (略)。</p>
</li>
<li><p>启动 yarn-session：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./yarn-session.sh -n 2 -s 2 -jm 1024 -tm 1024 -nm <span class="built_in">test</span> -d</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-n (–container)：TaskManager 的数量，新版本此参数应该无效了。<br>-s (–slots)： 每个 TaskManager 的 slot 数量，默认一个 slot 一个 core，默认每个 taskmanager 的 slot 的个数为 1，有时可以多一些 taskmanager，做冗余。<br>-jm：JobManager 的内存，单位 MB。<br>-tm：每个 taskmanager 的内存，单位 MB。<br>-nm：Yarn 的 appName (出现在 Yarn 的 ui 上的名字)。<br>-d：后台执行。</p>
</blockquote>
</li>
<li><p>提交任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./flink run -p 4 -d -c cn.xisun.flink.StreamWordCount /mnt/d/JetBrainsWorkSpace/IDEAProjects/xisun-flink/target/xisun-flink-1.0-SNAPSHOT.jar --host localhost --port 7777</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 Flink 中，如果启动了 yarn-session，提交任务时，默认提交到 yarn-session 中的 Flink 集群；如果没有启动 yarn-session，则提交到 Standalone 中的 Flink 集群。</p>
</blockquote>
</li>
<li><p>到 Yarn 控制台查看任务状态：</p>
<p><img src="/2021/04/25/flink/image-20210723120009218.png" alt="image-20210723120009218"></p>
</li>
<li><p>取消 yarn-session：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yarn application --<span class="built_in">kill</span> application_1577588252906_0001</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Per-Job-Cluster"><a href="#Per-Job-Cluster" class="headerlink" title="Per-Job-Cluster"></a>Per-Job-Cluster</h4><ul>
<li><p>启动 Hadoop 集群 (略)。</p>
</li>
<li><p>不启动 yarn-session ，直接提交任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./flink run –m yarn-cluster -p 4 -d -c cn.xisun.flink.StreamWordCount /mnt/d/JetBrainsWorkSpace/IDEAProjects/xisun-flink/target/xisun-flink-1.0-SNAPSHOT.jar --host localhost --port 7777</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按参数名称提取参数。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./flink run -m yarn-cluster -p 6 -d reaction-extractor-1.0-SNAPSHOT.jar extractor-patent extractor-reaction extractor-patent-timeout y</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按参数位置提取参数。</p>
</blockquote>
</li>
<li><p>查看任务和关闭任务，使用 Yarn 命令处理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看yarn上面的资源使用情况命令，ctrl+c退出</span></span><br><span class="line">$ yarn top</span><br><span class="line"><span class="comment"># 查看yarn上运行的任务列表命令，如果集群有krb认证的话，需要先kinit，认证后可以看到所有正在运行的任务</span></span><br><span class="line">$ yarn application -list</span><br><span class="line"><span class="comment"># 查看yarn上运行的指定状态的任务列表命令</span></span><br><span class="line">$ yarn application -list -appStates RUNNING</span><br><span class="line"><span class="comment"># 查看yarn指定任务的状态信息命令</span></span><br><span class="line">$ yarn application -status &lt;applicationId&gt; </span><br><span class="line"><span class="comment"># 查看yarn指定application任务日志命令，可以选择输出到本地文件</span></span><br><span class="line">$ yarn logs -applicationId &lt;applicationId&gt; &gt; yarn.log</span><br><span class="line"><span class="comment"># yarn logs -applicationId application_1606730935892_0095 &gt; yarn.log</span></span><br><span class="line"><span class="comment"># yarn logs -applicationId application_1606730935892_0095 &gt; yarn-2001-2005.log</span></span><br><span class="line"><span class="comment"># yarn logs -applicationId application_1606730935892_0093 --size 3145728 &gt; yarn-1996-2000.log</span></span><br><span class="line"><span class="comment"># kill yarn application命令</span></span><br><span class="line">$ yarn application -<span class="built_in">kill</span> &lt;applicationId&gt;</span><br><span class="line"><span class="comment"># kill yarn job命令</span></span><br><span class="line">$ yarn job -<span class="built_in">kill</span> &lt;jobId&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Kubernetes-部署"><a href="#Kubernetes-部署" class="headerlink" title="Kubernetes 部署"></a>Kubernetes 部署</h3><ul>
<li><p>容器化部署是目前业界很流行的一项技术，基于 Docker 镜像运行能够让用户更加方便地对应用进行管理和运维。容器管理工具中最为流行的就是 Kubernetes (k8s)，而 Flink 也在最近的版本中支持了 k8s 部署模式。</p>
</li>
<li><p>搭建 Kubernetes 集群 (略)。</p>
</li>
<li><p>配置各组件的 yaml 文件。</p>
<ul>
<li>在 k8s 上构建 Flink Session Cluster，需要将 Flink 集群的组件对应的 Docker 镜像分别在 k8s 上启动，包括 JobManager、TaskManager、JobManagerService 三个镜像服务，每个镜像服务都可以从中央镜像仓库中获取。</li>
</ul>
</li>
<li><p>启动 Flink Session Cluster：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 启动 jobmanager-service 服务</span><br><span class="line">$ kubectl create -f jobmanager-service.yaml</span><br><span class="line"></span><br><span class="line">// 启动 jobmanager-deployment 服务</span><br><span class="line">$ kubectl create -f jobmanager-deployment.yaml</span><br><span class="line"></span><br><span class="line">// 启动 taskmanager-deployment 服务</span><br><span class="line">$ kubectl create -f taskmanager-deployment.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 Flink UI 页面。集群启动后，就可以通过 JobManagerServicers 中配置的 WebUI 端口，用浏览器输入以下 url 来访问 Flink UI 页面了：<code>http://&#123;JobManagerHost:Port&#125;/api/v1/namespaces/default/services/flink-jobmanager:ui/proxy</code></p>
</li>
</ul>
<h2 id="Flink-的运行架构"><a href="#Flink-的运行架构" class="headerlink" title="Flink 的运行架构"></a>Flink 的运行架构</h2><h3 id="Flink-运行时的组件"><a href="#Flink-运行时的组件" class="headerlink" title="Flink 运行时的组件"></a>Flink 运行时的组件</h3><img src="/2021/04/25/flink/image-20210427114221318.png" alt="image-20210427114221318" style="zoom:67%;">

<h4 id="作业管理器-JobManager"><a href="#作业管理器-JobManager" class="headerlink" title="作业管理器 (JobManager)"></a>作业管理器 (JobManager)</h4><ul>
<li>控制一个应用程序执行的主进程，也就是说，<strong>每个应用程序都会被一个不同的 JobManager 所控制执行。</strong></li>
<li>JobManager 会先接收到要执行的应用程序，这个应用程序会包括：作业图 (JobGraph)、逻辑数据流图 (logical dataflow graph) 和打包了所有的类、库和其它资源的 Jar 包。</li>
<li>JobManager 会把 JobGraph 转换成一个物理层面的数据流图，这个图被叫做 “执行图” (ExecutionGraph)，包含了所有可以并发执行的任务。</li>
<li>JobManager 会向资源管理器 (ResourceManager) 请求执行任务必要的资源，也就是任务管理器 (TaskManager) 上的插槽 (slot)。一旦它获取到了足够的资源，就会将执行图分发到真正运行它们的 TaskManager 上。而在运行过程中，JobManager 会负责所有需要中央协调的操作，比如说检查点 (checkpoints) 的协调。</li>
</ul>
<h4 id="任务管理器-TaskManager"><a href="#任务管理器-TaskManager" class="headerlink" title="任务管理器 (TaskManager)"></a>任务管理器 (TaskManager)</h4><ul>
<li>Flink 中的工作进程。通常在 Flink 中会有多个 TaskManager 运行，每一个 TaskManager 都包含了一定数量的插槽 (slots)。插槽的数量限制了 TaskManager 能够执行的任务数量。</li>
<li>启动之后，<strong>TaskManager 会向资源管理器 (ResourceManager) 注册它的插槽；</strong>收到资源管理器 (ResourceManager) 的指令后，TaskManager 就会将一个或者多个插槽提供给 JobManager 调用，然后 JobManager 就可以向插槽分配任务 (tasks) 来执行了。</li>
<li>在执行过程中，一个 TaskManager 可以跟其它运行同一应用程序的 TaskManager 交换数据。</li>
</ul>
<h4 id="资源管理器-ResourceManager"><a href="#资源管理器-ResourceManager" class="headerlink" title="资源管理器 (ResourceManager)"></a>资源管理器 (ResourceManager)</h4><ul>
<li>主要负责管理任务管理器 (TaskManager) 的插槽 (slot)，TaskManger 插槽是 Flink 中定义的处理资源单元。</li>
<li>Flink 为不同的环境和资源管理工具提供了不同资源管理器，比如 YARN、Mesos、K8s，以及 Standalone 部署。</li>
<li>当 JobManager 申请插槽资源时，ResourceManager 会将有空闲插槽的 TaskManager 分配给 JobManager。如果 ResourceManager 没有足够的插槽来满足 JobManager 的请求，它还可以向资源提供平台发起会话，以提供启动 TaskManager 进程的容器。</li>
<li>另外，<strong>ResourceManager 还负责终止空闲的 TaskManager，释放计算资源。</strong></li>
</ul>
<h4 id="分发器-Dispatcher"><a href="#分发器-Dispatcher" class="headerlink" title="分发器 (Dispatcher)"></a>分发器 (Dispatcher)</h4><ul>
<li>可以跨作业运行，它为应用提交提供了 REST 接口。</li>
<li>当一个应用被提交执行时，分发器就会启动并将应用移交给一个 JobManager。</li>
<li>Dispatcher 也会启动一个 Web UI，用来方便地展示和监控作业执行的信息。</li>
<li>Dispatcher 在架构中可能并不是必需的，这取决于应用提交运行的方式。</li>
</ul>
<h3 id="任务提交流程"><a href="#任务提交流程" class="headerlink" title="任务提交流程"></a>任务提交流程</h3><ul>
<li><p>当一个应用提交执行时，Flink 的各个组件交互协作的过程如下：</p>
<img src="/2021/04/25/flink/image-20210427143509692.png" alt="image-20210427143509692" style="zoom:80%;">

<blockquote>
<p>上图中，步骤 7 指 TaskManager 为 JobManager 提供 slots，步骤 8 表示 JobManager 提交要在 slots 中执行的任务给 TaskManager。</p>
</blockquote>
</li>
<li><p>上图是从一个较为高层级的视角来看应用中各组件的交互协作。如果部署的集群环境不同 (例如 Yarn，Mesos，Kubernetes，Standalone等)，其中一些步骤可以被省略，或是有些组件会运行在同一个 JVM 进程中。</p>
</li>
</ul>
<ul>
<li><p>具体地，如果我们将 Flink 集群部署到 Yarn 上，那么就会有如下的提交流程：</p>
<img src="/2021/04/25/flink/image-20210427143943176.png" alt="image-20210427143943176" style="zoom:80%;">
- Flink 任务提交后，Client 向 HDFS 上传 Flink 的 Jar 包和配置。
- 之后，Client 向 Yarn ResourceManager 提交任务，Yarn ResourceManager 分配 Container 资源并通知对应的 NodeManager 启动 ApplicationMaster.
- ApplicationMaster 启动后加载 Flink 的 Jar 包和配置构建环境，然后启动 JobManager，之后，**JobManager 向 Flink 自身的 ResourceManager 申请资源，Flink 自身的 ResourceManager 再向 Yarn 的 ResourceManager 申请资源 (因为是 Yarn 模式，所有资源归 Yarn 的 ResourceManager 管理)，**申请到资源后，启动 TaskManager。
- Yarn ResourceManager 分配 Container 资源后 ， 由 ApplicationMaster 通知资源所在节点的 NodeManager 启动 TaskManager。
- NodeManager 加载 Flink 的 Jar 包和配置构建环境并启动 TaskManager，TaskManager 启动后向 JobManager 发送心跳包，并等待 JobManager 向其分配任务。

</li>
</ul>
<h3 id="任务调度原理"><a href="#任务调度原理" class="headerlink" title="任务调度原理"></a>任务调度原理</h3><img src="/2021/04/25/flink/image-20210427151039156.png" alt="image-20210427151039156" style="zoom:80%;">

<ul>
<li>客户端不是运行时和程序执行的一部分，但它用于准备并发送 dataflow (JobGraph) 给 Master (JobManager)，然后，客户端断开连接或者维持连接以等待接收计算结果。</li>
<li>当 Flink 集群启动后，首先会启动一个 JobManger 和一个或多个的 TaskManager。由 Client 提交任务给 JobManager，JobManager 再调度任务到各个 TaskManager 去执行，然后 TaskManager 将心跳和统计信息汇报给 JobManager。TaskManager 之间以流的形式进行数据的传输。上述三者均为独立的 JVM 进程。</li>
<li>Client 为提交 Job 的客户端，可以是运行在任何机器上 (与 JobManager 环境连通即可)。提交 Job 后，Client 可以结束进程 (Streaming 的任务)，也可以不结束并等待结果返回。</li>
<li>JobManager 会产生一个执行图 (Dataflow Graph)，主要负责调度 Job 并协调 Task 做 checkpoint，职责上很像 Storm 的 Nimbus。从 Client 处接收到 Job 和 Jar 包等资源后，会生成优化后的执行计划，并以 Task 的单元调度到各个 TaskManager 去执行。</li>
<li>TaskManager 在启动的时候就设置好了槽位数 (Slot)，每个 slot 能启动一个 Task，Task 为线程。从 JobManager 处接收需要部署的 Task，部署启动后，与自己的上游建立 Netty 连接，接收数据并处理。(如果一个 Slot 中启动多个线程，那么这几个线程类似 CPU 调度一样共用同一个 slot)</li>
</ul>
<h4 id="并行度-Parallelism"><a href="#并行度-Parallelism" class="headerlink" title="并行度 (Parallelism)"></a>并行度 (Parallelism)</h4><ul>
<li><p>Flink 程序的执行具有并行、分布式的特性。</p>
</li>
<li><p>在执行过程中，一个流 (Stream) 包含一个或多个分区 (stream partition)，而每一个算子 (operator) 可以包含一个或多个子任务 (operator subtask)，这些子任务在不同的线程、不同的物理机或不同的容器中彼此互不依赖地执行。</p>
</li>
<li><p>一个特定算子的子任务 (subtask) 的个数，称之为该算子的并行度 (parallelism)。一个程序中，不同的算子可能具有不同的并行度。一般情况下，一个流程序的并行度，可以认为就是其所有算子中，设置最大的那个算子的并行度。</p>
<p><img src="/2021/04/25/flink/image-20210721113548841.png" alt="image-20210721113548841"></p>
</li>
<li><p><strong>并行度优先级：具体算子设置的并行度 &gt; 程序全局设置的并行度 &gt; 提交 Job 时设置的并行度 &gt; flink-conf.yaml 配置文件默认的并行度。</strong></p>
</li>
<li><p>并行度，可以简单理解为：并行执行任务的程度。Flink 程序中，有四种方式设置并行度：</p>
<ul>
<li>通过 <code>env.setParallelism(1);</code> 设置全局的并行度。</li>
<li>通过  <code>setParallelism()</code> 设置每一个算子的并行度。</li>
<li>提交任务时，通过 Web 页面直接指定，或命令行使用 -p 参数指定并行度。</li>
<li>通过 flink-conf.yaml 配置文件配置。 </li>
</ul>
</li>
<li><p>并行度 parallelism 是动态概念，即 TaskManager 运行程序时实际使用的并发能力。在 flink-conf.yaml 配置文件中，通过 <code>parallelism.default</code> 设置并行度，默认为 1。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The parallelism used for programs that did not specify and other parallelism.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">parallelism.default:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<h4 id="TaskManger-与-Slots"><a href="#TaskManger-与-Slots" class="headerlink" title="TaskManger 与 Slots"></a>TaskManger 与 Slots</h4><ul>
<li><p>Flink 中每一个 worker (TaskManager) 都是一个 JVM 进程 (Processes)，它可能会在独立的线程 (Threads) 上执行一个或多个 subtask。为了控制一个 worker 能接收多少个 task，worker 通过 task slot 来进行控制 (一个 worker 至少有一个 task slot)。</p>
</li>
<li><p>每个 task slot 表示 TaskManager 拥有资源的一个固定大小的子集。假如一个 TaskManager 有三个 slot，那么它会将其管理的内存分成三份给各个 slot。资源 slot 化意味着一个 subtask 将不需要跟来自其他 job 的 subtask 竞争被管理的内存，取而代之的是它将拥有一定数量的内存储备。需要注意的是，这里不会涉及到 CPU 的隔离，slot 目前仅仅用来隔离 task 的受管理的内存。</p>
<p><img src="/2021/04/25/flink/image-20210726145655263.png" alt="image-20210726145655263"></p>
<ul>
<li>slot 实际上就是，执行一个独立任务所需要的计算资源的最小单元 (主要就是 CPU 和内存资源)。</li>
<li>当前 Flink 架构中，每一个 slot 所占的内存是隔离开的，即独享内存资源，互不影响。但 CPU 资源是共享的，如果一个 CPU 被多个 slot 使用，那 CPU 就是时间片上的一个轮转状态，被多个 slot 轮流使用。</li>
<li>通过调整 task slot 的数量，允许用户定义 subtask 之间如何互相隔离。如果一个 TaskManager 只有一个 slot，那将意味着每个 task group 运行在独立的 JVM 中 (该 JVM 可能是通过一个特定的容器启动的)，而一个 TaskManager 多个 slot，则意味着更多的 subtask 可以共享同一个 JVM。而在同一个 JVM 进程中的 task 将共享 TCP 连接 (基于多路复用) 和心跳消息。它们也可能共享数据集和数据结构，因此这减少了每个 task 的负载。</li>
</ul>
</li>
<li><p>默认情况下，Flink 允许子任务共享 slot，即使它们是不同任务的子任务。 这样的结果是，一个 slot 可以保存任务的整个管道 (也就是任务的一个完整流程)。</p>
<p><img src="/2021/04/25/flink/image-20210726150221347.png" alt="image-20210726150221347"></p>
<ul>
<li>从上图可以看出，Stream 的并行度为 6，共有 13 个任务，但实际上，只用了 6 个 slot 就完成了全部任务的执行。</li>
</ul>
</li>
<li><p>共享 slot 的好处：在一个 slot 中可以保存任务的整个管道，即使其他的 slot 挂掉了，也不会影响任务的完整执行，保证了程序的健壮性。另外，如果某个子任务比较占用 CPU，共享 slot 能够充分调用 CPU 的处理能力，防止出现有的 CPU 极其空闲，有的 CPU 极其繁忙。</p>
</li>
<li><p>共享 slot 的前提：必须是一个 Stream 中先后发生的不同的子任务。比如上图中，不同的 source-map 算子任务，就只能放在不同的 slot 中，不能共享一个 slot，因为相同的子任务，如果共享一个 slot，可能会导致这几个相同的子任务间数据的混淆。</p>
</li>
<li><p>Task Slot 是静态的概念，是指 TaskManager 具有的并发执行能力。在 flink-conf.yaml 配置文件中，通过 <code>taskmanager.numberOfTaskSlots</code> 设置 TaskManager 中的 slot 数量，默认为 1，<strong>一般应设置为与当前主机 CPU 的逻辑核心数相同。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of task slots that each TaskManager offers. Each slot runs one parallel pipeline.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">taskmanager.numberOfTaskSlots:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Flink 中，可以通过 <code>slotSharingGroup()</code> 设置每一个算子所属的 slot 共享组。 如果不同算子的 slot 共享组不同，则运行时一定要占用不同的 slot。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamWordCount</span> <span class="title">throws</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class="line">        String host = parameterTool.get(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> port = parameterTool.getInt(<span class="string">&quot;port&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;String&gt; inputDataStream = env.socketTextStream(host, port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不配置时，默认slot共享组为default，后面的算子默认与前面的算子同一slot共享组</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; resultStream = inputDataStream</span><br><span class="line">                .flatMap(<span class="keyword">new</span> WordCount.MyFlatMapper()).slotSharingGroup(<span class="string">&quot;green&quot;</span>)</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .sum(<span class="number">1</span>).setParallelism(<span class="number">2</span>).slotSharingGroup(<span class="string">&quot;red&quot;</span>);</span><br><span class="line"></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/25/flink/image-20210727163648248.png" alt="image-20210727163648248"></p>
<blockquote>
<p>上面代码中，source 算子是 default 共享组，flatMap 是 green 共享组，sum 是 red 共享组，print 与 sum 相同。提交上面这个任务时，先考虑分组，再考虑每个分组内最大的并行度，相加之后，即为所需的 slot 数量。因此，上面的任务，至少需要 4 个 slot。</p>
</blockquote>
</li>
</ul>
<h4 id="并行子任务的分配"><a href="#并行子任务的分配" class="headerlink" title="并行子任务的分配"></a>并行子任务的分配</h4><ul>
<li><p>假设一个 JobGraph 如下图左所示，则可以看出，一共有 16 个子任务。如果没有自定义 slot 共享组，则如下图右所示，只需要 4 个 slot 就可以完成任务。</p>
<p><img src="/2021/04/25/flink/image-20210727165729037.png" alt="image-20210727165729037"></p>
</li>
<li><p>假设一共有 3 个 TaskManager，每一个 TaskManager 中分配了 3 个 TaskSlot，也就是每个 TaskManager 可以接收 3 个 task，一共有 9 个 TaskSlot。在 Example 1 中，如果我们设置 <code>parallelism.default=1</code>，即运行程序默认的并行度为 1，那么 9 个 TaskSlot 只用了 1个，会有 8 个空闲。因此，设置合适的并行度才能提高效率，如 Example 2 ~ 4 所示。</p>
<p><img src="/2021/04/25/flink/image-20210728144150779.png" alt="image-20210728144150779"></p>
<p><img src="/2021/04/25/flink/image-20210728144213582.png" alt="image-20210728144213582"></p>
</li>
</ul>
<h4 id="程序与数据流-DataFlow"><a href="#程序与数据流-DataFlow" class="headerlink" title="程序与数据流 (DataFlow)"></a>程序与数据流 (DataFlow)</h4><p><img src="/2021/04/25/flink/image-20210728171436010.png" alt="image-20210728171436010"></p>
<ul>
<li><p>所有的 Flink 程序都是由三部分组成的：Source、Transformation 和 Sink。</p>
<ul>
<li>Source 负责读取数据源，Transformation 利用各种算子进行处理加工，Sink 负责输出。</li>
</ul>
</li>
<li><p>在运行时，Flink 上运行的程序会被映射成 “逻辑数据流” (dataflows)，它包含了这三部分。</p>
</li>
<li><p>每一个 dataflow 以一个或多个 source 开始，以一个或多个 sink 结束。dataflow 类似于任意的有向无环图 (DAG) (有方向非环形)。</p>
<p><img src="/2021/04/25/flink/image-20210729225604513.png" alt="image-20210729225604513"></p>
</li>
<li><p>在大部分情况下，程序中的转换运算 (transformations) 跟 dataflow 中的算子 (operator) 是一一对应的关系，但有时候，一个 transformation 可能对应多个 operator。</p>
</li>
</ul>
<h4 id="执行图-ExecutionGrap"><a href="#执行图-ExecutionGrap" class="headerlink" title="执行图 (ExecutionGrap)"></a>执行图 (ExecutionGrap)</h4><ul>
<li><p>由 Flink 程序直接映射成的数据流图是 StreamGraph，也被称为逻辑流图，因为它们表示的是计算逻辑的高级视图。为了执行一个流处理程序，Flink 需要将逻辑流图转换为物理数据流图 (也叫执行图)，详细说明程序的执行方式。</p>
</li>
<li><p>Flink 中的执行图可以分成四层：StreamGraph —&gt; JobGraph —&gt; ExecutionGraph —&gt; 物理执行图。</p>
<p><img src="/2021/04/25/flink/image-20210729231840293.png" alt="image-20210729231840293"></p>
<ul>
<li>StreamGraph：是根据用户通过 Stream API 编写的代码生成的最初的图。用来表示程序的拓扑结构。</li>
<li>JobGraph：StreamGraph 经过优化后生成了 JobGraph，即提交给 JobManager 的数据结构。主要的优化为：将多个符合条件的节点 chain 在一起作为一个节点，这样可以减少数据在节点之间流动所需要的序列化/反序列化/传输消耗。</li>
<li>ExecutionGraph：JobManager 根据 JobGraph 生成 ExecutionGraph。ExecutionGraph 是 JobGraph 的并行化版本，是调度层最核心的数据结构。</li>
<li>物理执行图：JobManager 根据 ExecutionGraph 对 Job 进行调度后，在各个 TaskManager 上部署 Task 后形成的 “图”，并不是一个具体的数据结构。</li>
</ul>
</li>
</ul>
<h4 id="数据传输形式"><a href="#数据传输形式" class="headerlink" title="数据传输形式"></a>数据传输形式</h4><ul>
<li>一个 Flink 程序中，不同的算子可能具有不同的并行度。</li>
<li>Stream 在算子之间传输数据的形式可以是 one-to-one (forwarding) 的模式，也可以是 redistributing 的模式，具体是哪一种形式，取决于算子的种类</li>
<li>One-to-one：Stream维护着分区以及元素的顺序，比如在 source 和 map 这两个 operator 之间，这意味着 map 算子的子任务看到的元素的个数以及顺序，跟 source 算子的子任务生产的元素的个数、顺序相同。map、fliter、flatMap 等算子都是 one-to-one 的对应关系。<ul>
<li>类似于 Spark 中的窄依赖。</li>
</ul>
</li>
<li>Redistributing：Stream 的分区会发生改变，比如 map 跟 keyBy/window 之间，或者 keyBy/window 跟 sink 之间。每一个算子的子任务依据所选择的 transformation 发送数据到不同的目标任务。例如，keyBy 基于 hashCode 重分区、broadcast 和 rebalance会随机重新分区 (rebalance 实际上是一种轮询的随机重新分区操作)，这些算子都会引起 redistribute 过程，而 redistribute 过程就类似于 Spark 中的 shuffle 过程 (Flink 中的 shuffle 算子，是完全随机的重新分区操作)。<ul>
<li>类似于 Spark 中的宽依赖。</li>
</ul>
</li>
</ul>
<h4 id="任务链-Operator-Chain"><a href="#任务链-Operator-Chain" class="headerlink" title="任务链 (Operator Chain)"></a>任务链 (Operator Chain)</h4><p><img src="/2021/04/25/flink/image-20210730163822923.png" alt="image-20210730163822923"></p>
<ul>
<li>Flink 采用了一种称为任务链的优化技术，它能减少线程之间的切换和基于缓存区的数据交换，在减少时延的同时提升吞吐量，可以在特定条件下减少本地通信的开销。为了满足任务链的要求，必须将两个或多个算子设为相同的并行度，并通过本地转发 (local forward) 的方式进行连接。</li>
<li>相同并行度的 one-to-one 操作，Flink 将这样相连的算子链接在一起形成一个 task，原来的算子成为里面的 subtask。</li>
<li>算子合并的条件：并行度相同，并且是 one-to-one 操作，两个条件缺一不可。</li>
<li>如上图所示，最终有 5 个任务，如果未自定义共享组，只需要 2 个 slot 即可。</li>
<li>如果不希望 Key Agg 和 Sink 这两个算子合并为一个任务，但也还是能 slot 共享，则有以下几种方式处理：<ul>
<li>在 Key Agg 算子后做一个 rebalance (<code>.rebalance()</code>) 或 shuffle (<code>.shuffle()</code>) 操作，改变其传输方式；</li>
<li>使用 <code>.disableChaining()</code>，指定 Key Agg 算子不参与任务链合并操作 (该算子前后都会不参与)；</li>
<li>使用 <code>.startNewChain()</code>，指定 Key Agg 算子后面开始一个新的任务链合并操作，即 Key Agg 算子还可以与它前面的算子合并，但不与后面的算子合并；</li>
<li>如果希望每一个算子都这样处理，可以通过 <code>env.disableOperatorChaining();</code>，对全局进行设置。</li>
</ul>
</li>
</ul>
<h2 id="Flink-的流处理-API"><a href="#Flink-的流处理-API" class="headerlink" title="Flink 的流处理 API"></a>Flink 的流处理 API</h2><img src="/2021/04/25/flink/image-20210428091400383.png" alt="image-20210428091400383" style="zoom:80%;">

<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><h4 id="getExecutionEnvironment"><a href="#getExecutionEnvironment" class="headerlink" title="getExecutionEnvironment()"></a><code>getExecutionEnvironment()</code></h4><ul>
<li><p>创建一个执行环境，表示当前执行程序的上下文。 如果程序是独立调用的，则此方法返回本地执行环境；如果从命令行客户端调用程序以提交到集群，则此方法返回此集群的执行环境，也就是说，getExecutionEnvironment 会根据查询运行的方式决定返回什么样的运行环境，是最常用的一种创建执行环境的方式。</p>
</li>
<li><p>批处理执行环境：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br></pre></td></tr></table></figure>
</li>
<li><p>流处理执行环境：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></pre></td></tr></table></figure>
</li>
<li><p>在生产环境时，如果没有设置并行度，会以 flink-conf.yaml 中的配置为准，默认是 1：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The parallelism used for programs that did not specify and other parallelism.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">parallelism.default:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在本地 IDEA 执行环境时，默认并行度是本地计算机的 CPU 逻辑核数，本地计算机为 4 核 8 处理器，即默认并行度为 8，本文测试代码以此为基准。</p>
</blockquote>
</li>
</ul>
<h4 id="createLocalEnvironment"><a href="#createLocalEnvironment" class="headerlink" title="createLocalEnvironment()"></a><code>createLocalEnvironment()</code></h4><ul>
<li><p>返回本地执行环境，需要在调用时指定默认的并行度：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocalStreamEnvironment env = StreamExecutionEnvironment.createLocalEnvironment(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="createRemoteEnvironment"><a href="#createRemoteEnvironment" class="headerlink" title="createRemoteEnvironment()"></a><code>createRemoteEnvironment()</code></h4><ul>
<li><p>返回集群执行环境，将 Jar 提交到远程服务器。需要在调用时指定 JobManager 的 IP 和端口号，并指定要在集群中运行的 Jar 包。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env =</span><br><span class="line">        StreamExecutionEnvironment.createRemoteEnvironment(<span class="string">&quot;jobmanage-hostname&quot;</span>, <span class="number">6123</span>, <span class="string">&quot;YOURPATH//WordCount.jar&quot;</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><h4 id="从集合读取数据"><a href="#从集合读取数据" class="headerlink" title="从集合读取数据"></a>从集合读取数据</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 传感器温度读数的数据类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 20:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SensorReading</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 属性：id，时间戳，温度值</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> Long timestamp;</span><br><span class="line">    <span class="keyword">private</span> Double temperature;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SensorReading</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SensorReading</span><span class="params">(String id, Long timestamp, Double temperature)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimestamp</span><span class="params">(Long timestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getTemperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTemperature</span><span class="params">(Double temperature)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.temperature = temperature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SensorReading&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&#x27;&quot;</span> + id + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">                <span class="string">&quot;, temperature=&quot;</span> + temperature +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 20:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest1_Collection</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.Source: 从集合读取数据</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; sensorDataStream = env.fromCollection(</span><br><span class="line">                Arrays.asList(</span><br><span class="line">                        <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_1&quot;</span>, <span class="number">1547718199L</span>, <span class="number">35.8</span>),</span><br><span class="line">                        <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_6&quot;</span>, <span class="number">1547718201L</span>, <span class="number">15.4</span>),</span><br><span class="line">                        <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_7&quot;</span>, <span class="number">1547718202L</span>, <span class="number">6.7</span>),</span><br><span class="line">                        <span class="keyword">new</span> SensorReading(<span class="string">&quot;sensor_10&quot;</span>, <span class="number">1547718205L</span>, <span class="number">38.1</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Integer&gt; intDataStream = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 打印，参数为数据流的名称，可选</span></span><br><span class="line">        sensorDataStream.print(<span class="string">&quot;sensorDataName&quot;</span>);</span><br><span class="line">        intDataStream.print(<span class="string">&quot;intDataStreamName&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行任务，参数为Job的名称，可选</span></span><br><span class="line">        env.execute(<span class="string">&quot;JobName&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">intDataStreamName:<span class="number">1</span>&gt; <span class="number">8</span></span><br><span class="line">intDataStreamName:<span class="number">5</span>&gt; <span class="number">4</span></span><br><span class="line">intDataStreamName:<span class="number">4</span>&gt; <span class="number">3</span></span><br><span class="line">sensorDataName:<span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">sensorDataName:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">intDataStreamName:<span class="number">3</span>&gt; <span class="number">2</span></span><br><span class="line">sensorDataName:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">intDataStreamName:<span class="number">2</span>&gt; <span class="number">1</span></span><br><span class="line">intDataStreamName:<span class="number">2</span>&gt; <span class="number">9</span></span><br><span class="line">intDataStreamName:<span class="number">7</span>&gt; <span class="number">6</span></span><br><span class="line">intDataStreamName:<span class="number">6</span>&gt; <span class="number">5</span></span><br><span class="line">sensorDataName:<span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">intDataStreamName:<span class="number">8</span>&gt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="从文件读取数据"><a href="#从文件读取数据" class="headerlink" title="从文件读取数据"></a>从文件读取数据</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 22:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest2_File</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据：单线程读取文件，按顺序逐行读取，如果不设置，则多线程读取，文件内容会乱序</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印，多线程</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>sensor.txt 文件内容：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718207,36.3</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果 (多线程打印，每次输出结果都会不同)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">4</span>&gt; sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line"><span class="number">1</span>&gt; sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line"><span class="number">3</span>&gt; sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line"><span class="number">6</span>&gt; sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br><span class="line"><span class="number">2</span>&gt; sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line"><span class="number">5</span>&gt; sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line"><span class="number">8</span>&gt; sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 <code>dataStream.print().setParallelism(1);</code>，单线程打印的输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="从-Kafka-消息队列读取数据"><a href="#从-Kafka-消息队列读取数据" class="headerlink" title="从 Kafka 消息队列读取数据"></a>从 Kafka 消息队列读取数据</h4><ul>
<li><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 22:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest3_Kafka</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建Kafka消费者</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        FlinkKafkaConsumer&lt;String&gt; consumer = <span class="keyword">new</span> FlinkKafkaConsumer&lt;&gt;(<span class="string">&quot;sensor&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Kafka读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = env.addSource(consumer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.打印</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="自定义-Source"><a href="#自定义-Source" class="headerlink" title="自定义 Source"></a>自定义 Source</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 22:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceTest4_UDF</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"><span class="comment">//        env.setParallelism(1);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从自定义Source读取数据</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = env.addSource(<span class="keyword">new</span> MySensorSource());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的SourceFunction，随机生成传感器数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MySensorSource</span> <span class="keyword">implements</span> <span class="title">SourceFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义一个标识位，用来控制数据的产生</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;SensorReading&gt; ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 定义一个随机数发生器</span></span><br><span class="line">            Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置10个传感器的初始温度</span></span><br><span class="line">            HashMap&lt;String, Double&gt; sensorTempMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                sensorTempMap.put(<span class="string">&quot;sensor_&quot;</span> + (i + <span class="number">1</span>), <span class="number">60</span> + random.nextGaussian() * <span class="number">20</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (running) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String sensorId : sensorTempMap.keySet()) &#123;</span><br><span class="line">                    <span class="comment">// 在当前温度基础上随机波动</span></span><br><span class="line">                    Double newtemp = sensorTempMap.get(sensorId) + random.nextGaussian();</span><br><span class="line">                    sensorTempMap.put(sensorId, newtemp);</span><br><span class="line">                    ctx.collect(<span class="keyword">new</span> SensorReading(sensorId, System.currentTimeMillis(), newtemp));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 控制输出频率</span></span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            running = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果 (程序会一直输出下去)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1619670947828</span>, temperature=<span class="number">57.523519020755195</span>&#125;</span><br><span class="line"><span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1619670947828</span>, temperature=<span class="number">60.16683595604395</span>&#125;</span><br><span class="line"><span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_9&#x27;</span>, timestamp=<span class="number">1619670947831</span>, temperature=<span class="number">42.125026316308286</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1619670947826</span>, temperature=<span class="number">82.58226594512607</span>&#125;</span><br><span class="line"><span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_4&#x27;</span>, timestamp=<span class="number">1619670947828</span>, temperature=<span class="number">78.73909616880852</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_5&#x27;</span>, timestamp=<span class="number">1619670947831</span>, temperature=<span class="number">26.71490359887942</span>&#125;</span><br><span class="line"><span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1619670947831</span>, temperature=<span class="number">85.09026456845346</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_2&#x27;</span>, timestamp=<span class="number">1619670947828</span>, temperature=<span class="number">64.90731492147165</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_3&#x27;</span>, timestamp=<span class="number">1619670947822</span>, temperature=<span class="number">31.96909359527708</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_8&#x27;</span>, timestamp=<span class="number">1619670947831</span>, temperature=<span class="number">86.34172370619932</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1619670948831</span>, temperature=<span class="number">60.71931724451548</span>&#125;</span><br><span class="line"><span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1619670948831</span>, temperature=<span class="number">57.36109139383153</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_4&#x27;</span>, timestamp=<span class="number">1619670948831</span>, temperature=<span class="number">78.1152626762054</span>&#125;</span><br><span class="line"><span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_2&#x27;</span>, timestamp=<span class="number">1619670948831</span>, temperature=<span class="number">63.90599072985537</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1619670948831</span>, temperature=<span class="number">82.1517010383502</span>&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h3><h4 id="基本转换算子"><a href="#基本转换算子" class="headerlink" title="基本转换算子"></a>基本转换算子</h4><ul>
<li><p>map、flatMap、filter 通常被统一称为<strong>基本转换算子 (简单转换算子)。</strong></p>
</li>
<li><p><strong>map：</strong></p>
<img src="/2021/04/25/flink/image-20210429130112584.png" alt="image-20210429130112584" style="zoom:80%;">
</li>
<li><p><strong>flatMap：</strong></p>
<img src="/2021/04/25/flink/image-20210429131505870.png" alt="image-20210429131505870" style="zoom:80%;">
</li>
<li><p><strong>filter：</strong></p>
<img src="/2021/04/25/flink/image-20210429130649590.png" alt="image-20210429130649590" style="zoom:80%;">
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/28 10:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest1_Base</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.map，把String转换成其长度输出</span></span><br><span class="line">        DataStream&lt;Integer&gt; mapStream = inputStream.map(<span class="keyword">new</span> MapFunction&lt;String, Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.length();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.flatmap，按逗号分割字符串</span></span><br><span class="line">        DataStream&lt;String&gt; flatMapStream = inputStream.flatMap(<span class="keyword">new</span> FlatMapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] fields = value.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String field : fields) &#123;</span><br><span class="line">                    out.collect(field);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.filter，筛选&quot;sensor_1&quot;开头的id对应的数据</span></span><br><span class="line">        DataStream&lt;String&gt; filterStream = inputStream.filter(<span class="keyword">new</span> FilterFunction&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> value.startsWith(<span class="string">&quot;sensor_1&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.打印</span></span><br><span class="line">        mapStream.print(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        flatMapStream.print(<span class="string">&quot;flatMap&quot;</span>);</span><br><span class="line">        filterStream.print(<span class="string">&quot;filter&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">map:<span class="number">5</span>&gt; <span class="number">24</span></span><br><span class="line">map:<span class="number">5</span>&gt; <span class="number">24</span></span><br><span class="line">flatMap:<span class="number">4</span>&gt; sensor_1</span><br><span class="line">flatMap:<span class="number">4</span>&gt; <span class="number">1547718199</span></span><br><span class="line">flatMap:<span class="number">4</span>&gt; <span class="number">35.8</span></span><br><span class="line">flatMap:<span class="number">4</span>&gt; sensor_1</span><br><span class="line">flatMap:<span class="number">4</span>&gt; <span class="number">1547718212</span></span><br><span class="line">flatMap:<span class="number">4</span>&gt; <span class="number">37.1</span></span><br><span class="line">flatMap:<span class="number">6</span>&gt; sensor_7</span><br><span class="line">flatMap:<span class="number">6</span>&gt; <span class="number">1547718202</span></span><br><span class="line">flatMap:<span class="number">6</span>&gt; <span class="number">6.7</span></span><br><span class="line">map:<span class="number">6</span>&gt; <span class="number">24</span></span><br><span class="line">filter:<span class="number">3</span>&gt; sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">filter:<span class="number">3</span>&gt; sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br><span class="line">filter:<span class="number">6</span>&gt; sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">map:<span class="number">4</span>&gt; <span class="number">24</span></span><br><span class="line">map:<span class="number">1</span>&gt; <span class="number">23</span></span><br><span class="line">map:<span class="number">3</span>&gt; <span class="number">24</span></span><br><span class="line">map:<span class="number">2</span>&gt; <span class="number">25</span></span><br><span class="line">filter:<span class="number">1</span>&gt; sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line">filter:<span class="number">2</span>&gt; sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line">flatMap:<span class="number">5</span>&gt; sensor_6</span><br><span class="line">flatMap:<span class="number">5</span>&gt; <span class="number">1547718201</span></span><br><span class="line">flatMap:<span class="number">5</span>&gt; <span class="number">15.4</span></span><br><span class="line">flatMap:<span class="number">3</span>&gt; sensor_1</span><br><span class="line">flatMap:<span class="number">3</span>&gt; <span class="number">1547718209</span></span><br><span class="line">flatMap:<span class="number">3</span>&gt; <span class="number">32.8</span></span><br><span class="line">flatMap:<span class="number">2</span>&gt; sensor_1</span><br><span class="line">flatMap:<span class="number">2</span>&gt; <span class="number">1547718207</span></span><br><span class="line">flatMap:<span class="number">2</span>&gt; <span class="number">36.3</span></span><br><span class="line">flatMap:<span class="number">1</span>&gt; sensor_10</span><br><span class="line">flatMap:<span class="number">1</span>&gt; <span class="number">1547718205</span></span><br><span class="line">flatMap:<span class="number">1</span>&gt; <span class="number">38.1</span></span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="聚合操作算子"><a href="#聚合操作算子" class="headerlink" title="聚合操作算子"></a>聚合操作算子</h4><ul>
<li><p>DataStream 里没有 reduce 和 sum 这类聚合操作的方法，因为 <strong>Flink 设计中，所有数据必须先分组才能做聚合操作。</strong></p>
</li>
<li><p><strong>先 keyBy 得到 KeyedStream，然后调用其 reduce、sum 等聚合操作方法。(先分组后聚合)</strong></p>
</li>
<li><p>常见的聚合操作算子主要有：</p>
<ul>
<li>keyBy</li>
<li>滚动聚合算子 Rolling Aggregation</li>
<li>reduce</li>
</ul>
</li>
<li><p><strong>keyBy：</strong></p>
<img src="/2021/04/25/flink/image-20210429131832931.png" alt="image-20210429131832931" style="zoom:80%;">

<ul>
<li><p>DataStream —&gt; KeyedStream：逻辑地将一个流拆分成不相交的分组，每个分组包含具有相同 key 的元素，在内部以 hash 的形式实现的。</p>
</li>
<li><p><strong>keyBy 会重新分组。相同的 key 一定在同一个分组，而不同的 key 可能会在一个分组，因为是通过 hash 原理实现的，可能存在取模操作。</strong></p>
</li>
<li><p>keyBy 不是计算操作。</p>
</li>
<li><p>keyBy 可以按照元组的位置，或者对象的属性名分组，在 Flink 新版本中，有一些方法被弃用，可以用其他的方法替换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;K&gt; <span class="function">KeyedStream&lt;T, K&gt; <span class="title">keyBy</span><span class="params">(KeySelector&lt;T, K&gt; key)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KeyedStream(<span class="keyword">this</span>, (KeySelector)<span class="keyword">this</span>.clean(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;K&gt; <span class="function">KeyedStream&lt;T, K&gt; <span class="title">keyBy</span><span class="params">(KeySelector&lt;T, K&gt; key, TypeInformation&lt;K&gt; keyType)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(key);</span><br><span class="line">    Preconditions.checkNotNull(keyType);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KeyedStream(<span class="keyword">this</span>, (KeySelector)<span class="keyword">this</span>.clean(key), keyType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> KeyedStream&lt;T, Tuple&gt; <span class="title">keyBy</span><span class="params">(<span class="keyword">int</span>... fields)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !(<span class="keyword">this</span>.getType() <span class="keyword">instanceof</span> BasicArrayTypeInfo) &amp;&amp; !(<span class="keyword">this</span>.getType() <span class="keyword">instanceof</span> PrimitiveArrayTypeInfo) ? <span class="keyword">this</span>.keyBy((Keys)(<span class="keyword">new</span> ExpressionKeys(fields, <span class="keyword">this</span>.getType()))) : <span class="keyword">this</span>.keyBy((KeySelector)KeySelectorUtil.getSelectorForArray(fields, <span class="keyword">this</span>.getType()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> KeyedStream&lt;T, Tuple&gt; <span class="title">keyBy</span><span class="params">(String... fields)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.keyBy((Keys)(<span class="keyword">new</span> ExpressionKeys(fields, <span class="keyword">this</span>.getType())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>滚动聚合算子 (Rolling Aggregation)：</strong></p>
<ul>
<li><p>这些算子可以针对 KeyedStream 的每一个支流做聚合，包括：</p>
<ul>
<li><strong><code>sum()</code></strong></li>
<li><strong><code>min()</code></strong></li>
<li><strong><code>max()</code></strong></li>
<li><strong><code>minBy()</code></strong></li>
<li><strong><code>maxBy()</code></strong></li>
</ul>
</li>
<li><p><strong><code>min()</code>、<code>max()</code> 和 <code>minBy()</code>、<code>maxBy()</code> 的区别在于：前者每次输出时，只有作为参数比较的字段会更新，其他字段不变；而后者除了作为参数比较的字段会更新，其他的字段会一起更新。</strong></p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/30 9:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest2_RollingAggregation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.按照SensorReading对象的id分组</span></span><br><span class="line">        <span class="comment">// 方式一：直接以属性名作为参数，此方法已弃用</span></span><br><span class="line">        <span class="comment">/*KeyedStream&lt;SensorReading, Tuple&gt; keyedStream = dataStream.keyBy(&quot;id&quot;);*/</span></span><br><span class="line">        <span class="comment">// 方式二：以KeySelector作为参数</span></span><br><span class="line">        <span class="comment">/*KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(new KeySelector&lt;SensorReading, String&gt;() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public String getKey(SensorReading sensorReading) throws Exception &#123;</span></span><br><span class="line"><span class="comment">                return sensorReading.getId();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;);*/</span></span><br><span class="line">        <span class="comment">// 方式三：方式二的Lambda表达式版</span></span><br><span class="line">        KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(SensorReading::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.滚动聚合，取当前最大的温度值，可以输入对象的属性名，或者元组里面的位置</span></span><br><span class="line">        <span class="comment">// DataStream&lt;SensorReading&gt; resultStream = keyedStream.max(&quot;temperature&quot;);</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; resultStream = keyedStream.maxBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.打印</span></span><br><span class="line">        resultStream.print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>max()</code> 输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">result:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">result:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为是滚动更新，对于每一个分组，每次来一条数据时，都会输出一次历史最大值，所以有的数据才会出现多次。</p>
<p>sensor_7 和 sensor_10 各属于一个分组 (线程2 和线程 4)，但各只有一条数据。sensor_6 和 sensor_1 在同一个分组 (线程 3)，sensor_6 只有一条数据，对于 sensor_1，有四条数据，temperature 最大值为 37.1，输出了四次，但每次只更新了 temperature 的值，其他字段的值没有更新。</p>
</blockquote>
</li>
<li><p><code>maxBy()</code> 输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">result:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">result:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">result:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于 sensor_1 的四条数据，每次输出时，除了更新 temperature 的值，其他字段的值也一起更新，但保留时间戳仍是当前 temperature 最大值对应的时间戳，而这个时间戳可能不是实时的值，比如第 9 行，其时间戳应该是 1547718209 (32.8 度的时间戳)，而不是 1547718207。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>reduce：</strong></p>
<ul>
<li><p><strong>reduce，归约，适用于更加一般化的聚合操作场景</strong>。比如：在读取文件内容时，可以使用 reduce 算子将前后两行加起来，最终组成完整的文件内容。</p>
</li>
<li><p><strong>KeyedStream —&gt; DataStream：一个分组数据流的聚合操作，合并当前的元素和上次聚合的结果，产生一个新的值，返回的流中包含每一次聚合的结果，而不是只返回最后一次聚合的最终结果。(返回值类型与传入类型一致，不能改变)</strong></p>
</li>
<li><p>在前面 Rolling Aggregation 的前提下，对需求进行修改。获取同组历史温度最高的传感器信息，并要求实时更新其时间戳信息。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/30 16:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest3_Reduce</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置并行度为1，能更好的体验效果，sensor.txt从上到下时间戳是递增的</span></span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.按照SensorReading对象的id分组</span></span><br><span class="line">        KeyedStream&lt;SensorReading, String&gt; keyedStream = dataStream.keyBy(SensorReading::getId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.reduce聚合，取每个分组最大的温度值，并更新为当前最新的时间戳</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; resultStream = keyedStream.reduce(<span class="keyword">new</span> ReduceFunction&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="comment">// curSensor：上次聚合的结果，newSensor：当前的元素</span></span><br><span class="line">            <span class="comment">// 对同一个分组，id值一直是相同的</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> SensorReading <span class="title">reduce</span><span class="params">(SensorReading curSensor, SensorReading newSensor)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(curSensor.getId(), newSensor.getTimestamp(),</span><br><span class="line">                        Math.max(curSensor.getTemperature(), newSensor.getTemperature()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.打印</span></span><br><span class="line">        resultStream.print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">result&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于 sensor_1 的四条数据，从第 8 行开始，每次输出时，temperature 都是当前历史温度的最高值，而时间戳也在实时更新。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="多流转换算子"><a href="#多流转换算子" class="headerlink" title="多流转换算子"></a>多流转换算子</h4><ul>
<li><p>多流转换算子一般包括：</p>
<ul>
<li>split 和 select (Filink 1.12.1 版本被移除)</li>
<li>connect 和 coMap</li>
<li>union</li>
</ul>
</li>
<li><p>split 和 select：</p>
<ul>
<li><p>split：</p>
<img src="/2021/04/25/flink/image-20210504093752377.png" alt="image-20210504093752377" style="zoom:80%;">

<ul>
<li><strong>DataStream —&gt; SplitStream</strong>：根据某些特征把一个 DataStream 拆分成两个或者多个 DataStream。</li>
</ul>
</li>
<li><p>select：</p>
<img src="/2021/04/25/flink/image-20210504093831460.png" alt="image-20210504093831460" style="zoom:80%;">

<ul>
<li>SplitStream —&gt; DataStream：从一个 SplitStream 中获取一个或者多个 DataStream。</li>
</ul>
</li>
<li><p>split 和 select 需要结合使用。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/2 11:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest4_MultipleStreams</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.分流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 可以获得多个分流，此处按温度是否超过30℃设置了两个分流</span></span><br><span class="line">                <span class="keyword">return</span> (sensorReading.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) :</span><br><span class="line">                        Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.获取分流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; allTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>, <span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.打印</span></span><br><span class="line">        highTempStream.print(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        lowTempStream.print(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        allTempStream.print(<span class="string">&quot;all&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上代码，可使用 Flink 1.11.1 版本测试。</p>
</blockquote>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">all:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">all:<span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">high:<span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">all:<span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">high:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">all:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">all:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">high:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">all:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">low:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">high:<span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">all:<span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">high:<span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">low:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>connect 和 coMap/coFlatMap：</strong></p>
<ul>
<li><p>connect：</p>
<img src="/2021/04/25/flink/image-20210504093142847.png" alt="image-20210504093142847" style="zoom:80%;">

<ul>
<li><strong>DataStream，DataStream —&gt; ConnectedStreams</strong>：连接两个保持他们类型的数据流，两个数据流被 Connect 之后，只是被放在了同一个流中，其内部依然保持各自的数据和形式不发生任何变化，两个流相互独立。</li>
</ul>
</li>
<li><p>coMap/coFlatMap：</p>
<img src="/2021/04/25/flink/image-20210504094045828.png" alt="image-20210504094045828" style="zoom:80%;">

<ul>
<li><strong>ConnectedStreams —&gt; DataStream</strong>：作用于 ConnectedStreams 上，功能与 map 和 flatMap 一样，对 ConnectedStreams 中的每一个 Stream 分别进行 map 和 flatMap 处理。</li>
</ul>
</li>
<li><p>connect 和 coMap/coFlatMap 需要结合使用。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/2 11:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest4_MultipleStreams2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.分流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 可以获得多个分流，此处按温度是否超过30℃设置了两个分流</span></span><br><span class="line">                <span class="keyword">return</span> (sensorReading.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) :</span><br><span class="line">                        Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.获取分流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; allTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>, <span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.合流connect，将高温流转换成二元组类型，再与低温流连接合并之后，输出状态信息</span></span><br><span class="line">        <span class="comment">// org.apache.flink.api.java.tuple.Tuple2</span></span><br><span class="line">        <span class="comment">// org.apache.flink.api.java.tuple.Tuple3</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Double&gt;&gt; warningStream = highTempStream.map(<span class="keyword">new</span> MapFunction&lt;SensorReading, Tuple2&lt;String, Double&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Double&gt; <span class="title">map</span><span class="params">(SensorReading sensorReading)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(sensorReading.getId(), sensorReading.getTemperature());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ConnectedStreams&lt;Tuple2&lt;String, Double&gt;, SensorReading&gt; connectedStreams = warningStream.connect(lowTempStream);</span><br><span class="line">        SingleOutputStreamOperator&lt;Object&gt; resultStream = connectedStreams.map(<span class="keyword">new</span> CoMapFunction&lt;Tuple2&lt;String, Double&gt;, SensorReading, Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">map1</span><span class="params">(Tuple2&lt;String, Double&gt; stringDoubleTuple2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple3&lt;&gt;(stringDoubleTuple2.f0, stringDoubleTuple2.f1, <span class="string">&quot;high temperature warning&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">map2</span><span class="params">(SensorReading sensorReading)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple3&lt;&gt;(sensorReading.getId(), sensorReading.getTemperature(), <span class="string">&quot;normal temperature&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">3</span>&gt; (sensor_1,<span class="number">35.8</span>,high temperature warning)</span><br><span class="line"><span class="number">2</span>&gt; (sensor_1,<span class="number">32.8</span>,high temperature warning)</span><br><span class="line"><span class="number">1</span>&gt; (sensor_1,<span class="number">36.3</span>,high temperature warning)</span><br><span class="line"><span class="number">4</span>&gt; (sensor_6,<span class="number">15.4</span>,normal temperature)</span><br><span class="line"><span class="number">3</span>&gt; (sensor_1,<span class="number">37.1</span>,high temperature warning)</span><br><span class="line"><span class="number">5</span>&gt; (sensor_7,<span class="number">6.7</span>,normal temperature)</span><br><span class="line"><span class="number">6</span>&gt; (sensor_10,<span class="number">38.1</span>,high temperature warning)</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>union：</strong></p>
<img src="/2021/04/25/flink/image-20210504114937037.png" alt="image-20210504114937037" style="zoom:80%;">

<ul>
<li><p><strong>DataStream —&gt; DataStream</strong>：对两个或者两个以上的 DataStream 进行 union 操作，产生一个包含所有 DataStream 元素的新 DataStream。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/2 11:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest4_MultipleStreams3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.分流</span></span><br><span class="line">        SplitStream&lt;SensorReading&gt; splitStream = dataStream.split(<span class="keyword">new</span> OutputSelector&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterable&lt;String&gt; <span class="title">select</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 可以获得多个分流，此处按温度是否超过30℃设置了两个分流</span></span><br><span class="line">                <span class="keyword">return</span> (sensorReading.getTemperature() &gt; <span class="number">30</span>) ? Collections.singletonList(<span class="string">&quot;high&quot;</span>) :</span><br><span class="line">                        Collections.singletonList(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.获取分流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; highTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; lowTempStream = splitStream.select(<span class="string">&quot;low&quot;</span>);</span><br><span class="line">        DataStream&lt;SensorReading&gt; allTempStream = splitStream.select(<span class="string">&quot;high&quot;</span>, <span class="string">&quot;low&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.联合两个分流</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; unionStream = highTempStream.union(lowTempStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.打印</span></span><br><span class="line">        unionStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line"><span class="number">6</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"><span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>connect 与 union 区别：</p>
<ul>
<li>执行 union 操作的流的类型必须是一样，connect 可以不一样，可以在之后的 coMap 中再调整为一样的类型。</li>
<li>connect 只能合并两个流，union 可以合并多个流。</li>
</ul>
</li>
</ul>
<h4 id="算子转换"><a href="#算子转换" class="headerlink" title="算子转换"></a>算子转换</h4><img src="/2021/04/25/flink/image-20210504165018734.png" alt="image-20210504165018734" style="zoom:80%;">

<ul>
<li>在 Flink 中，<strong>Transformation 算子就是将一个或多个 DataStream 转换为新的 DataStream</strong>，可以将多个转换组合成复杂的数据流拓扑。 如上图所示，DataStream 会由不同的 Transformation 操作，转换、过滤、聚合成其他不同的流，从而完成我们的业务要求。</li>
</ul>
<h3 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h3><ul>
<li>Flink 流应用程序处理的是以数据对象表示的事件流。所以在 Flink 内部，我们需要能够处理这些对象。它们<strong>需要被序列化和反序列化</strong>，以便通过网络传送它们；或者从状态后端、检查点和保存点读取它们。为了有效地做到这一点，Flink 需要明确知道应用程序所处理的数据类型。<strong>Flink 使用类型信息的概念来表示数据类型，并为每个数据类型生成特定的序列化器、反序列化器和比较器。</strong></li>
<li><strong>Flink 还具有一个类型提取系统，该系统分析函数的输入和返回类型，以自动获取类型信息，从而获得序列化器和反序列化器。</strong>但是，在某些情况下，例如 lambda 函数或泛型类型，需要显式地提供类型信息，才能使应用程序正常工作或提高其性能。</li>
<li>Flink 支持 Java 和 Scala 中所有常见数据类型。使用最广泛的类型有以下几种。</li>
</ul>
<h4 id="基础数据类型"><a href="#基础数据类型" class="headerlink" title="基础数据类型"></a>基础数据类型</h4><ul>
<li><p>Flink 支持所有的 Java 和 Scala 基础数据类型，Int，Double，Long，String，…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Integer&gt; numberStream = env.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">numberStream.map(data -&gt; data * <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Java-和-和-Scala-元组-Tuples"><a href="#Java-和-和-Scala-元组-Tuples" class="headerlink" title="Java 和 和 Scala 元组 (Tuples)"></a>Java 和 和 Scala 元组 (Tuples)</h4><ul>
<li><p>Java 不像 Scala 天生支持元组 Tuple 类型，Java 的元组类型由 Flink 的包提供，默认提供 Tuple0 ~ Tuple25。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; personStream = env.fromElements(</span><br><span class="line">        <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="string">&quot;Adam&quot;</span>, <span class="number">17</span>), <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="string">&quot;Sarah&quot;</span>, <span class="number">23</span>));</span><br><span class="line">personStream.filter(p -&gt; p.f1 &gt; <span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>包位置：<code>import org.apache.flink.api.java.tuple.Tuple2;</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Public</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Tuple</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARITY = <span class="number">25</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] CLASSES = <span class="keyword">new</span> Class[]&#123;Tuple0.class, Tuple1.class, Tuple2.class, Tuple3.class, Tuple4.class, Tuple5.class, Tuple6.class, Tuple7.class, Tuple8.class, Tuple9.class, Tuple10.class, Tuple11.class, Tuple12.class, Tuple13.class, Tuple14.class, Tuple15.class, Tuple16.class, Tuple17.class, Tuple18.class, Tuple19.class, Tuple20.class, Tuple21.class, Tuple22.class, Tuple23.class, Tuple24.class, Tuple25.class&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">getField</span><span class="params">(<span class="keyword">int</span> var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getFieldNotNull</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">        T field = <span class="keyword">this</span>.getField(pos);</span><br><span class="line">        <span class="keyword">if</span> (field != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> field;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullFieldException(pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">setField</span><span class="params">(T var1, <span class="keyword">int</span> var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getArity</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T extends Tuple&gt; <span class="function">T <span class="title">copy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;? extends Tuple&gt; getTupleClass(<span class="keyword">int</span> arity) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arity &gt;= <span class="number">0</span> &amp;&amp; arity &lt;= <span class="number">25</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> CLASSES[arity];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;The tuple arity must be in [0, 25].&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Tuple <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> arity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(arity) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> Tuple0.INSTANCE;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple1();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple3();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple4();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple5();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple6();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple7();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple8();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple9();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple10();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple11();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple12();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple13();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple14();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple15();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple16();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple17();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple18();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">19</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple19();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple20();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">21</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple21();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">22</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple22();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">23</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple23();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">24</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple24();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">25</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple25();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;The tuple arity must be in [0, 25].&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Scala-样例类-case-classes"><a href="#Scala-样例类-case-classes" class="headerlink" title="Scala 样例类 (case classes)"></a>Scala 样例类 (case classes)</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">val</span> <span class="title">persons</span></span>: <span class="type">DataStream</span>[<span class="type">Person</span>] = env.fromElements(<span class="type">Person</span>(<span class="string">&quot;Adam&quot;</span>, <span class="number">17</span>), <span class="type">Person</span>(<span class="string">&quot;Sarah&quot;</span>, <span class="number">23</span>))</span><br><span class="line">persons.filter(p =&gt; p.age &gt; <span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Java-简单对象-POJO"><a href="#Java-简单对象-POJO" class="headerlink" title="Java 简单对象 (POJO)"></a>Java 简单对象 (POJO)</h4><ul>
<li><p>要求必须提供无参构造函数。</p>
</li>
<li><p>要求成员变量都是 public，或者 private 的但提供 getter、setter 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataStream</span> <span class="type">Person</span> &gt; persons = env.fromElements(</span><br><span class="line">        <span class="keyword">new</span> <span class="type">Person</span>(<span class="string">&quot;Alex&quot;</span>, <span class="number">42</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="type">Person</span>(<span class="string">&quot;Wendy&quot;</span>, <span class="number">23</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="其它-Arrays，Lists，Maps，Enums，等等"><a href="#其它-Arrays，Lists，Maps，Enums，等等" class="headerlink" title="其它 (Arrays，Lists，Maps，Enums，等等)"></a>其它 (Arrays，Lists，Maps，Enums，等等)</h4><ul>
<li>Flink 对 Java 和 Scala 中的一些特殊目的的类型也都是支持的，比如 Java 的 ArrayList，HashMap，Enum 等等。</li>
</ul>
<h3 id="实现-UDF-函数——更细粒度的控制流"><a href="#实现-UDF-函数——更细粒度的控制流" class="headerlink" title="实现 UDF 函数——更细粒度的控制流"></a>实现 UDF 函数——更细粒度的控制流</h3><h4 id="函数类-Function-Classes"><a href="#函数类-Function-Classes" class="headerlink" title="函数类 (Function Classes)"></a>函数类 (Function Classes)</h4><ul>
<li><p>Flink 暴露了所有 udf 函数的接口 (实现方式为接口或者抽象类)。例如 MapFunction，FilterFunction，ProcessFunction 等等。</p>
</li>
<li><p>下面的例子，实现了 FilterFunction 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> FlinkFilter());</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkFilter</span> <span class="keyword">implements</span> <span class="title">FilterFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>还可以将函数实现成匿名类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> FilterFunction&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要 filter 的字符串 “flink” 可以当作参数传进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = env.readTextFile(<span class="string">&quot;INPUT_FILE &quot;</span>);</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> KeyWordFilter(<span class="string">&quot;flink&quot;</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyWordFilter</span> <span class="keyword">implements</span> <span class="title">FilterFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String keyWord;</span><br><span class="line"></span><br><span class="line">    KeyWordFilter(String keyWord) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keyWord = keyWord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value.contains(<span class="keyword">this</span>.keyWord);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = env.readTextFile(<span class="string">&quot;INPUT_FILE&quot;</span>);</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(tweet -&gt; tweet.contains(<span class="string">&quot;flink&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="富函数-Rich-Functions"><a href="#富函数-Rich-Functions" class="headerlink" title="富函数 (Rich Functions)"></a>富函数 (Rich Functions)</h4><ul>
<li><p>富函数是 DataStream API 提供的一个函数类的接口，所有 Flink 函数类都有其 Rich 版本。</p>
</li>
<li><p><strong>它与常规函数的不同在于，可以获取运行环境的上下文，并拥有一些生命周期方法，所以可以实现更复杂的功能</strong>。</p>
<ul>
<li>RichMapFunction</li>
<li>RichFlatMapFunction</li>
<li>RichFilterFunction</li>
<li>…</li>
</ul>
</li>
<li><p>Rich Function 有一个<strong>生命周期</strong>的概念。典型的生命周期方法有：</p>
<ul>
<li><code>open()</code> 是 RichFunction 的初始化方法，当一个算子例如 map 或者 filter 被调用之前，<code>open()</code> 会被调用。</li>
<li><code>close()</code> 是生命周期中的最后一个调用的方法，做一些清理工作。</li>
<li><code>getRuntimeContext()</code> 提供了函数的 RuntimeContext 的一些信息，例如函数执行的并行度，任务的名字，以及 state 状态。</li>
</ul>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/5 14:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest5_RichFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Tuple2&lt;Integer, String&gt;&gt; resultStream = dataStream.map(<span class="keyword">new</span> MyMapper());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传统的Function不能获取上下文信息，只能处理当前数据，不能和其他数据交互</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper0</span> <span class="keyword">implements</span> <span class="title">MapFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">map</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(value.getId(), value.getId().length());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义富函数类(RichMapFunction是一个abstract类)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">RichMapFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;Integer, String&gt; <span class="title">map</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// getRuntimeContext().getState();</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(getRuntimeContext().getIndexOfThisSubtask() + <span class="number">1</span>, value.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 初始化工作，一般是定义状态，或者建立数据库连接</span></span><br><span class="line">            System.out.println(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 一般是关闭连接和清空状态的收尾操作</span></span><br><span class="line">            System.out.println(<span class="string">&quot;close&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">open</span><br><span class="line">open</span><br><span class="line">open</span><br><span class="line">open</span><br><span class="line"><span class="number">2</span>&gt; (<span class="number">2</span>,sensor_7)</span><br><span class="line"><span class="number">2</span>&gt; (<span class="number">2</span>,sensor_1)</span><br><span class="line"><span class="number">3</span>&gt; (<span class="number">3</span>,sensor_10)</span><br><span class="line"><span class="number">1</span>&gt; (<span class="number">1</span>,sensor_6)</span><br><span class="line"><span class="number">1</span>&gt; (<span class="number">1</span>,sensor_1)</span><br><span class="line">close</span><br><span class="line">close</span><br><span class="line"><span class="number">4</span>&gt; (<span class="number">4</span>,sensor_1)</span><br><span class="line"><span class="number">4</span>&gt; (<span class="number">4</span>,sensor_1)</span><br><span class="line">close</span><br><span class="line">close</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于设置了执行环境 env 的并行度为 4，所以有 4 个 slot 执行自定义的 RichFunction，输出 4 次 open 和 close。</p>
</blockquote>
</li>
</ul>
<h3 id="数据重分区操作"><a href="#数据重分区操作" class="headerlink" title="数据重分区操作"></a>数据重分区操作</h3><ul>
<li><p>在多并行度的情况下，Flink 对数据的分配方式有多种：</p>
<p><img src="/2021/04/25/flink/image-20210506104650689.png" alt="image-20210506104650689"></p>
</li>
<li><p>常用的分配方式有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are broadcasted</span></span><br><span class="line"><span class="comment"> * to every parallel instance of the next operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with broadcast partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">broadcast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> BroadcastPartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are broadcasted</span></span><br><span class="line"><span class="comment"> * to every parallel instance of the next operation. In addition, it implicitly as many &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * org.apache.flink.api.common.state.BroadcastState broadcast states&#125; as the specified</span></span><br><span class="line"><span class="comment"> * descriptors which can be used to store the element of the stream.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> broadcastStateDescriptors the descriptors of the broadcast states to create.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A &#123;<span class="doctag">@link</span> BroadcastStream&#125; which can be used in the &#123;<span class="doctag">@link</span> #connect(BroadcastStream)&#125;</span></span><br><span class="line"><span class="comment"> *     to create a &#123;<span class="doctag">@link</span> BroadcastConnectedStream&#125; for further processing of the elements.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BroadcastStream&lt;T&gt; <span class="title">broadcast</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> MapStateDescriptor&lt;?, ?&gt;... broadcastStateDescriptors)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(broadcastStateDescriptors);</span><br><span class="line">    <span class="keyword">final</span> DataStream&lt;T&gt; broadcastStream = setConnectionType(<span class="keyword">new</span> BroadcastPartitioner&lt;&gt;());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BroadcastStream&lt;&gt;(environment, broadcastStream, broadcastStateDescriptors);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are shuffled</span></span><br><span class="line"><span class="comment"> * uniformly randomly to the next operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with shuffle partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">shuffle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> ShufflePartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are forwarded to</span></span><br><span class="line"><span class="comment"> * the local subtask of the next operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with forward partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">forward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> ForwardPartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are distributed</span></span><br><span class="line"><span class="comment"> * evenly to instances of the next operation in a round-robin fashion.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with rebalance partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">rebalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> RebalancePartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output elements are distributed</span></span><br><span class="line"><span class="comment"> * evenly to a subset of instances of the next operation in a round-robin fashion.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The subset of downstream operations to which the upstream operation sends elements depends</span></span><br><span class="line"><span class="comment"> * on the degree of parallelism of both the upstream and downstream operation. For example, if</span></span><br><span class="line"><span class="comment"> * the upstream operation has parallelism 2 and the downstream operation has parallelism 4, then</span></span><br><span class="line"><span class="comment"> * one upstream operation would distribute elements to two downstream operations while the other</span></span><br><span class="line"><span class="comment"> * upstream operation would distribute to the other two downstream operations. If, on the other</span></span><br><span class="line"><span class="comment"> * hand, the downstream operation has parallelism 2 while the upstream operation has parallelism</span></span><br><span class="line"><span class="comment"> * 4 then two upstream operations will distribute to one downstream operation while the other</span></span><br><span class="line"><span class="comment"> * two upstream operations will distribute to the other downstream operations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;In cases where the different parallelisms are not multiples of each other one or several</span></span><br><span class="line"><span class="comment"> * downstream operations will have a differing number of inputs from upstream operations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with rescale partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">rescale</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> RescalePartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the partitioning of the &#123;<span class="doctag">@link</span> DataStream&#125; so that the output values all go to the first</span></span><br><span class="line"><span class="comment"> * instance of the next processing operator. Use this setting with care since it might cause a</span></span><br><span class="line"><span class="comment"> * serious performance bottleneck in the application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The DataStream with shuffle partitioning set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataStream&lt;T&gt; <span class="title">global</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setConnectionType(<span class="keyword">new</span> GlobalPartitioner&lt;T&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>默认情况下，使用的分配方式是 rebalance 策略，即轮询。</strong></p>
</li>
<li><p><strong>DataStream 类中，<code>partitionCustom(...)</code> 用于自定义重分区</strong>。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/5 17:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformTest6_Partition</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);<span class="comment">// SingleOutputStreamOperator</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.SingleOutputStreamOperator多并行度时，默认分配方式是rebalance，即轮询方式分配</span></span><br><span class="line">        dataStream.print(<span class="string">&quot;rebalance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.shuffle (并非批处理中的获取一批后才打乱，这里每次获取到直接打乱且分区)</span></span><br><span class="line">        DataStream&lt;String&gt; shuffleStream = inputStream.shuffle();</span><br><span class="line">        shuffleStream.print(<span class="string">&quot;shuffle&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.keyBy (按Hash，然后取模)</span></span><br><span class="line">        dataStream.keyBy(SensorReading::getId).print(<span class="string">&quot;keyBy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.global (直接发送给第一个分区，少数特殊情况才用)</span></span><br><span class="line">        dataStream.global().print(<span class="string">&quot;global&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#StaticLoggerBinder for further details.</span></span><br><span class="line">shuffle:<span class="number">2</span>&gt; sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">shuffle:<span class="number">3</span>&gt; sensor_1,<span class="number">1547718207</span>,<span class="number">36.3</span></span><br><span class="line">shuffle:<span class="number">3</span>&gt; sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br><span class="line">rebalance:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">shuffle:<span class="number">4</span>&gt; sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">shuffle:<span class="number">1</span>&gt; sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">shuffle:<span class="number">4</span>&gt; sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">rebalance:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">rebalance:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">rebalance:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">rebalance:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">rebalance:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">shuffle:<span class="number">4</span>&gt; sensor_1,<span class="number">1547718209</span>,<span class="number">32.8</span></span><br><span class="line">rebalance:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">keyBy:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">keyBy:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">keyBy:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">keyBy:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">32.8</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">keyBy:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">global:<span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">keyBy:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718207</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">keyBy:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h3><ul>
<li><p>Flink 没有类似于 Spark 中的 foreach 方法，让用户进行迭代的操作。<strong>所有对外的输出操作都要利用 Sink 完成</strong>，最后通过类似如下的方式，完成整个任务的最终输出操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream.addSink(<span class="keyword">new</span> MySink(xxxx))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Flink 官方提供了一部分框架的 Sink。除此以外，需要用户自定义实现 Sink。</p>
</li>
<li><p>地址：<a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/connectors/datastream/overview/">https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/connectors/datastream/overview/</a></p>
<p><img src="/2021/04/25/flink/image-20210506131527104.png" alt="image-20210506131527104"></p>
</li>
</ul>
<h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><ul>
<li><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/6 12:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinkTest1_Kafka</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建Kafka消费者</span></span><br><span class="line">        Properties consumerProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        consumerProperties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        consumerProperties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>);</span><br><span class="line">        consumerProperties.setProperty(<span class="string">&quot;auto.offset.reset&quot;</span>, <span class="string">&quot;latest&quot;</span>);</span><br><span class="line">        consumerProperties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        consumerProperties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        FlinkKafkaConsumer&lt;String&gt; consumer = <span class="keyword">new</span> FlinkKafkaConsumer&lt;&gt;(<span class="string">&quot;sensor&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), consumerProperties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Kafka读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.addSource(consumer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.序列化从Kafka中读取的数据</span></span><br><span class="line">        DataStream&lt;String&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>])).toString();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.创建Kafka生产者</span></span><br><span class="line">        Properties producerProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        producerProperties.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        producerProperties.put(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;producer-group&quot;</span>);</span><br><span class="line">        producerProperties.put(<span class="string">&quot;key.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        producerProperties.put(<span class="string">&quot;value.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.ByteArraySerializer&quot;</span>);</span><br><span class="line">        FlinkKafkaProducer&lt;String&gt; producer = <span class="keyword">new</span> FlinkKafkaProducer&lt;&gt;(<span class="string">&quot;sinkTest&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(), producerProperties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.将数据写入Kafka</span></span><br><span class="line">        dataStream.addSink(producer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><ul>
<li><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/6 12:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinkTest2_Redis</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.定义jedis连接配置(我这里连接的是docker的redis)</span></span><br><span class="line">        FlinkJedisPoolConfig redisConfig = <span class="keyword">new</span> FlinkJedisPoolConfig.Builder()</span><br><span class="line">                .setHost(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">                .setPort(<span class="number">6379</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">                .setDatabase(<span class="number">0</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.将数据写入Redis</span></span><br><span class="line">        dataStream.addSink(<span class="keyword">new</span> RedisSink&lt;&gt;(redisConfig, <span class="keyword">new</span> MyRedisMapper()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.自定义RedisMapper</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisMapper</span> <span class="keyword">implements</span> <span class="title">RedisMapper</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义保存数据到Redis的命令，存成哈希表：hset sensor_temp id temperature</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.HSET, <span class="string">&quot;sensor_temp&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> sensorReading.getId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> sensorReading.getTemperature().toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 Redis 数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">localhost:0&gt;hgetall sensor_temp</span><br><span class="line">1) &quot;sensor_1&quot;</span><br><span class="line">2) &quot;37.1&quot;</span><br><span class="line">3) &quot;sensor_6&quot;</span><br><span class="line">4) &quot;15.4&quot;</span><br><span class="line">5) &quot;sensor_7&quot;</span><br><span class="line">6) &quot;6.7&quot;</span><br><span class="line">7) &quot;sensor_10&quot;</span><br><span class="line">8) &quot;38.1&quot;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h4><ul>
<li><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-elasticsearch7_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/6 12:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinkTest3_Es</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.定义es的连接配置</span></span><br><span class="line">        List&lt;HttpHost&gt; httpHosts = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">// org.apache.http.HttpHost;</span></span><br><span class="line">        httpHosts.add(<span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.将数据写入es</span></span><br><span class="line">        dataStream.addSink(<span class="keyword">new</span> ElasticsearchSink.Builder&lt;&gt;(httpHosts, <span class="keyword">new</span> MyEsSinkFunction()).build());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.实现自定义的ES写入操作</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEsSinkFunction</span> <span class="keyword">implements</span> <span class="title">ElasticsearchSinkFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(SensorReading sensorReading, RuntimeContext runtimeContext, RequestIndexer requestIndexer)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 定义写入的数据source</span></span><br><span class="line">            HashMap&lt;String, String&gt; dataSource = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">            dataSource.put(<span class="string">&quot;id&quot;</span>, sensorReading.getId());</span><br><span class="line">            dataSource.put(<span class="string">&quot;temp&quot;</span>, sensorReading.getTemperature().toString());</span><br><span class="line">            dataSource.put(<span class="string">&quot;ts&quot;</span>, sensorReading.getTimestamp().toString());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建请求，作为向es发起的写入命令(ES7统一type就是_doc，不再允许指定type)</span></span><br><span class="line">            IndexRequest indexRequest = Requests.indexRequest()</span><br><span class="line">                    .index(<span class="string">&quot;sensor&quot;</span>)</span><br><span class="line">                    .source(dataSource);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 用index发送请求</span></span><br><span class="line">            requestIndexer.add(indexRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 ElasticSearch 数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl <span class="string">&quot;localhost:9200/sensor/_search?pretty&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 1,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 7,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;jciyWXcBiXrGJa12kSQt&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;35.8&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_1&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718199&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;jsiyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;15.4&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_6&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718201&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;j8iyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;6.7&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_7&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718202&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;kMiyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;38.1&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_10&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718205&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;kciyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;36.3&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_1&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718207&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;ksiyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;32.8&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_1&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718209&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;sensor&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;k8iyWXcBiXrGJa12kSQu&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;temp&quot; : &quot;37.1&quot;,</span><br><span class="line">          &quot;id&quot; : &quot;sensor_1&quot;,</span><br><span class="line">          &quot;ts&quot; : &quot;1547718212&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="JDBC-自定义-Sink"><a href="#JDBC-自定义-Sink" class="headerlink" title="JDBC 自定义 Sink"></a>JDBC 自定义 Sink</h4><ul>
<li><p>以 MySQL 为例，添加 MySQL 连接依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/6 13:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinkTest4_Jdbc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从文件读取数据，单线程读取</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用之前编写的随机变动温度的SourceFunction来生成数据，数据一直生成</span></span><br><span class="line">        <span class="comment">/*DataStream&lt;SensorReading&gt; dataStream = env.addSource(new SourceTest4_UDF.MySensorSource());*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将数据写入MySQL</span></span><br><span class="line">        dataStream.addSink(<span class="keyword">new</span> MyJdbcSink());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.实现自定义的SinkFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJdbcSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 声明连接和预编译语句</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement insertStmt = <span class="keyword">null</span>;</span><br><span class="line">        PreparedStatement updateStmt = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            connection = DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/flink_test?useUnicode=true&amp;&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;serverTimezone=Asia/Shanghai&amp;characterEncoding=UTF-8&amp;useSSL=false&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;example&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建预编译语句，有占位符，可传入参数</span></span><br><span class="line">            insertStmt = connection.prepareStatement(<span class="string">&quot;insert into sensor_temp (id, temp) values (?, ?)&quot;</span>);</span><br><span class="line">            updateStmt = connection.prepareStatement(<span class="string">&quot;update sensor_temp set temp = ? where id = ?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每来一条数据，调用连接，执行sql</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(SensorReading sensorReading, Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 直接执行更新语句，如果没有更新那么就插入</span></span><br><span class="line">            updateStmt.setDouble(<span class="number">1</span>, sensorReading.getTemperature());</span><br><span class="line">            updateStmt.setString(<span class="number">2</span>, sensorReading.getId());</span><br><span class="line">            updateStmt.execute();</span><br><span class="line">            <span class="keyword">if</span> (updateStmt.getUpdateCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                insertStmt.setString(<span class="number">1</span>, sensorReading.getId());</span><br><span class="line">                insertStmt.setDouble(<span class="number">2</span>, sensorReading.getTemperature());</span><br><span class="line">                insertStmt.execute();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            insertStmt.close();</span><br><span class="line">            updateStmt.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 MySQL 数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM sensor_temp;</span></span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| id        | temp               |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| sensor_3  | 20.489172407885917 |</span><br><span class="line">| sensor_10 |  73.01289164711463 |</span><br><span class="line">| sensor_4  | 43.402500895809744 |</span><br><span class="line">| sensor_1  |  6.894772325662007 |</span><br><span class="line">| sensor_2  | 101.79309911751122 |</span><br><span class="line">| sensor_7  | 63.070612021580324 |</span><br><span class="line">| sensor_8  |  63.82606628090501 |</span><br><span class="line">| sensor_5  |  57.67115738487047 |</span><br><span class="line">| sensor_6  |  50.84442627975055 |</span><br><span class="line">| sensor_9  |  52.58400793021675 |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT * FROM sensor_temp;</span></span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| id        | temp               |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">| sensor_3  | 19.498209543035923 |</span><br><span class="line">| sensor_10 |  71.92981963197121 |</span><br><span class="line">| sensor_4  | 43.566017489470426 |</span><br><span class="line">| sensor_1  |  6.378208186786803 |</span><br><span class="line">| sensor_2  | 101.71010087830145 |</span><br><span class="line">| sensor_7  |  62.11402602179431 |</span><br><span class="line">| sensor_8  |  64.33196455020062 |</span><br><span class="line">| sensor_5  |  56.39071692662006 |</span><br><span class="line">| sensor_6  | 48.952784757264894 |</span><br><span class="line">| sensor_9  | 52.078086096436685 |</span><br><span class="line">+-----------+--------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Flink-的-Window"><a href="#Flink-的-Window" class="headerlink" title="Flink 的 Window"></a>Flink 的 Window</h2><h3 id="Window-概述"><a href="#Window-概述" class="headerlink" title="Window 概述"></a>Window 概述</h3><img src="/2021/04/25/flink/bounded-unbounded.png" alt="img" style="zoom: 33%;">

<ul>
<li>Streaming 流式计算是一种被设计用于处理无限数据集的数据处理引擎，无限数据集是指一种不断增长的本质上无限的数据集，而 <strong>Window 是一种切割无限数据为有限块进行处理的手段。</strong></li>
<li><strong>Window 是无限数据流处理的核心，Window 将一个无限的 stream 拆分成有限大小的 “buckets” 桶，我们可以在这些桶上做计算操作。</strong></li>
</ul>
<h3 id="Window-类型"><a href="#Window-类型" class="headerlink" title="Window 类型"></a>Window 类型</h3><h4 id="时间窗口-Time-Window"><a href="#时间窗口-Time-Window" class="headerlink" title="时间窗口 (Time Window)"></a>时间窗口 (Time Window)</h4><ul>
<li><p>按照时间生成 Window。</p>
</li>
<li><p><strong>滚动时间窗口 (Tumbling Windows)</strong></p>
<ul>
<li><p>滚动窗口分配器将每个元素分配到一个指定窗口大小的窗口中，滚动窗口有一个固定的大小，并且不会出现重叠。</p>
</li>
<li><p>原理：依据<strong>固定的窗口长度</strong>对数据进行切片。</p>
</li>
<li><p><strong>特点：时间对齐，窗口长度固定，没有重叠。</strong></p>
</li>
<li><p>适用场景：适合做 BI 统计等 (做每个时间段的聚合计算)。</p>
</li>
<li><p>例如，如果指定了一个 5 分钟大小的滚动窗口，窗口的创建如下图所示：</p>
<img src="/2021/04/25/flink/image-20210506215448736.png" alt="image-20210506215448736" style="zoom: 80%;">
</li>
</ul>
</li>
<li><p><strong>滑动时间窗口 (Sliding Windows)</strong></p>
<ul>
<li><p>滑动窗口是固定窗口的更广义的一种形式。滑动窗口分配器将元素分配到固定长度的窗口中，与滚动窗口类似，窗口的大小由窗口大小参数来配置，另一个窗口滑动参数控制滑动窗口开始的频率。因此，滑动窗口如果滑动参数小于窗口大小的话，窗口是可以重叠的，在这种情况下元素会被分配到多个窗口中。</p>
</li>
<li><p>原理：滑动窗口由<strong>固定的窗口长度</strong>和<strong>滑动间隔</strong>组成。</p>
</li>
<li><p><strong>特点：时间对齐，窗口长度固定，可以有重叠。</strong></p>
</li>
<li><p>适用场景：对最近一个时间段内的统计 (比如求某接口最近 5 min 的失败率来决定是否要报警)。</p>
</li>
<li><p>例如，你有 10 分钟的窗口和 5 分钟的滑动，那么每个窗口中 5 分钟的窗口里包含着上个 10 分钟产生的数据，如下图所示：</p>
<img src="/2021/04/25/flink/image-20210507095457119.png" alt="image-20210507095457119" style="zoom:80%;">
</li>
</ul>
</li>
<li><p><strong>会话窗口 (Session Windows)</strong></p>
<ul>
<li><p>session 窗口分配器通过 session 活动来对元素进行分组，session 窗口跟滚动窗口和滑动窗口相比，不会有重叠和固定的开始时间和结束时间的情况，相反，当它在一个固定的时间周期内不再收到元素，即非活动间隔产生，那个这个窗口就会关闭。一个 session 窗口通过一个 session 间隔来配置，这个 session 间隔定义了非活跃周期的长度，当这个非活跃周期产生，那么当前的 session 将关闭并且后续的元素将被分配到新的 session 窗口中去。</p>
</li>
<li><p>由一系列事件组合一个<strong>指定时间长度的 timeout 间隙</strong>组成，类似于 web 应用的 session，也就是一段时间没有接收到新数据就会生成新的窗口。</p>
</li>
<li><p><strong>特点：时间无对齐。</strong></p>
<img src="/2021/04/25/flink/image-20210507101757027.png" alt="image-20210507101757027" style="zoom:80%;">

</li>
</ul>
</li>
</ul>
<h4 id="计数窗口-Count-Window"><a href="#计数窗口-Count-Window" class="headerlink" title="计数窗口 (Count Window)"></a>计数窗口 (Count Window)</h4><ul>
<li><p>按照指定的数据条数生成一个 Window，与时间无关。</p>
</li>
<li><p><strong>滚动计数窗口</strong></p>
</li>
<li><p><strong>滑动计数窗口</strong></p>
</li>
</ul>
<h3 id="Window-API"><a href="#Window-API" class="headerlink" title="Window API"></a>Window API</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><ul>
<li><p>Flink 使用 <code>window()</code> 来定义一个窗口，然后基于这个 Window 去做一些聚合或者其他处理操作。</p>
<ul>
<li><p><code>window()</code> 是最基础的定义窗口的方法。</p>
</li>
<li><p><strong><code>window()</code> 必须在 keyBy 之后才能使用</strong>。</p>
<ul>
<li>DataStream 的 <code>windowAll()</code> 类似数据传输分区的 global 操作，这个操作是 non-parallel 的 (并行度强行为 1)，所有的数据都会被传递到同一个算子 operator 上，官方建议如果非必要就不要用这个 API。</li>
</ul>
</li>
<li><p><strong><code>window()</code> 之后需要有一个窗口函数。</strong></p>
</li>
<li><p>一个完整的窗口操作参考如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Double&gt;&gt; minTempPerWindowStream =</span><br><span class="line">        datastream								---&gt; 数据流</span><br><span class="line">                .map(<span class="keyword">new</span> MyMapper())</span><br><span class="line">                .keyBy(data -&gt; data.f0)			---&gt; 分组</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))	---&gt; 开窗</span><br><span class="line">                .minBy(<span class="number">1</span>);						---&gt; 窗口函数</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>window()</code> 需要接收一个输入参数：WindowAssigner (窗口分配器)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Windows this data stream to a &#123;<span class="doctag">@code</span> WindowedStream&#125;, which evaluates windows over a key</span></span><br><span class="line"><span class="comment"> * grouped stream. Elements are put into windows by a &#123;<span class="doctag">@link</span> WindowAssigner&#125;. The grouping of</span></span><br><span class="line"><span class="comment"> * elements is done both by key and by window.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;A &#123;<span class="doctag">@link</span> org.apache.flink.streaming.api.windowing.triggers.Trigger&#125; can be defined to</span></span><br><span class="line"><span class="comment"> * specify when windows are evaluated. However, &#123;<span class="doctag">@code</span> WindowAssigners&#125; have a default &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * Trigger&#125; that is used if a &#123;<span class="doctag">@code</span> Trigger&#125; is not specified.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> assigner The &#123;<span class="doctag">@code</span> WindowAssigner&#125; that assigns elements to windows.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The trigger windows data stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> &lt;W extends Window&gt; <span class="function">WindowedStream&lt;T, KEY, W&gt; <span class="title">window</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowAssigner&lt;? <span class="keyword">super</span> T, W&gt; assigner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WindowedStream&lt;&gt;(<span class="keyword">this</span>, assigner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>WindowAssigner 是一个抽象类，负责将每条输入的数据分发到正确的 Window 中。</p>
</li>
<li><p>WindowAssigner 的实现类位于 <code>org.apache.flink.streaming.api.windowing.assigners</code> 包下：</p>
<p><img src="/2021/04/25/flink/image-20210507152955485.png" alt="image-20210507152955485"></p>
<ul>
<li><p>说明：这些实现类的构造方法多是 protected 或 privated 的，需要通过类中的静态方法如 <code>of()</code> 或 <code>withGap()</code> 来获取一个实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dataStream</span><br><span class="line">        .keyBy(SensorReading::getId)</span><br><span class="line">        .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line">        .minBy(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>归纳起来，Flink 提供了四种类型通用的 WindowAssigner：</p>
<ul>
<li><strong>滚动窗口 (tumbling window)</strong></li>
<li><strong>滑动窗口 (sliding window)</strong></li>
<li><strong>会话窗口 (session window)</strong></li>
<li><strong>全局窗口 (global window)</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>除了 <code>.window()</code>，Flink 提供了更加简单的 <code>.timeWindow() </code> 和 <code>.countWindow() </code> 方法，用于定义时间窗口和计数窗口。</p>
</li>
</ul>
<h4 id="创建不同类型的窗口"><a href="#创建不同类型的窗口" class="headerlink" title="创建不同类型的窗口"></a>创建不同类型的窗口</h4><ul>
<li><p>Flink 创建窗口的方法有多种，实际使用时，按需求创建。</p>
</li>
<li><p>滚动时间窗口 (tumbling time window)：当时间达到窗口大小时，就会触发窗口的执行。</p>
<ul>
<li><p><code>.window(TumblingProcessingTimeWindows.of(Time.seconds(10)))</code></p>
</li>
<li><p><code>.window(TumblingEventTimeWindows.of(Time.seconds(10)))</code></p>
</li>
<li><p><code>.timeWindow(Time.seconds(15))</code>，Flink 1.12.1 版本已弃用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Windows this &#123;<span class="doctag">@code</span> KeyedStream&#125; into tumbling time windows.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This is a shortcut for either &#123;<span class="doctag">@code</span> .window(TumblingEventTimeWindows.of(size))&#125; or &#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * .window(TumblingProcessingTimeWindows.of(size))&#125; depending on the time characteristic set</span></span><br><span class="line"><span class="comment"> * using &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * org.apache.flink.streaming.api.environment.StreamExecutionEnvironment#setStreamTimeCharacteristic(org.apache.flink.streaming.api.TimeCharacteristic)&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size The size of the window.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span> Please use &#123;<span class="doctag">@link</span> #window(WindowAssigner)&#125; with either &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> *     TumblingEventTimeWindows&#125; or &#123;<span class="doctag">@link</span> TumblingProcessingTimeWindows&#125;. For more information,</span></span><br><span class="line"><span class="comment"> *     see the deprecation notice on &#123;<span class="doctag">@link</span> TimeCharacteristic&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, TimeWindow&gt; <span class="title">timeWindow</span><span class="params">(Time size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">        <span class="keyword">return</span> window(TumblingProcessingTimeWindows.of(size));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> window(TumblingEventTimeWindows.of(size));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>滑动时间窗口 (sliding time window)：两个参数，前者是 window_size，后者是 sliding_size。每隔 sliding_size 计算输出结果一次，每一次计算的 window 范围是 window_size 内的所有元素。</p>
<ul>
<li><p><code>.window(TumblingProcessingTimeWindows.of(Time.seconds(10), Time.seconds(5)))</code></p>
</li>
<li><p><code>.window(TumblingEventTimeWindows.of(Time.seconds(10), Time.seconds(5s)))</code></p>
</li>
<li><p><code>.timeWindow(Time.seconds(15), Time.seconds(5))</code>，Flink 1.12.1 版本已弃用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Windows this &#123;<span class="doctag">@code</span> KeyedStream&#125; into sliding time windows.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This is a shortcut for either &#123;<span class="doctag">@code</span> .window(SlidingEventTimeWindows.of(size, slide))&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> .window(SlidingProcessingTimeWindows.of(size, slide))&#125; depending on the time</span></span><br><span class="line"><span class="comment"> * characteristic set using &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * org.apache.flink.streaming.api.environment.StreamExecutionEnvironment#setStreamTimeCharacteristic(org.apache.flink.streaming.api.TimeCharacteristic)&#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> size The size of the window.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span> Please use &#123;<span class="doctag">@link</span> #window(WindowAssigner)&#125; with either &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> *     SlidingEventTimeWindows&#125; or &#123;<span class="doctag">@link</span> SlidingProcessingTimeWindows&#125;. For more information,</span></span><br><span class="line"><span class="comment"> *     see the deprecation notice on &#123;<span class="doctag">@link</span> TimeCharacteristic&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, TimeWindow&gt; <span class="title">timeWindow</span><span class="params">(Time size, Time slide)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">        <span class="keyword">return</span> window(SlidingProcessingTimeWindows.of(size, slide));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> window(SlidingEventTimeWindows.of(size, slide));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>会话窗口 (session window)</p>
<ul>
<li><code>.window(ProcessingTimeSessionWindows.withGap(Time.minutes(10)))</code></li>
<li><code>.window(EventTimeSessionWindows.withGap(Time.minutes(10)))</code></li>
</ul>
</li>
<li><p>滚动计数窗口 (tumbling count window)：当元素数量达到窗口大小时，就会触发窗口的执行。</p>
<ul>
<li><code>.countWindow(5)</code></li>
</ul>
</li>
<li><p>滑动计数窗口 (sliding count window)：两个参数，前者是 window_size，后者是 sliding_size。每隔 sliding_size 计算输出结果一次，每一次计算的 window 范围是 window_size 内的所有元素。</p>
<ul>
<li><code>.countWindow(10, 2)</code></li>
</ul>
</li>
</ul>
<h4 id="窗口函数-window-function"><a href="#窗口函数-window-function" class="headerlink" title="窗口函数 (window function)"></a>窗口函数 (window function)</h4><ul>
<li><p>window function 定义了要对窗口中收集的数据做的计算操作，主要分为两类。</p>
</li>
<li><p><strong>增量聚合函数 (incremental aggregation functions)</strong></p>
<ul>
<li><p><strong>每条数据到来就进行计算，保持一个简单的状态。</strong>(来一条处理一条，但是不输出，到窗口临界位置才输出)</p>
</li>
<li><p>典型的增量聚合函数有 ReduceFunction，AggregateFunction。</p>
</li>
<li><p>ReduceFunction：</p>
<ul>
<li><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base interface for Reduce functions. Reduce functions combine groups of elements to a single</span></span><br><span class="line"><span class="comment"> * value, by taking always two elements and combining them into one. Reduce functions may be used on</span></span><br><span class="line"><span class="comment"> * entire data sets, or on grouped data sets. In the latter case, each group is reduced</span></span><br><span class="line"><span class="comment"> * individually.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For a reduce functions that work on an entire group at the same time (such as the</span></span><br><span class="line"><span class="comment"> * MapReduce/Hadoop-style reduce), see &#123;<span class="doctag">@link</span> GroupReduceFunction&#125;. In the general case,</span></span><br><span class="line"><span class="comment"> * ReduceFunctions are considered faster, because they allow the system to use more efficient</span></span><br><span class="line"><span class="comment"> * execution strategies.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The basic syntax for using a grouped ReduceFunction is as follows:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * DataSet&lt;X&gt; input = ...;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DataSet&lt;X&gt; result = input.groupBy(&lt;key-definition&gt;).reduce(new MyReduceFunction());</span></span><br><span class="line"><span class="comment"> * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Like all functions, the ReduceFunction needs to be serializable, as defined in &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * java.io.Serializable&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; Type of the elements that this function processes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Public</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReduceFunction</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Function</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The core method of ReduceFunction, combining two values into one value of the same type. The</span></span><br><span class="line"><span class="comment">     * reduce function is consecutively applied to all values of a group until only a single value</span></span><br><span class="line"><span class="comment">     * remains.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value1 The first value to combine.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value2 The second value to combine.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The combined value of both input values.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception This method may throw exceptions. Throwing an exception will cause the</span></span><br><span class="line"><span class="comment">     *     operation to fail and may trigger recovery.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">T <span class="title">reduce</span><span class="params">(T value1, T value2)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/7 12:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest1_TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据，对于开窗，从本地读取数据时，耗时很短，可能窗口的临界点还没到，程序就结束了，也就看不到效果</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.开窗测试，时间窗口，增量聚合函数</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; resultStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">                .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line">                <span class="comment">// 归约</span></span><br><span class="line">                .reduce(<span class="keyword">new</span> ReduceFunction&lt;SensorReading&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> SensorReading <span class="title">reduce</span><span class="params">(SensorReading value1, SensorReading value2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(value1.getId(), value2.getTimestamp(),</span><br><span class="line">                                Math.max(value1.getTemperature(), value2.getTemperature()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/WINDOWS/system32$ nc -tl 7777</span><br><span class="line">sensor_1,1547718212,37.1</span><br><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">3&gt; SensorReading</span>&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718209</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>AggregateFunction：</p>
<ul>
<li><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The &#123;<span class="doctag">@code</span> AggregateFunction&#125; is a flexible aggregation function, characterized by the following</span></span><br><span class="line"><span class="comment"> * features:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;The aggregates may use different types for input values, intermediate aggregates, and</span></span><br><span class="line"><span class="comment"> *       result type, to support a wide range of aggregation types.</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;Support for distributive aggregations: Different intermediate aggregates can be merged</span></span><br><span class="line"><span class="comment"> *       together, to allow for pre-aggregation/final-aggregation optimizations.</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The &#123;<span class="doctag">@code</span> AggregateFunction&#125;&#x27;s intermediate aggregate (in-progress aggregation state) is</span></span><br><span class="line"><span class="comment"> * called the &lt;i&gt;accumulator&lt;/i&gt;. Values are added to the accumulator, and final aggregates are</span></span><br><span class="line"><span class="comment"> * obtained by finalizing the accumulator state. This supports aggregation functions where the</span></span><br><span class="line"><span class="comment"> * intermediate state needs to be different than the aggregated values and the final result type,</span></span><br><span class="line"><span class="comment"> * such as for example &lt;i&gt;average&lt;/i&gt; (which typically keeps a count and sum). Merging intermediate</span></span><br><span class="line"><span class="comment"> * aggregates (partial aggregates) means merging the accumulators.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The AggregationFunction itself is stateless. To allow a single AggregationFunction instance to</span></span><br><span class="line"><span class="comment"> * maintain multiple aggregates (such as one aggregate per key), the AggregationFunction creates a</span></span><br><span class="line"><span class="comment"> * new accumulator whenever a new aggregation is started.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Aggregation functions must be &#123;<span class="doctag">@link</span> Serializable&#125; because they are sent around between</span></span><br><span class="line"><span class="comment"> * distributed processes during distributed execution.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;h1&gt;Example: Average and Weighted Average&lt;/h1&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;&#123;<span class="doctag">@code</span></span></span><br><span class="line"><span class="comment"> * // the accumulator, which holds the state of the in-flight aggregate</span></span><br><span class="line"><span class="comment"> * public class AverageAccumulator &#123;</span></span><br><span class="line"><span class="comment"> *     long count;</span></span><br><span class="line"><span class="comment"> *     long sum;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // implementation of an aggregation function for an &#x27;average&#x27;</span></span><br><span class="line"><span class="comment"> * public class Average implements AggregateFunction&lt;Integer, AverageAccumulator, Double&gt; &#123;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator createAccumulator() &#123;</span></span><br><span class="line"><span class="comment"> *         return new AverageAccumulator();</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator merge(AverageAccumulator a, AverageAccumulator b) &#123;</span></span><br><span class="line"><span class="comment"> *         a.count += b.count;</span></span><br><span class="line"><span class="comment"> *         a.sum += b.sum;</span></span><br><span class="line"><span class="comment"> *         return a;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator add(Integer value, AverageAccumulator acc) &#123;</span></span><br><span class="line"><span class="comment"> *         acc.sum += value;</span></span><br><span class="line"><span class="comment"> *         acc.count++;</span></span><br><span class="line"><span class="comment"> *         return acc;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public Double getResult(AverageAccumulator acc) &#123;</span></span><br><span class="line"><span class="comment"> *         return acc.sum / (double) acc.count;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // implementation of a weighted average</span></span><br><span class="line"><span class="comment"> * // this reuses the same accumulator type as the aggregate function for &#x27;average&#x27;</span></span><br><span class="line"><span class="comment"> * public class WeightedAverage implements AggregateFunction&lt;Datum, AverageAccumulator, Double&gt; &#123;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator createAccumulator() &#123;</span></span><br><span class="line"><span class="comment"> *         return new AverageAccumulator();</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator merge(AverageAccumulator a, AverageAccumulator b) &#123;</span></span><br><span class="line"><span class="comment"> *         a.count += b.count;</span></span><br><span class="line"><span class="comment"> *         a.sum += b.sum;</span></span><br><span class="line"><span class="comment"> *         return a;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public AverageAccumulator add(Datum value, AverageAccumulator acc) &#123;</span></span><br><span class="line"><span class="comment"> *         acc.count += value.getWeight();</span></span><br><span class="line"><span class="comment"> *         acc.sum += value.getValue();</span></span><br><span class="line"><span class="comment"> *         return acc;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     public Double getResult(AverageAccumulator acc) &#123;</span></span><br><span class="line"><span class="comment"> *         return acc.sum / (double) acc.count;</span></span><br><span class="line"><span class="comment"> *     &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * &#125;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;IN&gt; The type of the values that are aggregated (input values) ---&gt; 聚合值的类型(输入值)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;ACC&gt; The type of the accumulator (intermediate aggregate state). ---&gt; 累加器的类型(中间聚合状态)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;OUT&gt; The type of the aggregated result ---&gt; 聚合结果的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AggregateFunction</span>&lt;<span class="title">IN</span>, <span class="title">ACC</span>, <span class="title">OUT</span>&gt; <span class="keyword">extends</span> <span class="title">Function</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new accumulator, starting a new aggregate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The new accumulator is typically meaningless unless a value is added via &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * #add(Object, Object)&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;The accumulator is the state of a running aggregation. When a program has multiple</span></span><br><span class="line"><span class="comment">     * aggregates in progress (such as per key and window), the state (per key and window) is the</span></span><br><span class="line"><span class="comment">     * size of the accumulator.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> A new accumulator, corresponding to an empty aggregate.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ACC <span class="title">createAccumulator</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds the given input value to the given accumulator, returning the new accumulator value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;For efficiency, the input accumulator may be modified and returned.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The value to add</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accumulator The accumulator to add the value to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The accumulator with the updated state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ACC <span class="title">add</span><span class="params">(IN value, ACC accumulator)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the result of the aggregation from the accumulator.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accumulator The accumulator of the aggregation</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The final aggregation result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">OUT <span class="title">getResult</span><span class="params">(ACC accumulator)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merges two accumulators, returning an accumulator with the merged state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;This function may reuse any of the given accumulators as the target for the merge and</span></span><br><span class="line"><span class="comment">     * return that. The assumption is that the given accumulators will not be used any more after</span></span><br><span class="line"><span class="comment">     * having been passed to this function.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a An accumulator to merge</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b Another accumulator to merge</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The accumulator with the merged state</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ACC <span class="title">merge</span><span class="params">(ACC a, ACC b)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/7 12:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest1_TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据，对于开窗，从本地读取数据时，耗时很短，可能窗口的临界点还没到，程序就结束了，也就看不到效果</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.开窗测试，时间窗口，增量聚合函数</span></span><br><span class="line">        DataStream&lt;Integer&gt; resultStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">                .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line">                <span class="comment">// 统计每个分组下数据的个数，中间聚合状态的类型和最终输出的类型是一致的</span></span><br><span class="line">                .aggregate(<span class="keyword">new</span> AggregateFunction&lt;SensorReading, Integer, Integer&gt;() &#123;</span><br><span class="line">                    <span class="comment">// 创建一个累加器</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">createAccumulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 初始值，从0开始</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 来一条数据后，该怎么累加</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(SensorReading value, Integer accumulator)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 累加器基础上+1</span></span><br><span class="line">                        <span class="keyword">return</span> accumulator + <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 返回最终的处理结果</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">getResult</span><span class="params">(Integer accumulator)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 就是返回累加器</span></span><br><span class="line">                        <span class="keyword">return</span> accumulator;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// merge方法一般在session window中使用，可能会存在一些合并的操作</span></span><br><span class="line">                    <span class="comment">// 不存在分区合并，因为当前处理的都是keyBy之后的</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Integer <span class="title">merge</span><span class="params">(Integer a, Integer b)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 为防止意外，将两个状态a和b相加</span></span><br><span class="line">                        <span class="keyword">return</span> a + b;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/WINDOWS/system32$ nc -tl 7777</span><br><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_1,1547718207,36.3</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">3&gt; 2</span></span><br><span class="line"><span class="function">2&gt; 1</span></span><br><span class="line"><span class="function">3&gt; 2</span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>全窗口函数 (full window functions)</strong></p>
<ul>
<li><p><strong>先把窗口所有数据收集起来，等到计算的时候再遍历所有数据。</strong>(来一条存放一条，到窗口临界位置才遍历且计算、输出)</p>
</li>
<li><p>典型的全窗口函数有 ProcessWindowFunction，WindowFunction。</p>
</li>
<li><p>ProcessWindowFunction：</p>
<ul>
<li><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base abstract class for functions that are evaluated over keyed (grouped) windows using a context</span></span><br><span class="line"><span class="comment"> * for retrieving extra information.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;IN&gt; The type of the input value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;OUT&gt; The type of the output value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;KEY&gt; The type of the key.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;W&gt; The type of &#123;<span class="doctag">@code</span> Window&#125; that this window function can be applied on.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>, <span class="title">KEY</span>, <span class="title">W</span> <span class="keyword">extends</span> <span class="title">Window</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractRichFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Evaluates the window and outputs none or several elements.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key The key for which this window is evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context The context in which the window is being evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> elements The elements in the window being evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out A collector for emitting elements.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception The function may throw exceptions to fail the program and trigger recovery.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            KEY key, Context context, Iterable&lt;IN&gt; elements, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deletes any state in the &#123;<span class="doctag">@code</span> Context&#125; when the Window expires (the watermark passes its</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> maxTimestamp&#125; + &#123;<span class="doctag">@code</span> allowedLateness&#125;).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context The context to which the window is being evaluated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception The function may throw exceptions to fail the program and trigger recovery.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">(Context context)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The context holding window metadata. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** Returns the window that is being evaluated. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> W <span class="title">window</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Returns the current processing time. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">currentProcessingTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** Returns the current event-time watermark. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">currentWatermark</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * State accessor for per-key and per-window state.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt;If you use per-window state you have to ensure that you clean it up by</span></span><br><span class="line"><span class="comment">         * implementing &#123;<span class="doctag">@link</span> ProcessWindowFunction#clear(Context)&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title">windowState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** State accessor for per-key global state. */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title">globalState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Emits a record to the side output identified by the &#123;<span class="doctag">@link</span> OutputTag&#125;.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> outputTag the &#123;<span class="doctag">@code</span> OutputTag&#125; that identifies the side output to emit to.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> value The record to emit.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;X&gt; <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">(OutputTag&lt;X&gt; outputTag, X value)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/7 12:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest1_TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据，对于开窗，从本地读取数据时，耗时很短，可能窗口的临界点还没到，程序就结束了，也就看不到效果</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.开窗测试，时间窗口，全窗口函数</span></span><br><span class="line">        DataStream&lt;Tuple3&lt;String, Long, Integer&gt;&gt; resultStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">                .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line">                <span class="comment">// 统计每个分组下数据的个数</span></span><br><span class="line">                .process(<span class="keyword">new</span> ProcessWindowFunction&lt;SensorReading, Tuple3&lt;String, Long, Integer&gt;, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String key, Context context, Iterable&lt;SensorReading&gt; elements,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Collector&lt;Tuple3&lt;String, Long, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// 把elements转换为List，然后其长度就是当前分组下数据的个数</span></span><br><span class="line">                        Integer count = IteratorUtils.toList(elements.iterator()).size();</span><br><span class="line">                        <span class="comment">// 输出一个三元组：key，窗口结束时间，数据个数</span></span><br><span class="line">                        out.collect(<span class="keyword">new</span> Tuple3&lt;&gt;(key, context.window().getEnd(), count));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/WINDOWS/system32$ nc -tl 7777</span><br><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1    ---&gt; 此数据的输入与前面相同的key的时间间隔，超出15s，在下一个窗口处理</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">4&gt; <span class="params">(sensor_7,<span class="number">1620451335000</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">1620451335000</span>,<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">1620451365000</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>WindowFunction：</p>
<ul>
<li><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Base interface for functions that are evaluated over keyed (grouped) windows.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;IN&gt; The type of the input value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;OUT&gt; The type of the output value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;KEY&gt; The type of the key.    ---&gt; 分组的key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;W&gt; The type of &#123;<span class="doctag">@code</span> Window&#125; that this window function can be applied on.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Public</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowFunction</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>, <span class="title">KEY</span>, <span class="title">W</span> <span class="keyword">extends</span> <span class="title">Window</span>&gt; <span class="keyword">extends</span> <span class="title">Function</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Evaluates the window and outputs none or several elements.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key The key for which this window is evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> window The window that is being evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input The elements in the window being evaluated.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out A collector for emitting elements.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception The function may throw exceptions to fail the program and trigger recovery.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(KEY key, W window, Iterable&lt;IN&gt; input, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/7 12:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest1_TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据，对于开窗，从本地读取数据时，耗时很短，可能窗口的临界点还没到，程序就结束了，也就看不到效果</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.开窗测试，时间窗口，全窗口函数</span></span><br><span class="line">        DataStream&lt;Tuple3&lt;String, Long, Integer&gt;&gt; resultStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">                .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line">                <span class="comment">// 统计每个分组下数据的个数</span></span><br><span class="line">                .apply(<span class="keyword">new</span> WindowFunction&lt;SensorReading, Tuple3&lt;String, Long, Integer&gt;, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    input：当前输入的所有的数据</span></span><br><span class="line"><span class="comment">                    out：当前输出的数据</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(String key, TimeWindow window, Iterable&lt;SensorReading&gt; input,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      Collector&lt;Tuple3&lt;String, Long, Integer&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// 把input转换为List，然后其长度就是当前分组下数据的个数</span></span><br><span class="line">                        Integer count = IteratorUtils.toList(input.iterator()).size();</span><br><span class="line">                        <span class="comment">// 输出一个三元组：key，窗口结束时间，数据个数</span></span><br><span class="line">                        out.collect(<span class="keyword">new</span> Tuple3&lt;&gt;(key, window.getEnd(), count));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/WINDOWS/system32$ nc -tl 7777</span><br><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1    ---&gt; 此数据的输入与前面相同的key的时间间隔，超出15s，在下一个窗口处理</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">1620450990000</span>,<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function">4&gt; <span class="params">(sensor_7,<span class="number">1620450990000</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">1620451095000</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>前面的例子是以时间窗口写的，下面以计数窗口为例。</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/5/8 13:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest2_CountWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据，对于开窗，从本地读取数据时，耗时很短，可能窗口的临界点还没到，程序就结束了，也就看不到效果</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.开窗测试，技术窗口，增量聚合函数</span></span><br><span class="line">        DataStream&lt;Double&gt; resultStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">                <span class="comment">// 4个数开一个窗口，隔两个数滑动一次</span></span><br><span class="line">                .countWindow(<span class="number">4</span>, <span class="number">2</span>)</span><br><span class="line">                <span class="comment">// 计算窗口内数据温度的平均值</span></span><br><span class="line">                .aggregate(<span class="keyword">new</span> MyAvgTemp());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAvgTemp</span> <span class="keyword">implements</span> <span class="title">AggregateFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Tuple2</span>&lt;<span class="title">Double</span>, <span class="title">Integer</span>&gt;, <span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;Double, Integer&gt; <span class="title">createAccumulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="number">0.0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;Double, Integer&gt; <span class="title">add</span><span class="params">(SensorReading value, Tuple2&lt;Double, Integer&gt; accumulator)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 每来一条数据，把温度值加到二元组的第一个元素上，二元组第二个元素自增1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(accumulator.f0 + value.getTemperature(), accumulator.f1 + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Double <span class="title">getResult</span><span class="params">(Tuple2&lt;Double, Integer&gt; accumulator)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 返回所有数据温度的平均值</span></span><br><span class="line">            <span class="keyword">return</span> accumulator.f0 / accumulator.f1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;Double, Integer&gt; <span class="title">merge</span><span class="params">(Tuple2&lt;Double, Integer&gt; a, Tuple2&lt;Double, Integer&gt; b)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(a.f0 + b.f0, a.f1 + b.f1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP-OM8IACS:/mnt/c/WINDOWS/system32$ nc -tl 7777</span><br><span class="line">sensor_1,1547718199,1</span><br><span class="line">sensor_1,1547718199,2</span><br><span class="line">sensor_1,1547718199,3</span><br><span class="line">sensor_1,1547718199,4</span><br><span class="line">sensor_1,1547718199,5</span><br><span class="line">sensor_1,1547718199,6</span><br><span class="line">sensor_1,1547718199,7</span><br><span class="line">sensor_1,1547718199,8</span><br><span class="line">sensor_1,1547718199,9</span><br><span class="line">sensor_1,1547718199,10</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">3&gt; 1.5   ---&gt; <span class="params">(<span class="number">1</span>+<span class="number">2</span>)</span>/2</span></span><br><span class="line"><span class="function">3&gt; 2.5   ---&gt; <span class="params">(<span class="number">1</span>+<span class="number">2</span>+<span class="number">3</span>+<span class="number">4</span>)</span>/4</span></span><br><span class="line"><span class="function">3&gt; 4.5   ---&gt; <span class="params">(<span class="number">3</span>+<span class="number">4</span>+<span class="number">5</span>+<span class="number">6</span>)</span>/4</span></span><br><span class="line"><span class="function">3&gt; 6.5   ---&gt; <span class="params">(<span class="number">5</span>+<span class="number">6</span>+<span class="number">7</span>+<span class="number">8</span>)</span>/4</span></span><br><span class="line"><span class="function">3&gt; 8.5   ---&gt; <span class="params">(<span class="number">7</span>+<span class="number">8</span>+<span class="number">9</span>+<span class="number">10</span>)</span>/4</span></span><br><span class="line"><span class="function">...</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>滑动的距离是 2，因此前两个数计算一次平均值</strong>，后两个数来时，与前面两个数组成一个完整窗口 4 个数，计算一次平均值，后面都是 4 个数计算一次平均值。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="其他可选-API"><a href="#其他可选-API" class="headerlink" title="其他可选 API"></a>其他可选 API</h3><ul>
<li><p><code>.trigger()</code>：触发器，定义 window 什么时候关闭，触发计算并输出结果。一般不使用。</p>
</li>
<li><p><code>.evictor()</code>：移除器，定义移除某些数据的逻辑。一般不使用。</p>
</li>
<li><p><code>.allowedLateness()</code>：允许处理迟到的数据。</p>
</li>
<li><p><code>.sideOutputLateData()</code>：将迟到的数据放入侧输出流。</p>
</li>
<li><p><code>.getSideOutput()</code>：获取侧输出流。</p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;&#125;;</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;SensorReading&gt; sumStream = dataStream.keyBy(SensorReading::getId)</span><br><span class="line">    			  .window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">15</span>)))</span><br><span class="line"><span class="comment">//                .trigger()</span></span><br><span class="line"><span class="comment">//                .evictor()</span></span><br><span class="line">    			  <span class="comment">// 允许1分钟内的迟到数据&lt;=比如数据产生时间在窗口范围内，但是要处理的时候已经超过窗口时间了</span></span><br><span class="line">    			  .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">    			  <span class="comment">// 侧输出流，迟到超过1分钟的数据，收集于此</span></span><br><span class="line">                  .sideOutputLateData(outputTag)</span><br><span class="line">                  .sum(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">sumStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Window-API-总览"><a href="#Window-API-总览" class="headerlink" title="Window API 总览"></a>Window API 总览</h3><p><img src="/2021/04/25/flink/image-20210508161548431.png" alt="image-20210508161548431"></p>
<h2 id="Flink-的时间语义和-Wartermark"><a href="#Flink-的时间语义和-Wartermark" class="headerlink" title="Flink 的时间语义和 Wartermark"></a>Flink 的时间语义和 Wartermark</h2><h3 id="Flink-中的时间语义"><a href="#Flink-中的时间语义" class="headerlink" title="Flink 中的时间语义"></a>Flink 中的时间语义</h3><img src="/2021/04/25/flink/image-20210508172915347.png" alt="image-20210508172915347" style="zoom:80%;">

<ul>
<li><strong>Event Time：事件创建的时间。</strong><ul>
<li>Event Time 是事件创建的时间。它通常由事件中的时间戳描述，例如采集的日志数据中，每一条日志都会记录自己的生成时间，Flink 通过时间戳分配器访问事件时间戳。</li>
</ul>
</li>
<li>Ingestion Time：数据进入Flink 的时间。</li>
<li>Processing Time：执行操作算子的本地系统时间，与机器相关。</li>
</ul>
<h3 id="哪种时间语义更重要"><a href="#哪种时间语义更重要" class="headerlink" title="哪种时间语义更重要"></a>哪种时间语义更重要</h3><img src="/2021/04/25/flink/image-20210508173159146.png" alt="image-20210508173159146" style="zoom:80%;">

<ul>
<li>不同的时间语义有不同的应用场合。</li>
<li>我们<strong>往往更关心事件时间 (Event Time)。</strong></li>
</ul>
<img src="/2021/04/25/flink/image-20210508173336325.png" alt="image-20210508173336325" style="zoom:80%;">

<ul>
<li>这里假设玩游戏，两分钟内如果过 5 关就有奖励。用户坐地铁玩游戏，进入隧道前已经过 3 关，在隧道中又过了 5 关。但是信号不好，后 5 关通关的信息，等到出隧道的时候 (8:23:20) 才正式到达服务器。</li>
<li>在这个应用场合下，如果为了用户体验，则不应该使用 Processing Time，而是应该按照 Event Time 处理信息，保证用户获得游戏奖励。</li>
<li>Event Time 可以从日志数据的时间戳 (timestamp) 中提取：<ul>
<li><code>2017-11-02 18:37:15.624 INFO Fail over to rm</code></li>
</ul>
</li>
</ul>
<h3 id="在代码中设置-Event-Time"><a href="#在代码中设置-Event-Time" class="headerlink" title="在代码中设置 Event Time"></a>在代码中设置 Event Time</h3><ul>
<li><p>在 Flink 的流式处理中，绝大部分的业务都会使用 Event Time，一般只在 Event Time 无法使用时，才会被迫使用 Processing Time 或者 Ingestion Time。</p>
</li>
<li><p>如果要使用 Event Time，那么需要引入 Event Time 的时间属性，引入方式如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"><span class="comment">// 从调用时刻开始给env创建的每一个stream追加时间特征</span></span><br><span class="line">env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Watermark"><a href="#Watermark" class="headerlink" title="Watermark"></a>Watermark</h3><h4 id="Watermark-的基本概念"><a href="#Watermark-的基本概念" class="headerlink" title="Watermark 的基本概念"></a>Watermark 的基本概念</h4><ul>
<li><p>我们知道，流处理从事件产生，到流经 Source，再到 Operator，中间是有一个过程和时间的，虽然大部分情况下，流到 Operator 的数据都是按照事件产生的时间顺序来的，但是也不排除由于网络、分布式等原因，导致乱序的产生，所谓乱序，就是指 Flink 接收到的事件的先后顺序不是严格按照事件的 Event Time 顺序排列的。那么此时出现一个问题，一旦出现乱序，如果只根据 Event Time 决定 Window 的运行，我们不能明确数据是否全部到位，但又不能无限期的等下去，此时必须要有个机制来保证一个特定的时间后，必须触发 Window 去进行计算了，这个特别的机制，就是 Watermark。</p>
<p><img src="/2021/04/25/flink/image-20210802131640148.png" alt="image-20210802131640148"></p>
<p><img src="/2021/04/25/flink/image-20210804102019506.png" alt="image-20210804102019506"></p>
<ul>
<li>当 Flink 以 Event Time 模式处理数据流时，它会根据数据里的时间戳来处理基于时间的算子。</li>
<li>由于网络、分布式等原因，会导致乱序数据的产生。</li>
<li>乱序数据会让窗口计算不准确。</li>
<li>遇到一个时间戳达到了窗口关闭时间，不应该立刻触发窗口计算，而是等待一段时间，等迟到的数据来了再关闭窗口。</li>
</ul>
</li>
<li><p>Watermark 是一种衡量 Event Time 进展的机制。</p>
</li>
<li><p><strong>Watermark 是用于处理乱序事件的，而正确的处理乱序事件，通常用 Watermark 机制结合 Window 来实现。</strong></p>
</li>
<li><p>数据流中的 Watermark 用于表示 timestamp 小于 Watermark 的数据，都已经到达了，因此，Window 的执行也是由 Watermark 触发的。</p>
</li>
<li><p>Watermark 可以理解成一个延迟触发机制，我们可以设置 Watermark 的延时时长 t，每次系统会校验已经到达的数据中最大的 maxEventTime，然后认定 Event Time 小于 maxEventTime - t 的所有数据都已经到达，如果有窗口的停止时间等于 maxEventTime – t (说明这个窗口的所有数据都已到达)，那么这个窗口被触发执行。</p>
</li>
<li><p>Watermark 用来让程序自己平衡延迟和结果正确性。</p>
</li>
<li><p>有序流的 Watermarker 如下图所示：(Watermark 的延时时长设置为 0s)</p>
<p><img src="/2021/04/25/flink/image-20210803225357577.png" alt="image-20210803225357577"></p>
</li>
<li><p>乱序流的 Watermarker 如下图所示：(Watermark 的延时时长设置为 2s)</p>
<p><img src="/2021/04/25/flink/image-20210803225534170.png" alt="image-20210803225534170"></p>
<ul>
<li>当 Flink 接收到数据时，会按照一定的规则去生成 Watermark，这条 Watermark 就等于当前所有到达数据中的 maxEventTime - 延时时长 t，也就是说，Watermark 是基于数据携带的时间戳生成的，一旦 Watermark 比当前未触发的窗口的停止时间要晚，那么就会触发相应窗口的执行。由于 Event Time 是由数据携带的，因此，如果运行过程中无法获取新的数据，那么没有被触发的窗口将永远都不被触发。上图中，我们设置的允许最大延时时长为 2s，所以时间戳为 7s 的事件对应的 Watermark 是 5s，时间戳为 12s 的事件的 Watermark 是 10s，如果我们的 Window 1 是 1s ~ 5s，Window 2 是 6s ~ 10s，那么时间戳为 7s 的事件到达时的 Watermarker 恰好触发 Window 1，时间戳为 12s 的事件到达时的 Watermark 恰好触发 Window 2。</li>
<li>Watermark 就是触发前一窗口的 “关窗时间”，一旦触发关门那么以当前时刻为准在窗口范围内的所有所有数据都会收入窗中。</li>
<li>只要新来的数据没有达到 Watermark，那么不管现实中的时间推进了多久，都不会触发关窗。</li>
</ul>
</li>
<li><p>Watermark 的延时时长，应结合实际数据到达的迟到程度来设置。比如下图所示，当前到达数据的最大时间戳为 5s，其后续迟到数据有 2s 和 3s，那 Watermark 延时时长 t 应设置为 3s。</p>
<p><img src="/2021/04/25/flink/image-20210804104402570.png" alt="image-20210804104402570"></p>
<ul>
<li><p>上图中，Watermark 的变化规律：1s 数据为 -2，4s 数据为 1，5s 数据为 2，2s 数据为 2，3s 数据为 2，6s 数据为 3。</p>
<ul>
<li>Watermark 只单调递增，所以 2s 和 3s 的数据，都为 2。</li>
</ul>
</li>
<li><p>如果有设置为 2s 的 Window，其会在 5s 数据到达时，触发执行。如果有设置为 5s 的 Window，则会在 8s 数据到达时，才会触发执行。</p>
</li>
<li><p>具体的数据流向，可参考下图：</p>
<p><img src="/2021/04/25/flink/image-20210804112151265.png" alt="image-20210804112151265"></p>
<ul>
<li>从图中可以看出，当 8s 数据到达时，Watermark 为 5，此时，触发 0 ~ 5s 的 Window 数据桶关闭，并输出一次结果，如果 8s 数据不到达，0 ~ 5s 的数据桶，会一直开启。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Watermark-的特点"><a href="#Watermark-的特点" class="headerlink" title="Watermark 的特点"></a>Watermark 的特点</h4><p><img src="/2021/04/25/flink/image-20210804095939601.png" alt="image-20210804095939601"></p>
<ul>
<li><p>上图中，三角形表示数据自带的时间戳。</p>
</li>
<li><p>Watermark 是一条特殊的数据记录，其本质上就是一个带时间戳的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.flink.api.common.eventtime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Watermark</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Thread local formatter for stringifying the timestamps. */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt; TS_FORMATTER = ThreadLocal.withInitial(</span><br><span class="line">      () -&gt; <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/** The watermark that signifies end-of-event-time. */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Watermark MAX_WATERMARK = <span class="keyword">new</span> Watermark(Long.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/** The timestamp of the watermark in milliseconds. */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timestamp;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new watermark with the given timestamp in milliseconds.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Watermark</span><span class="params">(<span class="keyword">long</span> timestamp)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the timestamp associated with this Watermark.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> timestamp;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Formats the timestamp of this watermark, assuming it is a millisecond timestamp.</span></span><br><span class="line"><span class="comment">    * The returned format is &quot;yyyy-MM-dd HH:mm:ss.SSS&quot;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getFormattedTimestamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> TS_FORMATTER.get().format(<span class="keyword">new</span> Date(timestamp));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span> == o ||</span><br><span class="line">            o != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            o.getClass() == Watermark.class &amp;&amp;</span><br><span class="line">            ((Watermark) o).timestamp == <span class="keyword">this</span>.timestamp;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Long.hashCode(timestamp);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Watermark @ &quot;</span> + timestamp + <span class="string">&quot; (&quot;</span> + getFormattedTimestamp() + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Watermark 必须单调递增，以确保任务的事件时间时钟在向前推进，而不是在后退。</p>
</li>
<li><p>Watermark 与数据的时间戳相关。</p>
</li>
<li><p>Watermark 可以为负值，表示事件还未发生。</p>
</li>
</ul>
<h4 id="Watermark-的传递"><a href="#Watermark-的传递" class="headerlink" title="Watermark 的传递"></a>Watermark 的传递</h4><p><img src="/2021/04/25/flink/image-20210804113522284.png" alt="image-20210804113522284"></p>
<ul>
<li>Watermark 向下游传递：上游接收到 Watermark 后，会广播到下游的所有任务。</li>
<li>当上游存在多个并行任务时，下游子任务可能会接收到上游广播的多个 Watermark，此时，当前子任务会取时间戳最小的那个 Watermark，因为这样才能保证上游并行任务的每一个，Watermark 之前的数据都到了。</li>
<li>上图 1 中，上游四条并行的数据流，从上到下，当前广播即将到达的 Watermark 分别为 4s，7s 和 6s，而 Task 在之前已经到达并保存的 Watermark 分别为 2s，4s，3s 和 6s，Task 的 Watermark 为 2s。</li>
<li>上图 2 中，Task 接收到第一个分区新的 Watermark 4s，第一个分区的 Watermark 由 2s 更新为 4s，整个 Task 的 Watermark 对比更新为 3s，并广播到下游所有任务。</li>
<li>上图 3 中，Task 接收到第二个分区新的 Watermark 7s，第二个分区的 Watermark 由 4s 更新为 7s，整个 Task 的 Watermark 对比仍为 3s，此时，Watermark 未更新，不广播到下游。</li>
<li>上图 4 中，Task 接收到第三个分区新的 Watermark 6s，第三个分区的 Watermark 由 3s 更新为 6s，整个 Task 的 Watermark 对比更新为 4s，并广播到下游所有任务。</li>
</ul>
<h4 id="Watermark-的引入"><a href="#Watermark-的引入" class="headerlink" title="Watermark 的引入"></a>Watermark 的引入</h4><ul>
<li><p>引入 Watermark，需要设置时间语义。</p>
<ul>
<li>Event Time 的使用一定要指定数据源中的时间戳，否则程序无法知道事件的事件时间是什么 (数据源里的数据没有时间戳的话，就只能使用 Processing Time 了)。</li>
</ul>
</li>
<li><p>升序数据 (数据流的时间戳是单调递增的，也就是说没有乱序，即理想数据)，不需要延迟触发，可以只指定时间戳，使用 AscendingTimestampExtractor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.方式一：理想数据，使用AscendingTimestampExtractor</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> AscendingTimestampExtractor&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractAscendingTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 因为sensorReading的时间戳是秒，要转换为毫秒</span></span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>乱序数据，需要设置延迟触发，使用 BoundedOutOfOrdernessTimestampExtractor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.方式二：乱序数据，使用BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line">        <span class="comment">// 需要指定延时时长，此处设置为Time.seconds(2)，即2s，实际上生产时，按实际情况设置，可能更多是毫秒级别</span></span><br><span class="line">        <span class="comment">// import org.apache.flink.streaming.api.windowing.time.Time;</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 因为sensorReading的时间戳是秒，要转换为毫秒</span></span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Flink 最新版本中，上面两种方式已经被弃用，建议使用 <code>.assignTimestampsAndWatermarks(WatermarkStrategy)</code> 替代。</p>
</li>
<li><p>AscendingTimestampExtractor 和 BoundedOutOfOrdernessTimestampExtractor，本质上都是 TimestampAssigner 接口的实现类。</p>
</li>
<li><p>Flink 暴露了 TimestampAssigner 接口供我们实现，我们可以自定义如何从事件数据中抽取时间戳以及生成 Watermark。</p>
</li>
<li><p>TimestampAssigner 接口定义了抽取时间戳，以及生成 Watermark 的方法，有两种类型：AssignerWithPeriodicWatermarks 和 AssignerWithPunctuatedWatermarks。</p>
</li>
</ul>
<h5 id="AssignerWithPeriodicWatermarks"><a href="#AssignerWithPeriodicWatermarks" class="headerlink" title="AssignerWithPeriodicWatermarks"></a>AssignerWithPeriodicWatermarks</h5><ul>
<li><p>周期性的生成 Watermark，系统会周期性的将 Watermark 插入到流中 (Watermark 实际上也是一种特殊的事件)。</p>
</li>
<li><p>在设置时间语义时，Processing Time 语义下默认周期是 0 毫秒，Event Time 和 Ingestion Time 语义下默认周期是 200 毫秒，可以使用 <code>ExecutionConfig.setAutoWatermarkInterval()</code> 进行设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStreamTimeCharacteristic</span><span class="params">(TimeCharacteristic characteristic)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.timeCharacteristic = Preconditions.checkNotNull(characteristic);</span><br><span class="line">   <span class="keyword">if</span> (characteristic == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">      getConfig().setAutoWatermarkInterval(<span class="number">0</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      getConfig().setAutoWatermarkInterval(<span class="number">200</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每隔5秒生成一个Watermark</span></span><br><span class="line">env.getConfig().setAutoWatermarkInterval(<span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>产生 Watermark 的逻辑：每隔周期时间，Flink 会调用一次 AssignerWithPeriodicWatermarks 的 <code>getCurrentWatermark()</code>。如果方法返回一个时间戳大于之前 Watermark 的时间戳，新的 Watermark 会被插入到流中。如果方法返回的时间戳小于等于之前 Watermark 的时间戳，则不会产生新的 Watermark。这种检查模式，保证了 Watermark 是单调递增的。</p>
</li>
<li><p>前面升序和乱序使用的 AscendingTimestampExtractor 和 BoundedOutOfOrdernessTimestampExtractor，都是基于周期性 Watermark 的。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.周期性的生成Watermark</span></span><br><span class="line">        env.getConfig().setAutoWatermarkInterval(<span class="number">5000</span>);<span class="comment">// 每隔5秒生成一个Watermark</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> AssignerWithPeriodicWatermarks&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> Long bound = <span class="number">60</span> * <span class="number">1000L</span>;<span class="comment">// 延迟一分钟</span></span><br><span class="line">            <span class="keyword">private</span> Long maxTs = Long.MIN_VALUE;<span class="comment">// 当前最大时间戳</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回Watermark</span></span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Watermark <span class="title">getCurrentWatermark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Watermark(maxTs - bound);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当前到达数据的时间戳，与之前保存的最大时间戳对比，拿到当前数据到达后，最大的时间戳</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading, <span class="keyword">long</span> recordTimestamp)</span> </span>&#123;</span><br><span class="line">                maxTs = Math.max(maxTs, sensorReading.getTimestamp() * <span class="number">1000L</span>);</span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="AssignerWithPunctuatedWatermarks"><a href="#AssignerWithPunctuatedWatermarks" class="headerlink" title="AssignerWithPunctuatedWatermarks"></a>AssignerWithPunctuatedWatermarks</h5><ul>
<li><p>没有时间周期规律，间断式地生成 Watermark。</p>
</li>
<li><p>和周期性生成的方式不同，这种方式不是固定时间的，而是可以根据需要对每条数据进行筛选和处理。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.间断性的生成Watermark，只给sensor_1的传感器的数据流插入Watermark</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> AssignerWithPunctuatedWatermarks&lt;SensorReading&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> Long bound = <span class="number">60</span> * <span class="number">1000L</span>;<span class="comment">// 延迟一分钟</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading, <span class="keyword">long</span> recordTimestamp)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Nullable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Watermark <span class="title">checkAndGetNextWatermark</span><span class="params">(SensorReading sensorReading, <span class="keyword">long</span> extractedTimestamp)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;sensor_1&quot;</span>.equals(sensorReading.getId())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Watermark(extractedTimestamp - bound);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Watermark-的设定"><a href="#Watermark-的设定" class="headerlink" title="Watermark 的设定"></a>Watermark 的设定</h4><ul>
<li>在 Flink 中，Watermark 由应用程序开发人员生成，这通常需要对相应的领域有一定的了解。</li>
<li>如果 Watermark 设置的延迟太长，收到结果的速度可能就会很慢，解决办法是在 Watermark 到达之前输出一个近似结果。</li>
<li>如果 Watermark 设置的延迟太短，则可能收到错误结果，不过 Flink 处理迟到数据的机制 (侧输出流等) 可以解决这个问题。</li>
<li>Watermark 设置的位置离 Source 越近越好。</li>
</ul>
<h3 id="Evnet-Time-在-Window-中的测试说明"><a href="#Evnet-Time-在-Window-中的测试说明" class="headerlink" title="Evnet Time 在 Window 中的测试说明"></a>Evnet Time 在 Window 中的测试说明</h3><h4 id="流的并行度为-1"><a href="#流的并行度为-1" class="headerlink" title="流的并行度为 1"></a>流的并行度为 1</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.乱序数据设置Watermark</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 因为sensorReading的时间戳是秒，要转换为毫秒</span></span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值，并设置窗口延迟1分钟关闭，同时，窗口关闭后的迟到数据都输出到侧输出流</span></span><br><span class="line">        <span class="comment">// 这个延迟1分钟，是基于Event Time的，不是现实中的1分钟</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP<span class="literal">-OM8IACS</span>:/mnt/c/Users/XiSun<span class="variable">$</span> nc <span class="literal">-lk</span> <span class="number">7777</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">sensor_1,<span class="number">1547718206</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718210</span>,<span class="number">34.7</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">37.1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">SensorReading</span>&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718206</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718210</span>, temperature=<span class="number">34.7</span>&#125;</span><br><span class="line">SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">37.1</span>&#125;</span><br><span class="line">minTemp&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">minTemp&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">minTemp&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">minTemp&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>源码分析：窗口起始点的确定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, TimeWindow&gt; <span class="title">timeWindow</span><span class="params">(Time size)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (environment.getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">      <span class="keyword">return</span> window(TumblingProcessingTimeWindows.of(size));</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Event Time语义</span></span><br><span class="line">      <span class="keyword">return</span> window(TumblingEventTimeWindows.of(size));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TumblingEventTimeWindows</span> <span class="keyword">extends</span> <span class="title">WindowAssigner</span>&lt;<span class="title">Object</span>, <span class="title">TimeWindow</span>&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> size;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> offset;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">TumblingEventTimeWindows</span><span class="params">(<span class="keyword">long</span> size, <span class="keyword">long</span> offset)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (Math.abs(offset) &gt;= size) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;TumblingEventTimeWindows parameters must satisfy abs(offset) &lt; size&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.size = size;</span><br><span class="line">      <span class="keyword">this</span>.offset = offset;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 此方法确定当前数据数据哪个窗口，即如何开窗</span></span><br><span class="line">   <span class="comment">// element：当前数据；timestamp：当前数据的时间戳</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Collection&lt;TimeWindow&gt; <span class="title">assignWindows</span><span class="params">(Object element, <span class="keyword">long</span> timestamp, WindowAssignerContext context)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (timestamp &gt; Long.MIN_VALUE) &#123;</span><br><span class="line">         <span class="comment">// Long.MIN_VALUE is currently assigned when no timestamp is present</span></span><br><span class="line">         <span class="comment">// 确定起始点</span></span><br><span class="line">         <span class="keyword">long</span> start = TimeWindow.getWindowStartWithOffset(timestamp, offset, size);</span><br><span class="line">         <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> TimeWindow(start, start + size));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Record has Long.MIN_VALUE timestamp (= no timestamp marker). &quot;</span> +</span><br><span class="line">               <span class="string">&quot;Is the time characteristic set to &#x27;ProcessingTime&#x27;, or did you forget to call &quot;</span> +</span><br><span class="line">               <span class="string">&quot;&#x27;DataStream.assignTimestampsAndWatermarks(...)&#x27;?&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Method to get the window start for a timestamp.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timestamp epoch millisecond to get the window start.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> offset The offset which window start would be shifted by.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> windowSize The size of the generated windows.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> window start</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// timestamp：当前数据的时间戳；offset：偏移量，未设置时默认为0；windowSize：开窗大小</span></span><br><span class="line">   <span class="comment">// offset一般用于处理不同时区的偏移时间。标准时间是按伦敦所在时区，如果在北京时间东八区，获取的时间戳比标准时间早8个小时，</span></span><br><span class="line">   <span class="comment">// 如果想统计每天0点到0点的窗口，应该设置偏移量offset为-8h</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getWindowStartWithOffset</span><span class="params">(<span class="keyword">long</span> timestamp, <span class="keyword">long</span> offset, <span class="keyword">long</span> windowSize：开窗大小)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// offset为0，此式化简为timestamp减去timestamp对windowSize取余，结果是windowSize的整数倍</span></span><br><span class="line">      <span class="keyword">return</span> timestamp - (timestamp - offset + windowSize) % windowSize;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>由以上分析，第一个数据时间戳为 1547718199，开窗尺寸为 15s，则窗口起始点为：<code>1547718199 - 1547718199 % 15 = 1547718195</code>。而窗口尺寸为 15s，则后续窗口为：[195, 210)，[210, 225)，[225, 240)，以此类推。后续到达的每个数据，也会进入对应的数据桶中。</p>
<p><img src="/2021/04/25/flink/image-20210806151223965.png" alt="image-20210806151223965"></p>
</li>
<li><p>从图中可以看出，因为 Watermark 延时时长设置为 2s，所以当 <code>sensor_1,1547718212,37.1</code> 数据到达时，会触发 [195, 210) 窗口关闭 (因为设置了窗口延迟 1 分钟关闭，212 数据到达时，会触发窗口返回一个结果，之后 1 分钟之内，来一个新数据会返回一个结果，直到 272 数据到达时，窗口关闭，关闭之后的迟到数据，都会输出到侧输出流)，这也是第一个被触发关闭的窗口。然后根据 id 分组，输出四个结果。其中，sensor_1 对应的最小温度值为 <code>sensor_1,1547718199,35.8</code>。</p>
</li>
</ul>
</li>
</ul>
<h4 id="流的并行度不为-1"><a href="#流的并行度不为-1" class="headerlink" title="流的并行度不为 1"></a>流的并行度不为 1</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowTest3_Watermark2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置Event Time时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.乱序数据设置Watermark</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; watermarkStream = dataStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 因为sensorReading的时间戳是秒，要转换为毫秒</span></span><br><span class="line">                <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 侧输出流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;late&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.基于事件时间的开窗聚合，统计15秒内温度的最小值，并设置窗口延迟1分钟关闭，同时，窗口关闭后的迟到数据都输出到侧输出流</span></span><br><span class="line">        <span class="comment">// 这个延迟1分钟，是基于Event Time的，不是现实中的1分钟</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; minTempStream = watermarkStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .timeWindow(Time.seconds(<span class="number">15</span>))</span><br><span class="line">                .allowedLateness(Time.minutes(<span class="number">1</span>))</span><br><span class="line">                .sideOutputLateData(outputTag)</span><br><span class="line">                .minBy(<span class="string">&quot;temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印最小值</span></span><br><span class="line">        minTempStream.print(<span class="string">&quot;minTemp&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印迟到数据</span></span><br><span class="line">        minTempStream.getSideOutput(outputTag).print(<span class="string">&quot;late&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP<span class="literal">-OM8IACS</span>:/mnt/c/Users/Ziyoo<span class="variable">$</span> nc <span class="literal">-lk</span> <span class="number">7777</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">sensor_1,<span class="number">1547718206</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718210</span>,<span class="number">34.7</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">33.1</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">31.9</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">30.8</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">36.7</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">2&gt; SensorReading</span>&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718206</span>, temperature=<span class="number">36.3</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718210</span>, temperature=<span class="number">34.7</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">33.1</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">31.9</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">30.8</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">36.7</span>&#125;</span><br><span class="line">minTemp:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_7&#x27;</span>, timestamp=<span class="number">1547718202</span>, temperature=<span class="number">6.7</span>&#125;</span><br><span class="line">minTemp:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718205</span>, temperature=<span class="number">38.1</span>&#125;</span><br><span class="line">minTemp:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718201</span>, temperature=<span class="number">15.4</span>&#125;</span><br><span class="line">minTemp:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时，第一条数据是 199，如前面分析，开窗仍为 [195, 210)，[210, 225)，[225, 240)，依次类推。Scoket 文本流的并行度为 1，map 算子的并行度为 4。因此，每条数据会轮询的方式进入 map 算子。数据桶的分布情况如下：</p>
<p><img src="/2021/04/25/flink/image-20210809131823596.png" alt="image-20210809131823596"></p>
</li>
<li><p>由 Watermark 的传递可知，对于四个分区，只有每个分区的 Watermark 都更新为 210s 时，才会触发 [195, 210) 窗口的关闭，也就是最有一条数据 <code>sensor_1,1547718212,36.7</code> 到达时，触发输出计算结果。其中，sensor_1 对应的最小温度值为 <code>sensor_1,1547718199,35.8</code>。</p>
<ul>
<li><p>第一条数据 <code>sensor_1,1547718199,35.8</code> 到达时，第一个分区的 Watermark 是 197s，其他三个分区的 Watermark 是初始值，是一个很大的负值。此时，下游任务的 Watermark 取四个分区的最小值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.currentMaxTimestamp = Long.MIN_VALUE + <span class="keyword">this</span>.maxOutOfOrderness;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>如果继续输入数据，可得相应结果。从结果中可以看出，数据通过轮询方式进入四个并行的分区中，当四个分区的 Watermark 都更新为 225s 和 240s 时，才会触发 [210, 225) 和 [225, 240) 窗口输出结果。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sensor_10,<span class="number">1547718227</span>,<span class="number">3.1</span></span><br><span class="line">sensor_10,<span class="number">1547718227</span>,<span class="number">3.2</span></span><br><span class="line">sensor_10,<span class="number">1547718227</span>,<span class="number">3.3</span></span><br><span class="line">sensor_10,<span class="number">1547718227</span>,<span class="number">3.4</span></span><br><span class="line">sensor_10,<span class="number">1547718242</span>,<span class="number">4.1</span></span><br><span class="line">sensor_10,<span class="number">1547718242</span>,<span class="number">4.2</span></span><br><span class="line">sensor_10,<span class="number">1547718242</span>,<span class="number">4.3</span></span><br><span class="line">sensor_10,<span class="number">1547718242</span>,<span class="number">4.4</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718227</span>, temperature=<span class="number">3.1</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718227</span>, temperature=<span class="number">3.2</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718227</span>, temperature=<span class="number">3.3</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718227</span>, temperature=<span class="number">3.4</span>&#125;</span><br><span class="line">minTemp:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718212</span>, temperature=<span class="number">30.8</span>&#125;</span><br><span class="line"><span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718242</span>, temperature=<span class="number">4.1</span>&#125;</span><br><span class="line"><span class="number">1</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718242</span>, temperature=<span class="number">4.2</span>&#125;</span><br><span class="line"><span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718242</span>, temperature=<span class="number">4.3</span>&#125;</span><br><span class="line"><span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718242</span>, temperature=<span class="number">4.4</span>&#125;</span><br><span class="line">minTemp:<span class="number">2</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718227</span>, temperature=<span class="number">3.1</span>&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Flink-的状态管理"><a href="#Flink-的状态管理" class="headerlink" title="Flink 的状态管理"></a>Flink 的状态管理</h2><ul>
<li><p>流式计算分为无状态和有状态两种情况。无状态的计算观察每个独立事件，并根据最后一个事件输出结果。例如，流处理应用程序从传感器接收温度读数，并在温度超过 90 度时发出警告。有状态的计算则会基于多个事件输出结果。以下是一些例子：</p>
<ul>
<li>所有类型的窗口。例如，计算过去一小时的平均温度，就是有状态的计算。</li>
<li>所有用于复杂事件处理的状态机。例如，若在一分钟内收到两个相差 20 度以上的温度读数，则发出警告，这是有状态的计算。</li>
<li>流与流之间的所有关联操作，以及流与静态表或动态表之间的关联操作，都是有状态的计算。</li>
</ul>
</li>
<li><p>下图展示了无状态流处理和有状态流处理的主要区别。无状态流处理分别接收每条数据记录 (图中的黑条)，然后根据最新输入的数据生成输出数据 (白条)。有状态流处理会维护状态 (根据每条输入记录进行更新)，并基于最新输入的记录和当前的状态值生成输出记录 (灰条)。</p>
<p><img src="/2021/04/25/flink/image-20210809231831959.png" alt="image-20210809231831959"></p>
<ul>
<li>上图中输入数据由黑条表示。无状态流处理每次只转换一条输入记录，并且仅根据最新的输入记录输出结果 (白条)。有状态流处理维护所有已处理记录的状态值，并根据每条新输入的记录更新状态，因此输出记录 (灰条) 反映的是综合考虑多个事件之后的结果。</li>
</ul>
</li>
<li><p>尽管无状态的计算很重要，但是流处理对有状态的计算更感兴趣。事实上，正确地实现有状态的计算比实现无状态的计算难得多。旧的流处理系统并不支持有状态的计算，而新一代的流处理系统则将状态及其正确性视为重中之重。</p>
</li>
</ul>
<h3 id="Flink-中的状态"><a href="#Flink-中的状态" class="headerlink" title="Flink 中的状态"></a>Flink 中的状态</h3><p><img src="/2021/04/25/flink/image-20210806165916098.png" alt="image-20210806165916098"></p>
<ul>
<li>Flink 内置的很多算子，数据源 Source，数据存储 Sink 都是有状态的，流中的数据都是 buffer records，会保存一定的元素或者元数据。例如：ProcessWindowFunction 会缓存输入流的数据，ProcessFunction 会保存设置的定时器信息等等。</li>
<li>由一个任务维护，并且用来计算某个结果的所有数据，都属于这个任务的状态。</li>
<li>可以认为状态就是一个本地变量 (保存在内存中)，可以被任务的业务逻辑访问。</li>
<li>Flink 会进行状态管理，包括状态一致性、故障处理以及高效存储和访问，以便开发人员可以专注于应用程序的逻辑。</li>
<li>在 Flink 中，状态始终与特定算子相关联。</li>
<li>为了使运行时的 Flink 了解算子的状态，算子需要预先注册其状态。</li>
<li>总的说来，有两种类型的状态：<ul>
<li>算子状态 (Operator State)<ul>
<li>算子状态的作用范围限定为算子任务。</li>
<li>后面的算子任务，无法访问前面的算子任务的状态。</li>
</ul>
</li>
<li>键控状态 (Keyed State)<ul>
<li>根据输入数据流中定义的键 (key) 来维护和访问。</li>
<li>访问原则：只有当前 key 对应的数据，才能访问当前 key 对应的状态。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="算子状态-Operator-State"><a href="#算子状态-Operator-State" class="headerlink" title="算子状态 (Operator State)"></a>算子状态 (Operator State)</h3><p><img src="/2021/04/25/flink/image-20210809154103959.png" alt="image-20210809154103959"></p>
<ul>
<li>算子状态的作用范围限定为算子任务，由同一并行任务所处理的所有数据都可以访问到相同的状态。<ul>
<li>到达当前算子的所有任务，共享算子状态，不论这些任务的 key 是否相同。注意：需要是同一个分区的。如果一个算子有多个并行分区，每一个分区的子任务，享有自己所在分区的算子状态。</li>
</ul>
</li>
<li>状态对于同一子任务而言是共享的。</li>
<li>算子状态不能由相同或不同算子的另一个子任务访问。</li>
</ul>
<h4 id="算子状态数据结构"><a href="#算子状态数据结构" class="headerlink" title="算子状态数据结构"></a>算子状态数据结构</h4><ul>
<li><p>列表状态 (List state)</p>
<ul>
<li>将状态表示为一组数据的列表。</li>
<li>列表状态方便于后续算子任务可能存在的并行度的调整。</li>
</ul>
</li>
<li><p>联合列表状态 (Union list state)</p>
<ul>
<li><p>也将状态表示为数据的列表。它与常规列表状态的区别在于，在发生故障时，或者从保存点 (savepoint) 启动应用程序时如何恢复。</p>
<p><img src="/2021/04/25/flink/image-20210809163414850.png" alt="image-20210809163414850"></p>
<p><img src="/2021/04/25/flink/image-20210809163742517.png" alt="image-20210809163742517"></p>
</li>
</ul>
</li>
<li><p>广播状态 (Broadcast state)</p>
<ul>
<li>如果一个算子有多项任务，而它的每项任务状态又都相同，那么这种特殊情况最适合应用广播状态。比如：算子的状态是某个配置项，则其对每项任务都是相同的状态。</li>
</ul>
</li>
</ul>
<h4 id="算子状态的使用"><a href="#算子状态的使用" class="headerlink" title="算子状态的使用"></a>算子状态的使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateTest1_OperatorState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.定义一个有状态的map操作，统计当前分区数据个数</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Integer&gt; resultStream = dataStream.map(<span class="keyword">new</span> MyCountMapper());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义MapFunction</span></span><br><span class="line">    <span class="comment">// ListCheckpointed&lt;Integer&gt;：列表状态，存放当前要保存的算子状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCountMapper</span> <span class="keyword">implements</span> <span class="title">MapFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Integer</span>&gt;, <span class="title">ListCheckpointed</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义一个本地变量，作为算子状态</span></span><br><span class="line">        <span class="comment">// 算子状态，从使用上来看，就相当于一个本地变量</span></span><br><span class="line">        <span class="keyword">private</span> Integer count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">map</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存状态使用的方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">snapshotState</span><span class="params">(<span class="keyword">long</span> checkpointId, <span class="keyword">long</span> timestamp)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singletonList(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复状态使用的方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreState</span><span class="params">(List&lt;Integer&gt; state)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 可能有多个分区，每个分区都有自己的算子状态</span></span><br><span class="line">            <span class="keyword">for</span> (Integer num : state) &#123;</span><br><span class="line">                count += num;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="键控状态-Keyed-State"><a href="#键控状态-Keyed-State" class="headerlink" title="键控状态 (Keyed State)"></a>键控状态 (Keyed State)</h3><p><img src="/2021/04/25/flink/image-20210809170614289.png" alt="image-20210809170614289"></p>
<ul>
<li><p>键控状态是根据输入数据流中定义的键 (key) 来维护和访问的。</p>
</li>
<li><p>Flink 为每个 key 维护一个状态实例，并将具有相同键的所有数据，都分区到同一个算子任务中，这个任务会维护和处理这个 key 对应的状态。</p>
</li>
<li><p>当任务处理一条数据时，它会自动将状态的访问范围限定为当前数据的 key。因此，具有相同 key 的所有数据都会访问相同的状态。</p>
<ul>
<li>不同 key 的数据，即使分配在同一个 Task 内，也会按 key 保存不同的状态，访问时，不同的 key 之间不共享状态。</li>
</ul>
</li>
<li><p>键控状态很类似于一个分布式的 key-value map 数据结构，只能用于 KeyedStream (keyBy 算子处理之后)。</p>
</li>
</ul>
<h4 id="键控状态数据结构"><a href="#键控状态数据结构" class="headerlink" title="键控状态数据结构"></a>键控状态数据结构</h4><ul>
<li>值状态 (Value state)<ul>
<li><code>ValueState&lt;T&gt;</code>：将状态表示为单个的值，值的类型为 T。<ul>
<li><code>ValueState.value()</code>：get 操作。</li>
<li><code>ValueState.update(T value)</code>：set 操作。</li>
<li><code>ValueState.clear()</code>：清空。</li>
</ul>
</li>
</ul>
</li>
<li>列表状态 (List state)<ul>
<li><code>ListState&lt;T&gt;</code>：将状态表示为一组数据的列表，列表里的元素的数据类型为 T。<ul>
<li><code>ListState.add(T value)</code></li>
<li><code>ListState.addAll(List&lt;T&gt; values)</code></li>
<li><code>ListState.get()</code>：返回 <code>Iterable&lt;T&gt;</code>。</li>
<li><code>ListState.update(List&lt;T&gt; values)</code></li>
<li><code>ListState.clear()</code>：清空。</li>
</ul>
</li>
</ul>
</li>
<li>映射状态 (Map state)<ul>
<li><code>MapState&lt;K, V&gt;</code>：将状态表示为一组 Key-Value 对。<ul>
<li><code>MapState.get(UK key)</code></li>
<li><code>MapState.put(UK key, UV value)</code></li>
<li><code>MapState.contains(UK key)</code></li>
<li><code>MapState.remove(UK key)</code></li>
<li><code>MapState.clear()</code>：清空。</li>
</ul>
</li>
</ul>
</li>
<li>聚合状态 (Reducing state &amp; Aggregating state)<ul>
<li><code>ReducingState&lt;T&gt;</code> 或 <code>AggregatingState&lt;I, O&gt;</code>：将状态表示为一个用于聚合操作的列表。</li>
<li><code>State.clear()</code>：清空。</li>
</ul>
</li>
</ul>
<h4 id="键控状态的使用"><a href="#键控状态的使用" class="headerlink" title="键控状态的使用"></a>键控状态的使用</h4><ul>
<li><p>声明一个键控状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyCountState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Integer&gt;(<span class="string">&quot;key-count&quot;</span>, Integer.class, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>需要使用运行时上下文，意味着键控状态的使用不同于算子状态，必须要在富函数中实现。</li>
<li>在 <code>open()</code> 中赋值 state 变量。</li>
<li>通过 RuntimeContext 注册 StateDescriptor。StateDescriptor 以状态 state 的名字和存储的数据类型为参数。state 的名字不能重复。</li>
</ul>
</li>
<li><p>读取状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer count = keyCountState.value();</span><br></pre></td></tr></table></figure>
</li>
<li><p>对状态赋值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyCountState.update(count);</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateTest2_KeyedState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.定义一个有状态的map操作，统计当前分区数据个数</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Integer&gt; resultStream = dataStream</span><br><span class="line">                .keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .map(<span class="keyword">new</span> MyKeyCountMapper());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义RichMapFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyKeyCountMapper</span> <span class="keyword">extends</span> <span class="title">RichMapFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 值状态</span></span><br><span class="line">        <span class="keyword">private</span> ValueState&lt;Integer&gt; keyCountState;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其它类型状态的声明</span></span><br><span class="line">        <span class="keyword">private</span> ListState&lt;String&gt; myListState;<span class="comment">// 列表状态</span></span><br><span class="line">        <span class="keyword">private</span> MapState&lt;String, Double&gt; myMapState;<span class="comment">// 映射状态</span></span><br><span class="line">        <span class="keyword">private</span> ReducingState&lt;SensorReading&gt; myReducingState;<span class="comment">// 聚合状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须要在open方法里赋值，不同状态的名称不能相同</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 值状态的赋值，此处初始值为0，如果不设置，则是null，在使用时需要先判断是否为null</span></span><br><span class="line">            <span class="comment">// 但此方法已被弃用，推荐不设初始值，在使用时手动判断并赋值</span></span><br><span class="line">            keyCountState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Integer&gt;(<span class="string">&quot;key-count&quot;</span>, Integer.class, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 其它类型状态的赋值</span></span><br><span class="line">            myListState = getRuntimeContext().getListState(<span class="keyword">new</span> ListStateDescriptor&lt;String&gt;(<span class="string">&quot;my-list&quot;</span>, String.class));</span><br><span class="line">            myMapState = getRuntimeContext().getMapState(<span class="keyword">new</span> MapStateDescriptor&lt;String, Double&gt;(<span class="string">&quot;my-map&quot;</span>, String.class, Double.class));</span><br><span class="line">            myReducingState = getRuntimeContext().getReducingState(<span class="keyword">new</span> ReducingStateDescriptor&lt;SensorReading&gt;(<span class="string">&quot;my-reduce&quot;</span>, <span class="keyword">new</span> ReduceFunction&lt;SensorReading&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> SensorReading <span class="title">reduce</span><span class="params">(SensorReading value1, SensorReading value2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="comment">// 按照具体需求，返回对应的对象</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SensorReading.class));<span class="comment">// 聚合状态需要传入一个聚合函数</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">map</span><span class="params">(SensorReading value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 值状态的使用，先取值，再赋值</span></span><br><span class="line">            Integer count = keyCountState.value();</span><br><span class="line">            count++;</span><br><span class="line">            keyCountState.update(count);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 其它状态API调用</span></span><br><span class="line">            <span class="comment">// list state --- List的常规操作</span></span><br><span class="line">            Iterable&lt;String&gt; lists = myListState.get();<span class="comment">// 取</span></span><br><span class="line">            <span class="keyword">for</span> (String str : lists) &#123;</span><br><span class="line">                System.out.println(str);</span><br><span class="line">            &#125;</span><br><span class="line">            myListState.add(<span class="string">&quot;hello&quot;</span>);<span class="comment">// 一个一个追加，也可以addAll()添加一个List</span></span><br><span class="line">            myListState.clear();<span class="comment">// 清空</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// map state --- Map的常规操作</span></span><br><span class="line">            myMapState.get(<span class="string">&quot;1&quot;</span>);<span class="comment">// 取</span></span><br><span class="line">            myMapState.put(<span class="string">&quot;2&quot;</span>, <span class="number">12.3</span>);<span class="comment">// 存</span></span><br><span class="line">            myMapState.remove(<span class="string">&quot;2&quot;</span>);<span class="comment">// 移除一个</span></span><br><span class="line">            myMapState.clear();<span class="comment">// 清空</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// reducing state</span></span><br><span class="line">            SensorReading sensorReading = myReducingState.get();<span class="comment">// 取</span></span><br><span class="line">            myReducingState.add(value);<span class="comment">// 会调用聚合状态声明的聚合函数来处理传入的值</span></span><br><span class="line">            myReducingState.clear();<span class="comment">// 清空</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例：检测传感器的温度值，如果连续的两个温度差值超过 10 度，就输出报警。</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateTest3_KeyedStateApplicationCase</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.定义一个flatmap操作，检测温度跳变，输出报警</span></span><br><span class="line">        <span class="comment">// map是一对一，实际情况时，可能有null数据，输出结果可能不同于输入数据，因此选择flatmap</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple3&lt;String, Double, Double&gt;&gt; resultStream = dataStream</span><br><span class="line">                .keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .flatMap(<span class="keyword">new</span> TempChangeWarning(<span class="number">10.0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        resultStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义函数类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TempChangeWarning</span> <span class="keyword">extends</span> <span class="title">RichFlatMapFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Tuple3</span>&lt;<span class="title">String</span>, <span class="title">Double</span>, <span class="title">Double</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 温度跳变阈值</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> threshold;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TempChangeWarning</span><span class="params">(<span class="keyword">double</span> threshold)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.threshold = threshold;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义值状态，保存上一次的温度值</span></span><br><span class="line">        <span class="keyword">private</span> ValueState&lt;Double&gt; lastTempState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 赋值，不定义初始值，使用时判断</span></span><br><span class="line">            lastTempState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Double&gt;(<span class="string">&quot;last-temp-state&quot;</span>, Double.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(SensorReading sensorReading, Collector&lt;Tuple3&lt;String, Double, Double&gt;&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Double lastTempValue = lastTempState.value();</span><br><span class="line">            <span class="comment">// 如果状态不为null，那么就判断两次温度差值</span></span><br><span class="line">            <span class="keyword">if</span> (lastTempValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 当前温度与上一次温度的差值</span></span><br><span class="line">                <span class="keyword">double</span> diff = Math.abs(sensorReading.getTemperature() - lastTempValue);</span><br><span class="line">                <span class="keyword">if</span> (diff &gt;= threshold) &#123;</span><br><span class="line">                    <span class="comment">// 输出报警信息</span></span><br><span class="line">                    out.collect(<span class="keyword">new</span> Tuple3&lt;&gt;(sensorReading.getId(), lastTempValue, sensorReading.getTemperature()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新状态为当前温度</span></span><br><span class="line">            lastTempState.update(sensorReading.getTemperature());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            lastTempState.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数输入：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP<span class="literal">-OM8IACS</span>:/mnt/c/Users/Ziyoo<span class="variable">$</span> nc <span class="literal">-lk</span> <span class="number">7777</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">37.9</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">48</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">35</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">36.9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">37.9</span>,<span class="number">48.0</span>)</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_6,<span class="number">15.4</span>,<span class="number">35.0</span>)</span></span></span><br><span class="line"><span class="function">3&gt; <span class="params">(sensor_1,<span class="number">48.0</span>,<span class="number">36.9</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输入 <code>sensor_1,1547718199,48</code> 时触发 sensor_1 报警，输入 <code>sensor_6,1547718201,35</code> 时触发 sensor_6 报警，输入 <code>sensor_1,1547718199,36.9</code> 时再次触发 sensor_1 报警。</p>
</li>
</ul>
</li>
</ul>
<h3 id="状态后端-State-Backends"><a href="#状态后端-State-Backends" class="headerlink" title="状态后端 (State Backends)"></a>状态后端 (State Backends)</h3><ul>
<li>每传入一条数据，有状态的算子任务都会读取和更新状态。</li>
<li>由于有效的状态访问对于处理数据的低延迟至关重要，因此每个并行任务都会在本地维护其状态，以确保快速的状态访问。</li>
<li>状态的存储、访问以及维护，由一个可插入的组件决定，这个组件就叫做状态后端 (state backend)。</li>
<li>状态后端主要负责两件事：本地的状态管理，以及将检查点 (Checkpoint) 状态写入远程存储。</li>
</ul>
<h4 id="选择一个状态后端"><a href="#选择一个状态后端" class="headerlink" title="选择一个状态后端"></a>选择一个状态后端</h4><ul>
<li><p>MemoryStateBackend</p>
<ul>
<li>内存级的状态后端，会将键控状态作为内存中的对象进行管理，将它们存储在 TaskManager 的 JVM 堆上，而将 Checkpoint 存储在 JobManager 的内存中。</li>
<li>特点：快速、低延迟，但不稳定。</li>
</ul>
</li>
<li><p>FsStateBackend</p>
<ul>
<li>将 Checkpoint 存到远程的持久化文件系统 (FileSystem) 上，而对于本地状态，跟 MemoryStateBackend 一样，也会存储在 TaskManager 的 JVM 堆上。</li>
<li>同时拥有内存级的本地访问速度，和更好的容错保证。</li>
</ul>
</li>
<li><p>RocksDBStateBackend</p>
<ul>
<li><p>将所有状态序列化后，存入本地的 RocksDB 中存储。</p>
</li>
<li><p>RocksDB 的支持并不直接包含在 Flink 中，需要引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-statebackend-rocksdb_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="状态后端的使用配置"><a href="#状态后端的使用配置" class="headerlink" title="状态后端的使用配置"></a>状态后端的使用配置</h4><ul>
<li><p>在 conf/flink-conf.yaml 配置文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#==============================================================================</span></span><br><span class="line"><span class="comment"># Fault tolerance and checkpointing</span></span><br><span class="line"><span class="comment">#==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The backend that will be used to store operator state checkpoints if</span></span><br><span class="line"><span class="comment"># checkpointing is enabled.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Supported backends are &#x27;jobmanager&#x27;, &#x27;filesystem&#x27;, &#x27;rocksdb&#x27;, or the</span></span><br><span class="line"><span class="comment"># &lt;class-name-of-factory&gt;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># state.backend: filesystem</span></span><br><span class="line"><span class="comment"># 默认使用FsStateBackend</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory for checkpoints filesystem, when using any of the default bundled</span></span><br><span class="line"><span class="comment"># state backends.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">state.checkpoints.dir:</span> <span class="string">hdfs://mghadoop:8020/flink-checkpoints</span></span><br><span class="line"><span class="comment"># checkpoints保存路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default target directory for savepoints, optional.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># state.savepoints.dir: hdfs://namenode-host:port/flink-checkpoints</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flag to enable/disable incremental checkpoints for backends that</span></span><br><span class="line"><span class="comment"># support incremental checkpoints (like the RocksDB state backend). </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># state.backend.incremental: false</span></span><br><span class="line"><span class="comment"># 是否增量化的进行checkpoints保存，默认false，比如FsStateBackend不容易支持此操作，但RocksDB可以</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The failover strategy, i.e., how the job computation recovers from task failures.</span></span><br><span class="line"><span class="comment"># Only restart tasks that may have been affected by the task failure, which typically includes</span></span><br><span class="line"><span class="comment"># downstream tasks and potentially upstream tasks if their produced data is no longer available for consumption.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobmanager.execution.failover-strategy:</span> <span class="string">region</span></span><br><span class="line"><span class="comment"># 区域重启的策略，即需要重启时，不是把所有的任务全部停掉再重启，而是只对受影响的区域执行重启，其他区域正常执行</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在代码中对每个任务配置：</p>
<ul>
<li><p>MemoryStateBackend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setStateBackend(<span class="keyword">new</span> MemoryStateBackend());</span><br></pre></td></tr></table></figure>

<ul>
<li><p>MemoryStateBackend 的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无参</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MemoryStateBackend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>, DEFAULT_MAX_STATE_SIZE, TernaryBoolean.UNDEFINED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// asynchronousSnapshots：是否开启异步快照，即执行快照时，不影响任务的继续操作</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MemoryStateBackend</span><span class="params">(<span class="keyword">boolean</span> asynchronousSnapshots)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>, DEFAULT_MAX_STATE_SIZE, TernaryBoolean.fromBoolean(asynchronousSnapshots));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>FsStateBackend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要传入一个checkpoints保存路径对应的uri</span></span><br><span class="line">env.setStateBackend(<span class="keyword">new</span> FsStateBackend(<span class="string">&quot;&quot;</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>RocksDBStateBackend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 需要传入一个checkpoints保存路径对应的uri</span></span><br><span class="line">    env.setStateBackend(<span class="keyword">new</span> RocksDBStateBackend(<span class="string">&quot;&quot;</span>));</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">    exception.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>RocksDBStateBackend 的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RocksDBStateBackend</span><span class="params">(String checkpointDataUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>((<span class="keyword">new</span> Path(checkpointDataUri)).toUri());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// enableIncrementalCheckpointing：是否开启增量化的进行checkpoints保存</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RocksDBStateBackend</span><span class="params">(String checkpointDataUri, <span class="keyword">boolean</span> enableIncrementalCheckpointing)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>((<span class="keyword">new</span> Path(checkpointDataUri)).toUri(), enableIncrementalCheckpointing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Flink-的容错机制"><a href="#Flink-的容错机制" class="headerlink" title="Flink 的容错机制"></a>Flink 的容错机制</h2><h3 id="一致性检查点-Checkpoint"><a href="#一致性检查点-Checkpoint" class="headerlink" title="一致性检查点 (Checkpoint)"></a>一致性检查点 (Checkpoint)</h3><p><img src="/2021/04/25/flink/image-20210810161328004.png" alt="image-20210810161328004"></p>
<ul>
<li>Flink 故障恢复机制的核心，就是应用状态的一致性检查点。</li>
<li>有状态流应用的一致检查点，其实就是所有任务的状态，在某个时间点的一份拷贝 (一份快照)；这个时间点，应该是所有任务都恰好处理完一个相同的输入数据的时候。</li>
</ul>
<h3 id="从检查点恢复状态"><a href="#从检查点恢复状态" class="headerlink" title="从检查点恢复状态"></a>从检查点恢复状态</h3><ul>
<li><p>在执行流应用程序期间，Flink 会定期保存状态的一致检查点。</p>
</li>
<li><p>如果发生故障， Flink 将会使用最近的检查点来一致恢复应用程序的状态，并重新启动处理流程。</p>
<p><img src="/2021/04/25/flink/image-20210810162207412.png" alt="image-20210810162207412"></p>
</li>
<li><p>遇到故障之后，第一步就是重启应用：</p>
<p><img src="/2021/04/25/flink/image-20210810162427408.png" alt="image-20210810162427408"></p>
</li>
<li><p>第二步是从 Checkpoint 中读取状态，将状态重置：</p>
<p><img src="/2021/04/25/flink/image-20210810162656149.png" alt="image-20210810162656149"></p>
<ul>
<li>从检查点重新启动应用程序后，其内部状态与检查点完成时的状态完全相同。</li>
</ul>
</li>
<li><p>第三步，开始消费并处理检查点到发生故障之间的所有数据：</p>
<p><img src="/2021/04/25/flink/image-20210810163340480.png" alt="image-20210810163340480"></p>
</li>
<li><p>这种检查点的保存和恢复机制可以为应用程序状态提供 “精确一次” (exactly-once) 的一致性，因为所有算子都会保存检查点并恢复其所有状态，这样一来所有的输入流就都会被重置到检查点完成时的位置。</p>
</li>
</ul>
<h3 id="检查点的实现算法"><a href="#检查点的实现算法" class="headerlink" title="检查点的实现算法"></a>检查点的实现算法</h3><ul>
<li>一种简单的想法：<ul>
<li>暂停应用，保存状态到检查点，再重新恢复应用。</li>
</ul>
</li>
<li>Flink 的改进实现：<ul>
<li>基于 Chandy-Lamport 算法的分布式快照。</li>
<li>将检查点的保存和数据处理分离开，不暂停整个应用。</li>
</ul>
</li>
</ul>
<h3 id="Flink-检查点算法"><a href="#Flink-检查点算法" class="headerlink" title="Flink 检查点算法"></a>Flink 检查点算法</h3><ul>
<li><p>Flink 检查点算法的正式名称是异步分界线快照 (asynchronous barrier snapshotting)。</p>
</li>
<li><p>检查点分界线 (Checkpoint Barrier)</p>
<ul>
<li>Flink 的检查点算法用到了一种称为分界线 (barrier) 的特殊数据形式，用来把一条流上数据按照不同的检查点分开。</li>
<li>分界线之前到来的数据导致的状态更改，都会被包含在当前分界线所属的检查点中；而基于分界线之后的数据导致的所有更改，就会被包含在之后的检查点中。</li>
</ul>
</li>
<li><p>假设现在是一个有两个输入流的应用程序，用并行的两个 Source 任务来读取。</p>
<p><img src="/2021/04/25/flink/image-20210810171057951.png" alt="image-20210810171057951"></p>
</li>
<li><p>首先，JobManager 会向每个 Source 任务同时发送一条带有新检查点 ID 的消息，通过这种方式来启动检查点。</p>
<p><img src="/2021/04/25/flink/image-20210810172052882.png" alt="image-20210810172052882"></p>
</li>
<li><p>然后，每个数据源将它们的状态写入检查点，并向后续任务广播发出一个检查点 barrier。状态后端在状态存入检查点之后，会返回通知给 Source 任务，Source 任务就会向 JobManager 确认检查点完成。</p>
<p><img src="/2021/04/25/flink/image-20210810173003834.png" alt="                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          "></p>
</li>
<li><p>之后，每个 Source 发送的 barrier 向下游传递，sum 任务 (下游任务) 会等待所有输入分区的 barrier 到达，这叫分界线对齐。</p>
<p><img src="/2021/04/25/flink/image-20210810214432904.png" alt="image-20210810214432904"></p>
<ul>
<li>对于 barrier 已经到达的分区，继续到达的数据会被缓存。</li>
<li>而 barrier 尚未到达的分区，数据会被正常处理。</li>
</ul>
</li>
<li><p>当收到所有输入分区的 barrier 时，任务就将其状态保存到状态后端的检查点中，然后将 barrier 继续向下游转发。</p>
<p><img src="/2021/04/25/flink/image-20210810220612064.png" alt="image-20210810220612064"></p>
</li>
<li><p>向下游转发检查点 barrier 后，任务继续正常的数据处理。</p>
<p><img src="/2021/04/25/flink/image-20210810231203921.png" alt="image-20210810231203921"></p>
</li>
<li><p>Sink 任务收到 barrier 后，也向 JobManager 确认状态保存到 checkpoint 完毕。</p>
<p><img src="/2021/04/25/flink/image-20210810231535649.png" alt="image-20210810231535649"></p>
</li>
<li><p>至此，当所有任务都确认已成功将状态保存到检查点时，当前这个检查点就真正完成了。</p>
</li>
<li><p>如果检查点操作失败，Flink 可以丢弃该检查点并继续正常执行，因为之后的某一个检查点可能会成功。虽然恢复时间可能更长，但是对于状态的保证依旧很有力。只有在一系列连续的检查点操作失败之后，Flink 才会抛出错误，因为这通常预示着发生了严重且持久的错误。</p>
</li>
</ul>
<h3 id="保存点-Savepoints"><a href="#保存点-Savepoints" class="headerlink" title="保存点 (Savepoints)"></a>保存点 (Savepoints)</h3><ul>
<li>Flink 还提供了可以自定义的镜像保存功能，就是保存点 (savepoints)。</li>
<li>原则上，创建保存点使用的算法与检查点完全相同，因此保存点可以认为就是具有一些额外元数据的检查点。<ul>
<li>检查点可以看作是自动存盘，保存点可以看作是手动存盘。</li>
</ul>
</li>
<li>Flink不会自动创建保存点，因此用户 (或者外部调度程序) 必须明确地触发创建操作。</li>
<li>保存点是一个强大的功能。除了故障恢复外，保存点可以用于：有计划的手动备份，更新应用程序，版本迁移，暂停和重启应用，等等。</li>
</ul>
<h3 id="检查点的使用配置"><a href="#检查点的使用配置" class="headerlink" title="检查点的使用配置"></a>检查点的使用配置</h3><ul>
<li><p>检查点默认情况下关闭，需要手动设置才能开启使用。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateTest4_FaultTolerance</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.检查点的配置</span></span><br><span class="line">        <span class="comment">// 开启检查点，参数表示每隔300毫秒触发一次Checkpoint，默认为500毫秒</span></span><br><span class="line">        env.enableCheckpointing(<span class="number">300L</span>);</span><br><span class="line">        <span class="comment">// 状态一致性的选择</span></span><br><span class="line">        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line">        <span class="comment">// 执行Checkpoint的超时时间，60s内完成，否则丢掉此次的Checkpoint</span></span><br><span class="line">        env.getCheckpointConfig().setCheckpointTimeout(<span class="number">60000L</span>);</span><br><span class="line">        <span class="comment">// 最大同时执行Checkpoint的数量，是指前一个Checkpoint还未执行结束，下一个Checkpoint已经开始执行，</span></span><br><span class="line">        <span class="comment">// 默认为1，即只能前一个Checkpoint执行完成后，下一个Checkpoint才能开始</span></span><br><span class="line">        env.getCheckpointConfig().setMaxConcurrentCheckpoints(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 两个Checkpoint之间最小的时间间隔，即前一个Checkpoint执行完成时间，与下一个Checkpoint执行开始时间之间的最小间隔</span></span><br><span class="line">        <span class="comment">// 可以防止Checkpoint处理过慢，整个集群都在处理Checkpoint，而没有时间处理真正的数据</span></span><br><span class="line">        <span class="comment">// 设置最小时间间隔后，则最大同时执行Checkpoint的数量就只能为1</span></span><br><span class="line">        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(<span class="number">100L</span>);</span><br><span class="line">        <span class="comment">// 倾向于使用Checkpoint进行故障回复，即使存在一个更近的Savepoint，默认false</span></span><br><span class="line">        env.getCheckpointConfig().setPreferCheckpointForRecovery(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 允许Checkpoint失败的次数，默认为0，即Checkpoint执行时如果失败了，会认为是整个任务失败，需要重启</span></span><br><span class="line">        env.getCheckpointConfig().setTolerableCheckpointFailureNumber(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.重启策略的配置</span></span><br><span class="line">        <span class="comment">// env.setRestartStrategy(RestartStrategies.noRestart());// 不重启，若工作失败则直接宣告失败，不启用Checkpoint时的策略</span></span><br><span class="line">        <span class="comment">// env.setRestartStrategy(RestartStrategies.fallBackRestart());// 回滚重启，将重启的策略交给上级的资源管理平台</span></span><br><span class="line">        <span class="comment">// 固定延迟重启，每隔30s重启一次，尝试3次，超过之后，工作宣告失败。</span></span><br><span class="line">        <span class="comment">// 启用Checkpoint后，这是默认的重启策略，尝试重启次数为Integer.MAX_VALUE</span></span><br><span class="line">        <span class="comment">// env.setRestartStrategy(RestartStrategies.fixedDelayRestart(3, 30000L));</span></span><br><span class="line">        <span class="comment">// 失败率重启，常用，任务失败后重启工作，如果10min内失败次数超过3次，则工作宣告失败，连续两次重启尝试中间隔1min</span></span><br><span class="line">        env.setRestartStrategy(RestartStrategies.failureRateRestart(<span class="number">3</span>, Time.minutes(<span class="number">10</span>), Time.minutes(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.打印</span></span><br><span class="line">        dataStream.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Flink-的状态一致性"><a href="#Flink-的状态一致性" class="headerlink" title="Flink 的状态一致性"></a>Flink 的状态一致性</h2><h3 id="状态一致性的概念"><a href="#状态一致性的概念" class="headerlink" title="状态一致性的概念"></a>状态一致性的概念</h3><p><img src="/2021/04/25/flink/image-20210812151826568.png" alt="image-20210812151826568"></p>
<ul>
<li>当在分布式系统中引入状态时，自然也引入了一致性问题。一致性实际上是 “正确性级别” 的另一种说法，也就是说在成功处理故障并恢复之后得到的结果，与没有发生任何故障时得到的结果相比，前者到底有多正确？举例来说，假设要对最近一小时登录的用户计数。在系统经历故障之后，计数结果是多少？如果有偏差，是有漏掉的计数还是重复计数？</li>
<li>有状态的流处理，内部每个算子任务都可以有自己的状态</li>
<li>对于流处理器内部来说，所谓的状态一致性，其实就是我们所说的计算结果要保证准确。</li>
<li>一条数据不应该丢失，也不应该重复计算。</li>
<li>在遇到故障时可以恢复状态，恢复以后的重新计算，结果应该也是完全正确的。</li>
</ul>
<h3 id="状态一致性的级别"><a href="#状态一致性的级别" class="headerlink" title="状态一致性的级别"></a>状态一致性的级别</h3><ul>
<li>在流处理中，一致性可以分为 3 个级别。</li>
<li>AT-MOST-ONCE：最多一次。<ul>
<li>当任务故障时，最简单的做法是什么都不干，既不恢复丢失的状态，也不处理丢失的数据。at-most-once 语义的含义是最多处理一次事件。</li>
</ul>
</li>
<li>AT-LEAST-ONCE：至少一次。<ul>
<li>在大多数的真实应用场景，我们希望不丢失事件。这种类型的保障称为 at-least-once，意思是所有的事件都得到了处理，但一些事件可能被处理多次。这表示计算结果可能大于正确值，但绝不会小于正确值。</li>
</ul>
</li>
<li>EXACTLY-ONCE：精确一次。<ul>
<li>恰好处理一次是最严格的保证，也是最难实现的。恰好处理一次语义不仅仅意味着没有事件丢失，还意味着针对每一个数据，内部状态仅仅更新一次。</li>
</ul>
</li>
<li>曾经，at-least-once 非常流行。第一代流处理器 (如 Storm 和 Samza) 刚问世时，只保证 at-least-once，原因有二：<ul>
<li>保证 exactly-once 的系统实现起来更复杂。这在基础架构层 (决定什么代表正确，以及 exactly-once 的范围是什么) 和实现层都很有挑战性。</li>
<li>流处理系统的早期用户愿意接受框架的局限性，并在应用层想办法弥补 (例如使应用程序具有幂等性，或者用批量计算层再做一遍计算)。</li>
</ul>
</li>
<li>最先保证 exactly-once 的系统 (Storm Trident 和 Spark Streaming)，在性能和表现力这两个方面付出了很大的代价。为了保证 exactly-once，这些系统无法单独地对每条记录运用应用逻辑，而是同时处理多条 (一批) 记录，保证对每一批的处理要么全部成功，要么全部失败。这就导致在得到结果前，必须等待一批记录处理结束。因此，用户经常不得不使用两个流处理框架 (一个用来保证 exactly-once，另一个用来对每个元素做低延迟处理)，结果使基础设施更加复杂。曾经，用户不得不在保证 exactly-once 与获得低延迟和效率之间权衡利弊。而 Flink 避免了这种权衡。</li>
<li>Flink 的一个重大价值在于， 它既保证了 exactly-once ，也具有低延迟和高吞吐力的处理能力。从根本上说，Flink 通过使自身满足所有需求来避免权衡，它是业界的一次意义重大的技术飞跃。尽管这在外行看来很神奇，但是一旦了解，就会恍然大悟。</li>
</ul>
<h3 id="exactly-once-的实现"><a href="#exactly-once-的实现" class="headerlink" title="exactly-once 的实现"></a>exactly-once 的实现</h3><p><img src="/2021/04/25/flink/image-20210812173118769.png" alt="image-20210812173118769"></p>
<ul>
<li>Flink 使用了一种轻量级快照机制 —— 检查点 (Checkpoint) 来保证 exactly-once 语义。</li>
<li>有状态流应用的一致检查点，其实就是：所有任务的状态，在某个时间点的一份拷贝 (一份快照)。而这个时间点，应该是所有任务都恰好处理完一个相同的输入数据的时候。</li>
<li>应用状态的一致检查点，是 Flink 故障恢复机制的核心。</li>
</ul>
<h3 id="端到端-end-to-end-状态一致性"><a href="#端到端-end-to-end-状态一致性" class="headerlink" title="端到端 (end-to-end) 状态一致性"></a>端到端 (end-to-end) 状态一致性</h3><ul>
<li>目前我们看到的一致性保证都是由流处理器实现的，也就是说都是在 Flink 流处理器内部保证的；而在真实应用中，流处理应用除了流处理器以外还包含了数据源 (例如 Kafka) 和输出到持久化系统。</li>
<li>端到端的一致性保证，意味着结果的正确性贯穿了整个流处理应用的始终；每一个组件都需要保证它自己的一致性。</li>
<li>整个端到端的一致性级别取决于所有组件中一致性最弱的组件。</li>
</ul>
<h3 id="端到端-exactly-once"><a href="#端到端-exactly-once" class="headerlink" title="端到端 exactly-once"></a>端到端 exactly-once</h3><ul>
<li>内部保证 —— Checkpoint 机制。</li>
<li>Source 端 —— 可重设数据的读取位置。</li>
<li>Sink 端 —— 从故障恢复时，数据不会重复写入外部系统。有两种实现方式：<ul>
<li>幂等写入</li>
<li>事务写入</li>
</ul>
</li>
</ul>
<h4 id="幂等写入-Idempotent-Writes"><a href="#幂等写入-Idempotent-Writes" class="headerlink" title="幂等写入 (Idempotent Writes)"></a>幂等写入 (Idempotent Writes)</h4><p><img src="/2021/04/25/flink/image-20210812232358366.png" alt="image-20210812232358366"></p>
<ul>
<li>所谓幂等操作，是说一个操作，可以重复执行很多次，但只导致一次结果更改，也就是说，后面再重复执行就不起作用了。</li>
<li>能够保证最终的结果是正确的，但不能保证中间过程全部正确。当前一个 Checkpoint 结束，后一个 Checkpoint 还未开始时，中间的数据会被处理，也会输出结果，此时如果出现故障，回滚到前一个 Checkpoint 保存的状态，中间的数据又会被处理一次并输出结果。虽然最终的结果只会保留一次，但中间过程会对外界造成一种反复执行的错觉。</li>
</ul>
<h4 id="事务写入-Transactional-Writes"><a href="#事务写入-Transactional-Writes" class="headerlink" title="事务写入 (Transactional Writes)"></a>事务写入 (Transactional Writes)</h4><ul>
<li>事务（Transaction）<ul>
<li>应用程序中一系列严密的操作，所有操作必须成功完成，否则在每个操作中所作的所有更改都会被撤消。</li>
<li>具有原子性：一个事务中的一系列的操作要么全部成功，要么一个都不做</li>
</ul>
</li>
<li><strong>实现思想：构建的事务对应着 Flink 的 Checkpoint 机制，等到 Checkpoint 真正完成的时候，才把所有对应的结果写入 Sink 系统中。</strong></li>
<li>有两种实现方式：<ul>
<li>预写日志</li>
<li>两阶段提交</li>
</ul>
</li>
</ul>
<h5 id="预写日志-Write-Ahead-Log，WAL"><a href="#预写日志-Write-Ahead-Log，WAL" class="headerlink" title="预写日志 (Write-Ahead-Log，WAL)"></a>预写日志 (Write-Ahead-Log，WAL)</h5><ul>
<li>把结果数据先当成状态保存，然后在收到 Checkpoint 完成的通知时，一次性写入 Sink 系统。</li>
<li>简单易于实现，由于数据提前在状态后端中做了缓存，所以无论什么 Sink 系统，都能用这种方式一批搞定。</li>
<li>预写日志在特殊情况下不能真正实现 exactly-once，比如数据提交时，不能保证一定是全部提交，可能是提交一半另一半还未提交时，任务出现故障。</li>
<li>DataStream API 提供了一个模板类：GenericWriteAheadSink，来实现这种事务性 Sink。</li>
</ul>
<h5 id="两阶段提交-Two-Phase-Commit，2PC"><a href="#两阶段提交-Two-Phase-Commit，2PC" class="headerlink" title="两阶段提交 (Two-Phase-Commit，2PC)"></a>两阶段提交 (Two-Phase-Commit，2PC)</h5><ul>
<li><p>对于每个 Checkpoint，Sink 任务会启动一个事务，并将接下来所有接收的数据添加到事务里。</p>
</li>
<li><p>然后将这些数据写入外部 Sink 系统，但不提交它们 —— 这时只是 “预提交”。</p>
</li>
<li><p>当它收到 Checkpoint 完成的通知时，它才正式提交事务，实现结果的真正写入。</p>
</li>
<li><p>这种方式真正实现了 exactly-once，它需要一个提供事务支持的外部 Sink 系统。Flink 提供了 TwoPhaseCommitSinkFunction 接口，来实现两阶段提交的 Sink。比如，FlinkKakfaProducer 就继承了这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkKafkaProducer</span>&lt;<span class="title">IN</span>&gt;</span></span><br><span class="line"><span class="class">   <span class="keyword">extends</span> <span class="title">TwoPhaseCommitSinkFunction</span>&lt;<span class="title">IN</span>, <span class="title">FlinkKafkaProducer</span>.<span class="title">KafkaTransactionState</span>, <span class="title">FlinkKafkaProducer</span>.<span class="title">KafkaTransactionContext</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoPhaseCommitSinkFunction</span>&lt;<span class="title">IN</span>, <span class="title">TXN</span>, <span class="title">CONTEXT</span>&gt;</span></span><br><span class="line"><span class="class">      <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">IN</span>&gt;</span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">CheckpointedFunction</span>, <span class="title">CheckpointListener</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/25/flink/image-20210813095330140.png" alt="image-20210813095330140"></p>
</li>
</ul>
<h5 id="2PC-对外部-Sink-系统的要求"><a href="#2PC-对外部-Sink-系统的要求" class="headerlink" title="2PC 对外部 Sink 系统的要求"></a>2PC 对外部 Sink 系统的要求</h5><ul>
<li>外部 Sink 系统必须提供事务支持，或者 Sink 任务必须能够模拟外部系统上的事务</li>
<li>在 Checkpoint 的间隔期间里，必须能够开启一个事务并接受数据写入</li>
<li>在收到 Checkpoint 完成的通知之前，事务必须是 “等待提交” 的状态。在故障恢复的情况下，这可能需要一些时间。如果这个时候 Sink 系统关闭事务 (例如超时了)，那么未提交的数据就会丢失。</li>
<li>Sink 任务必须能够在进程失败后恢复事务。</li>
<li>提交事务必须是幂等操作。</li>
</ul>
<h3 id="不同-Source-和-Sink-的一致性保证"><a href="#不同-Source-和-Sink-的一致性保证" class="headerlink" title="不同 Source 和 Sink 的一致性保证"></a>不同 Source 和 Sink 的一致性保证</h3><p><img src="/2021/04/25/flink/image-20210813102001911.png" alt="image-20210813102001911"></p>
<blockquote>
<p>2PC 是最精准，也是最难实现得一种方式。</p>
</blockquote>
<h3 id="Flink-Kafka-端到端状态一致性的保证"><a href="#Flink-Kafka-端到端状态一致性的保证" class="headerlink" title="Flink + Kafka 端到端状态一致性的保证"></a>Flink + Kafka 端到端状态一致性的保证</h3><ul>
<li>内部 —— 利用 Checkpoint 机制，把状态存盘，发生故障的时候可以恢复，保证内部的状态一致性。</li>
<li>Source —— Kafka Consumer 作为 Source，可以自动将偏移量保存下来，如果后续任务出现了故障，恢复的时候可以由连接器重置偏移量，重新消费数据，保证一致性。</li>
<li>Sink —— Kafka Producer 作为 Sink，采用两阶段提交 sink，需要实现一个 TwoPhaseCommitSinkFunction。</li>
</ul>
<h4 id="Exactly-once-两阶段提交图解"><a href="#Exactly-once-两阶段提交图解" class="headerlink" title="Exactly-once 两阶段提交图解"></a>Exactly-once 两阶段提交图解</h4><ul>
<li><p>定义一个任务，JobManager 协调各个 TaskManager 进行 Checkpoint 存储。Checkpoint 保存在 StateBackend中，默认 StateBackend 是内存级的，也可以改为文件级的进行持久化保存。</p>
<p><img src="/2021/04/25/flink/image-20210813104309481.png" alt="image-20210813104309481"></p>
</li>
<li><p>第一步：当 Checkpoint 启动时，JobManager 会将检查点分界线 (barrier) 注入数据流。barrier 会在算子间传递下去。</p>
<p><img src="/2021/04/25/flink/image-20210813104522976.png" alt="image-20210813104522976"></p>
</li>
<li><p>第二步：每个算子会对当前的状态做个快照，并保存到状态后端。Checkpoint 机制可以保证内部的状态一致性。</p>
<p><img src="/2021/04/25/flink/image-20210813104938956.png" alt="image-20210813104938956"></p>
</li>
<li><p>第三步：与第二步类似，后续每个内部的 transform 任务遇到 barrier 时，都会先把状态保存到 Checkpoint 里，然后通知 JobManager，barrier 继续向下游传递。最后，数据先到达 Sink 任务，Sink 会把数据写入外部 Kafka，这些数据都属于预提交的事务 TX1；然后，barrier 后到达 Sink 任务，Sink 会先把自己的状态保存到状态后端，并开启一个新的预提交事务 TX2，barrier 后的数据属于这个新的预提交事务。(因为流的并行度可能不为 1，当前的 Sink 任务收到了 barrier，不代表所有的 Sink 任务都收到了，此时，不能正式提交事务)</p>
<p><img src="/2021/04/25/flink/image-20210813110109944.png" alt="image-20210813110109944"></p>
</li>
<li><p>第四步：当所有算子任务的快照完成，也就是当前的 Checkpoint 完成时，JobManager 会向所有任务发通知，确认当前 Checkpoint 完成。Sink 任务收到确认通知后，会正式提交之前的事务，Kafka 中未确认数据改为 “已确认”。</p>
<p><img src="/2021/04/25/flink/image-20210813111720234.png" alt="image-20210813111720234"></p>
</li>
</ul>
<h4 id="Exactly-once-两阶段提交步骤"><a href="#Exactly-once-两阶段提交步骤" class="headerlink" title="Exactly-once 两阶段提交步骤"></a>Exactly-once 两阶段提交步骤</h4><ul>
<li>第一条数据来了之后，开启一个 Kafka 的事务 (transaction)，记作 TX1，数据正常写入 Kafka 分区日志，但标记为未提交，这就是 “预提交”；</li>
<li>Jobmanager 触发 Checkpoint 操作，barrier 从 Source 开始向下传递，遇到 barrier 的算子将状态存入状态后端，并通知 Jobmanager；</li>
<li>Sink 连接器收到 barrier，保存当前状态，存入 Checkpoint，通知 Jobmanager，并开启下一阶段的事务 TX2，用于提交下个检查点前的数据；</li>
<li>Jobmanager 收到所有任务的通知，发出确认信息，表示 Checkpoint 完成；</li>
<li>Sink 任务收到 Jobmanager 的确认信息，正式提交这段时间的数据，即 TX1 的数据；</li>
<li>外部 Kafka 关闭事务 TX1，提交的数据可以正常消费了。</li>
<li><strong>注意：Kafka 事务默认超时时间 <code>transaction.timeout.ms</code> 设置为 60s，Checkpoint 设置的超时时间不能大于 Kafka 事务的超时时间，否则，可能当 Checkpoint 仍在尝试执行时，Kafka 事务已经到达超时时间关闭了，当 Checkpoint 正常执行完成时，Kafka 之前预提交的数据就会丢失。同时，Kafka 下游的消费者，需要设置隔离级别 <code>isolation.level</code> 为 <code>read_committed</code> (默认为 <code>read_uncommitted</code>），保证 Kafka 未提交的数据不能被消费。</strong></li>
</ul>
<h2 id="ProcessFunction-API-底层-API"><a href="#ProcessFunction-API-底层-API" class="headerlink" title="ProcessFunction API (底层 API)"></a>ProcessFunction API (底层 API)</h2><ul>
<li><p>之前学习的转换算子是无法访问事件的时间戳信息和水位线信息的。而这在一些应用场景下，极为重要。例如 MapFunction 这样的 map 转换算子就无法访问时间戳或者当前事件的事件时间。</p>
</li>
<li><p>基于此，DataStream API 提供了一系列的 Low-Level 转换算子。可以访问时间戳、Watermark 以及注册定时事件。还可以输出特定的一些事件，例如超时事件等。Process Function 用来构建事件驱动的应用以及实现自定义的业务逻辑 (使用之前的 Window 函数和转换算子无法实现)。例如，Flink SQL 就是使用 Process Function 实现的。</p>
</li>
<li><p>Flink 提供了 8 个 Process Function：</p>
<ul>
<li><p>ProcessFunction</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessFunction</span>&lt;<span class="title">I</span>, <span class="title">O</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractRichFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Process one element from the input stream.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This function can output zero or more elements using the &#123;<span class="doctag">@link</span> Collector&#125; parameter</span></span><br><span class="line"><span class="comment">    * and also update internal state or set timers using the &#123;<span class="doctag">@link</span> Context&#125; parameter.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value The input value.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ctx A &#123;<span class="doctag">@link</span> Context&#125; that allows querying the timestamp of the element and getting</span></span><br><span class="line"><span class="comment">    *            a &#123;<span class="doctag">@link</span> TimerService&#125; for registering timers and querying the time. The</span></span><br><span class="line"><span class="comment">    *            context is only valid during the invocation of this method, do not store it.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception This method may throw exceptions. Throwing an exception will cause the operation</span></span><br><span class="line"><span class="comment">    *                   to fail and may trigger recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// I：输入参数   ctx：上下文   O：输出类型</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(I value, Context ctx, Collector&lt;O&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called when a timer set using &#123;<span class="doctag">@link</span> TimerService&#125; fires.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timestamp The timestamp of the firing timer.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ctx An &#123;<span class="doctag">@link</span> OnTimerContext&#125; that allows querying the timestamp of the firing timer,</span></span><br><span class="line"><span class="comment">    *            querying the &#123;<span class="doctag">@link</span> TimeDomain&#125; of the firing timer and getting a</span></span><br><span class="line"><span class="comment">    *            &#123;<span class="doctag">@link</span> TimerService&#125; for registering timers and querying the time.</span></span><br><span class="line"><span class="comment">    *            The context is only valid during the invocation of this method, do not store it.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception This method may throw exceptions. Throwing an exception will cause the operation</span></span><br><span class="line"><span class="comment">    *                   to fail and may trigger recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;O&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Information available in an invocation of &#123;<span class="doctag">@link</span> #processElement(Object, Context, Collector)&#125;</span></span><br><span class="line"><span class="comment">    * or &#123;<span class="doctag">@link</span> #onTimer(long, OnTimerContext, Collector)&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Timestamp of the element currently being processed or timestamp of a firing timer.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;p&gt;This might be &#123;<span class="doctag">@code</span> null&#125;, for example if the time characteristic of your program</span></span><br><span class="line"><span class="comment">       * is set to &#123;<span class="doctag">@link</span> org.apache.flink.streaming.api.TimeCharacteristic#ProcessingTime&#125;.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Long <span class="title">timestamp</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * A &#123;<span class="doctag">@link</span> TimerService&#125; for querying time and registering timers.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> TimerService <span class="title">timerService</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Emits a record to the side output identified by the &#123;<span class="doctag">@link</span> OutputTag&#125;.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> outputTag the &#123;<span class="doctag">@code</span> OutputTag&#125; that identifies the side output to emit to.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> value The record to emit.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;X&gt; <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">(OutputTag&lt;X&gt; outputTag, X value)</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Information available in an invocation of &#123;<span class="doctag">@link</span> #onTimer(long, OnTimerContext, Collector)&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OnTimerContext</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * The &#123;<span class="doctag">@link</span> TimeDomain&#125; of the firing timer.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> TimeDomain <span class="title">timeDomain</span><span class="params">()</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>KeyedProcessFunction</p>
</li>
<li><p>CoProcessFunction</p>
</li>
<li><p>ProcessJoinFunction</p>
</li>
<li><p>BroadcastProcessFunction</p>
</li>
<li><p>KeyedBroadcastProcessFunction</p>
</li>
<li><p>ProcessWindowFunction</p>
</li>
<li><p>ProcessAllWindowFunction</p>
</li>
</ul>
</li>
</ul>
<h3 id="KeyedProcessFunction"><a href="#KeyedProcessFunction" class="headerlink" title="KeyedProcessFunction"></a>KeyedProcessFunction</h3><ul>
<li><p>这里重点介绍 KeyedProcessFunction。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A keyed function that processes elements of a stream.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For every element in the input stream &#123;<span class="doctag">@link</span> #processElement(Object, Context, Collector)&#125;</span></span><br><span class="line"><span class="comment"> * is invoked. This can produce zero or more elements as output. Implementations can also</span></span><br><span class="line"><span class="comment"> * query the time and set timers through the provided &#123;<span class="doctag">@link</span> Context&#125;. For firing timers</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #onTimer(long, OnTimerContext, Collector)&#125; will be invoked. This can again produce</span></span><br><span class="line"><span class="comment"> * zero or more elements as output and register further timers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; Access to keyed state and timers (which are also scoped to a key) is only</span></span><br><span class="line"><span class="comment"> * available if the &#123;<span class="doctag">@code</span> KeyedProcessFunction&#125; is applied on a &#123;<span class="doctag">@code</span> KeyedStream&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; A &#123;<span class="doctag">@code</span> KeyedProcessFunction&#125; is always a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.flink.api.common.functions.RichFunction&#125;. Therefore, access to the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.flink.api.common.functions.RuntimeContext&#125; is always available and setup and</span></span><br><span class="line"><span class="comment"> * teardown methods can be implemented. See</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.apache.flink.api.common.functions.RichFunction#open(org.apache.flink.configuration.Configuration)&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@link</span> org.apache.flink.api.common.functions.RichFunction#close()&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;K&gt; Type of the key.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;I&gt; Type of the input elements.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;O&gt; Type of the output elements.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PublicEvolving</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">K</span>, <span class="title">I</span>, <span class="title">O</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractRichFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Process one element from the input stream.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This function can output zero or more elements using the &#123;<span class="doctag">@link</span> Collector&#125; parameter</span></span><br><span class="line"><span class="comment">    * and also update internal state or set timers using the &#123;<span class="doctag">@link</span> Context&#125; parameter.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value The input value.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ctx A &#123;<span class="doctag">@link</span> Context&#125; that allows querying the timestamp of the element and getting</span></span><br><span class="line"><span class="comment">    *            a &#123;<span class="doctag">@link</span> TimerService&#125; for registering timers and querying the time. The</span></span><br><span class="line"><span class="comment">    *            context is only valid during the invocation of this method, do not store it.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception This method may throw exceptions. Throwing an exception will cause the operation</span></span><br><span class="line"><span class="comment">    *                   to fail and may trigger recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(I value, Context ctx, Collector&lt;O&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Called when a timer set using &#123;<span class="doctag">@link</span> TimerService&#125; fires.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> timestamp The timestamp of the firing timer.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ctx An &#123;<span class="doctag">@link</span> OnTimerContext&#125; that allows querying the timestamp, the &#123;<span class="doctag">@link</span> TimeDomain&#125;, and the key</span></span><br><span class="line"><span class="comment">    *            of the firing timer and getting a &#123;<span class="doctag">@link</span> TimerService&#125; for registering timers and querying the time.</span></span><br><span class="line"><span class="comment">    *            The context is only valid during the invocation of this method, do not store it.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception This method may throw exceptions. Throwing an exception will cause the operation</span></span><br><span class="line"><span class="comment">    *                   to fail and may trigger recovery.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="comment">// 定时操作</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;O&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Information available in an invocation of &#123;<span class="doctag">@link</span> #processElement(Object, Context, Collector)&#125;</span></span><br><span class="line"><span class="comment">    * or &#123;<span class="doctag">@link</span> #onTimer(long, OnTimerContext, Collector)&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Timestamp of the element currently being processed or timestamp of a firing timer.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * &lt;p&gt;This might be &#123;<span class="doctag">@code</span> null&#125;, for example if the time characteristic of your program</span></span><br><span class="line"><span class="comment">       * is set to &#123;<span class="doctag">@link</span> org.apache.flink.streaming.api.TimeCharacteristic#ProcessingTime&#125;.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Long <span class="title">timestamp</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * A &#123;<span class="doctag">@link</span> TimerService&#125; for querying time and registering timers.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> TimerService <span class="title">timerService</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Emits a record to the side output identified by the &#123;<span class="doctag">@link</span> OutputTag&#125;.</span></span><br><span class="line"><span class="comment">       *</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> outputTag the &#123;<span class="doctag">@code</span> OutputTag&#125; that identifies the side output to emit to.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> value The record to emit.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;X&gt; <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">(OutputTag&lt;X&gt; outputTag, X value)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Get key of the element being processed.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> K <span class="title">getCurrentKey</span><span class="params">()</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Information available in an invocation of &#123;<span class="doctag">@link</span> #onTimer(long, OnTimerContext, Collector)&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OnTimerContext</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * The &#123;<span class="doctag">@link</span> TimeDomain&#125; of the firing timer.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> TimeDomain <span class="title">timeDomain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Get key of the firing timer.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> K <span class="title">getCurrentKey</span><span class="params">()</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>KeyedProcessFunction 用来操作 KeyedStream。KeyedProcessFunction 会处理流的每一个元素，输出为 0 个、1 个或者多个元素。</p>
</li>
<li><p>所有的 Process Function 都继承自RichFunction 接口，所以都有 <code>open()</code>、<code>close()</code> 和 <code>getRuntimeContext()</code> 等方法。而 <code>KeyedProcessFunction&lt;K, I, O&gt;</code> 还额外提供了两个方法:</p>
<ul>
<li><code>processElement(I value, Context ctx, Collector&lt;O&gt; out)</code>：流中的每一个元素都会调用这个方法，调用结果将会放在 Collector 数据类型中输出。Context 可以访问元素的时间戳，元素的 key，以及 TimerService 时间服务。Context 还可以将结果输出到别的流 (side outputs)。</li>
<li><code>onTimer(long timestamp, OnTimerContext ctx, Collector&lt;O&gt; out)</code>：是一个回调函数。当之前注册的定时器触发时调用。参数 timestamp 为定时器所设定的触发的时间戳。Collector 为输出结果的集合。OnTimerContext 和 <code>processElement()</code> 的 Context 参数一样，提供了上下文的一些信息，例如定时器触发的时间信息 (事件时间或者处理时间)。</li>
<li>Context 和 OnTimerContext 所持有的 TimerService 对象拥有以下方法：<ul>
<li><code>long currentProcessingTime()</code>：返回当前处理时间。</li>
<li><code>long currentWatermark()</code>：返回当前 Watermark 的时间戳。</li>
<li><code>void registerProcessingTimeTimer(long timestamp)</code>：会注册当前 key 的 Processing Time 的定时器。当 Processing Time 到达定时时间时，触发 timer。<ul>
<li>当定时器 timer 触发时，会执行回调函数 <code>onTimer()</code>。注意定时器 timer 只能在 keyed streams 上面使用。</li>
</ul>
</li>
<li><code>void registerEventTimeTimer(long timestamp)</code>：会注册当前 key 的 Event Time 定时器。当 Watetmark 大于等于定时器注册的时间时，触发定时器执行回调函数 <code>onTimer()</code>。</li>
<li><code>void deleteProcessingTimeTimer(long timestamp)</code>：删除之前注册处理时间定时器。如果没有这个时间戳的定时器，则不执行。</li>
<li><code>void deleteEventTimeTimer(long timestamp)</code>：删除之前注册的事件时间定时器。如果没有此时间戳的定时器，则不执行。</li>
</ul>
</li>
</ul>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessTest1_KeyedProcessFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.测试KeyedProcessFunction，先分组然后自定义处理</span></span><br><span class="line">        dataStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .process(<span class="keyword">new</span> MyProcess())</span><br><span class="line">                .print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的处理函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">Tuple</span>, <span class="title">SensorReading</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ValueState&lt;Long&gt; tsTimerState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            tsTimerState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Long&gt;(<span class="string">&quot;ts-timer&quot;</span>, Long.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(SensorReading sensorReading, Context ctx, Collector&lt;Integer&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            out.collect(sensorReading.getId().length());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Context的使用</span></span><br><span class="line">            <span class="comment">// 1.获取时间戳</span></span><br><span class="line">            ctx.timestamp();</span><br><span class="line">            <span class="comment">// 2.获取当前key</span></span><br><span class="line">            ctx.getCurrentKey();</span><br><span class="line">            <span class="comment">// 3.按需将满足某条件的数据输出到侧输出流</span></span><br><span class="line">            OutputTag&lt;Double&gt; outputTag = <span class="keyword">new</span> OutputTag&lt;Double&gt;(<span class="string">&quot;temp&quot;</span>) &#123;</span><br><span class="line">            &#125;;</span><br><span class="line">            ctx.output(outputTag, sensorReading.getTemperature());</span><br><span class="line">            <span class="comment">// 4.定时服务</span></span><br><span class="line">            ctx.timerService().currentProcessingTime();<span class="comment">// 获取当前Processing Time</span></span><br><span class="line">            ctx.timerService().currentWatermark();<span class="comment">// 获取当前Watermark</span></span><br><span class="line">            <span class="comment">// 注册Processing Time定时器，参数是要触发时的时间。从1970年1月1日开始的毫秒数，即当前时间基础上延迟1s</span></span><br><span class="line">            ctx.timerService().registerProcessingTimeTimer(ctx.timerService().currentProcessingTime() + <span class="number">1000L</span>);</span><br><span class="line">            <span class="comment">// 保存定时器指定的触发时间状态</span></span><br><span class="line">            tsTimerState.update(ctx.timerService().currentProcessingTime() + <span class="number">1000L</span>);</span><br><span class="line">            <span class="comment">// 注册Event Time定时器，参数是要触发时的时间。在当前参数时间戳基础上延迟10s</span></span><br><span class="line">            ctx.timerService().registerEventTimeTimer((sensorReading.getTimestamp() + <span class="number">10</span>) * <span class="number">1000L</span>);</span><br><span class="line">            <span class="comment">// 取消注册的Processing Time定时器，以定时器设定的时间区分</span></span><br><span class="line">            ctx.timerService().deleteProcessingTimeTimer(ctx.timerService().currentProcessingTime() + <span class="number">1000L</span>);</span><br><span class="line">            <span class="comment">// 删除定时器的操作，可能在定义定时器时间一段时间之后才执行，因此，保存定时器定义时的状态，然后在后续删除时取出这个状态</span></span><br><span class="line">            ctx.timerService().deleteProcessingTimeTimer(tsTimerState.value());</span><br><span class="line">            <span class="comment">// 取消注册的Event Time定时器，以定时器设定的时间区分</span></span><br><span class="line">            ctx.timerService().deleteEventTimeTimer((sensorReading.getTimestamp() + <span class="number">10</span>) * <span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定时器触发时执行的方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;Integer&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// timestamp即为触发的定时器的时间</span></span><br><span class="line">            System.out.println(timestamp + <span class="string">&quot;定时器触发&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ctx和out用法与processElement()类似，ctx多了下面这个方法</span></span><br><span class="line">            <span class="comment">// 获取当前的时间语义，PROCESSING_TIME或EVENT_TIME</span></span><br><span class="line">            ctx.timeDomain();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            tsTimerState.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例：监控温度传感器的温度值，如果温度值在 10 秒钟之内 (Processing Time) 连续上升，则报警。</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessTest2_ApplicationCase</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.测试KeyedProcessFunction，先分组然后自定义处理</span></span><br><span class="line">        dataStream.keyBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .process(<span class="keyword">new</span> TempConsIncreWarning(<span class="number">10</span>))</span><br><span class="line">                .print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义处理函数，检测一段时间内的温度连续上升，输出报警</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TempConsIncreWarning</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>&lt;<span class="title">Tuple</span>, <span class="title">SensorReading</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义私有属性，当前统计的时间间隔</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Integer interval;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TempConsIncreWarning</span><span class="params">(Integer interval)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.interval = interval;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义状态，保存上一次的温度值和定时器时间戳</span></span><br><span class="line">        <span class="keyword">private</span> ValueState&lt;Double&gt; lastTempState;</span><br><span class="line">        <span class="keyword">private</span> ValueState&lt;Long&gt; timerTsState;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            lastTempState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Double&gt;(<span class="string">&quot;last-temp&quot;</span>, Double.class));</span><br><span class="line">            timerTsState = getRuntimeContext().getState(<span class="keyword">new</span> ValueStateDescriptor&lt;Long&gt;(<span class="string">&quot;timer-ts&quot;</span>, Long.class));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(SensorReading value, Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 取出状态</span></span><br><span class="line">            Double lastTemp = lastTempState.value();</span><br><span class="line">            <span class="keyword">if</span> (lastTemp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Long timerTs = timerTsState.value();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果温度出现上升并且没有定时器，注册10秒后触发的定时器，开始等待</span></span><br><span class="line">                <span class="comment">// 之后的温度如果仍在上升，则不需要额外处理，等待定时器触发即可</span></span><br><span class="line">                <span class="keyword">if</span> (value.getTemperature() &gt; lastTemp &amp;&amp; timerTs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 计算定时器触发的时间戳，注意是执行操作算子的本地系统时间，10s时间很快</span></span><br><span class="line">                    <span class="keyword">long</span> ts = ctx.timerService().currentProcessingTime() + interval * <span class="number">1000L</span>;</span><br><span class="line">                    <span class="comment">// 注册定时器</span></span><br><span class="line">                    ctx.timerService().registerProcessingTimeTimer(ts);</span><br><span class="line">                    <span class="comment">// 保存定时器触发的时间戳，用于删除</span></span><br><span class="line">                    timerTsState.update(ts);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.getTemperature() &lt;= lastTemp &amp;&amp; timerTs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果温度下降，那么删除定时器</span></span><br><span class="line">                    ctx.timerService().deleteProcessingTimeTimer(timerTs);</span><br><span class="line">                    timerTsState.clear();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新温度状态</span></span><br><span class="line">            lastTempState.update(value.getTemperature());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimer</span><span class="params">(<span class="keyword">long</span> timestamp, OnTimerContext ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// 如果触发了定时器，说明10s内温度连续上升，输出报警信息</span></span><br><span class="line">            out.collect(<span class="string">&quot;传感器&quot;</span> + ctx.getCurrentKey().getField(<span class="number">0</span>) + <span class="string">&quot;的温度值&quot;</span> + interval + <span class="string">&quot;s内连续秒上升&quot;</span>);</span><br><span class="line">            <span class="comment">// 触发定时器后，清空</span></span><br><span class="line">            timerTsState.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            lastTempState.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP<span class="literal">-OM8IACS</span>:/mnt/c/Users/Ziyoo<span class="variable">$</span> nc <span class="literal">-lk</span> <span class="number">7777</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">36.7</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">37.2</span></span><br><span class="line">sensor_6,<span class="number">1547718199</span>,<span class="number">36.7</span></span><br><span class="line">sensor_6,<span class="number">1547718199</span>,<span class="number">35.7</span></span><br><span class="line">sensor_6,<span class="number">1547718199</span>,<span class="number">34.7</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>sensor_1 报警信息是从 35 度开始计算的，sensor_6 不会报警。</p>
</blockquote>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">5&gt; 传感器sensor_1温度值10s内连续秒上升</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="侧输出流-SideOutput"><a href="#侧输出流-SideOutput" class="headerlink" title="侧输出流 (SideOutput)"></a>侧输出流 (SideOutput)</h3><ul>
<li><p>大部分的 DataStream API 的算子的输出是单一输出，也就是某种数据类型的流。除了 split 算子，可以将一条流分成多条流，但这些流的数据类型也都相同。ProcessFunction 的 side outputs 功能可以产生多条流，并且这些流的数据类型可以不一样。一个 side output 可以定义为 OutputTag[X] 对象，X 是输出流的数据类型。ProcessFunction 可以通过 Context 对象发射一个事件到一个或者多个 side outputs。</p>
</li>
<li><p>实例：监控传感器温度值，将温度值低于 30 度的数据输出到 side output。</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessTest3_SideOuptCase</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.从Scoket文本流读取数据</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将文件内容转换成SensorReading对象</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个OutputTag，用来表示侧输出流低温流</span></span><br><span class="line">        OutputTag&lt;SensorReading&gt; lowTempTag = <span class="keyword">new</span> OutputTag&lt;SensorReading&gt;(<span class="string">&quot;lowTemp&quot;</span>) &#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.测试ProcessFunction，自定义侧输出流实现分流操作</span></span><br><span class="line">        SingleOutputStreamOperator&lt;SensorReading&gt; highTempStream = dataStream.process(<span class="keyword">new</span> ProcessFunction&lt;SensorReading, SensorReading&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(SensorReading sensorReading, Context ctx, Collector&lt;SensorReading&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 判断温度，大于30度，高温流输出到主流；小于低温流输出到侧输出流</span></span><br><span class="line">                <span class="keyword">if</span> (sensorReading.getTemperature() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                    out.collect(sensorReading);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ctx.output(lowTempTag, sensorReading);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印</span></span><br><span class="line">        highTempStream.print(<span class="string">&quot;high-temp&quot;</span>);</span><br><span class="line">        highTempStream.getSideOutput(lowTempTag).print(<span class="string">&quot;low-temp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xisun@DESKTOP<span class="literal">-OM8IACS</span>:/mnt/c/Users/Ziyoo<span class="variable">$</span> nc <span class="literal">-lk</span> <span class="number">7777</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">28.7</span></span><br><span class="line">sensor_6,<span class="number">1547718213</span>,<span class="number">15.3</span></span><br><span class="line">sensor_10,<span class="number">1547718213</span>,<span class="number">38.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.ClosureCleaner)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">high-temp:2&gt; SensorReading</span>&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">35.8</span>&#125;</span><br><span class="line">low-temp:<span class="number">3</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_1&#x27;</span>, timestamp=<span class="number">1547718199</span>, temperature=<span class="number">28.7</span>&#125;</span><br><span class="line">low-temp:<span class="number">4</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_6&#x27;</span>, timestamp=<span class="number">1547718213</span>, temperature=<span class="number">15.3</span>&#125;</span><br><span class="line">high-temp:<span class="number">5</span>&gt; SensorReading&#123;id=<span class="string">&#x27;sensor_10&#x27;</span>, timestamp=<span class="number">1547718213</span>, temperature=<span class="number">38.3</span>&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>与 id 无关，来一条数据判断一次，然后输出结果。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="CoProcessFunction"><a href="#CoProcessFunction" class="headerlink" title="CoProcessFunction"></a>CoProcessFunction</h3><ul>
<li>对于两条输入流，DataStream API 提供了 CoProcessFunction 这样的 low-level 操作。CoProcessFunction 提供了操作每一个输入流的方法：<code>processElement1()</code> 和 <code>processElement2()</code>。</li>
<li>类似于 ProcessFunction，这两种方法都通过 Context 对象来调用。这个 Context 对象可以访问事件数据，定时器时间戳，TimerService，以及 side outputs。CoProcessFunction 也提供了 <code>onTimer()</code> 回调函数。</li>
</ul>
<h2 id="Table-API-与-SQL"><a href="#Table-API-与-SQL" class="headerlink" title="Table API 与 SQL"></a>Table API 与 SQL</h2><ul>
<li>说明：本章节示例的很多方法已过时，此处只做学习用，具体使用时再做更改。</li>
</ul>
<h3 id="Table-API-和-Flink-SQL-是什么"><a href="#Table-API-和-Flink-SQL-是什么" class="headerlink" title="Table API 和 Flink SQL 是什么"></a>Table API 和 Flink SQL 是什么</h3><ul>
<li><p>Flink 对批处理和流处理，提供了统一的上层 API。</p>
<p><img src="/2021/04/25/flink/image-20210817114056535.png" alt="image-20210817114056535"></p>
</li>
<li><p>Table API 是一套内嵌在 Java 和 Scala 语言中的查询 API，它允许以非常直观的方式组合来自一些关系运算符的查询。</p>
</li>
<li><p>Flink 的 SQL 支持基于实现了 SQL 标准的 Apache Calcite。</p>
</li>
<li><p>Table API 是流处理和批处理通用的关系型 API，Table API 可以基于流输入或者批输入来运行而不需要进行任何修改。Table API 是 SQL 语言的超集并专门为 Apache Flink 设计的，Table API 是 Scala 和 Java 语言集成式的 API。与常规 SQL 语言中将查询指定为字符串不同，Table API 查询是以 Java 或 Scala 中的语言嵌入样式来定义的，具有 IDE 支持如自动完成和语法检测。</p>
</li>
<li><p>Maven 引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner-blink_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/25/flink/image-20210817164421379.png" alt="image-20210817164421379"></p>
</li>
<li><p>实例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest1_Example</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.读取数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.转换成POJO</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.基于流创建一张表，表中的字段就是SensorReading的属性</span></span><br><span class="line">        Table dataTable = tableEnv.fromDataStream(dataStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-1.调用Table API进行转换操作，选取表中指定数据</span></span><br><span class="line">        Table resultTable = dataTable.select(<span class="string">&quot;id, temperature&quot;</span>)</span><br><span class="line">                .where(<span class="string">&quot;id = &#x27;sensor_1&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-2.执行SQL进行查询操作，这种方式与用Table API是等价的</span></span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, dataTable);<span class="comment">// 需要先将表注册，sensor就是表明</span></span><br><span class="line">        String sql = <span class="string">&quot;select id, temperature from sensor where id = &#x27;sensor_1&#x27;&quot;</span>;<span class="comment">// 从注册的表中查询</span></span><br><span class="line">        Table resultSqlTable = tableEnv.sqlQuery(sql);<span class="comment">// 执行sql</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.将6-1和6-2的结果转换成流，然后打印</span></span><br><span class="line">        <span class="comment">// Row.class，org.apache.flink.types.Row，指定查询的结果按行输出</span></span><br><span class="line">        <span class="comment">// 也可以使用自定义的类，如SensorReading.class，但要求该类是public的，且查询的结果和类的属性要能对应</span></span><br><span class="line">        tableEnv.toAppendStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toAppendStream(resultSqlTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">result&gt; sensor_1,35.8</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,35.8</span></span><br><span class="line"><span class="function">result&gt; sensor_1,36.3</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,36.3</span></span><br><span class="line"><span class="function">result&gt; sensor_1,34.7</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,34.7</span></span><br><span class="line"><span class="function">result&gt; sensor_1,33.1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,33.1</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="程序实现的基本结构"><a href="#程序实现的基本结构" class="headerlink" title="程序实现的基本结构"></a>程序实现的基本结构</h3><ul>
<li><p>Table API 和 SQL 的程序结构，与流式处理的程序结构十分类似：</p>
<img src="/2021/04/25/flink/image-20210817165913353.png" alt="image-20210817165913353" style="zoom:80%;">

</li>
</ul>
<h3 id="不同类型-TableEnvironment-的创建"><a href="#不同类型-TableEnvironment-的创建" class="headerlink" title="不同类型 TableEnvironment 的创建"></a>不同类型 TableEnvironment 的创建</h3><ul>
<li><p>TableEnvironment 是 Flink 中集成 Table API 和 SQL 的核心概念，所有对表的操作都基于 TableEnvironment：</p>
<ul>
<li>注册 Catalog。</li>
<li>在 Catalog 中注册表。</li>
<li>执行 SQL 查询。</li>
<li>注册用户自定义函数 (UDF)。</li>
</ul>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest2_CreateTableEnv</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建表处理环境，Flink 1.11版本之前，默认使用老版本planner，1.11版本及之后，默认使用Blink版本</span></span><br><span class="line">        <span class="comment">// 因此，可以自行添加配置，创建所需要的环境版本</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.不同版本环境的创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-1.基于老版本planner的流处理</span></span><br><span class="line">        EnvironmentSettings oldStreamSettings = EnvironmentSettings.newInstance()</span><br><span class="line">                .useOldPlanner()<span class="comment">// 老版本</span></span><br><span class="line">                .inStreamingMode()<span class="comment">// 流式处理</span></span><br><span class="line">                .build();</span><br><span class="line">        StreamTableEnvironment oldStreamTableEnv = StreamTableEnvironment.create(env, oldStreamSettings);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-2.基于老版本planner的批处理</span></span><br><span class="line">        ExecutionEnvironment batchEnv = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        BatchTableEnvironment oldBatchTableEnv = BatchTableEnvironment.create(batchEnv);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-3.基于Blink的流处理(即新版本)</span></span><br><span class="line">        EnvironmentSettings blinkStreamSettings = EnvironmentSettings.newInstance()</span><br><span class="line">                .useBlinkPlanner()<span class="comment">// 新版本</span></span><br><span class="line">                .inStreamingMode()<span class="comment">// 流式处理</span></span><br><span class="line">                .build();</span><br><span class="line">        StreamTableEnvironment blinkStreamTableEnv = StreamTableEnvironment.create(env, blinkStreamSettings);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-4.基于Blink的批处理(即新版本)</span></span><br><span class="line">        EnvironmentSettings blinkBatchSettings = EnvironmentSettings.newInstance()</span><br><span class="line">                .useBlinkPlanner()<span class="comment">// 新版本</span></span><br><span class="line">                .inBatchMode()<span class="comment">// 批处理</span></span><br><span class="line">                .build();</span><br><span class="line">        TableEnvironment blinkBatchTableEnv = TableEnvironment.create(blinkBatchSettings);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="表-Table"><a href="#表-Table" class="headerlink" title="表 (Table)"></a>表 (Table)</h3><ul>
<li>TableEnvironment 可以注册目录 Catalog，并可以基于 Catalog 注册表。</li>
<li>表 (Table) 是由一个 “标识符” (identifier) 来指定的，由 3 部分组成：Catalog 名、数据库 (database) 名和对象名。<ul>
<li>Catalog 名、数据库 (database) 名如果不指定，默认为 defaultCatalog 和 defaultDatabase。</li>
</ul>
</li>
<li>表可以是常规的，也可以是虚拟的 (视图，View)。<ul>
<li>连接到外部系统 (比如 Kafka) 的叫常规表，如果是 Flink 程序转换过程中临时创建的，是虚拟表。</li>
</ul>
</li>
<li>常规表 (Table) 一般可以用来描述外部数据，比如文件、数据库表或消息队列的数据，也可以直接从 DataStream 转换而来。</li>
<li>视图 (View) 可以从现有的表中创建，通常是 Table API 或者 SQL 查询的一个结果集。</li>
</ul>
<h4 id="更新模式"><a href="#更新模式" class="headerlink" title="更新模式"></a>更新模式</h4><ul>
<li>对于流式查询，需要声明如何在表和外部连接器之间执行转换。</li>
<li>与外部系统交换的消息类型，由更新模式 (Update Mode) 指定：<ul>
<li>追加 (Append) 模式<ul>
<li>表只做插入操作，和外部连接器只交换插入 (Insert) 消息。</li>
</ul>
</li>
<li>撤回 (Retract) 模式<ul>
<li>表和外部连接器交换添加 (Add) 和撤回 (Retract) 消息。</li>
<li>插入操作 (Insert) 编码为 Add 消息；删除操作 (Delete) 编码为 Retract 消息；更新操作 (Update) 编码为上一条的 Retract 消息和下一条的 Add 消息。</li>
</ul>
</li>
<li>更新插入 (Upsert) 模式<ul>
<li>更新和插入操作都被编码为 Upsert 消息 (需要指定 key，key 存在为更新操作，不存在为插入操作)；删除操作编码为 Delete 消息。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="从文件创建表"><a href="#从文件创建表" class="headerlink" title="从文件创建表"></a>从文件创建表</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest3_CommonApi</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.表的创建：连接外部系统，读取数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-1.读取外部文件创建表</span></span><br><span class="line">        String inputPath = <span class="string">&quot;src/main/resources/sensor.txt&quot;</span>;</span><br><span class="line">        tableEnv.connect(<span class="keyword">new</span> FileSystem().path(inputPath))<span class="comment">// 连接器的描述器</span></span><br><span class="line">                .withFormat(<span class="keyword">new</span> Csv())<span class="comment">// 格式化，也可以是json</span></span><br><span class="line">                .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                        .field(<span class="string">&quot;timestamp&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">                        .field(<span class="string">&quot;temp&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">                )<span class="comment">// 定义表结构，参考数据库表结构的定义，注意：表结构的顺序，应和文件内字段顺序一一对应，字段名可以不相同</span></span><br><span class="line">                .createTemporaryTable(<span class="string">&quot;inputTable&quot;</span>);<span class="comment">// 注册表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-2.获取注册的表</span></span><br><span class="line">        Table inputTable = tableEnv.from(<span class="string">&quot;inputTable&quot;</span>);</span><br><span class="line">        inputTable.printSchema();<span class="comment">// 打印表结构</span></span><br><span class="line">        tableEnv.toAppendStream(inputTable, Row.class).print();<span class="comment">// 打印表数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.查询转换</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-1.Table API的操作</span></span><br><span class="line">        <span class="comment">// 简单转换</span></span><br><span class="line">        Table resultTable = inputTable.select(<span class="string">&quot;id, temp&quot;</span>)<span class="comment">// 查询id和temp字段</span></span><br><span class="line">                .filter(<span class="string">&quot;id === &#x27;sensor_6&#x27;&quot;</span>);<span class="comment">// 查询id为sensor_6的数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 聚合统计</span></span><br><span class="line">        Table aggTable = inputTable.groupBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, id.count as count, temp.avg as avgTemp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-2.SQL的操作</span></span><br><span class="line">        tableEnv.sqlQuery(<span class="string">&quot;select id, temp from inputTable where id = &#x27;senosr_6&#x27;&quot;</span>);</span><br><span class="line">        Table sqlAggTable = tableEnv.sqlQuery(<span class="string">&quot;select id, count(id) as cnt, avg(temp) as avgTemp from inputTable group by id&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.打印输出</span></span><br><span class="line">        tableEnv.toAppendStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);<span class="comment">// 来一条数据，resultTable追加一条数据</span></span><br><span class="line">        tableEnv.toRetractStream(aggTable, Row.class).print(<span class="string">&quot;agg&quot;</span>);<span class="comment">// 来一条数据，aggTable更新一次结果</span></span><br><span class="line">        tableEnv.toRetractStream(sqlAggTable, Row.class).print(<span class="string">&quot;sqlagg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Csv (<code>org.apache.flink.table.descriptors.Csv</code>) 需要添加依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新版本CSV支持 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;flink-csv&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Table API 是集成在 Scala 和 Java 语言内的查询 API。</p>
<ul>
<li>Table API 基于代表 “表” 的 Table 类，并提供一整套操作处理的方法 API；这些方法会返回一个新的 Table 对象，表示对输入表应用转换操作的结果。</li>
<li>有些关系型转换操作，可以由多个方法调用组成，构成链式调用结构。</li>
</ul>
</li>
<li><p>Flink 的 SQL 集成，基于实现 了SQL 标准的 Apache Calcite。</p>
<ul>
<li>在 Flink 中，用常规字符串来定义 SQL 查询语句。</li>
<li>SQL 查询的结果，也是一个新的 Table。</li>
</ul>
</li>
</ul>
</li>
<li><p>输入文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>src/main/resources/sensor.txt</code></p>
</blockquote>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line"> |-- id: STRING</span><br><span class="line"> |-- timestamp: BIGINT</span><br><span class="line"> |-- temp: DOUBLE</span><br><span class="line"></span><br><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">sensor_1,1547718199,35.8</span></span><br><span class="line"><span class="function">sensor_6,1547718201,15.4</span></span><br><span class="line"><span class="function">sensor_7,1547718202,6.7</span></span><br><span class="line"><span class="function">sensor_10,1547718205,38.1</span></span><br><span class="line"><span class="function">result&gt; sensor_6,15.4</span></span><br><span class="line"><span class="function">sensor_1,1547718206,36.3</span></span><br><span class="line"><span class="function">sensor_1,1547718210,34.7</span></span><br><span class="line"><span class="function">result&gt; sensor_6,15.3</span></span><br><span class="line"><span class="function">sensor_1,1547718212,33.1</span></span><br><span class="line"><span class="function">sensor_6,1547718212,15.3</span></span><br><span class="line"><span class="function">sensor_7,1547718212,6.3</span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_10,<span class="number">1</span>,<span class="number">38.1</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_10,<span class="number">1</span>,<span class="number">38.1</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">4</span>,<span class="number">34.975</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">false</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">2</span>,<span class="number">15.350000000000001</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">4</span>,<span class="number">34.975</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">false</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">false</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">sqlagg&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">2</span>,<span class="number">6.5</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">2</span>,<span class="number">15.350000000000001</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">false</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">agg&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">2</span>,<span class="number">6.5</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>表结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line"> |-- id: STRING</span><br><span class="line"> |-- timestamp: BIGINT</span><br><span class="line"> |-- temp: DOUBLE</span><br></pre></td></tr></table></figure>
</li>
<li><p>表数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,<span class="number">1547718199</span>,<span class="number">35.8</span></span><br><span class="line">sensor_6,<span class="number">1547718201</span>,<span class="number">15.4</span></span><br><span class="line">sensor_7,<span class="number">1547718202</span>,<span class="number">6.7</span></span><br><span class="line">sensor_10,<span class="number">1547718205</span>,<span class="number">38.1</span></span><br><span class="line">sensor_1,<span class="number">1547718206</span>,<span class="number">36.3</span></span><br><span class="line">sensor_1,<span class="number">1547718210</span>,<span class="number">34.7</span></span><br><span class="line">sensor_1,<span class="number">1547718212</span>,<span class="number">33.1</span></span><br><span class="line">sensor_6,<span class="number">1547718212</span>,<span class="number">15.3</span></span><br><span class="line">sensor_7,<span class="number">1547718212</span>,<span class="number">6.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>resultTable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result&gt; sensor_6,<span class="number">15.4</span></span><br><span class="line">result&gt; sensor_6,<span class="number">15.3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>aggTable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_10,<span class="number">1</span>,<span class="number">38.1</span>)</span><br><span class="line">agg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)	<span class="comment">// 2表示的是当前id数据的个数</span></span><br><span class="line">agg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span><br><span class="line">agg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">4</span>,<span class="number">34.975</span>)</span><br><span class="line">agg&gt; (<span class="keyword">false</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_6,<span class="number">2</span>,<span class="number">15.350000000000001</span>)</span><br><span class="line">agg&gt; (<span class="keyword">false</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span><br><span class="line">agg&gt; (<span class="keyword">true</span>,sensor_7,<span class="number">2</span>,<span class="number">6.5</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看出：对于同一个 id，来一条新数据时，会做一次聚合操作，并撤销前一次的聚合结果 (如 <code>agg&gt; (false,sensor_1,1,35.8)</code>)，再添加聚合后的新结果 (如 <code>agg&gt; (true,sensor_1,2,36.05)</code>)。聚合操作是把新数据的温度值，与之前的聚合结果重新聚合 (此处是取平均值)。</li>
</ul>
</li>
<li><p>sqlAggTable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_10,<span class="number">1</span>,<span class="number">38.1</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">1</span>,<span class="number">35.8</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">2</span>,<span class="number">36.05</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">false</span>,sensor_1,<span class="number">3</span>,<span class="number">35.6</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_1,<span class="number">4</span>,<span class="number">34.975</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">false</span>,sensor_6,<span class="number">1</span>,<span class="number">15.4</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_6,<span class="number">2</span>,<span class="number">15.350000000000001</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">false</span>,sensor_7,<span class="number">1</span>,<span class="number">6.7</span>)</span><br><span class="line">sqlagg&gt; (<span class="keyword">true</span>,sensor_7,<span class="number">2</span>,<span class="number">6.5</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>sqlAggTable 与 aggTable 效果一样。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="输出表到文件"><a href="#输出表到文件" class="headerlink" title="输出表到文件"></a>输出表到文件</h4><ul>
<li><p>表的输出，是通过将数据写入 TableSink 来实现的。</p>
</li>
<li><p>TableSink 是一个通用接口，可以支持不同的文件格式、存储数据库和消息队列。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest4_FileOutput</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.表的创建：连接外部系统，读取数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-1.读取外部文件创建表</span></span><br><span class="line">        String inputPath = <span class="string">&quot;src/main/resources/sensor.txt&quot;</span>;</span><br><span class="line">        tableEnv.connect(<span class="keyword">new</span> FileSystem().path(inputPath))<span class="comment">// 连接器的描述器</span></span><br><span class="line">                .withFormat(<span class="keyword">new</span> Csv())<span class="comment">// 格式化，也可以是json</span></span><br><span class="line">                .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                        .field(<span class="string">&quot;timestamp&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">                        .field(<span class="string">&quot;temp&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">                )<span class="comment">// 定义表结构，参考数据库表结构的定义，注意：表结构的顺序，应和文件内字段顺序一一对应</span></span><br><span class="line">                .createTemporaryTable(<span class="string">&quot;inputTable&quot;</span>);<span class="comment">// 注册表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-2.获取注册的表</span></span><br><span class="line">        Table inputTable = tableEnv.from(<span class="string">&quot;inputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.查询转换</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-1.Table API的操作</span></span><br><span class="line">        <span class="comment">// 简单转换</span></span><br><span class="line">        Table resultTable = inputTable.select(<span class="string">&quot;id, temp&quot;</span>)<span class="comment">// 查询id和temp字段</span></span><br><span class="line">                .filter(<span class="string">&quot;id === &#x27;sensor_6&#x27;&quot;</span>);<span class="comment">// 查询id为sensor_6的数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 聚合统计</span></span><br><span class="line">        Table aggTable = inputTable.groupBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, id.count as count, temp.avg as avgTemp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-2.SQL的操作</span></span><br><span class="line">        tableEnv.sqlQuery(<span class="string">&quot;select id, temp from inputTable where id = &#x27;senosr_6&#x27;&quot;</span>);</span><br><span class="line">        Table sqlAggTable = tableEnv.sqlQuery(<span class="string">&quot;select id, count(id) as cnt, avg(temp) as avgTemp from inputTable group by id&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.输出到文件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5-1.连接外部文件，注册输出表</span></span><br><span class="line">        String outputPath = <span class="string">&quot;src/main/resources/out.txt&quot;</span>;</span><br><span class="line">        tableEnv.connect(<span class="keyword">new</span> FileSystem().path(outputPath))<span class="comment">// 连接器的描述器</span></span><br><span class="line">                .withFormat(<span class="keyword">new</span> Csv())<span class="comment">// 格式化</span></span><br><span class="line">                .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                        .field(<span class="string">&quot;temperature&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">                )<span class="comment">// 定义表结构，注意：表结构的内容，应和前面创建的表的字段的顺序一一对应，字段名可以不相同</span></span><br><span class="line">                .createTemporaryTable(<span class="string">&quot;outputTable&quot;</span>);<span class="comment">// 注册表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5-2.写出到外部文件</span></span><br><span class="line">        <span class="comment">// 注意：aggTable或sqlAggTable不支持往外部文件写入，因为外部文件写入只能追加数据，</span></span><br><span class="line">        <span class="comment">// 而aggTable或sqlAggTable存在数据更新，无法操控文件把旧数据删除再更新为新数据</span></span><br><span class="line">        resultTable.executeInsert(<span class="string">&quot;outputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务，使用executeInsert()后，不需要再次执行execute()</span></span><br><span class="line">        <span class="comment">// env.execute();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>src/main/resources/sensor.txt</code></p>
</blockquote>
</li>
<li><p>输出文件：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sensor_6,15.4</span><br><span class="line">sensor_6,15.3</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>src/main/resources/out.txt</code></p>
</blockquote>
</li>
</ul>
<h4 id="对接-Kafka"><a href="#对接-Kafka" class="headerlink" title="对接 Kafka"></a>对接 Kafka</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest4_KafkaPipeLine</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.连接Kafka，读取数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-1.创建表</span></span><br><span class="line">        tableEnv</span><br><span class="line">                .connect(<span class="keyword">new</span> Kafka()</span><br><span class="line">                        .version(<span class="string">&quot;2.3&quot;</span>)</span><br><span class="line">                        .topic(<span class="string">&quot;sensor&quot;</span>)</span><br><span class="line">                        .property(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="string">&quot;localhost:2181&quot;</span>)</span><br><span class="line">                        .property(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .withFormat(<span class="keyword">new</span> Csv())</span><br><span class="line">                .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                        .field(<span class="string">&quot;timestamp&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">                        .field(<span class="string">&quot;temp&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">                )</span><br><span class="line">                .createTemporaryTable(<span class="string">&quot;inputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3-2.获取注册的表</span></span><br><span class="line">        Table sensorTable = tableEnv.from(<span class="string">&quot;inputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.查询转换</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-1.简单转换</span></span><br><span class="line">        Table resultTable = sensorTable.select(<span class="string">&quot;id, temp&quot;</span>)</span><br><span class="line">                .filter(<span class="string">&quot;id === &#x27;sensor_6&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4-2.聚合统计</span></span><br><span class="line">        Table aggTable = sensorTable.groupBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, id.count as count, temp.avg as avgTemp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.建立Kafka连接，输出到不同的topic下</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5-1.创建表</span></span><br><span class="line">        tableEnv</span><br><span class="line">                .connect(<span class="keyword">new</span> Kafka()</span><br><span class="line">                        .version(<span class="string">&quot;2.3&quot;</span>)</span><br><span class="line">                        .topic(<span class="string">&quot;sinkTest&quot;</span>)</span><br><span class="line">                        .property(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="string">&quot;localhost:2181&quot;</span>)</span><br><span class="line">                        .property(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .withFormat(<span class="keyword">new</span> Csv())</span><br><span class="line">                .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                        .field(<span class="string">&quot;temp&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">                )</span><br><span class="line">                .createTemporaryTable(<span class="string">&quot;outputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5-2.输出到Kafka</span></span><br><span class="line">        <span class="comment">// 注意：aggTable或sqlAggTable也不支持往Kafka写入</span></span><br><span class="line">        resultTable.executeInsert(<span class="string">&quot;outputTable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="对接-ES"><a href="#对接-ES" class="headerlink" title="对接 ES"></a>对接 ES</h4><ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">tableEnv</span><br><span class="line">        .connect(</span><br><span class="line">                <span class="keyword">new</span> Elasticsearch()</span><br><span class="line">                        .version(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">                        .host(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)</span><br><span class="line">                        .index(<span class="string">&quot;sensor&quot;</span>)</span><br><span class="line">                        .documentType(<span class="string">&quot;temp&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        .inUpsertMode()</span><br><span class="line">        .withFormat(<span class="keyword">new</span> Json())</span><br><span class="line">        .withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">                .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">                .field(<span class="string">&quot;count&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">        )</span><br><span class="line">        .createTemporaryTable(<span class="string">&quot;esOutputTable&quot;</span>);</span><br><span class="line"></span><br><span class="line">aggTable.executeInsert(<span class="string">&quot;esOutputTable&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Json (<code>org.apache.flink.table.descriptors.Json</code>) 需要添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="对接-MySQL"><a href="#对接-MySQL" class="headerlink" title="对接 MySQL"></a>对接 MySQL</h4><ul>
<li><p>引入 MySQL 连接器依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-jdbc_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL =</span><br><span class="line">        <span class="string">&quot;create table jdbcOutputTable (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; id varchar(20) not null, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; cnt bigint not null &quot;</span> +</span><br><span class="line">                <span class="string">&quot;) with (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.type&#x27; = &#x27;jdbc&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.url&#x27; = &#x27;jdbc:mysql://localhost:3306/test&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.table&#x27; = &#x27;sensor_count&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.driver&#x27; = &#x27;com.mysql.jdbc.Driver&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.username&#x27; = &#x27;root&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.password&#x27; = &#x27;123456&#x27; )&quot;</span>;</span><br><span class="line"></span><br><span class="line">tableEnv.sqlUpdate(sinkDDL);<span class="comment">// 执行DDL创建表</span></span><br><span class="line"></span><br><span class="line">aggResultSqlTable.insertInto(<span class="string">&quot;jdbcOutputTable&quot;</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="将表转换成-DataStream"><a href="#将表转换成-DataStream" class="headerlink" title="将表转换成 DataStream"></a>将表转换成 DataStream</h4><ul>
<li><p>表可以转换为 DataStream 或 DataSet ，这样自定义流处理或批处理程序就可以继续在 Table API 或 SQL 查询的结果上运行了。</p>
</li>
<li><p>将表转换为 DataStream 或 DataSet 时，需要指定生成的数据类型，即要将表的每一行转换成的数据类型。</p>
</li>
<li><p>表作为流式查询的结果，是动态更新的。</p>
</li>
<li><p>转换有两种转换模式：追加 (Append) 模式和撤回 (Retract) 模式。</p>
<ul>
<li><p>追加模式 (Append Mode)</p>
<ul>
<li><p>用于表只会被插入 (Insert) 操作更改的场景。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Row&gt; resultStream = tableEnv.toAppendStream(resultTable, Row.class);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>撤回模式 (Retract Mode)</p>
<ul>
<li><p>用于任何场景。类似于更新模式中的 Retract 模式，它只有 Insert 和 Delete 两类操作。</p>
</li>
<li><p>得到的数据会增加一个 Boolean 类型的标识位 (返回的第一个字段)，用它来表示到底是新增的数据 (Insert)，还是被删除的数据 (Delete)。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;Boolean, Row&gt;&gt; aggResultStream = tableEnv.toRetractStream(aggResultTable, Row.class);</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="将-DataStream-转换成表"><a href="#将-DataStream-转换成表" class="headerlink" title="将 DataStream 转换成表"></a>将 DataStream 转换成表</h4><ul>
<li><p>对于一个 DataStream，可以直接转换成 Table，进而方便地调用 Table API 做转换操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; dataStream = ...</span><br><span class="line">Table sensorTable = tableEnv.fromDataStream(dataStream);</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认转换后的 Table schema 和 DataStream 中的字段定义一一对应，也可以单独指定出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; dataStream = ...</span><br><span class="line">Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp as ts, temperature&quot;</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="创建临时视图-Temporary-View"><a href="#创建临时视图-Temporary-View" class="headerlink" title="创建临时视图 (Temporary View)"></a>创建临时视图 (Temporary View)</h4><ul>
<li><p>基于 DataStream 创建临时视图：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.createTemporaryView(<span class="string">&quot;sensorView&quot;</span>, dataStream);</span><br><span class="line">tableEnv.createTemporaryView(<span class="string">&quot;sensorView&quot;</span>, dataStream, <span class="string">&quot;id, temperature, timestamp as ts&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于 Table 创建临时视图：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tableEnv.createTemporaryView(<span class="string">&quot;sensorView&quot;</span>, sensorTable);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="查看执行计划"><a href="#查看执行计划" class="headerlink" title="查看执行计划"></a>查看执行计划</h4><ul>
<li><p>Table API 提供了一种机制来解释计算表的逻辑和优化查询计划。</p>
</li>
<li><p>查看执行计划，可以通过 <code>TableEnvironment.explain(table)</code> 方法或 <code>TableEnvironment.explain()</code> 方法完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String explaination = tableEnv.explain(resultTable);</span><br><span class="line">System.out.println(explaination);</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法返回一个字符串，描述三个计划：</p>
<ul>
<li>优化的逻辑查询计划</li>
<li>优化后的逻辑查询计划</li>
<li>实际执行计划</li>
</ul>
</li>
</ul>
<h3 id="流处理和关系代数的区别"><a href="#流处理和关系代数的区别" class="headerlink" title="流处理和关系代数的区别"></a>流处理和关系代数的区别</h3><table>
<thead>
<tr>
<th></th>
<th>关系代数 (表)/SQL</th>
<th>流处理</th>
</tr>
</thead>
<tbody><tr>
<td>处理的数据对象</td>
<td>字段元组的有界集合</td>
<td>字段元组的无限序列</td>
</tr>
<tr>
<td>查询 (Query) 对数据的访问</td>
<td>可以访问到完整的数据输入</td>
<td>无法访问所有数据，必须持续 “等待” 流式输入</td>
</tr>
<tr>
<td>查询终止条件</td>
<td>生成固定大小的结果集后终止</td>
<td>永不停止，根据持续收到的数据不断更新查询结果</td>
</tr>
</tbody></table>
<h3 id="动态表-Dynamic-Tables"><a href="#动态表-Dynamic-Tables" class="headerlink" title="动态表 (Dynamic Tables)"></a>动态表 (Dynamic Tables)</h3><ul>
<li><p>动态表是 Flink 对流数据的 Table API 和 SQL 支持的核心概念。</p>
</li>
<li><p>与表示批处理数据的静态表不同，动态表是随时间变化的。</p>
</li>
<li><p>动态表可以像静态的批处理表一样进行查询，查询一个动态表会产生持续查询 (Continuous Query)。</p>
</li>
<li><p>持续查询永远不会终止，并会生成另一个动态结果表。</p>
</li>
<li><p>持续查询会不断更新其动态结果表，以反映其动态输入表上的更改。</p>
</li>
<li><p>流式表查询 (持续查询) 的处理过程：</p>
<p><img src="/2021/04/25/flink/image-20210819163456431.png" alt="image-20210819163456431"></p>
<ul>
<li>第一步：流被转换为动态表。</li>
<li>第二步：对动态表计算连续查询，生成新的动态表。</li>
<li>第三步：生成的动态表被转换回流。</li>
</ul>
</li>
</ul>
<h4 id="将流转换成动态表"><a href="#将流转换成动态表" class="headerlink" title="将流转换成动态表"></a>将流转换成动态表</h4><ul>
<li><p>为了处理带有关系查询的流，必须先将其转换为表。</p>
</li>
<li><p>从概念上讲，流的每个数据记录，都被解释为对结果表的插入 (Insert) 修改操作：</p>
<p><img src="/2021/04/25/flink/image-20210819164346348.png" alt="image-20210819164346348"></p>
</li>
</ul>
<h4 id="持续查询"><a href="#持续查询" class="headerlink" title="持续查询"></a>持续查询</h4><ul>
<li><p>持续查询会在动态表上做计算处理，并作为结果生成新的动态表：</p>
<p><img src="/2021/04/25/flink/image-20210819164659342.png" alt="image-20210819164659342"></p>
</li>
</ul>
<h4 id="将动态表转换成-DataStream"><a href="#将动态表转换成-DataStream" class="headerlink" title="将动态表转换成 DataStream"></a>将动态表转换成 DataStream</h4><ul>
<li><p>与常规的数据库表一样，动态表可以通过插入 (Insert)、更新 (Update) 和删除 (Delete) 操作，进行持续的修改。</p>
</li>
<li><p>将动态表转换为流或将其写入外部系统时，需要对这些操作进行编码。</p>
<ul>
<li><p>仅追加 (Append-only) 流</p>
<ul>
<li>仅通过插入 (Insert) 更改来修改的动态表，可以直接转换为仅追加流。</li>
</ul>
</li>
<li><p>撤回 (Retract) 流</p>
<ul>
<li><p>撤回流是包含两类消息的流：添加 (Add) 消息和撤回 (Retract) 消息。</p>
<p><img src="/2021/04/25/flink/image-20210819165853317.png" alt="image-20210819165853317"></p>
</li>
</ul>
</li>
<li><p>更新插入 (Upsert) 流</p>
<ul>
<li><p>Upsert 流也包含两种类型的消息：Upsert 消息和删除 (Delete) 消息。</p>
<p><img src="/2021/04/25/flink/image-20210819170050982.png" alt="image-20210819170050982"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="时间特性-Time-Attributes"><a href="#时间特性-Time-Attributes" class="headerlink" title="时间特性 (Time Attributes)"></a>时间特性 (Time Attributes)</h3><ul>
<li>基于时间的操作 (比如 Table API 和 SQL 中窗口操作)，需要定义相关的时间语义和时间数据来源的信息。</li>
<li>Table 可以提供一个逻辑上的时间字段，用于在表处理程序中，指示时间和访问相应的时间戳。</li>
<li>时间属性，可以是每个表 Schema 的一部分。一旦定义了时间属性，它就可以作为一个字段引用，并且可以在基于时间的操作中使用。</li>
<li>时间属性的行为类似于常规时间戳，可以访问，并且进行计算。</li>
</ul>
<h4 id="定义处理时间-Processing-Time"><a href="#定义处理时间-Processing-Time" class="headerlink" title="定义处理时间 (Processing Time)"></a>定义处理时间 (Processing Time)</h4><ul>
<li><p>处理时间语义下，允许表处理程序根据机器的本地时间生成结果。它是时间的最简单概念。它既不需要提取时间戳，也不需要生成 Watermark。</p>
</li>
<li><p>定义处理时间，有三种方法。</p>
</li>
<li><p>方式一：由 DataStream 转换成表时指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, temperature, timestamp, pt.proctime&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在定义 Schema 时，可以使用 .proctime，指定字段名 (如示例中的 pt 字段) 定义处理时间字段。</p>
</li>
<li><p>这个 proctime 属性只能通过附加逻辑字段，来扩展物理 Schema。因此，只能在 Schema 定义的末尾定义它。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest6_TimeAndWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读入文件数据，得到DataStream</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换成POJO</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 将流转换成表，并定义时间特性，字段名pt自定义，不可与sql关键字冲突，pt是时间戳类型，精确到毫秒</span></span><br><span class="line">        Table dataTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp as ts, temperature as temp, pt.proctime&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.转换成流输出</span></span><br><span class="line">        dataTable.printSchema();</span><br><span class="line">        tableEnv.toAppendStream(dataTable, Row.class).print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">root</span></span><br><span class="line"><span class="function"> |-- id: STRING</span></span><br><span class="line"><span class="function"> |-- ts: BIGINT</span></span><br><span class="line"><span class="function"> |-- temp: DOUBLE</span></span><br><span class="line"><span class="function"> |-- pt: <span class="title">TIMESTAMP</span><span class="params">(<span class="number">3</span>)</span> *PROCTIME*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">sensor_1,1547718199,35.8,2021-08-20T02:40:18.998</span></span><br><span class="line"><span class="function">sensor_6,1547718201,15.4,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_7,1547718202,6.7,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_10,1547718205,38.1,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_1,1547718206,36.3,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_1,1547718210,34.7,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_1,1547718212,33.1,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_6,1547718212,15.3,2021-08-20T02:40:19.002</span></span><br><span class="line"><span class="function">sensor_7,1547718212,6.3,2021-08-20T02:40:19.003</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>方式二：定义 Table Schema 时指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">    .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">    .field(<span class="string">&quot;timestamp&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">    .field(<span class="string">&quot;temperature&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">    .field(<span class="string">&quot;pt&quot;</span>, DataTypes.TIMESTAMP(<span class="number">3</span>))</span><br><span class="line">    .proctime()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式三：在创建表的 DDL 中定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL =</span><br><span class="line">        <span class="string">&quot;create table dataTable (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; id varchar(20) not null, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; ts bigint, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; temperature double, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; pt AS PROCTIME() &quot;</span> +</span><br><span class="line">                <span class="string">&quot;) with (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.type&#x27; = &#x27;filesystem&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.path&#x27; = &#x27;/sensor.txt&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;format.type&#x27; = &#x27;csv&#x27;)&quot;</span>;</span><br><span class="line">tableEnv.sqlUpdate(sinkDDL);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="定义事件时间-Event-Time"><a href="#定义事件时间-Event-Time" class="headerlink" title="定义事件时间 (Event Time)"></a>定义事件时间 (Event Time)</h4><ul>
<li><p>事件时间语义下，允许表处理程序根据每个记录中包含的时间生成结果。这样即使在有乱序事件或者延迟事件时，也可以获得正确的结果。</p>
</li>
<li><p>为了处理无序事件，并区分流中的准时和迟到事件；Flink 需要从事件数据中，提取时间戳，并用来推进事件时间的进展。</p>
</li>
<li><p>定义事件时间，同样有三种方法。</p>
</li>
<li><p>方式一：由 DataStream 转换成表时指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将DataStream转换为Table，并指定时间字段</span></span><br><span class="line">Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp.rowtime, temperature&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者，直接追加时间字段</span></span><br><span class="line">Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, temperature, timestamp, rt.rowtime&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在 DataStream 转换成 Table，使用 .rowtime 可以定义事件时间属性。</p>
</li>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest6_TimeAndWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定事件时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读入文件数据，得到DataStream</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换成POJO，并设置Watermark为2s延迟</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream</span><br><span class="line">                .map(line -&gt; &#123;</span><br><span class="line">                    String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">                &#125;)</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 将流转换成表</span></span><br><span class="line">        <span class="comment">// 方式一：指定数据的timestamp属性为事件时间，数据的timestamp属性会被覆盖重写</span></span><br><span class="line">        Table dataTable1 = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp.rowtime as ts, temperature as temp&quot;</span>);</span><br><span class="line">        <span class="comment">// 方式二：追加一个新的字段，数据的原有属性不做变化</span></span><br><span class="line">        Table dataTable2 = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, temperature, timestamp, rt.rowtime&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.转换成流输出</span></span><br><span class="line">        dataTable1.printSchema();</span><br><span class="line">        tableEnv.toAppendStream(dataTable1, Row.class).print();</span><br><span class="line">        </span><br><span class="line">        dataTable2.printSchema();</span><br><span class="line">        tableEnv.toAppendStream(dataTable2, Row.class).print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<ul>
<li><p>覆盖数据的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">root</span></span><br><span class="line"><span class="function"> |-- id: STRING</span></span><br><span class="line"><span class="function"> |-- ts: <span class="title">TIMESTAMP</span><span class="params">(<span class="number">3</span>)</span> *ROWTIME*</span></span><br><span class="line"><span class="function"> |-- temp: DOUBLE</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">sensor_1,2019-01-17T09:43:19,35.8</span></span><br><span class="line"><span class="function">sensor_6,2019-01-17T09:43:21,15.4</span></span><br><span class="line"><span class="function">sensor_7,2019-01-17T09:43:22,6.7</span></span><br><span class="line"><span class="function">sensor_10,2019-01-17T09:43:25,38.1</span></span><br><span class="line"><span class="function">sensor_1,2019-01-17T09:43:26,36.3</span></span><br><span class="line"><span class="function">sensor_1,2019-01-17T09:43:30,34.7</span></span><br><span class="line"><span class="function">sensor_1,2019-01-17T09:43:32,33.1</span></span><br><span class="line"><span class="function">sensor_6,2019-01-17T09:43:32,15.3</span></span><br><span class="line"><span class="function">sensor_7,2019-01-17T09:43:32,6.3</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>追加新的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">root</span></span><br><span class="line"><span class="function"> |-- id: STRING</span></span><br><span class="line"><span class="function"> |-- temperature: DOUBLE</span></span><br><span class="line"><span class="function"> |-- timestamp: BIGINT</span></span><br><span class="line"><span class="function"> |-- rt: <span class="title">TIMESTAMP</span><span class="params">(<span class="number">3</span>)</span> *ROWTIME*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">sensor_1,35.8,1547718199,2019-01-17T09:43:19</span></span><br><span class="line"><span class="function">sensor_6,15.4,1547718201,2019-01-17T09:43:21</span></span><br><span class="line"><span class="function">sensor_7,6.7,1547718202,2019-01-17T09:43:22</span></span><br><span class="line"><span class="function">sensor_10,38.1,1547718205,2019-01-17T09:43:25</span></span><br><span class="line"><span class="function">sensor_1,36.3,1547718206,2019-01-17T09:43:26</span></span><br><span class="line"><span class="function">sensor_1,34.7,1547718210,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sensor_1,33.1,1547718212,2019-01-17T09:43:32</span></span><br><span class="line"><span class="function">sensor_6,15.3,1547718212,2019-01-17T09:43:32</span></span><br><span class="line"><span class="function">sensor_7,6.3,1547718212,2019-01-17T09:43:32</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>方式二：定义 Table Schema 时指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.withSchema(<span class="keyword">new</span> Schema()</span><br><span class="line">        .field(<span class="string">&quot;id&quot;</span>, DataTypes.STRING())</span><br><span class="line">        .field(<span class="string">&quot;timestamp&quot;</span>, DataTypes.BIGINT())</span><br><span class="line">        .rowtime(</span><br><span class="line">                <span class="keyword">new</span> Rowtime()</span><br><span class="line">                        .timestampsFromField(<span class="string">&quot;timestamp&quot;</span>)<span class="comment">// 从字段中提取时间戳</span></span><br><span class="line">                        .watermarksPeriodicBounded(<span class="number">1000</span>)<span class="comment">// Watermark延迟1秒</span></span><br><span class="line">        )</span><br><span class="line">        .field(<span class="string">&quot;temperature&quot;</span>, DataTypes.DOUBLE())</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式三：在创建表的 DDL 中定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">String sinkDDL =</span><br><span class="line">        <span class="string">&quot;create table dataTable (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; id varchar(20) not null, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; ts bigint, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; temperature double, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; rt AS TO_TIMESTAMP( FROM_UNIXTIME(ts) ), &quot;</span> +</span><br><span class="line">                <span class="string">&quot; watermark for rt as rt - interval &#x27;1&#x27; second&quot;</span> +</span><br><span class="line">                <span class="string">&quot;) with (&quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.type&#x27; = &#x27;filesystem&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;connector.path&#x27; = &#x27;/sensor.txt&#x27;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot; &#x27;format.type&#x27; = &#x27;csv&#x27;)&quot;</span>;</span><br><span class="line">tableEnv.sqlUpdate(sinkDDL);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h3><ul>
<li>时间语义，要配合窗口操作才能发挥作用。</li>
<li>在 Table API 和 SQL 中，主要有两种窗口：<ul>
<li>Group Windows (分组窗口)<ul>
<li>根据时间或行计数间隔，将行聚合到有限的组 (Group) 中，并对每个组的数据执行一次聚合函数。</li>
</ul>
</li>
<li>Over Windows<ul>
<li>针对每个输入行，计算相邻行范围内的聚合。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Group-Windows"><a href="#Group-Windows" class="headerlink" title="Group Windows"></a>Group Windows</h4><ul>
<li><p>Group Windows 是使用 <code>.window(w:GroupWindow)</code>子句定义的，并且必须由 as 为子句指定一个别名。</p>
</li>
<li><p>为了按窗口对表进行分组，窗口的别名必须在 group by 子句中，像常规的分组字段一样引用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Table table = input</span><br><span class="line">        .window([w: GroupWindow] as <span class="string">&quot;w&quot;</span>)<span class="comment">// 定义窗口，别名为w</span></span><br><span class="line">        .groupBy(<span class="string">&quot;w, a&quot;</span>)<span class="comment">// 按照字段a和窗口w分组</span></span><br><span class="line">        .select(<span class="string">&quot;a, b.sum&quot;</span>);<span class="comment">// 聚合</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Table API 提供了一组具有特定语义的预定义 Window 类，这些类会被转换为底层 DataStream 或 DataSet 的窗口操作。</p>
</li>
</ul>
<h5 id="滚动窗口-Tumbling-windows"><a href="#滚动窗口-Tumbling-windows" class="headerlink" title="滚动窗口 (Tumbling windows)"></a>滚动窗口 (Tumbling windows)</h5><ul>
<li><p>滚动窗口要用 Tumble 类来定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tumbling Event-time Window</span></span><br><span class="line">.window(Tumble.over(<span class="string">&quot;10.minutes&quot;</span>).on(<span class="string">&quot;rowtime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 10min的滚动窗口，事件时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// Tumbling Processing-time Window</span></span><br><span class="line">.window(Tumble.over(<span class="string">&quot;10.minutes&quot;</span>).on(<span class="string">&quot;proctime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 10min的滚动窗口，处理时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// Tumbling Row-count Window</span></span><br><span class="line">.window(Tumble.over(<span class="string">&quot;10.rows&quot;</span>).on(<span class="string">&quot;proctime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 计数窗口，10个数据一行，处理时间</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>示例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest6_TimeAndWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定事件时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读入文件数据，得到DataStream</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换成POJO，并设置Watermark为2s延迟</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream</span><br><span class="line">                .map(line -&gt; &#123;</span><br><span class="line">                    String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">                &#125;)</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 将流转换成表</span></span><br><span class="line">        <span class="comment">// 方式一：指定数据的timestamp属性为事件时间，数据的timestamp属性会被覆盖重写</span></span><br><span class="line"><span class="comment">//        Table dataTable = tableEnv.fromDataStream(dataStream, &quot;id, timestamp.rowtime as ts, temperature as temp&quot;);</span></span><br><span class="line">        <span class="comment">// 方式二：追加一个新的字段</span></span><br><span class="line">        Table dataTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, temperature as temp, timestamp as ts, rt.rowtime&quot;</span>);</span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, dataTable);<span class="comment">// 注册表，在SQL中用</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.窗口操作</span></span><br><span class="line">        <span class="comment">// 6-1.Group Window</span></span><br><span class="line">        <span class="comment">// Table API写法</span></span><br><span class="line">        Table resultTable = dataTable.window(Tumble.over(<span class="string">&quot;10.seconds&quot;</span>).on(<span class="string">&quot;rt&quot;</span>).as(<span class="string">&quot;tw&quot;</span>))</span><br><span class="line">                .groupBy(<span class="string">&quot;id, tw&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, id.count, temp.avg, tw.end&quot;</span>);<span class="comment">// id, 当前id数据个数，温度平均值，开窗结束时间</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// SQL写法</span></span><br><span class="line">        Table resultSqlTable = tableEnv.sqlQuery(<span class="string">&quot;select id, count(id) as cnt, avg(temp) as avgTemp, tumble_end(rt, interval &#x27;10&#x27; second) &quot;</span> +</span><br><span class="line">                <span class="string">&quot;from sensor group by id, tumble(rt, interval &#x27;10&#x27; second)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.转换成流输出</span></span><br><span class="line">        tableEnv.toAppendStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toAppendStream(resultSqlTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">result&gt; sensor_1,1,35.8,2019-01-17T09:43:20</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1,15.4,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1,35.8,2019-01-17T09:43:20</span></span><br><span class="line"><span class="function">result&gt; sensor_10,1,38.1,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1,15.4,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1,36.3,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1,6.7,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1,6.3,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1,15.3,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function">result&gt; sensor_1,2,33.900000000000006,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function">sql&gt; sensor_10,1,38.1,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1,36.3,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1,6.7,2019-01-17T09:43:30</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1,6.3,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1,15.3,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,2,33.900000000000006,2019-01-17T09:43:40</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="滑动窗口-Sliding-windows"><a href="#滑动窗口-Sliding-windows" class="headerlink" title="滑动窗口 (Sliding windows)"></a>滑动窗口 (Sliding windows)</h5><ul>
<li><p>滑动窗口要用 Slide 类来定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sliding Event-time Window</span></span><br><span class="line">.window(Slide.over(<span class="string">&quot;10.minutes&quot;</span>).every(<span class="string">&quot;5.minutes&quot;</span>).on(<span class="string">&quot;rowtime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 10min的滑动窗口，滑动步长5min，事件时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// Sliding Processing-time window</span></span><br><span class="line">.window(Slide.over(<span class="string">&quot;10.minutes&quot;</span>).every(<span class="string">&quot;5.minutes&quot;</span>).on(<span class="string">&quot;proctime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 10min的滑动窗口，滑动步长5min，处理时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// Sliding Row-count window</span></span><br><span class="line">.window(Slide.over(<span class="string">&quot;10.rows&quot;</span>).every(<span class="string">&quot;5.rows&quot;</span>).on(<span class="string">&quot;proctime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// 计数窗口，10个数据一行，5个数据一滑动，处理时间</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="会话窗口（Session-windows）"><a href="#会话窗口（Session-windows）" class="headerlink" title="会话窗口（Session windows）"></a>会话窗口（Session windows）</h5><ul>
<li><p>会话窗口要用 Session 类来定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session Event-time Window</span></span><br><span class="line">.window(Session.withGap(<span class="string">&quot;10.minutes&quot;</span>).on(<span class="string">&quot;rowtime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// Session时长10min，事件时间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// Session Processing-time Window</span></span><br><span class="line">.window(Session.withGap(<span class="string">&quot;10.minutes&quot;</span>).on(<span class="string">&quot;proctime&quot;</span>).as(<span class="string">&quot;w&quot;</span>))<span class="comment">// Session时长10min，处理时间</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="SQL-中的-Group-Windows"><a href="#SQL-中的-Group-Windows" class="headerlink" title="SQL 中的 Group Windows"></a>SQL 中的 Group Windows</h5><ul>
<li>Group Windows 定义在 SQL 查询的 Group By 子句中。</li>
<li><code>TUMBLE(time_attr, interval)</code><ul>
<li>定义一个滚动窗口，第一个参数是时间字段，第二个参数是窗口长度。</li>
</ul>
</li>
<li><code>HOP(time_attr, interval, interval)</code><ul>
<li>定义一个滑动窗口，第一个参数是时间字段，第二4 个参数是窗口滑动步长，第三个是窗口长度。</li>
</ul>
</li>
<li><code>SESSION(time_attr, interval)</code><ul>
<li>定义一个会话窗口，第一个参数是时间字段，第二个参数是窗口间隔。</li>
</ul>
</li>
</ul>
<h4 id="Over-Windows"><a href="#Over-Windows" class="headerlink" title="Over Windows"></a>Over Windows</h4><ul>
<li><p>Over Windows 聚合是标准 SQL 中已有的 (over 子句)，可以在查询的 SELECT 子句中定义。</p>
</li>
<li><p>Over Windows 聚合，会针对每个输入行，计算相邻行范围内的聚合。</p>
</li>
<li><p>Over Windows 使用 <code>.window(w:overwindows)</code> 子句定义，并在 <code>select()</code> 中通过别名来引用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Table table = input</span><br><span class="line">        .window([w: OverWindow] as <span class="string">&quot;w&quot;</span>)<span class="comment">// 定义窗口，别名为w</span></span><br><span class="line">        .select(<span class="string">&quot;a, b.sum over w, c.min over w&quot;</span>);<span class="comment">// 聚合</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Table API 提供了 Over 类，来配置 Over 窗口的属性。</p>
</li>
</ul>
<h5 id="无界-Over-Windows"><a href="#无界-Over-Windows" class="headerlink" title="无界 Over Windows"></a>无界 Over Windows</h5><ul>
<li><p>可以在事件时间或处理时间，以及指定为时间间隔、或行计数的范围内，定义 Over Windows。</p>
</li>
<li><p>无界的 Over Windows 是使用常量指定的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无界的事件时间Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;rowtime&quot;</span>).preceding(UNBOUNDED_RANGE).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无界的处理时间Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;proctime&quot;</span>).preceding(UNBOUNDED_RANGE).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无界的事件时间Row-count Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;rowtime&quot;</span>).preceding(UNBOUNDED_ROW).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无界的处理时间Row-count Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;proctime&quot;</span>).preceding(UNBOUNDED_ROW).as(<span class="string">&quot;w&quot;</span>))</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="有界-Over-Windows"><a href="#有界-Over-Windows" class="headerlink" title="有界 Over Windows"></a>有界 Over Windows</h5><ul>
<li><p>有界的 Over Windows 是用间隔的大小指定的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有界的事件时间Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;rowtime&quot;</span>).preceding(<span class="string">&quot;1.minutes&quot;</span>).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有界的处理时间Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;proctime&quot;</span>).preceding(<span class="string">&quot;1.minutes&quot;</span>).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有界的事件时间Row-count Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;rowtime&quot;</span>).preceding(<span class="string">&quot;10.rows&quot;</span>).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有界的处理时间Row-count Over Window</span></span><br><span class="line">.window(Over.partitionBy(<span class="string">&quot;a&quot;</span>).orderBy(<span class="string">&quot;procime&quot;</span>).preceding(<span class="string">&quot;10.rows&quot;</span>).as(<span class="string">&quot;w&quot;</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TableTest6_TimeAndWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定事件时间语义</span></span><br><span class="line">        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读入文件数据，得到DataStream</span></span><br><span class="line">        DataStream&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换成POJO，并设置Watermark为2s延迟</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream</span><br><span class="line">                .map(line -&gt; &#123;</span><br><span class="line">                    String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">                &#125;)</span><br><span class="line">                .assignTimestampsAndWatermarks(<span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;SensorReading&gt;(Time.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(SensorReading sensorReading)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> sensorReading.getTimestamp() * <span class="number">1000L</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 将流转换成表</span></span><br><span class="line">        <span class="comment">// 方式一：指定数据的timestamp属性为事件时间，数据的timestamp属性会被覆盖重写</span></span><br><span class="line"><span class="comment">//        Table dataTable = tableEnv.fromDataStream(dataStream, &quot;id, timestamp.rowtime as ts, temperature as temp&quot;);</span></span><br><span class="line">        <span class="comment">// 方式二：追加一个新的字段</span></span><br><span class="line">        Table dataTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, temperature as temp, timestamp as ts, rt.rowtime&quot;</span>);</span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, dataTable);<span class="comment">// 注册表，在SQL中用</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.窗口操作</span></span><br><span class="line">        <span class="comment">// 6-2.Over Window</span></span><br><span class="line">        <span class="comment">// Table API写法</span></span><br><span class="line">        Table overResultTable = dataTable.window(Over.partitionBy(<span class="string">&quot;id&quot;</span>).orderBy(<span class="string">&quot;rt&quot;</span>).preceding(<span class="string">&quot;2.rows&quot;</span>).as(<span class="string">&quot;ow&quot;</span>))</span><br><span class="line">                .select(<span class="string">&quot;id, rt, id.count over ow, temp.avg over ow&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SQL写法</span></span><br><span class="line">        Table overSqlResultTable = tableEnv.sqlQuery(<span class="string">&quot;select id, rt, count(id) over ow, avg(temp) over ow &quot;</span> +</span><br><span class="line">                <span class="string">&quot; from sensor &quot;</span> +</span><br><span class="line">                <span class="string">&quot; window ow as (partition by id order by rt rows between 2 preceding and current row)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.转换成流输出</span></span><br><span class="line">        tableEnv.toAppendStream(overResultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toAppendStream(overSqlResultTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">result&gt; sensor_1,2019-01-17T09:43:19,1,35.8</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,2019-01-17T09:43:19,1,35.8</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,2019-01-17T09:43:21,1,15.4</span></span><br><span class="line"><span class="function">result&gt; sensor_6,2019-01-17T09:43:21,1,15.4</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,2019-01-17T09:43:22,1,6.7</span></span><br><span class="line"><span class="function">result&gt; sensor_7,2019-01-17T09:43:22,1,6.7</span></span><br><span class="line"><span class="function">sql&gt; sensor_10,2019-01-17T09:43:25,1,38.1</span></span><br><span class="line"><span class="function">result&gt; sensor_10,2019-01-17T09:43:25,1,38.1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,2019-01-17T09:43:26,2,36.05</span></span><br><span class="line"><span class="function">result&gt; sensor_1,2019-01-17T09:43:26,2,36.05</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,2019-01-17T09:43:30,3,35.6</span></span><br><span class="line"><span class="function">result&gt; sensor_1,2019-01-17T09:43:30,3,35.6</span></span><br><span class="line"><span class="function">result&gt; sensor_7,2019-01-17T09:43:32,2,6.5</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,2019-01-17T09:43:32,2,6.5</span></span><br><span class="line"><span class="function">result&gt; sensor_1,2019-01-17T09:43:32,3,34.699999999999996</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,2019-01-17T09:43:32,3,34.699999999999996</span></span><br><span class="line"><span class="function">result&gt; sensor_6,2019-01-17T09:43:32,2,15.350000000000001</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,2019-01-17T09:43:32,2,15.350000000000001</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code </span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="SQL-中的-Over-Windows"><a href="#SQL-中的-Over-Windows" class="headerlink" title="SQL 中的 Over Windows"></a>SQL 中的 Over Windows</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SELECT <span class="title">COUNT</span><span class="params">(amount)</span> <span class="title">OVER</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	PARTITION BY user</span></span></span><br><span class="line"><span class="function"><span class="params">	ORDER BY proctime</span></span></span><br><span class="line"><span class="function"><span class="params">	ROWS BETWEEN <span class="number">2</span> PRECEDING AND CURRENT ROW)</span></span></span><br><span class="line"><span class="function">FROM Orders</span></span><br></pre></td></tr></table></figure>

<ul>
<li>用 Over 做窗口聚合时，所有聚合必须在同一窗口上定义，也就是说必须是相同的分区、排序和范围。</li>
<li>目前仅支持在当前行范围之前的窗口。</li>
<li>ORDER BY 必须在单一的时间属性上指定。</li>
</ul>
<h3 id="函数-Functions"><a href="#函数-Functions" class="headerlink" title="函数 (Functions)"></a>函数 (Functions)</h3><ul>
<li><p>Flink Table API 和 SQL 为用户提供了一组用于数据转换的内置函数。</p>
</li>
<li><p>SQL 中支持的很多函数，Table API 和 SQL 都已经做了实现：</p>
<table>
<thead>
<tr>
<th></th>
<th>Table API</th>
<th>SQL</th>
</tr>
</thead>
<tbody><tr>
<td>比较函数</td>
<td><code>ANY1 === ANY2</code><br><code>ANY1 &gt; ANY2</code></td>
<td><code>value1 = value2</code><br><code>value1 &gt; value2</code></td>
</tr>
<tr>
<td>逻辑函数</td>
<td>`BOOLEAN1</td>
<td></td>
</tr>
<tr>
<td>算数函数</td>
<td><code>NUMERIC1 + NUMERIC2</code><br><code>NUMERIC1.power(NUMERIC2)</code></td>
<td><code>numeric1 + numeric2</code><br><code>POWER(numeric1, numeric2)</code></td>
</tr>
<tr>
<td>字符串函数</td>
<td><code>STRING1 + STRING2</code><br><code>STRING.upperCase()</code><br><code>STRING.charLength()</code></td>
<td>`string1</td>
</tr>
<tr>
<td>时间函数</td>
<td><code>STRING.toDate</code><br><code>STRING.toTimestamp</code><br><code>currentTime()</code><br><code>NUMERIC.days</code><br><code>NUMERIC.minutes</code></td>
<td><code>DATE string</code><br><code>TIMESTAMP string</code><br><code>CURRENT_TIME</code><br><code>INTERVAL string range</code></td>
</tr>
<tr>
<td>聚合函数</td>
<td><code>FIELD.count</code><br><code>FIELD.sum0</code></td>
<td><code>COUNT(*)</code><br><code>SUM(expression)</code><br><code>RANK()</code><br><code>ROW_NUMBER()</code></td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="用户自定义函数-UDF"><a href="#用户自定义函数-UDF" class="headerlink" title="用户自定义函数 (UDF)"></a>用户自定义函数 (UDF)</h4><ul>
<li>用户定义函数 (User-defined Functions，UDF) 是一个重要的特性，它们显著地扩展了查询的表达能力。</li>
<li>在大多数情况下，用户定义的函数必须先注册，然后才能在查询中使用。</li>
<li>函数通过调用 <code>registerFunction()</code> 在 TableEnvironment 中注册。当用户定义的函数被注册时，它被插入到 TableEnvironment 的函数目录中，这样 Table API 或 SQL 解析器就可以识别并正确地解释它。</li>
</ul>
<h5 id="标量函数-Scalar-Functions"><a href="#标量函数-Scalar-Functions" class="headerlink" title="标量函数 (Scalar Functions)"></a>标量函数 (Scalar Functions)</h5><ul>
<li><p>用户定义的标量函数，可以将 0、1 或多个标量值，映射到新的标量值。</p>
</li>
<li><p>为了定义标量函数，必须在 <code>org.apache.flink.table.functions</code> 中扩展基类 Scalar Function，并实现 (一个或多个) 求值 (eval) 方法。</p>
</li>
<li><p>标量函数的行为由求值方法决定，求值方法必须公开声明并命名为 <code>eval()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HashCode</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> factor = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashCode</span><span class="params">(<span class="keyword">int</span> factor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.factor = factor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">eval</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str.hashCode() * factor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdfTest1_ScalarFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.读取数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.转换成POJO</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.将流转换成表</span></span><br><span class="line">        Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp as ts, temperature as temp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.自定义标量函数，实现求id的hash值</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-1.需要在环境中注册UDF</span></span><br><span class="line">        HashCode hashCode = <span class="keyword">new</span> HashCode(<span class="number">23</span>);<span class="comment">// 创建实例</span></span><br><span class="line">        tableEnv.registerFunction(<span class="string">&quot;hashCode&quot;</span>, hashCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-2.Table API写法</span></span><br><span class="line">        Table resultTable = sensorTable.select(<span class="string">&quot;id, ts, hashCode(id)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-3.SQL写法</span></span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, sensorTable);</span><br><span class="line">        Table resultSqlTable = tableEnv.sqlQuery(<span class="string">&quot;select id, ts, hashCode(id) from sensor&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.打印输出</span></span><br><span class="line">        tableEnv.toAppendStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toAppendStream(resultSqlTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的ScalarFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HashCode</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> factor = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HashCode</span><span class="params">(<span class="keyword">int</span> factor)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.factor = factor;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须是public，方法名必须叫eval，其他按需自定义</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">eval</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> str.hashCode() * factor;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718199,-1036124876</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718199,-1036124876</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718201,-1036124761</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718201,-1036124761</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718202,-1036124738</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718202,-1036124738</span></span><br><span class="line"><span class="function">result&gt; sensor_10,1547718205,-2055098980</span></span><br><span class="line"><span class="function">sql&gt; sensor_10,1547718205,-2055098980</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718206,-1036124876</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718206,-1036124876</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718210,-1036124876</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718210,-1036124876</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718212,-1036124876</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718212,-1036124876</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718212,-1036124761</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718212,-1036124761</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718212,-1036124738</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718212,-1036124738</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="表函数-Table-Functions"><a href="#表函数-Table-Functions" class="headerlink" title="表函数 (Table Functions)"></a>表函数 (Table Functions)</h5><ul>
<li><p>用户定义的表函数，也可以将 0、1 或多个标量值作为输入参数；与标量函数不同的是，它可以返回任意数量的行作为输出，而不是单个值。</p>
</li>
<li><p>为了定义一个表函数，必须扩展 <code>org.apache.flink.table.functions</code> 中的基类 TableFunction 并实现 (一个或多个) 求值方法。</p>
</li>
<li><p>表函数的行为由其求值方法决定，求值方法必须是 public 的，并命名为 <code>eval()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Split</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String separator = <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Split</span><span class="params">(String separator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.separator = separator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eval</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String s : str.split(separator)) &#123;</span><br><span class="line">            collect(<span class="keyword">new</span> Tuple2&lt;&gt;(s, s.length()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdfTest2_TableFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.读取数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.转换成POJO</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.将流转换成表</span></span><br><span class="line">        Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp as ts, temperature as temp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.自定义表函数，实现将id拆分，并输出(word, length)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-1.需要在环境中注册UDF</span></span><br><span class="line">        Split split = <span class="keyword">new</span> Split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">        tableEnv.registerFunction(<span class="string">&quot;split&quot;</span>, split);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-2.Table API写法</span></span><br><span class="line">        Table resultTable = sensorTable</span><br><span class="line">                .joinLateral(<span class="string">&quot;split(id) as (word, length)&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, ts, word, length&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-3.SQL写法</span></span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, sensorTable);</span><br><span class="line">        Table resultSqlTable = tableEnv.sqlQuery(<span class="string">&quot;select id, ts, word, length &quot;</span> +</span><br><span class="line">                <span class="string">&quot; from sensor, lateral table(split(id)) as splitid(word, length)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.打印输出</span></span><br><span class="line">        tableEnv.toAppendStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toAppendStream(resultSqlTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义TableFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Split</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="comment">// 定义属性，分隔符</span></span><br><span class="line">        <span class="keyword">private</span> String separator = <span class="string">&quot;,&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Split</span><span class="params">(String separator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.separator = separator;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须实现一个eval方法，没有返回值</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eval</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (String s : str.split(separator)) &#123;</span><br><span class="line">                collect(<span class="keyword">new</span> Tuple2&lt;&gt;(s, s.length()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;java</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718199,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718199,1,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718199,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718199,1,1</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718201,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718201,6,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718201,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718201,6,1</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718202,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718202,7,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718202,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718202,7,1</span></span><br><span class="line"><span class="function">result&gt; sensor_10,1547718205,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_10,1547718205,10,2</span></span><br><span class="line"><span class="function">sql&gt; sensor_10,1547718205,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_10,1547718205,10,2</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718206,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718206,1,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718206,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718206,1,1</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718210,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718210,1,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718210,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718210,1,1</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718212,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_1,1547718212,1,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718212,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_1,1547718212,1,1</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718212,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_6,1547718212,6,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718212,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_6,1547718212,6,1</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718212,sensor,6</span></span><br><span class="line"><span class="function">result&gt; sensor_7,1547718212,7,1</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718212,sensor,6</span></span><br><span class="line"><span class="function">sql&gt; sensor_7,1547718212,7,1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="聚合函数-Aggregate-Functions"><a href="#聚合函数-Aggregate-Functions" class="headerlink" title="聚合函数 (Aggregate Functions)"></a>聚合函数 (Aggregate Functions)</h5><ul>
<li><p>用户自定义的聚合函数 (User-Defined Aggregate Functions，UDAGGs)，可以把一个表中的数据，聚合成一个标量值。</p>
</li>
<li><p>用户自定义的聚合函数，是通过继承 AggregateFunction 抽象类实现的。</p>
</li>
<li><p>AggregationFunction 要求必须实现的方法：</p>
<p><img src="/2021/04/25/flink/image-20210822170147356.png" alt="image-20210822170147356"></p>
<ul>
<li><code>createAccumulator()</code>：创建一个空累加器。</li>
<li><code>accumulate()</code>：更新累加器。</li>
<li><code>getValue()</code>：获取最终结果。</li>
</ul>
</li>
<li><p>AggregateFunction 的工作原理如下：</p>
<ul>
<li>首先，它需要一个累加器 (Accumulator)，用来保存聚合中间结果的数据结构。通过调用 <code>createAccumulator()</code> 创建空累加器。</li>
<li>随后，对每个输入行调用函数的 <code>accumulate()</code> 来更新累加器。</li>
<li>处理完所有行后，将调用函数的 <code>getValue()</code> 来计算并返回最终结果。</li>
</ul>
</li>
<li><p>实例：</p>
<ul>
<li><p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdfTest3_AggregateFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建流处理环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.读取数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; inputStream = env.readTextFile(<span class="string">&quot;src/main/resources/sensor.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.转换成POJO</span></span><br><span class="line">        DataStream&lt;SensorReading&gt; dataStream = inputStream.map(line -&gt; &#123;</span><br><span class="line">            String[] fields = line.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SensorReading(fields[<span class="number">0</span>], <span class="keyword">new</span> Long(fields[<span class="number">1</span>]), <span class="keyword">new</span> Double(fields[<span class="number">2</span>]));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建表处理环境</span></span><br><span class="line">        StreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.将流转换成表</span></span><br><span class="line">        Table sensorTable = tableEnv.fromDataStream(dataStream, <span class="string">&quot;id, timestamp as ts, temperature as temp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.自定义聚合函数，求当前传感器的平均温度值</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-1.需要在环境中注册UDF</span></span><br><span class="line">        AvgTemp avgTemp = <span class="keyword">new</span> AvgTemp();</span><br><span class="line">        tableEnv.registerFunction(<span class="string">&quot;avgTemp&quot;</span>, avgTemp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-2.Table API写法</span></span><br><span class="line">        Table resultTable = sensorTable</span><br><span class="line">                .groupBy(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .aggregate(<span class="string">&quot;avgTemp(temp) as avgtemp&quot;</span>)</span><br><span class="line">                .select(<span class="string">&quot;id, avgtemp&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6-3.SQL写法</span></span><br><span class="line">        tableEnv.createTemporaryView(<span class="string">&quot;sensor&quot;</span>, sensorTable);</span><br><span class="line">        Table resultSqlTable = tableEnv.sqlQuery(<span class="string">&quot;select id, avgTemp(temp) &quot;</span> +</span><br><span class="line">                <span class="string">&quot; from sensor group by id&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.打印输出</span></span><br><span class="line">        tableEnv.toRetractStream(resultTable, Row.class).print(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        tableEnv.toRetractStream(resultSqlTable, Row.class).print(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现自定义的AggregateFunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AvgTemp</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>&lt;<span class="title">Double</span>, <span class="title">Tuple2</span>&lt;<span class="title">Double</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Double <span class="title">getValue</span><span class="params">(Tuple2&lt;Double, Integer&gt; accumulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> accumulator.f0 / accumulator.f1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Tuple2&lt;Double, Integer&gt; <span class="title">createAccumulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="number">0.0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须实现一个accumulate方法，来数据之后更新状态</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accumulate</span><span class="params">(Tuple2&lt;Double, Integer&gt; accumulator, Double temp)</span> </span>&#123;</span><br><span class="line">            accumulator.f0 += temp;</span><br><span class="line">            accumulator.f1 += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入参数：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718206,36.3</span><br><span class="line">sensor_1,1547718210,34.7</span><br><span class="line">sensor_1,1547718212,33.1</span><br><span class="line">sensor_6,1547718212,15.3</span><br><span class="line">sensor_7,1547718212,6.3</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">log4j:<span class="function">WARN No appenders could be found <span class="keyword">for</span> <span class="title">logger</span> <span class="params">(org.apache.flink.api.java.typeutils.TypeExtractor)</span>.</span></span><br><span class="line"><span class="function">log4j:WARN Please initialize the log4j system properly.</span></span><br><span class="line"><span class="function">log4j:WARN See http:<span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_10,<span class="number">38.1</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_10,<span class="number">38.1</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">35.8</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">36.05</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">34.975</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">false</span>,sensor_6,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">false</span>,sensor_1,<span class="number">35.6</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">15.350000000000001</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_1,<span class="number">34.975</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">false</span>,sensor_7,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">sql&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">6.5</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">false</span>,sensor_6,<span class="number">15.4</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_6,<span class="number">15.350000000000001</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">false</span>,sensor_7,<span class="number">6.7</span>)</span></span></span><br><span class="line"><span class="function">result&gt; <span class="params">(<span class="keyword">true</span>,sensor_7,<span class="number">6.5</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Process finished with exit code 0</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="表聚合函数-Table-Aggregate-Functions"><a href="#表聚合函数-Table-Aggregate-Functions" class="headerlink" title="表聚合函数 (Table Aggregate Functions)"></a>表聚合函数 (Table Aggregate Functions)</h5><ul>
<li><p>用户自定义的表聚合函数 (User-Defined Table Aggregate Functions，UDTAGGs)，可以把一个表中数据，聚合为具有多行和多列的结果表。</p>
</li>
<li><p>用户自定义的表聚合函数，是通过继承 TableAggregateFunction 抽象类实现的。</p>
</li>
<li><p>TableAggregateFunction 要求必须实现的方法：</p>
<p><img src="/2021/04/25/flink/image-20210822170940295.png" alt="image-20210822170940295"></p>
<ul>
<li><code>createAccumulator()</code>：创建一个空累加器。</li>
<li><code>accumulate()</code>：更新累加器。</li>
<li><code>emitValue()</code>：获取最终结果。</li>
</ul>
</li>
<li><p>TableAggregateFunction 的工作原理如下:</p>
<ul>
<li>首先，它同样需要一个累加器 (Accumulator)，用来保存聚合中间结果的数据结构。通过调用 <code>createAccumulator()</code> 创建空累加器。</li>
<li>随后，对每个输入行调用函数的 <code>accumulate()</code> 来更新累加器。</li>
<li>处理完所有行后，将调用函数的 <code>emitValue()</code> 来计算并返回最终结果。</li>
</ul>
</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1qy4y1q728">https://www.bilibili.com/video/BV1qy4y1q728</a></p>
<p><a target="_blank" rel="noopener" href="https://ashiamd.github.io/docsify-notes/#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1-flink%e7%9a%84%e7%89%b9%e7%82%b9">https://ashiamd.github.io/docsify-notes/#/study/BigData/Flink/%E5%B0%9A%E7%A1%85%E8%B0%B7Flink%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E6%88%98-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0?id=_1-flink%e7%9a%84%e7%89%b9%e7%82%b9</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/23/spring-webflux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/23/spring-webflux/" class="post-title-link" itemprop="url">Spring 之 WebFlux</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-23 15:35:11" itemprop="dateCreated datePublished" datetime="2021-04-23T15:35:11+08:00">2021-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-07 16:55:01" itemprop="dateModified" datetime="2021-07-07T16:55:01+08:00">2021-07-07</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>23 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Spring-WebFlux-介绍"><a href="#Spring-WebFlux-介绍" class="headerlink" title="Spring WebFlux 介绍"></a>Spring WebFlux 介绍</h2><ul>
<li><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.2.7.RELEASE/spring-framework-reference/web-reactive.html#spring-webflux">https://docs.spring.io/spring-framework/docs/5.2.7.RELEASE/spring-framework-reference/web-reactive.html#spring-webflux</a></p>
</li>
<li><p>Spring WebFlux 是 Spring5 添加的新模块，用于 Web 开发，功能和 Spring MVC 类似的，底层实现不同。</p>
</li>
<li><p>Spring WebFlux 是契合使用<strong>响应式编程</strong>而出现的框架。</p>
</li>
<li><p>传统的 Web 框架，比如 Spring MVC、Struts2 等，是基于 Servlet 容器运行的。<strong>Spring WebFlux 是一种异步非阻塞的框架，异步非阻塞的框架在 Servlet3.1 以后才支持，其核心是基于 Reactor 的相关 API 实现的。</strong></p>
</li>
<li><p>异步非阻塞：</p>
<ul>
<li>异步和同步针对调用者：调用者发送请求，如果等着对方回应之后才去做其他事情就是同步，如果发送请求之后不等着对方回应就去做其他事情就是异步。</li>
<li>阻塞和非阻塞针对被调用者：被调用者收到请求时，如果做完请求任务之后才给出反馈就是阻塞，如果收到请求之后马上给出反馈，然后再去做任务就是非阻塞。<ul>
<li>阻塞需要等待，非阻塞不需要等待。</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring WebFlux 的特点：</p>
<ul>
<li>非阻塞式：能够在有限的资源下，提高系统的吞吐量和伸缩性，从而处理更多的请求。Spring WebFlux 是以 Reactor 为基础来实现的响应式编程框架。</li>
<li>函数式编程：Spring5 框架基于 Java8，Spring Webflux 能够使用 Java8 的函数式编程方式来实现路由请求。</li>
</ul>
</li>
<li><p>Spring WebFlux 和  Spring MVC 的对比：</p>
<img src="/2021/04/23/spring-webflux/image-20210423160134239.png" alt="image-20210423160134239" style="zoom: 80%;">

<ul>
<li>两个框架都可以使用注解方式操作，也都可以运行在 Tomcat 等容器中。</li>
<li>Spring MVC 采用命令式编程，Spring WebFlux 采用异步响应式编程。</li>
</ul>
</li>
</ul>
<h2 id="响应式编程概述"><a href="#响应式编程概述" class="headerlink" title="响应式编程概述"></a>响应式编程概述</h2><ul>
<li><p>响应式编程是一种面向数据流和变化传播的编程范式。这意味着可以在编程语言中很方便地表达静态或动态的数据流，而相关的计算模型会自动将变化的值通过数据流进行传播。</p>
<ul>
<li>例如，对于 a = b + c 这个表达式的处理，在命令式编程中，会先计算 b + c 的结果，再把此结果赋值给变量 a，因此 b，c 两值的变化不会对变量 a 产生影响。但在响应式编程中，变量 a 的值会随时跟随 b，c 的变化而变化。</li>
<li>电子表格程序就是响应式编程的一个例子。单元格可以包含字面值或类似 “= B1 + C1” 的公式，而包含公式的单元格的值会依据其他单元格的值的变化而变化。</li>
</ul>
</li>
<li><p>Java8 及其之前版本的实现方式：</p>
<ul>
<li><p>本质上使用的是观察者设计模式。</p>
</li>
<li><p>Java8 提供的观察者模式的两个类 <strong>Observer 和 Observable</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverDemo</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ObserverDemo observer = <span class="keyword">new</span> ObserverDemo();</span><br><span class="line">        <span class="comment">// 添加观察者</span></span><br><span class="line">        observer.addObserver(<span class="keyword">new</span> Observer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;发生了变化&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        observer.addObserver(<span class="keyword">new</span> Observer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;收到被观察者通知，准备改变&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        observer.setChanged();<span class="comment">// 监控数据是否发生变化</span></span><br><span class="line">        observer.notifyObservers();<span class="comment">// 通知</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Java9 及之后的版本，使用 <strong>Flow</strong> 类替换了 Observer 和 Observable。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Flow.Publisher&lt;String&gt; publisher = subscriber -&gt; &#123;</span><br><span class="line">            subscriber.onNext(<span class="string">&quot;1&quot;</span>);<span class="comment">// 1</span></span><br><span class="line">            subscriber.onNext(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">            subscriber.onError(<span class="keyword">new</span> RuntimeException(<span class="string">&quot;出错&quot;</span>));<span class="comment">// 2</span></span><br><span class="line">            <span class="comment">//  subscriber.onComplete();</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        publisher.subscribe(<span class="keyword">new</span> Flow.Subscriber&lt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> </span>&#123;</span><br><span class="line">                subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">                System.out.println(item);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;出错了&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;publish complete&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Reactor</strong> 实现。</p>
<ul>
<li><p>响应式编程操作中，都需要满足 Reactive 规范，Reactor 即为这样的一个框架，WebFlux 的核心即是使用 Reactor 实现的。</p>
</li>
<li><p>Reactor 有两个核心类，Mono 和 Flux ，这两个类都实现了 Publisher 接口，提供了丰富的操作符。</p>
<ul>
<li><strong>Flux 对象实现发布者时，返回 N 个元素；Mono 实现发布者时，返回 0 或者 1 个元素。</strong></li>
</ul>
</li>
<li><p><strong>Flux 和 Mono 都是数据流的发布者，使用 Flux 和 Mono 都可以发出三种数据信号：元素值、错误信号、完成信号。</strong></p>
<ul>
<li><strong>错误信号和完成信号都代表终止信号，终止信号用于告诉订阅者数据流结束了。</strong></li>
<li><strong>错误信号在终止数据流的同时，会把错误信息传递给订阅者。</strong></li>
<li><strong>错误信号和完成信号不能共存。</strong></li>
<li><strong>如果没有发送任何元素值，而是直接发送错误信号或者完成信号，表示是空数据流。</strong></li>
<li><strong>如果既没有错误信号，也没有完成信号，表示是无限数据流。</strong></li>
</ul>
</li>
<li><p>代码演示 Flux 和 和 Mono：</p>
<ul>
<li><p>第一步：引入依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：声明数据流，有以下几种方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// just方法直接声明数据流，此时没有订阅，数据是不会输出的</span></span><br><span class="line">        Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        Mono.just(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其他方法声明数据流</span></span><br><span class="line">        Integer[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">        Flux.fromArray(arr);<span class="comment">// 来自数组</span></span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;(<span class="number">5</span>);</span><br><span class="line">        Flux.fromIterable(list);<span class="comment">// 来自集合</span></span><br><span class="line"></span><br><span class="line">        Stream&lt;Integer&gt; stream = list.stream();</span><br><span class="line">        Flux.fromStream(stream);<span class="comment">// 来自流</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：订阅。<strong>调用 <code>just()</code> 或者其他方法只是声明数据流，数据流并没有发出，只有进行订阅之后才会触发数据流，不订阅什么都不会发生。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        list.add(<span class="number">4</span>);</span><br><span class="line">        list.add(<span class="number">5</span>);</span><br><span class="line">        Flux.fromIterable(list).subscribe(System.out::print);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>常用操作符：</p>
<ul>
<li><p>对数据流进行一道道操作，称为操作符，比如工厂流水线。</p>
</li>
<li><p>**<code>map()</code>**：将数据流中的每一个元素，按一定的规则映射为新元素。</p>
<img src="/2021/04/23/spring-webflux/image-20210423215925415.png" alt="image-20210423215925415" style="zoom:80%;">
</li>
<li><p>**<code>flatmap()</code>**：将数据流中的每一个元素，按一定的规则转换成流，然后再把所有的流合并为一个整体的流。</p>
<img src="/2021/04/23/spring-webflux/image-20210423220045483.png" alt="image-20210423220045483" style="zoom:80%;">
</li>
<li><p>**<code>filter()</code>**：将数据流中的元素，按一定的规则进行筛选。</p>
<img src="/2021/04/23/spring-webflux/image-20210423220116869.png" alt="image-20210423220116869" style="zoom:80%;">
</li>
<li><p>**<code>zip()</code>**：将数据流中的元素，按一定的规则进行压缩。</p>
<img src="/2021/04/23/spring-webflux/image-20210423220157174.png" alt="image-20210423220157174" style="zoom:80%;">

</li>
</ul>
</li>
</ul>
<h2 id="Spring-WebFlux-的执行流程和核心-API"><a href="#Spring-WebFlux-的执行流程和核心-API" class="headerlink" title="Spring WebFlux 的执行流程和核心 API"></a>Spring WebFlux 的执行流程和核心 API</h2><ul>
<li><p>Spring WebFlux 基于 Reactor，默认使用的容器是 Netty，Netty 是一个高性能的异步非阻塞的 NIO 框架。</p>
<ul>
<li><p>BIO：阻塞方式。</p>
<p><img src="/2021/04/23/spring-webflux/image-20210423220910001.png" alt="image-20210423220910001"></p>
</li>
<li><p>NIO：非阻塞方式。</p>
<p><img src="/2021/04/23/spring-webflux/image-20210423220943660.png" alt="image-20210423220943660"></p>
<ul>
<li>Channel：通道；Register：注册；Selector：选择器。</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring WebFlux 执行过程和 Spring MVC 相似。</p>
<ul>
<li><p>Spring MVC 的核心控制器是 DispatcherServlet，Spring WebFlux 的核心控制器是 DispatcherHandler，DispatcherHandler 实现了 WebHandler 接口，重写了 <code>handle()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Handle the web server exchange.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> exchange the current server exchange</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> Mono&lt;Void&gt;&#125; to indicate when request handling is complete</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> createNotFoundError();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.handlerMappings)</span><br><span class="line">         .concatMap(mapping -&gt; mapping.getHandler(exchange))</span><br><span class="line">         .next()</span><br><span class="line">         .switchIfEmpty(createNotFoundError())</span><br><span class="line">         .flatMap(handler -&gt; invokeHandler(exchange, handler))</span><br><span class="line">         .flatMap(result -&gt; handleResult(exchange, result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>exchange：放 http 请求响应的信息。</li>
<li><code>mapping.getHandler(exchange)</code>：根据 http 请求地址获得其对应的 handlerMapping。</li>
<li><code>invokeHandler(exchange, handler)</code>：调用具体的业务方法处理 http 请求。</li>
<li><code>handleResult(exchange, result))</code>：返回处理的结果。</li>
</ul>
</li>
<li><p>Spring WebFlux 除了 DispatcherHandler 组件外，还有其他几个重要的组件：</p>
<ul>
<li>DispatcherHandler：负责请求的处理。</li>
<li>HandlerMapping：负责查询请求对应的处理的方法。</li>
<li>HandlerAdapter：负责请求处理的实际的业务。</li>
<li>HandlerResultHandler：负责响应结果的处理。</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring WebFlux 实现函数式编程，依赖于两个接口：RouterFunction (负责路由处理) 和 HandlerFunction (负责处理函数)。</p>
</li>
</ul>
<h2 id="Spring-WebFlux-实现"><a href="#Spring-WebFlux-实现" class="headerlink" title="Spring WebFlux 实现"></a>Spring WebFlux 实现</h2><ul>
<li><p>Spring MVC 方式实现，是同步阻塞的方式，基于 Spring MVC + Servlet + Tomcat。</p>
</li>
<li><p>Spring WebFlux 方式实现，是异步非阻塞的方式，基于 Spring WebFlux + Reactor + Netty。</p>
</li>
<li><p><strong>基于注解编程模型</strong></p>
<ul>
<li><p>第一步：创建 Spring Boot 工程，引入 Spring WebFlux 依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.xisun.spring.webflux<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xisun-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xisun-webflux<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：打开 application.properties 配置文件，配置启动端口号。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8081</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：创建包和相关类。</p>
<ul>
<li><p>entity 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/24 10:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, String gender, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGender</span><span class="params">(String gender)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = (User) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(name, user.name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(gender, user.gender)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(age, user.age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (gender != <span class="keyword">null</span> ? gender.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + (age != <span class="keyword">null</span> ? age.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, gender=&#x27;&quot;</span> + gender + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>dao 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据id查询用户</span></span><br><span class="line">    <span class="function">User <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="function">String <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建map集合存储数据，代替从数据库查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, User&gt; users = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">1</span>, <span class="keyword">new</span> User(<span class="string">&quot;Lucy&quot;</span>, <span class="string">&quot;male&quot;</span>, <span class="number">20</span>));</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">2</span>, <span class="keyword">new</span> User(<span class="string">&quot;Mary&quot;</span>, <span class="string">&quot;female&quot;</span>, <span class="number">30</span>));</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">3</span>, <span class="keyword">new</span> User(<span class="string">&quot;Jack&quot;</span>, <span class="string">&quot;male&quot;</span>, <span class="number">50</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dao: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.users.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        Collection&lt;User&gt; values = <span class="keyword">this</span>.users.values();</span><br><span class="line">        userList.addAll(values);</span><br><span class="line">        <span class="keyword">return</span> userList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="keyword">this</span>.users.size() + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.users.put(id, user);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.users);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据id查询用户</span></span><br><span class="line">    <span class="function">Mono&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户</span></span><br><span class="line">    <span class="function">Flux&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="function">Mono&lt;String&gt; <span class="title">saveUser</span><span class="params">(Mono&lt;User&gt; user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service: &quot;</span> + id);</span><br><span class="line">        User user = userDao.getUserById(id);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; allUser = userDao.getAllUser();</span><br><span class="line">        <span class="keyword">return</span> Flux.fromIterable(allUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">saveUser</span><span class="params">(Mono&lt;User&gt; userMono)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// return userMono.doOnNext(person -&gt; userDao.saveUser(person)).thenEmpty(Mono.empty());// 返回 Mono&lt;Void&gt;</span></span><br><span class="line">        <span class="keyword">return</span> userMono.map(user -&gt; userDao.saveUser(user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据id查询用户</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getUserById/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;controller: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> userService.getUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getAllUser&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getAllUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/saveUserMessage&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;save user: &quot;</span> + user);</span><br><span class="line">        <span class="keyword">return</span> userService.saveUser(Mono.just(user));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>main 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XisunWebfluxApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(XisunWebfluxApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>整体结构：</p>
<p><img src="/2021/04/23/spring-webflux/image-20210424185319673.png" alt="image-20210424185319673"></p>
</li>
<li><p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | &#x27;</span>_ | <span class="string">&#x27;_| | &#x27;</span>_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::                (v2.4.5)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2021-04-24 18:54:21.418  INFO 4836 --- [           main] c.x.s.w.x.XisunWebfluxApplication        : Starting XisunWebfluxApplication using Java 1.8.0_222 on DESKTOP-OM8IACS with PID 4836 (D:\JetBrainsWorkSpace\IDEAProjects\xisun-webflux\target\classes started by Ziyoo in D:\JetBrainsWorkSpace\IDEAProjects\xisun-webflux)</span></span><br><span class="line"><span class="string">2021-04-24 18:54:21.423  INFO 4836 --- [           main] c.x.s.w.x.XisunWebfluxApplication        : No active profile set, falling back to default profiles: default</span></span><br><span class="line"><span class="string">2021-04-24 18:54:22.719  INFO 4836 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port 8081</span></span><br><span class="line"><span class="string">2021-04-24 18:54:22.730  INFO 4836 --- [           main] c.x.s.w.x.XisunWebfluxApplication        : Started XisunWebfluxApplication in 2.007 seconds (JVM running for 3.003)</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/23/spring-webflux/image-20210424185543581.png" alt="image-20210424185543581"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>基于函数式编程模型</strong></p>
<ul>
<li><p>在使用函数式编程模型操作的时候，需要自己初始化服务器。</p>
</li>
<li><p>基于函数式编程模型操作的时候，有两个核心接口：<strong>RouterFunction (实现路由功能，将请求转发给对应的 handler) 和 HandlerFunction (处理请求并生成响应的函数)。基于函数式编程模型的核心任务就是定义这两个函数式接口的实现，并且启动需要的服务器。</strong></p>
</li>
<li><p>Spring WebFlux 请求和响应不再是 ServletRequest 和 ServletResponse，而是 ServerRequest 和 ServerResponse。</p>
</li>
<li><p>第一步：创建 Spring Boot 工程，引入 Spring WebFlux 依赖。</p>
</li>
<li><p>第二步：打开 application.properties 配置文件，配置启动端口号。</p>
</li>
<li><p>第三步：创建包和相关类。</p>
<ul>
<li><p>entity 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, String gender, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGender</span><span class="params">(String gender)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = (User) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(name, user.name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(gender, user.gender)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(age, user.age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (gender != <span class="keyword">null</span> ? gender.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + (age != <span class="keyword">null</span> ? age.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, gender=&#x27;&quot;</span> + gender + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>dao 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function">User <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建map集合存储数据，代替从数据库查询</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, User&gt; users = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">1</span>, <span class="keyword">new</span> User(<span class="string">&quot;Lucy&quot;</span>, <span class="string">&quot;male&quot;</span>, <span class="number">20</span>));</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">2</span>, <span class="keyword">new</span> User(<span class="string">&quot;Mary&quot;</span>, <span class="string">&quot;female&quot;</span>, <span class="number">30</span>));</span><br><span class="line">        <span class="keyword">this</span>.users.put(<span class="number">3</span>, <span class="keyword">new</span> User(<span class="string">&quot;Jack&quot;</span>, <span class="string">&quot;male&quot;</span>, <span class="number">50</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dao: &quot;</span> + id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.users.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        Collection&lt;User&gt; values = <span class="keyword">this</span>.users.values();</span><br><span class="line">        userList.addAll(values);</span><br><span class="line">        <span class="keyword">return</span> userList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="keyword">this</span>.users.size() + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.users.put(id, user);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.users);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据id查询用户</span></span><br><span class="line">    <span class="function">Mono&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户</span></span><br><span class="line">    <span class="function">Flux&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">saveUser</span><span class="params">(Mono&lt;User&gt; user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserDao userDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">getUserById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service: &quot;</span> + id);</span><br><span class="line">        User user = userDao.getUserById(id);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; allUser = userDao.getAllUser();</span><br><span class="line">        <span class="keyword">return</span> Flux.fromIterable(allUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">saveUser</span><span class="params">(Mono&lt;User&gt; userMono)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// return userMono.map(user -&gt; userDao.saveUser(user));</span></span><br><span class="line">        <span class="keyword">return</span> userMono.doOnNext(person -&gt; userDao.saveUser(person)).thenEmpty(Mono.empty());<span class="comment">// 返回 Mono&lt;Void&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 Handler (具体实现方法)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserHandle</span><span class="params">(UserService userService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据id查询用户</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">getUserById</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取路径中的id值，返回的是String</span></span><br><span class="line">        <span class="keyword">int</span> userId = Integer.parseInt(request.pathVariable(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        <span class="comment">// 可能查询不到用户，进行空值处理</span></span><br><span class="line">        Mono&lt;ServerResponse&gt; notFound = ServerResponse.notFound().build();</span><br><span class="line">        <span class="comment">// 调用userService的方法查询用户</span></span><br><span class="line">        Mono&lt;User&gt; userMono = userService.getUserById(userId);</span><br><span class="line">        <span class="comment">// 把userMono进行转换，返回Mono&lt;ServerResponse&gt;</span></span><br><span class="line">        <span class="keyword">return</span> userMono.flatMap(user -&gt;</span><br><span class="line">                ServerResponse</span><br><span class="line">                        .ok()</span><br><span class="line">                        .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                        .body(BodyInserters.fromObject(user))</span><br><span class="line">                        .switchIfEmpty(notFound));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询所有用户，ServerRequest参数即使不用，也要添加，否则在Server中会找不到这个方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">getAllUsers</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用userService的方法查询所有用户</span></span><br><span class="line">        Flux&lt;User&gt; userFlux = userService.getAllUser();</span><br><span class="line">        <span class="keyword">return</span> ServerResponse</span><br><span class="line">                .ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(userFlux, User.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加用户</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">saveUser</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从请求中拿到user对象</span></span><br><span class="line">        Mono&lt;User&gt; userMono = request.bodyToMono(User.class);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse</span><br><span class="line">                .ok()</span><br><span class="line">                .build(userService.saveUser(userMono));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第四步：初始化服务器，编写 Router。</p>
<ul>
<li><p>创建路由，创建服务器完成适配。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建Router路由</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">routingFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建hanler对象(@Repository这些注解无效，需手动注入dao和service，是否有其他方法？)</span></span><br><span class="line">        UserDaoImpl userDao = <span class="keyword">new</span> UserDaoImpl();</span><br><span class="line">        UserService userService = <span class="keyword">new</span> UserServiceImpl(userDao);</span><br><span class="line">        UserHandler handler = <span class="keyword">new</span> UserHandler(userService);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置路由</span></span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">                .route(RequestPredicates.GET(<span class="string">&quot;/getUserById/&#123;id&#125;&quot;</span>)</span><br><span class="line">                        .and(RequestPredicates.accept(MediaType.APPLICATION_JSON)), handler::getUserById)</span><br><span class="line">                .andRoute(RequestPredicates.GET(<span class="string">&quot;/getAllUser&quot;</span>)</span><br><span class="line">                        .and(RequestPredicates.accept(MediaType.APPLICATION_JSON)), handler::getAllUser)</span><br><span class="line">                .andRoute(RequestPredicates.POST(<span class="string">&quot;/saveUserMessage&quot;</span>)</span><br><span class="line">                        .and(RequestPredicates.accept(MediaType.APPLICATION_JSON)), handler::saveUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建服务器完成适配</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createReactorServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 路由和handler适配</span></span><br><span class="line">        RouterFunction&lt;ServerResponse&gt; route = routingFunction();</span><br><span class="line">        HttpHandler httpHandler = RouterFunctions.toHttpHandler(route);</span><br><span class="line">        ReactorHttpHandlerAdapter adapter = <span class="keyword">new</span> ReactorHttpHandlerAdapter(httpHandler);</span><br><span class="line">        <span class="comment">// 创建服务器</span></span><br><span class="line">        HttpServer httpServer = HttpServer.create();</span><br><span class="line">        httpServer.handle(adapter).bindNow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.最终调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Server server = <span class="keyword">new</span> Server();</span><br><span class="line">        server.createReactorServer();</span><br><span class="line">        System.out.println(<span class="string">&quot;enter to exit&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终调用：启动 main 方法，并在网页上输入地址进行测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.306</span> [main] DEBUG reactor.util.Loggers - Using Slf4j logging framework</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.726</span> [main] DEBUG org.springframework.web.server.adapter.HttpWebHandlerAdapter - enableLoggingRequestDetails=<span class="string">&#x27;false&#x27;</span>: form data and headers will be masked to prevent unsafe logging of potentially sensitive data</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.785</span> [main] DEBUG io.netty.util.internal.logging.InternalLoggerFactory - Using SLF4J as the <span class="keyword">default</span> logging framework</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.786</span> [main] DEBUG io.netty.util.internal.PlatformDependent - Platform: Windows</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.792</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - -Dio.netty.noUnsafe: <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.792</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - Java version: <span class="number">8</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.794</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - sun.misc.Unsafe.theUnsafe: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.796</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - sun.misc.Unsafe.copyMemory: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.799</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - java.nio.Buffer.address: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.800</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - direct buffer constructor: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.802</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - java.nio.Bits.unaligned: available, <span class="keyword">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.802</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - jdk.internal.misc.Unsafe.allocateUninitializedArray(<span class="keyword">int</span>): unavailable prior to Java9</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.802</span> [main] DEBUG io.netty.util.internal.PlatformDependent0 - java.nio.DirectByteBuffer.&lt;init&gt;(<span class="keyword">long</span>, <span class="keyword">int</span>): available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.802</span> [main] DEBUG io.netty.util.internal.PlatformDependent - sun.misc.Unsafe: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.804</span> [main] DEBUG io.netty.util.internal.PlatformDependent - -Dio.netty.tmpdir: C:\Users\Ziyoo\AppData\Local\Temp (java.io.tmpdir)</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.805</span> [main] DEBUG io.netty.util.internal.PlatformDependent - -Dio.netty.bitMode: <span class="number">64</span> (sun.arch.data.model)</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.808</span> [main] DEBUG io.netty.util.internal.PlatformDependent - -Dio.netty.maxDirectMemory: <span class="number">1653604352</span> bytes</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.809</span> [main] DEBUG io.netty.util.internal.PlatformDependent - -Dio.netty.uninitializedArrayAllocationThreshold: -<span class="number">1</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.810</span> [main] DEBUG io.netty.util.internal.CleanerJava6 - java.nio.ByteBuffer.cleaner(): available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.811</span> [main] DEBUG io.netty.util.internal.PlatformDependent - -Dio.netty.noPreferDirect: <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.873</span> [main] DEBUG io.netty.util.ResourceLeakDetector - -Dio.netty.leakDetection.level: simple</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.873</span> [main] DEBUG io.netty.util.ResourceLeakDetector - -Dio.netty.leakDetection.targetRecords: <span class="number">4</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.911</span> [main] DEBUG reactor.netty.tcp.TcpResources - [http] resources will use the <span class="keyword">default</span> LoopResources: DefaultLoopResources &#123;prefix=reactor-http, daemon=<span class="keyword">true</span>, selectCount=<span class="number">8</span>, workerCount=<span class="number">8</span>&#125;</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.911</span> [main] DEBUG reactor.netty.tcp.TcpResources - [http] resources will use the <span class="keyword">default</span> ConnectionProvider: reactor.netty.resources.DefaultPooledConnectionProvider@<span class="number">5552768</span>b</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">43.913</span> [main] DEBUG reactor.netty.resources.DefaultLoopIOUring - Default io_uring support : <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.117</span> [main] DEBUG reactor.netty.resources.DefaultLoopEpoll - Default Epoll support : <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.118</span> [main] DEBUG reactor.netty.resources.DefaultLoopKQueue - Default KQueue support : <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.125</span> [main] DEBUG io.netty.channel.MultithreadEventLoopGroup - -Dio.netty.eventLoopThreads: <span class="number">16</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.154</span> [main] DEBUG io.netty.util.internal.InternalThreadLocalMap - -Dio.netty.threadLocalMap.stringBuilder.initialSize: <span class="number">1024</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.154</span> [main] DEBUG io.netty.util.internal.InternalThreadLocalMap - -Dio.netty.threadLocalMap.stringBuilder.maxSize: <span class="number">4096</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.161</span> [main] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.noKeySetOptimization: <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.161</span> [main] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.selectorAutoRebuildThreshold: <span class="number">512</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.170</span> [main] DEBUG io.netty.util.internal.PlatformDependent - org.jctools-core.MpscChunkedArrayQueue: available</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.218</span> [main] DEBUG io.netty.channel.DefaultChannelId - -Dio.netty.processId: <span class="number">7052</span> (auto-detected)</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.221</span> [main] DEBUG io.netty.util.NetUtil - -Djava.net.preferIPv4Stack: <span class="keyword">false</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.221</span> [main] DEBUG io.netty.util.NetUtil - -Djava.net.preferIPv6Addresses: <span class="keyword">false</span></span><br><span class="line">09:45:44.317 [main] DEBUG io.netty.util.NetUtilInitializations - Loopback interface: lo (Software Loopback Interface 1, 127.0.0.1)</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.318</span> [main] DEBUG io.netty.util.NetUtil - Failed to get SOMAXCONN from sysctl and file \proc\sys\net\core\somaxconn. Default: <span class="number">200</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.432</span> [main] DEBUG io.netty.channel.DefaultChannelId - -Dio.netty.machineId: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ff:fe:c0:<span class="number">00</span>:<span class="number">08</span> (auto-detected)</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numHeapArenas: <span class="number">16</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numDirectArenas: <span class="number">16</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.pageSize: <span class="number">8192</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxOrder: <span class="number">11</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.chunkSize: <span class="number">16777216</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.smallCacheSize: <span class="number">256</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.normalCacheSize: <span class="number">64</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedBufferCapacity: <span class="number">32768</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimInterval: <span class="number">8192</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimIntervalMillis: <span class="number">0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.useCacheForAllThreads: <span class="keyword">true</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.457</span> [main] DEBUG io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedByteBuffersPerChunk: <span class="number">1023</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.466</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.allocator.type: pooled</span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.466</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.threadLocalDirectBufferSize: <span class="number">0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.466</span> [main] DEBUG io.netty.buffer.ByteBufUtil - -Dio.netty.maxThreadLocalCharBufferSize: <span class="number">16384</span></span><br><span class="line"><span class="number">09</span>:<span class="number">45</span>:<span class="number">44.589</span> [reactor-http-nio-<span class="number">1</span>] DEBUG reactor.netty.transport.ServerTransport - [id:ae5a7227, L:/<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">0</span>:<span class="number">11779</span>] Bound <span class="keyword">new</span> server</span><br><span class="line">enter to exit</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p><img src="/2021/04/23/spring-webflux/image-20210425094903417.png" alt="image-20210425094903417"></p>
</li>
<li><p>除了上面的调用方式，也可以使用 WebClient 调用，这个不需要在浏览器中输入地址，可以直接在本地进行模拟测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先启动Server，查看端口，然后调用服务器的地址</span></span><br><span class="line">        WebClient webClient = WebClient.create(<span class="string">&quot;http://127.0.0.1:12009&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据id查询</span></span><br><span class="line">        String id = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        User user = webClient.get().uri(<span class="string">&quot;/getUserById/&#123;id&#125;&quot;</span>, id)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON).retrieve().bodyToMono(User.class).block();</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询所有</span></span><br><span class="line">        Flux&lt;User&gt; users = webClient.get().uri(<span class="string">&quot;/getAllUser&quot;</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON).retrieve().bodyToFlux(User.class);</span><br><span class="line">        <span class="comment">// 打印每一个User的名字</span></span><br><span class="line">        users.map(User::getName).buffer().doOnNext(System.out::println).blockFirst();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：需要先启动 Server，然后查询端口号，设置 WebClient 的地址，然后启动 Client，即可在控制台查询相应操作的输出结果。</p>
</blockquote>
</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Vf4y127N5">https://www.bilibili.com/video/BV1Vf4y127N5</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/13/tool-idea/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/13/tool-idea/" class="post-title-link" itemprop="url">IDEA 快捷键</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-13 20:38:59" itemprop="dateCreated datePublished" datetime="2021-04-13T20:38:59+08:00">2021-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-05 15:56:25" itemprop="dateModified" datetime="2021-07-05T15:56:25+08:00">2021-07-05</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>145</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ctrl + H：查看类的继承层级关系</p>
<p>ctrl + alt + B：查找接口的实现类</p>
<p>ctrl + alt + S：打开 settings</p>
<p>ctrl + alt + T：对一段代码添加包围语句，如 try/catch。</p>
<p>ctrl + Y：删除当前行</p>
<p>ctrl + D：复制当前行</p>
<p>shift + F6：重命名</p>
<p>ctrl + F：查找</p>
<p>ctrl + R：替换</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/13/spring-base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/13/spring-base/" class="post-title-link" itemprop="url">Spring5 入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-13 13:09:15" itemprop="dateCreated datePublished" datetime="2021-04-13T13:09:15+08:00">2021-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-09 14:22:20" itemprop="dateModified" datetime="2021-07-09T14:22:20+08:00">2021-07-09</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>116k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:45</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Spring-框架概述"><a href="#Spring-框架概述" class="headerlink" title="Spring 框架概述"></a>Spring 框架概述</h2><ul>
<li><p>Spring 官网：<a target="_blank" rel="noopener" href="https://spring.io/">https://spring.io/</a></p>
</li>
<li><p>Spring 各版本源码下载地址：<a target="_blank" rel="noopener" href="https://repo.spring.io/release/org/springframework/spring/">https://repo.spring.io/release/org/springframework/spring/</a></p>
</li>
<li><p>Spring 官方文档：</p>
<ul>
<li>全部版本：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/">https://docs.spring.io/spring-framework/docs/</a></li>
<li>5.2.7.RELEASE：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.2.7.RELEASE/spring-framework-reference/">https://docs.spring.io/spring-framework/docs/5.2.7.RELEASE/spring-framework-reference/</a></li>
<li>Spring Framework 5 中文文档：<a target="_blank" rel="noopener" href="https://cntofu.com/book/95/index.html">https://cntofu.com/book/95/index.html</a></li>
</ul>
</li>
<li><p>Spring 是轻量级的开源的 JavaEE 框架。</p>
</li>
<li><p>Spring 可以解决企业应用开发的复杂性。</p>
</li>
<li><p><strong>Spring 两个核心部分：IOC 和 AOP。</strong></p>
<ul>
<li><strong>IOC：Inversion of Control，即控制反转。是面向对象编程中的一种设计原则，可以用来降低计算机代码之间的耦合度，其中最常见的方式叫做依赖注入 (Dependency Injection，简称 DI)。Spring 就是采用依赖注入的方式，来管理容器中的 Bean 实例对象。</strong></li>
<li><strong>AOP：Aspect Oriented Programming，即面向切面。可以在不修改源代码的前提下，通过预编译方式和运行期间动态代理方式实现对原有代码的增强 (添加新功能)。</strong></li>
</ul>
</li>
<li><p>Spring 特点：</p>
<ul>
<li>方便解耦，简化开发。</li>
<li>AOP 编程支持。</li>
<li>方便程序测试。</li>
<li>方便和其他框架进行整合。</li>
<li>方便进行事务操作。</li>
<li>降低 API 开发难度。</li>
</ul>
</li>
<li><p>Spring 模块：</p>
<p><img src="/2021/04/13/spring-base/Spring5%E6%A8%A1%E5%9D%97.bmp" alt="Spring5模块"></p>
</li>
</ul>
<h2 id="Spring-入门案例"><a href="#Spring-入门案例" class="headerlink" title="Spring 入门案例"></a>Spring 入门案例</h2><ul>
<li><p>创建一个 Maven 工程。</p>
</li>
<li><p>引入依赖：<code>spring-beans</code>、<code>spring-context</code>、<code>spring-core</code>、<code>spring-expression</code>，另外，Spring 还需依赖 <code>commons-logging</code> 实现日志功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring核心依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这个依赖好像不需要 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>引入 <code>spring-context</code> 依赖时，会一并将其他几个依赖引入：</p>
<p><img src="/2021/04/13/spring-base/image-20210413153347997.png" alt="image-20210413153347997"></p>
</li>
</ul>
</li>
<li><p>创建 Bean 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer studentId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String studentName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(Integer studentId, String studentName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.studentId = studentId;</span><br><span class="line">        <span class="keyword">this</span>.studentName = studentName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getStudentId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> studentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStudentId</span><span class="params">(Integer studentId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.studentId = studentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStudentName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> studentName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStudentName</span><span class="params">(String studentName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.studentName = studentName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;studentId=&quot;</span> + studentId +</span><br><span class="line">                <span class="string">&quot;, studentName=&#x27;&quot;</span> + studentName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 Spring 配置文件：Spring 配置文件使用 xml 格式。</p>
<ul>
<li><p>在 resources 包下点击鼠标右键，选择【New】–&gt;【XML Configuration File】–&gt;【Spring Config】，输入配置文件名 (自定义) 创建。注：resource 包下的配置文件在执行时会被拷贝至类路径的根目录。</p>
<img src="/2021/04/13/spring-base/image-20210413153751219.png" alt="image-20210413153751219" style="zoom:80%;">
</li>
<li><p>在配置文件中添加如下配置：使用 &lt;bean&gt; 标签创建 Student 对象的实例，并注入属性的默认值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 使用bean元素定义一个由IOC容器创建的对象 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- id属性指定用于引用bean实例的标识 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- class属性指定用于创建bean的全类名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用property子元素为bean的属性赋值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;007&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>编写测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象</span></span><br><span class="line">        Student student = iocContainer.getBean(<span class="string">&quot;student&quot;</span>, Student.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(student);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>输出结果：</p>
<p><img src="/2021/04/13/spring-base/image-20210413155020623.png" alt="image-20210413155020623"></p>
</li>
</ul>
</li>
<li><p>测试说明：Spring 在创建 IOC 容器时，就已经完成了 Bean 的创建和属性的赋值。</p>
</li>
</ul>
<h2 id="Spring-基本语法"><a href="#Spring-基本语法" class="headerlink" title="Spring 基本语法"></a>Spring 基本语法</h2><h3 id="SqEL-表达式语言"><a href="#SqEL-表达式语言" class="headerlink" title="SqEL 表达式语言"></a>SqEL 表达式语言</h3><ul>
<li><p>SpEL 的全称是 Spring Expression Language，即 Spring 表达式语言，简称 SpEL，支持运行时查询并可以操作对象图，和 JSP 页面上的 EL 表达式、Struts2 中用到的 OGNL 表达式一样，SpEL 根据 JavaBean 风格的 <code>getXxx()</code>、<code>setXxx()</code> 方法定义的属性访问对象图，完全符合我们熟悉的操作习惯。</p>
</li>
<li><p>基本语法：</p>
<ul>
<li>SpEL 使用 <code>#&#123;…&#125;</code>作为定界符，所有在大框号中的字符都将被认为是 SpEL 表达式。</li>
</ul>
</li>
<li><p>字面量：</p>
<ul>
<li>整数：<code>&lt;property name=&quot;count&quot; value=&quot;#&#123;5&#125;&quot;/&gt;</code></li>
<li>小数：<code>&lt;property name=&quot;frequency&quot; value=&quot;#&#123;89.7&#125;&quot;/&gt;</code></li>
<li>科学计数法：<code>&lt;property name=&quot;capacity&quot; value=&quot;#&#123;1e4&#125;&quot;/&gt;</code></li>
<li>String 类型的字面量可以使用单引号或者双引号作为字符串的定界符号：<ul>
<li><code>&lt;property name=&quot;name&quot; value=&quot;#&#123;&#39;xisun&#39;&#125;&quot;/&gt;</code></li>
<li><code>&lt;property name=&#39;name&#39; value=&#39;#&#123;&quot;xisun&quot;&#125;&#39;/&gt;</code></li>
</ul>
</li>
<li>Boolean：<code>&lt;property name=&quot;enabled&quot; value=&quot;#&#123;false&#125;&quot;/&gt;</code></li>
</ul>
</li>
<li><p>引用其他 Bean：</p>
<ul>
<li><p>在 &lt;bean&gt; 标签的 value 属性中通过 <code>#&#123;对象名&#125;</code> 引用其他 Bean，注意：不能使用 ref 属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引用其他Bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;233&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computer&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;computer&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;computer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Computer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;666&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HP&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>引用其他 Bean 的属性:</p>
<ul>
<li><p>在 &lt;property&gt; 标签中通过 <code>#&#123;对象名.属性名&#125;</code> 引用其他 Bean 的属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引用其他Bean的属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;233&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computer&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Computer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;computer.computerId&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;computer.computerName&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;computer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Computer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;666&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HP&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>调用非静态方法：</p>
<ul>
<li><p>通过 <code>#&#123;对象名.方法名&#125;</code> 调用对象的非静态方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 调用非静态方法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;233&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Oneby&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Computer&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;computer.getComputerId()&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;computer.getComputerName()&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;computer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Computer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;666&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;computerName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;HP&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>调用静态方法：</p>
<ul>
<li><p>通过 <code>T(静态类路径).方法名</code> 调用静态方法。举例：定义获取随机整数的方法，随机整数的范围为 [start, end]。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRandomInt</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (Math.random() * (end - start + <span class="number">1</span>) + start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 调用静态方法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.entity.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(cn.xisun.spring.util.MathUtil).getRandomInt(0, 255)&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="Spring-中多个配置文件的整合"><a href="#Spring-中多个配置文件的整合" class="headerlink" title="Spring 中多个配置文件的整合"></a>Spring 中多个配置文件的整合</h3><ul>
<li><p>Spring 允许通过 &lt;import&gt; 标签将多个配置文件引入到一个文件中，进行配置文件的集成。这样在启动 Spring 容器时，仅需要指定这个合并好的配置文件就可以。</p>
</li>
<li><p>&lt;import&gt; 标签的 resource 属性支持 Spring 的标准的路径资源：</p>
<p><img src="/2021/04/13/spring-base/image-20210416115055805.png" alt="image-20210416115055805"></p>
</li>
</ul>
<h3 id="Application-context-not-configured-for-this-file"><a href="#Application-context-not-configured-for-this-file" class="headerlink" title="Application context not configured for this file"></a>Application context not configured for this file</h3><ul>
<li><p>IDEA 中，对于 Spring 的配置类或配置文件，可能会提示 <code>Application context not configured for this file</code>，大概意思就是没有将该配置类或配置文件配置到项目中。</p>
</li>
<li><p>解决办法：</p>
<img src="/2021/04/13/spring-base/image-20210625155355898.png" alt="image-20210625155355898" style="zoom:80%;">

<img src="/2021/04/13/spring-base/image-20210625155515773.png" alt="image-20210625155515773" style="zoom:80%;">

<img src="/2021/04/13/spring-base/image-20210625155637715.png" alt="image-20210625155637715" style="zoom:80%;">

</li>
</ul>
<h2 id="Spring-中的-Bean"><a href="#Spring-中的-Bean" class="headerlink" title="Spring 中的 Bean"></a>Spring 中的 Bean</h2><h3 id="Spring-中-Bean-的类型"><a href="#Spring-中-Bean-的类型" class="headerlink" title="Spring 中 Bean 的类型"></a>Spring 中 Bean 的类型</h3><ul>
<li><p><strong>Spring 内置了两种类型的 Bean ，一种是普通 Bean ，另外一种是工厂 Bean (FactoryBean)。</strong></p>
</li>
<li><p>普通 Bean：在配置文件中定义的 Bean 类型与返回类型一致。这种最常见。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBook&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;三体&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        Book book = iocContainer.getBean(<span class="string">&quot;myBook&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置文件中定义的 Bean 类型是 Book，实际返回的类型也是 Book。</p>
</blockquote>
</li>
<li><p>工厂 Bean：在配置文件中定义的 Bean 类型可以和返回类型不一样。</p>
<ul>
<li><p>第一步：创建类，实现 FactoryBean 接口，让这个类作为工厂 Bean。</p>
<ul>
<li><p>FactoryBean 接口中有如下三个方法：<code>getObject()</code> 负责将创建好的 Bean 实例返回给 IOC 容器；<code>getObjectType()</code> 负责返回工厂生产的 Bean 类型；<code>isSingleton()</code> 用于指示该 Bean 实例是否为单例，默认是单例 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    String OBJECT_TYPE_ATTRIBUTE = <span class="string">&quot;factoryBeanObjectType&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第二步：实现接口里面的方法，在实现的方法中定义返回的 Bean 类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthor</span><span class="params">(String author)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, author=&#x27;&quot;</span> + author + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Book</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 在getObject()方法中定义返回的Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setName(<span class="string">&quot;三体&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Book.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：在 Spring 配置文件中进行配置并测试，注意获取 Bean 的时候要使用工厂 Bean 返回的那个 Bean 的类型。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.factory.MyFactoryBean&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        Book book = iocContainer.getBean(<span class="string">&quot;myBean&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置文件中定义的 Bean 类型是 MyFactoryBean，但实际返回的类型是 Book。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="Spring-中-Bean-的作用域"><a href="#Spring-中-Bean-的作用域" class="headerlink" title="Spring 中 Bean 的作用域"></a>Spring 中 Bean 的作用域</h3><ul>
<li><p>默认情况下，Spring 只为每个在 IOC 容器里声明的 Bean 创建唯一一个实例 (单例对象)，整个 IOC 容器范围内都能共享该实例：所有后续的 <code>getBean()</code> 调用和 Bean 引用都将返回这个唯一的 Bean 实例。<strong>该作用域被称为 singleton，它是所有 Bean 的默认作用域。</strong></p>
</li>
<li><p>在 Spring 中，可以在 &lt;bean&gt; 标签的 scope 属性里设置 Bean 的作用域，以决定这个 Bean 是单实例的还是多实例的。scope 属性值有四个：</p>
<ul>
<li><p><strong>singleton</strong>：在 Spring IOC 容器中仅存在一个 Bean 实例，Bean 以<strong>单实例</strong>的方式存在。默认值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;平凡的世界&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;路遥&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        Book book = iocContainer.getBean(<span class="string">&quot;book&quot;</span>, Book.class);</span><br><span class="line">        Book book1 = iocContainer.getBean(<span class="string">&quot;book&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book == book1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>输出结果是 true，说明 book 和 book1 的地址一样，二者指向同一个对象。</p>
</blockquote>
</li>
<li><p><strong>prototype</strong>：每次调用 <code>getBean()</code> 时都会返回一个新的实例，Bean 以<strong>多实例</strong>的方式存在。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;平凡的世界&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;路遥&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的Bean实例对象，要求使用返回的Bean的类型</span></span><br><span class="line">        Book book = iocContainer.getBean(<span class="string">&quot;book&quot;</span>, Book.class);</span><br><span class="line">        Book book1 = iocContainer.getBean(<span class="string">&quot;book&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book == book1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>输出结果是 false，说明 book 和 book1 的地址不一样，二者指向不同的对象。</p>
</blockquote>
</li>
<li><p><strong>设置 scope 值是 singleton 时候，加载 Spring 配置文件时候就会创建单实例对象；设置 scope 值是 prototype 时候，不是在加载 Spring 配置文件的时候创建对象，而是在调用 <code>getBean()</code> 时创建多实例对象。</strong></p>
</li>
<li><p>request 和 session 不常用。</p>
</li>
</ul>
</li>
</ul>
<h3 id="Spring-中-Bean-的生命周期"><a href="#Spring-中-Bean-的生命周期" class="headerlink" title="Spring 中 Bean 的生命周期"></a>Spring 中 Bean 的生命周期</h3><ul>
<li><p>生命周期：一个对象从创建到销毁的过程，是这个对象的生命周期。</p>
</li>
<li><p>Spring IOC 容器可以管理 Bean 的生命周期，Spring 允许在 Bean 生命周期内特定的时间点执行指定的任务。Spring IOC 容器对 Bean 的生命周期进行管理的过程：</p>
<ul>
<li><p><strong>1. 通过构造器或工厂方法创建 Bean 实例。</strong></p>
</li>
<li><p><strong>2. 为 Bean 的属性设置值和对其他 Bean 的引用。</strong></p>
</li>
<li><p><strong>3. 调用 Bean 的初始化方法 (需要创建和配置初始化的方法)。</strong></p>
</li>
<li><p><strong>4. 获取 Bean 实例并使用。</strong></p>
</li>
<li><p><strong>5. 当容器关闭时，调用 Bean 的销毁方法 (需要创建和配置销毁的方法)。</strong></p>
</li>
<li><p>代码演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一步：执行无参数构造方法创建bean实例&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二步：调用setter方法设置属性值&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建执行的初始化的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第三步：执行初始化的方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建执行的销毁的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第五步：执行销毁的方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在&lt;bean&gt;标签中指定book实例的init-method属性(初始化方法)和destroy-method属性(销毁方法) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initMethod&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyMethod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;平凡的世界&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>​```java<br>  public class SpringTest {</p>
<pre><code>  public static void main(String[] args) &#123;
      // 1.加载Spring配置文件，创建IOC容器对象
      ApplicationContext iocContainer = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);

      // 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型
      System.out.println(&quot;第四步：获取创建的bean实例对象&quot;);
      Book book = iocContainer.getBean(&quot;book&quot;, Book.class);

      // 3.打印bean
      System.out.println(book);

      // 手动销毁bean的实例，会调用Book中定义的destroyMethod()，前提：在Spring配置文件中bean标签配置了destroy-method
      // ApplicationContext接口没有close()，需要它的子接口或实现类才能调用
      ((ClassPathXmlApplicationContext)iocContainer).close();
  &#125;</code></pre>
<p>  }<br>  输出结果：<br>  第一步：执行无参数构造方法创建bean实例<br>  第二步：调用setter方法设置属性值<br>  第三步：执行初始化的方法<br>  第四步：获取创建的bean实例对象<br>  Book{name=’平凡的世界’}<br>  第五步：执行销毁的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  &gt;注意：要手动关闭 IOC 容器才会执行 destroy-method 方法。</span><br><span class="line"></span><br><span class="line">- Spring 中可以设置 Bean **后置处理器**：</span><br><span class="line"></span><br><span class="line">  - Bean 后置处理器允许在调用初始化方法前后对 Bean 进行额外的处理。</span><br><span class="line">  - Bean 后置处理器对 IOC 容器里的所有 Bean 实例逐一处理，而非单一实例。其典型应用是：检查 Bean 属性的正确性或根据特定的标准更改 Bean 的属性。</span><br><span class="line">  - 定义 Bean 后置处理器时需要实现接口：&#96;org.springframework.beans.factory.config.BeanPostProcessor&#96;。在 Bean 的初始化方法被调用前后，Spring 将把每个 Bean 实例分别传递给上述接口的以下两个方法：</span><br><span class="line">    - &#96;postProcessBeforeInitialization(Object, String)&#96;</span><br><span class="line">    - &#96;postProcessAfterInitialization(Object, String)&#96;</span><br><span class="line"></span><br><span class="line">- Bean 添加后置处理器后的生命周期：</span><br><span class="line"></span><br><span class="line">  - **1. 通过构造器或工厂方法创建 Bean 实例。**</span><br><span class="line"></span><br><span class="line">  - **2. 为 Bean 的属性设置值和对其他 Bean 的引用。**</span><br><span class="line"></span><br><span class="line">  - **3. 将 Bean 实例传递给 Bean 后置处理器的 &#96;postProcessBeforeInitialization()&#96;。**</span><br><span class="line"></span><br><span class="line">  - **4. 调用 Bean 的初始化方法 (需要创建和配置初始化的方法)。**</span><br><span class="line"></span><br><span class="line">  - **5. 将 Bean 实例传递给 Bean 后置处理器的 &#96;postProcessAfterInitialization()&#96;。**</span><br><span class="line"></span><br><span class="line">  - **6. 获取 Bean 实例并使用。**</span><br><span class="line"></span><br><span class="line">  - **7. 当容器关闭时，调用 Bean 的销毁方法 (需要创建和配置销毁的方法)。**</span><br><span class="line"></span><br><span class="line">  - 代码演示：</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;java</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 自定义bean后置处理器</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public class MyBeanPostProcessor implements BeanPostProcessor &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">            System.out.println(&quot;第三步：执行初始化方法之前，执行postProcessBeforeInitialization方法&quot;);</span><br><span class="line">            return bean;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        @Override</span><br><span class="line">        public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">            System.out.println(&quot;第五步：执行初始化方法之后，执行postProcessAfterInitialization方法&quot;);</span><br><span class="line">            return bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第一步：执行无参数构造方法创建bean实例&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第二步：调用setter方法设置属性值&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建执行的初始化的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第四步：执行初始化的方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建执行的销毁的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第七步：执行销毁的方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置后置处理器，适用于配置的所有的bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBeanPostProcessor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.processor.MyBeanPostProcessor&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;initMethod&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroyMethod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;平凡的世界&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        System.out.println(<span class="string">&quot;第六步：获取创建的bean实例对象&quot;</span>);</span><br><span class="line">        Book book = iocContainer.getBean(<span class="string">&quot;book&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 手动销毁bean的实例，会调用Book中定义的destroyMethod()，前提：在Spring配置文件中bean标签配置了destroy-method</span></span><br><span class="line">        <span class="comment">// ApplicationContext接口没有close()，需要它的子接口或实现类才能调用</span></span><br><span class="line">        ((ClassPathXmlApplicationContext)iocContainer).close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">第一步：执行无参数构造方法创建bean实例</span><br><span class="line">第二步：调用setter方法设置属性值</span><br><span class="line">第三步：执行初始化方法之前，执行postProcessBeforeInitialization方法</span><br><span class="line">第四步：执行初始化的方法</span><br><span class="line">第五步：执行初始化方法之后，执行postProcessAfterInitialization方法</span><br><span class="line">第六步：获取创建的bean实例对象</span><br><span class="line">Book&#123;name=<span class="string">&#x27;平凡的世界&#x27;</span>&#125;</span><br><span class="line">第七步：执行销毁的方法</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Spring-中-Bean-的自动装配"><a href="#Spring-中-Bean-的自动装配" class="headerlink" title="Spring 中 Bean 的自动装配"></a>Spring 中 Bean 的自动装配</h3><ul>
<li><p>手动装配：在配置文件中，使用 &lt;bean&gt; 标签，以 value 或 ref 的方式明确指定属性值的方式，都是手动装配。</p>
</li>
<li><p>自动装配：根据指定的装配规则 (属性名称或者属性类型)，不需要明确指定，Spring 自动将匹配的属性值注入 Bean 中。</p>
</li>
<li><p>自动装配的装配模式：</p>
<ul>
<li><p>根据类型自动装配 (byType)：将类型匹配的 Bean 作为属性注入到另一个 Bean 中。若 IOC 容器中有多个与目标 Bean 类型一致的 Bean，Spring 将无法判定哪个 Bean 最合适该属性，继而不能执行自动装配。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;department&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Department&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 不能出现两个Department类型的bean --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;bean id=&quot;department1&quot; class=&quot;cn.xisun.spring.bean.Department&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;name&quot; value=&quot;IT&quot;/&gt;</span></span><br><span class="line"><span class="comment">&lt;/bean&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    通过bean标签属性autowire，实现自动装配。</span></span><br><span class="line"><span class="comment">    autowire 属性常用两个值：</span></span><br><span class="line"><span class="comment">        byName：根据属性名称注入，要求注入值bean的id值和类对应的属性名称一样。</span></span><br><span class="line"><span class="comment">        byType：根据属性类型注入，要求配置文件中只能有一个与目标bean类型一致的bean。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Employee&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据名称自动装配 (byName)：必须将目标 Bean 的名称和属性名设置的完全相同。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;department&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Department&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    通过bean标签属性autowire，实现自动装配。</span></span><br><span class="line"><span class="comment">    autowire 属性常用两个值：</span></span><br><span class="line"><span class="comment">        byName：根据属性名称注入，要求注入值bean的id值和类对应的属性名称一样。</span></span><br><span class="line"><span class="comment">        byType：根据属性类型注入，要求配置文件中只能有一个与目标bean类型一致的bean。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Employee&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据构造器自动装配 (constructor)：当 Bean 中存在多个构造器时，此种自动装配方式将会很复杂。不推荐使用。</p>
</li>
</ul>
</li>
<li><p><strong>相对于使用注解的方式实现的自动装配，在 xml 配置文件中进行的自动装配略显笨拙，在项目中更多的是使用注解的方式实现。</strong></p>
</li>
<li><p>代码演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Department</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Department&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Department department;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDepartment</span><span class="params">(Department department)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.department = department;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Employee&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, department=&quot;</span> + department +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        Employee employee = iocContainer.getBean(<span class="string">&quot;employee&quot;</span>, Employee.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(employee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">Employee&#123;name=<span class="string">&#x27;null&#x27;</span>, department=Department&#123;name=<span class="string">&#x27;IT&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Spring-中-Bean-的配置信息的继承"><a href="#Spring-中-Bean-的配置信息的继承" class="headerlink" title="Spring 中 Bean 的配置信息的继承"></a>Spring 中 Bean 的配置信息的继承</h3><ul>
<li><p>Spring 允许继承 Bean 的配置，被继承的 Bean 称为父 Bean，继承这个父 Bean 的 Bean 称为子 Bean。子 Bean 可以从父 Bean 中继承配置，包括 Bean 的属性配置，子 Bean 也可以覆盖从父 Bean 继承过来的配置。</p>
</li>
<li><p>父 Bean 可以作为配置模板，也可以作为 Bean 实例。若只想把父 Bean 作为模板，可以设置 &lt;bean&gt; 标签的 abstract 属性为 true，这样 Spring 将不会实例化这个 Bean。</p>
</li>
<li><p>创建实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String era;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthor</span><span class="params">(String author)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEra</span><span class="params">(String era)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.era = era;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, author=&#x27;&quot;</span> + author + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">              <span class="string">&quot;, era=&#x27;&quot;</span> + era + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不使用继承配置 Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;论语&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 以下都是重复的属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;era&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋末期&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 以下都是重复的属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;era&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋末期&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>book1 和 book2 两个 Bean 的 author 和 era 两个属性的值相同，像上面的配置会有点冗余。</p>
</blockquote>
</li>
<li><p>使用配置信息的继承配置 Bean：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;论语&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 以下都是重复的属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;era&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋末期&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book2&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;book1&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 重写不同值的属性即可 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>代码演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        Book book1 = iocContainer.getBean(<span class="string">&quot;book1&quot;</span>, Book.class);</span><br><span class="line">        Book book2 = iocContainer.getBean(<span class="string">&quot;book2&quot;</span>, Book.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(book1);</span><br><span class="line">        System.out.println(book2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">Book&#123;name=<span class="string">&#x27;论语&#x27;</span>, author=<span class="string">&#x27;孔子&#x27;</span>, era=<span class="string">&#x27;春秋末期&#x27;</span>&#125;</span><br><span class="line">Book&#123;name=<span class="string">&#x27;春秋&#x27;</span>, author=<span class="string">&#x27;孔子&#x27;</span>, era=<span class="string">&#x27;春秋末期&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Spring-中-Bean-之间的依赖"><a href="#Spring-中-Bean-之间的依赖" class="headerlink" title="Spring 中 Bean 之间的依赖"></a>Spring 中 Bean 之间的依赖</h3><ul>
<li><p>有的时候创建一个 Bean 的时候，需要保证另外一个 Bean 也被创建，这时我们称前面的 Bean 对后面的 Bean 有依赖。例如：要求创建 Student 对象的时候必须创建 Book。这里需要注意的是依赖关系不等于引用关系，Student 即使依赖 Book 也可以不引用它。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 一定要创建一个book对象，否则student对象无法创建 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Student&quot;</span> <span class="attr">depends-on</span>=<span class="string">&quot;book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;论语&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;论语&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span> <span class="attr">value</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;era&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋末期&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Spring-引入外部-Properties-文件"><a href="#Spring-引入外部-Properties-文件" class="headerlink" title="Spring 引入外部 Properties 文件"></a>Spring 引入外部 Properties 文件</h3><ul>
<li><p>当 Bean 的配置信息逐渐增多时，查找和修改一些 Bean 的配置信息就变得愈加困难。这时可以将一部分信息提取到 Bean 配置文件的外部，以 properties 格式的属性文件保存起来，同时在 Bean 的配置文件中引用 properties 属性文件中的内容，从而实现一部分属性值在发生变化时仅修改 properties 属性文件即可。<strong>这种技术多用于连接数据库的基本信息的配置。</strong></p>
</li>
<li><p>引入 <code>druid</code> 依赖和 <code>mysql-connector-java</code> 驱动依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- druid连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- mysql驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件中<strong>直接配置</strong>数据库连接信息：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 直接配置数据库连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/userDb&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件中<strong>引入外部 properties 文件</strong>中单独存放的数据库连接信息：</p>
<ul>
<li><p>在类路径下创建 jdbc.properties 数据库配置文件： </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">prop.driverClass</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">prop.url</span>=<span class="string">jdbc:mysql://localhost:3306/userDb</span></span><br><span class="line"><span class="meta">prop.userName</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">prop.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件中引入 context 名称空间：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2021/04/13/spring-base/image-20210415153016737.png" alt="image-20210415153016737" style="zoom:80%;">
</li>
<li><p>通过 &lt;context:property-placeholder&gt; 标签中的 location 属性来制定配置文件的路径，<code>classpath:</code> 表示该配置文件位于类路径下，并通过 SpEL 表达式语言如 <code>$&#123;prop.userName&#125;</code> 的方式来取出配置文件中的属性值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引用外部属性文件来配置数据库连接池 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 指定properties属性文件的位置，classpath:xxx表示属性文件位于类路径下 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 从properties属性文件中引入属性值 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.driverClass&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.userName&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>代码演示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        DataSource dataSource = iocContainer.getBean(<span class="string">&quot;dataSource&quot;</span>, DataSource.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">&#123;</span><br><span class="line">	CreateTime:<span class="string">&quot;2021-04-15 15:36:05&quot;</span>,</span><br><span class="line">	ActiveCount:<span class="number">0</span>,</span><br><span class="line">	PoolingCount:<span class="number">0</span>,</span><br><span class="line">	CreateCount:<span class="number">0</span>,</span><br><span class="line">	DestroyCount:<span class="number">0</span>,</span><br><span class="line">	CloseCount:<span class="number">0</span>,</span><br><span class="line">	ConnectCount:<span class="number">0</span>,</span><br><span class="line">	Connections:[</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><h3 id="IOC-思想的底层原理"><a href="#IOC-思想的底层原理" class="headerlink" title="IOC 思想的底层原理"></a>IOC 思想的底层原理</h3><ul>
<li><p>IOC 控制反转的思想：</p>
<ul>
<li>在应用程序中的组件需要获取资源时，传统的方式是组件主动的从容器中获取所需要的资源，在这样的模式下，开发人员往往需要知道在具体容器中特定资源的获取方式。比如 ClassA 中需要用到 ClassB 的对象，一般情况下，需要在 ClassA 的代码中显式的 new 一个 ClassB 的对象。</li>
<li><strong>控制反转的思想完全颠覆了应用程序组件获取资源的传统方式：反转了资源的获取方向 — 改由容器主动的将资源推送给需要的组件，开发人员不需要知道容器是如何创建资源对象的，只需要提供接收资源的方式即可。</strong>采用依赖注入技术之后，ClassA 的代码只需要定义一个私有的 ClassB 对象属性，不需要直接 new 来获得这个对象，而是通过相关的容器控制程序来将 ClassB 对象在外部 new 出来并注入到 ClassA 类里的引用中。而具体获取的方法、对象被获取时的状态由配置文件 (如 XML) 来指定。</li>
</ul>
</li>
<li><p>DI 依赖注入：可以将 DI 看作是 IOC 的一种实现方式 — <strong>即组件以一些预先定义好的方式 (例如 setter 方法) 接受来自于容器的资源注入。</strong>相对于 IOC 而言，这种表述更直接：<strong>IOC 容器在 Spring 中的实现。</strong></p>
</li>
<li><p><strong>IOC 底层原理：xml 解析，工厂模式，反射。</strong></p>
<ul>
<li><p>图解：</p>
<p><img src="/2021/04/13/spring-base/image-20210413171923916.png" alt="image-20210413171923916"></p>
</li>
<li><p>代码演示：</p>
<ul>
<li><p>原始方式：自己 new 对象，再通过 setter 方法注入器属性值。—&gt; 代码耦合度极高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Student student = <span class="keyword">new</span> Student();</span><br><span class="line">student.setStudentId(<span class="number">7</span>);</span><br><span class="line">student.setStudentName(<span class="string">&quot;Tom&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>进阶方式：通过工厂创建对象。—&gt; 可以降低代码的耦合度，不需要自己 new 对象，但仍需要手动去获取和管理 Bean。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1.先通过xml配置文件配置bean的属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.xisun.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;007&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.再通过工厂模式 + 反射的方法创建该对象的实例，并注入属性值</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title">getStudent</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String className = ...;<span class="comment">// 通过xml解析获取全类名</span></span><br><span class="line">        String[] fieldNames = ..;<span class="comment">// 通过xml解析获取字段名</span></span><br><span class="line">        String[] fieldValues = ...;<span class="comment">// 通过xml解析获取字段值</span></span><br><span class="line">        Class clazz = Class.forName(className);<span class="comment">// 通过反射创建对象实例</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fieldNames.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 依次为字段赋值</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz;<span class="comment">// 返回创建的实例对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最终方式：通过 Spring IOC 管理 Bean。—&gt; Bean 的创建与它们之间的依赖关系完全交给 Spring IOC 容器去管理，代码耦合程度极大降低。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1.先通过xml配置文件配置bean的属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentId&quot;</span> <span class="attr">value</span>=<span class="string">&quot;007&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;studentName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.再通过iocContainer.getbean(&quot;beanId&quot;, 类.class)方法或者@Autowire方式获取bean</span></span><br><span class="line">Student student = iocContainer.getBean(<span class="string">&quot;student&quot;</span>, Student.class);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>IOC 思想基于 IOC 容器完成，IOC 容器底层就是对象工厂。</strong></p>
</li>
</ul>
<h3 id="IOC-容器的实现方式"><a href="#IOC-容器的实现方式" class="headerlink" title="IOC 容器的实现方式"></a>IOC 容器的实现方式</h3><ul>
<li><p>Spring 为 IOC 容器提供的两种实现方式 (即两个接口 BeanFactory 和 ApplicationContext)：</p>
<ul>
<li><p>在通过 IOC 容器读取 Bean 的实例之前，需要先将 IOC 容器本身实例化。</p>
</li>
<li><p>BeanFactory 接口：</p>
<ul>
<li><p>IOC 容器的基本实现，是 Spring 内部的使用接口。面向 Spring 本身，不提供给开发人员使用。</p>
</li>
<li><p>BeanFactory 在加载配置文件的时候，不会创建对象，而是在使用对象的时候才去创建。</p>
</li>
<li><p>BeanFactory 接口的实现类：</p>
<p><img src="/2021/04/13/spring-base/image-20210413214323672.png" alt="image-20210413214323672"></p>
</li>
</ul>
</li>
<li><p><strong>ApplicationContext 接口：</strong></p>
<ul>
<li><p><strong>BeanFactory 的子接口 ，面向 Spring 的使用者，提供了更多功能，一般由开发人员进行使用。几乎所有场合都使用 ApplicationContext 而不是底层的 BeanFactory。</strong></p>
</li>
<li><p><strong>ApplicationContext 在加载配置文件的时候，就会把配置文件中配置的对象进行创建。</strong>(在服务启动的时候，就把加载对象等耗时的工作全部完成，而不是在用到的时候才创建，这对于 web 项目等的使用者，会有比较好的效果，因为一般项目部署到服务器启动后，都尽量不再关闭。)</p>
</li>
<li><p>ApplicationContext 接口的重要子接口和实现类：</p>
<ul>
<li><p>ConfigurableApplicationContext 子接口：扩展了一些方法，如 <code>refresh()</code> 和 <code>close()</code>，这些方法能够让 ApplicationContext 具有启动、关闭和刷新上下文的能力。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span>, <span class="title">Lifecycle</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Load or refresh the persistent representation of the configuration,</span></span><br><span class="line"><span class="comment">    * which might an XML file, properties file, or relational database schema.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;As this is a startup method, it should destroy already created singletons</span></span><br><span class="line"><span class="comment">    * if it fails, to avoid dangling resources. In other words, after invocation</span></span><br><span class="line"><span class="comment">    * of that method, either all or no singletons at all should be instantiated.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> BeansException if the bean factory could not be initialized</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> IllegalStateException if already initialized and multiple refresh</span></span><br><span class="line"><span class="comment">    * attempts are not supported</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Close this application context, releasing all resources and locks that the</span></span><br><span class="line"><span class="comment">    * implementation might hold. This includes destroying all cached singleton beans.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Note: Does &lt;i&gt;not&lt;/i&gt; invoke &#123;<span class="doctag">@code</span> close&#125; on a parent context;</span></span><br><span class="line"><span class="comment">    * parent contexts have their own, independent lifecycle.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;This method can be called multiple times without side effects: Subsequent</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> close&#125; calls on an already closed context will be ignored.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FileSystemXmlApplicationContext：对应文件系统中的 xml 格式的配置文件。(xml 配置文件的绝对路径)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext iocContainer = <span class="keyword">new</span> FileSystemXmlApplicationContext(</span><br><span class="line">        <span class="string">&quot;D:\\JetBrainsWorkSpace\\IDEAProjects\\xisun-projects\\xisun-spring\\src\\main\\resources\\spring.xml&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ClassPathXmlApplicationContext：对应类路径下的 xml 格式的配置文件。(xml 配置文件的相对路径，常用)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>WebApplicationContext 子接口：扩展了 ApplicationContext，是专门为 Web 应用准备的，它允许从相对于 Web 根目录的路径中装载配置文件完成初始化。</strong></p>
<p><img src="/2021/04/13/spring-base/image-20210414095049165.png" alt="image-20210414095049165"></p>
<ul>
<li><p>需要额外引入 <code>spring-web</code> 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Web依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="IOC-管理-Bean-的方式"><a href="#IOC-管理-Bean-的方式" class="headerlink" title="IOC 管理 Bean 的方式"></a>IOC 管理 Bean 的方式</h3><ul>
<li><p>IOC 操作 Bean 管理：</p>
<ul>
<li><p>Bean 管理指的是两个操作：</p>
<ul>
<li>Spring 创建对象。—&gt; 实例化</li>
<li>Spirng 注入属性。—&gt; 初始化</li>
</ul>
</li>
<li><p>Bean 管理操作有两种方式：</p>
<ul>
<li>基于 xml 配置文件方式实现 (基础)。</li>
<li><strong>基于注解方式实现。</strong></li>
</ul>
</li>
<li><p>Bean 对象的三种获取方式 (定义在 beanFactory 接口中)：</p>
<ul>
<li><p><code>Object getbean(String name) throws beansException;</code>：通过 Bean 的 name 获取 Bean 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Student student = (Student) iocContainer.getBean(<span class="string">&quot;student&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;T&gt; T getBean(Class&lt;T&gt; requiredType) throws BeansException;</code>：通过 Bean 的 class 获取 Bean 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Student student1 = iocContainer.getBean(Student.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>&lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType) throws BeansException;</code>：通过 Bean 的 name 和 Bean 的 class 获取 Bean 实例。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Student student = iocContainer.getBean(<span class="string">&quot;student&quot;</span>, Student.class);</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="基于-xml-配置文件方式实现"><a href="#基于-xml-配置文件方式实现" class="headerlink" title="基于 xml 配置文件方式实现"></a>基于 xml 配置文件方式实现</h4><ul>
<li><p>第一步：基于 xml 方式创建对象。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置Student对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;student&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 Spring 配置文件中，使用 &lt;bean&gt; 标签，标签里面添加对应属性，就可以实现对象创建。</li>
<li>&lt;bean&gt; 标签中有很多属性，常用的属性：<ul>
<li>id 属性：bean 实例的唯一标识。</li>
<li>class 属性：bean 的全类名。</li>
</ul>
</li>
<li><strong>创建对象时候，默认执行无参数构造方法完成对象创建。</strong></li>
</ul>
</li>
<li><p>第二步：基于 xml 方式注入对象的属性。</p>
<ul>
<li><p>DI：依赖注入，就是注入属性。</p>
</li>
<li><p><strong>第一种注入方式：通过 Bean 的 setter 方法注入属性值。</strong></p>
<ul>
<li><p>创建类，定义属性，创建属性对应的 setter 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String bookName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String bookAuthor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookName</span><span class="params">(String bookName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookName = bookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookAuthor</span><span class="params">(String bookAuthor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookAuthor = bookAuthor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件配置对象创建，配置属性注入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置Book对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用property完成属性注入：</span></span><br><span class="line"><span class="comment">            name：类里面属性名称</span></span><br><span class="line"><span class="comment">            value：向属性注入的值</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;论语&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookAuthor&quot;</span> <span class="attr">value</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 &lt;property&gt; 标签指定属性名，Spring 会帮我们找到该属性对应的 setter 方法，并注入其属性值。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>第二种注入方式：通过 Bean 的有参数构造方法注入属性值。</p>
<ul>
<li><p>创建类，定义属性，创建属性对应的有参数构造方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Orders</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String orderName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Orders</span><span class="params">(String orderName, String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderName = orderName;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件配置对象创建，配置属性注入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置Orders对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Orders&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;orderName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;computer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">value</span>=<span class="string">&quot;China&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 &lt;constructor-arg&gt; 标签为对象的属性赋值，name 指定属性名，value 指定属性值。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>第三种注入方式：通过 p 名称空间注入属性值。</p>
<ul>
<li><p>为了简化 xml 文件的配置，越来越多的 xml 文件采用属性而非子元素配置信息。Spring 从 2.5 版本开始引入了一个新的 p 命名空间，可以通过 &lt;bean&gt; 标签属性的方式配置 Bean 的属性。使用 p 命名空间后，基于 xml 的配置方式将进一步简化。</p>
</li>
<li><p>添加 p 名称空间在配置文件中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<img src="/2021/04/13/spring-base/image-20210414200410969.png" alt="image-20210414200410969" style="zoom: 80%;">

<ul>
<li><p>通过 p 名称空间注入属性值，也是调用 Bean 的 setter 方法设置属性值的。</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置Book对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span> <span class="attr">p:bookName</span>=<span class="string">&quot;论语&quot;</span> <span class="attr">p:bookAuthor</span>=<span class="string">&quot;孔子&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>基于 xml 方式注入其他类型的属性。</p>
<ul>
<li><p>第一种：字面量</p>
<ul>
<li><p>null 值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;无名&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- null值--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookAuthor&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>效果：Book{bookName=’无名’, bookAuthor=’null’}</p>
</blockquote>
</li>
<li><p>属性值包含特殊符号。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;春秋&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookAuthor&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 方式一：将特殊字符进行转义，比如：&lt;&gt;转义为&amp;lt; &amp;gt; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;value&gt;&amp;lt;相传是孔子&amp;gt;&lt;/value&gt;--&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 方式二：把带特殊符号内容写到CDATA中 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[&lt;相传是孔子&gt;]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>效果：Book{bookName=’春秋’, bookAuthor=’&lt;相传是孔子&gt;’}</p>
</blockquote>
</li>
</ul>
</li>
<li><p>第二种：外部 Bean。</p>
<ul>
<li><p>创建两个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDao</span><span class="params">(UserDao userDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service add...............&quot;</span>);</span><br><span class="line">        userDao.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件中进行配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.service.UserService&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注入userDao对象：</span></span><br><span class="line"><span class="comment">            name属性：类里面属性名称</span></span><br><span class="line"><span class="comment">            ref属性：配置userDao对象的bean标签的id值</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDao&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 外部Bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.UserDao&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第三种：内部 Bean。</p>
<ul>
<li><p>当 Bean 实例仅仅给一个特定的属性使用时，可以将其声明为内部 Bean。内部 Bean 声明直接包含在 &lt;property&gt; 或 &lt;constructor-arg&gt; 标签里，不需要设置任何 id 或 name 属性，<strong>内部 Bean 不能使用在任何其他地方。</strong></p>
</li>
<li><p>一对多关系：部门和员工，一个部门有多个员工，一个员工属于一个部门，部门是一，员工是多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Department</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String depName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDepName</span><span class="params">(String depName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.depName = depName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Department&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;depName=&#x27;&quot;</span> + depName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Department dep;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGender</span><span class="params">(String gender)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDep</span><span class="params">(Department dep)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dep = dep;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Employee&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, gender=&#x27;&quot;</span> + gender + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, dep=&quot;</span> + dep +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 spring 配置文件中进行配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dep&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 内部Bean --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;department&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Department&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;depName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第四种：级联赋值。</p>
<ul>
<li><p>写法一：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 级联赋值写法一 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dep&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;department&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;department&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Department&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;depName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>写法二：注意，必须要在 Employee 类中添加 dep 属性的 getter 方法，否则会报错。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;employee&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Employee&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Tom&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">value</span>=<span class="string">&quot;male&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 级联赋值写法二 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dep&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;department&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dep.depName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;editorial&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;department&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Department&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;depName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>基于 xml 方式注入集合属性：数组类型、List 类型、Map 类型、Set 类型。</p>
<ul>
<li><p>在 Spring 中可以通过一组内置的 xml 标签来配置集合属性，比如：&lt;array&gt;、&lt;list&gt;、&lt;map&gt;、&lt;set&gt;、&lt;props&gt;，并且可以用过引入 util 名称空间来提取集合类型的 Bean。</p>
</li>
<li><p>第一种：集合中元素是基本数据类型。</p>
<ul>
<li><p>创建类，定义数组、List、Map、Set 类型属性，并生成对应的 setter 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectionExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] array;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; list;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; set;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(String[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.array = array;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setList</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMap</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.map = map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSet</span><span class="params">(Set&lt;String&gt; set)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.set = set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件进行配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;collectionExample&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.CollectionExample&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数组类型属性注入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;array&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>Java<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>数据库<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- List类型属性注入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>李四<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Map类型属性注入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span> <span class="attr">key-type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;JAVA&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;PYTHON&quot;</span> <span class="attr">value</span>=<span class="string">&quot;python&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Set类型属性注入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;set&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>MySQL<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>Redis<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Properties类型属性注入 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;properties&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">props</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;SPRING&quot;</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;JVM&quot;</span>&gt;</span>jvm<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第二种：集合中元素是对象类型值。</p>
<ul>
<li><p>创建两个类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Course&gt; coursesist;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCoursesist</span><span class="params">(List&lt;Course&gt; coursesist)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.coursesist = coursesist;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件进行配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1.创建多个Course对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;course1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Course&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Spring&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;course2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Course&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SpringMVC&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2.注入list集合类型，值是Course对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;stu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.bean.Student&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;coursesist&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;course1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;course2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>把集合注入部分提取出来作为公共部分。</p>
<ul>
<li><p>创建一个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; bookList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBookList</span><span class="params">(List&lt;String&gt; bookList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookList = bookList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Book&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;bookList=&quot;</span> + bookList +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Spring 配置文件中引入名称空间 util。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/util </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/util/spring-util.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2021/04/13/spring-base/image-20210414200224118.png" alt="image-20210414200224118" style="zoom:80%;">
</li>
<li><p>使用 util 标签完成 list 集合注入提取。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1.提取list集合类型属性注入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">&quot;bookList&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>论语<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>孟子<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>大学<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2.注入list集合类型，值是对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;book&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.pojo.Book&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;bookList&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;bookList&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Map 和 Set 参考 List 的写法。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="基于注解方式实现"><a href="#基于注解方式实现" class="headerlink" title="基于注解方式实现"></a>基于注解方式实现</h4><ul>
<li><p>什么是注解：</p>
<ul>
<li>注解是代码特殊标记，格式：<code>@注解名称(属性名称=属性值, 属性名称=属性值...)</code>。</li>
<li>使用注解的时候，注解作用在类上面、方法上面、属性上面。</li>
<li>相对于 xml 方式而言，通过注解的方式配置 bean 更加简洁和优雅，而且和 MVC 组件化开发的理念十分契合，是开发中常用的使用方式。</li>
</ul>
</li>
<li><p>Spring 中用于标识 Bean 的四个注解：</p>
<ul>
<li><strong><code>@Component</code>：</strong>普通组件，用于标识一个受 Spring IOC 容器管理的组件。</li>
<li><strong><code>@Respository</code>：</strong>持久化层组件，用于标识一个受 Spring IOC 容器管理的持久化层组件。</li>
<li><strong><code>@Service</code>：</strong>业务逻辑层组件，用于标识一个受 Spring IOC 容器管理的业务逻辑层组件。</li>
<li><strong><code>@Controller</code>：</strong>表述层控制器组件，用于标识一个受 Spring IOC 容器管理的表述层控制器组件。</li>
<li>事实上 Spring 并没有能力识别一个组件到底是不是它所标记的类型，即使将 <code>@Respository</code> 注解用在一个非持久化层组件上面，也不会产生任何错误，所以 <code>@Respository</code>、<code>@Service</code>、<code>@Controller</code> 这几个注解仅仅是为了让开发人员自己明确当前的组件扮演的角色。</li>
</ul>
</li>
<li><p>组件命名规则：</p>
<ul>
<li><strong>默认情况：使用组件的简单类名首字母小写后得到的字符串作为 Bean 的 id。</strong></li>
<li>也可以使用四个组件注解的 value 属性指定 Bean 的 id。</li>
</ul>
</li>
<li><p><strong>第一步：开启 Spring 注解方式的整体流程。</strong></p>
<ul>
<li><p>第一步：引入 <code>spring-aop</code> 依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：在配置文件中引入 context 名称空间。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：在配置文件中开启组件扫描。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    开启组件扫描：</span></span><br><span class="line"><span class="comment">        1.如果扫描多个包，多个包间使用逗号隔开。</span></span><br><span class="line"><span class="comment">        2.扫描包的上层目录。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：创建类，在类上面添加创建对象注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.spring.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user service add ......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第五步：获取和使用 Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        UserService userService = iocContainer.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(userService);</span><br><span class="line">        userService.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">cn.xisun.spring.service.UserService@<span class="number">8e0379d</span></span><br><span class="line">user service add ......</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>开启组件扫描的注意事项：</p>
<ul>
<li><p>base-package 属性指定一个需要扫描的基类包，Spring 容器将会扫描这个基类包及其子包中的所有类。</p>
</li>
<li><p>当需要扫描多个包时可以使用逗号分隔，或者指定这多个包的上层包。</p>
</li>
<li><p>如果仅希望扫描特定的类而非基包下的所有类，可使用 resource-pattern 属性过滤特定的类，示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- resource-pattern：只扫描cn.xisun.spring包下的dao子包下的所有类。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring&quot;</span> <span class="attr">resource-pattern</span>=<span class="string">&quot;dao/*.class&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 resource-pattern 属性并不能提供完善的功能，所有我们得使用<strong>过滤子元素</strong>的方法。</p>
</blockquote>
</li>
<li><p><strong>&lt;context:include-filter&gt;：</strong>表示要包含的目标类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 示例1：</span></span><br><span class="line"><span class="comment">        use-default-filters=&quot;false&quot;：表示现在不使用默认filter，而是使用自己配置filter。</span></span><br><span class="line"><span class="comment">        context:include-filter：用于设置需要扫描哪些内容(这里配置扫描Repository、Service和Controller注解)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Repository&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通常需要与 use-default-filters 属性配合使用才能够达到 “仅包含某些组件” 这样的效果。即：通过将 use-default-filters 属性设置为 false，禁用默认过滤器，然后扫描的就只是 &lt;context:include-filter&gt; 标签中的规则指定的组件了。</p>
</blockquote>
</li>
<li><p><strong>&lt;context:exclude-filter&gt;：</strong>表示要排除在外的目标类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 示例2：下面配置扫描包所有内容context:exclude-filter，设置哪些内容不进行扫描(这里排除Controller注解) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>一个 &lt;context:component-scan&gt; 标签下可以有多个 &lt;context:include-filter&gt; 和 &lt;context:exclude-filter&gt;。</p>
</li>
<li><p>&lt;context:include-filter&gt; 和 &lt;context:exclude-filter&gt; 的 type 属性所支持的类型如下表：</p>
<img src="/2021/04/13/spring-base/image-20210415172739036.png" alt="image-20210415172739036" style="zoom:80%;">

<blockquote>
<p>在这些类型当中，除了 custom 外，aspectj 的过滤功能最强大，它能轻易的实现其他类别的过滤规则。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>第二步：基于注解方式实现属性注入。</strong></p>
<ul>
<li><p>项目中组件装配时，Controller 组件中往往需要用到 Service 组件的实例，Service 组件中往往需要用到 Repository 组件的实例。Spring 可以通过注解的方式帮我们实现属性的装配。</p>
</li>
<li><p><strong>在指定要扫描的包时，&lt;context:component-scan&gt; 标签会自动注册一个 Bean 的后置处理器 AutowiredAnnotationBeanPostProcessor 的实例。该后置处理器可以自动装配标记了 <code>@Autowired</code>、<code>@Resource</code> 或 <code>@Inject</code> 注解的属性。这就是组件扫描的原理。</strong></p>
</li>
<li><p><strong><code>@Autowired</code></strong></p>
<ul>
<li><p><strong>根据属性类型实现自动装配。</strong></p>
</li>
<li><p>构造器、普通字段 (即使是非 public)、一切具有参数的方法都可以应用 <code>@Autowired</code> 注解。</p>
</li>
<li><p>默认情况下，所有使用 <code>@Autowired</code> 注解的属性都需要被设置。当 Spring 找不到匹配的 Bean 装配属性时，会抛出异常。</p>
</li>
<li><p>若某一属性允许不被设置，可以设置 <code>@Autowired</code> 注解的 required 属性为 false。</p>
</li>
<li><p>默认情况下，当 IOC 容器里存在多个类型兼容的 Bean 时，Spring 会尝试匹配 Bean 的 id 值是否与变量名相同，如果相同则进行装配。如果 Bean 的 id 值不相同，通过类型的自动装配将无法工作。此时可以在 <code>@Qualifier</code> 注解里提供 Bean 的名称。Spring 甚至允许在方法的形参上标注 <code>@Qualifiter</code> 注解以指定注入 Bean 的名称。</p>
</li>
<li><p><code>@Autowired</code> 注解也可以应用在数组类型的属性上，此时 Spring 将会把所有匹配的 Bean 进行自动装配。</p>
</li>
<li><p><code>@Autowired</code> 注解也可以应用在集合属性上，此时 Spring 读取该集合的类型信息，然后自动装配所有与之兼容的 Bean。</p>
</li>
<li><p><code>@Autowired</code> 注解用在 <code>java.util.Map</code>上时，若该 Map 的键值为 String，那么 Spring 将自动装配与值类型兼容的 Bean 作为值，并以 Bean 的 id 值作为键。</p>
</li>
<li><p><code>@Autowired</code> 注解使用过程：</p>
<ul>
<li><p>第一步：创建 service 和 dao 对象，在 service 和 dao 类添加创建对象注解。</p>
</li>
<li><p>第二步：在 service 中注入 dao 对象，在 service 类添加 dao 类型属性，在属性上面使用注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dao add ......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义dao类型属性，添加注入属性注解，不需要添加setter方法</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user service add ......&quot;</span>);</span><br><span class="line">        userDao.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        UserService userService = iocContainer.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(userService);</span><br><span class="line">        userService.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">cn.xisun.spring.service.UserService@<span class="number">161</span>b062a</span><br><span class="line">user service add ......</span><br><span class="line">dao add ......</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code>@Qualifier</code></strong></p>
<ul>
<li><p><strong>根据属性名称实现自动装配。</strong></p>
</li>
<li><p><strong><code>@Qualifier</code> 注解需要和上面 <code>@Autowired</code> 注解一起使用。</strong></p>
</li>
<li><p>如果存在多个类型相同的 Bean，可以为每个 Bean 单独命名，然后根据名称使用 <code>@Qualifier</code> 注解指定需要注入的 Bean。</p>
</li>
<li><p><code>@Qualifier</code> 注解使用过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository(value = &quot;userDaoImpl1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;dao add ......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;userDaoImpl1&quot;)</span><span class="comment">// 需要与指定的bean的value相同，否则会找不到</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user service add ......&quot;</span>);</span><br><span class="line">        userDao.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置文件，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置文件中的bean实例对象，要求使用返回的bean的类型</span></span><br><span class="line">        UserService userService = iocContainer.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印bean</span></span><br><span class="line">        System.out.println(userService);</span><br><span class="line">        userService.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">cn.xisun.spring.service.UserService@<span class="number">3</span>ee0fea4</span><br><span class="line">user service add ......</span><br><span class="line">dao add ......</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>@Resource</code></p>
<ul>
<li><p>可以根据类型注入，也可以根据名称注入。<code>@Resource</code> 注解要求提供一个 Bean 名称的属性，若该属性为空，则自动采用标注处的变量或方法名作为 Bean 的名称。</p>
</li>
<li><p><code>@Resource</code> 是 JDK 提供的注解，不建议使用，开发中应该尽量使用 Spring 提供的注解。</p>
</li>
<li><p><code>@Resource</code> 注解使用说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Resource // 根据类型进行注入</span></span><br><span class="line"><span class="meta">@Resource(name = &quot;userDaoImpl1&quot;)</span> <span class="comment">// 根据Bean名称进行注入 </span></span><br><span class="line"><span class="keyword">private</span> UserDao userDao;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong><code>@Value</code></strong></p>
<ul>
<li><p>注入普通属性的值。</p>
</li>
<li><p><code>@Value</code> 注解使用说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(value = &quot;userDaoImpl1&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(value = &quot;Tom&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;<span class="comment">// @Value注解为name属性注入了一个值Tom</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;name is: &quot;</span> + <span class="keyword">this</span>.name);<span class="comment">// name is: Tom</span></span><br><span class="line">        System.out.println(<span class="string">&quot;user service add ......&quot;</span>);</span><br><span class="line">        userDao.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="进阶：完全注解开发"><a href="#进阶：完全注解开发" class="headerlink" title="进阶：完全注解开发"></a>进阶：完全注解开发</h4><ul>
<li><p>第一步：创建 SpringConfig 配置类，代替之前的 xml 配置文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.配置类本身也是一个组件</span></span><br><span class="line"><span class="comment"> * 2.配置类里使用<span class="doctag">@Bean</span>注解，标注在方法上给容器注册组件，默认是单实例的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;cn.xisun.spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 给容器中添加组件。以方法名作为组件的id，返回类型就是组件的类型，返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">student01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Student(<span class="number">1000</span>, <span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以重新指定组件的id</span></span><br><span class="line">    <span class="meta">@Bean(value = &quot;Tom&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">student02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Student(<span class="number">1001</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>@Configuration</code>：标识这是一个配置类。</strong></p>
</li>
<li><p><strong><code>@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring&quot;&#125;)</code>：配置组件扫描路径。</strong></p>
</li>
<li><p>在 Spring 配置文件中，以 &lt;bean&gt; 标签注册的对象，均可在此配置类中实现。</p>
</li>
<li><p>如果需要注册一些特殊的对象，比如 Student 类的特定实例，需要在此配置类中以 @Bean 注解配置。而诸如以 @Repository 等注解标注的类，已经在 IOC 容器中注册，不需要在此配置。如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>第二步：编写测试类，通过 new 一个 AnnotationConfigApplicationContext 对象创建 IOC 容器对象。其他与前面的相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.加载Spring配置类，创建IOC容器对象</span></span><br><span class="line">        ApplicationContext iocContainer = <span class="keyword">new</span> AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.根据id值获取配置类中的Bean实例对象和容器中注册的组件，要求使用返回的Bean的类型</span></span><br><span class="line">        Student student01 = context.getBean(<span class="string">&quot;student01&quot;</span>, Student.class);<span class="comment">// 指向SpringConfig类中的第一个Bean</span></span><br><span class="line">        Student student = context.getBean(<span class="string">&quot;Tom&quot;</span>, Student.class);<span class="comment">// 指向SpringConfig类中的第二个Bean</span></span><br><span class="line">        UserDao userDao = context.getBean(<span class="string">&quot;userDao&quot;</span>, UserDao.class);<span class="comment">// 指向@Repository注解标注的UserDao</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.打印Bean</span></span><br><span class="line">        System.out.println(student01);</span><br><span class="line">        System.out.println(student);</span><br><span class="line">        System.out.println(userDao);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>效果：</p>
<p>Student{studentId=1000, studentName=’Jerry’}<br>Student{studentId=1001, studentName=’Tom’}<br>cn.xisun.spring.dao.UserDao@55a1c291</p>
</blockquote>
</li>
</ul>
<h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><ul>
<li><p>AOP (Aspect-Oriented Programming，面向切面编程)：是一种新的方法论，是对传统 OOP (Object-Oriented Programming，面向对象编程) 的补充。</p>
</li>
<li><p>AOP 编程操作的主要对象是切面 (aspect)，而切面模块化横切关注点。</p>
</li>
<li><p>在应用 AOP 编程时，仍然需要定义公共功能，但可以明确的定义这个功能应用在哪里，以什么方式应用，并且不必修改受影响的类。这样一来横切关注点就被模块化到特殊的类里 — 这样的类我们通常称之为 “切面”。</p>
</li>
<li><p>AOP 的好处：每个事物逻辑位于一个位置，代码不分散，便于维护和升级；业务模块更简洁，只包含核心业务代码。以上面的计算器案例说明：</p>
<img src="/2021/04/13/spring-base/image-20210416152006380.png" alt="image-20210416152006380" style="zoom:67%;">
</li>
<li><p><strong>通俗的说：AOP 是面向切面 (方面) 编程，利用 AOP 可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。即：可在不通过修改源代码方式，在主干功能里面添加新功能。</strong></p>
</li>
</ul>
<h3 id="AOP-底层原理"><a href="#AOP-底层原理" class="headerlink" title="AOP 底层原理"></a>AOP 底层原理</h3><ul>
<li><strong>AOP 底层使用动态代理。</strong></li>
</ul>
<h4 id="第一种：有接口的情况"><a href="#第一种：有接口的情况" class="headerlink" title="第一种：有接口的情况"></a>第一种：有接口的情况</h4><ul>
<li><p><strong>使用 JDK 动态代理。</strong></p>
<ul>
<li><strong>创建接口实现类代理对象，增强类的方法。</strong></li>
</ul>
</li>
<li><p>数学计算器要求：① 执行加减乘除运算；② 日志增强：在程序执行期间追踪正在发生的活动；③ 验证增强：希望计算器只能处理正数的运算。</p>
</li>
<li><p>数学计算器的常规实现代码 (这里为了简便形参类型设置为 int)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算器接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function">Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 常规方法实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorImpl</span> <span class="keyword">implements</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;The method add() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i + j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method add() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;The method subtract() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i - j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method subtract() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;The method multiply() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i * j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method multiply() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;The method div() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i / j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method div() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>存在的问题一：<strong>代码混乱</strong>。越来越多的非业务需求 (日志和验证等) 加入后，原有的业务方法急剧膨胀。每个方法在处理核心逻辑的同时还必须兼顾其他多个关注点。</li>
<li>存在的问题二：<strong>代码分散</strong>。以日志需求为例，只是为了满足这个单一需求，就不得不在多个模块 (方法) 里多次重复相同的日志代码。如果日志需求发生变化，必须修改所有模块。</li>
</ul>
</li>
<li><p>使用 JDK 动态代理改进：</p>
<img src="/2021/04/13/spring-base/image-20210416151059910.png" alt="image-20210416151059910" style="zoom:67%;">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算器接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function">Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ArithmeticCalculator实现类，只做计算的核心功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorImpl</span> <span class="keyword">implements</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i + j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;subtract 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i - j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;multiply 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i * j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;div 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i / j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志处理器：在计算的过程中添加日志记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorLoggingHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArithmeticCalculatorLoggingHandler</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写invoke()，增加日志处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method &quot;</span> + method.getName() + <span class="string">&quot;() begins with &quot;</span> + Arrays.toString(args));</span><br><span class="line">        Object result = method.invoke(obj, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;The method &quot;</span> + method.getName() + <span class="string">&quot;() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建当前代理的代理对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createProxy</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        ArithmeticCalculatorLoggingHandler handler = <span class="keyword">new</span> ArithmeticCalculatorLoggingHandler(obj);</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证处理器：在计算之前对参数进行验证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorValidationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArithmeticCalculatorValidationHandler</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重写invoke()，增加验证处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            validate((<span class="keyword">int</span>) arg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(obj, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (number &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建当前代理的代理对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createProxy</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        ArithmeticCalculatorValidationHandler handler = <span class="keyword">new</span> ArithmeticCalculatorValidationHandler(obj);</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 两级增强：普通计算 ---&gt; 日志增强 ---&gt; 验证增强</span></span><br><span class="line">        ArithmeticCalculator calculator = (ArithmeticCalculator) ArithmeticCalculatorValidationHandler.createProxy(</span><br><span class="line">                ArithmeticCalculatorLoggingHandler.createProxy(<span class="keyword">new</span> ArithmeticCalculatorImpl()));</span><br><span class="line">        <span class="keyword">int</span> addResult = calculator.add(-<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;result: &quot;</span> + addResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="第二种：没有接口的情况"><a href="#第二种：没有接口的情况" class="headerlink" title="第二种：没有接口的情况"></a>第二种：没有接口的情况</h4><ul>
<li><p><strong>使用 CGLIB 动态代理。</strong></p>
<ul>
<li><strong>创建子类的代理对象，增强类的方法。</strong></li>
</ul>
</li>
<li><p>数学计算器要求：① 执行加减乘除运算；② 日志增强：在程序执行期间追踪正在发生的活动；③ 验证增强：希望计算器只能处理正数的运算。</p>
</li>
<li><p>数学计算器的常规实现代码 (这里为了简便形参类型设置为 int)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 常规方法实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;The method add() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i + j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method add() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;The method subtract() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i - j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method subtract() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;The method multiply() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i * j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method multiply() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + j);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;The method div() begins with [&quot;</span> + i + <span class="string">&quot;, &quot;</span> + j + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> result = i / j;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method div() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 CGLIB 动态代理改进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i + j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;subtract 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i - j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;multiply 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i * j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;div 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i / j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志拦截器：在计算的过程中添加日志记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorLoggingInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The method &quot;</span> + method.getName() + <span class="string">&quot;() begins with &quot;</span> + Arrays.toString(args));</span><br><span class="line">        Object result = methodProxy.invokeSuper(obj, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;The method &quot;</span> + method.getName() + <span class="string">&quot;() ends with [&quot;</span> + result + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createProxy</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setClassLoader(obj.getClass().getClassLoader());</span><br><span class="line">        enhancer.setSuperclass(obj.getClass());</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> ArithmeticCalculatorLoggingInterceptor());</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证处理器：在计算之前对参数进行验证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorValidationInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            validate((<span class="keyword">int</span>) arg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(obj, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (number &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createProxy</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">        enhancer.setClassLoader(obj.getClass().getClassLoader());</span><br><span class="line">        enhancer.setSuperclass(obj.getClass());</span><br><span class="line">        enhancer.setCallback(<span class="keyword">new</span> ArithmeticCalculatorValidationInterceptor());</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 日志增强</span></span><br><span class="line">        ArithmeticCalculator arithmeticCalculator = (ArithmeticCalculator) ArithmeticCalculatorLoggingInterceptor</span><br><span class="line">                .createProxy(<span class="keyword">new</span> ArithmeticCalculator());</span><br><span class="line">        Integer addResult = arithmeticCalculator.add(-<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(addResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CGLIB 不支持类嵌套增强，如果需要多个多个嵌套增强，需要其他方法实现，此处不涉及。</p>
</blockquote>
</li>
</ul>
<h3 id="切入点表达式"><a href="#切入点表达式" class="headerlink" title="切入点表达式"></a>切入点表达式</h3><ul>
<li><p>AOP 相关术语：</p>
<ul>
<li><strong>连接点 (JoinPoint)**：</strong>类里面可以被增强的方法被称为连接点。**就是 Spring 允许使用通知的地方，基本每个方法的前、后 (两者都有也行)，或抛出异常时都可以是连接点，Spring 只支持方法连接点。</li>
<li><strong>切入点 (Pointcut)**：</strong>实际被真正增强的方法，称为切入点。**在上面说的连接点的基础上，来定义切入点，假设一个类里，有 15 个方法，那就可能有几十个连接点，但不一定需要在所有方法附近都使用通知，而是只想让其中的几个方法使用通知。则在调用这几个方法之前，之后或者抛出异常时，利用切入点来定义这几个方法，让切入点来筛选连接点，选中那几个需要使用通知的方法。</li>
<li><strong>通知 (Advice)**：</strong>实际增强的逻辑部分，也就是想要的功能，比如上面说的日志处理、验证处理等。**事先定义好，然后在想用的地方用一下。通知的类型：前置通知、最终通知、后置通知、异常通知、环绕通知。<ul>
<li>前置通知 (Before Advice)：在切入点选择的连接点处的方法之前执行的通知，该通知不影响正常程序执行流程 (除非该通知抛出异常，该异常将中断当前方法链的执行而返回)。</li>
<li>最终通知 (After Advice)：在切入点选择的连接点处的方法之后执行的通知 (无论方法执行是否成功都会被调用)。</li>
<li>后置通知 (After returning Advice)：在切入点选择的连接点处的方法正常执行完毕时执行的通知，必须是连接点处的方法没抛出任何异常正常返回时才调用。</li>
<li>异常通知 (After throwing Advice)：在切入点选择的连接点处的方法抛出异常返回时执行的通知，必须是连接点处的方法抛出任何异常返回时才调用异常通知。</li>
<li>环绕通知 (Around Advices)：环绕着在切入点选择的连接点处的方法所执行的通知，环绕通知可以在方法调用之前和之后自定义任何行为，并且可以决定是否执行连接点处的方法、替换返回值、抛出异常等等。</li>
</ul>
</li>
<li><strong>切面 (Aspect)**：</strong>把通知应用到切入点的过程 (是动作)。**切面是通知和切入点的结合，也就是说，没连接点什么事情，连接点是为了好理解切入点而提出来的概念。</li>
<li>**引入 (introduction)**：允许我们向现有的类添加新方法属性，也就是把切面 (即新方法属性：通知定义的) 用到目标类中。</li>
<li>**目标 (target)**：引入中所提到的目标类，也就是要被通知的对象，即真正的业务逻辑，他可以在毫不知情的情况下，被织入切面。而自己专注于业务本身的逻辑。</li>
<li>**代理 (proxy)**：怎么实现整套 AOP 机制的，都是通过代理。</li>
<li>**织入 (weaving)**：把切面应用到目标对象来创建新的代理对象的过程。有 3 种方式，Spring 采用的是运行时。</li>
</ul>
</li>
<li><p><strong>切入点表达式：</strong></p>
<ul>
<li>切入点表达式作用：表明对哪个类里面的哪个方法进行增强。</li>
<li><strong>语法结构： execution([权限修饰符] [返回类型] [类全类名] [方法名称]([参数列表]) )。</strong><ul>
<li>权限修饰符一般使用 * 替代；返回类型可以省略；参数列表使用 .. 代替。</li>
</ul>
</li>
<li>举例 1：对 <code>cn.xisun.spring.dao.UserDao</code> 类里面的 <code>add()</code> 进行增强。<ul>
<li><strong><code>execution(* cn.xisun.spring.dao.UserDao.add(..))</code></strong></li>
</ul>
</li>
<li>举例 2：对 <code>cn.xisun.spring.dao.UserDao</code> 类里面的所有的方法进行增强。<ul>
<li><strong><code>execution(* cn.xisun.spring.dao.UserDao.*(..))</code></strong></li>
</ul>
</li>
<li>举例 3：对 <code>cn.xisun.spring.dao</code> 包里面所有类，类里面所有方法进行增强。<ul>
<li><strong><code>execution(* cn.xisun.spring.dao.*.*(..))</code></strong></li>
</ul>
</li>
<li>举例 4：对 <code>cn.xisun.spring.dao.UserDao</code> 类里面返回 double 类型的方法进行增强。<ul>
<li><strong><code>execution(* double cn.xisun.spring.dao.UserDao.*(..))</code></strong></li>
</ul>
</li>
<li>举例 5：对 <code>cn.xisun.spring.dao.UserDao</code> 类里面第一个参数为 double 类型的方法进行增强。<ul>
<li><strong><code>execution(* cn.xisun.spring.dao.UserDao.*(double, ..))</code></strong></li>
</ul>
</li>
<li>举例 6：对 <code>cn.xisun.spring.dao.UserDao</code> 类里面里面的 <code>add()</code> 或 <code>div()</code> 进行增强。<ul>
<li><strong><code>execution(* cn.xisun.spring.dao.UserDao.add(..)) || execution(* cn.xisun.spring.dao.UserDap.div(..))</code></strong></li>
<li>在 AspectJ 中，切入点表达式可以通过 &amp;&amp;、||、! 等操作符结合起来。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="实现-AOP-操作的方式"><a href="#实现-AOP-操作的方式" class="headerlink" title="实现 AOP 操作的方式"></a>实现 AOP 操作的方式</h3><ul>
<li><p><strong>实现 AOP 操作的准备工作：</strong></p>
<ul>
<li><p><strong>Spring 框架一般都是基于 AspectJ 实现 AOP 操作：</strong></p>
<ul>
<li>AspectJ 不是 Spring 组成部分，它是 Java 社区里最完整最流行的 AOP 框架。在 Spring 2.0 以上版本中，可以使用基于 AspectJ 注解或基于 xml 配置的 AOP。</li>
</ul>
</li>
<li><p>基于 AspectJ 实现 AOP 操作：</p>
<ul>
<li><strong>基于注解方式实现 (常用)。</strong></li>
<li>基于 xml 配置文件实现。</li>
</ul>
</li>
<li><p>引入 AOP 和 AspectJ 的相关依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring AOP和AspectJ相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>aopalliance<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aopalliance<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.springsource.net.sf.cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="基于注解方式实现-1"><a href="#基于注解方式实现-1" class="headerlink" title="基于注解方式实现"></a>基于注解方式实现</h4><ul>
<li><p>第一步：编写 Spring 配置文件，引入 context 和 aop 名称空间，并开启组件扫描，指明包路径，以及开启自动代理功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string"></span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string"></span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启注解扫描 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring.aop&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启Aspect生成代理对象--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 被增强类有接口，需指定proxy-target-class为true，如果没有接口，不需要指定这个参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>  <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：被增强类 (目标类) 的定义。<strong>添加 <code>@Component</code> 注解。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要被增强的类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorImpl</span> <span class="keyword">implements</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i + j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;subtract 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i - j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;multiply 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i * j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;div 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i / j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：增强类 (切面类) 的定义。<strong>在增强类上添加 <code>@Component</code> 和 <code>@Aspect</code> 注解；在增强类里面，在作为通知的方法上面添加对应的通知类型注解，并使用切入点表达式配置需要增强的方法。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志增强</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorLoggingAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 相同的切入点抽取</span></span><br><span class="line">    <span class="meta">@Pointcut(value = &quot;execution(* cn.xisun.spring.aop.ArithmeticCalculatorImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointSame</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Before 前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterReturning 后置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@After 最终通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterThrowing 异常通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(value = &quot;execution(* cn.xisun.spring.aop.ArithmeticCalculatorImpl.add(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之前&quot;</span>);</span><br><span class="line">        <span class="comment">// 被增强的方法执行，proceed是该方法的返回结果，如果原方法为void，则proceed为null</span></span><br><span class="line">        Object proceed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            proceed = proceedingJoinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之后&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前置通知、后置通知、异常通知和最终通知，可以额外接受一个 JoinPoint 参数，用来获取目标对象和目标方法相关信息，但是一定要保证这个参数是第一个参数。在环绕通知中必须显式的通过调用 ProceedingJoinPoint 来执行目标方法，否则目标方法不会执行。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证增强</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorValidationAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Before(value = &quot;execution(* cn.xisun.spring.aop.ArithmeticCalculatorImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;验证方法开始执行&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = joinPoint.getTarget().getClass();<span class="comment">// 当前执行的方法所属的类</span></span><br><span class="line">        String name = joinPoint.getSignature().getName();<span class="comment">// 当前执行的方法名</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();<span class="comment">// 当前执行的方法的参数</span></span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            validate((<span class="keyword">int</span>) arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (number &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：测试方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        ArithmeticCalculator arithmeticCalculatorImpl = context.getBean(<span class="string">&quot;arithmeticCalculatorImpl&quot;</span>, ArithmeticCalculatorImpl.class);</span><br><span class="line">        Integer addResult = arithmeticCalculatorImpl.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;计算结果：&quot;</span> + addResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">Spring 测试版本：<span class="number">5.2</span>.<span class="number">7.</span>RELEASE</span><br><span class="line">验证方法开始执行</span><br><span class="line"><span class="meta">@Around</span> 环绕通知之前</span><br><span class="line"><span class="meta">@Before</span> 前置通知</span><br><span class="line">add 核心方法</span><br><span class="line"><span class="meta">@AfterReturning</span> 后置通知</span><br><span class="line"><span class="meta">@After</span> 最终通知</span><br><span class="line"><span class="meta">@Around</span> 环绕通知之后</span><br><span class="line">计算结果：<span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进阶操作：</p>
<ul>
<li><p><strong>1. 相同的切入点抽取：</strong></p>
<ul>
<li><p>在编写 AspectJ 切面时，可以直接在通知注解中书写切入点表达式。但同一个切点表达式可能会在多个通知中重复出现。此时，<strong>在 AspectJ 切面中，可以通过 <code>@Pointcut</code> 注解将一个重复的切入点声明成简单的方法，该切入点的方法体通常是空的。</strong></p>
<img src="/2021/04/13/spring-base/image-20210418144525994.png" alt="image-20210418144525994" style="zoom:80%;">
</li>
<li><p>切入点方法的访问权限控制符同时也控制着这个切入点的可见性。如果切入点要在多个切面中共用，最好将它们集中在一个公共的类中。在这种情况下，它们必须被声明为 public。在引入这个切入点时，必须将类名也包括在内。如果类没有与这个切面放在同一个包中，还必须包含包名。</p>
</li>
<li><p>比如，前面的日志增强类，各个通知的切入点表达式主要是 <code>execution(* cn.xisun.spring.dao.ArithmeticCalculatorImpl.*(..))</code>，可以把它单独抽取出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志增强</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingAspect</span> <span class="keyword">implements</span> <span class="title">CutAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 相同的切入点抽取</span></span><br><span class="line">    <span class="meta">@Pointcut(value = &quot;execution(* cn.xisun.spring.dao.ArithmeticCalculatorImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointSame</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Before(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Before 前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@AfterReturning(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterReturning 后置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@After(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@After 最终通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@AfterThrowing(value = &quot;pointSame()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterThrowing 异常通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Around(value = &quot;execution(* cn.xisun.spring.dao.ArithmeticCalculatorImpl.add(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;proceedingJoinPoint: &quot;</span> + proceedingJoinPoint);</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之前&quot;</span>);</span><br><span class="line">        <span class="comment">// 被增强的方法执行，proceed是该方法的返回结果，如果原方法为void，则proceed为null</span></span><br><span class="line">        Object proceed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            proceed = proceedingJoinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之后&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>2. 指定切面的优先级：</strong></p>
<ul>
<li><p><strong>在同一个连接点上应用不止一个切面时，除非明确指定，否则它们的优先级是不确定的。切面的优先级可以通过实现 <code>Ordered</code> 接口或利用 <code>@Order(数值类型值)</code> 注解指定。</strong></p>
</li>
<li><p>若是实现 Ordered 接口，<code>getOrder()</code> 方法的返回值越小，优先级越高。</p>
</li>
<li><p>若是使用 <code>@Order(数值类型值)</code> 注解，数字类型值越小，优先级越高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorLoggingAspect</span> <span class="keyword">implements</span> <span class="title">CutAspect</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorValidationAspect</span> <span class="keyword">implements</span> <span class="title">CutAspect</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="完全使用注解方式实现"><a href="#完全使用注解方式实现" class="headerlink" title="完全使用注解方式实现"></a>完全使用注解方式实现</h4><ul>
<li><p>第一步：创建配置类，替代 xml 配置文件。其他操作，与基于注解方式实现 AOP 操作相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring.aop&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAopConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@Configuration</code>：表示这是一个配置类。</li>
<li><code>@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring.aop&quot;&#125;)</code>：配置包扫描路径为 <code>cn.xisun.spring.aop</code>。</li>
<li><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code>：表示开启 AOP 自动代理。如果被增强类有接口，需指定 proxy-target-class 为 true，如果被增强类没有接口，不需要指定这个参数。</li>
</ul>
</li>
<li><p>第二步：编写测试代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(SpringAopConfig.class);</span><br><span class="line">        ArithmeticCalculator arithmeticCalculatorImpl = context.getBean(<span class="string">&quot;arithmeticCalculatorImpl&quot;</span>, ArithmeticCalculatorImpl.class);</span><br><span class="line">        Integer addResult = arithmeticCalculatorImpl.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;计算结果：&quot;</span> + addResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">输出结果：</span><br><span class="line">Spring 测试版本：<span class="number">5.2</span>.<span class="number">7.</span>RELEASE</span><br><span class="line">验证方法开始执行</span><br><span class="line"><span class="meta">@Around</span> 环绕通知之前</span><br><span class="line"><span class="meta">@Before</span> 前置通知</span><br><span class="line">add 核心方法</span><br><span class="line"><span class="meta">@AfterReturning</span> 后置通知</span><br><span class="line"><span class="meta">@After</span> 最终通知</span><br><span class="line"><span class="meta">@Around</span> 环绕通知之后</span><br><span class="line">计算结果：<span class="number">3</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="基于-xml-配置文件实现"><a href="#基于-xml-配置文件实现" class="headerlink" title="基于 xml 配置文件实现"></a>基于 xml 配置文件实现</h4><ul>
<li><p>了解，不建议深究。</p>
</li>
<li><p>除了使用 AspectJ 注解声明切面，Spring 也支持在 bean 配置文件中声明切面。这种声明是通过 AOP 名称空间中的 xml 元素完成的。</p>
</li>
<li><p><strong>正常情况下，基于注解的声明要优先于基于 xml 的声明，尽可能不使用基于 xml 的声明。</strong>通过 AspectJ 注解，切面可以与 AspectJ 兼容，而基于 xml 的配置则是 Spring 专有的。由于 AspectJ 得到越来越多的 AOP 框架支持，因此以注解风格编写的切面将会有更多重用的机会。</p>
</li>
<li><p>具体步骤：</p>
<ul>
<li><p>第一步：编写 Spring 配置文件，引入 aop 名称空间，并开启自动代理功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启Aspect生成代理对象--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：定义增强类和被增强类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="function">Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要被增强的类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorImpl</span> <span class="keyword">implements</span> <span class="title">ArithmeticCalculator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">add</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;add 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i + j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">subtract</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;subtract 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i - j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">multiply</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;multiply 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i * j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">div</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;div 核心方法&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i / j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CutAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知：在方法执行前执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 后置通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 环绕通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> proceedingJoinPoint.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最终通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志增强</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingAspect</span> <span class="keyword">implements</span> <span class="title">CutAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Before 前置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterReturning 后置通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@After 最终通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterThrowing 异常通知&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之前&quot;</span>);</span><br><span class="line">        <span class="comment">// 被增强的方法执行，proceed是该方法的返回结果，如果原方法为void，则proceed为null</span></span><br><span class="line">        Object proceed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            proceed = proceedingJoinPoint.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;@Around 环绕通知之后&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证增强</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArithmeticCalculatorValidationAspect</span> <span class="keyword">implements</span> <span class="title">CutAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;验证方法开始执行&quot;</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = joinPoint.getTarget().getClass();<span class="comment">// 当前执行的方法所属的类</span></span><br><span class="line">        String name = joinPoint.getSignature().getName();<span class="comment">// 当前执行的方法名</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();<span class="comment">// 当前执行的方法的参数</span></span><br><span class="line">        <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">            validate((<span class="keyword">int</span>) arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (number &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;positive numbers only: &quot;</span> + number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：在 Spring 配置文件中配置两个类的对象。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置增强类LoggingAspect和被增强类ArithmeticCalculatorImpl的对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;arithmeticCalculatorImpl&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.dao.ArithmeticCalculatorImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;loggingAspect&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cn.xisun.spring.dao.LoggingAspect&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：配置切入点和切面。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置aop切入点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置切入点表达式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;add&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* cn.xisun.spring.dao.ArithmeticCalculatorImpl.add(..))&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;all&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* cn.xisun.spring.dao.ArithmeticCalculatorImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;loggingAspect&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置通知的类型，以及对应的切入点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;before&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;after&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">method</span>=<span class="string">&quot;afterReturning&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">method</span>=<span class="string">&quot;afterThrowing&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">method</span>=<span class="string">&quot;around&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;add&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 bean 配置文件中，所有的 Spring AOP 配置都必须定义在 <code>&lt;aop:config&gt;</code> 元素内部。对于每个切面而言，都要创建一个 <code>&lt;aop:aspect&gt;</code> 元素来为具体的切面实现引用后端 bean 实例。切面 bean 必须有一个标识符，供 <code>&lt;aop:aspect&gt;</code> 元素引用。</li>
<li>切入点：<ul>
<li>切入点使用 <code>&lt;aop:pointcut&gt;</code> 元素声明。</li>
<li>切入点必须定义在 <code>&lt;aop:aspect&gt;</code> 元素下，或者直接定义在 <code>&lt;aop:config&gt;</code> 元素下。</li>
<li>切入点定义在 <code>&lt;aop:aspect&gt;</code> 元素下时：只对当前切面有效。</li>
<li>切入点定义在 <code>&lt;aop:config&gt;</code> 元素下：对所有切面都有效。</li>
<li>基于 xml 的 AOP 配置不允许在切入点表达式中用名称引用其他切入点。</li>
</ul>
</li>
<li>通知：<ul>
<li>在 aop 名称空间中，每种通知类型都对应一个特定的 xml 元素。</li>
<li>通知元素需要使用 <code>&lt;pointcut-ref&gt;</code> 来引用切入点，或用 <code>&lt;pointcut&gt;</code> 直接嵌入切入点表达式。</li>
<li>method 属性指定切面类中通知方法的名称。</li>
</ul>
</li>
<li>xml 在配置带参数的通知时，有部分细节未搞清楚，ArithmeticCalculatorValidationAspect 配置不成功，不做探讨了。</li>
</ul>
</li>
<li><p>第五步：测试方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        ArithmeticCalculator arithmeticCalculatorImpl = context.getBean(<span class="string">&quot;arithmeticCalculatorImpl&quot;</span>, ArithmeticCalculatorImpl.class);</span><br><span class="line">        Integer add = arithmeticCalculatorImpl.add(<span class="number">7</span>, <span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;计算结果：&quot;</span> + add);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="JdbcTemplate"><a href="#JdbcTemplate" class="headerlink" title="JdbcTemplate"></a>JdbcTemplate</h2><ul>
<li><p>为了使 JDBC 更加易于使用，Spring 在 JDBC API 上定义了一个抽象层，以此建立一个 JDBC 存取框架。</p>
</li>
<li><p>作为 Spring JDBC 框架的核心，JDBC 模板的设计目的是为不同类型的 JDBC 操作提供模板方法，通过这种方式，可以在尽可能保留灵活性的情况下，将数据库存取的工作量降到最低。</p>
</li>
<li><p>可以将 Spring 的 JdbcTemplate 看作是一个小型的轻量级持久化层框架，和我们之前使用过的 DBUtils 风格非常接近。</p>
</li>
<li><p>第一步：引入 JDBC 和 MySQL 的相关依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring jdbc相关依赖--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring-jdbc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-tx: 事务相关 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-orm: 整合Mybatis等框架需要 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- druid连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- mysql驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：开启组件扫描。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启组件扫描 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：配置数据库连接池。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置数据库连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.driverClass&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.userName&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">prop.driverClass</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">prop.url</span>=<span class="string">jdbc:mysql://localhost:3306/userDb</span></span><br><span class="line"><span class="meta">prop.userName</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">prop.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：配置 JdbcTemplate 对象，注入 DataSource。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置JdbcTemplate对象 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第五步：创建 dao 类，在 dao 注入 jdbcTemplate 对象；创建 service 类，在 service 类注入 dao 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * dao类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;<span class="comment">// 注入JdbcTemplate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * service类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;<span class="comment">// 注入dao</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JdbcTemplate 操作数据库 — <strong>添加、修改、删除</strong>。</p>
<ul>
<li><p>创建对应数据库表的实体类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String userStatus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String userId, String userName, String userStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">        <span class="keyword">this</span>.userStatus = userStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserStatus</span><span class="params">(String userStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userStatus = userStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = (User) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(userId, user.userId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(userName, user.userName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(userStatus, user.userStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = userId != <span class="keyword">null</span> ? userId.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (userName != <span class="keyword">null</span> ? userName.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + (userStatus != <span class="keyword">null</span> ? userStatus.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;userId=&#x27;&quot;</span> + userId + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, userName=&#x27;&quot;</span> + userName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, userStatus=&#x27;&quot;</span> + userStatus + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 dao 中调用 JdbcTemplate 对象里面的 <strong><code>update()</code></strong> 进行数据库添加、修改和删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(String userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建sql语句</span></span><br><span class="line">        String sql = <span class="string">&quot;insert into t_user values(?, ?, ?)&quot;</span>;</span><br><span class="line">        <span class="comment">// 2.设置参数</span></span><br><span class="line">        Object[] args = &#123;user.getUserId(), user.getUserName(), user.getUserStatus()&#125;;</span><br><span class="line">        <span class="comment">// 3.调用方法实现</span></span><br><span class="line">        <span class="keyword">int</span> update = jdbcTemplate.update(sql, args);</span><br><span class="line">        System.out.println(update);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update t_user set user_name = ?, user_status = ? where user_id = ?&quot;</span>;</span><br><span class="line">        Object[] args = &#123;user.getUserName(), user.getUserStatus(), user.getUserId()&#125;;</span><br><span class="line">        <span class="keyword">int</span> update = jdbcTemplate.update(sql, args);</span><br><span class="line">        System.out.println(update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;delete from t_user where user_id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span> update = jdbcTemplate.update(sql, userId);</span><br><span class="line">        System.out.println(update);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userDao.add(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userDao.update(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        userDao.delete(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试方法，执行 service 类相应方法实现添加、修改和删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        UserService userService = context.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line">        </span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserId(<span class="string">&quot;1000&quot;</span>);</span><br><span class="line">        user.setUserName(<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        user.setUserStatus(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加</span></span><br><span class="line">        userService.addUser(user);</span><br><span class="line">        <span class="comment">// 修改</span></span><br><span class="line">        user.setUserStatus(<span class="string">&quot;ng&quot;</span>);</span><br><span class="line">        userService.updateUser(user);</span><br><span class="line">        <span class="comment">// 删除</span></span><br><span class="line">        userService.deleteUser(<span class="string">&quot;1000&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>JdbcTemplate 操作数据库 — <strong>查询返回某个值、查询返回对象、查询返回集合</strong>。</p>
<ul>
<li><p>在 dao 中调用 JdbcTemplate 对象里面的 <strong><code>query()</code> 和 <code>queryForObject()</code></strong> 进行数据库相应查询操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Integer <span class="title">selectCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findUser</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAllUser</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">selectCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select count(*) from t_user&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, Integer.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUser</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select * from t_user where user_id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> BeanPropertyRowMapper&lt;&gt;(User.class), userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;select * from t_user&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(sql, <span class="keyword">new</span> BeanPropertyRowMapper&lt;&gt;(User.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>RowMapper 是一个函数式接口，其中只有一个方法：<code>T mapRow(ResultSet rs, int rowNum) throws SQLException</code>，该方法的具体作用是将查询得到的每行数据映射到 ResultSet 中。</p>
<p>BeanPropertyRowMapper 类实现了 RowMapper 接口，其功能是：将查询得到的结果集的值，注入到对象属性中。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">selectCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.selectCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUser</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findUser(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findAllUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试方法，执行 service 类相应方法实现查询返回某个值、查询返回对象和查询返回集合操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        UserService userService = context.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询返回某个值</span></span><br><span class="line">        Integer number = userService.selectCount();</span><br><span class="line">        System.out.println(number);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询返回对象</span></span><br><span class="line">        User user = userService.findUser(<span class="string">&quot;1001&quot;</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询返回集合</span></span><br><span class="line">        List&lt;User&gt; allUser = userService.findAllUser();</span><br><span class="line">        System.out.println(allUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>JdbcTemplate 操作数据库 — <strong>批量添加、修改和删除操作</strong>。</p>
<ul>
<li><p>在 dao 中调用 JdbcTemplate 对象里面的 <strong><code>batchUpdate()</code></strong> 进行数据库批量添加、修改和删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">batchAddUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">batchUpdateUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">batchDeleteUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoImpl</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchAddUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;insert into t_user values(?, ?, ?)&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span>[] ints = jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchUpdateUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update t_user set user_name = ?, user_status = ? where user_id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span>[] ints = jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchDeleteUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;delete from t_user where user_id = ?&quot;</span>;</span><br><span class="line">        <span class="keyword">int</span>[] ints = jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchAddUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        userDao.batchAddUser(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchUpdateUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        userDao.batchUpdateUser(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchDeleteUser</span><span class="params">(List&lt;Object[]&gt; batchArgs)</span> </span>&#123;</span><br><span class="line">        userDao.batchDeleteUser(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试方法，执行 service 类相应方法实现批量添加、修改和删除操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        UserService userService = context.getBean(<span class="string">&quot;userService&quot;</span>, UserService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量添加</span></span><br><span class="line">        List&lt;Object[]&gt; batchArgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 方式一</span></span><br><span class="line">        List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="string">&quot;1001&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;ok&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="string">&quot;1002&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;ok&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> User(<span class="string">&quot;1003&quot;</span>, <span class="string">&quot;Mike&quot;</span>, <span class="string">&quot;ok&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (User user : list) &#123;</span><br><span class="line">            batchArgs.add(<span class="keyword">new</span> Object[]&#123;user.getUserId(), user.getUserName(), user.getUserStatus()&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 方式二</span></span><br><span class="line">        <span class="comment">/*Object[] o1 = &#123;&quot;1001&quot;, &quot;Tom&quot;, &quot;ok&quot;&#125;;</span></span><br><span class="line"><span class="comment">        Object[] o2 = &#123;&quot;1002&quot;, &quot;Jerry&quot;, &quot;ok&quot;&#125;;</span></span><br><span class="line"><span class="comment">        Object[] o3 = &#123;&quot;1003&quot;, &quot;Mike&quot;, &quot;ok&quot;&#125;;</span></span><br><span class="line"><span class="comment">        batchArgs.add(o1);</span></span><br><span class="line"><span class="comment">        batchArgs.add(o2);</span></span><br><span class="line"><span class="comment">        batchArgs.add(o3);*/</span></span><br><span class="line">        userService.batchAddUser(batchArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量修改</span></span><br><span class="line">        List&lt;Object[]&gt; batchArgs1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Object[] o4 = &#123;<span class="string">&quot;1001&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;ng&quot;</span>&#125;;</span><br><span class="line">        Object[] o5 = &#123;<span class="string">&quot;1002&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="string">&quot;ng&quot;</span>&#125;;</span><br><span class="line">        Object[] o6 = &#123;<span class="string">&quot;1003&quot;</span>, <span class="string">&quot;Mike&quot;</span>, <span class="string">&quot;ng&quot;</span>&#125;;</span><br><span class="line">        batchArgs1.add(o4);</span><br><span class="line">        batchArgs1.add(o5);</span><br><span class="line">        batchArgs1.add(o6);</span><br><span class="line">        userService.batchUpdateUser(batchArgs1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量删除</span></span><br><span class="line">        List&lt;Object[]&gt; batchArgs2 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Object[] o7 = &#123;<span class="string">&quot;1002&quot;</span>&#125;;</span><br><span class="line">        Object[] o8 = &#123;<span class="string">&quot;1003&quot;</span>&#125;;</span><br><span class="line">        batchArgs2.add(o7);</span><br><span class="line">        batchArgs2.add(o8);</span><br><span class="line">        userService.batchDeleteUser(batchArgs2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="事务操作"><a href="#事务操作" class="headerlink" title="事务操作"></a>事务操作</h2><ul>
<li><p>事务是数据库操作的最基本单元，是一组由于逻辑上紧密关联而合并成一个整体 (工作单元) 的多个数据库操作，这些操作要么都执行成功，如果有一个失败所有操作都失败。典型应用场景：银行转账。</p>
</li>
<li><p><strong>事务的四个特性 (ACID)：</strong></p>
<ul>
<li><strong>原子性</strong> (atomicity)：原子的本意是不可再分，事务的原子性表现为一个事务中涉及到的多个操作在逻辑上缺一不可。<strong>事务的原子性要求事务中的所有操作要么都执行，要么都不执行。</strong></li>
<li><strong>一致性</strong> (consistency)：一致指的是数据的一致，具体是指：所有数据都处于满足业务规则的一致性状态。<strong>一致性原则要求：一个事务中不管涉及到多少个操作，都必须保证事务执行之前数据是正确的，事务执行之后数据仍然是正确的。</strong>如果一个事务在执行的过程中，其中某一个或某几个操作失败了，则必须将其他所有操作撤销，将数据恢复到事务执行之前的状态，这就是<strong>回滚</strong>。</li>
<li><strong>隔离性</strong> (isolation)：在应用程序实际运行过程中，事务往往是并发执行的，所以很有可能有许多事务同时处理相同的数据，因此每个事务都应该与其他事务隔离开来，防止数据损坏。<strong>隔离性原则要求多个事务在并发执行过程中不会互相干扰。</strong></li>
<li><strong>持久性</strong> (durability)：持久性原则要求事务执行完成后，对数据的修改永久的保存下来，不会因各种系统错误或其他意外情况而受到影响。通常情况下，事务对数据的修改应该被写入到持久化存储器中。</li>
</ul>
</li>
<li><p>事务管理一般添加到 JavaEE 三层结构里面的 Service 层 (业务逻辑层)。</p>
</li>
<li><p>事务管理操作有两种方式：</p>
<ul>
<li>编程式事务管理：<ul>
<li>执行步骤 — 使用原生的 JDBC API 进行事务管理：<ul>
<li>获取数据库连接Connection对象</li>
<li>取消事务的自动提交</li>
<li>执行操作</li>
<li>正常完成操作时手动提交事务</li>
<li>执行失败时回滚事务</li>
<li>关闭相关资源</li>
</ul>
</li>
<li>使用原生的 JDBC API 实现事务管理是所有事务管理方式的基石，同时也是最典型的编程式事务管理。编程式事务管理需要将事务管理代码嵌入到业务方法中来控制事务的提交和回滚。在使用编程的方式管理事务时，必须在每个事务操作中包含额外的事务管理代码。相对于核心业务而言，事务管理的代码显然属于非核心业务，如果多个模块都使用同样模式的代码进行事务管理，显然会造成较大程度的代码冗余。</li>
</ul>
</li>
<li><strong>声明式事务管理：</strong><ul>
<li>大多数情况下声明式事务比编程式事务管理更好：它将事务管理代码从业务方法中分离出来，以声明的方式来实现事务管理。事务管理代码的固定模式作为一种横切关注点，可以通过 AOP 方法模块化，进而借助 Spring AOP 框架实现声明式事务管理。</li>
</ul>
</li>
<li><strong>Spring 既支持编程式事务管理，也支持声明式事务管理。</strong><ul>
<li><strong>Spring 进行声明式事务管理，底层使用 AOP 原理。</strong></li>
<li>Spring 在不同的事务管理 API 之上定义了一个抽象层，通过配置的方式使其生效，从而让应用程序开发人员不必了解事务管理 API 的底层实现细节，就可以使用 Spring 的事务管理机制。</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring 的事务管理器：</p>
<ul>
<li><p><strong>Spring 的核心事务管理抽象是 PlatformTransactionManager。</strong>它为事务管理封装了一组独立于技术的方法。无论使用 Spring 的哪种事务管理策略 (编程式或声明式)，事务管理器都是必须的。</p>
<p><img src="/2021/04/13/spring-base/image-20210421144320340.png" alt="image-20210421144320340"></p>
<ul>
<li><strong>DataSourceTransactionManager</strong>：在应用程序中只需要处理一个数据源，而且通过 JDBC 存取。</li>
<li><strong>JtaTransactionManager</strong>：在 JavaEE 应用服务器上用 JTA (Java Transaction API) 进行事务管理。</li>
<li><strong>HibernateTransactionManager</strong>：用 Hibernate 框架存取数据库。</li>
</ul>
</li>
<li><p>事务管理器可以以普通的 bean 的形式声明在 Spring IOC 容器中。</p>
</li>
</ul>
</li>
<li><p>Spring 声明式事务管理的两种实现方式：</p>
<ul>
<li>基于 xml 配置文件方式</li>
<li><strong>基于注解方式 (常用)</strong></li>
</ul>
</li>
<li><p><strong>Spring 基于注解实现声明式事务管理：</strong></p>
<ul>
<li><p>第一步：引入 jdbc 和 mysql 的相关依赖、开启组件扫描、配置数据库连接池、配置 JdbcTemplate 对象，注入 DataSource。具体操作见 JdbcTemplate。</p>
</li>
<li><p>第二步：在 Spring 配置文件中，配置事务管理器并注入数据源。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>事务管理器的名字一定要叫 transactionManager，不然会抛异常。</p>
</blockquote>
</li>
<li><p>第三步：在 Spring 配置文件中，引入 tx 名称空间并开启事务注解。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 开启事务注解 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第四步：创建 dao 类，在 dao 注入 jdbcTemplate 对象；创建 service 类，在 service 类注入 dao 对象。具体操作见 JdbcTemplate。</p>
</li>
<li><p>第五步：在需要进行事务控制的方法或类上添加 <code>@Transactional</code> 注解。</p>
<ul>
<li>如果把 <code>@Transactional</code> 注解添加类上面，则这个类里面所有的方法都添加事务。</li>
<li>如果把 <code>@Transactional</code> 注解添加方法上面，则为这个方法添加事务。</li>
</ul>
</li>
<li><p>代码一览：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启组件扫描 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;cn.xisun.spring.dao,cn.xisun.spring.service&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置数据库连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.driverClass&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.userName&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置JdbcTemplate对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启事务注解 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer accountId;</span><br><span class="line">    <span class="keyword">private</span> String accountName;</span><br><span class="line">    <span class="keyword">private</span> Integer accountBalance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(Integer accountId, String accountName, Integer accountBalance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">        <span class="keyword">this</span>.accountName = accountName;</span><br><span class="line">        <span class="keyword">this</span>.accountBalance = accountBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAccountId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountId</span><span class="params">(Integer accountId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountId = accountId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAccountName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountName</span><span class="params">(String accountName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountName = accountName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAccountBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accountBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccountBalance</span><span class="params">(Integer accountBalance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accountBalance = accountBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Account account = (Account) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(accountId, account.accountId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(accountName, account.accountName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(accountBalance, account.accountBalance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = accountId != <span class="keyword">null</span> ? accountId.hashCode() : <span class="number">0</span>;</span><br><span class="line">        result = <span class="number">31</span> * result + (accountName != <span class="keyword">null</span> ? accountName.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + (accountBalance != <span class="keyword">null</span> ? accountBalance.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Account&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;accountId=&quot;</span> + accountId +</span><br><span class="line">                <span class="string">&quot;, accountName=&#x27;&quot;</span> + accountName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, accountBalance=&quot;</span> + accountBalance +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reduceMoney</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addMoney</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上面两个方法可以合并</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">tranfer</span><span class="params">(String accountName, <span class="keyword">int</span> money)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDaoImpl</span> <span class="keyword">implements</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lucy少钱</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update t_account set account_balance = account_balance - ? where account_name = ?&quot;</span>;</span><br><span class="line">        jdbcTemplate.update(sql, <span class="number">100</span>, <span class="string">&quot;lucy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mary多钱</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">&quot;update t_account set account_balance = account_balance + ? where account_name = ?&quot;</span>;</span><br><span class="line">        jdbcTemplate.update(sql, <span class="number">100</span>, <span class="string">&quot;mary&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上面两个方法可以合并</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">tranfer</span><span class="params">(String accountName, <span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 SQL 语句</span></span><br><span class="line">        String sql = <span class="string">&quot;update t_account set account_balance = account_balance - ? where account_name = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SQL 语句参数</span></span><br><span class="line">        Object[] args = &#123;money, accountName&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行 SQL 语句</span></span><br><span class="line">        <span class="keyword">int</span> insertRows = jdbcTemplate.update(sql, args);</span><br><span class="line">        <span class="keyword">return</span> insertRows;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转账的方法一</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accountMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// lucy 少 100</span></span><br><span class="line">        accountDao.reduceMoney();</span><br><span class="line">        <span class="comment">// mary 多 100</span></span><br><span class="line">        accountDao.addMoney();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转账的方法二</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(String srcAccountName, String destAccountName, <span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        accountDao.tranfer(srcAccountName, money);</span><br><span class="line">        accountDao.tranfer(destAccountName, -money);</span><br><span class="line">        System.out.println(srcAccountName + <span class="string">&quot; 向 &quot;</span> + destAccountName + <span class="string">&quot; 转账 &quot;</span> + money + <span class="string">&quot; 元&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">        AccountService accountService = context.getBean(<span class="string">&quot;accountService&quot;</span>, AccountService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试方法一</span></span><br><span class="line">        accountService.accountMoney();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试方法二</span></span><br><span class="line">        accountService.transfer(<span class="string">&quot;lucy&quot;</span>, <span class="string">&quot;mary&quot;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Spring 声明式事务管理参数配置：</p>
<ul>
<li><p><code>@Transactional</code> 注解里面可以配置事务的相关参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional &#123;</span><br><span class="line">    <span class="meta">@AliasFor(&quot;transactionManager&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> -1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">readOnly</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] rollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] noRollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>propagation：事务传播行为。</strong></p>
<ul>
<li><p>对数据库表数据进行变化的操作叫事务方法。<strong>当一个事务方法被另一个事务方法调用时，必须指定事务应该如何传播。</strong></p>
</li>
<li><p>事务的传播行为可以由传播属性指定，Spring 中定义了 7 种传播行为：</p>
<p><img src="/2021/04/13/spring-base/image-20210421162909301.png" alt="image-20210421162909301"></p>
</li>
<li><p>REQUIRED 和 REQUIRED_NEW 是常用的两种事务传播行为。<strong>REQUIRED 是默认的事务传播行为。</strong></p>
</li>
<li><p>REQUIRED 和 REQUIRED_NEW 的区别示例如下：</p>
<p><img src="/2021/04/13/spring-base/image-20210421163823116.png" alt="image-20210421163823116"></p>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 propagation 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 propagation 属性值，设置事务传播行为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRES_NEW&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>isolation：事务隔离级别。</strong></p>
<ul>
<li><p>事务的特性之一是隔离性，能够使得多事务在执行过程中，不会互相干扰。</p>
</li>
<li><p>但是，如果不考虑事务的隔离性，会产生三个读的问题：<strong>脏读、不可重复读、幻 (虚) 读。</strong></p>
<ul>
<li>脏读：一个未提交的事务读取到另一个事务未提交的数据。通俗点说：事务 A 更新了数据，但事务 A 还未提交，数据就被事务 B 读取了。</li>
<li>不可重复读：一个未提交的事务读取到另一个已提交事务修改的数据。通俗点说：一个事务中多次读取一个数据的结果不一致。</li>
<li>幻 (虚) 读：一个未提交的事务读取到另一个已提交事务新增的数据。通俗点说：一个事务多次读取同一个条件的数据时，数据的总条目不一致。</li>
</ul>
</li>
<li><p>举例说明，假设现在有两个事务：Transaction01 和 Transaction02 并发执行。</p>
<ul>
<li>① 脏读：<ul>
<li>[1] Transaction01 将某条记录的 AGE 值从 20 修改为 30，但还未提交。</li>
<li>[2] Transaction02 读取了 Transaction01 更新后的值：30。</li>
<li>[3] Transaction01 回滚，AGE 值恢复到了 20。</li>
<li>[4] Transaction02 读取到的 30 就是一个无效的值。</li>
</ul>
</li>
<li>② 不可重复读：<ul>
<li>[1] Transaction01 读取了 AGE 值为 20。</li>
<li>[2] Transaction02 将 AGE 值修改为 30 并提交。</li>
<li>[3] Transaction01 再次读取 AGE 值为 30，和第一次读取不一致。</li>
</ul>
</li>
<li>③ 幻 (虚) 读：<ul>
<li>[1] Transaction01 读取了 STUDENT 表中的一部分数据。</li>
<li>[2] Transaction02 向 STUDENT 表中插入了新的行。</li>
<li>[3] Transaction01 同一条件下再次读取 STUDENT 表时，多出了一些行。</li>
</ul>
</li>
</ul>
</li>
<li><p>通过设置事务隔离级别，解决读问题：</p>
<ul>
<li><p>数据库系统必须具有隔离并发运行各个事务的能力，使它们不会相互影响，避免各种并发问题。一个事务与其他事务隔离的程度称为隔离级别。SQL标准中规定了多种事务隔离级别，不同隔离级别对应不同的干扰程度，隔离级别越高，数据一致性就越好，但并发性越弱。</p>
</li>
<li><p><strong>各个隔离级别解决并发问题的能力：</strong></p>
<table>
<thead>
<tr>
<th align="center">隔离级别</th>
<th align="center">脏读</th>
<th align="center">不可重复读</th>
<th align="center">幻 (虚) 读</th>
</tr>
</thead>
<tbody><tr>
<td align="center">READ UNCOMMITTED (读未提交)</td>
<td align="center">有</td>
<td align="center">有</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">READ COMMITTED (读已提交)</td>
<td align="center">无</td>
<td align="center">有</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">REPEATABLE READ (可重复读)</td>
<td align="center">无</td>
<td align="center">无</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">SERIALIZABLE (串行化)</td>
<td align="center">无</td>
<td align="center">无</td>
<td align="center">无</td>
</tr>
</tbody></table>
</li>
<li><p><strong>各种数据库产品对事务隔离级别的支持程度：</strong></p>
<table>
<thead>
<tr>
<th align="center">隔离级别</th>
<th align="center">Oracle</th>
<th align="center">MySQL</th>
</tr>
</thead>
<tbody><tr>
<td align="center">READ UNCOMMITTED</td>
<td align="center">×</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">READ COMMITTED</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">REPEATABLE READ</td>
<td align="center">×</td>
<td align="center">√ (默认)</td>
</tr>
<tr>
<td align="center">SERIALIZABLE</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 isolation 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 isolation 属性值，设置事务隔离级别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">isolation</span>=<span class="string">&quot;REPEATABLE_READ&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>timeout：事务超时时间。</strong></p>
<ul>
<li><p>事务需要在一定时间内进行提交，如果不提交则进行回滚。</p>
</li>
<li><p>默认值是 -1，设置时间以秒为单位。</p>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 timeout 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 timeout 属性值，设置事务超时时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(timeout = 20)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>readOnly：事务是否只读。</strong></p>
<ul>
<li><p>读：查询操作，写：添加、修改、删除操作。</p>
</li>
<li><p>由于事务可以在行和表上获得锁，因此长事务会占用资源，并对整体性能产生影响。如果一个事物只读取数据但不做修改，数据库引擎可以对这个事务进行优化。</p>
</li>
<li><p>readOnly 默认值为 false，表示可以查询，也可以添加、修改和删除。</p>
</li>
<li><p>若设置 readOnly 值是 true，表示这个事务只读取数据但不更新数据, 这样可以帮助数据库引擎优化事务。</p>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 readOnly 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 read-only 属性值，设置事务超时时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(readOnly = true)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>rollbackFor：事务回滚触发条件。</strong></p>
<ul>
<li><p>设置出现哪些异常时，必须进行事务回滚，可以为多个。</p>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 rollbackFor 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 rollback-for 属性值，设置事务超时时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = &#123;IOException.class, SQLException.class&#125;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">rollback-for</span>=<span class="string">&quot;java.io.IOException, java.sql.SQLException&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>noRollbackFor：事务不回滚触发条件。</strong></p>
<ul>
<li><p>设置出现哪些异常时，不进行事务回滚，可以为多个。</p>
</li>
<li><p>Spring 中，可以通过指定 <code>@Transactional</code> 注解的 noRollbackFor 属性的值，或者在 xml 文件中通过 <code>&lt;tx:method&gt;</code> 元素的 no-rollback-for 属性值，设置事务超时时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(noRollbackFor = &#123;ArithmeticException.class&#125;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">no-rollback-for</span>=<span class="string">&quot;java.lang.ArithmeticException&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring 基于 xml 配置文件实现声明式事务管理 (了解)：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 配置数据库连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.driverClass&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.userName&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;prop.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置JdbcTemplate对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据源dataSource --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置通知 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置事务参数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定哪种规则的方法上面添加事务 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;accountMoney&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> <span class="attr">no-rollback-for</span>=<span class="string">&quot;java.lang.ArithmeticException&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 下面的配置含义是account开头的方法 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;tx:method name=&quot;account*&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置切入点和切面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置切入点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pt&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* cn.xisun.spring.service.AccountService.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置切面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pt&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Spring 基于完全注解实现声明式事务管理：</strong></p>
<ul>
<li><p>方式一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建数据库连接池</span></span><br><span class="line"><span class="comment">     *      从jdbc.properties配置文件中获取数据库连接信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Bean注解：该注解只能写在方法上，表明使用此方法创建一个对象，并且放入Spring容器。</span></span><br><span class="line"><span class="comment">     * name属性：给当前<span class="doctag">@Bean</span>注解方法创建的对象指定一个名称(即bean的id)，默认bean的名称就是其方法名。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSource的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties pros = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> (InputStream resource = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>)) &#123;</span><br><span class="line">            pros.load(resource);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(pros.getProperty(<span class="string">&quot;prop.driverClass&quot;</span>));</span><br><span class="line">        dataSource.setUrl(pros.getProperty(<span class="string">&quot;prop.url&quot;</span>));</span><br><span class="line">        dataSource.setUsername(pros.getProperty(<span class="string">&quot;prop.userName&quot;</span>));</span><br><span class="line">        dataSource.setPassword(pros.getProperty(<span class="string">&quot;prop.password&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建JdbcTemplate对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为jdbcTemplate的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        jdbcTemplate.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建事务管理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSourceTransactionManager的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSourceTransactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">createDataSourceTransactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>@Configuration</code>：标识这是一个配置类。</p>
<ul>
<li><code>@ComponentScan(basePackages = &quot;cn.xisun.spring&quot;)</code>：配置包扫描路径。</li>
<li><code>@EnableTransactionManagement</code>：开启注解事务管理。</li>
</ul>
</li>
<li><p>方式二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建数据库连接池</span></span><br><span class="line"><span class="comment">     *      从jdbc.properties配置文件中获取数据库连接信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Bean注解：该注解只能写在方法上，表明使用此方法创建一个对象，并且放入Spring容器。</span></span><br><span class="line"><span class="comment">     * name属性：给当前<span class="doctag">@Bean</span>注解方法创建的对象指定一个名称(即bean的id)，默认bean的名称就是其方法名。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSource的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties pros = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">try</span> (InputStream resource = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>)) &#123;</span><br><span class="line">            pros.load(resource);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(pros.getProperty(<span class="string">&quot;prop.driverClass&quot;</span>));</span><br><span class="line">        dataSource.setUrl(pros.getProperty(<span class="string">&quot;prop.url&quot;</span>));</span><br><span class="line">        dataSource.setUsername(pros.getProperty(<span class="string">&quot;prop.userName&quot;</span>));</span><br><span class="line">        dataSource.setPassword(pros.getProperty(<span class="string">&quot;prop.password&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建JdbcTemplate对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为jdbcTemplate的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        jdbcTemplate.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建事务管理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSourceTransactionManager的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSourceTransactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">createDataSourceTransactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">  <span class="meta">@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring&quot;&#125;)</span></span><br><span class="line">  <span class="meta">@EnableTransactionManagement</span></span><br><span class="line">  <span class="meta">@Import(JdbcConfig.class)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfig</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>@Import(JdbcConfig.class)</code>：引入 JdbcConfig.class 配置文件。</p>
</li>
<li><p>方式三：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;cn.xisun.spring&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@PropertySource(value = &quot;classpath:jdbc.properties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;prop.driverClass&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driverClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;prop.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;prop.userName&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;prop.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建数据库连接池</span></span><br><span class="line"><span class="comment">     *      从jdbc.properties配置文件中获取数据库连接信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Bean注解：该注解只能写在方法上，表明使用此方法创建一个对象，并且放入Spring容器。</span></span><br><span class="line"><span class="comment">     * name属性：给当前<span class="doctag">@Bean</span>注解方法创建的对象指定一个名称(即bean的id)，默认bean的名称就是其方法名。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSource的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClass);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(userName);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建JdbcTemplate对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为jdbcTemplate的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;jdbcTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">createJdbcTemplate</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        jdbcTemplate.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建事务管理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource 根据类型匹配从IOC容器中找到DataSource的对象，也就是createDataSource()返回的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 向IOC容器注入一个name为dataSourceTransactionManager的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;dataSourceTransactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">createDataSourceTransactionManager</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@PropertySource(value = &quot;classpath:jdbc.properties&quot;)</code>：标识 properties 配置文件的路径。</li>
</ul>
</li>
<li><p> <code>@Value</code>：给当前属性赋值，取值来源于读取的 jdbc.properties 配置文件中的内容。</p>
</li>
<li><p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Spring 测试版本：&quot;</span> + SpringVersion.getVersion());</span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line">        AccountService accountService = context.getBean(<span class="string">&quot;accountService&quot;</span>, AccountService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试方法一</span></span><br><span class="line">        accountService.accountMoney();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试方法二</span></span><br><span class="line">        accountService.transfer(<span class="string">&quot;lucy&quot;</span>, <span class="string">&quot;mary&quot;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="Spring5-框架部分新功能"><a href="#Spring5-框架部分新功能" class="headerlink" title="Spring5 框架部分新功能"></a>Spring5 框架部分新功能</h2><ul>
<li><p>整个 Spring5 框架的代码基于 JDK 8，运行时兼容 JDK 9，许多不建议使用的类和方法在代码库中被删除。</p>
</li>
<li><p>Spring5 框架自带了通用的日志封装。</p>
<ul>
<li><p>Spring5 已经移除 Log4jConfigListener，官方建议使用 Log4j2。</p>
</li>
<li><p>Spring5 框架整合 Log4j2：</p>
<ul>
<li><p>第一步：引入 jar 包。</p>
<img src="/2021/04/13/spring-base/image-20210423113705184.png" alt="image-20210423113705184" style="zoom:80%;">
</li>
<li><p>第二步：创建 log4j2.xml 配置文件，名称只能是这个。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志级别以及优先级排序: OFF &gt; FATAL &gt; ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE &gt; ALL --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Configuration后面的status用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，可以看到log4j2内部各种详细输出 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 先定义所有的appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 输出日志信息到控制台 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 控制日志输出的格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 然后定义logger，只有定义了logger并引入的appender，appender才会生效 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- root：用于指定项目的根日志，如果没有单独指定Logger，则会使用root作为默认的日志输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring5 框架核心容器支持 <code>@Nullable</code> 注解。</p>
<ul>
<li><p><code>@Nullable</code> 注解可以使用在方法上面，属性上面，参数上面，表示方法返回值可以为空，属性值可以为空，参数值可以为空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用在方法上面，表示方法返回值可以为空</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用在属性上面，表示属性值可以为空</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> String bookName;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用在参数上面，表示参数值可以为空</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">registerBean</span><span class="params">(<span class="meta">@Nullable</span> String beanName, Class&lt;T&gt; beanClass, <span class="meta">@Nullable</span> Supplier&lt;T&gt; supplier, BeanDefinitionCustomizer... customizers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.reader.registerBean(beanClass, beanName, supplier, customizers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Spring5 核心容器支持函数式风格 GenericApplicationContext。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建GenericApplicationContext对象</span></span><br><span class="line">        GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line">        <span class="comment">// 2.调用context的方法注册对象</span></span><br><span class="line">        context.refresh();<span class="comment">// 清空context中的内容</span></span><br><span class="line">        <span class="comment">// context.registerBean(Account.class, Account::new);// 方式一：注册bean</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;account&quot;</span>, Account.class, Account::<span class="keyword">new</span>);<span class="comment">// 方式二：注册bean</span></span><br><span class="line">        <span class="comment">// 3.获取在Spring中注册的对象</span></span><br><span class="line">        <span class="comment">// Account account = (Account) context.getBean(&quot;cn.xisun.spring.entity.Account&quot;);// 方式一：获取bean</span></span><br><span class="line">        Account account = (Account) context.getBean(<span class="string">&quot;account&quot;</span>);<span class="comment">// 方式二：获取bean</span></span><br><span class="line">        System.out.println(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Spring5 支持整合 JUnit5。</p>
<ul>
<li><p>Spring5 整合 JUnit4。</p>
<ul>
<li><p>第一步：引入 Spring 相关针对测试依赖。</p>
<img src="/2021/04/13/spring-base/image-20210423145245658.png" alt="image-20210423145245658" style="zoom: 80%;">
</li>
<li><p>第二步：创建测试类，使用注解方式完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner. class)</span> <span class="comment">//单元测试框架</span></span><br><span class="line"><span class="meta">@ContextConfiguration( &quot;classpath:bean1.xml&quot;)</span> <span class="comment">//加载配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JTest4</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	userService.accountMoney();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Spring5 整合 JUnit5。</p>
<ul>
<li><p>第一步：引入 JUnit5 的依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步：创建测试类，使用注解 <code>@ExtendWith</code> 和 <code>@ContextConfiguration</code> 完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.spring.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.xisun.spring.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.extension.ExtendWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit.jupiter.SpringExtension;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.jupiter.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/23 14:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(&quot;classpath:spring.xml&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        accountService.transfer(<span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步：使用一个复合注解 <code>@SpringJUnitConfig</code> 替代上面两个注解完成整合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.spring.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.xisun.spring.service.AccountService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit.jupiter.SpringJUnitConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.jupiter.api.Assertions.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiSun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2021/4/23 14:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringJUnitConfig(locations = &quot;classpath:spring.xml&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        accountService.transfer(<span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Vf4y127N5">https://www.bilibili.com/video/BV1Vf4y127N5</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/oneby1314/article/details/114259893">https://blog.csdn.net/oneby1314/article/details/114259893</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/09/java-newfeature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/09/java-newfeature/" class="post-title-link" itemprop="url">Java 新特性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-09 16:16:06" itemprop="dateCreated datePublished" datetime="2021-04-09T16:16:06+08:00">2021-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-13 09:01:56" itemprop="dateModified" datetime="2021-04-13T09:01:56+08:00">2021-04-13</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>31 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Java-8-的新特性"><a href="#Java-8-的新特性" class="headerlink" title="Java 8 的新特性"></a>Java 8 的新特性</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li><p>Java 8 (又称为 jdk 1.8) 是 Java 语言开发的一个主要版本。Java 8 是 oracle 公司于 2014 年 3 月发布，<strong>可以看成是自 Java 5 以来最具革命性的版本。</strong>Java 8 为 Java 语言、编译器、类库、开发工具与 JVM 带来了大量新特性。</p>
</li>
<li><p>Java 8 新特性一览：</p>
<img src="/2021/04/09/java-newfeature/image-20210409165532645.png" alt="image-20210409165532645" style="zoom:67%;">

<ul>
<li>速度更快。</li>
<li>代码更少 (增加了新的语法：Lambda 表达式)。</li>
<li>强大的 Stream API。</li>
<li>便于并行。</li>
<li>最大化减少空指针异常：Optional。</li>
<li>Nashorn 引擎，允许在 JVM上运行 JS 应用。</li>
</ul>
</li>
<li><p>并行流和串行流：</p>
<ul>
<li>并行流就是把一个内容分成多个数据块，并用不同的线程分别处理每个数据块的流。相比较串行的流，并行的流可以很大程度上提高程序的执行效率。</li>
<li>Java 8 中将并行进行了优化，我们可以很容易的对数据进行并行操作。Stream API 可以声明性地通过 <code>parallel()</code> 与 <code>sequential()</code> 在并行流与顺序流之间进行切换。</li>
</ul>
</li>
</ul>
<h3 id="Lambda-表达式"><a href="#Lambda-表达式" class="headerlink" title="Lambda 表达式"></a>Lambda 表达式</h3><ul>
<li><p>Lambda 是一个匿名函数，我们可以把 Lambda 表达式理解为是一段可以传递的代码 (将代码像数据一样进行传递)。使用它可以写出更简洁、更灵活的代码。作为一种更紧凑的代码风格，使 Java 的语言表达能力得到了提升。</p>
</li>
<li><p>Lambda 表达式：在 Java 8 语言中引入的一种新的语法元素和操作符。<strong>这个操作符为 “-&gt;”，该操作符被称为 Lambda 操作符或箭头操作符。</strong>它将 Lambda 分为两个部分：</p>
<ul>
<li><strong>左侧</strong>：指定了 Lambda 表达式需要的参数列表。</li>
<li><strong>右侧</strong>：指定了 <strong>Lambda 体</strong>，是抽象方法的实现逻辑，也即 Lambda 表达式要执行的功能。</li>
</ul>
</li>
<li><p>语法格式：</p>
<img src="/2021/04/09/java-newfeature/image-20210409215450100.png" alt="image-20210409215450100" style="zoom:67%;">
</li>
<li><p>类型推断：上述 Lambda 表达式中的参数类型都是由编译器推断得出的。Lambda 表达式中无需指定类型，程序依然可以编译，这是因为 javac 根据程序的上下文，在后台推断出了参数的类型。Lambda 表达式的类型依赖于上下文环境，是由编译器推断出来的。这就是所谓的 **”类型推断”**。</p>
<img src="/2021/04/09/java-newfeature/image-20210409215935816.png" alt="image-20210409215935816" style="zoom:67%;">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 语法格式三：数据类型可以省略，因为可由编译器推断得出，称为&quot;类型推断&quot;</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; con1 = (String s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con1.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; con2 = (s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con2.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">// 类型推断，ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;<span class="comment">// 类型推断，int[] arr = new int[]&#123;1, 2, 3&#125;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Lambda 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lambda表达式的使用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1.举例: (o1,o2) -&gt; Integer.compare(o1,o2);</span></span><br><span class="line"><span class="comment"> * 2.格式:</span></span><br><span class="line"><span class="comment"> *      -&gt;: lambda操作符或箭头操作符</span></span><br><span class="line"><span class="comment"> *      -&gt;左边：lambda形参列表(其实就是接口中的抽象方法的形参列表)</span></span><br><span class="line"><span class="comment"> *      -&gt;右边：lambda体(其实就是重写的抽象方法的方法体)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3.Lambda表达式的使用: (分为6种情况介绍)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    总结:</span></span><br><span class="line"><span class="comment"> *    -&gt;左边: lambda形参列表的参数类型可以省略(类型推断)；如果lambda形参列表只有一个参数，其一对()也可以省略，其他情况不能省略</span></span><br><span class="line"><span class="comment"> *    -&gt;右边: lambda体应该使用一对&#123;&#125;包裹；如果lambda体只有一条执行语句(也可能是return语句)，省略这一对&#123;&#125;和return关键字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4.Lambda表达式的本质: 作为函数式接口的实例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 5.如果一个接口中，只声明了一个抽象方法，则此接口就称为函数式接口。我们可以在一个接口上使用<span class="doctag">@FunctionalInterface</span>注解，</span></span><br><span class="line"><span class="comment"> *   这样做可以检查它是否是一个函数式接口。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 6.所有以前用匿名实现类表示的现在都可以用Lambda表达式来写</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 语法格式一：无参，无返回值</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runnable r1 = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;我爱北京天安门&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        r1.run();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;***********************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Runnable r2 = () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我爱北京故宫&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r2.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语法格式二：Lambda需要一个参数，但是没有返回值。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; con = <span class="keyword">new</span> Consumer&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                System.out.println(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        con.accept(<span class="string">&quot;谎言和誓言的区别是什么？&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; con1 = (String s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">        con1.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语法格式三：数据类型可以省略，因为可由编译器推断得出，称为&quot;类型推断&quot;</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; con1 = (String s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con1.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; con2 = (s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con2.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语法格式四：Lambda若只需要一个参数时，参数的小括号可以省略</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; con1 = (s) -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con1.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; con2 = s -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con2.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语法格式五：Lambda需要两个或以上的参数，多条执行语句，并且可以有返回值</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Comparator&lt;Integer&gt; com1 = <span class="keyword">new</span> Comparator&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Integer o1, Integer o2)</span> </span>&#123;</span><br><span class="line">                System.out.println(o1);</span><br><span class="line">                System.out.println(o2);</span><br><span class="line">                <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(com1.compare(<span class="number">12</span>, <span class="number">21</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*****************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; com2 = (o1, o2) -&gt; &#123;</span><br><span class="line">            System.out.println(o1);</span><br><span class="line">            System.out.println(o2);</span><br><span class="line">            <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(com2.compare(<span class="number">12</span>, <span class="number">6</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 语法格式六：当Lambda体只有一条语句时，return与大括号若有，都可以省略</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Comparator&lt;Integer&gt; com1 = (o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> o1.compareTo(o2);</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(com1.compare(<span class="number">12</span>, <span class="number">6</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*****************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; com2 = (o1, o2) -&gt; o1.compareTo(o2);</span><br><span class="line">        System.out.println(com2.compare(<span class="number">12</span>, <span class="number">21</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Consumer&lt;String&gt; con1 = s -&gt; &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;;</span><br><span class="line">        con1.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*****************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Consumer&lt;String&gt; con2 = s -&gt; System.out.println(s);</span><br><span class="line">        con2.accept(<span class="string">&quot;一个是听得人当真了，一个是说的人当真了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="函数式-Functional-接口"><a href="#函数式-Functional-接口" class="headerlink" title="函数式 (Functional) 接口"></a>函数式 (Functional) 接口</h3><ul>
<li><p>什么是函数式 (Functional) 接口：</p>
<ul>
<li><strong>只包含一个抽象方法的接口，称为函数式接口。</strong></li>
<li>你可以通过 Lambda 表达式来创建该接口的对象。(若 Lambda 表达式抛出一个受检异常 (即：非运行时异常)，那么该异常需要在目标接口的抽象方法上进行声明。)</li>
<li>我们可以在一个接口上使用 <strong><code>@FunctionalInterface</code></strong> 注解，这样做可以检查它是否是一个函数式接口。同时 javadoc 也会包含一条声明，说明这个接口是一个函数式接口。</li>
<li><strong>在 <code>java.util.function</code> 包下定义了 Java 8 的丰富的函数式接口。</strong></li>
</ul>
</li>
<li><p>如何理解函数式接口：</p>
<ul>
<li>Java 从诞生日起就是一直倡导 “一切皆对象”，在 Java 里面面向对象 (OOP) 编程是一切。但是随着 python、scala 等语言的兴起和新技术的挑战，Java 不得不做出调整以便支持更加广泛的技术要求，也即 <strong>Java 不但可以支持 OOP 还可以支持 OOF (面向函数编程)。</strong></li>
<li>在函数式编程语言当中，函数被当做一等公民对待。在将函数作为一等公民的编程语言中，Lambda 表达式的类型是函数。但是在 Java 8 中，有所不同。在 Java 8 中，Lambda 表达式是对象，而不是函数，它们必须依附于一类特别的对象类型——函数式接口。</li>
<li>简单的说，在 Java 8 中，<strong>Lambda 表达式就是一个函数式接口的实例。</strong>这就是 Lambda 表达式和函数式接口的关系。也就是说，只要一个对象是函数式接口的实例，那么该对象就可以用 Lambda 表达式来表示。</li>
<li><strong>所有以前用匿名实现类表示的现在都可以用 Lambda 表达式来写。</strong></li>
</ul>
</li>
<li><p>函数式接口举例：</p>
<img src="/2021/04/09/java-newfeature/image-20210410173448388.png" alt="image-20210410173448388" style="zoom:67%;">
</li>
<li><p>自定义函数式接口：</p>
<ul>
<li><p>函数式接口中不使用泛型：</p>
<img src="/2021/04/09/java-newfeature/image-20210410173951736.png" alt="image-20210410173951736" style="zoom:67%;">
</li>
<li><p>函数式接口中使用泛型：</p>
<img src="/2021/04/09/java-newfeature/image-20210410174041073.png" alt="image-20210410174041073" style="zoom:67%;">
</li>
</ul>
</li>
<li><p>作为参数传递 Lambda 表达式：</p>
<img src="/2021/04/09/java-newfeature/image-20210410174532960.png" alt="image-20210410174532960" style="zoom:67%;">
</li>
<li><p>Java 内置四大核心函数式接口：</p>
<img src="/2021/04/09/java-newfeature/image-20210410193809887.png" alt="image-20210410193809887" style="zoom:67%;">
</li>
<li><p>其他接口：</p>
<img src="/2021/04/09/java-newfeature/image-20210410193935197.png" alt="image-20210410193935197" style="zoom:67%;">
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * java内置的4大核心函数式接口：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 消费型接口 Consumer&lt;T&gt;     void accept(T t)</span></span><br><span class="line"><span class="comment"> * 供给型接口 Supplier&lt;T&gt;     T get()</span></span><br><span class="line"><span class="comment"> * 函数型接口 Function&lt;T,R&gt;   R apply(T t)</span></span><br><span class="line"><span class="comment"> * 断定型接口 Predicate&lt;T&gt;    boolean test(T t)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 作为参数传递Lambda表达式</span></span><br><span class="line">    <span class="comment">// happyTime()：将参数1传给函数式接口con，Consumer函数式接口包含唯一方法accept()</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">happyTime</span><span class="params">(<span class="keyword">double</span> money, Consumer&lt;Double&gt; con)</span> </span>&#123;</span><br><span class="line">        con.accept(money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        happyTime(<span class="number">500</span>, <span class="keyword">new</span> Consumer&lt;Double&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Double aDouble)</span> </span>&#123;<span class="comment">// 重写accept()</span></span><br><span class="line">                System.out.println(<span class="string">&quot;学习太累了，去天上人间买了瓶矿泉水，价格为：&quot;</span> + aDouble);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;********************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        happyTime(<span class="number">400</span>, money -&gt; System.out.println(<span class="string">&quot;学习太累了，去天上人间喝了口水，价格为：&quot;</span> + money));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// filterString()：根据给定的规则，过滤集合中的字符串。此规则由Predicate的方法决定</span></span><br><span class="line">    <span class="comment">// Predicate函数式接口包含唯一方法test()</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">filterString</span><span class="params">(List&lt;String&gt; list, Predicate&lt;String&gt; pre)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; filterList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 过滤list中的每一个元素，通过Predicate实例test()验证的，添加到filterList中并返回</span></span><br><span class="line">        <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pre.test(s)) &#123;</span><br><span class="line">                filterList.add(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filterList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;北京&quot;</span>, <span class="string">&quot;南京&quot;</span>, <span class="string">&quot;天津&quot;</span>, <span class="string">&quot;东京&quot;</span>, <span class="string">&quot;西京&quot;</span>, <span class="string">&quot;普京&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; filterStrs = filterString(list, <span class="keyword">new</span> Predicate&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String s)</span> </span>&#123;<span class="comment">// 重写test()</span></span><br><span class="line">                <span class="keyword">return</span> s.contains(<span class="string">&quot;京&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(filterStrs);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;********************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; filterStrs1 = filterString(list, s -&gt; s.contains(<span class="string">&quot;京&quot;</span>));</span><br><span class="line">        System.out.println(filterStrs1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="方法引用与构造器引用"><a href="#方法引用与构造器引用" class="headerlink" title="方法引用与构造器引用"></a>方法引用与构造器引用</h3><ul>
<li><p>方法引用 (Method References)：</p>
<ul>
<li><p><strong>当要传递给 Lambda 体的操作，已经有实现的方法了，可以使用方法引用！</strong></p>
</li>
<li><p>方法引用可以看做是 Lambda 表达式深层次的表达。换句话说，<strong>方法引用就是 Lambda 表达式，也就是函数式接口的一个实例，通过方法的名字来指向一个方法，可以认为是 Lambda 表达式的一个语法糖。</strong></p>
</li>
<li><p>要求：<strong>实现接口的抽象方法的参数列表和返回值类型，必须与方法引用的方法的参数列表和返回值类型保持一致！</strong>(针对情况一和情况二)</p>
</li>
<li><p><strong>ClassName :: methodName</strong>：当函数式接口方法的第一个参数是方法引用的方法的调用者，并且第二个参数是方法引用的方法的参数 (或无参数/返回值类型) 时使用。(针对情况三)</p>
</li>
<li><p>格式：使用操作符 <strong>“::”</strong> 将类 (或对象)与方法名分隔开来。</p>
</li>
<li><p>方法引用有如下三种主要使用情况：</p>
<ul>
<li><strong>对象 :: 实例方法名</strong></li>
<li><strong>类 :: 静态方法名</strong></li>
<li><strong>类 :: 实例方法</strong></li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> salary;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getSalary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSalary</span><span class="params">(<span class="keyword">double</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Employee().....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        System.out.println(<span class="string">&quot;Employee(int id).....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(<span class="keyword">int</span> id, String name, <span class="keyword">int</span> age, <span class="keyword">double</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Employee&#123;&quot;</span> + <span class="string">&quot;id=&quot;</span> + id + <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;, salary=&quot;</span> + salary + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        Employee employee = (Employee) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id != employee.id)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (age != employee.age)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (Double.compare(employee.salary, salary) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.equals(employee.name) : employee.name == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result;</span><br><span class="line">        <span class="keyword">long</span> temp;</span><br><span class="line">        result = id;</span><br><span class="line">        result = <span class="number">31</span> * result + (name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>);</span><br><span class="line">        result = <span class="number">31</span> * result + age;</span><br><span class="line">        temp = Double.doubleToLongBits(salary);</span><br><span class="line">        result = <span class="number">31</span> * result + (<span class="keyword">int</span>) (temp ^ (temp &gt;&gt;&gt; <span class="number">32</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 方法引用的使用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1.使用情境：当要传递给Lambda体的操作，已经有实现的方法了，可以使用方法引用！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.方法引用，本质上就是Lambda表达式，而Lambda表达式作为函数式接口的实例。所以</span></span><br><span class="line"><span class="comment"> *   方法引用，也是函数式接口的实例。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. 使用格式：  类(或对象) :: 方法名</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4. 具体分为如下的三种情况：</span></span><br><span class="line"><span class="comment"> *    情况1     对象 :: 非静态方法</span></span><br><span class="line"><span class="comment"> *    情况2     类 :: 静态方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    情况3     类 :: 非静态方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 5. 方法引用使用的要求：要求接口中的抽象方法的形参列表和返回值类型与方法引用的方法的</span></span><br><span class="line"><span class="comment"> *    形参列表和返回值类型相同！（针对于情况1和情况2）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodRefTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 情况一：对象 :: 实例方法</span></span><br><span class="line">    <span class="comment">// Consumer中的void accept(T t)</span></span><br><span class="line">    <span class="comment">// PrintStream中的void println(T t)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// System.out.println(str)这个方法体，在PrintStream中已经存在实现的方法</span></span><br><span class="line">        Consumer&lt;String&gt; con1 = str -&gt; System.out.println(str);</span><br><span class="line">        con1.accept(<span class="string">&quot;北京&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        PrintStream ps = System.out;<span class="comment">// 利用System.out的对象，调用其println()方法</span></span><br><span class="line">        Consumer&lt;String&gt; con2 = ps::println;</span><br><span class="line">        con2.accept(<span class="string">&quot;beijing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Supplier中的T get()</span></span><br><span class="line">    <span class="comment">// Employee中的String getName()</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Employee emp = <span class="keyword">new</span> Employee(<span class="number">1001</span>, <span class="string">&quot;Tom&quot;</span>, <span class="number">23</span>, <span class="number">5600</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// emp.getName()这个方法体，对应的就是emp对象的getName()方法</span></span><br><span class="line">        Supplier&lt;String&gt; sup1 = () -&gt; emp.getName();</span><br><span class="line">        System.out.println(sup1.get());<span class="comment">// 返回emp对象的name</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Supplier&lt;String&gt; sup2 = emp::getName;</span><br><span class="line">        System.out.println(sup2.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况二：类 :: 静态方法</span></span><br><span class="line">    <span class="comment">// Comparator中的int compare(T t1,T t2)</span></span><br><span class="line">    <span class="comment">// Integer中的int compare(T t1,T t2)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Comparator&lt;Integer&gt; com1 = (t1, t2) -&gt; Integer.compare(t1, t2);</span><br><span class="line">        System.out.println(com1.compare(<span class="number">12</span>, <span class="number">21</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Comparator&lt;Integer&gt; com2 = Integer::compare;</span><br><span class="line">        System.out.println(com2.compare(<span class="number">12</span>, <span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function中的R apply(T t)</span></span><br><span class="line">    <span class="comment">// Math中的Long round(Double d)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Function&lt;Double, Long&gt; func = <span class="keyword">new</span> Function&lt;Double, Long&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">apply</span><span class="params">(Double d)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Math.round(d);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Function&lt;Double, Long&gt; func1 = d -&gt; Math.round(d);<span class="comment">// lambda表达式</span></span><br><span class="line">        System.out.println(func1.apply(<span class="number">12.3</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Function&lt;Double, Long&gt; func2 = Math::round;<span class="comment">// 方法引用</span></span><br><span class="line">        System.out.println(func2.apply(<span class="number">12.6</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况三：类 :: 实例方法  (有难度)</span></span><br><span class="line">    <span class="comment">// Comparator中的int comapre(T t1,T t2)</span></span><br><span class="line">    <span class="comment">// String中的int t1.compareTo(t2)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Comparator&lt;String&gt; com1 = (s1, s2) -&gt; s1.compareTo(s2);</span><br><span class="line">        System.out.println(com1.compare(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;abd&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Comparator&lt;String&gt; com2 = String::compareTo;</span><br><span class="line">        System.out.println(com2.compare(<span class="string">&quot;abd&quot;</span>, <span class="string">&quot;abm&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BiPredicate中的boolean test(T t1, T t2);</span></span><br><span class="line">    <span class="comment">// String中的boolean t1.equals(t2)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始写法</span></span><br><span class="line">        BiPredicate&lt;String, String&gt; pre = <span class="keyword">new</span> BiPredicate&lt;String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> s1.equals(s2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(pre.test(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;abc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lambda表达式：lambda体是参数1调用一个方法，参数2是那个方法的入参</span></span><br><span class="line">        BiPredicate&lt;String, String&gt; pre1 = (s1, s2) -&gt; s1.equals(s2);</span><br><span class="line">        System.out.println(pre1.test(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;abc&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用：String类的equals()符合上述lambda体的功能</span></span><br><span class="line">        BiPredicate&lt;String, String&gt; pre2 = String::equals;</span><br><span class="line">        System.out.println(pre2.test(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;abd&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function中的R apply(T t)</span></span><br><span class="line">    <span class="comment">// Employee中的String getName();</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Employee employee = <span class="keyword">new</span> Employee(<span class="number">1001</span>, <span class="string">&quot;Jerry&quot;</span>, <span class="number">23</span>, <span class="number">6000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 原始写法：lambda体是参数1调用一个方法，返回一个参数2类型的值</span></span><br><span class="line">        Function&lt;Employee, String&gt; func = <span class="keyword">new</span> Function&lt;Employee, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(Employee employee)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> employee.getName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lambda表达式：Employee类的getName()符合上述lambda体的功能</span></span><br><span class="line">        Function&lt;Employee, String&gt; func1 = e -&gt; e.getName();</span><br><span class="line">        System.out.println(func1.apply(employee));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用</span></span><br><span class="line">        Function&lt;Employee, String&gt; func2 = Employee::getName;</span><br><span class="line">        System.out.println(func2.apply(employee));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>构造器引用：</p>
<ul>
<li><p>格式：<strong>ClassName :: new</strong></p>
</li>
<li><p>与函数式接口相结合，自动与函数式接口中方法兼容。可以把构造器引用赋值给定义的方法，<strong>要求构造器参数列表要与接口中抽象方法的参数列表一致，且方法的返回值即为构造器对应类的对象。</strong></p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一、构造器引用</span></span><br><span class="line"><span class="comment"> *      和方法引用类似，函数式接口的抽象方法的形参列表和构造器的形参列表一致。</span></span><br><span class="line"><span class="comment"> *      抽象方法的返回值类型即为构造器所属的类的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstructorRefTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构造器引用</span></span><br><span class="line">    <span class="comment">// Supplier中的T get()</span></span><br><span class="line">    <span class="comment">// Employee的空参构造器：Employee()</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始写法</span></span><br><span class="line">        Supplier&lt;Employee&gt; sup = <span class="keyword">new</span> Supplier&lt;Employee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Employee <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Employee();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(sup.get());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lambda表达式</span></span><br><span class="line">        Supplier&lt;Employee&gt; sup1 = () -&gt; <span class="keyword">new</span> Employee();</span><br><span class="line">        System.out.println(sup1.get());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用：Employee的无参构造器符合上述Lambda体</span></span><br><span class="line">        Supplier&lt;Employee&gt; sup2 = Employee::<span class="keyword">new</span>;</span><br><span class="line">        System.out.println(sup2.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Function中的R apply(T t)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始写法</span></span><br><span class="line">        Function&lt;Integer, Employee&gt; func = <span class="keyword">new</span> Function&lt;Integer, Employee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Employee <span class="title">apply</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Employee(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Employee employee = func.apply(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(employee);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lambda表达式</span></span><br><span class="line">        Function&lt;Integer, Employee&gt; func1 = id -&gt; <span class="keyword">new</span> Employee(id);</span><br><span class="line">        Employee employee1 = func1.apply(<span class="number">1001</span>);</span><br><span class="line">        System.out.println(employee1);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用：Employee的带id的有参构造器符合上述Lambda体</span></span><br><span class="line">        Function&lt;Integer, Employee&gt; func2 = Employee::<span class="keyword">new</span>;</span><br><span class="line">        Employee employee2 = func2.apply(<span class="number">1002</span>);</span><br><span class="line">        System.out.println(employee2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BiFunction中的R apply(T t,U u)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始写法</span></span><br><span class="line">        BiFunction&lt;Integer, String, Employee&gt; func = <span class="keyword">new</span> BiFunction&lt;Integer, String, Employee&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Employee <span class="title">apply</span><span class="params">(Integer id, String name)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Employee(id, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(func.apply(<span class="number">1000</span>, <span class="string">&quot;Tom&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lambda表达式</span></span><br><span class="line">        BiFunction&lt;Integer, String, Employee&gt; func1 = (id, name) -&gt; <span class="keyword">new</span> Employee(id, name);</span><br><span class="line">        System.out.println(func1.apply(<span class="number">1001</span>, <span class="string">&quot;Tom&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用：Employee的带id和name的有参构造器符合上述Lambda体</span></span><br><span class="line">        BiFunction&lt;Integer, String, Employee&gt; func2 = Employee::<span class="keyword">new</span>;</span><br><span class="line">        System.out.println(func2.apply(<span class="number">1002</span>, <span class="string">&quot;Tom&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>数组引用：</p>
<ul>
<li><p>格式：<strong>type[] :: new</strong></p>
</li>
<li><p>可以把数组看做是一个特殊的类，则写法与构造器引用一致。</p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二、数组引用</span></span><br><span class="line"><span class="comment"> *     大家可以把数组看做是一个特殊的类，则写法与构造器引用一致。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstructorRefTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 数组引用</span></span><br><span class="line">    <span class="comment">// Function中的R apply(T t)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原始写法</span></span><br><span class="line">        Function&lt;Integer, String[]&gt; func = <span class="keyword">new</span> Function&lt;Integer, String[]&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String[] apply(Integer length) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String[length];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        String[] arr = func.apply(<span class="number">1</span>);</span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lambda表达式</span></span><br><span class="line">        Function&lt;Integer, String[]&gt; func1 = length -&gt; <span class="keyword">new</span> String[length];</span><br><span class="line">        String[] arr1 = func1.apply(<span class="number">5</span>);</span><br><span class="line">        System.out.println(Arrays.toString(arr1));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法引用</span></span><br><span class="line">        Function&lt;Integer, String[]&gt; func2 = String[]::<span class="keyword">new</span>;</span><br><span class="line">        String[] arr2 = func2.apply(<span class="number">10</span>);</span><br><span class="line">        System.out.println(Arrays.toString(arr2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="强大的-Stream-API"><a href="#强大的-Stream-API" class="headerlink" title="强大的 Stream API"></a>强大的 Stream API</h3><ul>
<li><p>Java 8 中有两大最为重要的改变。第一个是 Lambda 表达式；另外一个则是 Stream API。</p>
</li>
<li><p>Stream API (<code>java.util.stream</code>) 把真正的函数式编程风格引入到 Java 中。这是目前为止对 Java 类库最好的补充，因为 Stream API 可以极大提供 Java 程序员的生产力，让程序员写出高效率、干净、简洁的代码。</p>
</li>
<li><p>Stream 是 Java 8 中处理集合的关键抽象概念，它可以指定你希望对集合进行的操作，可以执行非常复杂的查找、过滤和映射数据等操作。 使用 Stream API 对集合数据进行操作，就类似于使用 SQL 执行的数据库查询。也可以使用 Stream API 来并行执行操作。简言之，Stream API 提供了一种高效且易于使用的处理数据的方式。</p>
</li>
<li><p>为什么要使用 Stream API：</p>
<ul>
<li>实际开发中，项目中多数数据源都来自于 Mysql，Oracle 等。但现在数据源可以更多了，有 MongDB，Redis 等，而这些 NoSQL 的数据就需要 Java 层面去处理。</li>
<li><strong>Stream 和 Collection 集合的区别：Collection 是一种静态的内存数据结构，而 Stream 是有关计算的。前者是主要面向内存，存储在内存中，后者主要是面向 CPU，通过 CPU 实现计算。</strong></li>
</ul>
</li>
<li><p><strong>Stream 就是一个数据渠道，用于操作数据源 (集合、数组等) 所生成的元素序列。”集合讲的是数据，Stream 讲的是计算！”</strong></p>
</li>
<li><p><strong>Stream 的特性：</strong></p>
<ul>
<li><strong>Stream 自己不会存储元素。</strong></li>
<li><strong>Stream 不会改变源对象。相反，他们会返回一个持有结果的新 Stream。</strong></li>
<li><strong>Stream 操作是延迟执行的。这意味着他们会等到需要结果的时候才执行。</strong></li>
</ul>
</li>
<li><p>Stream 操作的三个步骤：</p>
<img src="/2021/04/09/java-newfeature/image-20210411143020376.png" alt="image-20210411143020376" style="zoom: 80%;">

<ul>
<li><strong>1 - 创建 Stream</strong><ul>
<li>一个数据源 (如：集合、数组)，获取一个流。</li>
</ul>
</li>
<li><strong>2 - 中间操作</strong><ul>
<li>一个中间操作链，对数据源的数据进行处理。</li>
</ul>
</li>
<li><strong>3 - 终止操作 (终端操作)</strong><ul>
<li>一旦执行终止操作，就执行中间操作链，并产生结果。之后，不会再被使用。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>步骤一：Stream 的四种创建方式。</strong></p>
<ul>
<li><p>方式一：通过集合</p>
<ul>
<li>Java 8 中的 Collection 接口被扩展，提供了两个获取流的方法：<ul>
<li>**<code>default Stream&lt;E&gt; stream()</code>**：返回一个顺序流。</li>
<li>**<code>default Stream&lt;E&gt; parallelStream()</code>**：返回一个并行流。</li>
</ul>
</li>
</ul>
</li>
<li><p>方式二：通过数组</p>
<ul>
<li>Java 8 中的 Arrays 类的静态方法 <code>stream()</code> 可以获取数组流：<ul>
<li>**<code>static &lt;T&gt; Stream&lt;T&gt; stream(T[] array)</code>**：返回一个特殊对象数组的流。</li>
</ul>
</li>
<li>重载形式，能够处理对应基本类型的数组：<ul>
<li><code>public static IntStream stream(int[] array)</code>：返回一个 int 数组的流。</li>
<li><code>public static LongStream stream(long[] array)</code>：返回一个 long 数组的流。</li>
<li><code>public static DoubleStream stream(double[] array)</code>：返回一个 double 数组的流。</li>
</ul>
</li>
</ul>
</li>
<li><p>方式三：通过 Stream 类的 <code>of()</code></p>
<ul>
<li>可以调用 Stream 类静态方法 <code>of()</code>，通过显示值创建一个流。它可以接收任意数量的参数。<ul>
<li>**<code>public static&lt;T&gt; Stream&lt;T&gt; of(T... values)</code>**：返回一个流。</li>
</ul>
</li>
</ul>
</li>
<li><p>方式四：创建无限流</p>
<ul>
<li>可以使用静态方法 <code>Stream.iterate()</code> 和 <code>Stream.generate()</code> 这两种方式，创建无限流。<ul>
<li>迭代：<code>public static&lt;T&gt; Stream&lt;T&gt; iterate(final T seed, final UnaryOperator&lt;T&gt; f)</code></li>
<li>生成：<code>public static&lt;T&gt; Stream&lt;T&gt; generate(Supplier&lt;T&gt; s)</code></li>
</ul>
</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供用于测试的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeData</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Employee&gt; <span class="title">getEmployees</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Employee&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1001</span>, <span class="string">&quot;马1&quot;</span>, <span class="number">34</span>, <span class="number">6000.38</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1002</span>, <span class="string">&quot;马2&quot;</span>, <span class="number">12</span>, <span class="number">9876.12</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1003</span>, <span class="string">&quot;刘&quot;</span>, <span class="number">33</span>, <span class="number">3000.82</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1004</span>, <span class="string">&quot;雷&quot;</span>, <span class="number">26</span>, <span class="number">7657.37</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1005</span>, <span class="string">&quot;李&quot;</span>, <span class="number">65</span>, <span class="number">5555.32</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1006</span>, <span class="string">&quot;比&quot;</span>, <span class="number">42</span>, <span class="number">9500.43</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1007</span>, <span class="string">&quot;任&quot;</span>, <span class="number">26</span>, <span class="number">4333.32</span>));</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. Stream关注的是对数据的运算，与CPU打交道</span></span><br><span class="line"><span class="comment"> *    集合关注的是数据的存储，与内存打交道</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 2.</span></span><br><span class="line"><span class="comment"> * 	① Stream 自己不会存储元素。</span></span><br><span class="line"><span class="comment"> * 	② Stream 不会改变源对象。相反，他们会返回一个持有结果的新Stream。</span></span><br><span class="line"><span class="comment"> * 	③ Stream 操作是延迟执行的。这意味着他们会等到需要结果的时候才执行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3.Stream 执行流程</span></span><br><span class="line"><span class="comment"> * 	① Stream的实例化</span></span><br><span class="line"><span class="comment"> * 	② 一系列的中间操作(过滤、映射、...)</span></span><br><span class="line"><span class="comment"> * 	③ 终止操作</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4.说明：</span></span><br><span class="line"><span class="comment"> * 4.1 一个中间操作链，对数据源的数据进行处理</span></span><br><span class="line"><span class="comment"> * 4.2 一旦执行终止操作，就执行中间操作链，并产生结果。之后，不会再被使用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  测试Stream的实例化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamAPITest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Stream方式一：通过集合</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法一：</span></span><br><span class="line">        <span class="comment">// default Stream&lt;E&gt; stream() : 返回一个顺序流</span></span><br><span class="line">        Stream&lt;Employee&gt; stream = employees.stream();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法二：</span></span><br><span class="line">        <span class="comment">// default Stream&lt;E&gt; parallelStream() : 返回一个并行流</span></span><br><span class="line">        Stream&lt;Employee&gt; parallelStream = employees.parallelStream();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Stream方式二：通过数组</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用Arrays类的static &lt;T&gt; Stream&lt;T&gt; stream(T[] array): 返回一个流</span></span><br><span class="line"></span><br><span class="line">        IntStream stream = Arrays.stream(arr);</span><br><span class="line"></span><br><span class="line">        Employee e1 = <span class="keyword">new</span> Employee(<span class="number">1001</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        Employee e2 = <span class="keyword">new</span> Employee(<span class="number">1002</span>, <span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        Employee[] arr1 = <span class="keyword">new</span> Employee[]&#123;e1, e2&#125;;</span><br><span class="line">        Stream&lt;Employee&gt; stream1 = Arrays.stream(arr1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Stream方式三：通过Stream的of()</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Stream&lt;Integer&gt; stream = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        Stream&lt;String&gt; stringStream = Stream.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Stream方式四：创建无限流 --- 用的比较少</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 迭代</span></span><br><span class="line">        <span class="comment">// public static&lt;T &gt; Stream &lt; T &gt; iterate( final T seed, final UnaryOperator&lt;T&gt; f)</span></span><br><span class="line">        <span class="comment">// 遍历前10个偶数</span></span><br><span class="line">        Stream.iterate(<span class="number">0</span>, t -&gt; t + <span class="number">2</span>).limit(<span class="number">10</span>).forEach(System.out::println);<span class="comment">// 从0开始，后一个数是前一个数+2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成</span></span><br><span class="line">        <span class="comment">// public static&lt;T&gt; Stream&lt;T&gt; generate(Supplier&lt;T&gt; s)</span></span><br><span class="line">        <span class="comment">// 遍历前10个随机数</span></span><br><span class="line">        Stream.generate(Math::random).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>步骤二：Stream 的中间操作。</strong></p>
<ul>
<li><p><strong>多个中间操作可以连接起来形成一个流水线，除非流水线上触发终止操作，否则中间操作不会执行任何的处理！而在终止操作时一次性全部处理，这称为 “惰性求值”。</strong></p>
</li>
<li><p>操作 1 - 筛选与切片：</p>
<img src="/2021/04/09/java-newfeature/image-20210411190429319.png" alt="image-20210411190429319" style="zoom:67%;">
</li>
<li><p>操作 2 - 映射：</p>
<img src="/2021/04/09/java-newfeature/image-20210411190552117.png" alt="image-20210411190552117" style="zoom: 67%;">
</li>
<li><p>操作 3 - 排序：</p>
<img src="/2021/04/09/java-newfeature/image-20210411190808235.png" alt="image-20210411190808235" style="zoom:67%;">
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Stream的中间操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamAPITest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1-筛选与切片</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Employee&gt; list = EmployeeData.getEmployees();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// filter(Predicate p) --- 接收Lambda，从流中排除某些元素。</span></span><br><span class="line">        <span class="comment">// 练习：查询员工表中薪资大于7000的员工信息</span></span><br><span class="line">        list.stream().filter(e -&gt; e.getSalary() &gt; <span class="number">7000</span>).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// limit(n) --- 截断流，使其元素不超过给定数量n。</span></span><br><span class="line">        <span class="comment">// 练习：打印员工表中前三名的员工信息</span></span><br><span class="line">        list.stream().limit(<span class="number">3</span>).forEach(System.out::println);<span class="comment">// 前一个流已经关闭，必须重新建一个流</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// skip(n) --- 跳过元素，返回一个扔掉了前n个元素的流。若流中元素不足n个，则返回一个空流。与limit(n)互补。</span></span><br><span class="line">        <span class="comment">// 练习：跳过员工表中前三名的员工信息，然后打印之后的每个员工的信息</span></span><br><span class="line">        list.stream().skip(<span class="number">3</span>).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// distinct() --- 筛选，通过流所生成元素的hashCode()和equals()去除重复元素</span></span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1010</span>, <span class="string">&quot;刘强东&quot;</span>, <span class="number">40</span>, <span class="number">8000</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1010</span>, <span class="string">&quot;刘强东&quot;</span>, <span class="number">41</span>, <span class="number">8000</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1010</span>, <span class="string">&quot;刘强东&quot;</span>, <span class="number">40</span>, <span class="number">8000</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1010</span>, <span class="string">&quot;刘强东&quot;</span>, <span class="number">40</span>, <span class="number">8000</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> Employee(<span class="number">1010</span>, <span class="string">&quot;刘强东&quot;</span>, <span class="number">40</span>, <span class="number">8000</span>));</span><br><span class="line">        <span class="comment">// System.out.println(list);</span></span><br><span class="line">        list.stream().distinct().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2-映射</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// map(Function f) --- 接收一个函数作为参数，将元素转换成其他形式或提取信息，</span></span><br><span class="line">        <span class="comment">// 						该函数会被应用到每个元素上，并将其映射成一个新的元素。</span></span><br><span class="line">        <span class="comment">//      ---&gt; 类似于List的add()：如果流的每个值转换成新流，则将每个新流作为一个元素组成新的流</span></span><br><span class="line">        <span class="comment">//            即类似：[1, [1, 2], 5, [1, 3, 2, 5], 9]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 练习1：将list中的每一个元素变成大写并打印</span></span><br><span class="line">        List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>, <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;dd&quot;</span>);</span><br><span class="line">        <span class="comment">// list.stream().map(str -&gt; str.toUpperCase()).forEach(System.out::println);</span></span><br><span class="line">        list.stream().map(String::toUpperCase).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 练习2：获取员工姓名长度大于3的员工的姓名。</span></span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line">        Stream&lt;String&gt; namesStream = employees.stream().map(Employee::getName);</span><br><span class="line">        namesStream.filter(name -&gt; name.length() &gt; <span class="number">3</span>).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  练习3：</span></span><br><span class="line">        Stream&lt;Stream&lt;Character&gt;&gt; streamStream = list.stream().map(StreamAPITest::fromStringToStream);</span><br><span class="line">        <span class="comment">// streamStream.forEach(System.out::println);</span></span><br><span class="line">        <span class="comment">// 体会下下面的写法与上面写法的区别</span></span><br><span class="line">        streamStream.forEach(s -&gt; &#123;</span><br><span class="line">            s.forEach(System.out::println);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// flatMap(Function f) --- 接收一个函数作为参数，将流中的每个值都换成另一个流，然后把所有流连接成一个流。</span></span><br><span class="line">        <span class="comment">//      ---&gt; 似于List的addAll()：如果流的每个值转换成新流，则将每个新流的值组合连接成一个流</span></span><br><span class="line">        <span class="comment">//            即类似：[1, 1, 2, 5, 1, 3, 2, 5, 9]</span></span><br><span class="line">        Stream&lt;Character&gt; characterStream = list.stream().flatMap(StreamAPITest::fromStringToStream);</span><br><span class="line">        characterStream.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将字符串中的多个字符构成的集合转换为对应的Stream的实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Stream&lt;Character&gt; <span class="title">fromStringToStream</span><span class="params">(String str)</span> </span>&#123;<span class="comment">// 如：aa---&gt;返回两个字符a组成的集合对应的流</span></span><br><span class="line">        ArrayList&lt;Character&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Character c : str.toCharArray()) &#123;</span><br><span class="line">            list.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list.stream();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比map()和flatmap()的区别</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArrayList list1 = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        list1.add(<span class="number">1</span>);</span><br><span class="line">        list1.add(<span class="number">2</span>);</span><br><span class="line">        list1.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        ArrayList list2 = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        list2.add(<span class="number">4</span>);</span><br><span class="line">        list2.add(<span class="number">5</span>);</span><br><span class="line">        list2.add(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        list1.add(list2);<span class="comment">// [1, 2, 3, [4, 5, 6]]</span></span><br><span class="line">        list1.addAll(list2);<span class="comment">// [1, 2, 3, 4, 5, 6]</span></span><br><span class="line">        System.out.println(list1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3-排序</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// sorted() --- 自然排序</span></span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">12</span>, <span class="number">43</span>, <span class="number">65</span>, <span class="number">34</span>, <span class="number">87</span>, <span class="number">0</span>, -<span class="number">98</span>, <span class="number">7</span>);</span><br><span class="line">        list.stream().sorted().forEach(System.out::println);</span><br><span class="line">        <span class="comment">// 抛异常，原因: Employee没有实现Comparable接口</span></span><br><span class="line">        <span class="comment">// List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span></span><br><span class="line">        <span class="comment">// employees.stream().sorted().forEach(System.out::println);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// sorted(Comparator com) --- 定制排序</span></span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line">        employees.stream().sorted((e1, e2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> ageValue = Integer.compare(e1.getAge(), e2.getAge());<span class="comment">// 先按年龄</span></span><br><span class="line">            <span class="keyword">if</span> (ageValue != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ageValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> -Double.compare(e1.getSalary(), e2.getSalary());<span class="comment">// 再按薪水</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>步骤三：Stream 的终止操作。</p>
<ul>
<li><p>终端操作会从流的流水线生成结果。其结果可以是任何不是流的值，例如：List、Integer，甚至是 void。</p>
</li>
<li><p>流进行了终止操作后，不能再次使用。</p>
</li>
<li><p>操作 1 - 匹配与查找：</p>
<img src="/2021/04/09/java-newfeature/image-20210412092853406.png" alt="image-20210412092853406" style="zoom:67%;">

<img src="/2021/04/09/java-newfeature/image-20210412092939535.png" alt="image-20210412092939535" style="zoom:67%;">
</li>
<li><p>操作 2 - 归约：</p>
<img src="/2021/04/09/java-newfeature/image-20210412100133543.png" alt="image-20210412100133543" style="zoom:67%;">

<ul>
<li>map 和 reduce 的连接通常称为 map-reduce 模式，因 Google 用它来进行网络搜索而出名。</li>
<li><strong>map 是一对一映射，由 n 到 n；reduce 是多对一归约，由 n 到 1。</strong></li>
</ul>
</li>
<li><p>操作 3 - 收集：</p>
<img src="/2021/04/09/java-newfeature/image-20210412101429053.png" alt="image-20210412101429053" style="zoom:67%;">

<ul>
<li><p>Collector 接口中方法的实现决定了如何对流执行收集的操作，如收集到 List、Set、Map 等。</p>
</li>
<li><p>Collectors 实用类提供了很多静态方法，可以方便地创建常见收集器实例 (Collector 实例)，具体方法与实例如下表：</p>
<img src="/2021/04/09/java-newfeature/image-20210412102055634.png" alt="image-20210412102055634" style="zoom:80%;">

<p><img src="/2021/04/09/java-newfeature/image-20210412102147845.png" alt="image-20210412102147845"></p>
</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Stream的终止操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamAPITest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1-匹配与查找</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// allMatch(Predicate p) --- 检查是否匹配所有元素。</span></span><br><span class="line">        <span class="comment">// 练习：是否所有的员工的年龄都大于18</span></span><br><span class="line">        <span class="keyword">boolean</span> allMatch = employees.stream().allMatch(e -&gt; e.getAge() &gt; <span class="number">18</span>);</span><br><span class="line">        System.out.println(allMatch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// anyMatch(Predicate p) --- 检查是否至少匹配一个元素。</span></span><br><span class="line">        <span class="comment">// 练习：是否存在员工的工资大于10000</span></span><br><span class="line">        <span class="keyword">boolean</span> anyMatch = employees.stream().anyMatch(e -&gt; e.getSalary() &gt; <span class="number">10000</span>);</span><br><span class="line">        System.out.println(anyMatch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// noneMatch(Predicate p) ---- 检查是否没有匹配的元素。如果有，返回false</span></span><br><span class="line">        <span class="comment">// 练习：是否存在员工姓&quot;雷&quot;</span></span><br><span class="line">        <span class="keyword">boolean</span> noneMatch = employees.stream().noneMatch(e -&gt; e.getName().startsWith(<span class="string">&quot;雷&quot;</span>));</span><br><span class="line">        System.out.println(noneMatch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// findFirst() --- 返回第一个元素</span></span><br><span class="line">        Optional&lt;Employee&gt; employee = employees.stream().findFirst();</span><br><span class="line">        System.out.println(employee);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// findAny() --- 返回当前流中的任意元素</span></span><br><span class="line">        Optional&lt;Employee&gt; employee1 = employees.parallelStream().findAny();</span><br><span class="line">        System.out.println(employee1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line">        <span class="comment">// count --- 返回流中元素的总个数</span></span><br><span class="line">        <span class="comment">// 练习：返回工资高于5000的员工个数</span></span><br><span class="line">        <span class="keyword">long</span> count = employees.stream().filter(e -&gt; e.getSalary() &gt; <span class="number">5000</span>).count();</span><br><span class="line">        System.out.println(count);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// max(Comparator c) --- 返回流中最大值</span></span><br><span class="line">        <span class="comment">// 练习：返回最高的工资</span></span><br><span class="line">        Stream&lt;Double&gt; salaryStream = employees.stream().map(Employee::getSalary);</span><br><span class="line">        Optional&lt;Double&gt; maxSalary = salaryStream.max(Double::compare);</span><br><span class="line">        System.out.println(maxSalary);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// min(Comparator c) --- 返回流中最小值</span></span><br><span class="line">        <span class="comment">// 练习：返回最低工资的员工</span></span><br><span class="line">        Optional&lt;Employee&gt; employee = employees.stream().min((e1, e2) -&gt; Double.compare(e1.getSalary(), e2.getSalary()));</span><br><span class="line">        System.out.println(employee);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// forEach(Consumer c) --- 内部迭代</span></span><br><span class="line">        employees.stream().forEach(System.out::println);</span><br><span class="line">        <span class="comment">// 外部迭代</span></span><br><span class="line">        Iterator&lt;Employee&gt; iterator = employees.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            System.out.println(iterator.next());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用集合的遍历操作方法</span></span><br><span class="line">        employees.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2-归约</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// reduce(T identity, BinaryOperator) --- 可以将流中元素反复结合起来，得到一个值。返回T</span></span><br><span class="line">        <span class="comment">// 练习1：计算1-10的自然数的和</span></span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line">        Integer sum = list.stream().reduce(<span class="number">0</span>, Integer::sum);<span class="comment">// 有一个初始值，在初始值基础上操作</span></span><br><span class="line">        System.out.println(sum);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reduce(BinaryOperator) --- 可以将流中元素反复结合起来，得到一个值。返回Optional&lt;T&gt;</span></span><br><span class="line">        <span class="comment">// 练习2：计算公司所有员工工资的总和</span></span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line">        Stream&lt;Double&gt; salaryStream = employees.stream().map(Employee::getSalary);</span><br><span class="line">        Optional&lt;Double&gt; sumMoney = salaryStream.reduce((d1, d2) -&gt; d1 + d2);</span><br><span class="line">        <span class="comment">// Optional&lt;Double&gt; sumMoney = salaryStream.reduce(Double::sum);// 方法引用</span></span><br><span class="line">        <span class="comment">// Double sumMoney = salaryStream.reduce(0.0, Double::sum);// 也可以计算工资总和</span></span><br><span class="line">        System.out.println(sumMoney.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3-收集</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// collect(Collector c) --- 将流转换为其他形式。接收一个Collector接口的实现，用于给Stream中元素做汇总的方法</span></span><br><span class="line">        <span class="comment">// 练习：查找工资大于6000的员工，结果返回为一个List或Set</span></span><br><span class="line"></span><br><span class="line">        List&lt;Employee&gt; employees = EmployeeData.getEmployees();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回List</span></span><br><span class="line">        List&lt;Employee&gt; employeeList = employees.stream().filter(e -&gt; e.getSalary() &gt; <span class="number">6000</span>).collect(Collectors.toList());</span><br><span class="line">        employeeList.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回Set</span></span><br><span class="line">        Set&lt;Employee&gt; employeeSet = employees.stream().filter(e -&gt; e.getSalary() &gt; <span class="number">6000</span>).collect(Collectors.toSet());</span><br><span class="line">        employeeSet.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="Optional-类"><a href="#Optional-类" class="headerlink" title="Optional 类"></a>Optional 类</h3><ul>
<li><p>到目前为止，臭名昭著的空指针异常是导致 Java 应用程序失败的最常见原因。以前，为了解决空指针异常，Google 公司著名的 Guava 项目引入了 Optional 类，Guava 通过使用检查空值的方式来防止代码污染，它鼓励程序员写更干净的代码。受到 Google Guava 的启发，Optional 类已经成为 Java 8 类库的一部分。</p>
</li>
<li><p><strong>Optional&lt;T&gt; 类 (<code>java.util.Optional</code>) 是一个容器类，它可以保存类型 T 的值，代表这个值存在。或者仅仅保存 null，表示这个值不存在。原来用 null 表示一个值不存在，现在 Optional 可以更好的表达这个概念。并且可以避免空指针异常。</strong></p>
</li>
<li><p>Optional 类的 Javadoc 描述如下：这是一个可以为 null 的容器对象。如果值存在则 <code>isPresent()</code> 会返回 true，调用 <code>get()</code> 会返回该对象。</p>
</li>
<li><p>Optional 类提供了很多有用的方法，这样我们就不用显式进行空值检测。</p>
</li>
<li><p>创建 Optional 类对象的方法：</p>
<ul>
<li><p>**<code>Optional.of(T t)</code>**：创建一个 Optional 实例，t 必须非空。否则，报 NullPointerException。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Optional&lt;Employee&gt; opt = Optional.of(<span class="keyword">new</span> Employee(<span class="string">&quot;张三&quot;</span>, <span class="number">8888</span>));</span><br><span class="line">        <span class="comment">// 判断opt中员工对象是否满足条件，如果满足就保留，否则返回空</span></span><br><span class="line">        Optional&lt;Employee&gt; emp = opt.filter(e -&gt; e.getSalary() &gt; <span class="number">10000</span>);</span><br><span class="line">        System.out.println(emp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Optional&lt;Employee&gt; opt = Optional.of(<span class="keyword">new</span> Employee(<span class="string">&quot;张三&quot;</span>, <span class="number">8888</span>));</span><br><span class="line">        <span class="comment">// 如果opt中员工对象不为空，就涨薪10%</span></span><br><span class="line">        Optional&lt;Employee&gt; emp = opt.map(e -&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            e.setSalary(e.getSalary() % <span class="number">1.1</span>);</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(emp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Optional.empty()</code>：创建一个空的 Optional 实例</p>
</li>
<li><p>**<code>Optional.ofNullable(T t)</code>**：创建一个 Optional 实例，t 可以为 null。</p>
</li>
</ul>
</li>
<li><p>判断 Optional 容器中是否包含对象：</p>
<ul>
<li><p>**<code>boolean isPresent()</code>**：判断是否包含对象</p>
</li>
<li><p><code>void ifPresent(Consumer&lt;? super T&gt; consumer)</code>：如果有值，就执行 Consumer 接口的实现代码，并且该值会作为参数传给它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Boy b = <span class="keyword">new</span> Boy(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        Optional&lt;Girl&gt; opt = Optional.ofNullable(b.getGrilFriend());</span><br><span class="line">        <span class="comment">// 如果女朋友存在就打印女朋友的信息</span></span><br><span class="line">        opt.ifPresent(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>获取 Optional 容器的对象：</p>
<ul>
<li><p>**<code>T get()</code>**：如果调用对象包含值，返回该值，否则抛异常。可以对应于 <code>Optional.of(T t)</code> 一起使用。</p>
</li>
<li><p>**<code>T orElse(T other)</code>**：如果有值则将其返回，否则返回指定的 other 对象。可以对应于 <code>Optional.ofNullable(T t)</code> 一起使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Boy b = <span class="keyword">new</span> Boy(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        Optional&lt;Girl&gt; opt = Optional.ofNullable(b.getGrilFriend());</span><br><span class="line">        <span class="comment">// 如果有女朋友就返回他的女朋友，否则只能欣赏“嫦娥”了</span></span><br><span class="line">        Girl girl = opt.orElse(<span class="keyword">new</span> Girl(<span class="string">&quot;嫦娥&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;他的女朋友是：&quot;</span> + girl.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>T orElseGet(Supplier&lt;? extends T&gt; other)</code>：如果有值则将其返回，否则返回由 Supplier 接口实现提供的对象。</p>
</li>
<li><p><code>T orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier)</code>：如果有值则将其返回，否则抛出由 Supplier 接口实现提供的异常。</p>
</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Boy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Girl girl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Girl <span class="title">getGirl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> girl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGirl</span><span class="params">(Girl girl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.girl = girl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Boy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Boy</span><span class="params">(Girl girl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.girl = girl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Boy&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;girl=&quot;</span> + girl +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Girl</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Girl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Girl</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Girl&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Optional类：为了在程序中避免出现空指针异常而创建的。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 常用的方法：ofNullable(T t)</span></span><br><span class="line"><span class="comment"> *           orElse(T t)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionalTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Optional.of(T t): 创建一个Optional实例，t必须非空。否则，报NullPointerException</span></span><br><span class="line"><span class="comment">    Optional.empty(): 创建一个空的Optional实例</span></span><br><span class="line"><span class="comment">    Optional.ofNullable(T t): t可以为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Girl girl = <span class="keyword">new</span> Girl();</span><br><span class="line">        <span class="comment">// girl = null;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// of(T t): 保证t是非空的</span></span><br><span class="line">        Optional&lt;Girl&gt; optionalGirl = Optional.of(girl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Girl girl = <span class="keyword">new</span> Girl();</span><br><span class="line">        <span class="comment">// girl = null;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ofNullable(T t): t可以为null</span></span><br><span class="line">        Optional&lt;Girl&gt; optionalGirl = Optional.ofNullable(girl);</span><br><span class="line">        System.out.println(optionalGirl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// orElse(T t1): 如果当前的Optional内部封装的t是非空的，则返回内部的t。</span></span><br><span class="line">        <span class="comment">//                  如果内部的t是空的，则返回orElse()方法中的参数t1。</span></span><br><span class="line">        Girl girl1 = optionalGirl.orElse(<span class="keyword">new</span> Girl(<span class="string">&quot;赵&quot;</span>));</span><br><span class="line">        System.out.println(girl1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Boy boy = <span class="keyword">new</span> Boy();</span><br><span class="line">        boy = <span class="keyword">null</span>;</span><br><span class="line">        String girlName = getGirlName(boy);</span><br><span class="line">        <span class="comment">// String girlName = getGirlName1(boy);// 不会出现NullPointerException</span></span><br><span class="line">        System.out.println(girlName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Boy boy = <span class="keyword">null</span>;</span><br><span class="line">        boy = <span class="keyword">new</span> Boy();</span><br><span class="line">        boy = <span class="keyword">new</span> Boy(<span class="keyword">new</span> Girl(<span class="string">&quot;苍&quot;</span>));</span><br><span class="line">        String girlName = getGirlName2(boy);</span><br><span class="line">        System.out.println(girlName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 未优化代码，容易出现NullPointerException</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGirlName</span><span class="params">(Boy boy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> boy.getGirl().getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优化以后的getGirlName():</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGirlName1</span><span class="params">(Boy boy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (boy != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Girl girl = boy.getGirl();</span><br><span class="line">            <span class="keyword">if</span> (girl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> girl.getName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用Optional类优化的getGirlName()</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGirlName2</span><span class="params">(Boy boy)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// boy可能为空</span></span><br><span class="line">        Optional&lt;Boy&gt; boyOptional = Optional.ofNullable(boy);</span><br><span class="line">        <span class="comment">// 此时的boy1一定非空</span></span><br><span class="line">        Boy boy1 = boyOptional.orElse(<span class="keyword">new</span> Boy(<span class="keyword">new</span> Girl(<span class="string">&quot;迪&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// girl可能为空</span></span><br><span class="line">        Girl girl = boy1.getGirl();</span><br><span class="line">        Optional&lt;Girl&gt; girlOptional = Optional.ofNullable(girl);</span><br><span class="line">        <span class="comment">// 此时的girl1一定非空</span></span><br><span class="line">        Girl girl1 = girlOptional.orElse(<span class="keyword">new</span> Girl(<span class="string">&quot;古&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> girl1.getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Java-9-的新特性"><a href="#Java-9-的新特性" class="headerlink" title="Java 9 的新特性"></a>Java 9 的新特性</h2><h2 id="Java-10-的新特性"><a href="#Java-10-的新特性" class="headerlink" title="Java 10 的新特性"></a>Java 10 的新特性</h2><h2 id="Java-11-的新特性"><a href="#Java-11-的新特性" class="headerlink" title="Java 11 的新特性"></a>Java 11 的新特性</h2><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0">https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/java-reflection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/java-reflection/" class="post-title-link" itemprop="url">Java 反射机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-07 13:23:13" itemprop="dateCreated datePublished" datetime="2021-04-07T13:23:13+08:00">2021-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-09 16:08:10" itemprop="dateModified" datetime="2021-04-09T16:08:10+08:00">2021-04-09</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>30 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Java-反射机制概述"><a href="#Java-反射机制概述" class="headerlink" title="Java 反射机制概述"></a>Java 反射机制概述</h2><ul>
<li><p><strong>Reflection (反射) 是被视为动态语言的关键，反射机制允许程序在执行期借助于 Reflection API 取得任何类的内部信息，并能直接操作任意对象的内部属性及方法。</strong></p>
<ul>
<li>动态语言：是一类在运行时可以改变其结构的语言。例如新的函数、对象、甚至代码可以被引进，已有的函数可以被删除或是其他结构上的变化。通俗点说就是在运行时代码可以根据某些条件改变自身结构。主要动态语言：Object-C、C#、JavaScript、PHP、Python、Erlang。</li>
<li>静态语言：与动态语言相对应的，运行时结构不可变的语言就是静态语言。如 Java、C、C++。</li>
<li>Java 不是动态语言，但 Java 可以称之为 “准动态语言”。即 Java 有一定的动态性，我们可以利用反射机制、字节码操作获得类似动态语言的特性。Java 的动态性让编程的时候更加灵活。</li>
</ul>
</li>
<li><p>加载完类之后，在堆内存的方法区中就产生了一个 Class 类型的对象 (一个类只有一个 Class 对象)，这个对象就包含了完整的类的结构信息。我们可以通过这个对象看到类的结构。这个对象就像一面镜子，透过这个镜子看到类的结构，所以，我们形象的称之为： 反射。</p>
<img src="/2021/04/07/java-reflection/image-20210407141402649.png" alt="image-20210407141402649" style="zoom:67%;">
</li>
<li><p>Java 反射机制提供的功能：</p>
<ul>
<li>在运行时判断任意一个对象所属的类。</li>
<li>在运行时构造任意一个类的对象。</li>
<li>在运行时判断任意一个类所具有的成员变量和方法。</li>
<li>在运行时获取泛型信息。</li>
<li>在运行时调用任意一个对象的成员变量和方法。</li>
<li>在运行时处理注解。</li>
<li>生成动态代理。</li>
</ul>
</li>
<li><p>反射相关的主要 API：</p>
<ul>
<li><code>java.lang.Class</code>：代表一 个类。</li>
<li><code>java.lang.reflect.Method</code>：代表类的方法。</li>
<li><code>java.lang.reflect.Field</code>：代表类的成员变量。</li>
<li><code>java.lang.reflect.Constructor</code>：代表类的构造器。</li>
</ul>
</li>
</ul>
<h2 id="理解-Class-类并获取-Class-类的实例"><a href="#理解-Class-类并获取-Class-类的实例" class="headerlink" title="理解 Class 类并获取 Class 类的实例"></a>理解 Class 类并获取 Class 类的实例</h2><ul>
<li><p>在 Object 类中定义了以下的方法，此方法将被所有子类继承：</p>
<ul>
<li><code>public final Class getClass()</code></li>
<li>以上的方法返回值的类型是一个 Class 类，此类是 <strong>Java 反射的源头</strong>，实际上所谓反射从程序的运行结果来看也很好理解，即：可以通过对象反射求出类的名称。</li>
</ul>
</li>
<li><p>对象照镜子后可以得到的信息：某个类的属性、方法和构造器、某个类到底实现了哪些接口。对于每个类而言，JRE 都为其保留一个不变的 Class 类型的对象。一个 Class 对象包含了特定某个结构 (class/interface/enum/annotation/primitive type/void/[]) 的有关信息。</p>
<ul>
<li><p>Class 本身也是一个类。</p>
</li>
<li><p>Class 对象只能由系统建立对象。</p>
</li>
<li><p>一个加载的类在 JVM 中只会有一个 Class 实例。</p>
</li>
<li><p>一个 Class 对象对应的是一个加载到 JVM 中的一个 .class 文件。</p>
</li>
<li><p>每个类的实例都会记得自己是由哪个 Class 实例所生成。</p>
</li>
<li><p>通过 Class 可以完整地得到一个类中的所有被加载的结构。</p>
</li>
<li><p>Class 类是 Reflection 的根源，针对任何你想动态加载、运行的类，唯有先获得相应的 Class 对象。</p>
<img src="/2021/04/07/java-reflection/image-20210407154647357.png" alt="image-20210407154647357" style="zoom:67%;">
</li>
</ul>
</li>
<li><p>Class 类的常用方法：</p>
<ul>
<li><code>static Class forName(String name)</code>：返回指定类名 name 的 Class 对象。</li>
<li><code>Object newInstance()</code>：调用缺省构造函数，返回该 Class 对象的一个实例。</li>
<li><code>getName()</code>：返回此 Class 对象所表示的实体 (类、接口、数组类、基本类型或 void) 名称。</li>
<li><code>Class getSuperClass()</code>：返回当前 Class 对象的父类的 Class 对象。</li>
<li><code>Class [] getInterfaces()</code>：获取当前 Class 对象的接口。</li>
<li><code>ClassLoader getClassLoader()</code>：返回该类的类加载器。</li>
<li><code>Class getSuperclass()</code>：返回表示此 Class 所表示的实体的超类的 Class。</li>
<li><code>Constructor[] getConstructors()</code>：返回一个包含某些 Constructor 对象的数组。</li>
<li><code>Field[] getDeclaredFields()</code>：返回 Field 对象的一个数组。</li>
<li><code>Method getMethod(String name,Class … paramTypes)</code>：返回一个 Method 对象，此对象的形参类型为 paramType。</li>
</ul>
</li>
<li><p>反射实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.xisun.java.base.file;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Person()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Person</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;你好，我是一个人&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">showNation</span><span class="params">(String nation)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我的国籍是：&quot;</span> + nation);</span><br><span class="line">        <span class="keyword">return</span> nation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    反射之前，对于Person的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建Person类的对象</span></span><br><span class="line">        Person p1 = <span class="keyword">new</span> Person(<span class="string">&quot;Tom&quot;</span>, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.通过对象，调用其内部的属性、方法</span></span><br><span class="line">        p1.age = <span class="number">10</span>;</span><br><span class="line">        System.out.println(p1.toString());</span><br><span class="line">        p1.show();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.在Person类外部，不可以通过Person类的对象调用其内部私有结构。---封装性的限制</span></span><br><span class="line">        <span class="comment">// 比如：name、showNation()以及私有的构造器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    反射之后，对于Person的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.通过反射，创建Person类的对象</span></span><br><span class="line">        Constructor cons = clazz.getConstructor(String.class, <span class="keyword">int</span>.class);</span><br><span class="line">        Object obj = cons.newInstance(<span class="string">&quot;Tom&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        Person p = (Person) obj;</span><br><span class="line">        System.out.println(p.toString());<span class="comment">// Person&#123;name=&#x27;Tom&#x27;, age=12&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.通过反射，调用对象指定的属性、方法</span></span><br><span class="line">        <span class="comment">// 2.1 调用属性</span></span><br><span class="line">        Field age = clazz.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        age.set(p, <span class="number">10</span>);</span><br><span class="line">        System.out.println(p.toString());<span class="comment">// Person&#123;name=&#x27;Tom&#x27;, age=10&#125;</span></span><br><span class="line">        <span class="comment">// 2.2 调用方法</span></span><br><span class="line">        Method show = clazz.getDeclaredMethod(<span class="string">&quot;show&quot;</span>);</span><br><span class="line">        show.invoke(p);<span class="comment">// 你好，我是一个人</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*******************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.通过反射，可以调用Person类的私有结构的。比如：私有的构造器、方法、属性</span></span><br><span class="line">        <span class="comment">// 3.1 调用私有的构造器</span></span><br><span class="line">        Constructor cons1 = clazz.getDeclaredConstructor(String.class);</span><br><span class="line">        cons1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Person p1 = (Person) cons1.newInstance(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">        System.out.println(p1);<span class="comment">// Person&#123;name=&#x27;Jerry&#x27;, age=0&#125;</span></span><br><span class="line">        <span class="comment">// 3.2 调用私有的属性</span></span><br><span class="line">        Field name = clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        name.set(p1, <span class="string">&quot;HanMeimei&quot;</span>);</span><br><span class="line">        System.out.println(p1);<span class="comment">// Person&#123;name=&#x27;HanMeimei&#x27;, age=0&#125;</span></span><br><span class="line">        <span class="comment">// 3.3 调用私有的方法</span></span><br><span class="line">        Method showNation = clazz.getDeclaredMethod(<span class="string">&quot;showNation&quot;</span>, String.class);</span><br><span class="line">        showNation.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        String nation = (String) showNation.invoke(p1, <span class="string">&quot;中国&quot;</span>);<span class="comment">// 相当于String nation = p1.showNation(&quot;中国&quot;)</span></span><br><span class="line">        System.out.println(nation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 疑问1：通过直接new的方式或反射的方式都可以调用公共的结构，开发中到底用那个？</span></span><br><span class="line">    <span class="comment">// 建议：直接new的方式。</span></span><br><span class="line">    <span class="comment">// 什么时候会使用：反射的方式。---&gt; 根据反射的特征：动态性，进行考虑</span></span><br><span class="line">    <span class="comment">// 疑问2：反射机制与面向对象中的封装性是不是矛盾的？如何看待两个技术？</span></span><br><span class="line">    <span class="comment">// 不矛盾。封装性是给出了一种建议，不应该调用私有的结构，但如果有调用私有结构的需求，则可以通过反射机制做到。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取 Class 类的实例的四种方法：</p>
<ul>
<li><p>若已知具体的类，则通过类的 class 属性获取，该方法最为安全可靠，程序性能最高。比如：<code>Class clazz = String.class;</code>。</p>
</li>
<li><p>若已知某个类的实例，则调用该实例的 <code>getClass()</code> 获取 Class 对象。比如：<code>Class clazz = &quot;Hello,World!&quot;.getClass();</code>。</p>
</li>
<li><p><strong>若已知一个类的全类名，且该类在类路径下，可通过 Class 类的静态方法 <code>forName()</code> 获取，可能抛出 ClassNotFoundException。</strong>比如：<code>Class clazz = Class.forName(&quot;java.lang.String&quot;);</code>。— 最常用，体现了反射的动态性</p>
</li>
<li><p>使用类的加载器 ClassLoader，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader cl = <span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">Class clazz4 = cl.loadClass(<span class="string">&quot;类的全类名&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    关于java.lang.Class类的理解</span></span><br><span class="line"><span class="comment">    1.类的加载过程：</span></span><br><span class="line"><span class="comment">    程序经过javac.exe命令以后，会生成一个或多个字节码文件(.class结尾)。</span></span><br><span class="line"><span class="comment">    接着我们使用java.exe命令对某个字节码文件进行解释运行。相当于将某个字节码文件</span></span><br><span class="line"><span class="comment">    加载到内存中。这个过程就称为类的加载。加载到内存中的类，我们称为运行时类，此</span></span><br><span class="line"><span class="comment">    运行时类，就作为Class的一个实例。</span></span><br><span class="line"><span class="comment">    (万事万物皆对象：一方面，通过对象.xxx的方式调用方法、属性等；另一方面，在反射机制中，类本身也是Class的对象)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    2.换句话说，Class的实例就对应着一个运行时类。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    3.加载到内存中的运行时类，会缓存一定的时间。在此时间之内，我们可以通过不同的方式</span></span><br><span class="line"><span class="comment">    来获取此运行时类。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取Class的实例的方式（前三种方式需要掌握）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 方式一：调用运行时类的属性：.class</span></span><br><span class="line">        Class clazz1 = Person.class;</span><br><span class="line">        System.out.println(clazz1);<span class="comment">// class cn.xisun.java.base.file.Person</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式二：通过运行时类的对象，调用getClass()</span></span><br><span class="line">        Person p1 = <span class="keyword">new</span> Person();</span><br><span class="line">        Class clazz2 = p1.getClass();</span><br><span class="line">        System.out.println(clazz2);<span class="comment">// class cn.xisun.java.base.file.Person</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式三：调用Class的静态方法：forName(String classPath)</span></span><br><span class="line">        Class clazz3 = Class.forName(<span class="string">&quot;cn.xisun.java.base.file.Person&quot;</span>);<span class="comment">// 指明类的全类名</span></span><br><span class="line">        <span class="comment">// clazz3 = Class.forName(&quot;java.lang.String&quot;);</span></span><br><span class="line">        System.out.println(clazz3);<span class="comment">// class cn.xisun.java.base.file.Person</span></span><br><span class="line"></span><br><span class="line">        System.out.println(clazz1 == clazz2);<span class="comment">// true</span></span><br><span class="line">        System.out.println(clazz1 == clazz3);<span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式四：使用类的加载器：ClassLoader  (了解)</span></span><br><span class="line">        ClassLoader classLoader = ReflectionTest.class.getClassLoader();</span><br><span class="line">        Class clazz4 = classLoader.loadClass(<span class="string">&quot;cn.xisun.java.base.file.Person&quot;</span>);</span><br><span class="line">        System.out.println(clazz4);<span class="comment">// class cn.xisun.java.base.file.Person</span></span><br><span class="line"></span><br><span class="line">        System.out.println(clazz1 == clazz4);<span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>哪些类型可以有 Class 对象：</p>
<ul>
<li><p>class：外部类，成员 (成员内部类，静态内部类)，局部内部类，匿名内部类。</p>
</li>
<li><p>interface：接口。</p>
</li>
<li><p>[]：数组.</p>
</li>
<li><p>enum：枚举。</p>
</li>
<li><p>annotation：注解 @interface。</p>
</li>
<li><p>primitive type：基本数据类型。</p>
</li>
<li><p>void</p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Class实例可以是哪些结构的说明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class c1 = Object.class;</span><br><span class="line">        Class c2 = Comparable.class;</span><br><span class="line">        Class c3 = String[].class;</span><br><span class="line">        Class c4 = <span class="keyword">int</span>[][].class;<span class="comment">// 二维数组</span></span><br><span class="line">        Class c5 = ElementType.class;<span class="comment">// 枚举类</span></span><br><span class="line">        Class c6 = Override.class;<span class="comment">// 注解</span></span><br><span class="line">        Class c7 = <span class="keyword">int</span>.class;</span><br><span class="line">        Class c8 = <span class="keyword">void</span>.class;</span><br><span class="line">        Class c9 = Class.class;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] a = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">int</span>[] b = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">100</span>];</span><br><span class="line">        Class c10 = a.getClass();</span><br><span class="line">        Class c11 = b.getClass();</span><br><span class="line">        <span class="comment">// 只要数组的元素类型与维度一样，就是同一个Class</span></span><br><span class="line">        System.out.println(c10 == c11);<span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="类的加载与-ClassLoader-的理解"><a href="#类的加载与-ClassLoader-的理解" class="headerlink" title="类的加载与 ClassLoader 的理解"></a>类的加载与 ClassLoader 的理解</h2><ul>
<li><p>类的加载过程：当程序主动使用某个类时，如果该类还未被加载到内存中，则系统会通过如下三个步骤来对该类进行初始化：</p>
<img src="/2021/04/07/java-reflection/image-20210407161703502.png" alt="image-20210407161703502" style="zoom:67%;">

<ul>
<li><p>加载：将 class 文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构，然后生成一个代表这个类的 <code>java.lang.Class</code> 对象，作为方法区中类数据的访问入口 (即引用地址)。所有需要访问和使用类数据的地方，只能通过这个 Class 对象。这个加载的过程需要类加载器参与。</p>
</li>
<li><p>链接：将 Java 类的二进制代码合并到 JVM 的运行状态之中的过程。</p>
<ul>
<li>验证：确保加载的类信息符合 JVM 规范，例如：以 cafe 开头，没有安全方面的问题。</li>
<li>准备：<strong>正式为类变量 (static) 分配内存并设置类变量默认初始值的阶段</strong>，这些内存都将在方法区中进行分配。</li>
<li>解析：虚拟机常量池内的符号引用 (常量名) 替换为直接引用 (地址) 的过程。</li>
</ul>
</li>
<li><p>初始化：</p>
<ul>
<li>执行类构造器 <code>&lt;clinit&gt;()</code> 方法的过程。<strong>类构造器 <code>&lt;clinit&gt;()</code> 方法是由编译期自动收集类中所有类变量的赋值动作和静态代码块中的语句合并产生的。</strong>(类构造器是构造类信息的，不是构造该类对象的构造器)</li>
<li>当初始化一个类的时候，如果发现其父类还没有进行初始化，则需要先触发其父类的初始化。</li>
<li>虚拟机会保证一个类的 <code>&lt;clinit&gt;()</code> 方法在多线程环境中被正确加锁和同步。</li>
</ul>
</li>
<li><p>代码图示：</p>
<img src="/2021/04/07/java-reflection/image-20210407162818901.png" alt="image-20210407162818901" style="zoom:67%;">
</li>
</ul>
</li>
<li><p>什么时候会发生类的初始化：</p>
<ul>
<li><p>类的主动引用 (一定会发生类的初始化)：</p>
<ul>
<li>当虚拟机启动，先初始化 main 方法所在的类。</li>
<li>new 一个类的对象。</li>
<li>调用类的静态成员 (除了 final 常量) 和静态方法。</li>
<li>使用 <code>java.lang.reflect</code> 包的方法对类进行反射调用。</li>
<li>当初始化一个类，如果其父类没有被初始化，则先会初始化它的父类。</li>
</ul>
</li>
<li><p>类的被动引用 (不会发生类的初始化)：</p>
<ul>
<li>当访问一个静态域时，只有真正声明这个域的类才会被初始化。</li>
<li>当通过子类引用父类的静态变量，不会导致子类初始化。</li>
<li>通过数组定义类引用，不会触发此类的初始化。</li>
<li>引用常量不会触发此类的初始化 (常量在链接阶段就存入调用类的常量池中了)。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoadingTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 主动引用：一定会导致A和Father的初始化</span></span><br><span class="line">        A a = <span class="keyword">new</span> A();</span><br><span class="line">        System.out.println(A.m);</span><br><span class="line">        Class.forName(<span class="string">&quot;cn.xisun.java.base.file.A&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 被动引用</span></span><br><span class="line">        A[] array = <span class="keyword">new</span> A[<span class="number">5</span>];<span class="comment">// 不会导致A和Father的初始化</span></span><br><span class="line">        System.out.println(A.b);<span class="comment">// 只会初始化Father</span></span><br><span class="line">        System.out.println(A.M);<span class="comment">// 不会导致A和Father的初始化</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main所在的类&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;父类被加载&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;子类被加载&quot;</span>);</span><br><span class="line">        m = <span class="number">300</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> m = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> M = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>类加载器的作用：</p>
<img src="/2021/04/07/java-reflection/image-20210407202222663.png" alt="image-20210407202222663" style="zoom:67%;">

<ul>
<li><strong>类加载的作用：将 class 文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构，然后在堆中生成一个代表这个类的 <code>java.lang.Class</code> 对象，作为方法区中类数据的访问入口。</strong></li>
<li>类缓存：标准的 Java SE 类加载器可以按要求查找类，但<strong>一旦某个类被加载到类加载器中，它将维持加载 (缓存) 一段时间。</strong>不过 JVM 垃圾回收机制可以回收这些 Class 对象。</li>
</ul>
</li>
<li><p>JVM 规范定义了如下类型的类的加载器：</p>
<img src="/2021/04/07/java-reflection/image-20210407203502068.png" alt="image-20210407203502068" style="zoom: 80%;">

<ul>
<li><p>引导类加载器</p>
</li>
<li><p>扩展类加载器</p>
</li>
<li><p>系统类加载器</p>
</li>
<li><p>自定义类加载器</p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 了解类的加载器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 对于自定义类，使用系统类加载器进行加载</span></span><br><span class="line">        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();</span><br><span class="line">        System.out.println(classLoader);<span class="comment">// sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用系统类加载器的getParent()：获取扩展类加载器</span></span><br><span class="line">        ClassLoader classLoader1 = classLoader.getParent();</span><br><span class="line">        System.out.println(classLoader1);<span class="comment">// sun.misc.Launcher$ExtClassLoader@21588809</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用扩展类加载器的getParent()：无法获取引导类加载器</span></span><br><span class="line">        <span class="comment">// 引导类加载器主要负责加载java的核心类库，无法加载自定义类的。</span></span><br><span class="line">        ClassLoader classLoader2 = classLoader1.getParent();</span><br><span class="line">        System.out.println(classLoader2);<span class="comment">// null</span></span><br><span class="line"></span><br><span class="line">        ClassLoader classLoader3 = String.class.getClassLoader();</span><br><span class="line">        System.out.println(classLoader3);<span class="comment">// null，String的加载器是引导类加载器，无法获取</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 测试当前类由哪个类加载器进行加载</span></span><br><span class="line">        ClassLoader classLoader4 = Class.forName(<span class="string">&quot;cn.xisun.java.base.file.ClassLoaderTest&quot;</span>).getClassLoader();</span><br><span class="line">        System.out.println(classLoader4);<span class="comment">// sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line">        <span class="comment">// 测试JDK提供的Object类由哪个类加载器加载</span></span><br><span class="line">        ClassLoader classLoader5 = Class.forName(<span class="string">&quot;java.lang.Object&quot;</span>).getClassLoader();</span><br><span class="line">        System.out.println(classLoader5);<span class="comment">// null，Object的加载器是引导类加载器，无法获取</span></span><br><span class="line">        <span class="comment">// 关于类加载器的一个主要方法：getResourceAsStream(String str):获取类路径下的指定文件的输入流</span></span><br><span class="line">        InputStream in = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;test.properties&quot;</span>);</span><br><span class="line">        System.out.println(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>类加载器读取配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Properties：用来读取配置文件。</span></span><br><span class="line"><span class="comment">    注意：配置文件的路径问题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Properties pros = <span class="keyword">new</span> Properties();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取配置文件的方式一：</span></span><br><span class="line">        <span class="comment">// 此时的文件默认在当前的module下</span></span><br><span class="line">        <span class="comment">/*FileInputStream fis = new FileInputStream(&quot;jdbc1.properties&quot;);</span></span><br><span class="line"><span class="comment">        // FileInputStream fis = new FileInputStream(&quot;src\\jdbc1.properties&quot;);// 等同于方式二</span></span><br><span class="line"><span class="comment">        pros.load(fis);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取配置文件的方式二：使用ClassLoader</span></span><br><span class="line">        <span class="comment">// 此时的配置文件默认识别为：当前module的src下</span></span><br><span class="line">        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();</span><br><span class="line">        InputStream is = classLoader.getResourceAsStream(<span class="string">&quot;jdbc1.properties&quot;</span>);</span><br><span class="line">        pros.load(is);</span><br><span class="line"></span><br><span class="line">        String user = pros.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        String password = pros.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user + <span class="string">&quot;, password = &quot;</span> + password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="创建运行时类的对象"><a href="#创建运行时类的对象" class="headerlink" title="创建运行时类的对象"></a>创建运行时类的对象</h2><ul>
<li><p>当拿到了运行时类的 Class 对象后，就可以创建该运行时类的对象，这是反射机制应用最多的地方。</p>
</li>
<li><p>通过 Class 对象的 <code>newInstance()</code> 创建：</p>
<ul>
<li><p>运行时类必须有一个无参数的构造器。</p>
</li>
<li><p>运行时类的构造器的访问权限需要足够。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过反射创建对应的运行时类的对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstanceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        newInstance(): 调用此方法，创建对应的运行时类的对象。内部调用了运行时类的空参的构造器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        要想此方法正常的创建运行时类的对象，要求：</span></span><br><span class="line"><span class="comment">        1.运行时类必须提供空参的构造器</span></span><br><span class="line"><span class="comment">        2.空参的构造器的访问权限得够。通常，设置为public。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        在javabean中要求提供一个public的空参构造器。原因：</span></span><br><span class="line"><span class="comment">        1.便于通过反射，创建运行时类的对象</span></span><br><span class="line"><span class="comment">        2.便于子类继承此运行时类时，默认调用super()时，保证父类有此构造器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Person obj = clazz.newInstance();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>通过 Class 对象的 <code>getDeclaredConstructor(Class … parameterTypes)</code> 创建：</p>
<ul>
<li><p>先向构造器的形参中传递一个对象数组进去，里面包含了构造器中所需的各个参数。</p>
</li>
<li><p>再通过 Constructor 实例化对象。</p>
<img src="/2021/04/07/java-reflection/image-20210408101448504.png" alt="image-20210408101448504" style="zoom:67%;">
</li>
</ul>
</li>
<li><p>体会反射的动态性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstanceTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    体会反射的动态性：以下程序只有在运行时，才能确定到底创建哪个对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="keyword">new</span> Random().nextInt(<span class="number">3</span>);<span class="comment">// 0,1,2</span></span><br><span class="line">            String classPath = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (num) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    classPath = <span class="string">&quot;java.util.Date&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    classPath = <span class="string">&quot;java.lang.Object&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    classPath = <span class="string">&quot;cn.xisun.java.base.file.Person&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object obj = getInstance(classPath);</span><br><span class="line">                System.out.println(obj);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    创建一个指定类的对象。</span></span><br><span class="line"><span class="comment">    classPath: 指定类的全类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getInstance</span><span class="params">(String classPath)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class clazz = Class.forName(classPath);</span><br><span class="line">        <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="获取运行时类的完整结构"><a href="#获取运行时类的完整结构" class="headerlink" title="获取运行时类的完整结构"></a>获取运行时类的完整结构</h2><ul>
<li><p>类的完整结构：</p>
<ul>
<li>Field 、Method 、Constructor 、Superclass 、Interface 、Annotation。</li>
<li>全部的 Field。</li>
<li>全部的方法。</li>
<li>全部的构造器。</li>
<li>所继承的父类。</li>
<li>实现的全部接口。</li>
<li>注解。</li>
</ul>
</li>
<li><p>定义 Person 类和相关接口、注解类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Creature</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> gender;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span> weight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">breath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;生物呼吸&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;生物吃东西&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;TYPE, FIELD, METHOD, PARAMETER, CONSTRUCTOR, LOCAL_VARIABLE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnnotation &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyAnnotation(value = &quot;hi&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">Creature</span>&lt;<span class="title">String</span>&gt; <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;, <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MyAnnotation(value = &quot;abc&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Person</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Person(String name, <span class="keyword">int</span> age) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MyAnnotation</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">show</span><span class="params">(String nation)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我的国籍是：&quot;</span> + nation);</span><br><span class="line">        <span class="keyword">return</span> nation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">display</span><span class="params">(String interests, <span class="keyword">int</span> age)</span> <span class="keyword">throws</span> NullPointerException, ClassCastException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> interests + age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是一个人&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(String o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是一个可爱的人&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用反射获得全部的 Field：</strong></p>
<ul>
<li><p><code>public Field[] getFields()</code>：返回此 Class 对象所表示的类或接口的 public 的 Field (包括父类)。</p>
</li>
<li><p><code>public Field[] getDeclaredFields()</code>：返回此 Class 对象所表示的类或接口的全部 Field (不包括父类)。</p>
</li>
<li><p>Field 类中的方法：</p>
<ul>
<li><code>public int getModifiers()</code>：以整数形式返回此 Field 的修饰符。</li>
<li><code>public Class&lt;?&gt; getType()</code>：得到 Field 的属性类型。</li>
<li><code>public String getName()</code>：返回 Field 的名称。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取属性结构</span></span><br><span class="line">        <span class="comment">// getFields(): 获取当前运行时类及其父类中声明为public访问权限的属性</span></span><br><span class="line">        Field[] fields = clazz.getFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : fields) &#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getDeclaredFields(): 获取当前运行时类中声明的所有属性。（不包含父类中声明的属性）</span></span><br><span class="line">        Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : declaredFields) &#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    权限修饰符  数据类型 变量名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line">        Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : declaredFields) &#123;</span><br><span class="line">            <span class="comment">// 1.权限修饰符</span></span><br><span class="line">            <span class="keyword">int</span> modifier = f.getModifiers();</span><br><span class="line">            System.out.print(Modifier.toString(modifier) + <span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.数据类型</span></span><br><span class="line">            Class type = f.getType();</span><br><span class="line">            System.out.print(type.getName() + <span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.变量名</span></span><br><span class="line">            String fName = f.getName();</span><br><span class="line">            System.out.print(fName);</span><br><span class="line"></span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">test1输出结果：</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> cn.xisun.java.base.file.Person.id</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">double</span> cn.xisun.java.base.file.Creature.weight</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> java.lang.String cn.xisun.java.base.file.Person.name</span><br><span class="line"><span class="keyword">int</span> cn.xisun.java.base.file.Person.age</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> cn.xisun.java.base.file.Person.id</span><br><span class="line"></span><br><span class="line">test2输出结果：</span><br><span class="line"><span class="keyword">private</span>, java.lang.String, name</span><br><span class="line">, <span class="keyword">int</span>, age</span><br><span class="line"><span class="keyword">public</span>, <span class="keyword">int</span>, id</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>使用反射获得全部的 Method：</strong></p>
<ul>
<li><p><code>public Method[] getMethods()</code>：返回此 Class 对象所表示的类或接口的 public 的 Method (包括父类)。</p>
</li>
<li><p><code>public Method[] getDeclaredMethods()</code>：返回此 Class 对象所表示的类或接口的全部 Method (不包括父类)。</p>
</li>
<li><p>Method 类中的方法：</p>
<ul>
<li><code>public Class&lt;?&gt;[] getParameterTypes()</code>：取得全部的参数。</li>
<li><code>public int getModifiers()</code>：取得修饰符。</li>
<li><code>public Class&lt;?&gt; getReturnType()：</code>取得全部的返回值。</li>
<li><code>public Class&lt;?&gt;[] getExceptionTypes()</code>：取得异常信息。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getMethods(): 获取当前运行时类及其所有父类中声明为public权限的方法</span></span><br><span class="line">        Method[] methods = clazz.getMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : methods) &#123;</span><br><span class="line">            System.out.println(m);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getDeclaredMethods(): 获取当前运行时类中声明的所有方法。（不包含父类中声明的方法）</span></span><br><span class="line">        Method[] declaredMethods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : declaredMethods) &#123;</span><br><span class="line">            System.out.println(m);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @Xxxx</span></span><br><span class="line"><span class="comment">    权限修饰符  返回值类型  方法名(参数类型1 形参名1, ...) throws XxxException&#123;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Method[] declaredMethods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : declaredMethods) &#123;</span><br><span class="line">            <span class="comment">// 1.获取方法声明的注解</span></span><br><span class="line">            Annotation[] annos = m.getAnnotations();</span><br><span class="line">            <span class="keyword">for</span> (Annotation a : annos) &#123;</span><br><span class="line">                System.out.print(a + <span class="string">&quot;, &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.权限修饰符</span></span><br><span class="line">            System.out.print(Modifier.toString(m.getModifiers()) + <span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.返回值类型</span></span><br><span class="line">            System.out.print(m.getReturnType().getName() + <span class="string">&quot;, &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.方法名</span></span><br><span class="line">            System.out.print(m.getName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.形参列表</span></span><br><span class="line">            System.out.print(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">            Class[] parameterTypes = m.getParameterTypes();</span><br><span class="line">            <span class="keyword">if</span> (!(parameterTypes == <span class="keyword">null</span> &amp;&amp; parameterTypes.length == <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i == parameterTypes.length - <span class="number">1</span>) &#123;</span><br><span class="line">                        System.out.print(parameterTypes[i].getName() + <span class="string">&quot; args_&quot;</span> + i);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.print(parameterTypes[i].getName() + <span class="string">&quot; args_&quot;</span> + i + <span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.print(<span class="string">&quot;), &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.抛出的异常</span></span><br><span class="line">            Class[] exceptionTypes = m.getExceptionTypes();</span><br><span class="line">            <span class="keyword">if</span> (exceptionTypes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;throws &quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptionTypes.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (i == exceptionTypes.length - <span class="number">1</span>) &#123;</span><br><span class="line">                        System.out.print(exceptionTypes[i].getName());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.print(exceptionTypes[i].getName() + <span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>使用反射获得全部的构造器：</strong></p>
<ul>
<li><code>public Constructor&lt;T&gt;[] getConstructors()</code>：返回此 Class 对象所表示的类的所有 public 构造方法 (没有父类)。</li>
<li><code>public Constructor&lt;T&gt;[] getDeclaredConstructors()</code>：返回此 Class 对象表示的类声明的所有构造方法 (没有父类)。</li>
<li>Constructor 类中的方法：<ul>
<li><code>public int getModifiers()</code>：取得修饰符。</li>
<li><code>public String getName()</code>：取得方法名称。</li>
<li><code>public Class&lt;?&gt;[] getParameterTypes()</code>：取得参数的类型。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>使用反射获得实现的全部接口：</strong></p>
<ul>
<li><code>public Class&lt;?&gt;[] getInterfaces()</code>：确定此对象所表示的类或接口实现的接口。</li>
</ul>
</li>
<li><p><strong>使用反射获得所继承的父类</strong></p>
<ul>
<li><code>public Class&lt;? Super T&gt; getSuperclass()</code>：返回表示此 Class 所表示的实体 (类、接口、基本类型) 的父类的 Class。</li>
</ul>
</li>
<li><p><strong>使用反射获得泛型相关：</strong></p>
<ul>
<li><code>Type getGenericSuperclass()</code>：获取父类泛型类型。</li>
<li>泛型类型：ParameterizedType。</li>
<li><code>getActualTypeArguments()</code>：获取实际的泛型类型参数数组。</li>
</ul>
</li>
<li><p><strong>使用反射获得 Annotation 相关</strong></p>
<ul>
<li><code>get Annotation(Class&lt;T&gt; annotationClass)</code></li>
<li><code>getDeclaredAnnotations()</code></li>
</ul>
</li>
<li><p>使用反射获得类所在的包：</p>
<ul>
<li><code>Package getPackage()</code></li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取构造器结构</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getConstructors(): 获取当前运行时类中声明为public的构造器</span></span><br><span class="line">        Constructor&lt;?&gt;[] constructors = clazz.getConstructors();</span><br><span class="line">        <span class="keyword">for</span> (Constructor&lt;?&gt; c : constructors) &#123;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">// getDeclaredConstructors(): 获取当前运行时类中声明的所有的构造器</span></span><br><span class="line">        Constructor&lt;?&gt;[] declaredConstructors = clazz.getDeclaredConstructors();</span><br><span class="line">        <span class="keyword">for</span> (Constructor&lt;?&gt; c : declaredConstructors) &#123;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类的父类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Class&lt;? <span class="keyword">super</span> Person&gt; superclass = clazz.getSuperclass();</span><br><span class="line">        System.out.println(superclass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类的带泛型的父类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Type genericSuperclass = clazz.getGenericSuperclass();</span><br><span class="line">        System.out.println(genericSuperclass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类的带泛型的父类的泛型</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    代码：逻辑性代码  vs 功能性代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Type genericSuperclass = clazz.getGenericSuperclass();</span><br><span class="line">        ParameterizedType paramType = (ParameterizedType) genericSuperclass;</span><br><span class="line">        <span class="comment">// 获取泛型类型</span></span><br><span class="line">        Type[] actualTypeArguments = paramType.getActualTypeArguments();</span><br><span class="line">        System.out.println(actualTypeArguments[<span class="number">0</span>].getTypeName());<span class="comment">// 方式一</span></span><br><span class="line">        System.out.println(((Class) actualTypeArguments[<span class="number">0</span>]).getName());<span class="comment">// 方式二</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类实现的接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt;[] interfaces = clazz.getInterfaces();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; c : interfaces) &#123;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">// 获取运行时类的父类实现的接口</span></span><br><span class="line">        Class&lt;?&gt;[] interfaces1 = clazz.getSuperclass().getInterfaces();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; c : interfaces1) &#123;</span><br><span class="line">            System.out.println(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类声明的注解</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Annotation[] annotations = clazz.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (Annotation annos : annotations) &#123;</span><br><span class="line">            System.out.println(annos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    获取运行时类所在的包</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        Package pack = clazz.getPackage();</span><br><span class="line">        System.out.println(pack);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="调用运行时类的指定结构"><a href="#调用运行时类的指定结构" class="headerlink" title="调用运行时类的指定结构"></a>调用运行时类的指定结构</h2><ul>
<li><p>调用指定属性：</p>
<ul>
<li>在反射机制中，可以直接通过 Field 类操作类中的属性，通过 Field 类提供的 <code>set()</code> 和 <code>get()</code> 就可以完成设置和取得属性内容的操作。<ul>
<li><code>public Field getField(String name)</code>：返回此 Class 对象表示的类或接口的指定的 public 的Field。</li>
<li>**<code>public Field getDeclaredField(String name)</code>**：返回此 Class 对象表示的类或接口的指定的 Field。</li>
</ul>
</li>
<li>在 Field 中：<ul>
<li><code>public void set(Object obj,Object value)</code>：设置指定对象 obj 上此 Field 的属性内容。</li>
<li><code>public Object get(Object obj)</code>：取得指定对象 obj 上此 Field 的属性内容。</li>
</ul>
</li>
</ul>
</li>
<li><p>调用指定方法：</p>
<ul>
<li>通过反射，调用类中的方法，通过 Method 类完成。步骤：<ul>
<li>通过 Class 类的 <strong><code>getDeclaredMethod(String name,Class…parameterTypes)</code></strong> 取得一个 Method 对象，并设置此方法操作时所需要的参数类型。</li>
<li>之后使用 <code>Object invoke(Object obj, Object[] args)</code> 进行调用，并向方法中传递要设置的 obj 对象的参数信息。</li>
</ul>
</li>
</ul>
</li>
<li><p>关于 <code>setAccessible(true)</code> 的使用：</p>
<ul>
<li>Method 和 Field、Constructor 对象都有 <code>setAccessible()</code>。</li>
<li><code>setAccessible()</code> 启动和禁用访问安全检查的开关。</li>
<li>参数值为 true 则指示反射的对象在使用时应该取消 Java 语言访问检查。<ul>
<li>提高反射的效率。如果代码中必须用反射，而该句代码需要频繁的被调用，那么请设置为 true。</li>
<li><strong>使得原本无法访问的私有成员也可以访问。</strong></li>
</ul>
</li>
<li>参数值为 false 则指示反射的对象应该实施 Java 语言访问检查。</li>
</ul>
</li>
<li><p>关于 <code>Object invoke(Object obj, Object … args)</code> 的使用：</p>
<ul>
<li><strong>Object 对应原方法的返回值，若原方法无返回值，此时返回 null。</strong></li>
<li><strong>若原方法为静态方法，则形参 obj 为运行时类本身或者 null。</strong></li>
<li>若原方法形参列表为空，则形参 args 为 null。</li>
<li>若原方法声明为 private，则需要在调用此 <code>invoke()</code> 前，显式调用方法对象的 <code>setAccessible(true)</code>，即可访问 private 的方法。(一般来说，不论调用的是什么权限的方法，都可显示调用方法对象的 <code>setAccessible(true)</code>。)</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    不需要掌握，因为只能获取public的,通常不采用此方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testField</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建运行时类的对象</span></span><br><span class="line">        Person p = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取指定的属性：要求运行时类中属性声明为public</span></span><br><span class="line">        Field id = clazz.getField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设置当前属性的值</span></span><br><span class="line"><span class="comment">        set():</span></span><br><span class="line"><span class="comment">            参数1：指明设置哪个对象的属性   参数2：将此属性值设置为多少</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        id.set(p, <span class="number">1001</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        获取当前属性的值</span></span><br><span class="line"><span class="comment">        get():</span></span><br><span class="line"><span class="comment">            参数1：获取哪个对象的当前属性值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> pId = (<span class="keyword">int</span>) id.get(p);</span><br><span class="line">        System.out.println(pId);<span class="comment">// 1001</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如何操作运行时类中的指定的属性 --- 需要掌握</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testField1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建运行时类的对象</span></span><br><span class="line">        Person p = (Person) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. getDeclaredField(String fieldName): 获取运行时类中指定变量名的属性</span></span><br><span class="line">        Field name = clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.保证当前属性是可访问的</span></span><br><span class="line">        name.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.获取、设置指定对象的此属性值</span></span><br><span class="line">        name.set(p, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        System.out.println(name.get(p));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*************如何调用静态属性*****************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// public static String national = &quot;中国&quot;;</span></span><br><span class="line"></span><br><span class="line">        Field national = clazz.getDeclaredField(<span class="string">&quot;national&quot;</span>);</span><br><span class="line">        national.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        System.out.println(national.get(Person.class));<span class="comment">// 中国</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如何操作运行时类中的指定的方法 --- 需要掌握</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建运行时类的对象</span></span><br><span class="line">        Person p = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1.获取指定的某个方法</span></span><br><span class="line"><span class="comment">            getDeclaredMethod():</span></span><br><span class="line"><span class="comment">                参数1 ：指明获取的方法的名称  参数2：指明获取的方法的形参列表</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Method show = clazz.getDeclaredMethod(<span class="string">&quot;show&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.保证当前方法是可访问的</span></span><br><span class="line">        show.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        3.调用方法的invoke():</span></span><br><span class="line"><span class="comment">            参数1：方法的调用者  参数2：给方法形参赋值的实参</span></span><br><span class="line"><span class="comment">        invoke()的返回值即为对应类中调用的方法的返回值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Object returnValue = show.invoke(p, <span class="string">&quot;CHN&quot;</span>); <span class="comment">// String nation = p.show(&quot;CHN&quot;);</span></span><br><span class="line">        System.out.println(returnValue);<span class="comment">// CHN，返回的returnValue是一个String，可以强转</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*************如何调用静态方法*****************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// private static void showDesc()&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">        Method showDesc = clazz.getDeclaredMethod(<span class="string">&quot;showDesc&quot;</span>);</span><br><span class="line">        showDesc.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 如果调用的运行时类中的方法没有返回值，则此invoke()返回null</span></span><br><span class="line">        <span class="comment">// Object returnVal = showDesc.invoke(null);// 参数写null也可以，因为静态方法的调用者只有类本身</span></span><br><span class="line">        Object returnVal = showDesc.invoke(Person.class);<span class="comment">// 静态方法的调用者就是当前类</span></span><br><span class="line">        System.out.println(returnVal);<span class="comment">// null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如何调用运行时类中的指定的构造器 --- 不常用</span></span><br><span class="line"><span class="comment">    经常调用类的空参构造器创建类的对象：Person p = clazz.newInstance();</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConstructor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;Person&gt; clazz = Person.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//private Person(String name)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1.获取指定的构造器</span></span><br><span class="line"><span class="comment">            getDeclaredConstructor():</span></span><br><span class="line"><span class="comment">                参数：指明构造器的参数列表</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// private Person(String name) &#123;this.name = name;&#125;</span></span><br><span class="line">        Constructor&lt;Person&gt; constructor = clazz.getDeclaredConstructor(String.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.保证此构造器是可访问的</span></span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.调用此构造器创建运行时类的对象</span></span><br><span class="line">        Person per = constructor.newInstance(<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        System.out.println(per);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="反射的应用：动态代理"><a href="#反射的应用：动态代理" class="headerlink" title="反射的应用：动态代理"></a>反射的应用：动态代理</h2><ul>
<li><p><strong>代理设计模式的原理：使用一个代理将对象包装起来，然后用该代理对象取代原始对象。任何对原始对象的调用都要通过代理。代理对象决定是否以及何时将方法调用转到原始对象上。</strong></p>
<img src="/2021/04/07/java-reflection/image-20210409104325337.png" alt="image-20210409104325337" style="zoom:67%;">

<ul>
<li><strong>代理过程：代理类和被代理类实现共同的接口，重写接口的方法 a。被代理类中，在方法 a 中实现自身需要完成的逻辑。代理类中，提供被代理类的实例，并在方法 a 中，调用该实例对象的方法 a，同时，在代理类的方法 a 中，也可以添加一些不同代理类需要实现的公共的方法。</strong></li>
</ul>
</li>
<li><p>代理分为静态代理和动态代理。</p>
</li>
<li><p>静态代理的特征是代理类和目标对象的类都是在编译期间确定下来。静态代理不利于程序的扩展。同时，每一个代理类只能为一个接口服务，这样一来程序开发中必然产生过多的代理。 最好可以通过一个代理类完成全部的代理功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 静态代理举例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 特点：代理类和被代理类在编译期间，就确定下来了。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AntaClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Anta工厂生产一批运动服&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LiningClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Lining工厂生产一批运动服&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代理类 --- 只能代理实现了ClothFactory这个接口的被代理类，其他类型的被代理类不能使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 用被代理类对象进行实例化</span></span><br><span class="line">    <span class="keyword">private</span> ClothFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyClothFactory</span><span class="params">(ClothFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;代理类做一些公共的准备工作&quot;</span>);</span><br><span class="line">        factory.produceCloth();<span class="comment">// 此方法由具体的被代理类自己实现</span></span><br><span class="line">        System.out.println(<span class="string">&quot;代理类做一些公共的收尾工作&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建被代理类的对象</span></span><br><span class="line">        ClothFactory anta = <span class="keyword">new</span> AntaClothFactory();</span><br><span class="line">        <span class="comment">// 创建代理类的对象</span></span><br><span class="line">        ClothFactory proxyClothFactory = <span class="keyword">new</span> ProxyClothFactory(anta);</span><br><span class="line">        proxyClothFactory.produceCloth();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;******************************&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        proxyClothFactory = <span class="keyword">new</span> ProxyClothFactory(<span class="keyword">new</span> LiningClothFactory());</span><br><span class="line">        proxyClothFactory.produceCloth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态代理是指客户通过代理类来调用其它对象的方法，并且是在程序运行时根据需要动态创建目标类的代理对象。</p>
</li>
<li><p>动态代理使用场合：</p>
<ul>
<li>调试</li>
<li>远程方法调用</li>
</ul>
</li>
<li><p><strong>动态代理相比于静态代理的优点：抽象角色中 (接口) 声明的所有方法都被转移到调用处理器一个集中的方法中处理，这样，我们可以更加灵活和统一的处理众多的方法。</strong></p>
<ul>
<li>一个动态代理类能做到所有被代理类的工作，在运行时，会根据传入的被代理类的对象，动态的创建一个对应的代理对象。</li>
</ul>
</li>
<li><p>Java 动态代理相关的 API：</p>
<ul>
<li><p><strong>Proxy</strong>：专门完成代理的操作类，是所有动态代理类的父类。通过此类为一个或多个接口动态地生成实现类。</p>
</li>
<li><p>提供用于创建动态代理类和动态代理对象的静态方法：</p>
<img src="/2021/04/07/java-reflection/image-20210409113606076.png" alt="image-20210409113606076" style="zoom:67%;">

<ul>
<li><code>static Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces)</code>：创建一个动态代理类所对应的Class对象</li>
<li><code>static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</code>：直接创建一个动态代理对象</li>
</ul>
</li>
</ul>
</li>
<li><p>动态代理步骤：</p>
<ul>
<li><p>创建一个实现接口 InvocationHandler 的类，它必须实现 <code>invoke()</code>，以完成代理的具体操作：</p>
<img src="/2021/04/07/java-reflection/image-20210409131314915.png" alt="image-20210409131314915" style="zoom:67%;">
</li>
<li><p>创建被代理的类以及接口：</p>
<img src="/2021/04/07/java-reflection/image-20210409131837840.png" alt="image-20210409131837840" style="zoom: 50%;">
</li>
<li><p>通过 Proxy 的静态方法 <code>newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)</code> 创建一个 Subject 接口代理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RealSubject target = <span class="keyword">new</span> RealSubject();</span><br><span class="line"><span class="comment">// Create a proxy to wrap the original implementation</span></span><br><span class="line">DebugProxy proxy = <span class="keyword">new</span> DebugProxy(target);</span><br><span class="line"><span class="comment">// Get a reference to the proxy through the Subject interface</span></span><br><span class="line">Subject sub = (Subject) Proxy.newProxyInstance(Subject.class.getClassLoader(),<span class="keyword">new</span> Class[] &#123; Subject.class &#125;, proxy);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 Subject 代理调用 RealSubject 实现类的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String info = sub.say(<span class="string">&quot;Peter&quot;</span>, <span class="number">24</span>);</span><br><span class="line">System.out.println(info);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类型一</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getBelief</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperMan</span> <span class="keyword">implements</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBelief</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I believe I can fly!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;超人喜欢吃&quot;</span> + food);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类型二</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AntaClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Anta工厂生产一批运动服&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">要想实现动态代理，需要解决的问题？</span></span><br><span class="line"><span class="comment">问题一：如何根据加载到内存中的被代理类，动态的创建一个代理类及其对象。</span></span><br><span class="line"><span class="comment">问题二：当通过代理类的对象调用方法a时，如何动态的去调用被代理类中的同名方法a。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用此方法，返回一个代理类的对象。---&gt; 解决问题一</span></span><br><span class="line">    <span class="comment">// 返回的可能是不同类型的代理类对象，因此返回Object，然后根据传参obj的类型，再进行强转 </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxyInstance</span><span class="params">(Object obj)</span> </span>&#123;<span class="comment">// obj:被代理类的对象</span></span><br><span class="line">        <span class="comment">// 创建InvocationHandler接口的实例，并赋值被代理类的对象</span></span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</span><br><span class="line">        handler.bind(obj);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        参数1：被代理类obj的类加载器</span></span><br><span class="line"><span class="comment">        参数2：被代理类obj实现的接口</span></span><br><span class="line"><span class="comment">        参数3：实现InvocationHandler接口的handler，包含被代理类执行方法调用的逻辑</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现InvocationHandler接口 ---&gt; 解决问题二</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 需要使用被代理类的对象进行赋值</span></span><br><span class="line">    <span class="keyword">private</span> Object obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋值操作，也可以通过构造器进行赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当我们通过代理类的对象，调用方法a时，就会自动的调用如下的方法：invoke()</span></span><br><span class="line">    <span class="comment">// 将被代理类要执行的方法a的功能就声明在invoke()中</span></span><br><span class="line">    <span class="comment">// proxy：代理类的对象</span></span><br><span class="line">    <span class="comment">// method：代理类和被代理类共同实现的接口中的重写的方法</span></span><br><span class="line">    <span class="comment">// args：该重写方法需要传入的参数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// method: 即为代理类对象调用的方法，此方法也就作为了被代理类对象要调用的方法</span></span><br><span class="line">        <span class="comment">// obj: 被代理类的对象</span></span><br><span class="line">        Object returnValue = method.invoke(obj, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 上述方法的返回值returnValue就作为当前类中的invoke()的返回值。</span></span><br><span class="line">        <span class="comment">// 实际上也就是被代理类所调用方法的返回值</span></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 被代理类型一</span></span><br><span class="line">        SuperMan superMan = <span class="keyword">new</span> SuperMan();</span><br><span class="line">        <span class="comment">// proxyHuman: 代理类的对象</span></span><br><span class="line">        <span class="comment">// 在动态代理中，proxyHuman代表的是代理类的对象，不应该被强转为SuperMan，因为SuperMan是被代理类</span></span><br><span class="line">        <span class="comment">// 但可以被强转为共同的接口Human。其他类型的代理类和被代理类同理</span></span><br><span class="line">        Human proxyHuman = (Human) ProxyFactory.getProxyInstance(superMan);</span><br><span class="line">        <span class="comment">// 当通过代理类对象调用方法时，会自动的调用被代理类中同名的方法</span></span><br><span class="line">        String belief = proxyHuman.getBelief();<span class="comment">// 方法一：getBelief()有返回值</span></span><br><span class="line">        System.out.println(belief);</span><br><span class="line">        proxyHuman.eat(<span class="string">&quot;四川麻辣烫&quot;</span>);<span class="comment">// 方法二：eat()没有返回值</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*****************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 被代理类型二</span></span><br><span class="line">        AntaClothFactory antaClothFactory = <span class="keyword">new</span> AntaClothFactory();<span class="comment">// 创建被代理类</span></span><br><span class="line">        ClothFactory proxyClothFactory = (ClothFactory) ProxyFactory.getProxyInstance(antaClothFactory);<span class="comment">// 创建代理类</span></span><br><span class="line">        proxyClothFactory.produceCloth();<span class="comment">// 执行方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态代理与 AOP (Aspect Orient Programming)：</p>
<ul>
<li><p>前面介绍的 Proxy 和 InvocationHandler，很难看出这种动态代理的优势，下面介绍一种更实用的动态代理机制。</p>
</li>
<li><p>改进前：</p>
<img src="/2021/04/07/java-reflection/image-20210409145506270.png" alt="image-20210409145506270" style="zoom:67%;">

<img src="/2021/04/07/java-reflection/image-20210409145742238.png" alt="image-20210409145742238" style="zoom: 67%;">
</li>
<li><p>改进后的说明：代码段 1、代码段 2、代码段 3 和深色代码段分离开了，但代码段 1、2、3 又和一个特定的方法 A 耦合了！最理想的效果是：代码块 1、2、3 既可以执行方法A ，又无须在程序中以硬编码的方式直接调用深色代码的方法。</p>
</li>
<li><p>AOP 实例，参看 ProxyUtil 的定义和使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类型一</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getBelief</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuperMan</span> <span class="keyword">implements</span> <span class="title">Human</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBelief</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I believe I can fly!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">(String food)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;超人喜欢吃&quot;</span> + food);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类型二</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AntaClothFactory</span> <span class="keyword">implements</span> <span class="title">ClothFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produceCloth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Anta工厂生产一批运动服&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不同被代理类都需要执行的通用方法，比如日志等 --- AOP的应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;====================通用方法一====================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;====================通用方法二====================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxyInstance</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        MyInvocationHandler handler = <span class="keyword">new</span> MyInvocationHandler();</span><br><span class="line">        handler.bind(obj);</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(), obj.getClass().getInterfaces(), handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object obj;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        ProxyUtil util = <span class="keyword">new</span> ProxyUtil();</span><br><span class="line">        <span class="comment">// 执行通用方法一</span></span><br><span class="line">        util.method1();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行被代理类的相应方法</span></span><br><span class="line">        Object returnValue = method.invoke(obj, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行通用方法二</span></span><br><span class="line">        util.method2();</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 被代理类型一</span></span><br><span class="line">        SuperMan superMan = <span class="keyword">new</span> SuperMan();</span><br><span class="line">        Human proxyHuman = (Human) ProxyFactory.getProxyInstance(superMan);</span><br><span class="line">        String belief = proxyHuman.getBelief();<span class="comment">// getBelief()有返回值</span></span><br><span class="line">        System.out.println(belief);</span><br><span class="line">        proxyHuman.eat(<span class="string">&quot;四川麻辣烫&quot;</span>);<span class="comment">// eat()没有返回值</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;*****************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 被代理类型二</span></span><br><span class="line">        AntaClothFactory antaClothFactory = <span class="keyword">new</span> AntaClothFactory();</span><br><span class="line">        ClothFactory proxyClothFactory = (ClothFactory) ProxyFactory.getProxyInstance(antaClothFactory);</span><br><span class="line">        proxyClothFactory.produceCloth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 Proxy 生成一个动态代理时，往往并不会凭空产生一个动态代理，这样没有太大的意义。<strong>通常都是为指定的目标对象生成动态代理。</strong></p>
</li>
<li><p>这种动态代理在 AOP 中被称为 AOP 代理，AOP 代理可代替目标对象，AOP 代理包含了目标对象的全部方法。但 AOP 代理中的方法与目标对象的方法存在差异：<strong>AOP 代理里的方法可以在执行目标方法之前、之后插入一些通用处理。</strong></p>
<img src="/2021/04/07/java-reflection/image-20210409151359825.png" alt="image-20210409151359825" style="zoom:67%;">

</li>
</ul>
</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0">https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/05/java-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="XiSun">
      <meta itemprop="description" content="心如止水者，虽世间繁华之红尘纷扰，已然空无一物">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiSun的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/05/java-network/" class="post-title-link" itemprop="url">Java 网络编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-05 12:39:24" itemprop="dateCreated datePublished" datetime="2021-04-05T12:39:24+08:00">2021-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-09 15:59:26" itemprop="dateModified" datetime="2021-04-09T15:59:26+08:00">2021-04-09</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>18 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="网络编程概述"><a href="#网络编程概述" class="headerlink" title="网络编程概述"></a>网络编程概述</h2><ul>
<li>Java 是 Internet 上的语言，它从语言级上提供了对网络应用程序的支持，程序员能够很容易开发常见的网络应用程序。</li>
<li>Java 提供的网络类库，可以实现无痛的网络连接，联网的底层细节被隐藏在 Java 的本机安装系统里，由 JVM 进行控制。并且 Java 实现了一个跨平台的网络库， 程序员面对的是一个统一的网络编程环境。</li>
<li>计算机网络：把分布在不同地理区域的计算机与专门的外部设备用通信线路互连成一个规模大、功能强的网络系统，从而使众多的计算机可以方便地互相传递信息、共享硬件、软件、数据信息等资源。</li>
<li>网络编程的目的：直接或间接地通过网络协议与其它计算机实现数据交换，进行通讯。</li>
<li>网络编程中有两个主要的问题：<ul>
<li>如何准确地定位网络上一台或多台主机，以及定位主机上的特定的应用。</li>
<li>找到主机后如何可靠高效地进行数据传输。</li>
</ul>
</li>
</ul>
<h2 id="网络通信要素概述"><a href="#网络通信要素概述" class="headerlink" title="网络通信要素概述"></a>网络通信要素概述</h2><ul>
<li><p>IP 和端口号</p>
</li>
<li><p>网络通信协议</p>
</li>
<li><p>如何实现网络中的主机互相通信：</p>
<ul>
<li><p><strong>通信双方地址：</strong></p>
<ul>
<li>IP</li>
<li>端口号</li>
</ul>
</li>
<li><p><strong>一定的规则 (即：网络通信协议。有两套参考模型)：</strong></p>
<ul>
<li><p>OSI 参考模型：模型过于理想化，未能在因特网上进行广泛推广。</p>
</li>
<li><p><strong>TCP/IP 参考模型 (或叫 TCP/IP 协议)：事实上的国际标准。</strong></p>
<img src="/2021/04/05/java-network/image-20210405204926090.png" alt="image-20210405204926090" style="zoom:67%;">
</li>
</ul>
</li>
</ul>
</li>
<li><p>网络中数据传输过程：</p>
<img src="/2021/04/05/java-network/image-20210405205407834.png" alt="image-20210405205407834" style="zoom:67%;">

</li>
</ul>
<h2 id="通信要素-1：IP-和端口号"><a href="#通信要素-1：IP-和端口号" class="headerlink" title="通信要素 1：IP 和端口号"></a>通信要素 1：IP 和端口号</h2><ul>
<li><p><strong>IP 地址</strong>：Java 中，一个 InetAddress 类的实例对象，就代表一个 IP 地址。</p>
<ul>
<li>唯一的标识 Internet 上的计算机 (通信实体)。</li>
<li>本地回环地址 (hostAddress)：127.0.0.1，主机名 (hostName)：localhost。</li>
<li>IP 地址分类方式 1：<strong>IPV4 和 IPV6。</strong><ul>
<li>IPV4：4 个字节组成，4 个 0 ~ 255。大概 42 亿，30 亿都在北美，亚洲 4亿。2011 年初已经用尽。以点分十进制表示，如 192.168.0.1。</li>
<li>IPV6：128 位，16个字节，写成 8 个无符号整数，每个整数用四个十六进制位表示，数之间用冒号 : 分开，如：3ffe:3201:1401:1280:c8ff:fe4d:db39:1984。</li>
</ul>
</li>
<li>IP 地址分类方式 2： <strong>公网地址 (万维网使用) 和私有地址 (局域网使用)。</strong>192.168. 开头的就是私有址址，范围为 192.168.0.0 ~ 192.168.255.255，专门为组织机构内部使用。</li>
<li>特点：不易记忆。</li>
</ul>
</li>
<li><p><strong>端口号</strong>：标识正在计算机上运行的进程 (程序)。</p>
<ul>
<li>不同的进程有不同的端口号。</li>
<li>被规定为一个 16 位的整数 0 ~ 65535。</li>
<li>端口分类：<ul>
<li><strong>公认端口</strong>：0 ~ 1023。被预先定义的服务通信占用，如：HTTP 占用端口 80，FTP 占用端口 21，Telnet 占用端口 23 等。</li>
<li><strong>注册端口</strong>：1024 ~ 49151。分配给用户进程或应用程序，如：Tomcat 占用端口 8080，MySQL 占用端口 3306，Oracle 占用端口 1521 等。</li>
<li><strong>动态/私有端口</strong>：49152 ~ 65535。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>端口号与 IP 地址的组合得出一个网络套接字：Socket。</strong></p>
</li>
<li><p>InetAddress 类：</p>
<ul>
<li><p>Internet 上的主机有两种方式表示地址：</p>
<ul>
<li>域名 (hostName)，如：<a target="_blank" rel="noopener" href="http://www.atguigu.com./">www.atguigu.com。</a></li>
<li>IP 地址 (hostAddress)，如：202.108.35.210。</li>
</ul>
</li>
<li><p>InetAddress 类主要表示 IP 地址，两个子类：Inet4Address、Inet6Address。</p>
</li>
<li><p>InetAddress 类对象含有一个 Internet 主机地址的域名和 IP 地址，如：<a target="_blank" rel="noopener" href="http://www.atguigu.com/">www.atguigu.com</a> 和 202.108.35.210。</p>
</li>
<li><p>域名容易记忆，当在连接网络时输入一个主机的域名后，域名服务器 (DNS) 负责将域名转化成 IP 地址，这样才能和主机建立连接。这就是<strong>域名解析</strong>。</p>
<ul>
<li><p>域名解析时，先找本机 hosts 文件，确定是否有输入的域名地址，如果没有，再通过 DNS 服务器，找到对应的主机。</p>
<img src="/2021/04/05/java-network/image-20210406115221751.png" alt="image-20210406115221751" style="zoom:67%;">
</li>
</ul>
</li>
<li><p>InetAddress 类没有提供公共的构造器，而是提供了如下几个静态方法来获取 InetAddress 实例：</p>
<ul>
<li><code>public static InetAddress getLocalHost()</code></li>
<li><code>public static InetAddress getByName(String host)</code></li>
</ul>
</li>
<li><p>InetAddress 类提供了如下几个常用的方法：</p>
<ul>
<li><code>public String getHostAddress()</code>：返回 IP 地址字符串，以文本表现形式。</li>
<li><code>public String getHostName()</code>：获取此 IP 地址的主机名。</li>
<li><code>public boolean isReachable(int timeout)</code>：测试是否可以达到该地址。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一、网络编程中有两个主要的问题：</span></span><br><span class="line"><span class="comment"> * 1.如何准确地定位网络上一台或多台主机；定位主机上的特定的应用</span></span><br><span class="line"><span class="comment"> * 2.找到主机后如何可靠高效地进行数据传输</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 二、网络编程中的两个要素：</span></span><br><span class="line"><span class="comment"> * 1.对应问题一：IP和端口号</span></span><br><span class="line"><span class="comment"> * 2.对应问题二：提供网络通信协议：TCP/IP参考模型（应用层、传输层、网络层、物理+数据链路层）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 三、通信要素一：IP和端口号</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. IP: 唯一的标识 Internet 上的计算机（通信实体）</span></span><br><span class="line"><span class="comment"> * 2. 在Java中使用InetAddress类代表IP</span></span><br><span class="line"><span class="comment"> * 3. IP分类：IPv4 和 IPv6 ; 万维网 和 局域网</span></span><br><span class="line"><span class="comment"> * 4. 域名:   www.baidu.com   www.mi.com  www.sina.com  www.jd.com  www.vip.com</span></span><br><span class="line"><span class="comment"> * 5. 本地回路地址：127.0.0.1 对应着：localhost</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 6. 如何实例化InetAddress:两个方法：getByName(String host) 、 getLocalHost()</span></span><br><span class="line"><span class="comment"> *        两个常用方法：getHostName() / getHostAddress()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 7. 端口号：正在计算机上运行的进程。</span></span><br><span class="line"><span class="comment"> * 要求：不同的进程有不同的端口号</span></span><br><span class="line"><span class="comment"> * 范围：被规定为一个 16 位的整数 0~65535。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 8. 端口号与IP地址的组合得出一个网络套接字：Socket</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InetAddressTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InetAddress inet1 = InetAddress.getByName(<span class="string">&quot;192.168.10.14&quot;</span>);</span><br><span class="line">            System.out.println(inet1);<span class="comment">// /192.168.10.14</span></span><br><span class="line"></span><br><span class="line">            InetAddress inet2 = InetAddress.getByName(<span class="string">&quot;www.atguigu.com&quot;</span>);</span><br><span class="line">            System.out.println(inet2);<span class="comment">// www.atguigu.com/58.215.145.131</span></span><br><span class="line"></span><br><span class="line">            InetAddress inet3 = InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">            System.out.println(inet3);<span class="comment">// /127.0.0.1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取本地ip</span></span><br><span class="line">            InetAddress inet4 = InetAddress.getLocalHost();</span><br><span class="line">            System.out.println(inet4);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// getHostAddress()</span></span><br><span class="line">            System.out.println(inet2.getHostAddress());<span class="comment">// 58.215.145.131</span></span><br><span class="line">            <span class="comment">// getHostName()</span></span><br><span class="line">            System.out.println(inet2.getHostName());<span class="comment">// www.atguigu.com</span></span><br><span class="line">            <span class="comment">// isReachable(int timeout)</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(inet2.isReachable(<span class="number">10</span>));<span class="comment">// true</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="通信要素-2：网络通信协议"><a href="#通信要素-2：网络通信协议" class="headerlink" title="通信要素 2：网络通信协议"></a>通信要素 2：网络通信协议</h2><ul>
<li><p><strong>网络通信协议：计算机网络中实现通信必须有一些约定，即通信协议，对速率、传输代码、代码结构、传输控制步骤、出错控制等制定标准。</strong></p>
</li>
<li><p>问题：网络协议太复杂。计算机网络通信涉及内容很多，比如指定源地址和目标地址、加密解密、压缩解压缩、差错控制、流量控制、路由控制等，如何实现如此复杂的网络协议呢？</p>
</li>
<li><p>通信协议分层的思想：在制定协议时，把复杂成份分解成一些简单的成份，再将它们复合起来。最常用的复合方式是层次方式，即<strong>同层间可以通信、上一层可以调用下一层，而与再下一层不发生关系。</strong>各层互不影响，利于系统的开发和扩展。</p>
</li>
<li><p>TCP/IP 协议簇：</p>
<ul>
<li><strong>TCP/IP 协议簇以其两个主要协议传输控制协议 (TCP) 和网络互联协议 (IP) 而得名</strong>，实际上是一组协议，包括多个具有不同功能且互为关联的协议。</li>
<li>传输层协议中两个非常重要的协议：<ul>
<li><strong>传输控制协议 TCP</strong> (Transmission Control Protocol)。</li>
<li><strong>用户数据报协议 UDP</strong> (User Datagram Protocol)。</li>
</ul>
</li>
<li>网络层的主要协议： 网络互联协议 IP (Internet Protocol)，其支持网间互连的数据通信。</li>
<li>TCP/IP 协议模型从更实用的角度出发，形成了高效的四层体系结构，即<strong>物理链路层、IP 层、传输层和应用层</strong>。</li>
</ul>
</li>
<li><p><strong>TCP 协议：</strong></p>
<ul>
<li><p>使用 TCP 协议前，<strong>须先建立 TCP 连接</strong>，形成传输数据通道。</p>
</li>
<li><p>传输前，采用 <strong>“三次握手”</strong> 方式，点对点通信，<strong>是可靠的</strong>。</p>
<img src="/2021/04/05/java-network/image-20210406150220705.png" alt="image-20210406150220705" style="zoom:67%;">
</li>
<li><p>TCP 协议进行通信的两个应用进程：客户端、服务端。</p>
</li>
<li><p>在连接中<strong>可进行大数据量的传输</strong>。</p>
</li>
<li><p>传输完毕，采用 <strong>“四次挥手”</strong> 方式，<strong>释放已建立的连接，效率相对低</strong>。</p>
<img src="/2021/04/05/java-network/image-20210406150310805.png" alt="image-20210406150310805" style="zoom:67%;">
</li>
</ul>
</li>
<li><p><strong>UDP 协议：</strong></p>
<ul>
<li>将数据、源、目的封装成数据包，<strong>不需要建立连接</strong>。</li>
<li>每个数据报的大小限制在 64 K 内。</li>
<li>发送不管对方是否准备好，接收方收到也不确认，故<strong>是不可靠的</strong>。</li>
<li>可以广播发送。</li>
<li>发送数据结束时<strong>无需释放资源，开销小，速度相对快</strong>。</li>
</ul>
</li>
</ul>
<h2 id="TCP-网络编程"><a href="#TCP-网络编程" class="headerlink" title="TCP 网络编程"></a>TCP 网络编程</h2><ul>
<li><p>Socket 类实现了基于 TCP 协议的网络编程。</p>
</li>
<li><p>Socket 类：</p>
<ul>
<li>利用套接字 (Socket) 开发网络应用程序早已被广泛的采用，以至于成为事实上的标准。</li>
<li><strong>网络上具有唯一标识的 IP 地址和端口号组合在一起，才能构成唯一能识别的标识符套接字。</strong></li>
<li>通信的两端都要有 Socket，是两台机器间通信的端点。</li>
<li>网络通信其实就是 Socket 间的通信。</li>
<li>Socket 允许程序把网络连接当成一个流，数据在两个 Socket 间通过 IO 传输。</li>
<li>一般主动发起通信的应用程序属客户端，等待通信请求的为服务端。</li>
<li>Socket 类：<ul>
<li><strong>流套接字 (stream socket)：使用 TCP 提供可依赖的字节流服务。</strong></li>
<li><strong>数据报套接字 (datagram socket)：使用 UDP 提供 “尽力而为” 的数据报服务。</strong></li>
</ul>
</li>
<li>Socket 类的常用构造器 ：<ul>
<li><code>public Socket(InetAddress address,int port)</code>：创建一个流套接字并将其连接到指定 IP 地址的指定端口号。</li>
<li><code>public Socket(String host,int port)</code>：创建一个流套接字并将其连接到指定主机上的指定端口号。</li>
</ul>
</li>
<li>Socket 类的常用方法：<ul>
<li><code>public InputStream getInputStream()</code>：返回此套接字的输入流。可以用于接收网络消息。</li>
<li><code>public OutputStream getOutputStream()</code>：返回此套接字的输出流。可以用于发送网络消息。</li>
<li><code>public InetAddress getInetAddress()</code>：返回此套接字连接到的远程 IP 地址；如果尚未连接套接字，则返回 null。</li>
<li><code>public InetAddress getLocalAddress()</code>：返回此套接字绑定的本地地址，即本端的 IP 地址。</li>
<li><code>public int getPort()</code>：返回此套接字连接到的远程端口号；如果尚未连接套接字，则返回 0。</li>
<li><code>public int getLocalPort()</code>：返回此套接字绑定的本地端口，即本端的端口号。如果尚未绑定套接字，则返回 -1。</li>
<li><code>public void close()</code>：关闭此套接字。套接字被关闭后，便不可在以后的网络连接中使用 (即无法重新连接或重新绑定)。需要创建新的套接字对象。关闭此套接字也将会关闭该套接字的 InputStream 和 OutputStream。</li>
<li><code>public void shutdownInput()</code>：关闭此套接字的输入流。如果在套接字上调用 <code>shutdownInput()</code> 后再从套接字输入流读取内容，则流将返回 EOF (文件结束符)，即不能再从此套接字的输入流中接收任何数据。</li>
<li><code>public void shutdownOutput()</code>：关闭此套接字的输出流。对于 TCP 套接字，任何以前写入的数据都将被发送，并且后跟 TCP 的正常连接终止序列。 如果在套接字上调用 <code>shutdownOutput()</code> 后再写入套接字输出流，则该流将抛出 IOException，即不能再通过此套接字的输出流发送任何数据。</li>
</ul>
</li>
</ul>
</li>
<li><p>Java 语言的基于套接字编程分为服务端编程和客户端编程，其通信模型如图所示：</p>
<img src="/2021/04/05/java-network/image-20210406213311857.png" alt="image-20210406213311857" style="zoom:67%;">
</li>
<li><p><strong>服务端 Scoket 的工作过程包含以下四个基本的步骤：</strong></p>
<ul>
<li>调用 <code>ServerSocket(int port)</code>：创建一个服务器端套接字，并绑定到指定端口上。用于监听客户端的请求。</li>
<li>调用 <code>accept()</code>：监听连接请求，如果客户端请求连接，则接受连接，并返回通信套接字对象。</li>
<li>调用该 Socket 类对象的 <code>getOutputStream()</code> 和 <code>getInputStream()</code>：获取输出流和输入流，开始网络数据的发送和接收。</li>
<li>关闭 ServerSocket 和 Socket 对象：客户端访问结束，关闭通信套接字。</li>
</ul>
</li>
<li><p><strong>客户端 Socket 的工作过程包含以下四个基本的步骤：</strong></p>
<ul>
<li>创建 Socket：根据指定服务端的 IP 地址或端口号构造 Socket 类对象。若服务器端响应，则建立客户端到服务器的通信线路。若连接失败，会出现异常。</li>
<li>打开连接到 Socket 的输入/输出流：使用 <code>getInputStream()</code> 获得输入流，使用 <code>getOutputStream()</code> 获得输出流，进行数据传输。</li>
<li>按照一定的协议对 Socket 进行读/写操作：通过输入流读取服务器放入通信线路的信息 (但不能读取自己放入通信线路的信息)，通过输出流将信息写入通信线路。</li>
<li>关闭 Socket：断开客户端到服务器的连接，释放通信线路。</li>
</ul>
</li>
<li><p>服务器建立 ServerSocket 对象：</p>
<ul>
<li><p>ServerSocket 对象负责等待客户端请求建立套接字连接，类似邮局某个窗口中的业务员。也就是说，<strong>服务器必须事先建立一个等待客户请求建立套接字</strong><br><strong>连接的 ServerSocket 对象。</strong></p>
</li>
<li><p>所谓 “接收” 客户的套接字请求，就是 <code>accept()</code> 会返回一个 Socket 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ServerSocket ss = <span class="keyword">new</span> ServerSocket(<span class="number">9999</span>);</span><br><span class="line">Socket s = ss.accept();</span><br><span class="line">InputStream in = s.getInputStream();</span><br><span class="line"><span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="keyword">int</span> num = in.read(buf);</span><br><span class="line">String str = <span class="keyword">new</span> String(buf,<span class="number">0</span>,num);</span><br><span class="line">System.out.println(s.getInetAddress().toString()+”:”+str);</span><br><span class="line">s.close();</span><br><span class="line">ss.close();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>客户端创建 Socket 对象：</p>
<ul>
<li><p>客户端程序可以使用 Socket 类创建对象，<strong>创建的同时会自动向服务器方发起连接。</strong>Socket 的构造器是：</p>
<ul>
<li><code>Socket(String host,int port)throws UnknownHostException,IOException</code>：向服务器 (域名为 host，端口号为 port) 发起 TCP 连接，若成功，则创建 Socket 对象，否则抛出异常。</li>
<li><code>Socket(InetAddress address,int port)throws IOException</code>：根据 InetAddress 对象所表示的 IP 地址以及端口号 port 发起连接。</li>
</ul>
</li>
<li><p>客户端建立 socketAtClient 对象的过程就是向服务器发出套接字连接请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Socket s = <span class="keyword">new</span> Socket(<span class="string">&quot;192.168.40.165&quot;</span>,<span class="number">9999</span>);</span><br><span class="line">OutputStream out = s.getOutputStream();</span><br><span class="line">out.write(<span class="string">&quot; hello&quot;</span>.getBytes());</span><br><span class="line">s.close();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>流程示意图：</p>
<img src="/2021/04/05/java-network/image-20210407094416022.png" alt="image-20210407094416022" style="zoom:80%;">
</li>
<li><p>实例 1：客户端发送信息给服务端，服务端将数据显示在控制台上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现TCP的网络编程</span></span><br><span class="line"><span class="comment"> * 实例1：客户端发送信息给服务端，服务端将数据显示在控制台上</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.创建Socket对象，指明服务器端的ip和端口号</span></span><br><span class="line">            InetAddress inet = InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>);<span class="comment">// 本机</span></span><br><span class="line">            socket = <span class="keyword">new</span> Socket(inet, <span class="number">8879</span>);</span><br><span class="line">            <span class="comment">// 2.获取一个输出流，用于输出数据</span></span><br><span class="line">            os = socket.getOutputStream();</span><br><span class="line">            <span class="comment">// 3.写出数据的操作</span></span><br><span class="line">            os.write(<span class="string">&quot;你好，我是客户端&quot;</span>.getBytes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4.关闭资源</span></span><br><span class="line">            <span class="keyword">if</span> (os != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    os.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    服务端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServerSocket ss = <span class="keyword">null</span>;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.创建服务器端的ServerSocket，指明自己的端口号</span></span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket(<span class="number">8879</span>);</span><br><span class="line">            <span class="comment">// 2.调用accept()表示接收来自于客户端的socket</span></span><br><span class="line">            socket = ss.accept();</span><br><span class="line">            <span class="comment">// 3.获取输入流</span></span><br><span class="line">            is = socket.getInputStream();</span><br><span class="line">            <span class="comment">// 4.读取输入流中的数据</span></span><br><span class="line">            <span class="comment">// 不建议这样写，可能会有乱码(字节流读取中文)</span></span><br><span class="line">            <span class="comment">/*byte[] buffer = new byte[1024];</span></span><br><span class="line"><span class="comment">            int len;</span></span><br><span class="line"><span class="comment">            while ((len = is.read(buffer)) != -1) &#123;</span></span><br><span class="line"><span class="comment">                String str = new String(buffer, 0, len);</span></span><br><span class="line"><span class="comment">                System.out.print(str);</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">5</span>];</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 将输入流中的数据都读到ByteArrayOutputStream中，读完之后再转换</span></span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;收到了来自于：&quot;</span> + socket.getInetAddress().getHostAddress() + <span class="string">&quot;的数据&quot;</span>);<span class="comment">// 客户端信息</span></span><br><span class="line">            System.out.println(baos.toString());<span class="comment">// 客户端发送的数据</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5.关闭资源</span></span><br><span class="line">            <span class="keyword">if</span> (baos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    baos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ss != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ss.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例 2：客户端发送文件给服务端，服务端将文件保存在本地。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 实现TCP的网络编程</span></span><br><span class="line"><span class="comment"> * 实例2：客户端发送文件给服务端，服务端将文件保存在本地。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">   客户端</span></span><br><span class="line"><span class="comment">   这里涉及到的异常，应该使用try-catch-finally处理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建Socket对象，指明服务器端的ip和端口号</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9090</span>);</span><br><span class="line">        <span class="comment">// 2.获取一个输出流，用于输出数据</span></span><br><span class="line">        OutputStream os = socket.getOutputStream();</span><br><span class="line">        <span class="comment">// 3.创建输入流，可以使用BufferedInputStream包装</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;beauty.jpg&quot;</span>));</span><br><span class="line">        <span class="comment">// 4.读写操作</span></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            os.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5.关闭资源</span></span><br><span class="line">        fis.close();</span><br><span class="line">        os.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    服务端</span></span><br><span class="line"><span class="comment">    这里涉及到的异常，应该使用try-catch-finally处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建服务器端的ServerSocket，指明自己的端口号</span></span><br><span class="line">        ServerSocket ss = <span class="keyword">new</span> ServerSocket(<span class="number">9090</span>);</span><br><span class="line">        <span class="comment">// 2.调用accept()表示接收来自于客户端的socket</span></span><br><span class="line">        Socket socket = ss.accept();</span><br><span class="line">        <span class="comment">// 3.获取输入流</span></span><br><span class="line">        InputStream is = socket.getInputStream();</span><br><span class="line">        <span class="comment">// 4.创建输出流，可以使用BufferedOutputStream包装</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;beauty1.jpg&quot;</span>));</span><br><span class="line">        <span class="comment">// 5.读写操作</span></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.关闭资源</span></span><br><span class="line">        fos.close();</span><br><span class="line">        is.close();</span><br><span class="line">        socket.close();</span><br><span class="line">        ss.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实例 3：从客户端发送文件给服务端，服务端保存到本地，然后返回 “发送成功” 给客户端，并关闭相应的连接。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现TCP的网络编程</span></span><br><span class="line"><span class="comment"> * 实例3：从客户端发送文件给服务端，服务端保存到本地，然后返回&quot;发送成功&quot;给客户端，并关闭相应的连接。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">   客户端</span></span><br><span class="line"><span class="comment">   这里涉及到的异常，应该使用try-catch-finally处理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建Socket对象，指明服务器端的ip和端口号</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9090</span>);</span><br><span class="line">        <span class="comment">// 2.获取一个输出流，用于输出数据</span></span><br><span class="line">        OutputStream os = socket.getOutputStream();</span><br><span class="line">        <span class="comment">// 3.创建输入流，可以使用BufferedInputStream包装</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;beauty.jpg&quot;</span>));</span><br><span class="line">        <span class="comment">// 4.读写操作</span></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            os.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭数据的输出，表示客服端数据传输已经完成，提醒服务端不必继续等待</span></span><br><span class="line">        <span class="comment">// 如果不执行此操作，服务器端会一直阻塞</span></span><br><span class="line">        socket.shutdownOutput();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.接收来自于服务器端的数据，并显示到控制台上</span></span><br><span class="line">        InputStream is = socket.getInputStream();</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] bufferr = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">20</span>];</span><br><span class="line">        <span class="keyword">int</span> len1;</span><br><span class="line">        <span class="keyword">while</span> ((len1 = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(buffer, <span class="number">0</span>, len1);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(baos.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.关闭资源</span></span><br><span class="line">        baos.close();</span><br><span class="line">        fis.close();</span><br><span class="line">        os.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    服务端</span></span><br><span class="line"><span class="comment">    这里涉及到的异常，应该使用try-catch-finally处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.创建服务器端的ServerSocket，指明自己的端口号</span></span><br><span class="line">        ServerSocket ss = <span class="keyword">new</span> ServerSocket(<span class="number">9090</span>);</span><br><span class="line">        <span class="comment">// 2.调用accept()表示接收来自于客户端的socket</span></span><br><span class="line">        Socket socket = ss.accept();</span><br><span class="line">        <span class="comment">// 3.获取输入流</span></span><br><span class="line">        InputStream is = socket.getInputStream();</span><br><span class="line">        <span class="comment">// 4.创建输出流，可以使用BufferedOutputStream包装</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;beauty1.jpg&quot;</span>));</span><br><span class="line">        <span class="comment">// 5.读写操作</span></span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;<span class="comment">// read()是一个阻塞式方法</span></span><br><span class="line">            fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;图片传输完成&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.服务器端给予客户端反馈</span></span><br><span class="line">        OutputStream os = socket.getOutputStream();</span><br><span class="line">        os.write(<span class="string">&quot;你好，客户端，照片已收到！&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.关闭资源</span></span><br><span class="line">        os.close();</span><br><span class="line">        fos.close();</span><br><span class="line">        is.close();</span><br><span class="line">        socket.close();</span><br><span class="line">        ss.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="UDP-网络编程"><a href="#UDP-网络编程" class="headerlink" title="UDP 网络编程"></a>UDP 网络编程</h2><ul>
<li><p>DatagramSocket 类和 DatagramPacket 类实现了基于 UDP 协议的网络编程。</p>
</li>
<li><p>UDP 数据报通过数据报套接字 DatagramSocket 发送和接收，系统不保证 UDP 数据报一定能够安全送到目的地，也不能确定什么时候可以抵达。</p>
</li>
<li><p>DatagramPacket 对象封装了 UDP 数据报，在数据报中包含了发送端的 IP 地址和端口号以及接收端的 IP 地址和端口号。</p>
</li>
<li><p>UDP 协议中每个数据报都给出了完整的地址信息，因此无须建立发送方和接收方的连接。如同发快递包裹一样。</p>
</li>
<li><p>DatagramSocket 类的常用方法：</p>
<ul>
<li><code>public DatagramSocket(int port)</code>：创建数据报套接字并将其绑定到本地主机上的指定端口。套接字将被绑定到通配符地址，IP 地址由内核来选择。</li>
<li><code>public DatagramSocket(int port,InetAddress laddr)</code>：创建数据报套接字，将其绑定到指定的本地地址。本地端口必须在 0 到 65535 之间 (包括两者)。如果 IP 地址为 0.0.0.0，套接字将被绑定到通配符地址，IP 地址由内核选择。</li>
<li><code>public void close()</code>：关闭此数据报套接字。</li>
<li><code>public void send(DatagramPacket p)</code>：从此套接字发送数据报包。DatagramPacket 包含的信息指示：将要发送的数据、数据长度、远程主机的 IP 地址和远程主机的端口号。</li>
<li><code>public void receive(DatagramPacket p)</code>：从此套接字接收数据报包。当此方法返回时，DatagramPacket 的缓冲区填充了接收的数据。数据报包也包含发送方的 IP 地址和发送方机器上的端口号。此方法在接收到数据报前一直阻塞。数据报包对象的 length 字段包含所接收信息的长度。如果信息比包的长度长，该信息将被截短。</li>
<li><code>public InetAddress getLocalAddress()</code>：获取套接字绑定的本地地址。</li>
<li><code>public int getLocalPort()</code>：返回此套接字绑定的本地主机上的端口号。</li>
<li><code>public InetAddress getInetAddress()</code>：返回此套接字连接的地址。如果套接字未连接，则返回 null。</li>
<li><code>public int getPort()</code>：返回此套接字的端口。如果套接字未连接，则返回 -1。</li>
</ul>
</li>
<li><p>DatagramPacket 类的常用方法：</p>
<ul>
<li><code>public DatagramPacket(byte[] buf,int length)</code>：构造 DatagramPacket，用来接收长度为 length 的数据包。 length 参数必须小于等于  <code>buf.length()</code>。</li>
<li><code>public DatagramPacket(byte[] buf,int length,InetAddress address,int port)</code>：构造数据报包，用来将长度为 length 的包发送到指定主机上的指定端口号。length 参数必须小于等于 <code>buf.length()</code>。</li>
<li><code>public InetAddress getAddress()</code>：返回某台机器的 IP 地址，此数据报将要发往该机器或者是从该机器接收到的。</li>
<li><code>public int getPort()</code>：返回某台远程主机的端口号，此数据报将要发往该主机或者是从该主机接收到的。</li>
<li><code>public byte[] getData()</code>：返回数据缓冲区。接收到的或将要发送的数据从缓冲区中的偏移量 offset 处开始，持续 length 长度。</li>
<li><code>public int getLength()</code>：返回将要发送或接收到的数据的长度。</li>
</ul>
</li>
<li><p>UDP 网络通信流程：</p>
<ul>
<li>DatagramSocket 与 DatagramPacket。</li>
<li>建立发送端，接收端， 发送端与接收端是两个独立的运行程序。</li>
<li>建立数据包。</li>
<li>调用 Socket 的发送、接收方法。</li>
<li>关闭 Socket。</li>
</ul>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    发送端</span></span><br><span class="line"><span class="comment">    注意：发送端发送数据，是不管接收端能不能收到，为了保证接收端能收到数据，应该先启动接收端。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DatagramSocket socket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line"></span><br><span class="line">            String str = <span class="string">&quot;我是UDP方式发送的数据&quot;</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] data = str.getBytes();</span><br><span class="line">            InetAddress inet = InetAddress.getLocalHost();</span><br><span class="line">            <span class="comment">// 封装数据报，发送到本机的9090端口</span></span><br><span class="line">            DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(data, <span class="number">0</span>, data.length, inet, <span class="number">9090</span>);</span><br><span class="line"></span><br><span class="line">            socket.send(packet);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    接收端</span></span><br><span class="line"><span class="comment">    注意：在接收端，要指定监听的端口。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DatagramSocket socket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> DatagramSocket(<span class="number">9090</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">100</span>];</span><br><span class="line">            DatagramPacket packet = <span class="keyword">new</span> DatagramPacket(buffer, <span class="number">0</span>, buffer.length);</span><br><span class="line"></span><br><span class="line">            socket.receive(packet);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(packet.getData(), <span class="number">0</span>, packet.getLength()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="URL-网络编程"><a href="#URL-网络编程" class="headerlink" title="URL 网络编程"></a>URL 网络编程</h2><ul>
<li><p><strong>URL (Uniform Resource Locator)：统一资源定位符，它表示 Internet 上某一资源的地址。</strong></p>
</li>
<li><p>它是一种具体的 URI，即 URL 可以用来标识一个资源，而且还指明了如何 locate 这个资源。</p>
</li>
<li><p>通过 URL 我们可以访问 Internet 上的各种网络资源，比如最常见的 www，ftp 站点。浏览器通过解析给定的 URL 可以在网络上查找相应的文件或其他资源。</p>
</li>
<li><p>URL 的基本结构由 5 部分组成：**&lt;传输协议&gt;://&lt; 主机名&gt;:&lt; 端口号&gt;/&lt; 文件名&gt;#片段名?参数列表**。</p>
<ul>
<li>例如：<a target="_blank" rel="noopener" href="http://192.168.1.100:8080/helloworld/index.jsp#a?username=shkstart&amp;password=123">http://192.168.1.100:8080/helloworld/index.jsp#a?username=shkstart&amp;password=123</a></li>
<li>#片段名：即锚点，例如看小说，直接定位到章节</li>
<li>参数列表格式：参数名=参数值&amp;参数名=参数值….</li>
</ul>
</li>
<li><p>为了表示 URL，<code>java.net</code> 中实现了类 URL。我们可以通过下面的构造器来初始化一个 URL 对象：</p>
<ul>
<li>**<code>public URL (String spec)</code>**：通过一个表示 URL 地址的字符串可以构造一个 URL 对象。例如：<code>URL url = new URL(&quot;http://www. atguigu.com/&quot;);</code>。</li>
<li>**<code>public URL(URL context, String spec)</code>**：通过基 URL 和相对 URL 构造一个 URL 对象。例如：<code>URL downloadUrl = new URL(url, &quot;download.html&quot;);</code>。</li>
<li><code>public URL(String protocol, String host, String file)</code>：例如：<code>new URL(&quot;http&quot;,&quot;www.atguigu.com&quot;, “download. html&quot;);</code>。</li>
<li><code>public URL(String protocol, String host, int port, String file)</code>：例如：<code>URL gamelan = new URL(&quot;http&quot;, &quot;www.atguigu.com&quot;, 80, “download.html&quot;);</code>。</li>
</ul>
</li>
<li><p>URL 类的构造器都声明抛出非运行时异常，必须要对这一异常进行处理，通常使用 try - catch 语句进行捕获。</p>
</li>
<li><p>一个 URL 对象生成后，其属性是不能被改变的，但可以通过它给定的方法来获取这些属性：</p>
<ul>
<li><p><code>public String getProtocol()</code>：获取该 URL 的协议名</p>
</li>
<li><p><code>public String getHost()</code>：获取该 URL 的主机名。</p>
</li>
<li><p><code>public String getPort()</code>：获取该 URL 的端口号。</p>
</li>
<li><p><code>public String getPath()</code>：获取该 URL 的文件路径。</p>
</li>
<li><p><code>public String getFile()</code>：获取该 URL 的文件名。</p>
</li>
<li><p><code>public String getQuery()</code>：获取该 URL 的查询名。</p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * URL网络编程</span></span><br><span class="line"><span class="comment"> * 1.URL：统一资源定位符，对应着互联网的某一资源地址</span></span><br><span class="line"><span class="comment"> * 2.格式：</span></span><br><span class="line"><span class="comment"> *  http://localhost:8080/examples/beauty.jpg?username=Tom</span></span><br><span class="line"><span class="comment"> *  协议    主机名     端口号  资源地址           参数列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://localhost:8080/examples/beauty.jpg?username=Tom&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// public String getProtocol(): 获取该URL的协议名</span></span><br><span class="line">            System.out.println(url.getProtocol());<span class="comment">// http</span></span><br><span class="line">            <span class="comment">// public String getHost(): 获取该URL的主机名</span></span><br><span class="line">            System.out.println(url.getHost());<span class="comment">// localhost</span></span><br><span class="line">            <span class="comment">// public String getPort(): 获取该URL的端口号</span></span><br><span class="line">            System.out.println(url.getPort());<span class="comment">// 8080</span></span><br><span class="line">            <span class="comment">// public String getPath(): 获取该URL的文件路径</span></span><br><span class="line">            System.out.println(url.getPath());<span class="comment">// /examples/beauty.jpg</span></span><br><span class="line">            <span class="comment">// public String getFile(): 获取该URL的文件名</span></span><br><span class="line">            System.out.println(url.getFile());<span class="comment">// /examples/beauty.jpg?username=Tom</span></span><br><span class="line">            <span class="comment">// public String getQuery(): 获取该URL的查询名</span></span><br><span class="line">            System.out.println(url.getQuery());<span class="comment">// username=Tom</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>URL 的方法 <code>openStream()</code>：能从网络上读取数据。</p>
</li>
<li><p>若希望输出数据，例如向服务器端的 CGI (公共网关接口 Common Gateway Interface 的简称，是用户浏览器和服务器端的应用程序进行连接的接口) 程序发送一些数据，则必须先与 URL 建立连接，然后才能对其进行读写，此时需要使用 URLConnection 类。</p>
</li>
<li><p>URLConnection：表示到 URL 所引用的远程对象的连接。当与一个 URL 建立连接时，首先要在一个 URL 对象上通过方法 <code>openConnection()</code> 生成对应的 URLConnection 对象。如果连接过程失败，将产生 IOException。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URL netchinaren = <span class="keyword">new</span> URL (<span class="string">&quot;http://www.atguigu.com/index.shtml&quot;</span>);</span><br><span class="line">URLConnectonn u = netchinaren.openConnection();</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 URLConnection 对象获取的输入流和输出流，即可以与现有的 CGI 程序进行交互。</p>
<ul>
<li><p><code>public Object getContent() throws IOException</code></p>
</li>
<li><p><code>public int getContentLength()</code></p>
</li>
<li><p><code>public String getContentType()</code></p>
</li>
<li><p><code>public long getDate()</code></p>
</li>
<li><p><code>public long getLastModified()</code></p>
</li>
<li><p><code>public InputStream getInputStream()throws IOException</code></p>
</li>
<li><p><code>public OutputSteram getOutputStream()throws IOException</code></p>
</li>
<li><p>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HttpURLConnection urlConnection = <span class="keyword">null</span>;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(<span class="string">&quot;http://localhost:8080/examples/beauty.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">            urlConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line"></span><br><span class="line">            urlConnection.connect();</span><br><span class="line"></span><br><span class="line">            is = urlConnection.getInputStream();</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;day10\\beauty3.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;下载完成&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 关闭资源</span></span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (urlConnection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                urlConnection.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>URI 、URL 和URN的区别：</p>
<img src="/2021/04/05/java-network/image-20210407115543616.png" alt="image-20210407115543616" style="zoom:80%;">

<ul>
<li>URI，是 uniform resource identifier，统一资源标识符，用来唯一的标识一个资源。而 URL 是 uniform resource locator，统一资源定位符，它是一种具体的 URI，即 URL 可以用来标识一个资源，而且还指明了如何 locate 这个资源。而 URN，是 uniform resource name，统一资源命名，是通过名字来标识资源，比如 mailto:<a href="mailto:&#x6a;&#97;&#x76;&#x61;&#x2d;&#x6e;&#101;&#116;&#x40;&#x6a;&#x61;&#118;&#97;&#x2e;&#115;&#117;&#110;&#46;&#x63;&#x6f;&#109;">&#x6a;&#97;&#x76;&#x61;&#x2d;&#x6e;&#101;&#116;&#x40;&#x6a;&#x61;&#118;&#97;&#x2e;&#115;&#117;&#110;&#46;&#x63;&#x6f;&#109;</a>。也就是说，URI 是以一种抽象的，高层次概念定义统一资源标识，而 URL 和 URN 则是具体的资源标识的方式。URL 和 URN 本身也都是一种 URI。</li>
<li>在 Java 的 URI 中，一个 URI 实例可以代表绝对的，也可以是相对的，只要它符合 URI 的语法规则。而 URL 类则不仅符合语义，还包含了定位该资源的信息，因此它不能是相对的。</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>位于网络中的计算机具有唯一的 IP 地址，这样不同的主机可以互相区分。</li>
<li>客户端－服务器是一种最常见的网络应用程序模型。服务器是一个为其客户端提供某种特定服务的硬件或软件。客户机是一个用户应用程序，用于访问某台服务器提供的服务。端口号是对一个服务的访问场所，它用于区分同一物理计算机上的多个服务。套接字用于连接客户端和服务器，客户端和服务器之间的每个通信会话使用一个不同的套接字。TCP 协议用于实现面向连接的会话。</li>
<li>Java 中有关网络方面的功能都定义在 <code>java.net</code> 程序包中。Java 用 InetAddress 对象表示  IP 地址，该对象里有两个字段：主机名 (String) 和 IP 地址 (int)。</li>
<li>类 Socket 和 ServerSocket 实现了基于 TCP 协议的客户端－服务器程序。Socket 是客户端和服务器之间的一个连接，连接创建的细节被隐藏了。这个连接提供了一个安全的数据传输通道，这是因为 TCP 协议可以解决数据在传送过程中的丢失、损坏、重复、乱序以及网络拥挤等问题，它保证数据可靠的传送。</li>
<li>类 URL 和 URLConnection 提供了最高级网络应用。URL 的网络资源的位置来统一标识 Internet 上各种网络资源。通过 URL 对象可以创建当前应用程序和 URL 表示的网络资源之间的连接，这样当前程序就可以读取网络资源数据，或者把自己的数据传送到网络上去。</li>
</ul>
<h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><p><a target="_blank" rel="noopener" href="https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0">https://www.gulixueyuan.com/goods/show/203?targetId=309&amp;preview=0</a></p>
<p>声明：写作本文初衷是个人学习记录，鉴于本人学识有限，如有侵权或不当之处，请联系 <a href="mailto:wdshfut@163.com">wdshfut@163.com</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XiSun"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">XiSun</p>
  <div class="site-description" itemprop="description">心如止水者，虽世间繁华之红尘纷扰，已然空无一物</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiSun</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.8m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">27:20</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
